Imports System.IO
Imports ExpertPdf.HtmlToPdf
Imports System.Data.OleDb
Imports ICSharpCode.SharpZipLib.Zip
Imports ICSharpCode.SharpZipLib.Checksums
Imports System.Collections.Generic

Partial Class VSA_NuovaDomandaVSA_domandaNuova
    Inherits PageSetIdMode

    Dim lValoreCorrente As Long
    Dim sAnnoIsee As String
    Dim sAnnoCanone As String
    Dim par As New CM.Global
    'Dim par As New [Global]()
    Dim bEseguito As Boolean = False
    Dim scriptblock As String
    Dim errore As Boolean = False
    Dim docMancanti As Boolean = False

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If Session.Item("OPERATORE") = "" Then
            Response.Redirect("~/AccessoNegato.htm", True)
            Exit Sub
        End If
        Try



            If IsPostBack = False And bEseguito = False Then

                If Request.QueryString("GLocat") <> "" Then
                    lblProcessi.Visible = False
                    Dom_Decisioni1.DisattivaTutto()
                    lblStatoDOM.Visible = False
                Else
                    If Session.Item("OP_RESP_VSA") = 1 Then
                        lblProcessi.Visible = True
                        lblProcessi.Text = "<a href='javascript:void(0)' style='text-decoration: none;' onclick=" & Chr(34) & "document.getElementById('txtModificato').value='1';window.open('../Locatari/TempisticaProcessi.aspx','TempiProcessi','top=0,left=0,width=580,height=400,resizable=no,menubar=no,toolbar=no,scrollbars=no'); return false;" & Chr(34) & ">GESTIONE TEMPISTICA</a>"
                    End If
                End If
                txtDataPG.Attributes.Add("onblur", "javascript:return mask(this.value,this,'2,5','/');")
                bMemorizzato = False
                lIdDomanda = Request.QueryString("ID")

                lIdDichiarazione = Request.QueryString("ID1")
                Dom_Alloggio_ERP1.IdDichiarazione = Request.QueryString("ID1")
                lProgr = Request.QueryString("PROGR")
                Fl_Integrazione = Request.QueryString("INT")
                Fl_DerogaInCorso = Request.QueryString("DER")
                Fl_US = Request.QueryString("US")
                inlettura.Value = Request.QueryString("L")
                chiudidirettamente.Value = Request.QueryString("CH")
                H1.Value = "1"

                '22/06/2012 - Stringa di connessione!!
                lIdConnessDOMANDA = Format(Now, "yyyyMMddhhmmss")

                If Fl_Integrazione = "1" Then
                    H1.Value = "1"
                    H2.Value = "1"
                End If


                txtTab.Value = "1"


                If lIdDomanda = -1 Then
                    'iTab = 0
                    lNuovaDomanda = 1
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    'imgAttendi.Visible = True
                    NuovaDomanda()
                    If Request.QueryString("GLocat") = "" Then
                        CalcolaISEE()
                    End If

                    'imgAttendi.Visible = False
                    FL_VECCHIO_BANDO = "1"

                    'cmbAccolta.Visible = False
                    'Label13.Visible = False

                Else
                    'iTab = 0
                    lNuovaDomanda = 0
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    'imgAttendi.Visible = True
                    Dom_Requisiti_Cambi1.DisattivaTutto()
                    VisualizzaDomanda()
                    'imgAttendi.Visible = False

                    If Session.Item("ANAGRAFE") = "1" Then
                        imgAnagrafe.Attributes.Add("onclick", "javascript:window.open('../../Anagrafe.aspx?ID=" & par.criptamolto(lIdDichiarazione) & "&T=4','Anagrafe','top=0,left=0,width=600,height=400');")
                    End If
                End If
                'txtDataPG.Enabled = False
                HiddenID.Value = lIdDomanda

                Dom_Dichiara_Cambi1.Id_Dichiarazione = lIdDichiarazione
                Dom_Dichiara_Cambi1.Id_Domanda = lIdDomanda

                CType(Dom_Dichiara_Cambi1.FindControl("DOMANDA"), HiddenField).Value = lIdDomanda
                CType(Dom_Dichiara_Cambi1.FindControl("DICHIARAZIONE"), HiddenField).Value = lIdDichiarazione

                If imgStampa.Visible = True Then
                    'CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).NavigateUrl = "VSA/MotivazioniEmergenza.aspx?ID=" & lIdDomanda & "&DI=" & lIdDichiarazione & "&IDE=" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "&CONN=" & lIdConnessDOMANDA
                    CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).NavigateUrl = "VSA/MotivazioniEmergenzaNEW.aspx?MODIF=" & txtModificato.Value & "&ID=" & lIdDomanda & "&DI=" & lIdDichiarazione & "&IDE=" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "&CONN=" & lIdConnessDOMANDA
                    CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).Target = "_blank"
                Else
                    CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).NavigateUrl = "VSA/MotivazioniEmergenzaNEW.aspx?MODIF=" & txtModificato.Value & "&X=1&ID=" & lIdDomanda & "&DI=" & lIdDichiarazione & "&IDE=" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "&CONN=" & lIdConnessDOMANDA
                    CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).Target = "_blank"
                End If

                Select Case CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedValue
                    Case 1
                        CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).Visible = False
                        CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = True
                    Case 6
                        CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).Visible = False
                        CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = True
                    Case 0
                        CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).Visible = False
                        CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = True
                    Case 2
                        CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).Visible = False
                        CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = True
                    Case 4
                        CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).Visible = True
                        CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = False
                        If Request.QueryString("GLocat") = "" Then
                            CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).SelectedValue = 0
                            CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).Enabled = False
                        Else
                            CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).SelectedValue = 2
                            CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).Enabled = False
                        End If
                    Case 3
                        CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).Visible = False
                        CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = True
                    Case 7
                        CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).Visible = False
                        CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = True
                    Case 5
                        If Request.QueryString("GLocat") = "" Then
                            CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).SelectedValue = 0
                            CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).Enabled = False
                        Else
                            CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).SelectedValue = 2
                            CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).Enabled = False
                        End If

                    Case 8
                        CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).Visible = False
                        CType(Dom_Dichiara_Cambi1.FindControl("Label16"), Label).Visible = False
                        CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = False
                        MenuStampe.Visible = False
                    Case 9
                        CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).Visible = False
                        CType(Dom_Dichiara_Cambi1.FindControl("Label16"), Label).Visible = False
                        CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = False
                        MenuStampe.Visible = False
                    Case 10
                        CType(Dom_Dichiara_Cambi1.FindControl("CEM"), HyperLink).Visible = False
                        CType(Dom_Dichiara_Cambi1.FindControl("Label16"), Label).Visible = False
                        CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = False
                        MenuStampe.Visible = False
                End Select


                'CEM.NavigateUrl = "MotivazioniEmergenza.aspx?ID=" & ID

                'imgRiassunto.Attributes.Add("onclick", "javascript:window.open('Riassunto.aspx?ID=" & lIdDomanda & "&CF=" & CType(Me.Page.FindControl("txtCF"), TextBox).Text & "','Riassunto','');")
                'If Session.Item("id_caf") = "6" Then
                'Label12.Attributes.Add("onclick", "javascript:window.open('Eventi.aspx?ID=" & lIdDomanda & "','Eventi','');")
                'Label12.Visible = True
                'End If

                'nascondo in quanto nel bando cambi non servono
                'Me.Page.FindControl("cmbResidenza").Visible = False
                'Me.Page.FindControl("Label9").Visible = False

                bEseguito = True

                If CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).SelectedItem.Value = 0 Then
                    CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).ReadOnly = True
                    CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).ReadOnly = True
                End If

                'CType(Me.Page.FindControl("HyperLink1"), HyperLink).NavigateUrl = "CAMBI/Help_Domanda.htm"
                'CType(Dom_Alloggio_ERP1.FindControl("HyperLink1"), HyperLink).NavigateUrl = "CAMBI/Help_Domanda.htm"
                'CType(Dom_Requisiti_Cambi1.FindControl("HyperLink1"), HyperLink).NavigateUrl = "CAMBI/Help_Domanda.htm"
                'CType(Dom_Abitative_1_1.FindControl("HyperLink2"), HyperLink).NavigateUrl = "CAMBI/Help_Domanda.htm"
                'CType(Dom_Abitative_2_1.FindControl("HyperLink2"), HyperLink).NavigateUrl = "CAMBI/Help_Domanda.htm"
                'CType(Dom_Dichiara_Cambi1.FindControl("HyperLink1"), HyperLink).NavigateUrl = "CAMBI/Help_Domanda.htm"
                'CType(Dom_Familiari1.FindControl("HyperLink1"), HyperLink).NavigateUrl = "CAMBI/Help_Domanda.htm"


                If inlettura.Value = "1" Then
                    Dom_Alloggio_ERP1.DisattivaTutto()
                    Dom_Dichiara_Cambi1.DisattivaTutto()
                    Dom_Requisiti_Cambi1.DisattivaTutto()
                    Dom_Note1.DisattivaTutto()
                    DisattivaTutto()

                    btnSalva.Visible = False
                    'imgStampa.Visible = True
                    imgAnagrafe.Visible = False

                End If
                Dim CTRL As Control
                For Each CTRL In Me.form1.Controls
                    If TypeOf CTRL Is TextBox Then
                        DirectCast(CTRL, TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';document.getElementById('H1').value='0';")
                    ElseIf TypeOf CTRL Is DropDownList Then
                        DirectCast(CTRL, DropDownList).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';document.getElementById('H1').value='0';")
                    End If
                Next

                tipoRichiesta.Value = CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedValue

                'SetMenuStampe(tipoRichiesta.Value)

                If tipoRichiesta.Value <> "2" And tipoRichiesta.Value <> "3" Or par.IfEmpty(CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue, -1) = 30 Then
                    IMGCanone.Visible = False
                End If

            Else

                If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedValue = "4" Or CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedValue = "5" Then
                    If Request.QueryString("GLocat") = "" Then
                        CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).SelectedValue = 0
                        CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).Enabled = False
                    Else
                        CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).SelectedValue = 2
                        CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).Enabled = False


                        If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedValue = "5" Then
                            CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Visible = True
                            CType(Dom_Decisioni1.FindControl("ChkMotiviRies"), CheckBoxList).Visible = True
                            CType(Dom_Decisioni1.FindControl("btnRiduzCanone"), Button).Text = "AUTORIZZA CAMBIO CONSENSUALE"
                            CType(Dom_Decisioni1.FindControl("lblTitolo"), Label).Text = "Decisioni per Cambio Consensuale"

                        ElseIf CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedValue = "4" Then
                            CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Visible = True
                            CType(Dom_Decisioni1.FindControl("ChkMotiviRies"), CheckBoxList).Visible = True
                            CType(Dom_Decisioni1.FindControl("btnRiduzCanone"), Button).Text = "AUTORIZZA CAMBIO ALLOGGIO"
                            CType(Dom_Decisioni1.FindControl("lblTitolo"), Label).Text = "Decisioni per Cambio Alloggio ex art.22"
                        End If
                    End If
                End If
            End If
            'H1.Value = H2.Value

            H1.Value = "1"
            Dom_Alloggio_ERP1.IdDichiarazione = lIdDichiarazione

            'If CType(Dom_Note1.FindControl("ListBox1"), ListBox).Items.Count > 0 Then
            '    CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1
            'Else
            '    CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 0
            'End If

            If Ccodicetrovato.Value <> "" Then
                CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text = Trim(Ccodicetrovato.Value)
                'Ccodicetrovato.Value = ""
            End If

            If Ucodicetrovato.Value <> "" Then
                CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text = Ucodicetrovato.Value
                'Ucodicetrovato.Value = ""
            End If

            If tipoRichiesta.Value = 3 Or tipoRichiesta.Value = 4 Then
                imgStampa.Visible = True
            Else
                imgStampa.Visible = False
            End If
            If Request.QueryString("GLocat") <> "" Then
                imgStampa.Visible = True
            End If



        Catch ex As Exception
            Response.Write(ex.Message)
        End Try
    End Sub

    Private Sub txtCognome_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtCognome.TextChanged
        par.SetFocusControl(Page, "txtNome")
    End Sub

    Private Sub txtNome_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtNome.TextChanged
        par.SetFocusControl(Page, "cmbSesso")
    End Sub

    Private Sub cmbSesso_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbSesso.SelectedIndexChanged
        par.SetFocusControl(Page, "txtCF")
    End Sub

    Private Sub txtCF_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtCF.TextChanged
        par.SetFocusControl(Page, "cmbResidenza")
    End Sub

    Private Sub cbmNazioneNas_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        par.SetFocusControl(Page, "cmbPrNas")
    End Sub

    Private Sub cmbPrNas_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbPrNas.SelectedIndexChanged
        Dim item As ListItem

        item = cmbPrNas.SelectedItem
        par.RiempiDList(Me, par.OracleConn, "cmbComuneNas", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & par.PulisciStrSql(item.Text) & "' ORDER BY NOME ASC", "NOME", "ID")

        par.SetFocusControl(Page, "cmbComuneNas")
    End Sub

    Private Sub cmbComuneNas_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbComuneNas.SelectedIndexChanged
        par.SetFocusControl(Page, "txtDataNascita")
    End Sub

    Private Sub txtDataNascita_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtDataNascita.TextChanged

        txtDataNascita.Text = Trim(Left(txtDataNascita.Text, 10))
        lblErrData.Text = ""
        If Len(txtDataNascita.Text) = 0 Then
            lblErrData.Text = "*"
        ElseIf Not par.ControllaData(txtDataNascita) Then
            lblErrData.Text = "GG/MM/AAAA o GGMMAAAA"
        Else
            par.SetFocusControl(Page, "cmbNazioneRes")
        End If

    End Sub

    Private Sub cmbNazioneRes_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbNazioneRes.SelectedIndexChanged
        If cmbNazioneRes.Items.FindByText("ITALIA").Selected = False Then
            cmbPrRes.Visible = False
            'Label11.Visible = False
            'Label10.Visible = False
            cmbComuneRes.Visible = False
        Else
            cmbPrRes.Visible = True
            'Label11.Visible = True
            'Label10.Visible = True
            cmbComuneRes.Visible = True
        End If
        par.SetFocusControl(Page, "cmbPrRes")
    End Sub

    Private Sub cmbPrRes_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbPrRes.SelectedIndexChanged
        Dim item As ListItem
        'Dim cmd As New Oracle.DataAccess.Client.OracleCommand()

        item = cmbPrRes.SelectedItem
        'par.OracleConn.Open()
        par.RiempiDList(Me, par.OracleConn, "cmbComuneRes", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & par.PulisciStrSql(item.Text) & "' ORDER BY NOME ASC", "NOME", "ID")
        'par.OracleConn.Close()
        txtCAPRes.Text = ""
        par.SetFocusControl(Page, "cmbComuneRes")


        item = cmbComuneRes.SelectedItem
        par.OracleConn.Open()
        par.SettaCommand(par)
        par.cmd.CommandText = "SELECT CAP FROM COMUNI_NAZIONI WHERE NOME='" & par.PulisciStrSql(item.Text) & "'"

        Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
        If myReader.Read() Then
            txtCAPRes.Text = myReader(0)
        End If
        myReader.Close()
        par.OracleConn.Close()
        par.OracleConn.Dispose()
    End Sub

    Private Sub cmbComuneRes_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbComuneRes.SelectedIndexChanged
        Dim item As ListItem
        'Dim cmd As New Oracle.DataAccess.Client.OracleCommand()

        item = cmbComuneRes.SelectedItem
        par.OracleConn.Open()
        par.SettaCommand(par)
        par.cmd.CommandText = "SELECT CAP FROM COMUNI_NAZIONI WHERE NOME='" & par.PulisciStrSql(item.Text) & "'"

        Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
        If myReader.Read() Then
            txtCAPRes.Text = myReader(0)
        End If
        myReader.Close()
        par.OracleConn.Close()
        par.OracleConn = Nothing
        par.SetFocusControl(Page, "cmbTipoIRes")
    End Sub

    Private Sub cmbTipoIRes_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbTipoIRes.SelectedIndexChanged
        par.SetFocusControl(Page, "txtIndRes")
    End Sub

    Private Sub txtIndRes_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtIndRes.TextChanged
        par.SetFocusControl(Page, "txtCivicoRes")
    End Sub

    Private Sub txtCivicoRes_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtCivicoRes.TextChanged
        par.SetFocusControl(Page, "txtCAPRes")
    End Sub

    Private Sub txtCAPRes_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtCAPRes.TextChanged
        par.SetFocusControl(Page, "txtTelRes")
    End Sub

    Private Sub txtTelRes_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtTelRes.TextChanged
        par.SetFocusControl(Page, "txtPresso")
    End Sub

    Private Sub txtPresso_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtPresso.TextChanged
        par.SetFocusControl(Page, "cmbProvRec")
    End Sub

    Private Sub cmbProvRec_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbProvRec.SelectedIndexChanged
        Dim item As ListItem
        'Dim cmd As New Oracle.DataAccess.Client.OracleCommand()

        item = cmbProvRec.SelectedItem
        par.RiempiDList(Me, par.OracleConn, "cmbComuneRec", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & par.PulisciStrSql(item.Text) & "' ORDER BY NOME ASC", "NOME", "ID")

        par.SetFocusControl(Page, "cmbComuneRec")

        item = cmbComuneRec.SelectedItem
        par.OracleConn.Open()
        par.SettaCommand(par)
        par.cmd.CommandText = "SELECT CAP FROM COMUNI_NAZIONI WHERE NOME='" & par.PulisciStrSql(item.Text) & "'"

        Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
        If myReader.Read() Then
            txtCAPRec.Text = myReader(0)
        End If
        myReader.Close()
        par.OracleConn.Close()
        par.OracleConn = Nothing
    End Sub

    Private Sub cmbComuneRec_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbComuneRec.SelectedIndexChanged
        Dim item As ListItem
        'Dim cmd As New Oracle.DataAccess.Client.OracleCommand()

        item = cmbComuneRec.SelectedItem
        par.OracleConn.Open()
        par.SettaCommand(par)
        par.cmd.CommandText = "SELECT CAP FROM COMUNI_NAZIONI WHERE NOME='" & par.PulisciStrSql(item.Text) & "'"

        Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
        If myReader.Read() Then
            txtCAPRec.Text = myReader(0)
        End If
        myReader.Close()
        par.OracleConn.Close()
        par.OracleConn = Nothing
        par.SetFocusControl(Page, "txtCAPRec")
    End Sub

    Private Sub txtCAPRec_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtCAPRec.TextChanged
        par.SetFocusControl(Page, "cmbTipoIRec")
    End Sub

    Private Sub cmbTipoIRec_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbTipoIRec.SelectedIndexChanged
        par.SetFocusControl(Page, "txtIndirizzoRec")
    End Sub

    Private Sub txtIndirizzoRec_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtIndirizzoRec.TextChanged
        par.SetFocusControl(Page, "txtCivicoRec")
    End Sub

    Private Sub txtCivicoRec_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtCivicoRec.TextChanged
        par.SetFocusControl(Page, "txtTelRec")
    End Sub

    Private Sub cmbNazioneNas_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbNazioneNas.SelectedIndexChanged
        If cmbNazioneNas.Items.FindByText("ITALIA").Selected = False Then
            cmbPrNas.Visible = False
            'Label6.Visible = False
            'Label7.Visible = False
            cmbComuneNas.Visible = False
        Else
            cmbPrNas.Visible = True
            'Label6.Visible = True
            'Label7.Visible = True
            cmbComuneNas.Visible = True
        End If
        par.SetFocusControl(Page, "cmbPrNascita")
    End Sub

    Public Function DisattivaRichiedente()
        txtCognome.Enabled = False
        txtNome.Enabled = False
        cmbSesso.Enabled = False
        txtCF.Enabled = False
        cmbNazioneNas.Enabled = False
        cmbPrNas.Enabled = False
        cmbComuneNas.Enabled = False
        txtDataNascita.Enabled = False
    End Function

    Public Function DisattivaIndirizzo()
        cmbNazioneRes.Enabled = False
        cmbPrRes.Enabled = False
        cmbComuneRes.Enabled = False
        cmbTipoIRes.Enabled = False
        txtIndRes.Enabled = False
        txtCivicoRes.Enabled = False
        txtCAPRes.Enabled = False
        txtTelRes.Enabled = False
    End Function

    Public Sub DisattivaTutto()
        txtCognome.Enabled = False
        txtNome.Enabled = False
        cmbSesso.Enabled = False
        txtCF.Enabled = False
        cmbResidenza.Enabled = False
        cmbNazioneNas.Enabled = False
        cmbPrNas.Enabled = False
        cmbComuneNas.Enabled = False
        txtDataNascita.Enabled = False
        cmbNazioneRes.Enabled = False
        cmbPrRes.Enabled = False
        cmbComuneRes.Enabled = False
        cmbTipoIRes.Enabled = False
        txtIndRes.Enabled = False
        txtCivicoRes.Enabled = False
        txtCAPRes.Enabled = False
        txtTelRes.Enabled = False
        txtPresso.Enabled = False
        cmbProvRec.Enabled = False
        cmbComuneRec.Enabled = False
        txtCAPRec.Enabled = False
        cmbTipoIRec.Enabled = False
        txtIndirizzoRec.Enabled = False
        txtCivicoRec.Enabled = False
        txtTelRec.Enabled = False

        cmbResidenza.Enabled = False


    End Sub

    Private Function CheckCoincidenzaNucleo() As Boolean

        Dim nucleoCoincidente As Boolean = True
        Dim numCompAU As Integer = 0
        Dim numCompDichNew As Integer = 0

        Try
            If par.OracleConn.State = Data.ConnectionState.Closed Then
                par.OracleConn.Open()
                par.SettaCommand(par)
            End If

            par.cmd.CommandText = "SELECT COUNT(*) AS NUMCOMP FROM UTENZA_COMP_NUCLEO,UTENZA_DICHIARAZIONI WHERE UTENZA_COMP_NUCLEO.ID_DICHIARAZIONE=UTENZA_DICHIARAZIONI.ID and utenza_dichiarazioni.id = (select max(id) from utenza_dichiarazioni where RAPPORTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "')"
            Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If lettore.Read Then
                numCompAU = par.IfNull(lettore("NUMCOMP"), 0)
            End If
            lettore.Close()


            If numCompAU = 0 Then
                par.cmd.CommandText = "SELECT COUNT(*) AS NUMCOMP FROM SISCOM_MI.SOGGETTI_CONTRATTUALI,SISCOM_MI.RAPPORTI_UTENZA WHERE SOGGETTI_CONTRATTUALI.ID_CONTRATTO = RAPPORTI_UTENZA.ID AND COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
                lettore = par.cmd.ExecuteReader()
                If lettore.Read Then
                    numCompAU = par.IfNull(lettore("NUMCOMP"), 0)
                End If
                lettore.Close()
            End If


            par.cmd.CommandText = "SELECT COUNT(*) AS NUMCOMP FROM COMP_NUCLEO_VSA,DICHIARAZIONI_VSA WHERE COMP_NUCLEO_VSA.ID_DICHIARAZIONE=DICHIARAZIONI_VSA.ID AND DICHIARAZIONI_VSA.ID=" & lIdDichiarazione
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                numCompDichNew = par.IfNull(lettore("NUMCOMP"), 0)
            End If
            lettore.Close()

            If numCompAU <> numCompDichNew Then
                nucleoCoincidente = False
            End If


        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try

        Return nucleoCoincidente

    End Function
    Private Sub SegnalazioneTempi(ByVal dataPres As String, ByVal IDmotivoDomanda As Integer)
        Try
            Dim giorniTrascorsi As Integer
            Dim tempoRestante As Integer
            Dim durataGG As Integer
            Dim dataScadProcedimento As String
            Dim esitoNegat As Boolean = False
            Dim dataEsitoNegativo As String = ""
            Dim dataDocManc As String = ""
            Dim sottoponiRiesame As Boolean = False
            Dim dataSottRiesame As String = ""

            par.cmd.CommandText = "SELECT * FROM VSA_DECISIONI_REV_C WHERE ID_DOMANDA = " & lIdDomanda & " AND COD_DECISIONE = '4'"
            Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If lettore.Read Then
                sottoponiRiesame = True
                dataSottRiesame = par.IfNull(lettore("DATA"), "")
            End If
            lettore.Close()

            par.cmd.CommandText = "SELECT * FROM VSA_DECISIONI_REV_C WHERE ID_DOMANDA = " & lIdDomanda & " AND COD_DECISIONE = '3'"
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                esitoNegat = True
                dataEsitoNegativo = par.IfNull(lettore("DATA"), "")
            End If
            lettore.Close()

            par.cmd.CommandText = "SELECT * FROM EVENTI_BANDI_VSA WHERE ID_DOMANDA = " & lIdDomanda & " AND COD_EVENTO = 'F193' ORDER BY DATA_ORA DESC"
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                dataDocManc = par.IfNull(lettore("DATA_ORA"), "").ToString.Substring(0, 8)
            End If
            lettore.Close()


            '23/01/2012 Messaggio Giorni restanti
            Dim giorniSospensione As String = ""
            Dim dataUltimaScad As String = ""
            durataGG = tempoProcesso(IDmotivoDomanda)
            giorniTrascorsi = DateDiff(DateInterval.Day, CDate(par.FormattaData(dataPres)), CDate(par.FormattaData(Format(Now, "yyyyMMdd"))))
            dataScadProcedimento = par.AggiustaData(Date.Parse(par.FormattaData(dataPres), New System.Globalization.CultureInfo("it-IT", False)).AddDays(durataGG).ToString("dd/MM/yyyy"))

            If CType(Dom_Decisioni1.FindControl("autorizzFinale"), HiddenField).Value = 0 Then
                If CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1 And CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 0 Then
                    'Sospensione 30 giorni
                    lblStatoDOM.Text = "In attesa di integrazioni. Scadenza il: " & par.FormattaData(Date.Parse(par.FormattaData(dataDocManc), New System.Globalization.CultureInfo("it-IT", False)).AddDays(30).ToString("dd/MM/yyyy"))
                    lblSospesa.Visible = True

                    'Verifico se sono trascorsi 30 gg
                    If DateDiff(DateInterval.Day, CDate(par.FormattaData(dataDocManc)), CDate(par.FormattaData(Format(Now, "yyyyMMdd")))) > 30 Then
                        imgAlertScadenza.Visible = True
                        lblScadenza.Visible = True

                        lblScadenza.Text = "Documentazione mancante non integrata entro il termine di 30 gg. Selezionare NON ACCOLTA nella scheda Decisioni."
                        CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 11
                    End If
                End If
                If esitoNegat = True And sottoponiRiesame = False Then
                    lblStatoDOM.Text = "PROCEDIMENTO in attesa di Osservazioni!"
                    imgAlertScadenza.Visible = True
                    lblScadenza.Visible = True

                    'Nel calcolo dei giorni ne aggiungo 10 (dalla data dell'esito negativo) - tempo entro cui inviare le osservazioni
                    lblScadenza.Text = "Presentare le dovute osservazioni entro il: " _
                        & par.FormattaData(Date.Parse(par.FormattaData(dataEsitoNegativo), New System.Globalization.CultureInfo("it-IT", False)).AddDays(10).ToString("dd/MM/yyyy"))

                    'Verifico se sono trascorsi 10 gg dalla prima decisione NON accolta
                    If DateDiff(DateInterval.Day, CDate(par.FormattaData(dataEsitoNegativo)), CDate(par.FormattaData(Format(Now, "yyyyMMdd")))) = 10 Then
                        lblScadenza.Text = "Il tempo per il riesame è terminato. Si prega di inoltrare il provvedimento alla chiusura!"
                    End If

                    ''If dataEsitoNegRies <> "" Then
                    ''    tempoRestante = tempoRestante - DateDiff(DateInterval.Day, CDate(par.FormattaData(dataEsitoNegativo)), CDate(par.FormattaData(Format(Now, "yyyyMMdd"))))
                    ''End If
                Else
                    imgAlertScadenza.Visible = False
                    lblScadenza.Visible = False
                End If
                If sottoponiRiesame = True Then
                    ''Dall'intervallo in giorni che va dalla data di presentazione della richiesta sino ad oggi elimino i giorni di sospensione per Doc Mancante ed Esito Negativo
                    If dataDocManc <> "" Then
                        giorniSospensione = DateDiff(DateInterval.Day, CDate(par.FormattaData(dataDocManc)), CDate(par.FormattaData(dataEsitoNegativo)))
                        'giorniTrascorsi = giorniTrascorsi - DateDiff(DateInterval.Day, CDate(par.FormattaData(dataDocManc)), CDate(par.FormattaData(dataEsitoNegativo)))
                    End If
                    giorniSospensione = DateDiff(DateInterval.Day, CDate(par.FormattaData(dataEsitoNegativo)), CDate(par.FormattaData(dataSottRiesame)))
                    dataUltimaScad = par.FormattaData(Date.Parse(par.FormattaData(dataScadProcedimento), New System.Globalization.CultureInfo("it-IT", False)).AddDays(giorniSospensione).ToString("dd/MM/yyyy"))
                    giorniTrascorsi = giorniTrascorsi - giorniSospensione

                    'giorniTrascorsi = giorniTrascorsi - DateDiff(DateInterval.Day, CDate(par.FormattaData(dataEsitoNegativo)), CDate(par.FormattaData(dataSottRiesame)))
                    tempoRestante = (durataGG - giorniTrascorsi) + giorniSospensione
                    If tempoRestante <= durataGG Then
                        'dataUltimaScad = par.FormattaData(Date.Parse(par.FormattaData(dataScadProcedimento), New System.Globalization.CultureInfo("it-IT", False)).AddDays(giorniSospensione).ToString("dd/MM/yyyy"))
                        If par.AggiustaData(dataUltimaScad) > Format(Now, "yyyyMMdd") Then
                            lblStatoDOM.Text = "PROCEDIMENTO AVVIATO Scadenza: " & dataUltimaScad
                            tempoRestante = DateDiff(DateInterval.Day, CDate(par.FormattaData(Format(Now, "yyyyMMdd"))), CDate(par.FormattaData(dataUltimaScad)))
                            If tempoRestante <= 10 Then
                                imgAlertScadenza.Visible = True
                                lblScadenza.Visible = True
                                lblScadenza.Text = "Tempo rimanente: " & tempoRestante & " giorni"
                            Else
                                imgAlertScadenza.Visible = False
                                lblScadenza.Visible = False
                            End If
                        Else
                            lblStatoDOM.Text = "PROCEDIMENTO Scaduto in data: " & dataUltimaScad
                        End If
                    Else
                        imgAlertScadenza.Visible = False
                        lblScadenza.Visible = False
                        lblStatoDOM.Text = "Tempo limite superato!"
                        'Dom_Decisioni1.DisattivaTutto()
                    End If
                ElseIf CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 0 And esitoNegat = False And sottoponiRiesame = False Then
                    tempoRestante = durataGG - giorniTrascorsi
                    If giorniTrascorsi <= durataGG Then
                        lblStatoDOM.Text = "PROCEDIMENTO AVVIATO Scadenza: " & par.FormattaData(dataScadProcedimento)
                        If tempoRestante <= 10 Then
                            imgAlertScadenza.Visible = True
                            lblScadenza.Visible = True
                            lblScadenza.Text = "Tempo rimanente: " & tempoRestante & " giorni"
                        End If
                    Else
                        lblScadenza.Visible = False
                        lblStatoDOM.Text = "Tempo limite superato!"
                        'Dom_Decisioni1.DisattivaTutto()
                    End If
                End If
            Else
                lblStatoDOM.Text = "PROCEDIMENTO CONCLUSO!"
                MenuStampe.Enabled = True
                'btnSalva.Enabled = False
                imgStampa.Enabled = False
                imgEventi.Enabled = True
                imgAlertScadenza.Visible = False
                lblScadenza.Visible = False
                Dom_Alloggio_ERP1.DisattivaTutto()
                DisattivaTutto()
                Dom_Dichiara_Cambi1.DisattivaTutto()
                Dom_Requisiti_Cambi1.DisattivaTutto()
            End If
            '23/01/2012 FINE Messaggio Giorni restanti

        Catch ex As Exception
            Response.Write(ex.Message)
        End Try

    End Sub

    Private Sub ControlloDataEvento(ByVal annoSitEcon As Integer, ByVal causaleDom As String, ByVal dataEvento As String, ByVal dataPres As String)

        If causaleDom = 23 Then
            If (Right(dataEvento, 4) <> annoSitEcon) And (Right(dataPres, 4) <> annoSitEcon) Then
                Response.Write("<script>alert('Attenzione! L'anno di presentazione e l'anno dell'evento devono essere uguali all'anno di reddito!')</script>")
            End If
        Else
            If Right(dataEvento, 4) <> annoSitEcon Then
                Response.Write("<script>alert('Attenzione! L'anno dell'evento deve essere uguale all'anno di reddito!')</script>")
            End If
            If dataPres < dataEvento Then
                Response.Write("<script>alert('Attenzione! La data evento non può essere successiva a quella di presentazione!')</script>")
            End If
        End If

    End Sub

    Protected Sub btnfunzesci2_Click(sender As Object, e As System.EventArgs) Handles btnfunzesci2.Click
        txtModificato.Value = "0"
        opUscita()
    End Sub


    Protected Sub imgUscita_Click(sender As Object, e As System.EventArgs) Handles imgUscita.Click
        opUscita()
    End Sub

    Protected Sub opUscita()
        Try
            If txtModificato.Value = "1" Or txtModificato.Value = "111" Then
                ScriptManager.RegisterStartupScript(Page, GetType(Page), "MyScriptKey", "ConfermaEsci();", True)

            Else
                If txtModificato.Value <> "111" And txtModificato.Value <> "222" Then
                    If Session.Item("LAVORAZIONE") = "1" Then
                        If Session.Item("STAMPATO") = "0" Then

                            MessJQuery("La dichiarazione deve essere elaborata!", 0, "Attenzione")
                            ScriptManager.RegisterStartupScript(Page, GetType(Page), "MyScriptKey", "document.getElementById('caric').style.visibility = 'hidden';", True)
                            'H1.Text = "0"
                            Exit Sub
                        End If
                        par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleConnection)
                        par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleTransaction)
                        '‘par.cmd.Transaction = par.myTrans
                        par.myTrans.Rollback()
                        'par.myTrans.Dispose()
                        par.OracleConn.Close()
                        par.OracleConn.Dispose()
                        HttpContext.Current.Session.Remove("TRANSAZIONE" & lIdConnessDOMANDA)
                        HttpContext.Current.Session.Remove(lIdConnessDOMANDA)
                        Session.Item("LAVORAZIONE") = "0"
                        Session.Remove("STAMPATO")
                        Oracle.DataAccess.Client.OracleConnection.ClearAllPools()

                        If CHIUDI <> "1" Then
                            'Response.Write("<script>document.location.href=""pagina_home.aspx""</script>")

                            'Response.Write("<script>window.close();</script>")
                            ScriptManager.RegisterStartupScript(Page, GetType(Page), "MyScriptKey", "self.close();", True)
                        Else
                            ScriptManager.RegisterStartupScript(Page, GetType(Page), "MyScriptKey", "self.close();", True)
                        End If
                    Else
                        Session.Item("LAVORAZIONE") = "0"

                        If Not (CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleTransaction)) Is Nothing Then
                            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleTransaction)
                            par.myTrans.Rollback()
                            HttpContext.Current.Session.Remove("TRANSAZIONE" & lIdConnessDOMANDA)
                        End If

                        If Not (CType(HttpContext.Current.Session.Item("CONNESSIONE" & lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleConnection)) Is Nothing Then
                            par.OracleConn = CType(HttpContext.Current.Session.Item("CONNESSIONE" & lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleConnection)

                            par.OracleConn.Close()

                            HttpContext.Current.Session.Remove(lIdConnessDOMANDA)
                            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()

                        End If

                        If CHIUDI <> "1" Then
                            ScriptManager.RegisterStartupScript(Page, GetType(Page), "MyScriptKey", "self.close();", True)
                        Else
                            ScriptManager.RegisterStartupScript(Page, GetType(Page), "MyScriptKey", "self.close();", True)
                        End If
                    End If
                Else
                    '   document.txtModificato.Value = "1"
                    ScriptManager.RegisterStartupScript(Page, GetType(Page), "MyScriptKey", "document.getElementById('txtModificato').value = 1;", True)
                End If
            End If
        Catch EX As Exception
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
            Session.Item("LAVORAZIONE") = "0"
            Session.Add("ERRORE", "Provenienza: " & Page.Title & " - ImgUscita.click() " & EX.Message)
            Response.Redirect("../../Errore.aspx", False)
        Finally

        End Try
    End Sub

    Private Sub SetMenuStampe(ByVal TipoDomanda As Integer)

        '0) Voltura;
        '1) Subentro;
        '2) Ampliamento;
        '3) Riduzione Canone;
        '4) Cambio art22 c10 rr 1/2004
        '5) Cambio Diretto
        Try

            MenuStampe.Items(0).ChildItems.Clear()
            Select Case TipoDomanda
                Case 0
                    MenuVoltura()
                Case 1, 6
                    MenuSubentro()
                Case 2
                    MenuAmpliamento()
                Case 3
                    MenuRiduzione()
                Case 4
                    MenuCambiEmerg()
                Case 5
                    MenuCambioCons()
                Case 7
                    MenuOspitalita()
            End Select

            'MenuStampe.StaticHoverStyle.BackColor = Drawing.Color.Aqua
        Catch ex As Exception
            Response.Write("<script>document.location.href=""../../ErrorPage.aspx""</script>")

        End Try
    End Sub

    Private Sub MenuRiduzione()
        Dim item As MenuItem
        If modPresent = "0" Then
            item = New MenuItem("Ricezione Richiesta", "RichRC", "", "javascript:RicezRichiesta();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        item = New MenuItem("Avvio Procedimento", "AvvProcRC", "", "javascript:AvvioProc();")
        MenuStampe.Items(0).ChildItems.Add(item)

        If CType(Dom_Note1.FindControl("chkSoprall"), CheckBox).Checked = True Then
            item = New MenuItem("Sopralluogo", "SoprallRID", "", "javascript:SopralluogoRID();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        If CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1 Then
            item = New MenuItem("Richiesta Doc.Mancante", "DocMancRC", "", "javascript:StampaDoc();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue <> 23 And CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue <> 18 Then
            If CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1 Then
                item = New MenuItem("Comunicaz.Esito Positivo", "EsPosRC", "", "javascript:EsitoPos();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 1 Then
                item = New MenuItem("Comunicaz.Esito Positivo", "EsPosRC", "", "javascript:EsitoPos();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If
        End If

        If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 23 Then
            If CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1 Then
                item = New MenuItem("Comunicaz.Esito Positivo", "EsPosRCProvv", "", "javascript:EsitoPosProvv();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 1 Then
                item = New MenuItem("Comunicaz.Esito Positivo", "EsPosRCProvv", "", "javascript:EsitoPosProvv();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If
        End If


        'If Right(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text, 4) = "2009" Then
        If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 18 Then
            If CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1 Then
                item = New MenuItem("Comunicaz.Esito Positivo", "EsPosRCDef", "", "javascript:EsitoPosDEF();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 1 Then
                item = New MenuItem("Comunicaz.Esito Positivo", "EsPosRCDef", "", "javascript:EsitoPosDEF();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If
        End If
        'End If


        If CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1 Then
            item = New MenuItem("Comunicaz.Esito Negativo", "EsNegatRC", "", "javascript:EsitoNeg();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        If CType(Dom_Decisioni1.FindControl("esNegaRiesame"), HiddenField).Value = 1 Then
            If fl_osserv = 1 Then
                item = New MenuItem("Comunicaz.Esito Neg. Riesame Con Osserv.", "EsNegRiesNOoss", "", "javascript:EsNegRiesame();")
                MenuStampe.Items(0).ChildItems.Add(item)
            Else
                item = New MenuItem("Comunicaz.Esito Neg. Riesame Senza Osserv.", "EsNegRiesameRC", "", "javascript:EsNegRiesConOss();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If
        End If

        If fl_contab = 0 Then
            item = New MenuItem("Rapporto Sintetico", "rappRECA", "", "javascript:RapportoRECA();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        item = New MenuItem("ELENCO STAMPE", "ElStamp", "", "javascript:ElStampe();")
        MenuStampe.Items(0).ChildItems.Add(item)

    End Sub

    Private Sub MenuAmpliamento()
        Dim item As MenuItem
        If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue <> 30 Then

            item = New MenuItem("Ricezione Richiesta", "RicRichiesta", "", "javascript:RicRichiesta();")
            MenuStampe.Items(0).ChildItems.Add(item)

            item = New MenuItem("Avvio Procedimento", "AvvioProcAMPL", "", "javascript:AvvProcedim();")
            MenuStampe.Items(0).ChildItems.Add(item)

            item = New MenuItem("Stato Famiglia Ospite", "StFamigliaAMPL", "", "javascript:AUcertStFamiglia();")
            MenuStampe.Items(0).ChildItems.Add(item)

            item = New MenuItem("Permanenza Requisiti ERP (titolare)", "PermanenzaAMPL1", "", "javascript:PermReqERP();")
            MenuStampe.Items(0).ChildItems.Add(item)

            item = New MenuItem("Permanenza Requisiti ERP (ospite)", "PermanenzaAMPL2", "", "javascript:PermReqERP2();")
            MenuStampe.Items(0).ChildItems.Add(item)

            If CType(Dom_Note1.FindControl("chkSoprall"), CheckBox).Checked = True Then
                item = New MenuItem("Sopralluogo", "SoprallAMPL", "", "javascript:SopralluogoAMPL();")
                MenuStampe.Items(0).ChildItems.Add(item)

                item = New MenuItem("Comunicazione Sospensione Sopralluogo", "ComSoprallAMPL", "", "javascript:ComSoprallAMPL();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1 Then
                item = New MenuItem("Richiesta Doc.Mancante", "DocMancanteAMPL", "", "javascript:DocMancante();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 4 Then
                item = New MenuItem("Conviv. More Uxorio", "MoreUxorioAMPL", "", "javascript:MoreUxorio();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 5 Then
                item = New MenuItem("Conviv. per Assistenza", "AssistenzaAMPL", "", "javascript:Assistenza();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1 Then
                If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 3 Then
                    item = New MenuItem("Presa d'atto per Rientro", "PresaAttoRientro", "", "javascript:PresaAttoRientro();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                Else
                    item = New MenuItem("Esito Positivo", "EsPositivoAMPL", "", "javascript:EsitoPosit();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                End If
            End If

            If CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1 Then
                item = New MenuItem("Esito Negativo", "EsNegativoAMPL", "", "javascript:EsNegativo();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 1 Then
                If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 3 Then
                    item = New MenuItem("Comunicaz.Esito Positivo Riesame Rientro", "EsPosRiesRientro", "", "javascript:EsPosRiesRientro();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                End If
                item = New MenuItem("Comunicaz.Esito Positivo Riesame", "EsitoPosRiesAMPL", "", "javascript:EsPosRiesAMPL();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Decisioni1.FindControl("esNegaRiesame"), HiddenField).Value = 1 Then
                If fl_osserv = 1 Then
                    item = New MenuItem("Comunicaz.Esito Neg. Riesame Con Osserv.", "EsNegRiesameAMPL", "", "javascript:EsNegRiesameAMPL();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                Else
                    item = New MenuItem("Comunicaz.Esito Neg. Riesame Senza Osserv.", "EsNegRiesameNOoss", "", "javascript:EsNegRiesameNOoss();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                End If

                item = New MenuItem("Provvedimento Definitivo Comune", "ProvvDefComune", "", "javascript:ProvvDefComune();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If
        End If
        'RAPPORTO SINTETICO
        item = New MenuItem("Rapporto Sintetico", "rappANF", "", "javascript:RapportoANF();")
        MenuStampe.Items(0).ChildItems.Add(item)


        item = New MenuItem("ELENCO STAMPE", "ElStamp", "", "javascript:ElStampe();")
        MenuStampe.Items(0).ChildItems.Add(item)

    End Sub

    Private Sub MenuVoltura()
        Dim item As MenuItem

        'If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedValue <> 8 Then

        If modPresent = "0" Then
            item = New MenuItem("Ricezione Richiesta", "RicezRicVOL", "", "javascript:RichVoltura();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        item = New MenuItem("Avvio Procedimento", "AvvProcedVOL", "", "javascript:AvvProcVoltura();")
        MenuStampe.Items(0).ChildItems.Add(item)

        If CType(Dom_Note1.FindControl("chkSoprall"), CheckBox).Checked = True Then
            item = New MenuItem("Sopralluogo", "ModuloSoprallVOL", "", "javascript:ModSoprall();")
            MenuStampe.Items(0).ChildItems.Add(item)

            item = New MenuItem("Comunicaz. Sopralluogo", "SoprUtenteVOL", "", "javascript:SoprallUtente();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        If CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1 Then
            item = New MenuItem("Comunicaz.Esito Positivo", "EsitoPosiVOL", "", "javascript:EsPositVolt();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        If CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1 Then
            item = New MenuItem("Comunicaz.Esito Negativo", "EsitoNegaVOL", "", "javascript:EsitoNega();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        If CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 1 Then
            item = New MenuItem("Comunicaz.Esito Positivo Riesame", "EsitoPosRiesVOL", "", "javascript:EsitoPosRies();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        If CType(Dom_Decisioni1.FindControl("esNegaRiesame"), HiddenField).Value = 1 Then
            If fl_osserv = 1 Then
                item = New MenuItem("Comunicaz.Esito Negativo Riesame", "EsitoNegatRiesVOL", "", "javascript:EsitoNegatRies();")
                MenuStampe.Items(0).ChildItems.Add(item)
            Else
                item = New MenuItem("Comunicaz.Esito Neg. Riesame Senza Osserv.", "EsitoNegatRiesNOVOL", "", "javascript:EsitoNegatRiesNO();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If
        End If
        'Else
        '    item = New MenuItem("Richiesta variazione assegn.", "RichiestaVariazAss", "", "javascript:DomSubentroFFOO();")
        '    MenuStampe.Items(0).ChildItems.Add(item)

        '    item = New MenuItem("Avvio Procedimento", "AvvProcedVOL", "", "javascript:AvvProcVoltura();")
        '    MenuStampe.Items(0).ChildItems.Add(item)

        '    If CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1 Then
        '        item = New MenuItem("Esito Positivo", "EsitoPosFFOO", "", "javascript:EsPositFFOO();")
        '        MenuStampe.Items(0).ChildItems.Add(item)
        '    End If

        '    If CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1 Then
        '        For i = 0 To CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items.Count - 1
        '            If CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items(i).Selected = True Then
        '                'item = New MenuItem("Lettera di decadenza", "LettDecadenza1", "", "javascript:EsiNegatFFOO();")
        '                'MenuStampe.Items(0).ChildItems.Add(item)
        '                Select Case CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).SelectedValue
        '                    Case 50, 53, 48
        '                        item = New MenuItem("Lettera di decadenza", "LettDecadenza1", "", "javascript:EsiNegatFFOO();")
        '                        MenuStampe.Items(0).ChildItems.Add(item)
        '                End Select
        '            End If
        '        Next
        '    End If

        'End If

        'RAPPORTO SINTETICO
        item = New MenuItem("Rapporto Sintetico", "rappCAIN", "", "javascript:RapportoCAIN();")
        MenuStampe.Items(0).ChildItems.Add(item)


        item = New MenuItem("ELENCO STAMPE", "ElStamp", "", "javascript:ElStampe();")
        MenuStampe.Items(0).ChildItems.Add(item)

    End Sub

    Private Sub MenuSubentro()
        Dim item As MenuItem

        If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedValue <> 6 Then

            item = New MenuItem("Avvio Procedimento", "AvvioProcSUB", "", "javascript:AvvioProcSUB();")
            MenuStampe.Items(0).ChildItems.Add(item)


            item = New MenuItem("Domanda di Subentro", "DomandaSUB", "", "javascript:DomSubentro();")
            MenuStampe.Items(0).ChildItems.Add(item)

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 2 Then
                item = New MenuItem("Perm. Requisiti per rinunciante", "PermReqRSUB", "", "javascript:CertRinunciante();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1 Then
                item = New MenuItem("Richiesta Doc.Mancante", "DocMancanteSUB", "", "javascript:DocMancanteSUB();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Note1.FindControl("chkSoprall"), CheckBox).Checked = True Then
                item = New MenuItem("Sopralluogo", "SoprallSUB", "", "javascript:Sopralluogo();")
                MenuStampe.Items(0).ChildItems.Add(item)

                item = New MenuItem("Comunicaz. Sopralluogo", "ComSopralSUB", "", "javascript:ComSoprall();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1 Then
                item = New MenuItem("Esito Positivo", "EsitoPosSUB", "", "javascript:EsPositSub();")
                MenuStampe.Items(0).ChildItems.Add(item)

                If CType(Me.Page.FindControl("cmbNazioneNas"), DropDownList).SelectedItem.Text <> "ITALIA" Then
                    item = New MenuItem("Esito Positivo Commissariato", "EsitoPosComSUB", "", "javascript:EsPosCommiss();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                End If

                If condominio = True Then
                    item = New MenuItem("Esito Positivo Condomini", "EsitoPosCondom", "", "javascript:EsPosCondom();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                End If
            End If

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbSiNo"), DropDownList).Visible = True And CType(Dom_Dichiara_Cambi1.FindControl("cmbSiNo"), DropDownList).SelectedValue = 1 Then
                item = New MenuItem("Esito Positivo Dir. Crediti", "EsitoPosDRCSUB", "", "javascript:EsPosDirezCrediti();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            'If CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1 Then
            '    item = New MenuItem("Comunicaz. Comm. di Governo", "ComGovSUB", "", "javascript:ComCommissGoverno();")
            '    MenuStampe.Items(0).ChildItems.Add(item)
            'End If

            If CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1 Then
                item = New MenuItem("Esito Negativo", "EsitNegSUB", "", "javascript:EsiNegat();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 1 Then
                item = New MenuItem("Esito Positivo Riesame", "EsitPosRiSUB", "", "javascript:EsiPosRies();")
                MenuStampe.Items(0).ChildItems.Add(item)

                item = New MenuItem("Esito Positivo Commissariato", "EsitoPosComSUB", "", "javascript:EsPosCommiss();")
                MenuStampe.Items(0).ChildItems.Add(item)

                If condominio = True Then
                    item = New MenuItem("Esito Positivo Condomini", "EsitoPosCondom", "", "javascript:EsPosCondom();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                End If
            End If

            If CType(Dom_Decisioni1.FindControl("esNegaRiesame"), HiddenField).Value = 1 Then
                If fl_osserv = 1 Then
                    item = New MenuItem("Esito Negativo Riesame Con Oss.", "EsitNegRiesSUB", "", "javascript:EsiNegaRies();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                Else
                    item = New MenuItem("Esito Neg. Riesame Senza Oss.", "EsitNegRiesSUBNoOSS", "", "javascript:EsiNegaRiesNoOSS();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                End If

                ''****** 12/06/2012  STESSO MODELLO NEL CASO DI PRESENZA DI OSSERV. O MENO ******
                'item = New MenuItem("Esito Negativo Riesame", "EsitNegRiesSUB", "", "javascript:EsiNegaRies();")
                'MenuStampe.Items(0).ChildItems.Add(item)
            End If

            item = New MenuItem("Rapporto Sintetico", "rappVAIN", "", "javascript:RapportoVAIN();")
            MenuStampe.Items(0).ChildItems.Add(item)
        Else
            item = New MenuItem("Richiesta variazione assegn.", "RichiestaVariazAss", "", "javascript:DomSubentroFFOO();")
            MenuStampe.Items(0).ChildItems.Add(item)




            If CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1 Then
                If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 12 Then
                    item = New MenuItem("Es. Positivo Decesso", "EsitoPosFFOO", "", "javascript:EsPositFFOO();")
                    MenuStampe.Items(0).ChildItems.Add(item)

                    item = New MenuItem("Es. Positivo Decesso con Motivo", "EsitoPosFFOO2", "", "javascript:EsPositFFOO2();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                Else
                    item = New MenuItem("Es. Positivo", "EsitoPosFFOO1", "", "javascript:EsPositFFOO();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                End If
            End If

            If CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1 Then
                item = New MenuItem("Lettera di decadenza per Comune", "LettDecadenzaCom", "", "javascript:LetteraDecadenza();")
                MenuStampe.Items(0).ChildItems.Add(item)

                For i = 0 To CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items.Count - 1
                    If CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items(i).Selected = True Then
                        Select Case CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items(i).Value
                            Case 35
                                item = New MenuItem("Lettera di decadenza (lett.f art.18)", "LettDecadenza1", "", "javascript:EsiNegatFFOO1();")
                                MenuStampe.Items(0).ChildItems.Add(item)
                            Case 18
                                item = New MenuItem("Lettera di decadenza (redditi oltre i limiti)", "LettDecadenza2", "", "javascript:EsiNegatFFOO2();")
                                MenuStampe.Items(0).ChildItems.Add(item)
                            Case 21
                                item = New MenuItem("Lettera di decadenza (ulteriore carenza)", "LettDecadenza3", "", "javascript:EsiNegatFFOO3();")
                                MenuStampe.Items(0).ChildItems.Add(item)
                        End Select
                    End If
                Next
            End If

            If CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1 Or CType(Dom_Decisioni1.FindControl("esNegaRiesame"), HiddenField).Value = 1 Then
                item = New MenuItem("Lettera di Trasformazione", "LettTrasfor", "", "javascript:LetteraTrasf();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If
            item = New MenuItem("Rapporto Sintetico", "rappVAIN", "", "javascript:RapportoVAINFFOO();")
            MenuStampe.Items(0).ChildItems.Add(item)

        End If


        item = New MenuItem("ELENCO STAMPE", "ElStamp", "", "javascript:ElStampe();")
        MenuStampe.Items(0).ChildItems.Add(item)


    End Sub

    Private Sub MenuOspitalita()

        Dim item As MenuItem

        item = New MenuItem("Avvio Procedimento", "AvvioProcOSP", "", "javascript:AvvioProcOSP();")
        MenuStampe.Items(0).ChildItems.Add(item)


        If CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1 Then
            item = New MenuItem("Richiesta Doc.Mancante", "DocMancanteOSP", "", "javascript:DocMancanteOSP();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        If modPresent = "0" Then
            If CType(Dom_Ospiti1.FindControl("ListBox1"), ListBox).Items.Count > 0 Then


                If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 14 Then
                    item = New MenuItem("Richiesta di Ospitalità Generica", "RichOSP", "", "javascript:RichOSP();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                End If

                If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 15 Then
                    item = New MenuItem("Richiesta di Ospitalità Assistenza", "RichOSPbada", "", "javascript:RichOSPbada();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                End If

                If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 16 Then
                    item = New MenuItem("Richiesta di Ospitalità Scolast.", "RichOSPscol", "", "javascript:RichOSPscol();")
                    MenuStampe.Items(0).ChildItems.Add(item)
                End If
            End If
        End If

        If CType(Dom_Ospiti1.FindControl("ListBox1"), ListBox).Items.Count > 0 Then
            item = New MenuItem("Autocertificazione Stato di Famiglia", "StFamigliaOSP", "", "javascript:StFamigliaOSP();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        If CType(Dom_Note1.FindControl("chkSoprall"), CheckBox).Checked = True Then
            item = New MenuItem("Sopralluogo", "SopralluogoOSP", "", "javascript:SopralluogoOSP();")
            MenuStampe.Items(0).ChildItems.Add(item)

            item = New MenuItem("Comunicaz. Sopralluogo", "ComSoprallOSP", "", "javascript:ComSoprallOSP();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        If CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1 Then
            item = New MenuItem("Esito Negativo", "EsiNegatOSP", "", "javascript:EsiNegatOSP();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        If CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1 Then
            If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 14 Then
                item = New MenuItem("Esito Positivo", "EsPositOSP", "", "javascript:EsPositOSP();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 15 Then
                item = New MenuItem("Esito Positivo per Assistenza", "EsPositOSPbada", "", "javascript:EsPositOSPbada();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 16 Then
                item = New MenuItem("Esito Positivo per autorizz.scolastica", "EsPositOSPscol", "", "javascript:EsPositOSPscol();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If
        End If

        If CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 1 Then
            If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 14 Then
                item = New MenuItem("Esito Positivo Riesame", "EsPosRiesOSP", "", "javascript:EsPosRiesOSP();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 15 Then
                item = New MenuItem("Esito Positivo Riesame per Assistenza", "EsPosRiesOSPbada", "", "javascript:EsPosRiesOSPbada();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 16 Then
                item = New MenuItem("Esito Positivo Riesame per autorizz.scolastica", "EsPosRiesOSPscol", "", "javascript:EsPosRiesOSPscol();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If
        End If

        If CType(Dom_Decisioni1.FindControl("esNegaRiesame"), HiddenField).Value = 1 Then
            If fl_osserv = 1 Then
                item = New MenuItem("Comunicaz.Esito Neg. Riesame Con Osserv.", "EsitoNegRiesOsservOSP", "", "javascript:EsitoNegRiesOsservOSP();")
                MenuStampe.Items(0).ChildItems.Add(item)
            Else
                item = New MenuItem("Comunicaz.Esito Neg. Riesame Senza Osserv.", "EsitoNegRiesNoOsservOSP", "", "javascript:EsitoNegRiesNoOsservOSP();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If
        End If

        item = New MenuItem("Rapporto Sintetico", "rappOSP", "", "javascript:RapportoOSP();")
        MenuStampe.Items(0).ChildItems.Add(item)


        item = New MenuItem("ELENCO STAMPE", "ElStamp", "", "javascript:ElStampe();")
        MenuStampe.Items(0).ChildItems.Add(item)

    End Sub


    Private Sub MenuCambiEmerg()
        Dim item As MenuItem

        'item = New MenuItem("Modulo Offerta Alloggio", "OffertaALL", "", "javascript:ModOffertaAlloggio();")
        'MenuStampe.Items(0).ChildItems.Add(item)

        If CheckCoincidenzaNucleo() = False Then
            item = New MenuItem("Composizione Nucleo", "CompNucleo", "", "javascript:ComposizioneNucleo();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        If CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1 Then
            item = New MenuItem("Documentaz. Mancante", "DocMancante", "", "javascript:DocumentazioneMancante();")
            MenuStampe.Items(0).ChildItems.Add(item)
        End If

        If CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1 Then
            For i = 0 To CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items.Count - 1
                If CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items(i).Selected = True Then
                    Select Case CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items(i).Value
                        Case "46"
                            item = New MenuItem("Esito Negativo All. Adeguato", "EsitoNegatAllAdeg", "", "javascript:EsitoNegatAllAdeguato();")
                            MenuStampe.Items(0).ChildItems.Add(item)
                        Case "47"
                            item = New MenuItem("Esito Negativo ISEE", "EsitoNegatISEE", "", "javascript:EsitoNegativoISEE();")
                            MenuStampe.Items(0).ChildItems.Add(item)
                        Case "48"
                            item = New MenuItem("Esito Negativo Morosità", "EsitoNegatMoros", "", "javascript:EsitoNegatMorosita();")
                            MenuStampe.Items(0).ChildItems.Add(item)
                        Case "49"
                            item = New MenuItem("Esito Negativo Requisiti", "EsitoNegatRequis", "", "javascript:EsitoNegatRequisiti();")
                            MenuStampe.Items(0).ChildItems.Add(item)
                        Case Else
                            item = New MenuItem("Esito Negativo", "EsitoNegat", "", "javascript:EsitoNegativoArt22();")
                            MenuStampe.Items(0).ChildItems.Add(item)
                    End Select
                End If
            Next
        End If

        If CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1 Then
            item = New MenuItem("Esito Positivo", "EsitoPosit", "", "javascript:EsitoPositivoArt22();")
            MenuStampe.Items(0).ChildItems.Add(item)

            'If morosita = 1 Then
            '    item = New MenuItem("Esito Positivo Morosità", "EsitoPositMoros", "", "javascript:EsitoPositMorosita();")
            '    MenuStampe.Items(0).ChildItems.Add(item)
            'End If
        End If

        If CType(Dom_Decisioni1.FindControl("esNegaRiesame"), HiddenField).Value = 1 Then
            If fl_osserv = 1 Then
                item = New MenuItem("Esito Negativo Ricorso", "EsitoNegatRic", "", "javascript:EsitoNegatRicorso();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If
        End If

        If CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 1 Then
            If fl_osserv = 1 Then
                item = New MenuItem("Esito Positivo Ricorso", "EsitoPositRic", "", "javascript:EsitoPositRicorso();")
                MenuStampe.Items(0).ChildItems.Add(item)
            End If
        End If

        item = New MenuItem("ELENCO STAMPE", "ElStampART22", "", "javascript:ElStampeART22();")
        MenuStampe.Items(0).ChildItems.Add(item)

    End Sub
    Private Sub MenuCambioCons()
        Dim item As MenuItem

        If modPresent = "0" Then
            If CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text <> "" Then
                item = New MenuItem("Richiesta Cambio Consensuale", "RichCAMB", "", "javascript:RichCAMB();")
                MenuStampe.Items(0).ChildItems.Add(item)
                'If CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Checked = False Then
                '    item = New MenuItem("Richiesta Cambio Consensuale 2", "RichCAMB2", "", "javascript:RichCAMB2();")
                '    MenuStampe.Items(0).ChildItems.Add(item)
                'End If
            End If
        End If

        item = New MenuItem("Dichiarazione Permanenza Requisiti ERP", "DichPermanenza", "", "javascript:DichPermanenzaReq();")
        MenuStampe.Items(0).ChildItems.Add(item)

        'If CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Checked = False Then
        '    item = New MenuItem("Dichiarazione Permanenza Requisiti ERP 2", "DichPermanenza2", "", "javascript:DichPermanenzaReq2();")
        '    MenuStampe.Items(0).ChildItems.Add(item)
        'End If

        If CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1 Then
            item = New MenuItem("Richiesta Doc.Mancante", "DocMancCAMB", "", "javascript:DocMancanteCAMB();")
            MenuStampe.Items(0).ChildItems.Add(item)

            'If CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Checked = False Then
            '    item = New MenuItem("Richiesta Doc.Mancante 2", "DocMancCAMB2", "", "javascript:DocMancanteCAMB2();")
            '    MenuStampe.Items(0).ChildItems.Add(item)
            'End If
        End If

        item = New MenuItem("Avvio Procedimento", "AvvProcedCAMB", "", "javascript:AvvioProcCAMB();")
        MenuStampe.Items(0).ChildItems.Add(item)

        'If CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Checked = False Then
        '    item = New MenuItem("Avvio Procedimento 2", "AvvProcedCAMB2", "", "javascript:AvvioProcCAMB2();")
        '    MenuStampe.Items(0).ChildItems.Add(item)
        'End If

        If CType(Dom_Note1.FindControl("chkSoprall"), CheckBox).Checked = True Then
            item = New MenuItem("Sopralluogo", "SoprallCAMB", "", "javascript:SopralluogoCAMB();")
            MenuStampe.Items(0).ChildItems.Add(item)

            item = New MenuItem("Comunicaz. Sopralluogo", "ComSoprallCAMB", "", "javascript:ComSoprallCAMB();")
            MenuStampe.Items(0).ChildItems.Add(item)

            'If CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Checked = False Then
            '    item = New MenuItem("Comunicaz. Sopralluogo 2", "ComSoprallCAMB2", "", "javascript:ComSoprallCAMB2();")
            '    MenuStampe.Items(0).ChildItems.Add(item)
            'End If
        End If

        If CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1 Then
            item = New MenuItem("Comunicaz.Esito Positivo", "EsPositCAMB", "", "javascript:EsPositCAMB();")
            MenuStampe.Items(0).ChildItems.Add(item)

            'If CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Checked = False Then
            '    item = New MenuItem("Comunicaz.Esito Positivo 2", "EsPositCAMB2", "", "javascript:EsPositCAMB2();")
            '    MenuStampe.Items(0).ChildItems.Add(item)
            'End If
        End If

        If CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1 Then
            item = New MenuItem("Comunicaz.Esito Negativo", "EsNegaCAMB", "", "javascript:EsiNegatCAMB();")
            MenuStampe.Items(0).ChildItems.Add(item)

            'If CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Checked = False Then
            '    item = New MenuItem("Comunicaz.Esito Negativo 2", "EsNegaCAMB2", "", "javascript:EsiNegatCAMB2();")
            '    MenuStampe.Items(0).ChildItems.Add(item)
            'End If

        End If

        item = New MenuItem("Rapporto Sintetico", "rappCACO", "", "javascript:RapportoCACO();")
        MenuStampe.Items(0).ChildItems.Add(item)


        item = New MenuItem("ELENCO STAMPE", "ElStamp", "", "javascript:ElStampe();")
        MenuStampe.Items(0).ChildItems.Add(item)

    End Sub

    Private Sub MessJQuery(ByVal Messaggio As String, ByVal Tipo As Integer, Optional ByVal Titolo As String = "Messaggio")
        Try
            Dim sc As String = ""
            If Tipo = 0 Then
                sc = ScriptErrori(Messaggio, Titolo)
            Else
                sc = ScriptChiudi(Messaggio, Titolo)
            End If
            ScriptManager.RegisterClientScriptBlock(UpdatePanel1, UpdatePanel1.GetType(), "ScriptMsg", sc, True)

        Catch ex As Exception
            'lblErrore.Text = ex.Message
            'lblErrore.Visible = True
        End Try
    End Sub

    Private Function ScriptErrori(ByVal Messaggio As String, Optional ByVal Titolo As String = "Messaggio") As String
        Try
            Dim retvalue As String = ""
            Dim sb As New StringBuilder
            sb.Append("$(document).ready(function(){")
            sb.Append("$('#dialog').text('" & Messaggio & "');")
            sb.Append("$('#dialog').dialog({ autoOpen:true, modal:true, show:'blind', hide:'explode', title:'" & Titolo & "',buttons: {'Ok': function() {$(this).dialog('close');}}});")
            sb.Append("});")
            retvalue = sb.ToString()
            Return retvalue
        Catch ex As Exception
            Return ""
        End Try
    End Function

    Private Function ScriptChiudi(ByVal Messaggio As String, Optional ByVal Titolo As String = "Messaggio") As String
        Try
            Dim retvalue As String = ""
            Dim sb As New StringBuilder
            sb.Append("$(document).ready(function(){")
            sb.Append("$('#dialog').text('" & Messaggio & "');")
            sb.Append("$('#dialog').dialog({ autoOpen:true, modal:true, show:'blind', hide:'explode', title:'" & Titolo & "',buttons: {'Ok': function() {$(this).dialog('close');}}});")
            sb.Append("});")
            retvalue = sb.ToString()
            Return retvalue
        Catch ex As Exception
            Return ""
        End Try
    End Function

    Public Property CHIUDI() As Long
        Get
            If Not (ViewState("par_CHIUDI") Is Nothing) Then
                Return CLng(ViewState("par_CHIUDI"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_CHIUDI") = value
        End Set

    End Property

    Private Sub SettaControlModifiche(ByVal obj As Control)
        Dim CTRL As Control
        For Each CTRL In obj.Controls
            If CTRL.Controls.Count > 0 Then
                SettaControlModifiche(CTRL)
            End If
            If TypeOf CTRL Is TextBox Then
                DirectCast(CTRL, TextBox).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            ElseIf TypeOf CTRL Is DropDownList Then
                DirectCast(CTRL, DropDownList).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            ElseIf TypeOf CTRL Is CheckBox Then
                DirectCast(CTRL, CheckBox).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            ElseIf TypeOf CTRL Is Button Then
                DirectCast(CTRL, Button).Attributes.Add("onclick", "javascript:document.getElementById('caric').style.visibility ='visible';")

            End If
        Next

    End Sub

    Public Function VisualizzaDomanda()
        Dim CT1 As DropDownList
        Dim cT As TextBox
        Dim lIndiceAppoggio_0 As Long
        Dim lIndiceAppoggio_1 As Long
        Dim lIndiceAppoggio_2 As Long
        Dim LB1 As Label
        Dim VALORE_R As Double

        'Variabili 23/01/2012 Gestione Tempistica
        Dim data_presentazione As String = ""
        Dim IDmotivoDom As Integer


        Dim presDocManca As Integer
        Dim dataPresDocM As String = ""
        Dim fl_autorizza As Integer


        Try
            par.OracleConn.Open()
            par.SettaCommand(par)
            'HttpContext.Current.Session.Add("CONNESSIONE", par.OracleConn)


            '22/06/2012 - Stringa di connessione in sessione
            HttpContext.Current.Session.Add(lIdConnessDOMANDA, par.OracleConn)
            Session.Add("lIdConnessDOMANDA", lIdConnessDOMANDA)


            If Session.Item("ANAGRAFE") = "0" Then
                imgAnagrafe.Visible = False
                imgAnagrafe.Attributes.Clear()
            Else
                imgAnagrafe.Visible = True
            End If


            par.cmd.CommandText = "SELECT BANDI_VSA.STATO,DOMANDE_BANDO_VSA.FL_RINNOVO,DATA_PRESENTAZIONE,ID_MOTIVO_DOMANDA FROM BANDI_VSA,DOMANDE_BANDO_VSA WHERE DOMANDE_BANDO_VSA.ID=" & lIdDomanda & " AND DOMANDE_BANDO_VSA.ID_BANDO=BANDI_VSA.ID"
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                data_presentazione = par.IfNull(myReader("DATA_PRESENTAZIONE"), "")
                IDmotivoDom = par.IfNull(myReader("ID_MOTIVO_DOMANDA"), "")
                FL_RINNOVO = par.IfNull(myReader("FL_RINNOVO"), "")
                FL_VECCHIO_BANDO = CStr(myReader("STATO"))

                If Request.QueryString("GLocat") = "" Then
                    CType(Dom_Dichiara_Cambi1.FindControl("lblDurataProc"), Label).Text = "Durata max procedimento: <b>" & tempoProcesso(IDmotivoDom) & " giorni </b>"
                Else
                    CType(Dom_Dichiara_Cambi1.FindControl("lblDurataProc"), Label).Visible = False
                End If

                If Session.Item("id_caf") = "6" Then
                    HiddenField1.Value = "1"
                End If

                If myReader("STATO") <> 1 And Fl_Integrazione <> "1" And Session.Item("id_caf") <> "6" Then
                    btnSalva.Visible = False
                    'Label5.Visible = False
                    imgStampa.Visible = False
                    'Label6.Visible = False

                    Dom_Alloggio_ERP1.DisattivaTutto()
                    DisattivaTutto()
                    Dom_Dichiara_Cambi1.DisattivaTutto()
                    Dom_Requisiti_Cambi1.DisattivaTutto()
                    Dom_Note1.DisattivaTutto()

                    If Fl_US <> "1" Then
                        Response.Write("<script>alert('Il Bando a cui appartiene questa domanda è CHIUSO. Per apportare modifiche usare le funzioni di INTEGRAZIONE!');</script>")
                    End If
                End If
            End If
            myReader.Close()

            If IDmotivoDom <> 3 Or IDmotivoDom <> 4 Then
                imgStampa.Visible = False
            Else
                imgStampa.Visible = True
            End If

            par.cmd.CommandText = "SELECT DICHIARAZIONI_VSA.ID_STATO,DOMANDE_BANDO_VSA.ID_CAUSALE_DOMANDA FROM DICHIARAZIONI_VSA,DOMANDE_BANDO_VSA WHERE DOMANDE_BANDO_VSA.ID=" & lIdDomanda & " AND DOMANDE_BANDO_VSA.ID_DICHIARAZIONE=DICHIARAZIONI_VSA.ID"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                If myReader("ID_STATO") <> 1 Then
                    btnSalva.Visible = False

                    imgStampa.Visible = False

                    Dom_Alloggio_ERP1.DisattivaTutto()
                    DisattivaTutto()
                    Dom_Dichiara_Cambi1.DisattivaTutto()
                    Dom_Requisiti_Cambi1.DisattivaTutto()
                    Me.MenuStampe.Visible = True
                    'Dom_Note1.DisattivaTutto()
                    If Fl_US <> "1" Then
                        'Response.Write("<script>alert('LA DICHIARAZIONE NON è COMPLETA!');</script>")
                        dichCompleta.Value = "1"
                        btnSalva.Visible = True
                        If IDmotivoDom = 3 Then
                            imgStampa.Visible = True
                        End If
                        CType(Dom_DocAllegati.FindControl("chkListDocumenti"), CheckBoxList).Enabled = True
                        IMGCanone.Visible = False
                        Dom_Decisioni1.DisattivaTutto()
                    End If
                End If
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT DOMANDE_BANDO_VSA.N_DISTINTA,DICHIARAZIONI_VSA.ANNO_SIT_ECONOMICA,DICHIARAZIONI_VSA.ID_CAF,DICHIARAZIONI_VSA.MOD_PRESENTAZIONE,CAF_WEB.COD_CAF,DOMANDE_BANDO_VSA.FL_RINNOVO,DOMANDE_BANDO_VSA.FL_INIZIO_REQ,DOMANDE_BANDO_VSA.ID_STATO,domande_bando_VSA.fl_verifica_conclusa FROM DOMANDE_BANDO_VSA,DICHIARAZIONI_VSA,CAF_WEB WHERE DOMANDE_BANDO_VSA.ID_DICHIARAZIONE=DICHIARAZIONI_VSA.ID AND DICHIARAZIONI_VSA.ID_CAF=CAF_WEB.ID AND DOMANDE_BANDO_VSA.ID=" & lIdDomanda
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                annoSitEconom = par.IfNull(myReader("ANNO_SIT_ECONOMICA"), 0)
                'LBLENTE.Visible = True
                'LBLENTE.Text = "Ente Ins.: " & par.IfNull(myReader("COD_CAF"), "")
                modPresent = par.IfNull(myReader("MOD_PRESENTAZIONE"), "")
                If Session.Item("id_caf") = "6" Then
                    'If Session.Item("id_caf") = "6" Then
                    '    If par.IfNull(myReader("ID_STATO"), -1) = "8" Or par.IfNull(myReader("ID_STATO"), -1) = "2" Or par.IfNull(myReader("ID_STATO"), -1) = "4" Then



                    '    Else
                    '        btnSalva.Visible = False
                    '        imgStampa.Visible = False

                    '        Dom_Alloggio_ERP1.DisattivaTutto()
                    '        Me.DisattivaTutto()
                    '        Dom_Abitative_2_1.DisattivaTutto()
                    '        Dom_Abitative_1_1.DisattivaTutto()
                    '        Dom_Dichiara_Cambi1.DisattivaTutto()
                    '        Dom_Familiari1.DisattivaTutto()
                    '        Dom_Requisiti_Cambi1.DisattivaTutto()
                    '        Note1.Disattivatutto()
                    '    End If
                    '    If par.IfNull(myReader("N_DISTINTA"), -1) = 0 And myReader("ID_CAF") <> Session.Item("ID_CAF") Then

                    '        btnSalva.Visible = False
                    '        imgStampa.Visible = False

                    '        Dom_Alloggio_ERP1.DisattivaTutto()
                    '        Me.DisattivaTutto()
                    '        Dom_Abitative_2_1.DisattivaTutto()
                    '        Dom_Abitative_1_1.DisattivaTutto()
                    '        Dom_Dichiara_Cambi1.DisattivaTutto()

                    '        Dom_Familiari1.DisattivaTutto()
                    '        Dom_Requisiti_Cambi1.DisattivaTutto()
                    '        Note1.Disattivatutto()
                    '        If Fl_US <> "1" Then
                    '            Response.Write("<script>alert('Non è possibile modificare. La domanda è ancora in carico presso un ente esterno!');</script>")
                    '        End If
                    '    End If
                    'Else
                    'If myReader("N_DISTINTA") > 0 And myReader("FL_RINNOVO") <> "1" Then
                    If par.IfNull(myReader("N_DISTINTA"), -1) > 0 And Fl_Integrazione <> "1" Then
                        btnSalva.Visible = False

                        imgStampa.Visible = False

                        Dom_Alloggio_ERP1.DisattivaTutto()
                        DisattivaTutto()
                        Dom_Dichiara_Cambi1.DisattivaTutto()
                        Dom_Requisiti_Cambi1.DisattivaTutto()
                        Dom_Note1.DisattivaTutto()
                        If Fl_US <> "1" Then
                            Response.Write("<script>alert('Non è possibile modificare. La domanda è stata scaricata nella distinta N. " & par.IfNull(myReader("N_DISTINTA"), "") & " ! USARE LE FUNZIONI DI INTEGRAZIONE');</script>")
                        End If
                        'End If
                    End If
                Else
                    'If myReader("N_DISTINTA") > 0 And myReader("FL_RINNOVO") <> "1" Then
                    If par.IfNull(myReader("N_DISTINTA"), -2) > 0 And Fl_Integrazione <> "1" Then
                        btnSalva.Visible = False
                        'Label5.Visible = False
                        imgStampa.Visible = False
                        'Label6.Visible = False

                        Dom_Alloggio_ERP1.DisattivaTutto()
                        DisattivaTutto()
                        Dom_Dichiara_Cambi1.DisattivaTutto()
                        Dom_Requisiti_Cambi1.DisattivaTutto()
                        Dom_Note1.DisattivaTutto()
                        If Fl_US <> "1" Then
                            Response.Write("<script>alert('Non è possibile modificare. La domanda è stata scaricata nella distinta N. " & par.IfNull(myReader("N_DISTINTA"), "") & " ! USARE LE FUNZIONI DI INTEGRAZIONE');</script>")
                        End If
                    End If
                End If
            Else
                'If Len(Session.Item("OPERATORE")) > 6 Then
                'If Session.Item("id_caf") = "6" Then
                '    btnSalva.Visible = False
                '    'Label5.Visible = False
                '    imgStampa.Visible = False
                '    'Label6.Visible = False

                '    Dom_Alloggio_ERP1.DisattivaTutto()
                '    Me.DisattivaTutto()
                '    Dom_Abitative_2_1.DisattivaTutto()
                '    Dom_Abitative_1_1.DisattivaTutto()
                '    Dom_Dichiara_Cambi1.DisattivaTutto()
                '    Dom_Familiari1.DisattivaTutto()
                '    Dom_Requisiti_Cambi1.DisattivaTutto()
                '    Note1.Disattivatutto()
                '    If Fl_US <> "1" Then
                '        Response.Write("<script>alert('Non è possibile modificare. La domanda NON è stata ancora creata!');</script>")
                '    End If
                'End If
                'End If
            End If
            myReader.Close()



            par.RiempiDList(Me, par.OracleConn, "cmbNazioneNas", "SELECT * FROM COMUNI_NAZIONI WHERE SIGLA IN ('I','C','E') ORDER BY NOME ASC", "NOME", "ID")
            par.RiempiDList(Me, par.OracleConn, "cmbNazioneRes", "SELECT * FROM COMUNI_NAZIONI WHERE SIGLA IN ('I','C','E') ORDER BY NOME ASC", "NOME", "ID")
            par.RiempiDList(Me, par.OracleConn, "cmbPrNas", "SELECT DISTINCT SIGLA FROM COMUNI_NAZIONI ORDER BY SIGLA ASC", "SIGLA", "SIGLA")
            par.RiempiDList(Me, par.OracleConn, "cmbPrRes", "SELECT DISTINCT SIGLA FROM COMUNI_NAZIONI ORDER BY SIGLA ASC", "SIGLA", "SIGLA")
            par.RiempiDList(Me, par.OracleConn, "cmbProvRec", "SELECT DISTINCT SIGLA FROM COMUNI_NAZIONI ORDER BY SIGLA ASC", "SIGLA", "SIGLA")
            par.RiempiDList(Me, par.OracleConn, "cmbTipoIRes", "SELECT DESCRIZIONE,COD FROM T_TIPO_INDIRIZZO ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
            par.RiempiDList(Me, par.OracleConn, "cmbTipoIRec", "SELECT DESCRIZIONE,COD FROM T_TIPO_INDIRIZZO ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
            par.RiempiDList(Me, par.OracleConn, "cmbResidenza", "SELECT DESCRIZIONE,ID FROM T_RESIDENZA_LOMBARDIA where id=2 or id=3 ORDER BY ID ASC", "DESCRIZIONE", "ID")


            par.RiempiDList(Dom_Alloggio_ERP1, par.OracleConn, "cmbPianoUnita", "SELECT DESCRIZIONE,cod FROM siscom_mi.tipo_livello_piano ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")

            If Request.QueryString("GLocat") = "" Then
                par.RiempiDList(Dom_Dichiara_Cambi1, par.OracleConn, "cmbTipoRichiesta", "SELECT DESCRIZIONE,ID FROM T_MOTIVO_DOMANDA_VSA ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "ID")

            Else
                par.RiempiDList(Dom_Dichiara_Cambi1, par.OracleConn, "cmbTipoRichiesta", "SELECT DESCRIZIONE,ID FROM T_MOTIVO_DOMANDA_VSA WHERE ID=4 OR ID=5 ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "ID")
            End If


            If tipoRichiesta.Value <> "5" And Request.QueryString("GLocat") = "" Then
                par.RiempiDList(Dom_Dichiara_Cambi1, par.OracleConn, "cmbPresentaD", "SELECT DESCRIZIONE,COD FROM T_CAUSALI_DOMANDA_VSA ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
            End If

            par.RiempiDList(Dom_Alloggio_ERP1, par.OracleConn, "cmbNazioneNas", "SELECT * FROM COMUNI_NAZIONI WHERE SIGLA IN ('I','C','E') ORDER BY NOME ASC", "NOME", "ID")
            par.RiempiDList(Dom_Alloggio_ERP1, par.OracleConn, "cmbPrNas", "SELECT DISTINCT SIGLA FROM COMUNI_NAZIONI ORDER BY SIGLA ASC", "SIGLA", "SIGLA")


            ''par.RiempiDList(Dom_Alloggio_ERP1, par.OracleConn, "cmbGestore", "SELECT DESCRIZIONE,COD FROM T_TIPO_GESTORE WHERE COD=9 OR COD=12 ORDER BY COD DESC", "DESCRIZIONE", "COD")
            'par.RiempiDList(Dom_Alloggio_ERP1, par.OracleConn, "cmbTipoContratto", "SELECT DESCRIZIONE,COD FROM T_TIPO_CONTRATTI ORDER BY COD asc", "DESCRIZIONE", "COD")
            ''par.RiempiDList(Dom_Alloggio_ERP1, par.OracleConn, "cmbTipoRapporto", "SELECT DESCRIZIONE,COD FROM T_TIPO_RAPPORTO ORDER BY COD asc", "DESCRIZIONE", "COD")




            Dim lsiFrutto As New ListItem(" ", "-1")

            CT1 = Me.Page.FindControl("cmbResidenza")
            CT1.Items.Add(lsiFrutto)
            CT1.SelectedIndex = -1
            CT1.Items.FindByValue(-1).Selected = True

            'CT1 = Dom_Alloggio_ERP1.FindControl("cmbTipoContratto")
            'CT1.Items.Add(lsiFrutto)
            'CT1.SelectedIndex = -1
            'CT1.Items.FindByValue(-1).Selected = True

            'CT1 = Dom_Alloggio_ERP1.FindControl("cmbTipoRapporto")
            'CT1.Items.Add(lsiFrutto)
            'CT1.SelectedIndex = -1
            'CT1.Items.FindByValue(-1).Selected = True

            If inlettura.Value = "1" Then
                par.cmd.CommandText = "select * from domande_bando_vsa where id=" & lIdDomanda
            Else
                If Fl_US <> "1" Then
                    par.cmd.CommandText = "SELECT * FROM DOMANDE_BANDO_VSA WHERE ID=" & lIdDomanda & " FOR UPDATE NOWAIT"
                Else
                    par.cmd.CommandText = "SELECT * FROM DOMANDE_BANDO_VSA WHERE ID=" & lIdDomanda
                End If
            End If
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then

                lIndice_Bando = myReader("ID_BANDO")
                lIdDichiarazione = myReader("ID_DICHIARAZIONE")
                lProgr = myReader("PROGR_COMPONENTE")
                sStato = myReader("id_stato")

                'peppe modify 20/09/2011
                'If par.IfNull(myReader("ID_MOTIVO_DOMANDA"), 0) = 3 Then
                '    Me.MenuStampe.Visible = True
                'Else
                '    Me.MenuStampe.Visible = False
                'End If

                CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).SelectedIndex = -1
                CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).Items.FindByValue(par.IfNull(myReader("TIPO_U"), 0)).Selected = True


                'lblISBAR.Text = par.Converti3(Format(par.IfNull(myReader("isbarc_r"), 0), "##,##0.000"))
                lblISBAR.Text = par.Tronca(par.IfNull(myReader("REDDITO_ISEE"), 0))
                lblPG.Text = par.IfNull(myReader("pg"), "")
                txtDataPG.Text = par.FormattaData(par.IfNull(myReader("data_pg"), ""))
                lblPG.ToolTip = lIdDomanda


                If Fl_US <> "1" And par.IfNull(myReader("ID_MOTIVO_DOMANDA"), "") = "4" Then
                    IMGPREFERENZE.Visible = True
                    IMGPREFERENZE.Attributes.Add("onclick", "javascript:window.open('../../ASS/GestionePreferenze.aspx?T=ART.22 C.10&ID=" & lIdDomanda & "&PG=" & lblPG.Text & "','Gestione','height=620,top=0,left=0,width=800,scrollbars=no'); return false;")
                End If
                If lblISBAR.Text >= 0 Then
                    ISEEnullo.Value = 1
                End If

                cT = Me.Page.FindControl("txtPresso")
                cT.Text = par.IfNull(myReader("PRESSO_REC_DNTE"), "")

                cT = Me.Page.FindControl("txtIndirizzoRec")
                cT.Text = par.IfNull(myReader("IND_REC_DNTE"), "")

                cT = Me.Page.FindControl("txtCivicoRec")
                cT.Text = par.IfNull(myReader("CIVICO_REC_DNTE"), "")
                If cT.Text = "" Then

                End If

                cT = Me.Page.FindControl("txtTelRec")
                cT.Text = par.IfNull(myReader("TELEFONO_REC_DNTE"), "")

                cT = Me.Page.FindControl("txtCAPRec")
                cT.Text = par.IfNull(myReader("CAP_REC_DNTE"), "")

                CT1 = CType(Me.Page.FindControl("cmbResidenza"), DropDownList)
                CT1.SelectedIndex = -1
                CT1.Items.FindByValue(par.IfNull(myReader("PERIODO_RES"), 1)).Selected = True



                CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text = par.FormattaData(par.IfNull(myReader("DATA_PRESENTAZIONE"), ""))

                CT1 = CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList)
                CT1.SelectedIndex = -1
                CT1.Items.FindByValue(par.IfNull(myReader("ID_MOTIVO_DOMANDA"), 0)).Selected = True

                '****** Combobox sottotipologie richiesta
                If Request.QueryString("GLocat") = "" Then
                    par.RiempiDList(Dom_Dichiara_Cambi1, par.OracleConn, "cmbPresentaD", "SELECT DESCRIZIONE,COD FROM T_CAUSALI_DOMANDA_VSA WHERE ID_MOTIVO = " & par.IfNull(myReader("ID_MOTIVO_DOMANDA"), 0) & " ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")

                    If CT1.SelectedValue <> "5" Then
                        CT1 = CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList)
                        CT1.SelectedIndex = -1
                        If par.IfNull(myReader("ID_CAUSALE_DOMANDA"), 0) = -1 Then
                            If Not IsNothing(CT1.Items.FindByValue(0)) Then
                                CT1.Items.FindByValue(0).Selected = True
                            End If
                        Else
                            If Not IsNothing(CT1.Items.FindByValue(par.IfNull(myReader("ID_CAUSALE_DOMANDA"), 0))) Then
                                CT1.Items.FindByValue(par.IfNull(myReader("ID_CAUSALE_DOMANDA"), 0)).Selected = True
                            End If
                        End If
                    End If
                End If


                '10/02/2012 MTeresa - Controlli sulla data di presentazione della richiesta
                If par.IfNull(myReader("ID_MOTIVO_DOMANDA"), 0) = "3" Then
                    'ControlloDataPresent(annoSitEconom, CT1.SelectedValue, CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text)
                End If
                '10/02/2012 MTeresa - FINE Controlli sulla data di presentazione della richiesta


                '10/02/2012 MTeresa - Visualizzo nel Tab Dichiara la data evento inserita e controllo il valore
                'If CT1.SelectedValue >= 17 And CT1.SelectedValue <> 20 Then
                '    CType(Dom_Dichiara_Cambi1.FindControl("lblDataEvento"), Label).Visible = True
                '    CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Visible = True
                CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text = par.FormattaData(par.IfNull(myReader("DATA_EVENTO"), ""))
                'End If
                '10/02/2012 MTeresa - FINE Visualizzo nel Tab Dichiara la data evento inserita



                '    'If par.IfNull(myReader("ID_MOTIVO_DOMANDA"), 0) = 4 Then
                '    '    cmbAccolta.Visible = False
                '    '    Label13.Visible = False
                '    'Else
                '    cmbAccolta.SelectedIndex = -1
                '    cmbAccolta.Items.FindByValue(par.IfNull(myReader("ACCOLTA"), 0)).Selected = True
                'End If

                'If sStato = "4" Then
                '    cmbAccolta.Visible = False
                '    Label13.Visible = False
                'End If

                If par.IfNull(myReader("ID_MOTIVO_DOMANDA"), "0") = "3" Then
                    CType(Dom_Dichiara_Cambi1.FindControl("Label16"), Label).Visible = True
                    CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = True
                End If

                If par.IfNull(myReader("ID_MOTIVO_DOMANDA"), "0") = "5" Then
                    CType(Dom_Dichiara_Cambi1.FindControl("Label16"), Label).Visible = False
                    CType(Dom_Dichiara_Cambi1.FindControl("lblCodContrattoScambio"), Label).Visible = True
                    CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Visible = True
                    If Request.QueryString("GLocat") = "" Then
                        CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).ReadOnly = True
                        lblPGcoll.Visible = True
                        lblSlash.Visible = True
                        lblPGcoll.Text = par.IfNull(myReader("pg_collegato"), "")
                    End If
                    CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text = par.IfNull(myReader("cod_contratto_scambio"), "")
                    CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = False
                End If


                'If sStato <> "1" And sStato <> "2" Then
                CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).Enabled = False
                CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Enabled = False

                'End If


                CT1 = CType(Dom_Dichiara_Cambi1.FindControl("cmbFattaAU"), DropDownList)
                CT1.SelectedIndex = -1
                CT1.Items.FindByValue(par.IfNull(myReader("FL_FATTA_AU"), 0)).Selected = True




                cT = Dom_Note1.FindControl("txtNote")
                cT.Text = par.IfNull(myReader("NOTE_WEB"), "")

                CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoDocumento"), DropDownList).SelectedIndex = -1
                CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoDocumento"), DropDownList).Items.FindByValue(par.IfNull(myReader("TIPO_DOCUMENTO"), 0)).Selected = True
                CType(Dom_Dichiara_Cambi1.FindControl("txtCINum"), TextBox).Text = par.IfNull(myReader("CARTA_I"), "")
                CType(Dom_Dichiara_Cambi1.FindControl("txtCIData"), TextBox).Text = par.FormattaData(par.IfNull(myReader("CARTA_I_DATA"), ""))
                CType(Dom_Dichiara_Cambi1.FindControl("txtCSData"), TextBox).Text = par.FormattaData(par.IfNull(myReader("CARTA_SOGG_DATA"), ""))
                CType(Dom_Dichiara_Cambi1.FindControl("txtPSScade"), TextBox).Text = par.FormattaData(par.IfNull(myReader("PERMESSO_SOGG_SCADE"), ""))
                CType(Dom_Dichiara_Cambi1.FindControl("txtPSRinnovo"), TextBox).Text = par.FormattaData(par.IfNull(myReader("PERMESSO_SOGG_RINNOVO"), ""))
                CType(Dom_Dichiara_Cambi1.FindControl("txtPSData"), TextBox).Text = par.FormattaData(par.IfNull(myReader("PERMESSO_SOGG_DATA"), ""))
                CType(Dom_Dichiara_Cambi1.FindControl("txtCIRilascio"), TextBox).Text = par.IfNull(myReader("CARTA_I_RILASCIATA"), "")
                CType(Dom_Dichiara_Cambi1.FindControl("txtPSNum"), TextBox).Text = par.IfNull(myReader("PERMESSO_SOGG_N"), "")
                CType(Dom_Dichiara_Cambi1.FindControl("txtCSNum"), TextBox).Text = par.IfNull(myReader("CARTA_SOGG_N"), "")

                If par.IfNull(myReader("REQUISITO1"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR1"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR1"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO1"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR1"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR1"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO2"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR2"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR2"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO3"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR3"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR3"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO4"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR4"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR4"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO5"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR5"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR5"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO7"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR6"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR6"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO8"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR7"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR7"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO9"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR8"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR8"), CheckBox).Checked = True
                End If


                If par.IfNull(myReader("REQUISITO10"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR9"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR9"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO11"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR10"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR10"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO12"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR11"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR11"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO13"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR12"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR12"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO14"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR13"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR13"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO15"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR14"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR14"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO16"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR15"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR15"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO17"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR16"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR16"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO18"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR17"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR17"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("REQUISITO19"), "0") = "0" Then
                    CType(Dom_Requisiti_Cambi1.FindControl("chR18"), CheckBox).Checked = False
                Else
                    CType(Dom_Requisiti_Cambi1.FindControl("chR18"), CheckBox).Checked = True
                End If


                Dim item As ListItem

                par.cmd.CommandText = "select * from comuni_nazioni where id=" & par.IfNull(myReader("ID_LUOGO_REC_DNTE"), 0)
                Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()

                If myReader1.Read Then
                    par.RiempiDList(Me, par.OracleConn, "cmbProvRec", "SELECT DISTINCT SIGLA FROM COMUNI_NAZIONI ORDER BY SIGLA ASC", "SIGLA", "SIGLA")

                    CT1 = Me.Page.FindControl("cmbProvRec")
                    CT1.SelectedIndex = -1
                    CT1.Items.FindByValue(par.IfNull(myReader1("SIGLA"), 0)).Selected = True
                    item = CT1.SelectedItem

                    par.RiempiDList(Me, par.OracleConn, "cmbComuneRec", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & par.PulisciStrSql(item.Text) & "' ORDER BY NOME ASC", "NOME", "ID")

                    CT1 = Me.Page.FindControl("cmbComuneRec")
                    CT1.SelectedIndex = -1
                    CT1.Items.FindByText(par.IfNull(myReader1("NOME"), "")).Selected = True
                    item = CT1.SelectedItem

                End If
                myReader1.Close()

                CT1 = Me.Page.FindControl("cmbTipoIRec")
                CT1.Items.FindByValue(par.IfNull(myReader("ID_TIPO_IND_REC_DNTE"), "")).Selected = True

                Select Case par.IfNull(myReader("PERIODO_RES"), 0)
                    Case 0
                        VALORE_R = 0
                    Case 1
                        VALORE_R = 0
                    Case 2
                        VALORE_R = 40
                    Case 3
                        VALORE_R = 85
                    Case 4
                        VALORE_R = 0
                End Select
                VALORE_R = (VALORE_R / 100) * 0.29999999999999999

                'txtIndici.Text = "V1=" & (par.IfNull(myReader("isbar"), 0)) _
                '           & "&V2=" & (par.IfNull(myReader("isbarc"), 0)) _
                '           & "&V3=" & (par.IfNull(myReader("isbarc_r"), 0)) _
                '           & "&V4=" & Format(par.IfNull(myReader("disagio_a"), 0), "##,##0.000000000000000") _
                '           & "&V5=" & Format(par.IfNull(myReader("disagio_e"), 0), "##,##0.000000000000000") _
                '           & "&V6=" & Format(par.IfNull(myReader("disagio_f"), 0), "##,##0.000000000000000") _
                '           & "&V7=" & par.Converti(par.IfNull(myReader("reddito_isee"), 0)) _
                '           & "&V8=" & par.Converti(par.IfNull(myReader("ISR_ERP"), 0)) _
                '           & "&V9=" & par.Converti(par.IfNull(myReader("ISP_ERP"), 0)) _
                '           & "&V10=" & par.Converti(par.IfNull(myReader("ISe_ERP"), 0)) _
                '           & "&V11=" & Format(VALORE_R, "##,##0.000000000000000") _
                '           & "&V12=" & par.Converti(par.IfNull(myReader("PSE"), 0)) _
                '           & "&V13=" & par.Converti(par.IfNull(myReader("VSE"), 0)) _
                '           & "&PG=" & lblPG.Text & "&UJ=3"



                'CONTROLLO PRESENTAZIONE DOC. MANCANTE e OSSERVAZIONI 26/03/2012
                presDocManca = myReader("FL_PRESENT_DOC_MANC")
                dataPresDocM = par.IfNull(myReader("DATA_PRESENT_DOC_MANC"), "")
                fl_fine_sosp = par.IfNull(myReader("FL_FINE_SOSPENSIONE"), -1)

                fl_osserv = myReader("FL_OSSERVAZIONI")
                fl_autorizza = myReader("FL_AUTORIZZAZIONE")
                fl_contab = myReader("FL_CONTABILIZZATO")
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT TIPO_BANDO,DATA_INIZIO FROM BANDI_VSA WHERE ID=" & lIndice_Bando
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                lBando = par.IfNull(myReader("TIPO_BANDO"), "-1")
                'Select Case lBando
                '    Case 0
                '        lblSPG.Text = Mid(myReader("DATA_INIZIO"), 3, 2) & "-1"
                '    Case 1
                '        lblSPG.Text = Mid(myReader("DATA_INIZIO"), 3, 2) & "-2"
                '    Case 2
                '        lblSPG.Text = Mid(myReader("DATA_INIZIO"), 3, 2) & "-3"
                'End Select
            End If
            myReader.Close()

            If fl_autorizza = 1 Then
                IMGCanone.Visible = False
            End If


            '**************** 16/12/2011 cerco gli ospiti ***************
            'Dim listaOspiti As String = ""
            'par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_OSPITI_VSA WHERE ID_DOMANDA = " & lIdDomanda & " ORDER BY DATA_AGG DESC"
            'Dim myReaderOspiti As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            ''Dim da As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            ''dtOspiti = New Data.DataTable
            ''da.Fill(dtOspiti)
            ''da.Dispose()

            ''Dim rowDT As System.Data.DataRow
            ''If dtOspiti.Rows.Count > 0 Then

            ''    CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).DataSource = dtOspiti
            ''    CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).DataBind()

            ''Else
            ''    rowDT = dtOspiti.NewRow()
            ''    rowDT.Item("ID") = "-1"
            ''    rowDT.Item("COGNOME") = "&nbsp"
            ''    rowDT.Item("NOME") = "&nbsp"

            ''    dtOspiti.Rows.Add(rowDT)

            ''    CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).DataSource = dtOspiti
            ''    CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).DataBind()

            ''End If
            'While myReaderOspiti.Read
            '    listaOspiti = par.MiaFormat(par.IfNull(myReaderOspiti("COGNOME"), ""), 25) & " " & par.MiaFormat(par.IfNull(myReaderOspiti("NOME"), ""), 25) & " " & par.MiaFormat(par.FormattaData(myReaderOspiti("DATA_NASC")), 11) & "" & par.MiaFormat(par.IfNull(myReaderOspiti("COD_FISCALE"), ""), 22) _
            '        & par.MiaFormat(par.FormattaData(par.IfNull(myReaderOspiti("DATA_INIZIO_OSPITE"), "")), 16) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReaderOspiti("DATA_FINE_OSPITE"), "")), 10)

            '    CType(Dom_Ospiti1.FindControl("ListBox1"), ListBox).Items.Add(New ListItem(listaOspiti, myReaderOspiti("ID")))
            'End While
            'myReaderOspiti.Close()

            CaricaOspiti()
            '**************** 16/12/2011 FINE ospiti ********************


            par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " AND PROGR=" & lProgr
            myReader = par.cmd.ExecuteReader()
            Dim sPresso As String
            sPresso = ""

            If myReader.Read() Then
                cT = Me.Page.FindControl("txtCognome")
                cT.Text = par.IfNull(myReader("COGNOME"), "")

                cT = Me.Page.FindControl("txtNome")
                cT.Text = par.IfNull(myReader("NOME"), "")

                cT = Me.Page.FindControl("txtDataNascita")
                cT.Text = Mid(par.IfNull(myReader("DATA_NASCITA"), ""), 7, 2) & "/" & Mid(par.IfNull(myReader("DATA_NASCITA"), ""), 5, 2) & "/" & Mid(par.IfNull(myReader("DATA_NASCITA"), ""), 1, 4)

                cT = Me.Page.FindControl("txtCF")
                cT.Text = par.IfNull(myReader("COD_FISCALE"), "")

                CT1 = Me.Page.FindControl("cmbSesso")
                CT1.SelectedIndex = -1
                CT1.Items.FindByText(par.IfNull(myReader("SESSO"), "M")).Selected = True

                lIndice_Componente = myReader("ID")

                If lProgr <> 0 Then
                    par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE COD='" & Mid(cT.Text, 12, 4) & "'"
                    Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader1.Read() Then
                        CT1 = Me.Page.FindControl("cmbNazioneNas")
                        If myReader1("SIGLA") = "E" Or myReader1("SIGLA") = "C" Then
                            CT1.SelectedIndex = -1
                            CT1.Items.FindByText(myReader1("NOME")).Selected = True
                            'LB1 = Me.Page.FindControl("Label6")
                            'LB1.Visible = False
                            'LB1 = Me.Page.FindControl("Label7")
                            'LB1.Visible = False
                            CT1 = Me.Page.FindControl("cmbPrNas")
                            CT1.Visible = False
                            CT1 = Me.Page.FindControl("cmbComuneNas")
                            CT1.Visible = False
                        Else
                            CT1.SelectedIndex = -1
                            CT1.Items.FindByText("ITALIA").Selected = True
                            CT1 = Me.Page.FindControl("cmbPrNas")
                            CT1.SelectedIndex = -1
                            CT1.Items.FindByText(myReader1("SIGLA")).Selected = True
                            par.RiempiDList(Me, par.OracleConn, "cmbComuneNas", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & myReader1("SIGLA") & "' ORDER BY NOME ASC", "NOME", "ID")
                            CT1 = Me.Page.FindControl("cmbComuneNas")
                            CT1.SelectedIndex = -1
                            CT1.Items.FindByText(myReader1("NOME")).Selected = True
                        End If
                    End If
                    myReader1.Close()
                End If

            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT DICHIARAZIONI_VSA.*,SINDACATI_VSA.DESCRIZIONE FROM DICHIARAZIONI_VSA,SINDACATI_VSA WHERE DICHIARAZIONI_VSA.ID=" & lIdDichiarazione & " AND SINDACATI_VSA.ID (+) = DICHIARAZIONI_VSA.ID_SINDACATO_VSA"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                'lblPGDic.Text = lblSPG.Text & "-" & myReader("PG") & "-F205"
                lblPGDic.Text = myReader("PG") & "-F205"

                iNumComponenti = myReader("N_COMP_NUCLEO") - 1
                iNumPersone = myReader("N_COMP_NUCLEO")

                If Request.QueryString("GLocat") = "" Then
                    Select Case par.IfNull(myReader("MOD_PRESENTAZIONE"), "-1")
                        Case 0
                            CType(Dom_Dichiara_Cambi1.FindControl("lblModPres"), Label).Text = "Modalità di presentazione: <b>di persona</b>"
                        Case 1
                            CType(Dom_Dichiara_Cambi1.FindControl("lblModPres"), Label).Text = "Modalità di presentazione: <b>a mezzo posta</b>"
                        Case 2
                            CType(Dom_Dichiara_Cambi1.FindControl("lblModPres"), Label).Text = "Modalità di presentazione: <b>verifica d'ufficio</b>"
                        Case 3
                            CType(Dom_Dichiara_Cambi1.FindControl("lblModPres"), Label).Text = "Modalità di presentazione: <b>sindacato - " & par.IfNull(myReader("DESCRIZIONE"), "") & "</b>"
                        Case 4
                            CType(Dom_Dichiara_Cambi1.FindControl("lblModPres"), Label).Text = "Modalità di presentazione: <b>altro - " & par.IfNull(myReader("MOD_PRES_ALTRO"), "") & "</b>"
                    End Select
                    CType(Dom_Dichiara_Cambi1.FindControl("txtInizioVal"), TextBox).Text = par.FormattaData(par.IfNull(myReader("DATA_INIZIO_VAL"), ""))
                    CType(Dom_Dichiara_Cambi1.FindControl("txtFineVal"), TextBox).Text = par.FormattaData(par.IfNull(myReader("DATA_FINE_VAL"), ""))

                Else
                    CType(Dom_Dichiara_Cambi1.FindControl("lblModPres"), Label).Visible = False
                End If

                If lProgr = 0 Then
                    cT = Me.Page.FindControl("txtIndRes")
                    cT.Text = par.IfNull(myReader("IND_RES_DNTE"), "")

                    cT = Me.Page.FindControl("txtCivicoRes")
                    cT.Text = par.IfNull(myReader("CIVICO_RES_DNTE"), "")

                    cT = Me.Page.FindControl("txtTelRes")
                    cT.Text = par.IfNull(myReader("TELEFONO_DNTE"), "")

                    cT = Me.Page.FindControl("txtCAPRes")
                    cT.Text = par.IfNull(myReader("CAP_RES_DNTE"), "")

                    lIndiceAppoggio_0 = myReader("ID_LUOGO_NAS_DNTE")
                    lIndiceAppoggio_1 = myReader("ID_LUOGO_RES_DNTE")
                    lIndiceAppoggio_2 = myReader("ID_TIPO_IND_RES_DNTE")

                Else
                    par.cmd.CommandText = "SELECT * FROM COMP_NAS_RES_VSA WHERE ID_COMPONENTE=" & lIndice_Componente
                    Dim myReader2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader2.Read Then


                        lIndiceAppoggio_1 = myReader2("ID_LUOGO_RES_DNTE")
                        lIndiceAppoggio_2 = myReader2("ID_TIPO_IND_RES_DNTE")

                        CType(Me.Page.FindControl("txtIndRes"), TextBox).Text = par.IfNull(myReader2("IND_RES_DNTE"), "")
                        CType(Me.Page.FindControl("txtCivicoRes"), TextBox).Text = par.IfNull(myReader2("CIVICO_RES_DNTE"), "")

                        CType(Me.Page.FindControl("txtTelRes"), TextBox).Text = par.IfNull(myReader2("TELEFONO_DNTE"), "")

                        cT = Me.Page.FindControl("txtCAPRes")
                        cT.Text = par.IfNull(myReader2("CAP_RES"), "")

                        CT1 = Me.Page.FindControl("cmbTipoIRes")
                        CT1.SelectedIndex = -1
                        CT1.Items.FindByValue(par.IfNull(myReader2("ID_TIPO_IND_RES_DNTE"), 6)).Selected = True

                    End If
                    myReader2.Close()
                End If
            End If
            myReader.Close()
            If lProgr = 0 Then
                par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE ID=" & lIndiceAppoggio_0
                myReader = par.cmd.ExecuteReader()
                If myReader.Read() Then
                    CT1 = Me.Page.FindControl("cmbNazioneNas")
                    CT1.SelectedIndex = -1
                    If myReader("SIGLA") = "E" Or myReader("SIGLA") = "C" Then
                        CT1.Items.FindByText(myReader("NOME")).Selected = True
                        'LB1 = Me.Page.FindControl("Label6")
                        'LB1.Visible = False
                        'LB1 = Me.Page.FindControl("Label7")
                        'LB1.Visible = False
                        CT1 = Me.Page.FindControl("cmbPrNas")
                        CT1.Visible = False
                        CT1 = Me.Page.FindControl("cmbComuneNas")
                        CT1.Visible = False
                    Else
                        CT1.Items.FindByText("ITALIA").Selected = True
                        CT1 = Me.Page.FindControl("cmbPrNas")
                        CT1.SelectedIndex = -1
                        CT1.Items.FindByText(myReader("SIGLA")).Selected = True
                        par.RiempiDList(Me, par.OracleConn, "cmbComuneNas", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & myReader("SIGLA") & "' ORDER BY NOME ASC", "NOME", "ID")
                        CT1 = Me.Page.FindControl("cmbComuneNas")
                        CT1.SelectedIndex = -1
                        CT1.Items.FindByText(myReader("NOME")).Selected = True
                    End If
                End If
                myReader.Close()

                par.cmd.CommandText = "SELECT DESCRIZIONE FROM T_TIPO_INDIRIZZO WHERE COD=" & lIndiceAppoggio_2

                myReader = par.cmd.ExecuteReader()
                If myReader.Read() Then
                    CT1 = Me.Page.FindControl("cmbTipoIRes")
                    CT1.SelectedIndex = -1
                    CT1.Items.FindByText(myReader("DESCRIZIONE")).Selected = True
                End If
                myReader.Close()
            End If

            par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE ID=" & lIndiceAppoggio_1
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                CT1 = Me.Page.FindControl("cmbNazioneRes")
                CT1.SelectedIndex = -1
                If myReader("SIGLA") = "E" Or myReader("SIGLA") = "C" Then
                    CT1.Items.FindByText(myReader("NOME")).Selected = True
                Else
                    CT1.Items.FindByText("ITALIA").Selected = True
                    CT1 = Me.Page.FindControl("cmbPrRes")
                    CT1.SelectedIndex = -1
                    CT1.Items.FindByText(myReader("SIGLA")).Selected = True
                    par.RiempiDList(Me, par.OracleConn, "cmbComuneRes", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & myReader("SIGLA") & "' ORDER BY NOME ASC", "NOME", "ID")
                    CT1 = Me.Page.FindControl("cmbComuneRes")
                    CT1.SelectedIndex = -1
                    CT1.Items.FindByText(myReader("NOME")).Selected = True

                    'cT = Me.Page.FindControl("txtCAPRes")
                    'cT.Text = myReader("CAP")

                End If
            End If
            myReader.Close()

            'par.cmd.CommandText = "SELECT * from bandi_graduatoria_def_cambi WHERE ID_DOMANDA=" & lIdDomanda
            'myReader = par.cmd.ExecuteReader()
            'If myReader.Read() Then
            '    lblPosizione.Visible = True
            '    lblPosizione.Text = "POSIZIONE IN GRADUATORIA: " & myReader("POSIZIONE") & " (ISBARC/R GRAD.:" & par.Tronca(myReader("ISBARC_R")) & ")"
            'End If
            'myReader.Close()


            par.cmd.CommandText = "SELECT * from INTESTATARI_CONTRATTI_VSA WHERE ID_DOMANDA=" & lIdDomanda
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                CType(Dom_Alloggio_ERP1.FindControl("txtCognome"), TextBox).Text = par.IfNull(myReader("cognome"), "")
                CType(Dom_Alloggio_ERP1.FindControl("txtNome"), TextBox).Text = par.IfNull(myReader("Nome"), "")
                CType(Dom_Alloggio_ERP1.FindControl("txtDataNascita"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_nascita_dnte"), ""))

                CType(Dom_Alloggio_ERP1.FindControl("txtCF"), TextBox).Text = par.IfNull(myReader("cod_fiscale"), "")
                CType(Dom_Alloggio_ERP1.FindControl("cmbSesso"), DropDownList).Items.FindByText(par.IfNull(myReader("sesso"), "")).Selected = True

                par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE ID=" & par.IfNull(myReader("ID_LUOGO_NAS_DNTE"), 0)
                Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader1.Read() Then
                    CT1 = Dom_Alloggio_ERP1.FindControl("cmbNazioneNas")
                    CT1.SelectedIndex = -1
                    If myReader1("SIGLA") = "E" Or myReader1("SIGLA") = "C" Then
                        CT1.Items.FindByText(par.IfNull(myReader1("NOME"), "")).Selected = True
                        CType(Dom_Alloggio_ERP1.FindControl("Label20"), Label).Visible = False
                        CType(Dom_Alloggio_ERP1.FindControl("Label21"), Label).Visible = False
                        CType(Dom_Alloggio_ERP1.FindControl("cmbComuneNas"), DropDownList).Visible = False
                        CType(Dom_Alloggio_ERP1.FindControl("cmbPrNas"), DropDownList).Visible = False
                    Else
                        CT1.Items.FindByText("ITALIA").Selected = True
                        CT1 = Dom_Alloggio_ERP1.FindControl("cmbPrNas")
                        CT1.SelectedIndex = -1
                        CT1.Items.FindByText(myReader1("SIGLA")).Selected = True
                        par.RiempiDList(Dom_Alloggio_ERP1, par.OracleConn, "cmbComuneNas", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & myReader1("SIGLA") & "' ORDER BY NOME ASC", "NOME", "ID")
                        CT1 = Dom_Alloggio_ERP1.FindControl("cmbComuneNas")
                        CT1.SelectedIndex = -1
                        CT1.Items.FindByText(myReader1("NOME")).Selected = True
                    End If
                End If
                myReader1.Close()

            End If
            myReader.Close()

            'par.cmd.CommandText = "SELECT domande_bando.id FROM domande_bando,comp_nucleo WHERE domande_bando.progr_componente=comp_nucleo.progr and domande_bando.id_dichiarazione=comp_nucleo.id_dichiarazione and comp_nucleo.cod_fiscale='" & CType(Me.Page.FindControl("txtCF"), TextBox).Text & "'"
            'myReader = par.cmd.ExecuteReader()
            'If myReader.Read() Then
            '    CType(Dom_Dichiara_Cambi1.FindControl("lblERP"), Label).Visible = True
            '    CType(Dom_Dichiara_Cambi1.FindControl("lblERP"), Label).Attributes.Add("onClick", "javascript:window.open('StatoDomanda.aspx?ID=" & myReader("id") & "','Stato','height=370,top=0,left=0,width=480,scrollbars=no');")
            'Else
            '    CType(Dom_Dichiara_Cambi1.FindControl("lblERP"), Label).Visible = False
            'End If
            'myReader.Close()

            par.cmd.CommandText = "SELECT * from DOMANDE_VSA_ALLOGGIO WHERE ID_DOMANDA=" & lIdDomanda
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                CType(Dom_Alloggio_ERP1.FindControl("txtCOMUNE"), TextBox).Text = par.IfNull(myReader("COMUNE"), "")
                CType(Dom_Alloggio_ERP1.FindControl("txtIndirizzo"), TextBox).Text = par.IfNull(myReader("Indirizzo"), "")
                CType(Dom_Alloggio_ERP1.FindControl("txtCAP"), TextBox).Text = par.IfNull(myReader("cap"), "")
                CType(Dom_Alloggio_ERP1.FindControl("txtCivico"), TextBox).Text = par.IfNull(myReader("Civico"), "")
                CType(Dom_Alloggio_ERP1.FindControl("txtInterno"), TextBox).Text = par.IfNull(myReader("Interno"), "")
                CType(Dom_Alloggio_ERP1.FindControl("txtScala"), TextBox).Text = par.IfNull(myReader("Scala"), "")

                'CType(Dom_Alloggio_ERP1.FindControl("txtPiano"), TextBox).Text = par.IfNull(myReader("Piano"), "")
                CType(Dom_Alloggio_ERP1.FindControl("cmbPianoUnita"), DropDownList).Items.FindByValue(par.IfNull(myReader("Piano"), "78")).Selected = True

                CType(Dom_Alloggio_ERP1.FindControl("txtNetta"), TextBox).Text = par.IfNull(myReader("sup_netta"), "")
                CType(Dom_Alloggio_ERP1.FindControl("txtLocali"), TextBox).Text = par.IfNull(myReader("N_Locali"), "")
                CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text = Trim(par.IfNull(myReader("Num_Contratto"), ""))

                'Ccodicetrovato.Value = par.IfNull(myReader("Num_Contratto"), "")

                CType(Dom_Alloggio_ERP1.FindControl("txtCOMUNE"), TextBox).Text = par.IfNull(myReader("COMUNE"), "")
                CType(Dom_Alloggio_ERP1.FindControl("txtDecorrenza"), TextBox).Text = par.FormattaData(par.IfNull(myReader("dec_contratto"), ""))


                CType(Dom_Alloggio_ERP1.FindControl("cmbascensore"), DropDownList).SelectedIndex = -1
                CType(Dom_Alloggio_ERP1.FindControl("cmbascensore"), DropDownList).Items.FindByValue(par.IfNull(myReader("ascensore"), "0")).Selected = True
                CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text = par.IfNull(myReader("cod_unita_immobiliare"), "")

                ''Ucodicetrovato.Value = par.IfNull(myReader("cod_unita_immobiliare"), "")

                'CType(Dom_Alloggio_ERP1.FindControl("cmbTipoRapporto"), DropDownList).SelectedIndex = -1
                'CType(Dom_Alloggio_ERP1.FindControl("cmbGestore"), DropDownList).SelectedIndex = -1
                'CType(Dom_Alloggio_ERP1.FindControl("cmbGestore"), DropDownList).Items.FindByValue(par.IfNull(myReader("id_tipo_gestore"), "-1")).Selected = True
                'CType(Dom_Alloggio_ERP1.FindControl("cmbTipoRapporto"), DropDownList).Items.FindByValue(par.IfNull(myReader("id_tipo_rapporto"), "-1")).Selected = True

            End If
            myReader.Close()


            '***** 02/12/11 MTeresa CONTROLLO COINTESTATARIO ******
            If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = "1" Or CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = "4" Then
                If par.IfEmpty(CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue, -1) <> "8" Then
                    Dim idc As Long = 0
                    par.cmd.CommandText = "SELECT id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
                    Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderX1.Read Then
                        idc = myReaderX1("id")
                    End If
                    myReaderX1.Close()

                    par.cmd.CommandText = "select * from siscom_mi.bol_bollette where id_tipo = 4 and id_contratto = " & idc & " and importo_totale <> NVL(importo_pagato,0)"
                    Dim lettMorosita As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If lettMorosita.Read Then
                        morosita = 1
                        If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = "1" Then
                            CType(Dom_Dichiara_Cambi1.FindControl("lblCointest"), Label).Visible = True
                            CType(Dom_Dichiara_Cambi1.FindControl("cmbSiNo"), DropDownList).Visible = True
                        End If
                    End If
                    lettMorosita.Close()
                End If
            End If
            '***** 02/12/11 MTeresa FINE CONTROLLO COINTESTATARIO ******


            '***** 02/04/11 Controllo se l'alloggio è in Condominio ******
            par.cmd.CommandText = "SELECT DISTINCT(EDIFICI.ID) FROM SISCOM_MI.EDIFICI,SISCOM_MI.UNITA_IMMOBILIARI WHERE EDIFICI.ID = UNITA_IMMOBILIARI.ID_EDIFICIO AND UNITA_IMMOBILIARI.COD_UNITA_IMMOBILIARE = '" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "' " _
                & "AND EDIFICI.ID IN (SELECT DISTINCT(ID_EDIFICIO) FROM SISCOM_MI.COND_EDIFICI WHERE ID_EDIFICIO = EDIFICI.ID)"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                condominio = True
            Else
                condominio = False
            End If
            myReader.Close()


            If Request.QueryString("GLocat") <> "" Then
                lblProcessi.Visible = False
                Dom_Decisioni1.DisattivaTutto()
                lblStatoDOM.Visible = False
                CType(Dom_Dichiara_Cambi1.FindControl("lblDataEvento"), Label).Visible = False
                CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Visible = False
                CType(Dom_Dichiara_Cambi1.FindControl("lblInizioVal"), Label).Visible = False
                CType(Dom_Dichiara_Cambi1.FindControl("txtInizioVal"), TextBox).Visible = False
                CType(Dom_Dichiara_Cambi1.FindControl("lblFineVal"), Label).Visible = False
                CType(Dom_Dichiara_Cambi1.FindControl("txtFineVal"), TextBox).Visible = False
                MenuStampe.Visible = False
            Else
                'If IDmotivoDom = 5 Then
                '    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE upper(COD_CONTRATTO)='" & UCase(CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text) & "'"
                '    Dim myReader0 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                '    If myReader0.Read = False Or CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text = "" Then
                '        CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Visible = True
                '        CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Checked = True
                '    Else
                '        CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Visible = True
                '        CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Checked = False
                '    End If
                '    myReader0.Close()
                '    If Not IsNothing(Dom_Alloggio_ERP1.IdDichiarazione) Then
                '        CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Visible = True
                '        CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Checked = False
                '    End If
                'End If
                CType(Dom_Dichiara_Cambi1.FindControl("txtInizioVal"), TextBox).ReadOnly = True
                CType(Dom_Dichiara_Cambi1.FindControl("txtFineVal"), TextBox).ReadOnly = True
                CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).ReadOnly = True
                CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).ReadOnly = True
            End If


            '10/01/2012 Settaggio Variabili per Modelli Esito Positivo/Negativo
            par.cmd.CommandText = "SELECT COD_DECISIONE,data FROM VSA_DECISIONI_REV_C WHERE ID_DOMANDA = " & lIdDomanda & " AND (COD_DECISIONE = 2 OR COD_DECISIONE = 3 OR " _
                & "COD_DECISIONE = 5 OR COD_DECISIONE = 6) ORDER BY COD_DECISIONE ASC"
            Dim da1 As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            Dim dt As New Data.DataTable()
            da1.Fill(dt)
            da1.Dispose()
            If dt.Rows.Count > 0 Then
                For Each row As Data.DataRow In dt.Rows
                    Select Case row.Item("COD_DECISIONE")
                        Case 2
                            CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1
                        Case 3
                            CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1
                        Case 5
                            CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 1
                        Case 6
                            CType(Dom_Decisioni1.FindControl("esNegaRiesame"), HiddenField).Value = 1
                    End Select
                Next
            Else

                par.cmd.CommandText = "SELECT COD_DECISIONE,data FROM VSA_DECISIONI_REV_C WHERE ID_DOMANDA = " & lIdDomanda & " AND (COD_DECISIONE = 7 OR COD_DECISIONE = 8 OR " _
                & "COD_DECISIONE = 9 OR COD_DECISIONE = 10) ORDER BY COD_DECISIONE ASC"
                Dim da2 As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
                da2.Fill(dt)
                da2.Dispose()
                If dt.Rows.Count > 0 Then
                    For Each row As Data.DataRow In dt.Rows
                        Select Case row.Item("COD_DECISIONE")
                            Case 7
                                CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1
                            Case 8
                                CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1
                            Case 9
                                CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 1
                            Case 10
                                CType(Dom_Decisioni1.FindControl("esNegaRiesame"), HiddenField).Value = 1
                        End Select
                    Next
                End If
            End If
            'FINE settaggio Variabili per Modelli Esito Positivo/Negativo


            par.cmd.CommandText = "SELECT * FROM EVENTI_BANDI_VSA WHERE ID_DOMANDA = " & lIdDomanda & " AND (COD_EVENTO = 'F179' or COD_EVENTO = 'F165' or COD_EVENTO = 'F196' or COD_EVENTO = 'F197' or COD_EVENTO = 'F204' or COD_EVENTO='F208')"
            Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If lettore.Read Then
                CType(Dom_Decisioni1.FindControl("autorizzFinale"), HiddenField).Value = 1
            Else
                CType(Dom_Decisioni1.FindControl("autorizzFinale"), HiddenField).Value = 0
            End If
            lettore.Close()


            par.cmd.CommandText = "SELECT F_RESIDENZA FROM COMP_PATR_IMMOB_VSA WHERE ID_COMPONENTE=" & lIndice_Componente
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                Fl_Residenza = myReader("F_RESIDENZA")
            End If
            myReader.Close()
            If Fl_Residenza = "1" Then
                'CType(Dom_Abitative_2_1.FindControl("alert2"), Image).Visible = True
                'CType(Dom_Abitative_2_1.FindControl("alert3"), Image).Visible = True
            End If
            'peppe modify
            par.cmd.CommandText = "SELECT * FROM VSA_DOC_MANCANTI WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " ORDER BY ID_DOC ASC"
            myReader = par.cmd.ExecuteReader()
            While myReader.Read
                CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1
                CType(Dom_Note1.FindControl("ListBox1"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader("DESCRIZIONE"), ""), 250), myReader("ID_DOC")))
            End While
            myReader.Close()

            If CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1 Then
                CType(Dom_Note1.FindControl("chkDocManc"), CheckBox).Enabled = True
                CType(Dom_Note1.FindControl("txtDataDocManc"), TextBox).Enabled = True
            End If

            If presDocManca = 1 Then
                CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 0
                CType(Dom_Note1.FindControl("chkDocManc"), CheckBox).Checked = True
                CType(Dom_Note1.FindControl("txtDataDocManc"), TextBox).Text = par.FormattaData(dataPresDocM)
                'CType(Dom_Note1.FindControl("ListBox1"), ListBox).Enabled = False
                CType(Dom_Note1.FindControl("Button1"), ImageButton).Enabled = False
                CType(Dom_Note1.FindControl("Button2"), ImageButton).Enabled = False
                CType(Dom_Note1.FindControl("chkDocManc"), CheckBox).Enabled = True
                CType(Dom_Note1.FindControl("txtDataDocManc"), TextBox).Enabled = True
            End If



            If CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1 Then
                imgAvvisoSospesa.Visible = True
                lblSospesa.Visible = True
                imgAlertScadenza.Visible = False
                lblScadenza.Visible = False

                CType(Dom_Note1.FindControl("chkSosp"), CheckBox).Visible = True
                CType(Dom_Note1.FindControl("chkSosp"), CheckBox).Enabled = True
            End If

            If fl_fine_sosp = 1 Then
                CType(Dom_Note1.FindControl("chkSosp"), CheckBox).Checked = True
            End If


            '***** PRENDO L'ID DELLA DOMANDA ASSOCIATA PER IL CAMBIO CONS. *****
            Dim pgCollegato As String = ""
            If IDmotivoDom = "5" Then
                par.cmd.CommandText = "SELECT DOMANDE_BANDO_VSA.ID AS IDDOM,DOMANDE_BANDO_VSA.PG FROM DOMANDE_BANDO_VSA WHERE PG_COLLEGATO = '" & lblPG.Text & "'"
                myReader = par.cmd.ExecuteReader
                If myReader.Read Then
                    lIdDomScambio = par.IfNull(myReader("IDDOM"), "")
                    pgCollegato = par.IfNull(myReader("PG"), "")
                End If
                myReader.Close()
                par.cmd.CommandText = "SELECT DICHIARAZIONI_VSA.ID FROM DOMANDE_BANDO_VSA,DICHIARAZIONI_VSA WHERE DOMANDE_BANDO_VSA.ID = " & lIdDomScambio & " AND DICHIARAZIONI_VSA.ID = DOMANDE_BANDO_VSA.ID_DICHIARAZIONE AND DICHIARAZIONI_VSA.ID_STATO = 1"
                myReader = par.cmd.ExecuteReader
                If myReader.Read = False Then
                    statoDichCollegata = False
                Else
                    statoDichCollegata = True
                End If
                myReader.Close()

                CType(Me.Page.FindControl("lblNumDom"), Label).Visible = True
                CType(Me.Page.FindControl("lblNumDom"), Label).Text = "<< Num. dom. associata <a href='javascript:void(0)' onclick=" & Chr(34) & "today = new Date();document.getElementById('H1').value='0';window.open('domandaNuova.aspx?CH=1&ID=" & lIdDomScambio & "','DomCollegata'+ today.getMinutes() + today.getSeconds(),'');" & Chr(34) & ">" & pgCollegato & " </a> >>"

                par.cmd.CommandText = "SELECT * FROM VSA_Decisioni_rev_c WHERE ID_domanda = " & lIdDomScambio & " AND COD_DECISIONE =3"
                myReader = par.cmd.ExecuteReader
                If myReader.Read = True Then
                    par.cmd.CommandText = "SELECT * FROM VSA_DOM_ESITI_NEG WHERE ID_domanda = " & lIdDomScambio & " AND COD_DECISIONE =3"
                    Dim myReaderMOT As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderMOT.Read Then
                        decisioneConMotivi = True
                    Else
                        decisioneConMotivi = False
                    End If
                    myReaderMOT.Close()
                End If
                myReader.Close()

            End If



            '05/04/2012 GESTIONE SOPRALLUOGHI

            par.cmd.CommandText = "SELECT * FROM VSA_SOPRALLUOGHI WHERE ID_DOMANDA=" & lIdDomanda
            myReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                CType(Dom_Note1.FindControl("chkSoprall"), CheckBox).Checked = True
                CType(Dom_Note1.FindControl("chkSoprall"), CheckBox).Enabled = False
                CType(Dom_Note1.FindControl("txtDataSoprall"), TextBox).Text = par.FormattaData(par.IfNull(myReader("DATA_SOPRALLUOGO"), ""))
                CType(Dom_Note1.FindControl("txtNoteSoprall"), TextBox).Text = par.IfNull(myReader("NOTE"), "")
            End If
            myReader.Close()
            '05/04/2012 FINE GESTIONE SOPRALLUOGHI



            'cT = Me.Page.FindControl("txtPresso")
            'cT.Text = sPresso

            Dim da As New Oracle.DataAccess.Client.OracleDataAdapter("SELECT TO_CHAR(TO_DATE(DATA_NASCITA,'YYYYmmdd'),'DD/MM/YYYY') AS ""DATA_NASCITA"",PERC_INVAL,INDENNITA_ACC FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " ORDER BY PROGR ASC", par.OracleConn)

            Dim ds As New Data.DataSet()
            da.Fill(ds, "COMP_NUCLEO")
            DataGrid1.DataSource = ds
            DataGrid1.DataBind()
            da.Dispose()
            ds.Dispose()

            Me.DisattivaRichiedente()
            If lProgr = 0 Then
                Me.DisattivaIndirizzo()
            End If


            '23/01/2012 Chiamo funzione per Messaggio Giorni restanti
            If Request.QueryString("GLocat") = "" Then
                SegnalazioneTempi(data_presentazione, IDmotivoDom)
            End If
            '23/01/2012 FINE Chiamo funzione per Messaggio Giorni restanti


            'SetMenuStampe(IDmotivoDom)


            Dim S As String
            S = ""
            If VerificaDati(S) = False Then
                Response.Write("<script>alert('Attenzione...Sono state riscontrate anomalie nella domanda. Risolvere il/i problema/i prima di salvare e stampare la domanda!')</script>")
                imgStampa.Enabled = False
                'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
            Else
                If IDmotivoDom = 3 Or IDmotivoDom = 4 Then
                    imgStampa.Enabled = True
                    'imgStampa.ImageUrl = "../NuoveImm/Img_Stampa.png"
                End If
            End If


            If inlettura.Value = "1" Then
                par.cmd.Dispose()
                par.OracleConn.Close()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()

            Else

                If Fl_US <> "1" Then
                    par.myTrans = par.OracleConn.BeginTransaction()
                    '‘par.cmd.Transaction = par.myTrans
                    HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
                Else
                    par.cmd.Dispose()
                    par.OracleConn.Close()
                    Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                End If
            End If

            Session.Add("LAVORAZIONE", "1")

            If sStato <> "2" And sStato <> "1" Then
                imgAnagrafe.Visible = False
                imgAnagrafe.Attributes.Clear()
            End If

            If sStato = "9" Or sStato = "10" Then
                imgStampa.Visible = False
                'btnSalva.Visible = False
                'cmbAccolta.Enabled = False
                Dom_Alloggio_ERP1.DisattivaTutto()
                Dom_Dichiara_Cambi1.DisattivaTutto()
                Dom_Dichiara_Cambi1.DisattivaTutto()
                Dom_Requisiti_Cambi1.DisattivaTutto()
                Me.DisattivaTutto()
            End If

            If Request.QueryString("GLocat") <> "" Then
                imgStampa.Enabled = True
                imgStampa.Visible = True
                'imgStampa.ImageUrl = "../NuoveImm/Img_Stampa.png"
                Dom_Decisioni1.DisattivaTutto()
            End If

        Catch EX1 As Oracle.DataAccess.Client.OracleException
            If EX1.Number = 54 Then
                scriptblock = "<script language='javascript' type='text/javascript'>" _
                & "alert('Pratica aperta da un altro utente. Non è possibile effettuare modifiche!');" _
                & "</script>"
                If (Not Page.ClientScript.IsClientScriptBlockRegistered("clientScript5")) Then
                    Page.ClientScript.RegisterClientScriptBlock(Me.GetType(), "clientScript5", scriptblock)
                End If
                par.cmd.CommandText = "SELECT * FROM DOMANDE_BANDO_VSA WHERE ID=" & lIdDomanda
                Dim myReader5 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader5.Read() Then

                    lIndice_Bando = myReader5("ID_BANDO")
                    lIdDichiarazione = myReader5("ID_DICHIARAZIONE")
                    lProgr = myReader5("PROGR_COMPONENTE")

                    CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoDocumento"), DropDownList).SelectedIndex = -1
                    CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoDocumento"), DropDownList).Items.FindByValue(par.IfNull(myReader5("TIPO_DOCUMENTO"), 0)).Selected = True

                    CType(Dom_Dichiara_Cambi1.FindControl("txtCINum"), TextBox).Text = par.IfNull(myReader5("CARTA_I"), "")
                    CType(Dom_Dichiara_Cambi1.FindControl("txtCIData"), TextBox).Text = par.FormattaData(par.IfNull(myReader5("CARTA_I_DATA"), ""))
                    CType(Dom_Dichiara_Cambi1.FindControl("txtCSData"), TextBox).Text = par.FormattaData(par.IfNull(myReader5("CARTA_SOGG_DATA"), ""))
                    CType(Dom_Dichiara_Cambi1.FindControl("txtPSScade"), TextBox).Text = par.FormattaData(par.IfNull(myReader5("PERMESSO_SOGG_SCADE"), ""))
                    CType(Dom_Dichiara_Cambi1.FindControl("txtPSRinnovo"), TextBox).Text = par.FormattaData(par.IfNull(myReader5("PERMESSO_SOGG_RINNOVO"), ""))
                    CType(Dom_Dichiara_Cambi1.FindControl("txtPSData"), TextBox).Text = par.FormattaData(par.IfNull(myReader5("PERMESSO_SOGG_DATA"), ""))
                    CType(Dom_Dichiara_Cambi1.FindControl("txtCIRilascio"), TextBox).Text = par.IfNull(myReader5("CARTA_I_RILASCIATA"), "")
                    CType(Dom_Dichiara_Cambi1.FindControl("txtPSNum"), TextBox).Text = par.IfNull(myReader5("PERMESSO_SOGG_N"), "")
                    CType(Dom_Dichiara_Cambi1.FindControl("txtCSNum"), TextBox).Text = par.IfNull(myReader5("CARTA_SOGG_N"), "")


                    'lblISBAR.Text = par.Converti3(Format(par.IfNull(myReader5("isbarc_r"), 0), "##,##0.000"))
                    lblISBAR.Text = par.Tronca(par.IfNull(myReader5("REDDITO_ISEE"), 0))
                    lblPG.Text = par.IfNull(myReader5("pg"), "")
                    txtDataPG.Text = par.FormattaData(par.IfNull(myReader5("data_pg"), ""))

                    cT = Me.Page.FindControl("txtPresso")
                    cT.Text = par.IfNull(myReader5("PRESSO_REC_DNTE"), "")

                    cT = Me.Page.FindControl("txtIndirizzoRec")
                    cT.Text = par.IfNull(myReader5("IND_REC_DNTE"), "")

                    cT = Me.Page.FindControl("txtCivicoRec")
                    cT.Text = par.IfNull(myReader5("CIVICO_REC_DNTE"), "")

                    cT = Me.Page.FindControl("txtTelRec")
                    cT.Text = par.IfNull(myReader5("TELEFONO_REC_DNTE"), "")

                    cT = Me.Page.FindControl("txtCAPRec")
                    cT.Text = par.IfNull(myReader5("CAP_REC_DNTE"), "")

                    CT1 = CType(Me.Page.FindControl("cmbResidenza"), DropDownList)
                    CT1.SelectedIndex = -1
                    CT1.Items.FindByValue(par.IfNull(myReader5("PERIODO_RES"), 0)).Selected = True



                    CT1 = CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList)
                    CT1.SelectedIndex = -1
                    CT1.Items.FindByValue(par.IfNull(myReader5("ID_MOTIVO_DOMANDA"), 0)).Selected = True

                    '****** Combobox sottotipologie richiesta
                    par.RiempiDList(Dom_Dichiara_Cambi1, par.OracleConn, "cmbPresentaD", "SELECT DESCRIZIONE,COD FROM T_CAUSALI_DOMANDA_VSA WHERE ID_MOTIVO = " & par.IfNull(myReader5("ID_MOTIVO_DOMANDA"), 0) & " ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")

                    If CT1.SelectedValue <> "5" Then
                        CT1 = CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList)
                        CT1.SelectedIndex = -1
                        If par.IfNull(myReader5("ID_CAUSALE_DOMANDA"), 0) = -1 Then
                            'CT1.Items.FindByValue(0).Selected = True
                        Else
                            CT1.Items.FindByValue(par.IfNull(myReader5("ID_CAUSALE_DOMANDA"), 0)).Selected = True
                        End If
                    End If



                    CT1 = CType(Dom_Dichiara_Cambi1.FindControl("cmbFattaAU"), DropDownList)
                    CT1.SelectedIndex = -1
                    CT1.Items.FindByValue(par.IfNull(myReader5("FL_FATTA_AU"), 0)).Selected = True

                    CT1 = CType(Dom_Dichiara_Cambi1.FindControl("cmbFattaAU"), DropDownList)
                    CT1.SelectedIndex = -1
                    CT1.Items.FindByValue(par.IfNull(myReader5("FL_FAI_ERP"), 0)).Selected = True




                    cT = Dom_Note1.FindControl("txtNote")
                    cT.Text = par.IfNull(myReader5("NOTE_WEB"), "")


                    If par.IfNull(myReader5("REQUISITO1"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR1"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR1"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO1"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR1"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR1"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO2"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR2"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR2"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO3"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR3"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR3"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO4"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR4"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR4"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO5"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR5"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR5"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO7"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR6"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR6"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO8"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR7"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR7"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO9"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR8"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR8"), CheckBox).Checked = True
                    End If


                    If par.IfNull(myReader5("REQUISITO10"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR9"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR9"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO11"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR10"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR10"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO12"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR11"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR11"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO13"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR12"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR12"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO14"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR13"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR13"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO15"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR14"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR14"), CheckBox).Checked = True
                    End If


                    If par.IfNull(myReader5("REQUISITO16"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR15"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR15"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO17"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR16"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR16"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO18"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR17"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR17"), CheckBox).Checked = True
                    End If

                    If par.IfNull(myReader5("REQUISITO19"), "0") = "0" Then
                        CType(Dom_Requisiti_Cambi1.FindControl("chR18"), CheckBox).Checked = False
                    Else
                        CType(Dom_Requisiti_Cambi1.FindControl("chR18"), CheckBox).Checked = True
                    End If




                    'If par.IfNull(myReader5("ID_MOTIVO_DOMANDA"), 0) = 4 Then
                    '    'cmbAccolta.Visible = False
                    '    'Label13.Visible = False
                    'Else
                    '    'cmbAccolta.SelectedIndex = -1
                    '    'cmbAccolta.Items.FindByValue(par.IfNull(myReader5("ACCOLTA"), 0)).Selected = True
                    'End If

                    'If sStato = "4" Then
                    '    'cmbAccolta.Visible = False
                    '    'Label13.Visible = False
                    'End If

                    'If par.IfNull(myReader5("ID_MOTIVO_DOMANDA"), "0") = "3" Then
                    '    CType(Dom_Dichiara_Cambi1.FindControl("Label16"), Label).Visible = False
                    'End If

                    If par.IfNull(myReader5("ID_MOTIVO_DOMANDA"), "0") = "5" Then
                        CType(Dom_Dichiara_Cambi1.FindControl("Label16"), Label).Visible = False
                        CType(Dom_Dichiara_Cambi1.FindControl("lblCodContrattoScambio"), Label).Visible = True
                        CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Visible = True
                        CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text = par.IfNull(myReader5("cod_contratto_scambio"), "")
                        CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = False
                    End If


                    If sStato <> "1" And sStato <> "2" Then
                        CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).Enabled = False
                    End If

                    Dim item As ListItem

                    par.cmd.CommandText = "select * from comuni_nazioni where id=" & par.IfNull(myReader5("ID_LUOGO_REC_DNTE"), 0)
                    Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()

                    If myReader1.Read Then
                        par.RiempiDList(Me, par.OracleConn, "cmbProvRec", "SELECT DISTINCT SIGLA FROM COMUNI_NAZIONI ORDER BY SIGLA ASC", "SIGLA", "SIGLA")

                        CT1 = Me.Page.FindControl("cmbProvRec")
                        CT1.SelectedIndex = -1
                        CT1.Items.FindByValue(par.IfNull(myReader1("SIGLA"), 0)).Selected = True
                        item = CT1.SelectedItem

                        par.RiempiDList(Me, par.OracleConn, "cmbComuneRec", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & par.PulisciStrSql(item.Text) & "' ORDER BY NOME ASC", "NOME", "ID")

                        CT1 = Me.Page.FindControl("cmbComuneRec")
                        CT1.SelectedIndex = -1
                        CT1.Items.FindByText(par.IfNull(myReader1("NOME"), "")).Selected = True
                        item = CT1.SelectedItem

                        'cT = Me.Page.FindControl("txtCAPRec")
                        'cT.Text = par.IfNull(myReader1("CAP"), "")

                    End If
                    myReader1.Close()

                    CT1 = Me.Page.FindControl("cmbTipoIRec")
                    CT1.Items.FindByValue(par.IfNull(myReader5("ID_TIPO_IND_REC_DNTE"), "")).Selected = True

                    Select Case par.IfNull(myReader5("PERIODO_RES"), 0)
                        Case 0
                            VALORE_R = 0
                        Case 1
                            VALORE_R = 0
                        Case 2
                            VALORE_R = 40
                        Case 3
                            VALORE_R = 85
                        Case 4
                            VALORE_R = 0
                    End Select
                    VALORE_R = (VALORE_R / 100) * 0.29999999999999999



                    imgStampa.Visible = False
                    btnSalva.Visible = False
                    Dom_Alloggio_ERP1.DisattivaTutto()
                    Dom_Dichiara_Cambi1.DisattivaTutto()
                    Dom_Dichiara_Cambi1.DisattivaTutto()
                    Dom_Requisiti_Cambi1.DisattivaTutto()
                    Me.DisattivaTutto()

                    'txtIndici.Text = "V1=" & par.IfNull(myReader5("isbar"), 0) _
                    '           & "&V2=" & par.IfNull(myReader5("isbarc"), 0) _
                    '           & "&V3=" & par.IfNull(myReader5("isbarc_r"), 0) _
                    '           & "&V4=" & Format(par.IfNull(myReader5("disagio_a"), 0), "##,##0.000000000000000") _
                    '           & "&V5=" & Format(par.IfNull(myReader5("disagio_e"), 0), "##,##0.000000000000000") _
                    '           & "&V6=" & Format(par.IfNull(myReader5("disagio_f"), 0), "##,##0.000000000000000") _
                    '           & "&V7=" & par.Converti(par.IfNull(myReader5("reddito_isee"), 0)) _
                    '           & "&V8=" & par.Converti(par.IfNull(myReader5("ISR_ERP"), 0)) _
                    '           & "&V9=" & par.Converti(par.IfNull(myReader5("ISP_ERP"), 0)) _
                    '           & "&V10=" & par.Converti(par.IfNull(myReader5("ISe_ERP"), 0)) _
                    '           & "&V11=" & Format(VALORE_R, "##,##0.000000000000000") _
                    '           & "&V12=" & par.Converti(par.IfNull(myReader5("PSE"), 0)) _
                    '           & "&V13=" & par.Converti(par.IfNull(myReader5("VSE"), 0)) _
                    '           & "&PG=" & lblPG.Text & "&UJ=3"

                End If
                myReader5.Close()

                par.cmd.CommandText = "SELECT TIPO_BANDO,DATA_INIZIO FROM BANDI_VSA WHERE ID=" & lIndice_Bando
                myReader5 = par.cmd.ExecuteReader()
                If myReader5.Read() Then
                    lBando = par.IfNull(myReader5("TIPO_BANDO"), "-1")
                    'Select Case lBando
                    '    Case 0
                    '        lblSPG.Text = Mid(myReader5("DATA_INIZIO"), 3, 2) & "-1"
                    '    Case 1
                    '        lblSPG.Text = Mid(myReader5("DATA_INIZIO"), 3, 2) & "-2"
                    '    Case 2
                    '        lblSPG.Text = Mid(myReader5("DATA_INIZIO"), 3, 2) & "-3"
                    'End Select
                End If
                myReader5.Close()

                par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " AND PROGR=" & lProgr
                myReader5 = par.cmd.ExecuteReader()
                Dim sPresso As String
                sPresso = ""

                If myReader5.Read() Then
                    cT = Me.Page.FindControl("txtCognome")
                    cT.Text = par.IfNull(myReader5("COGNOME"), "")

                    cT = Me.Page.FindControl("txtNome")
                    cT.Text = par.IfNull(myReader5("NOME"), "")

                    cT = Me.Page.FindControl("txtDataNascita")
                    cT.Text = Mid(par.IfNull(myReader5("DATA_NASCITA"), ""), 7, 2) & "/" & Mid(par.IfNull(myReader5("DATA_NASCITA"), ""), 5, 2) & "/" & Mid(par.IfNull(myReader5("DATA_NASCITA"), ""), 1, 4)

                    cT = Me.Page.FindControl("txtCF")
                    cT.Text = par.IfNull(myReader5("COD_FISCALE"), "")

                    CT1 = Me.Page.FindControl("cmbSesso")
                    CT1.SelectedIndex = -1
                    CT1.Items.FindByText(par.IfNull(myReader5("SESSO"), "M")).Selected = True

                    lIndice_Componente = myReader5("ID")

                    If lProgr <> 0 Then
                        par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE COD='" & Mid(cT.Text, 12, 4) & "'"
                        Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReader1.Read() Then
                            CT1 = Me.Page.FindControl("cmbNazioneNas")
                            If myReader1("SIGLA") = "E" Or myReader1("SIGLA") = "C" Then
                                CT1.SelectedIndex = -1
                                CT1.Items.FindByText(myReader1("NOME")).Selected = True
                            Else
                                CT1.SelectedIndex = -1
                                CT1.Items.FindByText("ITALIA").Selected = True
                                CT1 = Me.Page.FindControl("cmbPrNas")
                                CT1.SelectedIndex = -1
                                CT1.Items.FindByText(myReader1("SIGLA")).Selected = True
                                par.RiempiDList(Me, par.OracleConn, "cmbComuneNas", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & myReader1("SIGLA") & "' ORDER BY NOME ASC", "NOME", "ID")
                                CT1 = Me.Page.FindControl("cmbComuneNas")
                                CT1.SelectedIndex = -1
                                CT1.Items.FindByText(myReader1("NOME")).Selected = True
                            End If
                        End If
                        myReader1.Close()
                    End If

                End If
                myReader5.Close()

                par.cmd.CommandText = "SELECT * FROM DICHIARAZIONI_VSA WHERE ID=" & lIdDichiarazione
                myReader5 = par.cmd.ExecuteReader()
                If myReader5.Read() Then
                    'lblPGDic.Text = lblSPG.Text & "-" & myReader5("PG") & "-F205"
                    lblPGDic.Text = myReader5("PG") & "-F205"

                    iNumComponenti = myReader5("N_COMP_NUCLEO") - 1
                    iNumPersone = myReader5("N_COMP_NUCLEO")


                    If lProgr = 0 Then
                        cT = Me.Page.FindControl("txtIndRes")
                        cT.Text = par.IfNull(myReader5("IND_RES_DNTE"), "")

                        cT = Me.Page.FindControl("txtCivicoRes")
                        cT.Text = par.IfNull(myReader5("CIVICO_RES_DNTE"), "")

                        cT = Me.Page.FindControl("txtTelRes")
                        cT.Text = par.IfNull(myReader5("TELEFONO_DNTE"), "")

                        cT = Me.Page.FindControl("txtCAPRes")
                        cT.Text = par.IfNull(myReader5("CAP_RES_DNTE"), "")

                        lIndiceAppoggio_0 = myReader5("ID_LUOGO_NAS_DNTE")
                        lIndiceAppoggio_1 = myReader5("ID_LUOGO_RES_DNTE")
                        lIndiceAppoggio_2 = myReader5("ID_TIPO_IND_RES_DNTE")

                    Else
                        par.cmd.CommandText = "SELECT * FROM COMP_NAS_RES_CAMBI WHERE ID_COMPONENTE=" & lIndice_Componente
                        Dim myReader2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReader2.Read Then


                            lIndiceAppoggio_1 = myReader2("ID_LUOGO_RES_DNTE")
                            lIndiceAppoggio_2 = myReader2("ID_TIPO_IND_RES_DNTE")

                            CType(Me.Page.FindControl("txtIndRes"), TextBox).Text = par.IfNull(myReader2("IND_RES_DNTE"), "")
                            CType(Me.Page.FindControl("txtCivicoRes"), TextBox).Text = par.IfNull(myReader2("CIVICO_RES_DNTE"), "")

                            CType(Me.Page.FindControl("txtTelRes"), TextBox).Text = par.IfNull(myReader2("TELEFONO_DNTE"), "")

                            cT = Me.Page.FindControl("txtCAPRes")
                            cT.Text = par.IfNull(myReader2("CAP_RES"), "")

                            CT1 = Me.Page.FindControl("cmbTipoIRes")
                            CT1.SelectedIndex = -1
                            CT1.Items.FindByValue(par.IfNull(myReader2("ID_TIPO_IND_RES_DNTE"), 6)).Selected = True

                        End If
                        myReader2.Close()
                    End If
                End If
                myReader5.Close()
                If lProgr = 0 Then
                    par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE ID=" & lIndiceAppoggio_0
                    myReader5 = par.cmd.ExecuteReader()
                    If myReader5.Read() Then
                        CT1 = Me.Page.FindControl("cmbNazioneNas")
                        CT1.SelectedIndex = -1
                        If myReader5("SIGLA") = "E" Or myReader5("SIGLA") = "C" Then
                            CT1.Items.FindByText(myReader5("NOME")).Selected = True
                        Else
                            CT1.Items.FindByText("ITALIA").Selected = True
                            CT1 = Me.Page.FindControl("cmbPrNas")
                            CT1.SelectedIndex = -1
                            CT1.Items.FindByText(myReader5("SIGLA")).Selected = True
                            par.RiempiDList(Me, par.OracleConn, "cmbComuneNas", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & myReader5("SIGLA") & "' ORDER BY NOME ASC", "NOME", "ID")
                            CT1 = Me.Page.FindControl("cmbComuneNas")
                            CT1.SelectedIndex = -1
                            CT1.Items.FindByText(myReader5("NOME")).Selected = True
                        End If
                    End If
                    myReader5.Close()

                    par.cmd.CommandText = "SELECT DESCRIZIONE FROM T_TIPO_INDIRIZZO WHERE COD=" & lIndiceAppoggio_2

                    myReader5 = par.cmd.ExecuteReader()
                    If myReader5.Read() Then
                        CT1 = Me.Page.FindControl("cmbTipoIRes")
                        CT1.SelectedIndex = -1
                        CT1.Items.FindByText(myReader5("DESCRIZIONE")).Selected = True
                    End If
                    myReader5.Close()
                End If

                par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE ID=" & lIndiceAppoggio_1
                myReader5 = par.cmd.ExecuteReader()
                If myReader5.Read() Then
                    CT1 = Me.Page.FindControl("cmbNazioneRes")
                    CT1.SelectedIndex = -1
                    If myReader5("SIGLA") = "E" Or myReader5("SIGLA") = "C" Then
                        CT1.Items.FindByText(myReader5("NOME")).Selected = True
                    Else
                        CT1.Items.FindByText("ITALIA").Selected = True
                        CT1 = Me.Page.FindControl("cmbPrRes")
                        CT1.SelectedIndex = -1
                        CT1.Items.FindByText(myReader5("SIGLA")).Selected = True
                        par.RiempiDList(Me, par.OracleConn, "cmbComuneRes", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & myReader5("SIGLA") & "' ORDER BY NOME ASC", "NOME", "ID")
                        CT1 = Me.Page.FindControl("cmbComuneRes")
                        CT1.SelectedIndex = -1
                        CT1.Items.FindByText(myReader5("NOME")).Selected = True

                        'cT = Me.Page.FindControl("txtCAPRes")
                        'cT.Text = myReader("CAP")

                    End If
                End If
                myReader5.Close()

                par.cmd.CommandText = "SELECT * from INTESTATARI_CONTRATTI_VSA WHERE ID_DOMANDA=" & lIdDomanda
                myReader5 = par.cmd.ExecuteReader()
                If myReader5.Read() Then
                    CType(Dom_Alloggio_ERP1.FindControl("txtCognome"), TextBox).Text = par.IfNull(myReader5("cognome"), "")
                    CType(Dom_Alloggio_ERP1.FindControl("txtNome"), TextBox).Text = par.IfNull(myReader5("Nome"), "")
                    CType(Dom_Alloggio_ERP1.FindControl("txtDataNascita"), TextBox).Text = par.FormattaData(par.IfNull(myReader5("data_nascita_dnte"), ""))

                    CType(Dom_Alloggio_ERP1.FindControl("txtCF"), TextBox).Text = par.IfNull(myReader5("cod_fiscale"), "")
                    CType(Dom_Alloggio_ERP1.FindControl("cmbSesso"), DropDownList).Items.FindByText(par.IfNull(myReader5("sesso"), "")).Selected = True

                    par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE ID=" & myReader5("ID_LUOGO_NAS_DNTE")
                    Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader1.Read() Then
                        CT1 = Dom_Alloggio_ERP1.FindControl("cmbNazioneNas")
                        CT1.SelectedIndex = -1
                        If myReader1("SIGLA") = "E" Or myReader1("SIGLA") = "C" Then
                            CT1.Items.FindByText(myReader1("NOME")).Selected = True
                        Else
                            CT1.Items.FindByText("ITALIA").Selected = True
                            CT1 = Dom_Alloggio_ERP1.FindControl("cmbPrNas")
                            CT1.SelectedIndex = -1
                            CT1.Items.FindByText(myReader1("SIGLA")).Selected = True
                            par.RiempiDList(Dom_Alloggio_ERP1, par.OracleConn, "cmbComuneNas", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & myReader1("SIGLA") & "' ORDER BY NOME ASC", "NOME", "ID")
                            CT1 = Dom_Alloggio_ERP1.FindControl("cmbComuneNas")
                            CT1.SelectedIndex = -1
                            CT1.Items.FindByText(myReader1("NOME")).Selected = True
                        End If
                    End If
                    myReader1.Close()

                End If
                myReader5.Close()

                par.cmd.CommandText = "SELECT * from DOMANDE_VSA_ALLOGGIO WHERE ID_DOMANDA=" & lIdDomanda
                myReader5 = par.cmd.ExecuteReader()
                If myReader5.Read() Then
                    CType(Dom_Alloggio_ERP1.FindControl("txtCOMUNE"), TextBox).Text = par.IfNull(myReader5("COMUNE"), "")
                    CType(Dom_Alloggio_ERP1.FindControl("txtIndirizzo"), TextBox).Text = par.IfNull(myReader5("Indirizzo"), "")
                    CType(Dom_Alloggio_ERP1.FindControl("txtCAP"), TextBox).Text = par.IfNull(myReader5("cap"), "")
                    CType(Dom_Alloggio_ERP1.FindControl("txtCivico"), TextBox).Text = par.IfNull(myReader5("Civico"), "")
                    CType(Dom_Alloggio_ERP1.FindControl("txtInterno"), TextBox).Text = par.IfNull(myReader5("Interno"), "")
                    CType(Dom_Alloggio_ERP1.FindControl("txtScala"), TextBox).Text = par.IfNull(myReader5("Scala"), "")
                    'CType(Dom_Alloggio_ERP1.FindControl("txtPiano"), TextBox).Text = par.IfNull(myReader5("Piano"), "")
                    CType(Dom_Alloggio_ERP1.FindControl("cmbPianoUnita"), DropDownList).Items.FindByValue(par.IfNull(myReader5("Piano"), "78")).Selected = True

                    CType(Dom_Alloggio_ERP1.FindControl("txtNetta"), TextBox).Text = par.IfNull(myReader5("sup_netta"), "")
                    CType(Dom_Alloggio_ERP1.FindControl("txtLocali"), TextBox).Text = par.IfNull(myReader5("N_Locali"), "")
                    CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text = Trim(par.IfNull(myReader5("Num_Contratto"), ""))
                    'Ccodicetrovato.Value = par.IfNull(myReader5("Num_Contratto"), "")
                    CType(Dom_Alloggio_ERP1.FindControl("txtCOMUNE"), TextBox).Text = par.IfNull(myReader5("COMUNE"), "")
                    CType(Dom_Alloggio_ERP1.FindControl("txtDecorrenza"), TextBox).Text = par.FormattaData(par.IfNull(myReader5("dec_contratto"), ""))

                    'CType(Dom_Alloggio_ERP1.FindControl("cmbGestore"), DropDownList).SelectedIndex = -1
                    CType(Dom_Alloggio_ERP1.FindControl("cmbascensore"), DropDownList).SelectedIndex = -1
                    CType(Dom_Alloggio_ERP1.FindControl("cmbascensore"), DropDownList).Items.FindByValue(par.IfNull(myReader5("ascensore"), "0")).Selected = True
                    CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text = par.IfNull(myReader5("cod_unita_immobiliare"), "")

                    'Ucodicetrovato.Value = par.IfNull(myReader5("cod_unita_immobiliare"), "")

                    'CType(Dom_Alloggio_ERP1.FindControl("cmbTipoRapporto"), DropDownList).SelectedIndex = -1
                    'CType(Dom_Alloggio_ERP1.FindControl("cmbGestore"), DropDownList).Items.FindByValue(par.IfNull(myReader5("id_tipo_gestore"), "-1")).Selected = True
                    'CType(Dom_Alloggio_ERP1.FindControl("cmbTipoRapporto"), DropDownList).Items.FindByValue(par.IfNull(myReader5("id_tipo_rapporto"), "-1")).Selected = True

                End If
                myReader5.Close()


                par.cmd.CommandText = "SELECT F_RESIDENZA FROM COMP_PATR_IMMOB_VSA WHERE ID_COMPONENTE=" & lIndice_Componente
                myReader5 = par.cmd.ExecuteReader()
                If myReader5.Read() Then
                    Fl_Residenza = myReader5("F_RESIDENZA")
                End If
                myReader5.Close()
                If Fl_Residenza = "1" Then
                    'CType(Dom_Abitative_2_1.FindControl("alert2"), Image).Visible = True
                    'CType(Dom_Abitative_2_1.FindControl("alert3"), Image).Visible = True
                End If
                par.cmd.CommandText = "SELECT * FROM VSA_DOC_MANCANTI WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " ORDER BY ID_DOC ASC"
                myReader5 = par.cmd.ExecuteReader()
                While myReader5.Read
                    CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1
                    CType(Dom_Note1.FindControl("ListBox1"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader5("DESCRIZIONE"), ""), 250), myReader5("ID_DOC")))
                End While
                myReader5.Close()

                'cT = Me.Page.FindControl("txtPresso")
                'cT.Text = sPresso

                Dim da As New Oracle.DataAccess.Client.OracleDataAdapter("SELECT TO_CHAR(TO_DATE(DATA_NASCITA,'YYYYmmdd'),'DD/MM/YYYY') AS ""DATA_NASCITA"",PERC_INVAL,INDENNITA_ACC FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " ORDER BY PROGR ASC", par.OracleConn)

                Dim ds As New Data.DataSet()
                da.Fill(ds, "COMP_NUCLEO_VSA")
                DataGrid1.DataSource = ds
                DataGrid1.DataBind()
                da.Dispose()
                ds.Dispose()


                '***** 02/12/11 MTeresa CONTROLLO COINTESTATARIO ******
                If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = "1" Then
                    If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedItem.Value <> "8" Then
                        Dim idc As Long = 0
                        par.cmd.CommandText = "SELECT id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
                        Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderX1.Read Then
                            idc = myReaderX1("id")
                        End If
                        myReaderX1.Close()

                        par.cmd.CommandText = "select * from siscom_mi.bol_bollette where id_tipo = 4 and id_contratto = " & idc & " and importo_totale <> NVL(importo_pagato,0)"
                        Dim lettMorosita As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If lettMorosita.Read Then
                            CType(Dom_Dichiara_Cambi1.FindControl("lblCointest"), Label).Visible = True
                            CType(Dom_Dichiara_Cambi1.FindControl("cmbSiNo"), DropDownList).Visible = True
                        End If
                        lettMorosita.Close()
                    End If
                End If
                '***** 02/12/11 MTeresa FINE CONTROLLO COINTESTATARIO ******


                Me.DisattivaRichiedente()
                If lProgr = 0 Then
                    Me.DisattivaIndirizzo()
                End If

                Dim S As String


                S = ""
                If VerificaDati(S) = False Then
                    'Response.Write("<script>alert('Attenzione...Sono state riscontrate anomalie nella domanda. Risolvere il/i problema/i prima di salvare e stampare la domanda!')</script>")
                    'imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "IMG\elaborastampaNO.gif"
                Else
                    'imgStampa.Enabled = True
                    'imgStampa.ImageUrl = "IMG\elaborastampa.gif"
                End If
                par.myTrans = par.OracleConn.BeginTransaction()
                '‘par.cmd.Transaction = par.myTrans
                HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
                imgStampa.Enabled = False
                imgStampa.Visible = False
                btnSalva.Enabled = False
                btnSalva.Visible = False
                'Label5.Visible = False
                'Label6.Visible = False
            Else
                'Label10.Visible = True
                'Label10.Text = EX1.ToString
                par.OracleConn.Close()
                par.OracleConn.Dispose()
            End If

        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = ex.ToString
            par.OracleConn.Close()
            par.OracleConn.Dispose()
        End Try
    End Function

    Private Sub CaricaOspiti()

        Try

            Dim listaOspiti As String = ""
            par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_OSPITI_VSA WHERE ID_DOMANDA = " & lIdDomanda & " ORDER BY DATA_AGG DESC"
            'par.cmd.CommandText = "SELECT ID, COGNOME, NOME, DATA_NASC, COD_FISCALE, DATA_INIZIO_OSPITE, DATA_FINE_OSPITE FROM COMP_NUCLEO_OSPITI_VSA WHERE ID_DOMANDA = " & lIdDomanda & " ORDER BY DATA_AGG DESC"
            Dim myReaderOspiti As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            'Dim da As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            'dtOspiti = New Data.DataTable
            'da.Fill(dtOspiti)
            'da.Dispose()

            'Dim rowDT As System.Data.DataRow
            'If dtOspiti.Rows.Count > 0 Then

            '    CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).DataSource = dtOspiti
            '    CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).DataBind()

            'Else
            '    rowDT = dtOspiti.NewRow()
            '    rowDT.Item("ID") = "-1"
            '    rowDT.Item("COGNOME") = "&nbsp"
            '    rowDT.Item("NOME") = "&nbsp"

            '    dtOspiti.Rows.Add(rowDT)

            '    CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).DataSource = dtOspiti
            '    CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).DataBind()

            'End If
            While myReaderOspiti.Read
                listaOspiti = par.MiaFormat(par.IfNull(myReaderOspiti("COGNOME"), ""), 25) & " " & par.MiaFormat(par.IfNull(myReaderOspiti("NOME"), ""), 25) & " " & par.MiaFormat(par.FormattaData(myReaderOspiti("DATA_NASC")), 11) & "" & par.MiaFormat(par.IfNull(myReaderOspiti("COD_FISCALE"), ""), 22) _
                    & par.MiaFormat(par.FormattaData(par.IfNull(myReaderOspiti("DATA_INIZIO_OSPITE"), "")), 16) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReaderOspiti("DATA_FINE_OSPITE"), "")), 10)

                CType(Dom_Ospiti1.FindControl("ListBox1"), ListBox).Items.Add(New ListItem(listaOspiti, myReaderOspiti("ID")))
            End While
            myReaderOspiti.Close()

        Catch ex As Exception
            par.OracleConn.Close()
            par.OracleConn.Dispose()
        End Try

    End Sub

    Public Property dtOspiti() As Data.DataTable
        Get
            If Not (ViewState("dtOspiti") Is Nothing) Then
                Return ViewState("dtOspiti")
            Else
                Return New Data.DataTable
            End If
        End Get
        Set(ByVal value As Data.DataTable)
            ViewState("dtOspiti") = value
        End Set
    End Property

    Private Function NuovaDomanda()
        Dim lIndiceAppoggio_0 As Long
        Dim lIndiceAppoggio_1 As Long
        Dim lIndiceAppoggio_2 As Long
        Dim CT1 As DropDownList
        Dim LB1 As Label
        Dim cT As TextBox



        Try

            If Session.Item("ANAGRAFE") = "0" Then
                imgAnagrafe.Visible = False
                imgAnagrafe.Attributes.Clear()
            Else
                imgAnagrafe.Visible = True
            End If

            par.OracleConn.Open()
            par.SettaCommand(par)
            'HttpContext.Current.Session.Add("CONNESSIONE", par.OracleConn)

            '22/06/2012 - Stringa di connessione in sessione
            HttpContext.Current.Session.Add(lIdConnessDOMANDA, par.OracleConn)
            Session.Add("lIdConnessDOMANDA", lIdConnessDOMANDA)

            par.cmd.CommandText = "SELECT ANNO_ISEE,ANNO_CANONE,ID,TIPO_BANDO,DATA_INIZIO FROM BANDI_VSA WHERE STATO=1 order by id desc"
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                If myReader.HasRows = False Then
                    If lIdDichiarazione = -1 Then
                        myReader.Close()
                        par.cmd.Dispose()
                        par.OracleConn.Close()
                        Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                        Session.Item("LAVORAZIONE") = "0"
                        Response.Write("<script>alert('NESSUN BANDO APERTO. Non è possibile inserire nuove domande!');history.go(-1);</script>")
                    Else
                        myReader.Close()
                        par.cmd.Dispose()
                        par.OracleConn.Close()
                        Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                        Response.Write("<script>alert('Il Bando a cui appartiene questa domanda è CHIUSO. Per apportare modifiche utilizzare le funzioni di INTEGRAZIONE!');</script>")
                    End If
                    Exit Function
                Else
                    sAnnoIsee = myReader(0)
                    sAnnoCanone = myReader(1)
                    lIndice_Bando = myReader(2)
                    lBando = par.IfNull(myReader("TIPO_BANDO"), "-1")
                    'Select Case lBando
                    '    Case 0
                    '        lblSPG.Text = Mid(myReader("DATA_INIZIO"), 3, 2) & "-1"
                    '    Case 1
                    '        lblSPG.Text = Mid(myReader("DATA_INIZIO"), 3, 2) & "-2"
                    '    Case 2
                    '        lblSPG.Text = Mid(myReader("DATA_INIZIO"), 3, 2) & "-3"
                    'End Select
                End If
            Else
                If lIdDichiarazione = -1 Then
                    myReader.Close()
                    par.cmd.Dispose()
                    par.OracleConn.Close()
                    Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                    Session.Item("LAVORAZIONE") = "0"
                    Response.Write("<script>alert('NESSUN BANDO APERTO. Non è possibile inserire nuove domande!');history.go(-1);</script>")
                Else
                    myReader.Close()
                    par.cmd.Dispose()
                    par.OracleConn.Close()
                    Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                    Response.Write("<script>alert('Il Bando a cui appartiene questa domanda è CHIUSO. Per apportare modifiche utilizzare le funzioni di INTEGRAZIONE!');</script>")
                End If
                Exit Function
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT MAX(COD) FROM T_TIPO_PRATICHE WHERE ID_SEZIONE=10"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                lBando = par.IfNull(myReader(0), "-1")
            End If
            myReader.Close()



            par.RiempiDList(Me, par.OracleConn, "cmbNazioneNas", "SELECT * FROM COMUNI_NAZIONI WHERE SIGLA IN ('I','C','E') ORDER BY NOME ASC", "NOME", "ID")
            par.RiempiDList(Me, par.OracleConn, "cmbNazioneRes", "SELECT * FROM COMUNI_NAZIONI WHERE SIGLA IN ('I','C','E') ORDER BY NOME ASC", "NOME", "ID")
            par.RiempiDList(Me, par.OracleConn, "cmbPrNas", "SELECT DISTINCT SIGLA FROM COMUNI_NAZIONI ORDER BY SIGLA ASC", "SIGLA", "SIGLA")
            par.RiempiDList(Me, par.OracleConn, "cmbPrRes", "SELECT DISTINCT SIGLA FROM COMUNI_NAZIONI ORDER BY SIGLA ASC", "SIGLA", "SIGLA")
            par.RiempiDList(Me, par.OracleConn, "cmbProvRec", "SELECT DISTINCT SIGLA FROM COMUNI_NAZIONI ORDER BY SIGLA ASC", "SIGLA", "SIGLA")
            par.RiempiDList(Me, par.OracleConn, "cmbTipoIRes", "SELECT DESCRIZIONE,COD FROM T_TIPO_INDIRIZZO ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
            par.RiempiDList(Me, par.OracleConn, "cmbTipoIRec", "SELECT DESCRIZIONE,COD FROM T_TIPO_INDIRIZZO ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
            par.RiempiDList(Me, par.OracleConn, "cmbResidenza", "SELECT DESCRIZIONE,ID FROM T_RESIDENZA_LOMBARDIA where id=2 or id=3 ORDER BY ID ASC", "DESCRIZIONE", "ID")


            par.RiempiDList(Dom_Alloggio_ERP1, par.OracleConn, "cmbPianoUnita", "SELECT DESCRIZIONE,cod FROM siscom_mi.tipo_livello_piano ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")




            par.RiempiDList(Dom_Alloggio_ERP1, par.OracleConn, "cmbNazioneNas", "SELECT * FROM COMUNI_NAZIONI WHERE SIGLA IN ('I','C','E') ORDER BY NOME ASC", "NOME", "ID")
            par.RiempiDList(Dom_Alloggio_ERP1, par.OracleConn, "cmbPrNas", "SELECT DISTINCT SIGLA FROM COMUNI_NAZIONI ORDER BY SIGLA ASC", "SIGLA", "SIGLA")


            par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE ID=4415"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                CT1 = Dom_Alloggio_ERP1.FindControl("cmbNazioneNas")
                CT1.SelectedIndex = -1
                CT1.Items.FindByText("ITALIA").Selected = True
                CT1 = Dom_Alloggio_ERP1.FindControl("cmbPrNas")
                CT1.SelectedIndex = -1
                CT1.Items.FindByText(myReader("SIGLA")).Selected = True
                par.RiempiDList(Dom_Alloggio_ERP1, par.OracleConn, "cmbComuneNas", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & myReader("SIGLA") & "' ORDER BY NOME ASC", "NOME", "ID")
                CT1 = Dom_Alloggio_ERP1.FindControl("cmbComuneNas")
                CT1.SelectedIndex = -1
                CT1.Items.FindByText(myReader("NOME")).Selected = True


            End If
            myReader.Close()


            'par.RiempiDList(Dom_Alloggio_ERP1, par.OracleConn, "cmbGestore", "SELECT DESCRIZIONE,COD FROM T_TIPO_GESTORE WHERE COD=9 OR COD=12 ORDER BY COD DESC", "DESCRIZIONE", "COD")
            'par.RiempiDList(Dom_Alloggio_ERP1, par.OracleConn, "cmbTipoRapporto", "SELECT DESCRIZIONE,COD FROM T_TIPO_RAPPORTO ORDER BY COD asc", "DESCRIZIONE", "COD")


            Dim lsiFrutto As New ListItem(" ", "-1")



            CT1 = Me.Page.FindControl("cmbResidenza")
            CT1.Items.Add(lsiFrutto)
            CT1.SelectedIndex = -1
            CT1.Items.FindByValue(-1).Selected = True



            'CT1 = Dom_Alloggio_ERP1.FindControl("cmbGestore")
            'CT1.Items.Add(lsiFrutto)
            'CT1.SelectedIndex = -1
            'CT1.Items.FindByValue(-1).Selected = True



            CT1 = Dom_Alloggio_ERP1.FindControl("cmbAscensore")
            CT1.Items.Add(lsiFrutto)
            CT1.SelectedIndex = -1
            CT1.Items.FindByValue(-1).Selected = True

            If Session.Item("MOD_EMRI") = "1" And Session.Item("MOD_ABB_DEC") = "1" Then
                par.RiempiDList(Dom_Dichiara_Cambi1, par.OracleConn, "cmbTipoRichiesta", "SELECT DESCRIZIONE,ID FROM T_MOTIVO_DOMANDA_VSA WHERE ID=4 OR ID=5 ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "ID")
            Else
                If Session.Item("MOD_ABB_DEC") = "1" Then
                    par.RiempiDList(Dom_Dichiara_Cambi1, par.OracleConn, "cmbTipoRichiesta", "SELECT DESCRIZIONE,ID FROM T_MOTIVO_DOMANDA_VSA WHERE ID=4 OR ID=5 ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "ID")
                End If
                If Session.Item("MOD_EMRI") = "1" Then
                    par.RiempiDList(Dom_Dichiara_Cambi1, par.OracleConn, "cmbTipoRichiesta", "SELECT DESCRIZIONE,ID FROM T_MOTIVO_DOMANDA_VSA WHERE ID=4 OR ID=5 ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "ID")
                End If
            End If



            CT1 = Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta")
            CT1.Items.Add(lsiFrutto)
            CT1.SelectedIndex = -1
            CT1.Items.FindByValue(-1).Selected = True

            'par.RiempiDList(Dom_Dichiara_Cambi1, par.OracleConn, "cmbPresentaD", "SELECT cod,descrizione FROM t_causali_domanda_vsa ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
            'CT1 = Dom_Dichiara_Cambi1.FindControl("cmbPresentaD")
            'CT1.Items.Add(lsiFrutto)
            'CT1.SelectedIndex = -1
            'CT1.Items.FindByValue(-1).Selected = True

            CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = False
            CType(Dom_Dichiara_Cambi1.FindControl("Label16"), Label).Visible = False


            Dim item As ListItem

            CT1 = Me.Page.FindControl("cmbProvRec")
            CT1.SelectedIndex = -1
            CT1.Items.FindByText("MI").Selected = True
            item = CT1.SelectedItem
            par.RiempiDList(Me, par.OracleConn, "cmbComuneRec", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & par.PulisciStrSql(item.Text) & "' ORDER BY NOME ASC", "NOME", "ID")

            CT1 = Me.Page.FindControl("cmbComuneRec")
            CT1.SelectedIndex = -1
            CT1.Items.FindByText("MILANO").Selected = True
            item = CT1.SelectedItem


            par.cmd.CommandText = "SELECT CAP FROM COMUNI_NAZIONI WHERE NOME='" & par.PulisciStrSql(item.Text) & "'"
            cT = Me.Page.FindControl("txtCAPRec")
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                cT.Text = myReader(0)
            End If
            myReader.Close()

            CT1 = Me.Page.FindControl("cmbTipoIRec")
            CT1.SelectedIndex = -1
            CT1.Items.FindByText("VIA").Selected = True

            txtDataPG.Text = Format(Now(), "dd/MM/yyyy")
            lblISBAR.Text = "0,000"

            par.cmd.CommandText = "SELECT * FROM DICHIARAZIONI_VSA WHERE ID=" & lIdDichiarazione
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                'lblPGDic.Text = lblSPG.Text & "-" & myReader("PG") & "-F205"
                lblPGDic.Text = myReader("PG") & "-F205"

                iNumComponenti = myReader("N_COMP_NUCLEO") - 1
                iNumPersone = myReader("N_COMP_NUCLEO")

                If lProgr = 0 Then

                    cT = Me.Page.FindControl("txtIndRes")
                    cT.Text = par.IfNull(myReader("IND_RES_DNTE"), "")

                    cT = Me.Page.FindControl("txtCivicoRes")
                    cT.Text = par.IfNull(myReader("CIVICO_RES_DNTE"), "")

                    cT = Me.Page.FindControl("txtTelRes")
                    cT.Text = par.IfNull(myReader("TELEFONO_DNTE"), "")

                    cT = Me.Page.FindControl("txtCAPRes")
                    cT.Text = par.IfNull(myReader("CAP_RES_DNTE"), "")


                    cT = Me.Page.FindControl("txtIndirizzoRec")
                    cT.Text = par.IfNull(myReader("IND_RES_DNTE"), "")

                    cT = Me.Page.FindControl("txtCivicoRec")
                    cT.Text = par.IfNull(myReader("CIVICO_RES_DNTE"), "")

                    cT = Me.Page.FindControl("txtTelRec")
                    cT.Text = par.IfNull(myReader("TELEFONO_DNTE"), "")

                    cT = Me.Page.FindControl("txtCAPRec")
                    cT.Text = par.IfNull(myReader("CAP_RES_DNTE"), "")





                    lIndiceAppoggio_0 = myReader("ID_LUOGO_NAS_DNTE")
                    lIndiceAppoggio_1 = myReader("ID_LUOGO_RES_DNTE")
                    lIndiceAppoggio_2 = myReader("ID_TIPO_IND_RES_DNTE")
                Else

                    cT = Me.Page.FindControl("txtIndRes")
                    cT.Text = ""

                    cT = Me.Page.FindControl("txtCivicoRes")
                    cT.Text = ""

                    cT = Me.Page.FindControl("txtTelRes")
                    cT.Text = ""

                    lIndiceAppoggio_1 = 4415 'MILANO
                    lIndiceAppoggio_2 = 6 'VIA
                End If
            End If
            myReader.Close()

            If lProgr = 0 Then
                par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE ID=" & lIndiceAppoggio_0
                myReader = par.cmd.ExecuteReader()
                If myReader.Read() Then
                    CT1 = Me.Page.FindControl("cmbNazioneNas")
                    If myReader("SIGLA") = "E" Or myReader("SIGLA") = "C" Then
                        CT1.SelectedIndex = -1
                        CT1.Items.FindByText(myReader("NOME")).Selected = True
                        'LB1 = Me.Page.FindControl("Label6")
                        'LB1.Visible = False
                        'LB1 = Me.Page.FindControl("Label7")
                        'LB1.Visible = False
                        CT1 = Me.Page.FindControl("cmbPrNas")
                        CT1.Visible = False
                        CT1 = Me.Page.FindControl("cmbComuneNas")
                        CT1.Visible = False
                    Else
                        CT1.SelectedIndex = -1
                        CT1.Items.FindByText("ITALIA").Selected = True
                        CT1 = Me.Page.FindControl("cmbPrNas")
                        CT1.SelectedIndex = -1
                        CT1.Items.FindByText(myReader("SIGLA")).Selected = True
                        par.RiempiDList(Me, par.OracleConn, "cmbComuneNas", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & myReader("SIGLA") & "' ORDER BY NOME ASC", "NOME", "ID")
                        CT1 = Me.Page.FindControl("cmbComuneNas")
                        CT1.SelectedIndex = -1
                        CT1.Items.FindByText(myReader("NOME")).Selected = True
                    End If
                End If
                myReader.Close()

                par.cmd.CommandText = "SELECT * FROM T_TIPO_INDIRIZZO WHERE COD=" & lIndiceAppoggio_2
                myReader = par.cmd.ExecuteReader()
                If myReader.Read() Then
                    CT1 = Me.Page.FindControl("cmbTipoIRes")
                    CT1.SelectedIndex = -1
                    CT1.Items.FindByText(myReader("DESCRIZIONE")).Selected = True
                End If
                myReader.Close()

                par.cmd.CommandText = "SELECT * FROM T_TIPO_INDIRIZZO WHERE COD=" & lIndiceAppoggio_2
                myReader = par.cmd.ExecuteReader()
                If myReader.Read() Then
                    CT1 = Me.Page.FindControl("cmbTipoIRes")
                    CT1.SelectedIndex = -1
                    CT1.Items.FindByText(myReader("DESCRIZIONE")).Selected = True
                End If
                myReader.Close()

            End If
            par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE ID=" & lIndiceAppoggio_1
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                CT1 = Me.Page.FindControl("cmbNazioneRes")
                CT1.SelectedIndex = -1
                If myReader("SIGLA") = "E" Or myReader("SIGLA") = "C" Then
                    CT1.Items.FindByText(myReader("NOME")).Selected = True
                Else
                    CT1.Items.FindByText("ITALIA").Selected = True
                    CT1 = Me.Page.FindControl("cmbPrRes")
                    CT1.SelectedIndex = -1
                    CT1.Items.FindByText(myReader("SIGLA")).Selected = True
                    par.RiempiDList(Me, par.OracleConn, "cmbComuneRes", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & myReader("SIGLA") & "' ORDER BY NOME ASC", "NOME", "ID")
                    CT1 = Me.Page.FindControl("cmbComuneRes")
                    CT1.SelectedIndex = -1
                    CT1.Items.FindByText(myReader("NOME")).Selected = True

                    'cT = Me.Page.FindControl("txtCAPRes")
                    'cT.Text = myReader("CAP")
                End If
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT DESCRIZIONE FROM T_TIPO_INDIRIZZO WHERE COD=" & lIndiceAppoggio_2

            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                CT1 = Me.Page.FindControl("cmbTipoIRes")
                CT1.SelectedIndex = -1
                CT1.Items.FindByText(myReader("DESCRIZIONE")).Selected = True
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " AND PROGR=" & lProgr
            myReader = par.cmd.ExecuteReader()
            Dim sPresso As String
            sPresso = ""

            If myReader.Read() Then
                cT = Me.Page.FindControl("txtCognome")
                cT.Text = par.IfNull(myReader("COGNOME"), "")
                sPresso = cT.Text
                cT = Me.Page.FindControl("txtNome")
                cT.Text = par.IfNull(myReader("NOME"), "")
                sPresso = sPresso & " " & cT.Text
                cT = Me.Page.FindControl("txtDataNascita")
                cT.Text = Mid(par.IfNull(myReader("DATA_NASCITA"), ""), 7, 2) & "/" & Mid(par.IfNull(myReader("DATA_NASCITA"), ""), 5, 2) & "/" & Mid(par.IfNull(myReader("DATA_NASCITA"), ""), 1, 4)

                cT = Me.Page.FindControl("txtCF")
                cT.Text = par.IfNull(myReader("COD_FISCALE"), "")

                If lProgr <> 0 Then

                    par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE COD='" & Mid(cT.Text, 12, 4) & "'"
                    Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader1.Read() Then
                        CT1 = Me.Page.FindControl("cmbNazioneNas")
                        If myReader1("SIGLA") = "E" Or myReader1("SIGLA") = "C" Then
                            CT1.SelectedIndex = -1
                            CT1.Items.FindByText(myReader1("NOME")).Selected = True
                            CT1 = Me.Page.FindControl("cmbPrNas")
                            CT1.Visible = False
                            CT1 = Me.Page.FindControl("cmbComuneNas")
                            CT1.Visible = False
                            'LB1 = Me.Page.FindControl("Label6")
                            'LB1.Visible = False
                            'LB1 = Me.Page.FindControl("Label7")
                            'LB1.Visible = False
                        Else
                            CT1.SelectedIndex = -1
                            CT1.Items.FindByText("ITALIA").Selected = True
                            CT1 = Me.Page.FindControl("cmbPrNas")
                            CT1.SelectedIndex = -1
                            CT1.Items.FindByText(myReader1("SIGLA")).Selected = True
                            par.RiempiDList(Me, par.OracleConn, "cmbComuneNas", "SELECT ID,NOME FROM COMUNI_NAZIONI WHERE SIGLA='" & myReader1("SIGLA") & "' ORDER BY NOME ASC", "NOME", "ID")
                            CT1 = Me.Page.FindControl("cmbComuneNas")
                            CT1.SelectedIndex = -1
                            CT1.Items.FindByText(myReader1("NOME")).Selected = True
                        End If
                    End If
                    myReader1.Close()
                End If

                CT1 = Me.Page.FindControl("cmbSesso")
                CT1.SelectedIndex = -1
                CT1.Items.FindByText(myReader("SESSO")).Selected = True




                lIndice_Componente = myReader("ID")

            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * FROM utenza_comp_nucleo WHERE cod_fiscale='" & CType(Me.Page.FindControl("txtCF"), TextBox).Text & "'"

            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                CType(Dom_Dichiara_Cambi1.FindControl("cmbFattaAU"), DropDownList).SelectedIndex = -1
                CType(Dom_Dichiara_Cambi1.FindControl("cmbFattaAU"), DropDownList).Items.FindByText("SI").Selected = True
            Else
                CType(Dom_Dichiara_Cambi1.FindControl("cmbFattaAU"), DropDownList).SelectedIndex = -1
                CType(Dom_Dichiara_Cambi1.FindControl("cmbFattaAU"), DropDownList).Items.FindByText("NO").Selected = True

            End If
            myReader.Close()

            'par.cmd.CommandText = "SELECT domande_bando.id FROM domande_bando,comp_nucleo WHERE domande_bando.progr_componente=comp_nucleo.progr and domande_bando.id_dichiarazione=comp_nucleo.id_dichiarazione and comp_nucleo.cod_fiscale='" & CType(Me.Page.FindControl("txtCF"), TextBox).Text & "'"
            'myReader = par.cmd.ExecuteReader()
            'If myReader.Read() Then
            '    CType(Dom_Dichiara_Cambi1.FindControl("lblERP"), Label).Visible = True
            '    CType(Dom_Dichiara_Cambi1.FindControl("lblERP"), Label).Attributes.Add("onClick", "javascript:window.open('StatoDomanda.aspx?ID=" & myReader("id") & "','Stato','height=370,top=0,left=0,width=480,scrollbars=no');")
            'Else
            '    CType(Dom_Dichiara_Cambi1.FindControl("lblERP"), Label).Visible = False
            'End If
            'myReader.Close()

            par.cmd.CommandText = "SELECT F_RESIDENZA FROM COMP_PATR_IMMOB_VSA WHERE ID_COMPONENTE=" & lIndice_Componente
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                Fl_Residenza = myReader("F_RESIDENZA")
            End If
            myReader.Close()
            If Fl_Residenza = "1" Then
                'CType(Dom_Abitative_2_1.FindControl("alert2"), Image).Visible = True
                'CType(Dom_Abitative_2_1.FindControl("alert3"), Image).Visible = True
            End If

            cT = Me.Page.FindControl("txtPresso")
            cT.Text = sPresso


            CType(Dom_Alloggio_ERP1.FindControl("txtCOMUNE"), TextBox).Text = CType(Me.Page.FindControl("cmbComuneRes"), DropDownList).SelectedItem.Text
            CType(Dom_Alloggio_ERP1.FindControl("txtIndirizzo"), TextBox).Text = CType(Me.Page.FindControl("cmbTipoIRes"), DropDownList).SelectedItem.Text & " " & CType(Me.Page.FindControl("txtIndRes"), TextBox).Text
            CType(Dom_Alloggio_ERP1.FindControl("txtCAP"), TextBox).Text = CType(Me.Page.FindControl("txtCAPRes"), TextBox).Text
            CType(Dom_Alloggio_ERP1.FindControl("txtCivico"), TextBox).Text = CType(Me.Page.FindControl("txtCivicoRes"), TextBox).Text


            'CType(Dom_Alloggio_ERP1.FindControl("cmbTipoRapporto"), DropDownList).SelectedIndex = 0
            'CType(Dom_Alloggio_ERP1.FindControl("cmbTipoRapporto"), DropDownList).Items.FindByValue(0).Selected = True

            Dim da As New Oracle.DataAccess.Client.OracleDataAdapter("SELECT TO_CHAR(TO_DATE(DATA_NASCITA,'YYYYmmdd'),'DD/MM/YYYY') AS ""DATA_NASCITA"",PERC_INVAL,INDENNITA_ACC FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " ORDER BY PROGR ASC", par.OracleConn)

            Dim ds As New Data.DataSet()
            da.Fill(ds, "COMP_NUCLEO_VSA")
            DataGrid1.DataSource = ds
            DataGrid1.DataBind()
            da.Dispose()
            ds.Dispose()




            par.cmd.CommandText = "SELECT MAX(ID) FROM NUM_PROTOCOLLI_VSA"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                lValoreCorrente = myReader(0) + 1
            End If
            myReader.Close()
            par.cmd.CommandText = "INSERT INTO NUM_PROTOCOLLI_VSA VALUES (" & lValoreCorrente & ")"
            par.cmd.ExecuteNonQuery()
            lblPG.Text = Format(lValoreCorrente, "0000000000")

            par.myTrans = par.OracleConn.BeginTransaction()
            '‘par.cmd.Transaction = par.myTrans
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)


            par.cmd.CommandText = "INSERT INTO DOMANDE_BANDO_VSA (ID,FL_PRATICA_CHIUSA,ID_STATO,N_DISTINTA,FL_CONFERMA_SCARICO,TIPO_PRATICA,FL_ASS_ESTERNA) VALUES (SEQ_DOMANDE_BANDO_VSA.NEXTVAL,'0','1',0,'0'," & lBando & ",'1')"
            par.cmd.ExecuteNonQuery()
            par.cmd.CommandText = "SELECT SEQ_DOMANDE_BANDO_VSA.CURRVAL FROM DUAL"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                lIdDomanda = myReader(0)
            End If
            myReader.Close()
            lblPG.ToolTip = lIdDomanda
            If lProgr <> 0 Then
                par.cmd.CommandText = "INSERT INTO COMP_NAS_RES_VSA (ID_COMPONENTE) VALUES (" & lIndice_Componente & ")"
                par.cmd.ExecuteNonQuery()
            End If
            par.cmd.CommandText = "INSERT INTO DOMANDE_VSA_ALLOGGIO (ID_DOMANDA) VALUES (" & lIdDomanda & ")"
            par.cmd.ExecuteNonQuery()

            Me.DisattivaRichiedente()
            If lProgr = 0 Then
                Me.DisattivaIndirizzo()
            End If
            Session.Add("LAVORAZIONE", "1")

            If Session.Item("ANAGRAFE") = "1" Then
                'imgAnagrafe.Attributes.Clear()
                imgAnagrafe.Attributes.Add("onclick", "javascript:window.open('../../Anagrafe.aspx?ID=" & par.criptamolto(lIdDichiarazione) & "&T=4','Anagrafe','top=0,left=0,width=600,height=400');")
            End If

        Catch EX As Exception
            par.SegnalaErrore(EX.ToString)
            par.OracleConn.Close()
            Session.Item("LAVORAZIONE") = "0"
            'Label5.Text = EX.ToString
        Finally
            If Not par.OracleConn Is Nothing Then
                'par.OracleConn.Close()
                'par.OracleConn.Dispose()
            End If
        End Try
    End Function

    Public Property lIdConnessDOMANDA() As String
        Get
            If Not (ViewState("par_lIdConnessDOMANDA") Is Nothing) Then
                Return CStr(ViewState("par_lIdConnessDOMANDA"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_lIdConnessDOMANDA") = value
        End Set

    End Property

    Public Property FL_VECCHIO_BANDO() As String
        Get
            If Not (ViewState("par_FL_VECCHIO_BANDO") Is Nothing) Then
                Return CStr(ViewState("par_FL_VECCHIO_BANDO"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_FL_VECCHIO_BANDO") = value
        End Set

    End Property

    Public Property FL_RINNOVO() As String
        Get
            If Not (ViewState("par_FL_RINNOVO") Is Nothing) Then
                Return CStr(ViewState("par_FL_RINNOVO"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_FL_RINNOVO") = value
        End Set

    End Property

    Public Property Fl_US() As String
        Get
            If Not (ViewState("par_Fl_US") Is Nothing) Then
                Return CStr(ViewState("par_Fl_US"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_Fl_US") = value
        End Set

    End Property

    Public Property Fl_DerogaInCorso() As String
        Get
            If Not (ViewState("par_Fl_DerogaInCorso") Is Nothing) Then
                Return CStr(ViewState("par_Fl_DerogaInCorso"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_Fl_DerogaInCorso") = value
        End Set

    End Property

    Public Property Fl_Integrazione() As String
        Get
            If Not (ViewState("par_Fl_Integrazione") Is Nothing) Then
                Return CStr(ViewState("par_Fl_Integrazione"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_Fl_Integrazione") = value
        End Set

    End Property


    Public Property Fl_Residenza() As String
        Get
            If Not (ViewState("par_Residenza") Is Nothing) Then
                Return CStr(ViewState("par_Residenza"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_Residenza") = value
        End Set

    End Property


    Public Property DeviSalvare() As Boolean
        Get
            If Not (ViewState("par_DeviSalvare") Is Nothing) Then
                Return CLng(ViewState("par_DeviSalvare"))
            Else
                Return False
            End If
        End Get

        Set(ByVal value As Boolean)
            ViewState("par_DeviSalvare") = value
        End Set

    End Property


    Public Property bMemorizzato() As Boolean
        Get
            If Not (ViewState("par_bMemorizzato") Is Nothing) Then
                Return CLng(ViewState("par_bMemorizzato"))
            Else
                Return False
            End If
        End Get

        Set(ByVal value As Boolean)
            ViewState("par_bMemorizzato") = value
        End Set

    End Property

    Public Property condominio() As Boolean
        Get
            If Not (ViewState("par_condominio") Is Nothing) Then
                Return CLng(ViewState("par_condominio"))
            Else
                Return False
            End If
        End Get

        Set(ByVal value As Boolean)
            ViewState("par_condominio") = value
        End Set

    End Property

    Public Property lBando() As Long
        Get
            If Not (ViewState("par_lBando") Is Nothing) Then
                Return CLng(ViewState("par_lBando"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_lBando") = value
        End Set

    End Property

    Public Property INDICE_CONTRATTO() As Long
        Get
            If Not (ViewState("par_INDICE_CONTRATTO") Is Nothing) Then
                Return CLng(ViewState("par_INDICE_CONTRATTO"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_INDICE_CONTRATTO") = value
        End Set

    End Property

    Public Property iNumPersone() As Integer
        Get
            If Not (ViewState("par_iNumPersone") Is Nothing) Then
                Return CInt(ViewState("par_iNumPersone"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Integer)
            ViewState("par_iNumPersone") = value
        End Set

    End Property

    Public Property annoSitEconom() As Integer
        Get
            If Not (ViewState("par_annoSitEconom") Is Nothing) Then
                Return CInt(ViewState("par_annoSitEconom"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Integer)
            ViewState("par_annoSitEconom") = value
        End Set

    End Property

    Public Property iNumComponenti() As Integer
        Get
            If Not (ViewState("par_componenti") Is Nothing) Then
                Return CInt(ViewState("par_componenti"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Integer)
            ViewState("par_componenti") = value
        End Set

    End Property

    Public Property sStato() As String
        Get
            If Not (ViewState("par_sStato") Is Nothing) Then
                Return CStr(ViewState("par_sStato"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sStato") = value
        End Set

    End Property

    Public Property lProgr() As Integer
        Get
            If Not (ViewState("par_lProgr") Is Nothing) Then
                Return CInt(ViewState("par_lProgr"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Integer)
            ViewState("par_lProgr") = value
        End Set

    End Property


    Public Property lIdDichiarazione() As Long
        Get
            If Not (ViewState("par_lIdDichiarazione") Is Nothing) Then
                Return CLng(ViewState("par_lIdDichiarazione"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_lIdDichiarazione") = value
        End Set

    End Property


    Public Property lIdDomanda() As Long
        Get
            If Not (ViewState("par_lIdDomanda") Is Nothing) Then
                Return CLng(ViewState("par_lIdDomanda"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_lIdDomanda") = value
        End Set

    End Property

    Public Property lIdDomScambio() As Long
        Get
            If Not (ViewState("par_lIdDomScambio") Is Nothing) Then
                Return CLng(ViewState("par_lIdDomScambio"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_lIdDomScambio") = value
        End Set

    End Property


    Public Property statoDichCollegata() As Boolean
        Get
            If Not (ViewState("par_statoDichCollegata") Is Nothing) Then
                Return CLng(ViewState("par_statoDichCollegata"))
            Else
                Return False
            End If
        End Get

        Set(ByVal value As Boolean)
            ViewState("par_statoDichCollegata") = value
        End Set

    End Property

    Public Property decisioneConMotivi() As Boolean
        Get
            If Not (ViewState("par_decisioneConMotivi") Is Nothing) Then
                Return CLng(ViewState("par_decisioneConMotivi"))
            Else
                Return False
            End If
        End Get

        Set(ByVal value As Boolean)
            ViewState("par_decisioneConMotivi") = value
        End Set

    End Property

    Public Property lNuovaDomanda() As Long
        Get
            If Not (ViewState("par_lNuovaDomanda") Is Nothing) Then
                Return CLng(ViewState("par_lNuovaDomanda"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_lNuovaDomanda") = value
        End Set

    End Property


    Public Property lIndice_Componente() As Long
        Get
            If Not (ViewState("par_lIndice_Componente") Is Nothing) Then
                Return CLng(ViewState("par_lIndice_Componente"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_lIndice_Componente") = value
        End Set

    End Property

    Public Property iTab() As Integer
        Get
            If Not (ViewState("par_itab") Is Nothing) Then
                Return CInt(ViewState("par_itab"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Integer)
            ViewState("par_itab") = value
        End Set

    End Property


    Public Property lIndice_Bando() As Long
        Get
            If Not (ViewState("par_lIndice_Bando") Is Nothing) Then
                Return CLng(ViewState("par_lIndice_Bando"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_lIndice_Bando") = value
        End Set

    End Property

    Public Property modPresent() As String
        Get
            If Not (ViewState("modPresent") Is Nothing) Then
                Return CStr(ViewState("modPresent"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("modPresent") = value
        End Set

    End Property

    Public Property morosita() As Integer
        Get
            If Not (ViewState("par_morosita") Is Nothing) Then
                Return CInt(ViewState("par_morosita"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Integer)
            ViewState("par_morosita") = value
        End Set

    End Property
    Public Property fl_osserv() As Integer
        Get
            If Not (ViewState("par_fl_osserv") Is Nothing) Then
                Return CInt(ViewState("par_fl_osserv"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Integer)
            ViewState("par_fl_osserv") = value
        End Set

    End Property

    Public Property fl_fine_sosp() As Integer
        Get
            If Not (ViewState("par_fl_fine_sosp") Is Nothing) Then
                Return CInt(ViewState("par_fl_fine_sosp"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Integer)
            ViewState("par_fl_fine_sosp") = value
        End Set

    End Property

    Public Property fl_contab() As Integer
        Get
            If Not (ViewState("par_fl_contab") Is Nothing) Then
                Return CInt(ViewState("par_fl_contab"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Integer)
            ViewState("par_fl_contab") = value
        End Set

    End Property

    Public Property aggVoce() As Boolean
        Get
            If Not (ViewState("par_aggVoce") Is Nothing) Then
                Return CLng(ViewState("par_aggVoce"))
            Else
                Return False
            End If
        End Get

        Set(ByVal value As Boolean)
            ViewState("par_aggVoce") = value
        End Set
    End Property

    Private Function VerificaDati(ByRef S As String) As Boolean
        Dim i As Integer
        Dim adulti As Integer
        Dim TRENTENNI As Integer
        Dim MINORI As Integer

        Dim VerificaDati1 As Boolean
        Dim VerificaDati2 As Boolean
        Dim VerificaDati3 As Boolean
        Dim VerificaDati4 As Boolean
        Dim VerificaDati5 As Boolean
        Dim VerificaDati6 As Boolean
        Dim VerificaDati7 As Boolean
        Dim VerificaDati8 As Boolean
        Dim VerificaDati9 As Boolean
        Dim VerificaDati01 As Boolean
        Dim VerificaDati02 As Boolean

        Dim VerificaDati10 As Boolean

        VerificaDati1 = True
        VerificaDati01 = True
        VerificaDati02 = True
        VerificaDati2 = True
        VerificaDati3 = True
        VerificaDati4 = True
        VerificaDati5 = True
        VerificaDati6 = True
        VerificaDati7 = True
        VerificaDati8 = True
        VerificaDati9 = True
        VerificaDati10 = True
        VerificaDati = True

        If lProgr <> 0 Then
            If CType(Me.Page.FindControl("txtIndRes"), TextBox).Text = "" Then
                VerificaDati10 = False
            End If
            If CType(Me.Page.FindControl("txtCivicoRes"), TextBox).Text = "" Then
                VerificaDati10 = False
            End If
        End If

        'If CType(Dom_Dichiara1.FindControl("cf1"), CheckBox).Checked = True And iNumComponenti = 1 Then
        '    CType(Dom_Dichiara1.FindControl("alert1"), Image).Visible = True
        '    VerificaDati01 = False
        '    S = "TAB DICHIARA - VOCE 1 non consentita!"
        'Else
        '    CType(Dom_Dichiara1.FindControl("alert1"), Image).Visible = False
        'End If





        If VerificaDati10 = False Or VerificaDati9 = False Or VerificaDati8 = False Or VerificaDati01 = False Or VerificaDati02 = False Or VerificaDati1 = False Or VerificaDati2 = False Or VerificaDati3 = False Or VerificaDati4 = False Or VerificaDati5 = False Or VerificaDati6 = False Or VerificaDati7 = False Then
            VerificaDati = False
        Else
            VerificaDati = True
        End If
    End Function



    Private Function Valore01(ByVal valore As Boolean) As String
        If valore = True Then
            Valore01 = "1"
        Else
            Valore01 = "0"
        End If
    End Function


    Protected Sub imgStampa_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles imgStampa.Click
        If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = 3 Then
            If conferma.Value = "0" Then
                Call btnSalva_Click(sender, e)
                Exit Sub
            End If
        End If
        Call btnSalva_Click(sender, e)
        If bMemorizzato = True Then
            'imgAttendi.Visible = True
            DeviSalvare = False
            CalcolaStampa()
            'imgAttendi.Visible = False
            If Fl_Integrazione = "1" Then
                Session.Item("CONFERMATO") = "0"
            End If
            If DeviSalvare = True Then
                Call btnSalva_Click(sender, e)
            End If
        Else
            imgStampa.Enabled = False
            'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
        End If

    End Sub

    Private Function CalcolaISEE()

        Dim DETRAZIONI As Long


        Dim INV_100_CON As Integer
        Dim INV_100_NO As Integer
        Dim INV_66_99 As Integer
        Dim TOT_COMPONENTI As Integer
        Dim REDDITO_COMPLESSIVO As Double
        Dim TOT_SPESE As Long
        Dim DETRAZIONI_FRAGILE As Long
        Dim DETRAZIONI_FR As Long

        Dim MOBILI As Double
        Dim TASSO_RENDIMENTO As Double
        Dim FIGURATIVO_MOBILI As Double
        Dim TOTALE_ISEE_ERP As Double
        Dim IMMOBILI As Long
        Dim MUTUI As Long
        Dim IMMOBILI_RESIDENZA As Long
        Dim MUTUI_RESIDENZA As Long
        Dim TOTALE_PATRIMONIO_ISEE_ERP As Double
        Dim TOTALE_IMMOBILI As Long
        Dim LIMITE_PATRIMONIO As Double

        Dim ISR_ERP As Double
        Dim ISP_ERP As Double
        Dim ISE_ERP As Double
        Dim VSE As Double
        Dim ISEE_ERP As Double
        Dim ESCLUSIONE As String


        Dim PARAMETRO_MINORI As Double

        Dim MINORI As Integer
        Dim adulti As Integer

        Dim STRINGA_STAMPA As String
        Dim STRINGA_STAMPA_1 As String
        Dim STRINGA_STAMPA_2 As String
        Dim STRINGA_STAMPA_3 As String
        Dim STRINGA_STAMPA_4 As String
        Dim STRINGA_STAMPA_5 As String
        Dim STRINGA_STAMPA_6 As String
        Dim STRINGA_STAMPA_66 As String
        Dim STRINGA_STAMPA_7 As String
        Dim TIPO_ALLOGGIO As Integer

        Dim Testo_Da_Scrivere As String
        Dim glIndice_Bando_Origine As Long
        Dim DescrizioneBandoAggiornamento As String
        Dim CONTRATTO_30_ANNI As Boolean = False

        Try

            MINORI = 0
            adulti = 0

            ISR_ERP = 0
            ISP_ERP = 0
            ISE_ERP = 0

            VSE = 0

            TOT_COMPONENTI = 0

            DETRAZIONI = 0
            REDDITO_COMPLESSIVO = 0
            TOT_SPESE = 0
            DETRAZIONI_FRAGILE = 0
            DETRAZIONI_FR = 0
            ISEE_ERP = 0
            MOBILI = 0
            FIGURATIVO_MOBILI = 0

            IMMOBILI = 0
            MUTUI = 0
            IMMOBILI_RESIDENZA = 0
            MUTUI_RESIDENZA = 0
            TOTALE_IMMOBILI = 0

            TOTALE_ISEE_ERP = 0
            TOTALE_PATRIMONIO_ISEE_ERP = 0
            LIMITE_PATRIMONIO = 0

            STRINGA_STAMPA = ""
            STRINGA_STAMPA_1 = ""
            STRINGA_STAMPA_2 = ""
            STRINGA_STAMPA_3 = ""
            STRINGA_STAMPA_4 = ""
            STRINGA_STAMPA_5 = ""
            STRINGA_STAMPA_6 = ""
            STRINGA_STAMPA_66 = ""
            STRINGA_STAMPA_7 = ""
            TIPO_ALLOGGIO = -1

            ESCLUSIONE = ""



            If par.RicavaEta(par.IfEmpty(par.AggiustaData(CType(Dom_Alloggio_ERP1.FindControl("txtDecorrenza"), TextBox).Text), Format(Now, "yyyMMdd"))) > 30 Then
                CONTRATTO_30_ANNI = True
            Else
                CONTRATTO_30_ANNI = False
            End If

            DescrizioneBandoAggiornamento = ""

            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans




            glIndice_Bando_Origine = lIndice_Bando
            par.cmd.CommandText = "select fl_rinnovo from domande_bando_vsa where id=" & lIdDomanda
            Dim myReader11 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader11.Read Then
                If par.IfNull(myReader11("fl_rinnovo"), "0") = "1" Then
                    par.cmd.CommandText = "select * from bandi_VSA where stato=1 order by id desc"
                    Dim myReader12 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader12.Read Then
                        'lIndice_Bando = par.IfNull(myReader12("id"), "-1")
                        DescrizioneBandoAggiornamento = par.IfNull(myReader12("descrizione"), "")
                    End If
                    myReader12.Close()
                End If
            End If
            myReader11.Close()




            If Fl_Integrazione = "1" Then
                par.cmd.CommandText = "select * from bandi_vsa where stato=1 order by id desc"
                Dim myReader14 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader14.Read Then
                    'lIndice_Bando = par.IfNull(myReader12("id"), "-1")
                    DescrizioneBandoAggiornamento = par.IfNull(myReader14("descrizione"), "")
                End If
                myReader14.Close()

            End If


            par.cmd.CommandText = "SELECT TASSO_RENDIMENTO FROM BANDI_vsa WHERE ID=" & lIndice_Bando
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()

            If myReader.Read() Then
                TASSO_RENDIMENTO = par.IfNull(myReader("TASSO_RENDIMENTO"), 0)
            End If
            myReader.Close()


            Dim CODICEANAGRAFICO As String = ""

            par.cmd.CommandText = "SELECT operatori.*,caf_web.descrizione as ENTE from operatori,caf_web where operatori.id_caf=caf_web.id and operatori.ID=" & Session.Item("ID_OPERATORE")
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                CODICEANAGRAFICO = par.IfNull(myReader("ente"), "") & " - " & par.IfNull(myReader("COD_ANA"), "")
            End If
            myReader.Close()



            par.cmd.CommandText = "SELECT DICHIARAZIONI_vsa.ANNO_SIT_ECONOMICA FROM DICHIARAZIONI_vsa,DOMANDE_BANDO_vsa WHERE DOMANDE_BANDO_vsa.ID=" & lIdDomanda & " AND DOMANDE_BANDO_vsa.ID_DICHIARAZIONE=DICHIARAZIONI_vsa.ID"
            Dim myReader13 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader13.Read Then
                TASSO_RENDIMENTO = par.RicavaTasso(par.IfNull(myReader13("ANNO_SIT_ECONOMICA"), 0))
            End If
            myReader13.Close()

            par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_vsa WHERE ID_DICHIARAZIONE=" & lIdDichiarazione
            myReader = par.cmd.ExecuteReader()

            'If myReader.Read() Then

            TOT_COMPONENTI = 0
            Dim VECCHI As Integer = 0
            Dim ETA_COMPONENTE As Integer = 0

            Do While myReader.Read()
                ETA_COMPONENTE = par.RicavaEta(myReader("DATA_NASCITA"))
                If ETA_COMPONENTE >= 15 Then
                    If ETA_COMPONENTE >= 18 Then
                        adulti = adulti + 1
                        If ETA_COMPONENTE > 65 Then
                            VECCHI = VECCHI + 1
                        End If
                    End If
                Else
                    MINORI = MINORI + 1
                End If

                par.cmd.CommandText = "SELECT * FROM COMP_DETRAZIONI_vsa WHERE id_COMPONENTE=" & par.IfNull(myReader("ID"), -1)
                Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                While myReader1.Read
                    DETRAZIONI = DETRAZIONI + par.IfNull(myReader1("IMPORTO"), 0)
                End While
                myReader1.Close()



                'par.cmd.CommandText = "SELECT * FROM COMP_REDDITO_vsa WHERE ID_COMPONENTE=" & par.IfNull(myReader("ID"), -1)
                'myReader1 = par.cmd.ExecuteReader()
                'While myReader1.Read
                '    REDDITO_COMPLESSIVO = REDDITO_COMPLESSIVO + par.IfNull(myReader1("REDDITO_IRPEF"), 0) + par.IfNull(myReader1("PROV_AGRARI"), 0)
                'End While
                'myReader1.Close()



                'par.cmd.CommandText = "SELECT * FROM COMP_ALTRI_REDDITI_vsa WHERE ID_COMPONENTE=" & par.IfNull(myReader("ID"), -1)
                'myReader1 = par.cmd.ExecuteReader()
                'While myReader1.Read
                '    REDDITO_COMPLESSIVO = REDDITO_COMPLESSIVO + par.IfNull(myReader1("IMPORTO"), 0)
                'End While
                'myReader1.Close()


                par.cmd.CommandText = "SELECT * FROM domande_redditi_vsa WHERE ID_COMPONENTE=" & par.IfNull(myReader("ID"), -1)
                Dim myReaderRedd As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                While myReaderRedd.Read
                    REDDITO_COMPLESSIVO = REDDITO_COMPLESSIVO + CDbl(par.IfNull(myReaderRedd("DIPENDENTE"), 0)) + CDbl(par.IfNull(myReaderRedd("PENSIONE"), 0)) + CDbl(par.IfNull(myReaderRedd("PENS_ESENTE"), 0)) + CDbl(par.IfNull(myReaderRedd("OCCASIONALI"), 0)) + CDbl(par.IfNull(myReaderRedd("AUTONOMO"), 0)) + CDbl(par.IfNull(myReaderRedd("NON_IMPONIBILI"), 0)) + CDbl(par.IfNull(myReaderRedd("DOM_AG_FAB"), 0))

                    'DIP = DIP + CDbl(par.IfNull(myReader("DIPENDENTE"), 0)) + CDbl(par.IfNull(myReader("PENSIONE"), 0)) + CDbl(par.IfNull(myReader("NON_IMPONIBILI"), 0))
                    'ALT = ALT + CDbl(par.IfNull(myReader("OCCASIONALI"), 0)) + CDbl(par.IfNull(myReader("AUTONOMO"), 0)) + CDbl(par.IfNull(myReader("DOM_AG_FAB"), 0))
                End While
                myReaderRedd.Close()


                DETRAZIONI_FRAGILE = 0
                par.cmd.CommandText = "SELECT * FROM COMP_ELENCO_SPESE_vsa WHERE ID_COMPONENTE=" & par.IfNull(myReader("ID"), -1)
                myReader1 = par.cmd.ExecuteReader()
                If myReader1.HasRows Then
                    While myReader1.Read
                        DETRAZIONI_FRAGILE = DETRAZIONI_FRAGILE + par.IfNull(myReader1("IMPORTO"), 0)
                        TOT_SPESE = TOT_SPESE + par.IfNull(myReader1("IMPORTO"), 0)

                        If DETRAZIONI_FRAGILE > 10000 Then
                            DETRAZIONI_FR = DETRAZIONI_FR + DETRAZIONI_FRAGILE
                        Else
                            DETRAZIONI_FR = DETRAZIONI_FR + 10000
                        End If

                    End While
                    myReader1.Close()
                Else
                    If par.IfNull(myReader("indennita_acc"), 0) = "1" Then
                        DETRAZIONI_FR = DETRAZIONI_FR + 10000
                        TOT_SPESE = TOT_SPESE + 10000
                    End If
                    myReader1.Close()
                End If



                par.cmd.CommandText = "SELECT * FROM COMP_PATR_MOB_vsa WHERE ID_COMPONENTE=" & par.IfNull(myReader("ID"), -1)
                myReader1 = par.cmd.ExecuteReader()
                While myReader1.Read
                    MOBILI = MOBILI + par.IfNull(myReader1("IMPORTO"), 0)
                End While
                myReader1.Close()



                par.cmd.CommandText = "SELECT * FROM COMP_PATR_IMMOB_vsa WHERE ID_COMPONENTE=" & par.IfNull(myReader("ID"), -1)
                myReader1 = par.cmd.ExecuteReader()
                While myReader1.Read
                    If par.IfNull(myReader1("F_RESIDENZA"), 0) = 1 Then
                        IMMOBILI_RESIDENZA = IMMOBILI_RESIDENZA + par.IfNull(myReader1("VALORE"), 0)
                        MUTUI_RESIDENZA = MUTUI_RESIDENZA + par.IfNull(myReader1("MUTUO"), 0)
                    Else
                        IMMOBILI = IMMOBILI + par.IfNull(myReader1("VALORE"), 0)
                        MUTUI = MUTUI + par.IfNull(myReader1("MUTUO"), 0)
                    End If
                End While
                myReader1.Close()
                TOT_COMPONENTI = TOT_COMPONENTI + 1
            Loop
            'End If
            myReader.Close()



            par.cmd.CommandText = "SELECT * FROM DICHIARAZIONI_vsa WHERE ID=" & lIdDichiarazione
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                INV_100_CON = par.IfNull(myReader("N_INV_100_CON"), 0)
                INV_100_NO = par.IfNull(myReader("N_INV_100_SENZA"), 0)
                INV_66_99 = par.IfNull(myReader("N_INV_100_66"), 0)
            End If
            myReader.Close()

            DETRAZIONI_FR = DETRAZIONI_FR + (INV_100_NO * 3000) + (INV_66_99 * 1500)



            FIGURATIVO_MOBILI = (MOBILI \ 5165) * 5165


            ISEE_ERP = REDDITO_COMPLESSIVO + ((FIGURATIVO_MOBILI * TASSO_RENDIMENTO) / 100) - DETRAZIONI - DETRAZIONI_FR
            If ISEE_ERP < 0 Then
                ISEE_ERP = 0
            End If

            ISR_ERP = ISEE_ERP

            ISEE_ERP = 0

            TOTALE_IMMOBILI = (IMMOBILI - MUTUI) + (IMMOBILI_RESIDENZA - MUTUI_RESIDENZA)

            TOTALE_ISEE_ERP = (TOTALE_IMMOBILI) * 0.20000000000000001

            ISP_ERP = TOTALE_ISEE_ERP

            TOTALE_PATRIMONIO_ISEE_ERP = (TOTALE_IMMOBILI + FIGURATIVO_MOBILI)


            Dim PARAMETRO As Double

            Select Case TOT_COMPONENTI
                Case 1
                    PARAMETRO = 1
                Case 2
                    PARAMETRO = (138 / 100)
                Case 3
                    PARAMETRO = (167 / 100)
                Case 4
                    PARAMETRO = (190 / 100)
                Case 5
                    PARAMETRO = (211 / 100)
                Case Else
                    PARAMETRO = (211 / 100) + ((TOT_COMPONENTI - 5) * (17 / 100))
            End Select

            PARAMETRO_MINORI = 0
            VSE = Format(PARAMETRO, "##,##0.00")
            If adulti >= 2 Then
                VSE = VSE - (MINORI * (1 / 10))
                PARAMETRO_MINORI = (MINORI * (1 / 10))
            End If

            LIMITE_PATRIMONIO = 16000 + (6000 * VSE)

            ISE_ERP = ISR_ERP + ISP_ERP

            ISEE_ERP = ISE_ERP / VSE

            'If ISEE_ERP <= 35000 Then
            '    TIPO_ALLOGGIO = 0
            'Else
            '    If (VECCHI = TOT_COMPONENTI Or INV_100_CON > 0 Or INV_100_NO > 0 Or INV_66_99 > 0) And CONTRATTO_30_ANNI = True Then
            '        TIPO_ALLOGGIO = 0
            '    Else
            '        ESCLUSIONE = "<li>ISEE superiore al limite ERP</li>"
            '        par.cmd.CommandText = "UPDATE DOMANDE_BANDO_vsa SET REQUISITO6='0' WHERE ID=" & lIdDomanda
            '        par.cmd.ExecuteNonQuery()

            '    End If
            'End If

            'If TOTALE_PATRIMONIO_ISEE_ERP > LIMITE_PATRIMONIO * 3 Then
            '    If (VECCHI = TOT_COMPONENTI Or INV_100_CON > 0 Or INV_100_NO > 0 Or INV_66_99 > 0) And CONTRATTO_30_ANNI = True Then

            '    Else
            '        ESCLUSIONE = ESCLUSIONE & "<li>Limite Patrimoniale superato</li>"
            '        par.cmd.CommandText = "UPDATE DOMANDE_BANDO_vsa SET REQUISITO6='0' WHERE ID=" & lIdDomanda
            '        par.cmd.ExecuteNonQuery()
            '    End If
            '    '***CasReq6.Text = "0"
            'End If


            Dim Totale_Risultati As Long
            Dim Valore
            Dim Valore1 As String = ""

            Totale_Risultati = 0

            Dim F1 As Double
            Dim F2 As Double
            Dim F3 As Double

            Dim F10 As Double
            Dim F20 As Double
            Dim F30 As Double

            F1 = 0
            F2 = 0
            F3 = 0

            F10 = 0
            F20 = 0
            F30 = 0


            If ESCLUSIONE <> "" Then
                ISEE_ERP = 0
            End If

            If ESCLUSIONE = "" Then
                If tipoRichiesta.Value <> 5 Then
                    par.cmd.CommandText = "update domande_bando_vsa set FL_CONTROLLA_REQUISITI='2',FL_ASS_ESTERNA='1',FL_COMPLETA='1',FL_RINNOVO='0'," _
                                        & "ID_VECCHIO_STATO='',ID_TIPO_CONTENZIOSO=NULL," _
                                        & "FL_ISTRUTTORIA_COMPLETA='1',ID_STATO='8'," _
                                        & "FL_ESAMINATA='1',ISE_ERP=" & par.VirgoleInPunti(ISE_ERP) _
                                        & ",ISR_ERP=" & par.VirgoleInPunti(ISR_ERP) & ",ISP_ERP=" _
                                        & par.VirgoleInPunti(ISP_ERP) & ",REDDITO_ISEE=" _
                                        & par.VirgoleInPunti(ISEE_ERP) & ", TIPO_ALLOGGIO=" _
                                        & TIPO_ALLOGGIO & ",ISBARC=" & "0" _
                                         & ",ISBAR=" & "0" & ",ISBARC_R=" _
                                        & "0" & ",DISAGIO_A=" _
                                        & "0" & ",DISAGIO_F=" _
                                        & "0" & ",DISAGIO_E=" _
                                        & "0" & ",PSE='" & PARAMETRO & "',VSE='" & VSE & "' WHERE ID=" & lIdDomanda
                    par.cmd.ExecuteNonQuery()
                Else
                    par.cmd.CommandText = "update domande_bando_vsa set FL_CONTROLLA_REQUISITI='2',FL_ASS_ESTERNA='1',FL_COMPLETA='1',FL_RINNOVO='0'," _
                           & "ID_VECCHIO_STATO='',ID_TIPO_CONTENZIOSO=NULL," _
                           & "FL_ISTRUTTORIA_COMPLETA='1',ID_STATO='4'," _
                           & "FL_ESAMINATA='1',ISE_ERP=" & par.VirgoleInPunti(ISE_ERP) _
                           & ",ISR_ERP=" & par.VirgoleInPunti(ISR_ERP) _
                           & ",ISP_ERP=" & par.VirgoleInPunti(ISP_ERP) _
                           & ",REDDITO_ISEE=" & par.VirgoleInPunti(ISEE_ERP) _
                           & ",TIPO_ALLOGGIO=" & TIPO_ALLOGGIO _
                           & ",ISBARC=" & "0" _
                           & ",ISBAR=" & "0" _
                           & ",ISBARC_R=" & "0" _
                           & ",DISAGIO_A=" & "0" _
                           & ",DISAGIO_F=" & "0" _
                           & ",DISAGIO_E=" & "0" _
                           & ",PSE='" & PARAMETRO & "',VSE='" & VSE & "' WHERE ID=" & lIdDomanda
                    par.cmd.ExecuteNonQuery()
                End If

            Else
                par.cmd.CommandText = "update domande_bando_vsa set FL_CONTROLLA_REQUISITI='2',FL_ASS_ESTERNA='1',FL_COMPLETA='1',FL_RINNOVO='0'," _
                                           & "ID_VECCHIO_STATO='',ID_TIPO_CONTENZIOSO=NULL," _
                                           & "FL_ISTRUTTORIA_COMPLETA='1',ID_STATO='4'," _
                                           & "FL_ESAMINATA='1',ISE_ERP=" & par.VirgoleInPunti(ISE_ERP) _
                                           & ",ISR_ERP=" & par.VirgoleInPunti(ISR_ERP) _
                                           & ",ISP_ERP=" & par.VirgoleInPunti(ISP_ERP) _
                                           & ",REDDITO_ISEE=" & par.VirgoleInPunti(ISEE_ERP) _
                                           & ",TIPO_ALLOGGIO=" & TIPO_ALLOGGIO _
                                           & ",ISBARC=" & "0" _
                                           & ",ISBAR=" & "0" _
                                           & ",ISBARC_R=" & "0" _
                                           & ",DISAGIO_A=" & "0" _
                                           & ",DISAGIO_F=" & "0" _
                                           & ",DISAGIO_E=" & "0" _
                                           & ",PSE='" & PARAMETRO & "',VSE='" & VSE & "' WHERE ID=" & lIdDomanda
                par.cmd.ExecuteNonQuery()
            End If

            'txtIndici.Text = "V1=0&V2=0&V3=0&V4=0&V5=0&V6=0&V7 = " & par.Converti(ISEE_ERP) & "&V8=" & par.Converti(ISR_ERP) _
            '           & "&V9=" & par.Converti(ISP_ERP) _
            '           & "&V10=" & par.Converti(ISE_ERP) _
            '           & "&V11=0" _
            '           & "&V12=" & PARAMETRO _
            '           & "&V13=" & VSE _
            '           & "&PG=" & lblPG.Text & "&UJ=3"

            par.myTrans.Commit()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)

            par.cmd.CommandText = "SELECT * FROM DOMANDE_BANDO_VSA WHERE ID=" & lIdDomanda & " FOR UPDATE NOWAIT"
            myReader = par.cmd.ExecuteReader()
            myReader.Close()

            lblISBAR.Text = par.Tronca(ISEE_ERP)
            If lblISBAR.Text = 0 Then
                ISEEnullo.Value = 1
            End If

        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        Finally

        End Try

    End Function


    Private Function CalcolaStampa()

        Dim DETRAZIONI As Long


        Dim INV_100_CON As Integer
        Dim INV_100_NO As Integer
        Dim INV_66_99 As Integer
        Dim TOT_COMPONENTI As Integer
        Dim REDDITO_COMPLESSIVO As Double
        Dim TOT_SPESE As Long
        Dim DETRAZIONI_FRAGILE As Long
        Dim DETRAZIONI_FR As Long

        Dim MOBILI As Double
        Dim TASSO_RENDIMENTO As Double
        Dim FIGURATIVO_MOBILI As Double
        Dim TOTALE_ISEE_ERP As Double
        Dim IMMOBILI As Long
        Dim MUTUI As Long
        Dim IMMOBILI_RESIDENZA As Long
        Dim MUTUI_RESIDENZA As Long
        Dim TOTALE_PATRIMONIO_ISEE_ERP As Double
        Dim TOTALE_IMMOBILI As Long
        Dim LIMITE_PATRIMONIO As Double

        Dim ISR_ERP As Double
        Dim ISP_ERP As Double
        Dim ISE_ERP As Double
        Dim VSE As Double
        Dim ISEE_ERP As Double
        Dim ESCLUSIONE As String


        Dim PARAMETRO_MINORI As Double

        Dim MINORI As Integer
        Dim adulti As Integer

        Dim STRINGA_STAMPA As String
        Dim STRINGA_STAMPA_1 As String
        Dim STRINGA_STAMPA_2 As String
        Dim STRINGA_STAMPA_3 As String
        Dim STRINGA_STAMPA_4 As String
        Dim STRINGA_STAMPA_5 As String
        Dim STRINGA_STAMPA_6 As String
        Dim STRINGA_STAMPA_66 As String
        Dim STRINGA_STAMPA_7 As String
        Dim TIPO_ALLOGGIO As Integer

        Dim Testo_Da_Scrivere As String
        Dim glIndice_Bando_Origine As Long
        Dim DescrizioneBandoAggiornamento As String
        Dim CONTRATTO_30_ANNI As Boolean = False

        Try

            MINORI = 0
            adulti = 0

            ISR_ERP = 0
            ISP_ERP = 0
            ISE_ERP = 0

            VSE = 0

            TOT_COMPONENTI = 0

            DETRAZIONI = 0
            REDDITO_COMPLESSIVO = 0
            TOT_SPESE = 0
            DETRAZIONI_FRAGILE = 0
            DETRAZIONI_FR = 0
            ISEE_ERP = 0
            MOBILI = 0
            FIGURATIVO_MOBILI = 0

            IMMOBILI = 0
            MUTUI = 0
            IMMOBILI_RESIDENZA = 0
            MUTUI_RESIDENZA = 0
            TOTALE_IMMOBILI = 0

            TOTALE_ISEE_ERP = 0
            TOTALE_PATRIMONIO_ISEE_ERP = 0
            LIMITE_PATRIMONIO = 0

            STRINGA_STAMPA = ""
            STRINGA_STAMPA_1 = ""
            STRINGA_STAMPA_2 = ""
            STRINGA_STAMPA_3 = ""
            STRINGA_STAMPA_4 = ""
            STRINGA_STAMPA_5 = ""
            STRINGA_STAMPA_6 = ""
            STRINGA_STAMPA_66 = ""
            STRINGA_STAMPA_7 = ""
            TIPO_ALLOGGIO = -1

            ESCLUSIONE = ""



            If par.RicavaEta(par.IfEmpty(par.AggiustaData(CType(Dom_Alloggio_ERP1.FindControl("txtDecorrenza"), TextBox).Text), Format(Now, "yyyMMdd"))) > 30 Then
                CONTRATTO_30_ANNI = True
            Else
                CONTRATTO_30_ANNI = False
            End If

            DescrizioneBandoAggiornamento = ""

            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans




            glIndice_Bando_Origine = lIndice_Bando
            par.cmd.CommandText = "select fl_rinnovo from domande_bando_vsa where id=" & lIdDomanda
            Dim myReader11 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader11.Read Then
                If par.IfNull(myReader11("fl_rinnovo"), "0") = "1" Then
                    par.cmd.CommandText = "select * from bandi_VSA where stato=1 order by id desc"
                    Dim myReader12 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader12.Read Then
                        'lIndice_Bando = par.IfNull(myReader12("id"), "-1")
                        DescrizioneBandoAggiornamento = par.IfNull(myReader12("descrizione"), "")
                    End If
                    myReader12.Close()
                End If
            End If
            myReader11.Close()




            If Fl_Integrazione = "1" Then
                par.cmd.CommandText = "select * from bandi_vsa where stato=1 order by id desc"
                Dim myReader14 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader14.Read Then
                    'lIndice_Bando = par.IfNull(myReader12("id"), "-1")
                    DescrizioneBandoAggiornamento = par.IfNull(myReader14("descrizione"), "")
                End If
                myReader14.Close()

            End If


            par.cmd.CommandText = "SELECT TASSO_RENDIMENTO FROM BANDI_vsa WHERE ID=" & lIndice_Bando
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()

            If myReader.Read() Then
                TASSO_RENDIMENTO = par.IfNull(myReader("TASSO_RENDIMENTO"), 0)
            End If
            myReader.Close()


            Dim CODICEANAGRAFICO As String = ""

            par.cmd.CommandText = "SELECT operatori.*,caf_web.descrizione as ENTE from operatori,caf_web where operatori.id_caf=caf_web.id and operatori.ID=" & Session.Item("ID_OPERATORE")
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                CODICEANAGRAFICO = par.IfNull(myReader("ente"), "") & " - " & par.IfNull(myReader("COD_ANA"), "")
            End If
            myReader.Close()


            'MODIFICA MTERESA 15/02/2012
            par.cmd.CommandText = "SELECT * FROM DICHIARAZIONI_vsa,DOMANDE_BANDO_vsa WHERE DOMANDE_BANDO_vsa.ID=" & lIdDomanda & " AND DOMANDE_BANDO_vsa.ID_DICHIARAZIONE=DICHIARAZIONI_vsa.ID"
            Dim da As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            Dim dt As New Data.DataTable
            da.Fill(dt)
            da.Dispose()

            'Dim myReader13 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            'If myReader13.Read Then
            TASSO_RENDIMENTO = par.RicavaTasso(par.IfNull(dt.Rows(0).Item("ANNO_SIT_ECONOMICA"), 0))
            'End If
            'myReader13.Close()

            par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_vsa WHERE ID_DICHIARAZIONE=" & lIdDichiarazione
            myReader = par.cmd.ExecuteReader()

            'If myReader.Read() Then

            TOT_COMPONENTI = 0
            Dim VECCHI As Integer = 0
            Dim ETA_COMPONENTE As Integer = 0

            Do While myReader.Read()
                ETA_COMPONENTE = par.RicavaEta(par.IfNull(myReader("DATA_NASCITA"), ""))
                If ETA_COMPONENTE >= 15 Then
                    If ETA_COMPONENTE >= 18 Then
                        adulti = adulti + 1
                        If ETA_COMPONENTE > 65 Then
                            VECCHI = VECCHI + 1
                        End If
                    End If
                Else
                    MINORI = MINORI + 1
                End If

                par.cmd.CommandText = "SELECT * FROM COMP_DETRAZIONI_vsa WHERE id_COMPONENTE=" & par.IfNull(myReader("ID"), -1)
                Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                While myReader1.Read
                    DETRAZIONI = DETRAZIONI + par.IfNull(myReader1("IMPORTO"), 0)
                End While
                myReader1.Close()



                'par.cmd.CommandText = "SELECT * FROM COMP_REDDITO_vsa WHERE ID_COMPONENTE=" & par.IfNull(myReader("ID"), -1)
                'myReader1 = par.cmd.ExecuteReader()
                'While myReader1.Read
                '    REDDITO_COMPLESSIVO = REDDITO_COMPLESSIVO + par.IfNull(myReader1("REDDITO_IRPEF"), 0) + par.IfNull(myReader1("PROV_AGRARI"), 0)
                'End While
                'myReader1.Close()



                'par.cmd.CommandText = "SELECT * FROM COMP_ALTRI_REDDITI_vsa WHERE ID_COMPONENTE=" & par.IfNull(myReader("ID"), -1)
                'myReader1 = par.cmd.ExecuteReader()
                'While myReader1.Read
                '    REDDITO_COMPLESSIVO = REDDITO_COMPLESSIVO + par.IfNull(myReader1("IMPORTO"), 0)
                'End While
                'myReader1.Close()

                par.cmd.CommandText = "SELECT * FROM domande_redditi_vsa WHERE ID_COMPONENTE=" & par.IfNull(myReader("ID"), -1)
                Dim myReaderRedd As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                While myReaderRedd.Read
                    REDDITO_COMPLESSIVO = REDDITO_COMPLESSIVO + CDbl(par.IfNull(myReaderRedd("DIPENDENTE"), 0)) + CDbl(par.IfNull(myReaderRedd("PENSIONE"), 0)) + CDbl(par.IfNull(myReaderRedd("PENS_ESENTE"), 0)) + CDbl(par.IfNull(myReaderRedd("OCCASIONALI"), 0)) + CDbl(par.IfNull(myReaderRedd("AUTONOMO"), 0)) + CDbl(par.IfNull(myReaderRedd("NON_IMPONIBILI"), 0)) + CDbl(par.IfNull(myReaderRedd("DOM_AG_FAB"), 0))

                    'DIP = DIP + CDbl(par.IfNull(myReader("DIPENDENTE"), 0)) + CDbl(par.IfNull(myReader("PENSIONE"), 0)) + CDbl(par.IfNull(myReader("NON_IMPONIBILI"), 0))
                    'ALT = ALT + CDbl(par.IfNull(myReader("OCCASIONALI"), 0)) + CDbl(par.IfNull(myReader("AUTONOMO"), 0)) + CDbl(par.IfNull(myReader("DOM_AG_FAB"), 0))
                End While
                myReaderRedd.Close()


                DETRAZIONI_FRAGILE = 0
                par.cmd.CommandText = "SELECT * FROM COMP_ELENCO_SPESE_vsa WHERE ID_COMPONENTE=" & par.IfNull(myReader("ID"), -1)
                myReader1 = par.cmd.ExecuteReader()
                If myReader1.HasRows Then
                    While myReader1.Read
                        DETRAZIONI_FRAGILE = DETRAZIONI_FRAGILE + par.IfNull(myReader1("IMPORTO"), 0)
                        TOT_SPESE = TOT_SPESE + par.IfNull(myReader1("IMPORTO"), 0)

                        If DETRAZIONI_FRAGILE > 10000 Then
                            DETRAZIONI_FR = DETRAZIONI_FR + DETRAZIONI_FRAGILE
                        Else
                            DETRAZIONI_FR = DETRAZIONI_FR + 10000
                        End If

                    End While
                    myReader1.Close()
                Else
                    If par.IfNull(myReader("indennita_acc"), 0) = "1" Then
                        DETRAZIONI_FR = DETRAZIONI_FR + 10000
                        TOT_SPESE = TOT_SPESE + 10000
                    End If
                    myReader1.Close()
                End If



                par.cmd.CommandText = "SELECT * FROM COMP_PATR_MOB_vsa WHERE ID_COMPONENTE=" & par.IfNull(myReader("ID"), -1)
                myReader1 = par.cmd.ExecuteReader()
                While myReader1.Read
                    MOBILI = MOBILI + par.IfNull(myReader1("IMPORTO"), 0)
                End While
                myReader1.Close()



                par.cmd.CommandText = "SELECT * FROM COMP_PATR_IMMOB_vsa WHERE ID_COMPONENTE=" & par.IfNull(myReader("ID"), -1)
                myReader1 = par.cmd.ExecuteReader()
                While myReader1.Read
                    If par.IfNull(myReader1("F_RESIDENZA"), 0) = 1 Then
                        IMMOBILI_RESIDENZA = IMMOBILI_RESIDENZA + par.IfNull(myReader1("VALORE"), 0)
                        MUTUI_RESIDENZA = MUTUI_RESIDENZA + par.IfNull(myReader1("MUTUO"), 0)
                    Else
                        IMMOBILI = IMMOBILI + par.IfNull(myReader1("VALORE"), 0)
                        MUTUI = MUTUI + par.IfNull(myReader1("MUTUO"), 0)
                    End If
                End While
                myReader1.Close()
                TOT_COMPONENTI = TOT_COMPONENTI + 1
            Loop
            'End If
            myReader.Close()



            par.cmd.CommandText = "SELECT * FROM DICHIARAZIONI_vsa WHERE ID=" & lIdDichiarazione
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                INV_100_CON = par.IfNull(myReader("N_INV_100_CON"), 0)
                INV_100_NO = par.IfNull(myReader("N_INV_100_SENZA"), 0)
                INV_66_99 = par.IfNull(myReader("N_INV_100_66"), 0)
            End If
            myReader.Close()

            DETRAZIONI_FR = DETRAZIONI_FR + (INV_100_NO * 3000) + (INV_66_99 * 1500)



            If REDDITO_COMPLESSIVO <> 0 Then
                STRINGA_STAMPA = STRINGA_STAMPA & "<tr>" _
                             & "<td width='80%' height='23'> REDDITO COMPLESSIVO DEL NUCLEO FAMILIARE" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>" & par.Converti(Format(REDDITO_COMPLESSIVO, "##,##0.00")) _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            Else
                STRINGA_STAMPA = STRINGA_STAMPA & "<tr>" _
                             & "<td width='80%' height='23'> Entrate nessun reddito indicato" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>" & par.Converti(Format(REDDITO_COMPLESSIVO, "##,##0.00")) _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If

            FIGURATIVO_MOBILI = (MOBILI \ 5165) * 5165

            If FIGURATIVO_MOBILI > 0 Then
                STRINGA_STAMPA = STRINGA_STAMPA & "<tr>" _
                             & "<td width='80%' height='23'> FIGURATIVO REDDITO MOBILIARE" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>" & par.Converti(Format(((FIGURATIVO_MOBILI * TASSO_RENDIMENTO) / 100), "##,##0.00")) _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If

            If DETRAZIONI <> 0 Then
                STRINGA_STAMPA = STRINGA_STAMPA & "<tr>" _
                             & "<td width='80%' height='23'> DETRAZIONI DAL REDDITO LORDO" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>- " & par.Converti(Format(DETRAZIONI, "##,##0.00")) _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            Else
                STRINGA_STAMPA = STRINGA_STAMPA & "<tr>" _
                             & "<td width='80%' height='23'> Non ci sono detrazioni" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>0 " _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If



            If INV_100_CON > 0 Then
                STRINGA_STAMPA = STRINGA_STAMPA & "<tr>" _
                             & "<td width='80%' height='23'> INVALIDI 100% CON INDENNITA'" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>" & INV_100_CON _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If

            If TOT_SPESE > 0 Then
                STRINGA_STAMPA = STRINGA_STAMPA & "<tr>" _
                             & "<td width='80%' height='23'> SPESE SOSTENUTE PER ASSISTENZA" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>" & par.Converti(Format(TOT_SPESE, "##,##0.00")) _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If

            If INV_100_NO > 0 Then
                STRINGA_STAMPA = STRINGA_STAMPA & "<tr>" _
                             & "<td width='80%' height='23'> INVALIDI 100% SENZA INDENNITA'" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>" & INV_100_NO _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If

            If INV_66_99 > 0 Then
                STRINGA_STAMPA = STRINGA_STAMPA & "<tr>" _
                             & "<td width='80%' height='23'> INVALIDI 66%-99%" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>" & INV_66_99 _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If

            If DETRAZIONI_FR > 0 Then
                STRINGA_STAMPA = STRINGA_STAMPA & "<tr>" _
                             & "<td width='80%' height='23'> Detrazioni per nucleo familiare affetto da fragilità (" & INV_100_CON + INV_100_NO + INV_66_99 & " invalidi)" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>-" & par.Converti(Format(DETRAZIONI_FR, "##,##0.00")) _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If



            ISEE_ERP = REDDITO_COMPLESSIVO + ((FIGURATIVO_MOBILI * TASSO_RENDIMENTO) / 100) - DETRAZIONI - DETRAZIONI_FR
            If ISEE_ERP < 0 Then
                ISEE_ERP = 0
            End If

            ISR_ERP = ISEE_ERP

            ISEE_ERP = 0
            STRINGA_STAMPA = STRINGA_STAMPA & "<tr>" _
                         & "<td width='80%' height='23'> TOTALE DEL REDDITO DA CONSIDERARE AI FINI ISEE-erp" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>" & par.Converti(Format(ISR_ERP, "##,##0.00")) _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"


            If FIGURATIVO_MOBILI > 0 Then
                STRINGA_STAMPA_1 = STRINGA_STAMPA_1 & "<tr>" _
                             & "<td width='80%' height='23'>CONSISTENZA DEL PATRIMONIO MOBILIARE" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>" & par.Converti(Format(FIGURATIVO_MOBILI, "##,##0.00")) _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If


            If IMMOBILI > 0 Then
                STRINGA_STAMPA_1 = STRINGA_STAMPA_1 & "<tr>" _
                             & "<td width='80%' height='23'>CONSISTENZA DEL PATRIMONIO IMMOBILIARE" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>" & par.Converti(Format(IMMOBILI, "##,##0.00")) _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If

            If MUTUI > 0 Then
                STRINGA_STAMPA_1 = STRINGA_STAMPA_1 & "<tr>" _
                             & "<td width='80%' height='23'>DETRAZIONI PER MUTUI CONTRATTI" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>-" & par.Converti(Format(MUTUI, "##,##0.00")) _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If

            STRINGA_STAMPA_1 = STRINGA_STAMPA_1 & "<tr>" _
                         & "<td width='80%' height='23'>TOTALE CONSISTENZA DEL PATRIMONIO IMMOBILIARE" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>" & par.Converti(Format(IMMOBILI - MUTUI, "##,##0.00")) _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"

            If IMMOBILI_RESIDENZA > 0 Then
                STRINGA_STAMPA_1 = STRINGA_STAMPA_1 & "<tr>" _
                             & "<td width='80%' height='23'>VALORE DELLA RESIDENZA DI PROPRIETA'" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>" & par.Converti(Format(IMMOBILI_RESIDENZA, "##,##0.00")) _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If

            If MUTUI_RESIDENZA > 0 Then
                STRINGA_STAMPA_1 = STRINGA_STAMPA_1 & "<tr>" _
                             & "<td width='80%' height='23'>MUTUO RESIDUO PER LA RESIDENZA" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>" & par.Converti(Format(MUTUI_RESIDENZA, "##,##0.00")) _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If

            If IMMOBILI_RESIDENZA > 0 Then
                STRINGA_STAMPA_1 = STRINGA_STAMPA_1 & "<tr>" _
                             & "<td width='80%' height='23'>VALORE NETTO DELLA CASA DI RESIDENZA" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>" & par.Converti(Format(IMMOBILI_RESIDENZA - MUTUI_RESIDENZA, "##,##0.00")) _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If

            TOTALE_IMMOBILI = (IMMOBILI - MUTUI) + (IMMOBILI_RESIDENZA - MUTUI_RESIDENZA)

            STRINGA_STAMPA_1 = STRINGA_STAMPA_1 & "<tr>" _
                         & "<td width='80%' height='23'>TOTALE COMPLESSIVO DEL PATRIMONIO AI FINI ISEE-erp" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>" & par.Converti(Format(TOTALE_IMMOBILI, "##,##0.00")) _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"


            STRINGA_STAMPA_1 = STRINGA_STAMPA_1 & "<tr>" _
                         & "<td width='80%' height='23'>Coefficiente della valutazione del patrimonio immobiliare" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>0,20" _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"


            TOTALE_ISEE_ERP = (TOTALE_IMMOBILI) * 0.20000000000000001

            ISP_ERP = TOTALE_ISEE_ERP

            STRINGA_STAMPA_1 = STRINGA_STAMPA_1 & "<tr>" _
                         & "<td width='80%' height='23'>VALUTAZIONE DEL PATRIMONIO AI FINI ISEE-erp" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>" & par.Converti(Format(TOTALE_ISEE_ERP, "##,##0.00")) _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"


            TOTALE_PATRIMONIO_ISEE_ERP = (TOTALE_IMMOBILI + FIGURATIVO_MOBILI)
            STRINGA_STAMPA_1 = STRINGA_STAMPA_1 & "<tr>" _
                         & "<td width='80%' height='23'>PATRIMONIO COMPLESSIVO AI FINI ERP" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='5%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>" & par.Converti(Format(TOTALE_PATRIMONIO_ISEE_ERP, "##,##0.00")) _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"

            Dim PARAMETRO As Double

            Select Case TOT_COMPONENTI
                Case 1
                    PARAMETRO = 1
                Case 2
                    PARAMETRO = (138 / 100)
                Case 3
                    PARAMETRO = (167 / 100)
                Case 4
                    PARAMETRO = (190 / 100)
                Case 5
                    PARAMETRO = (211 / 100)
                Case Else
                    PARAMETRO = (211 / 100) + ((TOT_COMPONENTI - 5) * (17 / 100))
            End Select

            PARAMETRO_MINORI = 0
            VSE = PARAMETRO
            If adulti >= 2 Then
                VSE = VSE - (MINORI * (1 / 10))
                PARAMETRO_MINORI = (MINORI * (1 / 10))
            End If




            LIMITE_PATRIMONIO = 16000 + (6000 * VSE)

            If TOTALE_PATRIMONIO_ISEE_ERP > LIMITE_PATRIMONIO * 3 Then
                STRINGA_STAMPA_1 = STRINGA_STAMPA_1 & "<tr>" _
                             & "<td width='80%' height='23'>Limite Patrimonio Familiare" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>" & par.Converti(Format(LIMITE_PATRIMONIO, "##,##0.00")) _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"

            End If


            STRINGA_STAMPA_2 = STRINGA_STAMPA_2 & "<tr>" _
                         & "<td width='80%' height='23'>Numero di componenti del nucleo familiare" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>" & TOT_COMPONENTI _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"



            STRINGA_STAMPA_2 = STRINGA_STAMPA_2 & "<tr>" _
                         & "<td width='80%' height='23'>Parametro corrispondente alla composizione del nucleo familiare" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>" & par.Converti(Format(PARAMETRO, "##,##0.00")) _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"

            'If MINORI > 0 Then
            STRINGA_STAMPA_2 = STRINGA_STAMPA_2 & "<tr>" _
                         & "<td width='80%' height='23'>Numero di minori di 15 anni nel nucleo familiare" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>" & MINORI _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"


            If PARAMETRO_MINORI > 0 Then
                STRINGA_STAMPA_2 = STRINGA_STAMPA_2 & "<tr>" _
                             & "<td width='80%' height='23'>- Parametro per minori" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>-" & par.Converti(Format(PARAMETRO_MINORI, "##,##0.00")) _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If


            If adulti >= 1 Then
                STRINGA_STAMPA_2 = STRINGA_STAMPA_2 & "<tr>" _
                             & "<td width='80%' height='23'>Numero di adulti nel nucleo familiare" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>" & adulti _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            Else
                STRINGA_STAMPA_2 = STRINGA_STAMPA_2 & "<tr>" _
                             & "<td width='80%' height='23'>Non ci sono adulti nel nucleo familiare" _
                             & "</td>" _
                             & "" _
                             & "" _
                             & "<td width='13%' height='23'>" _
                             & "<table border='1' width='100%'>" _
                             & "<tr>" _
                             & "<td width='100%' align='right'>0" _
                             & "</td>" _
                             & "</tr>" _
                             & "</table>      </td>   </tr>"
            End If

            STRINGA_STAMPA_2 = STRINGA_STAMPA_2 & "<tr>" _
                         & "<td width='80%' height='23'>REDDITO DA CONSIDERARE AI FINI ISEE-erp" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>" & par.Converti(Format(ISR_ERP, "##,##0.00")) _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"

            STRINGA_STAMPA_2 = STRINGA_STAMPA_2 & "<tr>" _
                         & "<td width='80%' height='23'>VALUTAZIONE DEL PATRIMONIO AI FINI ISEE-erp" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>" & par.Converti(Format(ISP_ERP, "##,##0.00")) _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"

            ISE_ERP = ISR_ERP + ISP_ERP

            STRINGA_STAMPA_2 = STRINGA_STAMPA_2 & "<tr>" _
                         & "<td width='80%' height='23'>ISE-erp: indicatore della situazione economica (erp)" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>" & par.Converti(Format(ISE_ERP, "##,##0.00")) _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"


            STRINGA_STAMPA_2 = STRINGA_STAMPA_2 & "<tr>" _
                         & "<td width='80%' height='23'>VSE: Valore della scala di equivalenza" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>" & par.Converti(Format(VSE, "##,##0.00")) _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"



            ISEE_ERP = ISE_ERP / VSE

            'If ISEE_ERP <= 35000 Then
            '    TIPO_ALLOGGIO = 0
            'Else
            '    If (VECCHI = TOT_COMPONENTI Or INV_100_CON > 0 Or INV_100_NO > 0 Or INV_66_99 > 0) And CONTRATTO_30_ANNI = True Then
            '        TIPO_ALLOGGIO = 0
            '    Else
            '        ESCLUSIONE = "<li>ISEE superiore al limite ERP</li>"
            '        par.cmd.CommandText = "UPDATE DOMANDE_BANDO_vsa SET REQUISITO6='0' WHERE ID=" & lIdDomanda
            '        par.cmd.ExecuteNonQuery()

            '    End If
            'End If

            'If UCase(CType(Dom_Alloggio_ERP1.FindControl("txtCOMUNE"), TextBox).Text) <> "MILANO" Then
            '    ESCLUSIONE = ESCLUSIONE & "<li>Alloggio non situato a Milano</li>"
            'End If

            'If TOTALE_PATRIMONIO_ISEE_ERP > LIMITE_PATRIMONIO * 3 Then
            '    If (VECCHI = TOT_COMPONENTI Or INV_100_CON > 0 Or INV_100_NO > 0 Or INV_66_99 > 0) And CONTRATTO_30_ANNI = True Then

            '    Else
            '        ESCLUSIONE = ESCLUSIONE & "<li>Limite Patrimoniale superato</li>"
            '        par.cmd.CommandText = "UPDATE DOMANDE_BANDO_vsa SET REQUISITO6='0' WHERE ID=" & lIdDomanda
            '        par.cmd.ExecuteNonQuery()
            '    End If
            '    '***CasReq6.Text = "0"
            'End If


            Dim req1 As String
            Dim req2 As String
            Dim req3 As String
            Dim req4 As String
            Dim req5 As String
            Dim req6 As String
            Dim req7 As String

            Dim req8 As String
            Dim req9 As String
            Dim req10 As String
            Dim req11 As String
            Dim req12 As String
            Dim req13 As String
            Dim req14 As String
            Dim req15 As String
            Dim req16 As String
            Dim req17 As String

            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR1"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Mancanza della cittadinanza o del permesso di soggiorno</li>"
                req1 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req1 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If
            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR2"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Mancanza Requisiti Art. 22</li>"
            End If
            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR3"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Predecente Assegnazione in proprietà</li>"
                req2 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req2 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If
            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR4"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Decadenza</li>"
                req3 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req3 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If
            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR5"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Cessione</li>"
                req4 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req4 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If
            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR6"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>posesso di U.I. adeguata al nucleo e/o di valore (RR 1/2004 Art.18 lett. f e g) o entro 70 km</li>"
                req5 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req5 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If
            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR7"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Morosità da alloggio ERP negli ultimi 5 anni</li>"
                req6 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req6 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If
            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR8"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Occupazione abusiva negli ultimi 5 anni</li>"
                req7 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req7 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If


            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR9"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Inutilizzo dell'alloggio</li>"
                req8 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req8 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If

            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR10"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Cambio destinazione d'uso</li>"
                req9 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req9 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If

            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR11"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Gravi danni</li>"
                req10 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req10 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If

            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR12"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Utilizzo per attività illecite</li>"
                req11 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req11 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If

            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR13"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Inadempimento a seguito di diffida</li>"
                req12 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req12 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If

            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR14"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Inadempimento art. 20-21 RR 1/2004</li>"
                req13 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req13 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If

            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR15"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Valore immobile superiore al limite</li>"
                req14 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req14 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If

            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR16"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Durata Convivenza inferiore al limite</li>"
                req15 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req15 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If

            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR17"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Convivenza non motivata da carattere assistenziale</li>"
                req16 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req16 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If

            If Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR18"), CheckBox).Checked) = "0" Then
                ESCLUSIONE = ESCLUSIONE & "<li>Forte sovraffollamento</li>"
                req17 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                req17 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If

            If ESCLUSIONE <> "" Then
                Testo_Da_Scrivere = "<b>DOMANDA NON IDONEA</b>"
            End If

            STRINGA_STAMPA_2 = STRINGA_STAMPA_2 & "<tr>" _
                         & "<td width='75%' height='23'><b>ISEE-erp:</b> Indicatore della Situazione Economica Equivalente (erp)" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'><b>" & par.Converti(Format(ISEE_ERP, "##,##0.00")) _
                         & "</b></td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"



            If TIPO_ALLOGGIO = 0 Then
                STRINGA_STAMPA_3 = STRINGA_STAMPA_3 & "<tr>" _
                         & "<td width='75%' height='23'>ISEE intermedio per canone sociale" _
                         & "</td>" _
                         & "" _
                         & "" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>35.000,00" _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"

            End If

            If TIPO_ALLOGGIO = 1 Then
                STRINGA_STAMPA_3 = STRINGA_STAMPA_3 & "<tr>" _
                         & "<td width='75%' height='23'>ISEE intermedio per canone sociale" _
                         & "</td>" _
                         & "<td width='13%' height='23'>" _
                         & "</td>" _
                         & "<td width='13%' height='23'>" _
                         & "<table border='1' width='100%'>" _
                         & "<tr>" _
                         & "<td width='100%' align='right'>17.000,00" _
                         & "</td>" _
                         & "</tr>" _
                         & "</table>      </td>   </tr>"
            End If

            Dim Totale_Risultati As Long
            Dim Valore
            Dim Valore1 As String = ""

            Totale_Risultati = 0

            Dim F1 As Double
            Dim F2 As Double
            Dim F3 As Double

            Dim F10 As Double
            Dim F20 As Double
            Dim F30 As Double

            F1 = 0
            F2 = 0
            F3 = 0

            F10 = 0
            F20 = 0
            F30 = 0


            If ESCLUSIONE <> "" Then
                STRINGA_STAMPA_7 = "<p><b>LA DOMANDA NON PUO' ESSERE ACCOLTA PER I SEGUENTI MOTIVI:</b></p>" _
                                 & "<ul>" _
                                 & ESCLUSIONE _
                                 & "</ul>"

                'cmbAccolta.Visible = False
                'Label13.Visible = False
            Else
                If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value <> 4 Then
                    '    cmbAccolta.Visible = True
                    '    Label13.Visible = True
                    'Else
                    '    cmbAccolta.Visible = False
                    '    Label13.Visible = False
                End If


            End If


            '***INIZIO STAMPA

            Dim DATI_ANAGRAFICI As String
            Dim sa1 As String
            'Dim sA2 As String
            Dim sA3 As String
            'Dim sA4 As String
            'Dim k1 As String
            Dim i1 As String
            Dim i2 As String
            Dim m1 As String
            Dim m2 As String
            Dim sc1 As String = ""
            Dim sc2 As String = ""
            Dim sc3 As String = ""
            Dim sc4 As String = ""
            Dim sc5 As String = ""
            Dim sc6 As String = ""
            Dim sc7 As String = ""
            Dim i1a As String = ""
            Dim i1b As String = ""
            Dim i1c As String = ""
            Dim i2a As String = ""
            Dim i2b As String = ""
            Dim i2c As String = ""
            Dim i2d As String = ""
            Dim i3a As String = ""
            Dim i3b As String = ""
            Dim i3c As String = ""
            Dim i3d As String = ""
            Dim i3e As String = ""
            Dim i4a As String = ""
            Dim i4b As String = ""
            Dim i4c As String = ""
            Dim i5a As String = ""
            Dim i5b As String = ""
            Dim i5c As String = ""
            Dim i5d As String = ""
            Dim i6a As String = ""
            Dim i6b As String = ""
            Dim i6c As String = ""
            Dim i7a As String = ""
            Dim i7b As String = ""
            Dim i7c As String = ""
            Dim i8a1 As String = ""
            Dim i8a2 As String = ""
            Dim i8b As String = ""
            Dim i8c As String = ""
            Dim i8d As String = ""


            Dim i8e As String = ""
            Dim i9a As String = ""
            Dim i9b As String = ""
            Dim i9c As String = ""
            Dim i9d As String = ""
            Dim i10a As String = ""
            Dim i10b As String = ""
            Dim i10c As String = ""
            Dim i11a As String = ""
            Dim i11b As String = ""
            Dim i11c As String = ""
            Dim i12a As String = ""
            Dim i12b As String = ""
            Dim i12c As String = ""
            Dim i13a As String = ""
            Dim i13b As String = ""
            Dim i14a As String = ""
            Dim i14b As String = ""
            Dim i15a As String = ""
            Dim i15b As String = ""
            Dim i16a As String = ""
            Dim i16b As String = ""

            Dim protocollo As String

            Dim SITUAZIONE_REDDITUALE As String
            Dim SITUAZIONE_PATRIMONIALE As String

            Dim sISEE_ERP As String
            Dim RISULTATI_INTERMEDI As String
            Dim sISBARC_R As String
            Dim sISBARC As String
            'Dim testo As String
            Dim Motivo As String

            Dim pg_dichiarazione As String

            Dim DATA_PRESENTA_DICH As String = ""
            Dim LUOGO_PRESENTA_DICH As String = ""
            Dim DATA_STAMPA As String = ""
            Dim ID_DOMANDA As String
            Dim DATA_STAMPA_DOMANDA As String = ""
            Dim PUNTEGGI_INTERMEDI As String = ""
            Dim sISBAR As String


            DATI_ANAGRAFICI = ""

            If CType(Me.Page.FindControl("cmbNazioneNas"), DropDownList).SelectedItem.Text = "ITALIA" Then
                DATI_ANAGRAFICI = "Il/La Sottoscritto/a " & CType(Me.Page.FindControl("txtCognome"), TextBox).Text & " " _
                                & "" & CType(Me.Page.FindControl("txtNome"), TextBox).Text & "<BR>" _
                                & "sesso " & CType(Me.Page.FindControl("cmbSesso"), DropDownList).SelectedItem.Text & ", codice fiscale " & CType(Me.Page.FindControl("txtCF"), TextBox).Text _
                                & " , nato/a il " & CType(Me.Page.FindControl("txtDataNascita"), TextBox).Text & "" _
                                & "<BR>" _
                                & "comune di " & CType(Me.Page.FindControl("cmbComuneNas"), DropDownList).SelectedItem.Text & " , provincia di " & CType(Me.Page.FindControl("cmbPrNas"), DropDownList).SelectedItem.Text _
                                & "<BR>"

            Else
                DATI_ANAGRAFICI = "Il/La Sottoscritto/a " & CType(Me.Page.FindControl("txtCognome"), TextBox).Text & " " _
                                & "" & CType(Me.Page.FindControl("txtNome"), TextBox).Text & "<BR>" _
                                & "sesso " & CType(Me.Page.FindControl("cmbSesso"), DropDownList).SelectedItem.Text & ", codice fiscale " & CType(Me.Page.FindControl("txtCF"), TextBox).Text _
                                & " , nato/a il " & CType(Me.Page.FindControl("txtDataNascita"), TextBox).Text & "" _
                                & "<BR>" _
                                & "Stato Estero " & CType(Me.Page.FindControl("cmbNazioneNas"), DropDownList).SelectedItem.Text _
                                & "<BR>"

            End If

            If CType(Me.Page.FindControl("cmbNazioneRes"), DropDownList).SelectedItem.Text = "ITALIA" Then
                DATI_ANAGRAFICI = DATI_ANAGRAFICI _
                & "e residente nel comune di " & CType(Me.Page.FindControl("cmbComuneRes"), DropDownList).SelectedItem.Text & " , provincia di " & CType(Me.Page.FindControl("cmbPrRes"), DropDownList).SelectedItem.Text & " , cap " & CType(Me.Page.FindControl("txtCAPRes"), TextBox).Text & "<BR>" _
                & "indirizzo " & CType(Me.Page.FindControl("cmbTipoIRes"), DropDownList).SelectedItem.Text & " " & CType(Me.Page.FindControl("txtIndRes"), TextBox).Text & " , n. civico " & CType(Me.Page.FindControl("txtCivicoRes"), TextBox).Text & " , n. telefono " & CType(Me.Page.FindControl("txtTelRes"), TextBox).Text & "<BR>"
            Else
                DATI_ANAGRAFICI = DATI_ANAGRAFICI _
                & "e residente nello stato " & CType(Me.Page.FindControl("cmbNazioneRes"), DropDownList).SelectedItem.Text & " , cap " & CType(Me.Page.FindControl("txtCAPRes"), TextBox).Text & "<BR>" _
                & "indirizzo " & CType(Me.Page.FindControl("cmbTipoIRes"), DropDownList).SelectedItem.Text & " " & CType(Me.Page.FindControl("txtIndRes"), TextBox).Text & " , n. civico " & CType(Me.Page.FindControl("txtCivicoRes"), TextBox).Text & " , n. telefono " & CType(Me.Page.FindControl("txtTelRes"), TextBox).Text & "<BR>"
            End If

            'protocollo = lblSPG.Text & "-" & lblPG.Text & "-" & Label7.Text
            protocollo = lblPG.Text '& "-" & Label7.Text

            pg_dichiarazione = lblPGDic.Text

            par.cmd.CommandText = "SELECT * FROM DICHIARAZIONI_vsa WHERE id='" & lIdDichiarazione & "'"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                LUOGO_PRESENTA_DICH = par.IfNull(myReader("LUOGO"), "")
                DATA_PRESENTA_DICH = par.FormattaData(par.IfNull(myReader("DATA"), ""))

            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * FROM EVENTI_DICHIARAZIONI_vsa WHERE ID_PRATICA=" & lIdDichiarazione & " AND COD_EVENTO='F132' order by data_ora desc"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                DATA_STAMPA = par.FormattaData(Mid(par.IfNull(myReader("DATA_ORA"), ""), 1, 8))

            End If
            myReader.Close()

            Dim DATI_BANDO As String = ""
            par.cmd.CommandText = "SELECT * FROM BANDI_vsa WHERE ID=" & glIndice_Bando_Origine
            myReader = par.cmd.ExecuteReader()
            If myReader.Read() Then
                DATI_BANDO = par.IfNull(myReader("DESCRIZIONE"), "")
            End If
            myReader.Close()

            If Fl_Integrazione = "1" Then
                DATI_BANDO = DATI_BANDO & " / <b>Aggiornamento del " & Format(Now, "dd/MM/yyyy") & "  - " & DescrizioneBandoAggiornamento & "</b>"
            End If

            ID_DOMANDA = protocollo & " del " & txtDataPG.Text
            DATA_STAMPA_DOMANDA = Format(Now, "dd/MM/yyyy")

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbFattaAU"), DropDownList).SelectedItem.Value = 0 Then
                sa1 = "<img src=block.gif width=10 height=10 border=1>"
            Else
                sa1 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End If



            SITUAZIONE_REDDITUALE = STRINGA_STAMPA
            SITUAZIONE_PATRIMONIALE = STRINGA_STAMPA_1
            sISEE_ERP = STRINGA_STAMPA_2
            RISULTATI_INTERMEDI = STRINGA_STAMPA_3
            PUNTEGGI_INTERMEDI = STRINGA_STAMPA_4
            sISBAR = STRINGA_STAMPA_5
            sISBARC = STRINGA_STAMPA_6
            sISBARC_R = STRINGA_STAMPA_66
            Motivo = STRINGA_STAMPA_7

            'If TIPO_ALLOGGIO = 0 Then
            '    If STRINGA_STAMPA_7 = "" Then
            '        testo = "<b>DOMANDA NON IDONEA</b>"
            '    Else
            '        testo = "<b>DOMANDA NON IDONEA</b>"
            '    End If
            'End If


            Select Case CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedIndex

                Case 0
                    sc1 = "<img src=block_checked.gif width=10 height=10 border=1>"
                    sc2 = "<img src=block.gif width=10 height=10 border=1>"
                    sc3 = "<img src=block.gif width=10 height=10 border=1>"
                    sc4 = "<img src=block.gif width=10 height=10 border=1>"
                    sc5 = "<img src=block.gif width=10 height=10 border=1>"
                    sc6 = "<img src=block.gif width=10 height=10 border=1>"
                    sc7 = "<img src=block.gif width=10 height=10 border=1>"
                Case 1
                    sc2 = "<img src=block_checked.gif width=10 height=10 border=1>"
                    sc1 = "<img src=block.gif width=10 height=10 border=1>"
                    sc3 = "<img src=block.gif width=10 height=10 border=1>"
                    sc4 = "<img src=block.gif width=10 height=10 border=1>"
                    sc5 = "<img src=block.gif width=10 height=10 border=1>"
                    sc6 = "<img src=block.gif width=10 height=10 border=1>"
                    sc7 = "<img src=block.gif width=10 height=10 border=1>"
                Case 2
                    sc3 = "<img src=block_checked.gif width=10 height=10 border=1>"
                    sc2 = "<img src=block.gif width=10 height=10 border=1>"
                    sc1 = "<img src=block.gif width=10 height=10 border=1>"
                    sc4 = "<img src=block.gif width=10 height=10 border=1>"
                    sc5 = "<img src=block.gif width=10 height=10 border=1>"
                    sc6 = "<img src=block.gif width=10 height=10 border=1>"
                    sc7 = "<img src=block.gif width=10 height=10 border=1>"
                Case 3
                    sc4 = "<img src=block_checked.gif width=10 height=10 border=1>"
                    sc2 = "<img src=block.gif width=10 height=10 border=1>"
                    sc3 = "<img src=block.gif width=10 height=10 border=1>"
                    sc1 = "<img src=block.gif width=10 height=10 border=1>"
                    sc5 = "<img src=block.gif width=10 height=10 border=1>"
                    sc6 = "<img src=block.gif width=10 height=10 border=1>"
                    sc7 = "<img src=block.gif width=10 height=10 border=1>"
                Case 4
                    sc5 = "<img src=block_checked.gif width=10 height=10 border=1>"
                    sc2 = "<img src=block.gif width=10 height=10 border=1>"
                    sc3 = "<img src=block.gif width=10 height=10 border=1>"
                    sc4 = "<img src=block.gif width=10 height=10 border=1>"
                    sc1 = "<img src=block.gif width=10 height=10 border=1>"
                    sc6 = "<img src=block.gif width=10 height=10 border=1>"
                    sc7 = "<img src=block.gif width=10 height=10 border=1>"
                Case 5
                    sc6 = "<img src=block_checked.gif width=10 height=10 border=1>"
                    sc2 = "<img src=block.gif width=10 height=10 border=1>"
                    sc3 = "<img src=block.gif width=10 height=10 border=1>"
                    sc4 = "<img src=block.gif width=10 height=10 border=1>"
                    sc5 = "<img src=block.gif width=10 height=10 border=1>"
                    sc1 = "<img src=block.gif width=10 height=10 border=1>"
                    sc7 = "<img src=block.gif width=10 height=10 border=1>"
                Case 6
                    sc6 = "<img src=block.gif width=10 height=10 border=1>"
                    sc2 = "<img src=block.gif width=10 height=10 border=1>"
                    sc3 = "<img src=block.gif width=10 height=10 border=1>"
                    sc4 = "<img src=block.gif width=10 height=10 border=1>"
                    sc5 = "<img src=block.gif width=10 height=10 border=1>"
                    sc1 = "<img src=block.gif width=10 height=10 border=1>"
                    sc7 = "<img src=block_checked.gif width=10 height=10 border=1>"
            End Select

            'If Valore01(CType(Dom_Dichiara_Cambi1.FindControl("cfProfugo"), CheckBox).Checked) = "0" Then
            '    k1 = "<img src=block.gif width=10 height=10 border=1>"
            'Else
            '    k1 = "<img src=block_checked.gif width=10 height=10 border=1>"
            'End If


            'i1 = CType(Dom_Abitative_2_1.FindControl("txtAnnoCanone"), TextBox).Text
            'i2 = CType(Dom_Abitative_2_1.FindControl("txtSpese"), TextBox).Text


            'm1 = CType(Dom_Abitative_2_1.FindControl("txtAnnoAcc"), TextBox).Text

            'm2 = CType(Dom_Abitative_2_1.FindControl("txtSpeseAcc"), TextBox).Text






            Dim SstringaSql As String


            SstringaSql = ""

            SstringaSql = SstringaSql & "<html xmlns='http://www.w3.org/1999/xhtml'>" & vbCrLf
            SstringaSql = SstringaSql & "<head>" & vbCrLf
            SstringaSql = SstringaSql & "<meta http-equiv='Content-Style-Type' content='text/css'>" & vbCrLf
            SstringaSql = SstringaSql & "<title>Stampa ERP Comune di Milano</title>" & vbCrLf
            SstringaSql = SstringaSql & "<title>SEPA@Web</title></head>" & vbCrLf
            SstringaSql = SstringaSql & "<BODY>" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "<table border='0' cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf
            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='50%'><img border='0' src='..\IMG\logo.gif' width='166' height='104'></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='50%'>" & vbCrLf
            SstringaSql = SstringaSql & "<p align='center'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" & vbCrLf
            SstringaSql = SstringaSql & "<img border='0' src='..\IMG\MM_113_84.png'></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf
            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='50%' valign='top'></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='50%'>" & vbCrLf
            SstringaSql = SstringaSql & "<p align='center'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf
            SstringaSql = SstringaSql & "</table>" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "<div align='center'>" & vbCrLf
            SstringaSql = SstringaSql & "<center>" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "<TABLE width='100%' cellspacing='0'>" & vbCrLf
            SstringaSql = SstringaSql & "<TBODY>" & vbCrLf
            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td>" & vbCrLf
            SstringaSql = SstringaSql & "<p class='titolo' align='center'>&nbsp;</p>" & vbCrLf
            SstringaSql = SstringaSql & "<font face='Arial' size='2'>MILANO" & vbCrLf
            SstringaSql = SstringaSql & "li " & Format(Now, "dd/MM/yyyy") & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "<p align='center'>" & vbCrLf
            SstringaSql = SstringaSql & "<b><font face='Arial' size='3'>" & vbCrLf
            SstringaSql = SstringaSql & "DOMANDA DI " & CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Text & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font></b></p>" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "&nbsp;" & vbCrLf
            SstringaSql = SstringaSql & "<p></p><p>" & protocollo & " / " & CODICEANAGRAFICO & "</p>" & vbCrLf
            SstringaSql = SstringaSql & "<p>&nbsp;<font face='Arial' size='2'>" & DATI_ANAGRAFICI & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</BR>"
            SstringaSql = SstringaSql & ""


            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</p>" & vbCrLf




            SstringaSql = SstringaSql & "<p class='titolo' align='center'>" & vbCrLf
            SstringaSql = SstringaSql & "<b><font face='Arial' size='3'>" & vbCrLf
            SstringaSql = SstringaSql & "CHIEDE</font></b>" & vbCrLf
            SstringaSql = SstringaSql & "</p>" & vbCrLf
            SstringaSql = SstringaSql & "<font face='Arial' size='2'>ai sensi degli ’Art. 16 e 20 del RR 10 febbraio 2004 n.1,</br>" & vbCrLf

            Select Case CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value
                Case 0
                    SstringaSql = SstringaSql & "- la voltura contrattuale dell’alloggio Erp:" & vbCrLf
                Case 1
                    SstringaSql = SstringaSql & "- il subentro contrattuale dell’alloggio Erp:" & vbCrLf
                Case 2
                    SstringaSql = SstringaSql & "- l’Ampliamento del nucleo per l'alloggio Erp:" & vbCrLf
                Case 3
                    SstringaSql = SstringaSql & "- la riduzione del canone per l'alloggio Erp:" & vbCrLf
                Case 4
                    SstringaSql = SstringaSql & "- il cambio ART.22 C.10 RR 1/2004 dell'alloggio Erp:" & vbCrLf
                Case 5
                    SstringaSql = SstringaSql & "- il cambio diretto dell'alloggio Erp da:" & vbCrLf
            End Select


            Select Case CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value
                Case "0", "1", "3", "4", "2"
                    SstringaSql = SstringaSql & "<p align='center'><b><font face='Arial' size='3'>" & vbCrLf
                    SstringaSql = SstringaSql & "</font></b></p>" & vbCrLf
                    SstringaSql = SstringaSql & "<p><font face='Arial' size='2'>Comune: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtComune"), TextBox).Text & "</b></BR>" & vbCrLf
                    SstringaSql = SstringaSql & "C.A.P.: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtCAP"), TextBox).Text & "</b></BR>" & vbCrLf
                    SstringaSql = SstringaSql & "INDIRIZZO: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtIndirizzo"), TextBox).Text & "</b> CIVICO: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtCivico"), TextBox).Text & "</b></BR>" & vbCrLf
                    SstringaSql = SstringaSql & "INTERNO/SUB: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtInterno"), TextBox).Text & "</b> SCALA: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtScala"), TextBox).Text & "</b> PIANO: <b>" & CType(Dom_Alloggio_ERP1.FindControl("cmbPianoUnita"), DropDownList).SelectedItem.Text & "</b> ASCENSORE: <b>" & CType(Dom_Alloggio_ERP1.FindControl("cmbAscensore"), DropDownList).SelectedItem.Text & "</b> NUM.LOCALI: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtLocali"), TextBox).Text & "</b> CODICE UNITA': <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "</b> SUP.NETTA': <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtNetta"), TextBox).Text & "</b></br>" & vbCrLf
                    SstringaSql = SstringaSql & "</font></p>" & vbCrLf
                    SstringaSql = SstringaSql & "<p align='center'><b><font face='Arial' size='3'>" & vbCrLf
                    SstringaSql = SstringaSql & "</font></b></p>" & vbCrLf
                    SstringaSql = SstringaSql & "<p><font face='Arial' size='2'>NUMERO CONTRATTO: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "</b> DECORRENZA: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtDecorrenza"), TextBox).Text & "</b>" & vbCrLf
                    SstringaSql = SstringaSql & "</font></p></br>" & vbCrLf
                    SstringaSql = SstringaSql & "<p><font face='Arial' size='2'>INTESTATO A: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtCognome"), TextBox).Text & " " & CType(Dom_Alloggio_ERP1.FindControl("txtNome"), TextBox).Text & "</b> CF:<b>" & CType(Dom_Alloggio_ERP1.FindControl("txtCF"), TextBox).Text & "</b>" & vbCrLf

                Case "5"
                    SstringaSql = SstringaSql & "<br /><p align='center'><b><font face='Arial' size='3'>" & vbCrLf
                    SstringaSql = SstringaSql & "</font></b></p>" & vbCrLf
                    SstringaSql = SstringaSql & "<p><font face='Arial' size='2'>Comune: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtComune"), TextBox).Text & "</b></BR>" & vbCrLf
                    SstringaSql = SstringaSql & "C.A.P.: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtCAP"), TextBox).Text & "</b></BR>" & vbCrLf
                    SstringaSql = SstringaSql & "INDIRIZZO: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtIndirizzo"), TextBox).Text & "</b> CIVICO: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtCivico"), TextBox).Text & "</b></BR>" & vbCrLf
                    SstringaSql = SstringaSql & "INTERNO/SUB: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtInterno"), TextBox).Text & "</b> SCALA: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtScala"), TextBox).Text & "</b> PIANO: <b>" & CType(Dom_Alloggio_ERP1.FindControl("cmbPianoUnita"), DropDownList).SelectedItem.Text & "</b> ASCENSORE: <b>" & CType(Dom_Alloggio_ERP1.FindControl("cmbAscensore"), DropDownList).SelectedItem.Text & "</b> NUM.LOCALI: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtLocali"), TextBox).Text & "</b> CODICE UNITA': <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "</b> SUP.NETTA': <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtNetta"), TextBox).Text & "</b></br>" & vbCrLf
                    SstringaSql = SstringaSql & "</font></p>" & vbCrLf
                    SstringaSql = SstringaSql & "<p align='center'><b><font face='Arial' size='3'>" & vbCrLf
                    SstringaSql = SstringaSql & "</font></b></p>" & vbCrLf
                    SstringaSql = SstringaSql & "<p><font face='Arial' size='2'>NUMERO CONTRATTO: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "</b> DECORRENZA: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtDecorrenza"), TextBox).Text & "</b>" & vbCrLf
                    SstringaSql = SstringaSql & "</font></p>" & vbCrLf
                    SstringaSql = SstringaSql & "<p><font face='Arial' size='2'>INTESTATO A: <b>" & CType(Dom_Alloggio_ERP1.FindControl("txtCognome"), TextBox).Text & " " & CType(Dom_Alloggio_ERP1.FindControl("txtNome"), TextBox).Text & " CF:" & CType(Dom_Alloggio_ERP1.FindControl("txtCF"), TextBox).Text & "</b>" & vbCrLf

                    par.cmd.CommandText = "select DIMENSIONI.VALORE AS NETTA,UNITA_CONTRATTUALE.COD_TIPO_LIVELLO_PIANO AS PIANO,UNITA_CONTRATTUALE.CAP,UNITA_CONTRATTUALE.COD_UNITA_IMMOBILIARE,rapporti_utenza.cod_contratto,TO_CHAR(TO_DATE(RAPPORTI_UTENZA.DATA_DECORRENZA,'YYYYmmdd'),'DD/MM/YYYY') AS DECORRENZA,unita_contrattuale.indirizzo,unita_contrattuale.civico,unita_contrattuale.cap,unita_contrattuale.interno,unita_contrattuale.scala,anagrafica.cognome,anagrafica.nome,anagrafica.cod_fiscale,soggetti_contrattuali.cod_tipologia_occupante,COMUNI_NAZIONI.NOME AS COMUNE  from SISCOM_MI.DIMENSIONI,COMUNI_NAZIONI,siscom_mi.unita_contrattuale,siscom_mi.rapporti_utenza,siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where UNITA_CONTRATTUALE.ID_UNITA=DIMENSIONI.ID_UNITA_IMMOBILIARE (+) AND DIMENSIONI.COD_TIPOLOGIA='SUP_NETTA' AND COMUNI_NAZIONI.COD=UNITA_CONTRATTUALE.COD_COMUNE AND rapporti_utenza.cod_contratto='" & CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text & "' AND rapporti_utenza.id=unita_contrattuale.id_contratto and unita_contrattuale.id_unita_principale is null and anagrafica.id=soggetti_contrattuali.id_anagrafica and rapporti_utenza.id=soggetti_contrattuali.id_contratto and soggetti_contrattuali.cod_tipologia_occupante='INTE'"
                    Dim myReader12345 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader12345.Read() Then
                        SstringaSql = SstringaSql & "<br /><br />a:<br /><p align='center'><b><font face='Arial' size='3'>" & vbCrLf
                        SstringaSql = SstringaSql & "</font></b></p>" & vbCrLf
                        SstringaSql = SstringaSql & "<p><font face='Arial' size='2'>Comune: <b>" & par.IfNull(myReader12345("COMUNE"), "") & "</b></BR>" & vbCrLf
                        SstringaSql = SstringaSql & "C.A.P.: <b>" & par.IfNull(myReader12345("CAP"), "") & "</b></BR>" & vbCrLf
                        SstringaSql = SstringaSql & "INDIRIZZO: <b>" & par.IfNull(myReader12345("INDIRIZZO"), "") & "</b> CIVICO: <b>" & par.IfNull(myReader12345("CIVICO"), "") & "</b></BR>" & vbCrLf
                        SstringaSql = SstringaSql & "INTERNO/SUB: <b>" & par.IfNull(myReader12345("INTERNO"), "") & "</b> SCALA: <b>" & par.IfNull(myReader12345("SCALA"), "") & "</b> PIANO: <b>" & par.IfNull(myReader12345("PIANO"), "") & "</b> CODICE UNITA': <b>" & par.IfNull(myReader12345("COD_UNITA_IMMOBILIARE"), "") & "</b> SUP.NETTA': <b>" & par.IfNull(myReader12345("NETTA"), "") & "</b></br>" & vbCrLf
                        SstringaSql = SstringaSql & "</font></p>" & vbCrLf
                        SstringaSql = SstringaSql & "<p align='center'><b><font face='Arial' size='3'>" & vbCrLf
                        SstringaSql = SstringaSql & "</font></b></p>" & vbCrLf
                        SstringaSql = SstringaSql & "<p><font face='Arial' size='2'>NUMERO CONTRATTO: <b>" & par.IfNull(myReader12345("COD_CONTRATTO"), "") & "</b> DECORRENZA: <b>" & par.IfNull(myReader12345("DECORRENZA"), "") & "</b>" & vbCrLf
                        SstringaSql = SstringaSql & "</font></p>" & vbCrLf
                        SstringaSql = SstringaSql & "<p><font face='Arial' size='2'>INTESTATO A: <b>" & par.IfNull(myReader12345("COGNOME"), "") & " " & par.IfNull(myReader12345("NOME"), "") & " CF:" & par.IfNull(myReader12345("COD_FISCALE"), "") & "</b><br />" & vbCrLf
                    End If
                    myReader12345.Close()



            End Select

            SstringaSql = SstringaSql & "<br />La richiesta è stata presentata in data " & CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text

            '***************** 15/02/2012 Informazioni Aggiuntive Per Stampa RAPPORTO ****************
            Select Case dt.Rows(0).Item("MOD_PRESENTAZIONE")
                Case 0
                    SstringaSql = SstringaSql & "<br />Modalità di presentazione: <b>di persona</b>"
                Case 1
                    SstringaSql = SstringaSql & "<br />Modalità di presentazione: <b>a mezzo posta</b>"
                Case 2
                    SstringaSql = SstringaSql & "<br />Modalità di presentazione: <b>verifica d'ufficio</b>"
            End Select

            Dim responsabile As String = ""
            If tipoRichiesta.Value <> "4" Then
                par.cmd.CommandText = "select id from siscom_mi.rapporti_utenza where cod_contratto='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
                Dim myReaderMT0 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderMT0.Read Then
                    par.cmd.CommandText = "select tab_filiali.*,indirizzi.descrizione as descr,indirizzi.civico,indirizzi.cap,indirizzi.localita from siscom_mi.indirizzi,siscom_mi.tab_filiali,siscom_mi.complessi_immobiliari,siscom_mi.edifici,siscom_mi.unita_immobiliari,siscom_mi.unita_contrattuale where unita_contrattuale.id_unita_principale is null and unita_contrattuale.id_contratto=" & par.IfNull(myReaderMT0("ID"), 0) & " and indirizzi.id=tab_filiali.id_indirizzo and unita_immobiliari.id=unita_contrattuale.id_unita and edifici.id=unita_immobiliari.id_edificio and complessi_immobiliari.id=edifici.id_complesso and tab_filiali.id=complessi_immobiliari.id_filiale"
                    Dim myReaderMT1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderMT1.Read Then
                        responsabile = par.IfNull(myReaderMT1("RESPONSABILE"), 0)
                        SstringaSql = SstringaSql & "<br />Referente Amministrativo: <b>" & responsabile & "</b>"
                    End If
                    myReaderMT1.Read()
                End If
                myReaderMT0.Read()
            End If


            If Not IsNothing(CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedItem) Then
                SstringaSql = SstringaSql & "<br /> Causale domanda: <b>" & CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedItem.Text & "</b>" & vbCrLf
            End If


            If tipoRichiesta.Value <> "4" Then
                SstringaSql = SstringaSql & "<br />Limite durata del procedimento: <b>" & tempoProcesso(CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedValue) & "gg </b>"
            End If
            SstringaSql = SstringaSql & "<br />Redditi relativi all'anno: <b>" & dt.Rows(0).Item("ANNO_SIT_ECONOMICA") & "</b><br />" & vbCrLf


            '***************** 15/02/2012 FINE Informazioni Aggiuntive Per Stampa RAPPORTO ****************



            If tipoRichiesta.Value = "4" Then
                par.cmd.CommandText = " SELECT * " _
                                & " FROM siscom_mi.tab_filiali, operatori " _
                                & " WHERE tab_filiali.ID = operatori.id_ufficio(+) " _
                                & " AND operatori.operatore ='" & Session.Item("OPERATORE") & "'"
                Dim myReaderMT0 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderMT0.Read Then
                    responsabile = par.IfNull(myReaderMT0("RESPONSABILE"), 0)
                    SstringaSql = SstringaSql & "<br /><br />Il Responsabile: <b>" & responsabile & "</b><br />"
                    SstringaSql = SstringaSql & "<br />Il Referente Amministrativo: <b>___________________________</b><br/><br/>" & vbCrLf
                End If
                myReaderMT0.Close()
            End If
            SstringaSql = SstringaSql & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "A tal fine" & vbCrLf
            SstringaSql = SstringaSql & "ai sensi del DPR 28 dicembre" & vbCrLf
            SstringaSql = SstringaSql & "2000" & vbCrLf
            SstringaSql = SstringaSql & "n. 445" & vbCrLf
            SstringaSql = SstringaSql & "sotto la propria responsabilità" & vbCrLf
            SstringaSql = SstringaSql & "e nella consapevolezza delle conseguenze" & vbCrLf
            SstringaSql = SstringaSql & "penali in caso di dichiarazione mendace" & vbCrLf
            SstringaSql = SstringaSql & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "<p class='titolo' align='center'>" & vbCrLf
            SstringaSql = SstringaSql & "<b><font face='Arial' size='3'>" & vbCrLf
            SstringaSql = SstringaSql & "DICHIARA</font></b>" & vbCrLf
            SstringaSql = SstringaSql & "</p>" & vbCrLf
            SstringaSql = SstringaSql & "<TABLE width='100%' cellpadding='2' cellspacing='0'>" & vbCrLf
            SstringaSql = SstringaSql & "<TBODY>" & vbCrLf
            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='5%'><font face='Arial' size='2'> </font></td>" & vbCrLf

            SstringaSql = SstringaSql & "<td width='55'>" & vbCrLf
            SstringaSql = SstringaSql & "<font face='Arial' size='2'>-</font>" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf

            Select Case CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value
                Case "0", "1", "3", "4", "5"
                    SstringaSql = SstringaSql & "<TD colspan='3' width='1117'><font face='Arial' size='2'>che il proprio nucleo familiare è composto" & vbCrLf
                    SstringaSql = SstringaSql & "così come indicato nella dichiarazione sostituiva" & vbCrLf
                    SstringaSql = SstringaSql & "allegata</font></td>" & vbCrLf
                Case "2"
                    SstringaSql = SstringaSql & "<TD colspan='3' width='1117'><font face='Arial' size='2'>che il proprio nucleo familiare sarà composto, in caso di ampliamento, " & vbCrLf
                    SstringaSql = SstringaSql & "così come indicato nella dichiarazione sostituiva" & vbCrLf
                    SstringaSql = SstringaSql & "allegata</font></td>" & vbCrLf
            End Select

            SstringaSql = SstringaSql & "</tr>" & vbCrLf
            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='16'></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='55'>" & vbCrLf
            SstringaSql = SstringaSql & "<font face='Arial' size='2'>" & sa1 & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<TD colspan='2' width='1056'><font face='Arial' size='2'>che il nucleo familiare richiedente ha " & vbCrLf
            SstringaSql = SstringaSql & "effettuato gli adempimenti connessi all'anagrafe utenza" & vbCrLf
            SstringaSql = SstringaSql & ".</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf

            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='16'></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='55'>" & vbCrLf
            SstringaSql = SstringaSql & "<font face='Arial' size='2'>" & sA3 & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<TD colspan='2' width='1056'><font face='Arial' size='2'>" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf

            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='16'></td>" & vbCrLf
            SstringaSql = SstringaSql & "<TD colspan='3' width='1117'><font face='Arial' size='2'>&nbsp;&nbsp;&nbsp;</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf


            SstringaSql = SstringaSql & "</TBODY></table></td></tr></table></center></div><div align='center'><center>"
            SstringaSql = SstringaSql & "<p style='page-break-after: always' class='mini'><font face='Arial' size='2'>&nbsp;</font></p><table width='100%' cellpadding='0' cellspacing='0'><TBODY>"
            SstringaSql = SstringaSql & "<tr><td><table cellpadding='2' cellspacing='0' style=" & Chr(34) & "width: 100%" & Chr(34) & "><TBODY>"
            SstringaSql = SstringaSql & "<tr><td width='5%' colspan='3' class='titolo'><p align='center'><u><b><font face='Arial' size='3'>REQUISITI AMMISSIBILITA'</font></b></u><font face='Arial' size='2'><br>"
            SstringaSql = SstringaSql & "<br></font>"

            SstringaSql = SstringaSql & "<p align='left'><font face='Arial' size='2'>Il richiedente dichiara di essere in possesso,<u>alla data di presentazione della domanda</u>, dei seguenti requisiti (RR 1/2004 e successive modifiche ed integrazioni e L.R. 5/2008):<br>"

            SstringaSql = SstringaSql & "</font>"

            'SstringaSql = SstringaSql & "<p align='left'><font face='Arial' size='2'>Il richiedente dichiara di essere in possesso, alla data di presentazione della domanda, dei seguenti requisiti (RR 1/2004 e successive modifiche ed integrazioni e L.R. 5/2008):<br>NB: I requisiti soggettivi debbono essere posseduti dal concorrente e dagli altri componenti il nucleo familiare (ad eccezione dei requisiti alle lettere a), b) k) ed l)) alla data della domanda, nonché al momento dell’assegnazione e debbono permanere in costanza del rapporto di locazione.</font></p>"
            SstringaSql = SstringaSql & "</td></tr>"

            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='16'><font face='Arial' size='2'>a)</font></td>            <td width='55'><font face='Arial' size='2'>" & req1 & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<TD colspan='2' width='1056'><font face='Arial' size='2'>Cittadinanza italiana o di uno Stato aderente all’Unione Europea o di altro Stato, qualora il diritto di assegnazione di alloggio Erp sia riconosciuto in condizioni di reciprocità <br>da convenzioni o trattati internazionali, ovvero lo straniero sia titolare di carta di soggiorno<br>o in possesso di permesso di soggiorno come previsto dalla vigente normativa;</font></td>" & vbCrLf

            SstringaSql = SstringaSql & "</tr>" & vbCrLf
            SstringaSql = SstringaSql & "<tr>" & vbCrLf

            Select Case CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value
                Case 0, 1
                    SstringaSql = SstringaSql & "<td width='16'><font face='Arial' size='2'>b)</font></td><td width='55'><font face='Arial' size='2'>" & req2 & "</font></td>" & vbCrLf
                    SstringaSql = SstringaSql & "<TD colspan='3' width='1117'><font face='Arial' size='2'>Residenza anagrafica in un alloggio ERP situato nel territorio del Comune di Milano, indipendentemente dall’ente proprietario, per cui il precedente instestatario era titolare legittimo , <br>oppure per cui il richiedente è titolare legittimo di un contratto di locazione in corso validità è in possesso di almeno uno dei requisiti ai sensi dell’art. 16 e 20 del R. R. 1/2004</font></td>" & vbCrLf
                    SstringaSql = SstringaSql & "</tr>" & vbCrLf
                Case 2
                    SstringaSql = SstringaSql & "<td width='16'><font face='Arial' size='2'>b)</font></td><td width='55'><font face='Arial' size='2'>" & req2 & "</font></td>" & vbCrLf
                    SstringaSql = SstringaSql & "<TD colspan='3' width='1117'><font face='Arial' size='2'>Residenza anagrafica in un alloggio ERP situato nel territorio del Comune di Milano, indipendentemente dall’ente proprietario <br>oppure per cui il richiedente è titolare legittimo di un contratto di locazione in corso di validità è in possesso di almeno uno dei requisiti ai sensi dell’art. 16 e 20 del R. R. 1/2004</font></td>" & vbCrLf
                    SstringaSql = SstringaSql & "</tr>" & vbCrLf
            End Select

            'SstringaSql = SstringaSql & "<tr>" & vbCrLf
            'SstringaSql = SstringaSql & "<td width='16'></td>" & vbCrLf
            'SstringaSql = SstringaSql & "<td width='55'><font face='Arial' size='2'><img src=block_checked.gif width=10 height=10 border=1></font>" & vbCrLf
            'SstringaSql = SstringaSql & "</td>" & vbCrLf
            'If Not IsNothing(CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedItem) Then
            '    SstringaSql = SstringaSql & "<TD colspan='2' width='1056'><font face='Arial' size='2'>" & CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedItem.Text & "</font></td>" & vbCrLf
            'End If
            'SstringaSql = SstringaSql & "</tr>" & vbCrLf


            SstringaSql = SstringaSql & "<tr><td width='16'></td><td width='55'></td><td width='1056'></td></tr>"


            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='16'></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='55'>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<TD colspan='2' width='1056'>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf

            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='5%' valign='middle'><font face='Arial' size='2'>c)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req2 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1061'><font face='Arial' size='2'>Assenza di precedente assegnazione in proprietà, immediata o futura, di alloggio realizzato con contributo pubblico o finanziamento agevolato in qualunque forma,<br> concesso dallo Stato, dalla Regione, dagli enti territoriali o da altri enti pubblici, sempre che l’alloggio non sia perito senza dare luogo al risarcimento del danno;" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf
            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>d)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req3 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123' valign='middle'><font face='Arial' size='2'>Assenza di precedente assegnazione in locazione di un alloggio di Erp, qualora il rilascio sia dovuto a provvedimento amministrativo di decadenza per aver <br>destinato l’alloggio o le relative pertinenze ad attività illecite che risultino da provvedimenti giudiziari e/o della pubblica sicurezza;" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf
            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>e)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req4 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123'><font face='Arial' size='2'>non abbia ceduto a terzi in tutto o in parte, fuori dei casi previsti dalla legge, l’alloggio assegnato in precedenza o le sue pertinenze;" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf
            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>g)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req5 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123'><font face='Arial' size='2'>Che nessun componente del nucleo familiare indicato nella dichiarazione sostitutiva allegata alla presente domanda è titolare del diritto di proprietà o di altri diritti reali <br>di godimento su alloggio adeguato alle esigenze del  nucleo familiare nel territorio nazionale e all’estero." & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf
            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>h)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req6 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123'><font face='Arial' size='2'>Non sia stato sfrattato per morosità da alloggi erp negli ultimi 5 anni e abbia pagato le somme dovute all’ente gestore;" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf
            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>i)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req7 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123'><font face='Arial' size='2'>Non sia stato occupante senza titolo di alloggi erp negli ultimi 5 anni (L.R. 5/2008 art. 2);</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf


            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>j)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req8 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123'><font face='Arial' size='2'>non abbia lasciato inutilizzato l’alloggio erp assegnato a seguito di assenza per un periodo superiore a sei mesi continuativi, a meno di espressa autorizzazione dell'ente gestore<br> per gravi motivi familiari o di salute o di lavoro;</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf

            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>k)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req9 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123'><font face='Arial' size='2'>non abbia mutato la destinazione d'uso dell'alloggio o delle relative pertinenze;</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf


            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>l)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req10 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123'><font face='Arial' size='2'>non abbia causato gravi danni all’alloggio e/o alle parti comuni dell’edificio ed il fatto è stato accertato con sentenza passata in giudicato;</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf


            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>m)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req11 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123'><font face='Arial' size='2'>non abbia usato - o non abbia consentito a terzi di utilizzare - l'alloggio o le sue pertinenze per attività illecite che risultino da provvedimenti giudiziari e/o <br>della pubblica sicurezza;</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf

            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>n)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req12 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123'><font face='Arial' size='2'>non abbia, dopo diffida dell’ente gestore, prodotto la documentazione relativa alla propria situazione economica o l’abbia reiteratamente prodotta in forma incompleta<br> non integrabile d’ufficio;</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf


            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>o)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req13 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123'><font face='Arial' size='2'>non abbia ottemperato alle disposizioni dell’ente gestore per quanto previsto agli articoli 20 e 21 del R. R. 1/2004 (subentro nell’assegnazione e ospitalità temporanea);</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr><p style='page-break-after: always' class='mini'><font face='Arial' size='2'>&nbsp;</font></p>" & vbCrLf

            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>p)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req14 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123'><font face='Arial' size='2'>non abbia conseguito la titolarità del diritto di proprietà o di altri diritti reali di godimento su un alloggio o su beni immobili in qualsiasi località del territorio nazionale<br> aventi un valore, definito ai fini I.C.I., pari o superiore a quello di un alloggio adeguato nel comune di residenza, di categoria catastale A3, classe 1; qualora il comune <br>in cui è situato l’immobile in locazione, abbia più zone censuarie, si fa riferimento alla zona censuaria con il valore catastale minore, per un alloggio dalle caratteristiche sopra specificate;</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf

            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>q)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req15 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123'><font face='Arial' size='2'>che la durata della convivenza non sia inferiore al limite previsto;</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf

            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>r)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req16 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123'><font face='Arial' size='2'>che la convivenza sia di carattere assistenziale;</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf

            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='middle'><font face='Arial' size='2'>s)</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='56'><font face='Arial' size='2'><BR>" & req17 & "<BR>" & vbCrLf
            SstringaSql = SstringaSql & "</font>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123'><font face='Arial' size='2'>presenza di forte sovraffollamento;</font></td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf



            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='12' valign='top'></td>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='1123' colspan='2'>" & vbCrLf
            SstringaSql = SstringaSql & "</td>" & vbCrLf
            SstringaSql = SstringaSql & "</tr>" & vbCrLf
            SstringaSql = SstringaSql & "</TBODY>" & vbCrLf
            SstringaSql = SstringaSql & "</table>" & vbCrLf


            If CType(Me.Page.FindControl("cmbResidenza"), DropDownList).SelectedItem.Value = 3 Then
                SstringaSql = SstringaSql & "<tr>" & vbCrLf
                SstringaSql = SstringaSql & "<td width='100%'><font face='Arial' size='2'>- dichiara altresì di essere residente in Lombardia, al momemento della domanda da OLTRE 10 ANNI</font></td>" & vbCrLf
                SstringaSql = SstringaSql & "<td width='5%' colspan='3'><font face='Arial' size='2'></font></B></td>" & vbCrLf
                SstringaSql = SstringaSql & "</tr>" & vbCrLf
            End If

            If CType(Me.Page.FindControl("cmbResidenza"), DropDownList).SelectedItem.Value = 2 Then
                SstringaSql = SstringaSql & "<tr>" & vbCrLf
                SstringaSql = SstringaSql & "<td width='5%'><font face='Arial' size='2'>- dichiara altresì di essere residente in Lombardia, al momemento della domanda da 5 A 10 ANNI</font></td>" & vbCrLf
                SstringaSql = SstringaSql & "<td width='5%' colspan='3'><font face='Arial' size='2'></font></B></td>" & vbCrLf
                SstringaSql = SstringaSql & "</tr>" & vbCrLf
            End If

            SstringaSql = SstringaSql & "</TBODY>" & vbCrLf
            SstringaSql = SstringaSql & "</table>" & vbCrLf
            'SstringaSql = SstringaSql & "<p style='page-break-after: always' class='mini'><font face='Arial' size='2'>&nbsp;</font></p>" & vbCrLf
            SstringaSql = SstringaSql & "<table>" & vbCrLf
            SstringaSql = SstringaSql & "<TBODY>" & vbCrLf

            SstringaSql = SstringaSql & "</TBODY>" & vbCrLf
            SstringaSql = SstringaSql & "</table>&nbsp;" & vbCrLf
            SstringaSql = SstringaSql & "<p>&nbsp;" & vbCrLf
            SstringaSql = SstringaSql & "</p>" & vbCrLf
            SstringaSql = SstringaSql & "<p><font face='Arial' size='2'><BR>" & vbCrLf

            SstringaSql = SstringaSql & "</tr></table></td></tr></table></center></div><H2 align='center'><b><font face='Arial' size='5'>PROSPETTO ERP</font></b></H2>" & vbCrLf
            SstringaSql = SstringaSql & "<table border='0' cellpadding='0' cellspacing='1' width='98%'  height='40'>" & vbCrLf
            SstringaSql = SstringaSql & "<tr>" & vbCrLf
            SstringaSql = SstringaSql & "<td width='80%' height='23'><b><font face='Arial' size='2'>SITUAZIONE REDDITUALE DEL NUCLEO FAMILIARE</font></b>" & SITUAZIONE_REDDITUALE & "</table>" & vbCrLf
            SstringaSql = SstringaSql & "" & vbCrLf
            SstringaSql = SstringaSql & "<table border='0' cellpadding='0' cellspacing='5' width='98%' height='40'>" & vbCrLf
            SstringaSql = SstringaSql & "<tr><td width='80%' height='23'><b><font face='Arial' size='2'>SITUAZIONE PATRIMONIALE DEL NUCLEO FAMILIARE</font></b>" & SITUAZIONE_PATRIMONIALE & "</table>" & vbCrLf
            SstringaSql = SstringaSql & "<table border='0' cellpadding='0' cellspacing='5' width='98%' height='40'><tr><td width='80%' height='23'><b><font face='Arial' size='2'>DETERMINAZIONE" & vbCrLf
            SstringaSql = SstringaSql & "DELL'ISEE-erp </font></b>" & sISEE_ERP & "</td>   </table><table border='0' cellpadding='0' cellspacing='5' width='98%' height='66'><tr><td width='80%' height='23'><b><font face='Arial' size='2'>Risultati intermedi" & vbCrLf
            SstringaSql = SstringaSql & "</font></b>" & RISULTATI_INTERMEDI & "</td>   </table>" & vbCrLf
            SstringaSql = SstringaSql & Motivo '& "<font face='Arial' size='2'>La presente domanda è stata valutata sulla base della dichiarazione sostitutiva unica con numero protocollo" & vbCrLf
            'SstringaSql = SstringaSql & "<b>" & pg_dichiarazione & "</b>" & vbCrLf
            'SstringaSql = SstringaSql & "presentata "
            'SstringaSql = SstringaSql & "in data <b>" & DATA_PRESENTA_DICH & "</b> a <b>" & LUOGO_PRESENTA_DICH & "</b>" _
            '    & "presso l'ente <b>COMUNE DI MILANO</b>  ed elaborata in data" & vbCrLf
            'SstringaSql = SstringaSql & "<b>" & DATA_STAMPA & "</b></font><table align='center' border=1 width=98% ><tr><td align='center'  ><strong><font size='2' face='Arial'>Pg/data" & vbCrLf
            'SstringaSql = SstringaSql & "domanda</font></strong></td><td align='center'  ><strong><font size='2' face='Arial'>ente erogatore</font></strong></td><td align='center'  ><strong><font size='2' face='Arial'>data elaborazione</font></strong></td><td align='center'  ><strong><font size='2' face='Arial'>ente inseritore</font></strong></td><td align='center'  ><strong><font size='2' face='Arial'>stato</font></strong></td></tr><tr><td align='center' ><font face='Arial' size='2'>" & ID_DOMANDA & "</font></td><td align='center' >" & vbCrLf
            'SstringaSql = SstringaSql & "<font size='2' face='Arial'>" & Session.Item("CAAF") & "</font></td><td align='center' >" & vbCrLf
            'SstringaSql = SstringaSql & "<font face='Arial' size='2'>" & DATA_STAMPA_DOMANDA & "</font></td><td align='center'>" & vbCrLf
            'SstringaSql = SstringaSql & "<font size='2' face='Arial'>COMUNE DI MILANO</font></td><td align='center' >" & vbCrLf
            'SstringaSql = SstringaSql & "<font size='2' face='Arial'>Completa</font></td></tr></table>"


            '*************************** 16/02/2012 DECISIONI RELATIVE ALLA DOMANDA ***************************
            'Dim decisioni As Boolean = True
            'SstringaSql = SstringaSql & "<br/><br/><table width='100%'><tr><td style='border-bottom-style: solid; border-bottom-width: 1px;border-bottom-color: grey'><strong><font size='3' face='Arial'>PROSPETTO DECISIONI</font></strong></td><td style='border-bottom-style: solid; border-bottom-width: 1px;border-bottom-color: grey'></td></tr><br/>"

            'par.cmd.CommandText = "SELECT * from VSA_DECISIONI_REV_C where ID_DOMANDA=" & lIdDomanda & " AND COD_DECISIONE = 1"
            'Dim lettoreDec As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            'If lettoreDec.Read() Then
            '    SstringaSql = SstringaSql & "<tr><td width='40%'>Domanda sottoposta a decisione: <b>SI</b></td><td width='40%'>&nbsp</td><td width='50%'>Data: <b>" & par.FormattaData(lettoreDec("DATA")) & "</b></td></tr>"
            'Else
            '    SstringaSql = SstringaSql & "<tr><td width='40%'><font face='Arial' size='2'>Non è stata presa alcuna decisione su questa domanda</font></td></tr>"
            '    decisioni = False
            'End If
            'lettoreDec.Close()

            'If decisioni = True Then

            '    par.cmd.CommandText = "SELECT * from VSA_DECISIONI_REV_C where ID_DOMANDA=" & lIdDomanda & " AND (COD_DECISIONE = 2 or COD_DECISIONE = 3)"
            '    lettoreDec = par.cmd.ExecuteReader()
            '    'If Not lettoreDec.Read Then
            '    '    SstringaSql = SstringaSql & "<tr><td width='80%'>Decisione accolta: ---</td><td width='50%'>Data: --- </td></tr>"
            '    'Else
            '    While lettoreDec.Read
            '        If lettoreDec("COD_DECISIONE") = 2 Then
            '            SstringaSql = SstringaSql & "<tr><td width='40%'>Decisione accolta: <b>SI</b></td><td width='40%'>&nbsp</td><td width='50%'>Data: <b>" & par.FormattaData(lettoreDec("DATA")) & "</b></td></tr>"
            '        Else
            '            SstringaSql = SstringaSql & "<tr><td width='40%'>Decisione accolta: <b>NO</b></td><td width='40%'>Note: <b>" & par.IfNull(lettoreDec("NOTE"), "---") & "</b></td><td width='50%'>Data: <b>" & par.FormattaData(lettoreDec("DATA")) & "</b></td></tr>"
            '            par.cmd.CommandText = "SELECT * from VSA_DECISIONI_REV_C where ID_DOMANDA=" & lIdDomanda & " AND COD_DECISIONE = 4"
            '            Dim lettoreDec2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            '            If lettoreDec2.Read() Then
            '                SstringaSql = SstringaSql & "<tr><td width='40%'>Domanda sottoposta a riesame: <b>SI</b></td><td width='40%'>&nbsp</td><td width='50%'>Data: <b>" & par.FormattaData(lettoreDec2("DATA")) & "</b></td></tr>"
            '            Else
            '                SstringaSql = SstringaSql & "<tr><td width='40%'><i><b>Domanda in attesa di osservazioni</i></b></td></tr>"
            '            End If
            '            lettoreDec2.Close()
            '        End If
            '    End While
            '    'End If
            '    lettoreDec.Close()

            '    par.cmd.CommandText = "SELECT * from VSA_DECISIONI_REV_C where ID_DOMANDA=" & lIdDomanda & " AND COD_DECISIONE = 4"
            '    lettoreDec = par.cmd.ExecuteReader()
            '    If lettoreDec.Read() = False Then
            '        SstringaSql = SstringaSql & "<tr><td width='40%'>Domanda sottoposta a riesame: <b>NO</b></td></tr>"
            '    End If
            '    lettoreDec.Close()

            '    par.cmd.CommandText = "SELECT * from VSA_DECISIONI_REV_C where ID_DOMANDA=" & lIdDomanda & " AND (COD_DECISIONE = 5 or COD_DECISIONE = 6)"
            '    lettoreDec = par.cmd.ExecuteReader()
            '    If lettoreDec.Read() Then
            '        If lettoreDec("COD_DECISIONE") = 5 Then
            '            SstringaSql = SstringaSql & "<tr><td width='40%'>Riesame accolto: <b>SI</b></td><td width='40%'>Note: <b>" & par.IfNull(lettoreDec("NOTE"), "---") & "</b></td><td width='50%'>Data: <b>" & par.FormattaData(lettoreDec("DATA")) & "</b></td></tr>"
            '        Else
            '            SstringaSql = SstringaSql & "<tr><td width='40%'>Riesame accolto: <b>NO</b></td><td width='40%'>Note: <b>" & par.IfNull(lettoreDec("NOTE"), "---") & "</b></td><td width='50%'>Data: <b>" & par.FormattaData(lettoreDec("DATA")) & "</b></td></tr>"
            '        End If
            '    Else
            '        SstringaSql = SstringaSql & "<tr><td width='40%'>Riesame accolto: ---</td><td width='40%'>&nbsp</td><td width='50%'>Data: --- </td></tr>"
            '    End If
            '    lettoreDec.Close()

            '    par.cmd.CommandText = "SELECT * FROM EVENTI_BANDI_VSA WHERE ID_DOMANDA = " & lIdDomanda & " AND (COD_EVENTO = 'F179' or COD_EVENTO = 'F165' or COD_EVENTO = 'F196' or COD_EVENTO = 'F197' or COD_EVENTO = 'F204')"
            '    lettoreDec = par.cmd.ExecuteReader()
            '    If lettoreDec.Read() Then
            '        SstringaSql = SstringaSql & "<tr><td width='40%'>Autorizzazione finale: <b>SI</b></td><td width='40%'>&nbsp</td><td width='50%'>Data: <b>" & par.FormattaData(par.IfNull(lettoreDec("DATA_ORA"), "").ToString.Substring(0, 8)) & "</b></td></tr>"
            '    Else
            '        SstringaSql = SstringaSql & "<tr><td width='40%'>Autorizzazione finale: ---</td><td width='40%'>&nbsp</td><td width='50%'>Data: --- </td></tr>"
            '    End If
            '    lettoreDec.Close()
            'End If
            'SstringaSql = SstringaSql & "</table>"
            '*************************** 16/02/2012 fine DECISIONI RELATIVE ALLA DOMANDA *****************

            'If ESCLUSIONE = "" Then
            '    If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = 3 Then

            '        cmbAccolta.ClearSelection()
            '        cmbAccolta.Items.FindByText("SI").Selected = True
            '        cmbAccolta.Enabled = False

            '        Dim IMPORTO As Double = 0
            '        Dim LOCATIVO As String = ""
            '        Dim IDUNITA As Long = 0
            '        Dim comunicazioni As String = ""
            '        Dim AreaEconomica As Integer = 0



            '        par.cmd.CommandText = "SELECT ID FROM SISCOM_MI.UNITA_IMMOBILIARI WHERE COD_UNITA_IMMOBILIARE='" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "'"
            '        Dim myReader1234 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            '        If myReader1234.Read() Then
            '            IDUNITA = par.IfNull(myReader1234("ID"), 0)
            '        End If
            '        myReader1234.Close()

            '        Dim TestoFile As String = Replace(par.CalcolaCanone27(CDbl(HiddenID.Value), 3, IDUNITA, Request.QueryString("COD"), IMPORTO, LOCATIVO, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone), "CALCOLO CANONE L.R. 27/07", "CALCOLO CANONE L.R. 27/07 E L.R. 36/2008")

            '        SstringaSql = SstringaSql & "<p style='page-break-after: always' class='mini'><font face='Arial' size='2'>&nbsp;</font></p>" & vbCrLf
            '        SstringaSql = SstringaSql & "<font size='2' face='Courier New'>" & Replace(TestoFile, vbCrLf, "</br>") & "</font></br></br>"

            '        If IMPORTO = 0 Then
            '            cmbAccolta.ClearSelection()
            '            cmbAccolta.Items.FindByText("-").Selected = True
            '            cmbAccolta.Enabled = True
            '        Else
            '            'operazioni aggiornamento canone
            '            Dim CanoneCorrente As Double = 0
            '            Dim idc As Long = 0


            '            par.cmd.CommandText = "SELECT imp_canone_iniziale,id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            '            Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            '            If myReaderX1.Read Then
            '                CanoneCorrente = par.IfNull(myReaderX1(0), 0)
            '                idc = myReaderX1("id")
            '            End If
            '            myReaderX1.Close()

            '            par.cmd.CommandText = "select SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE ID_CONTRATTO=" & idc
            '            myReaderX1 = par.cmd.ExecuteReader()
            '            If myReaderX1.Read Then
            '                CanoneCorrente = CanoneCorrente + par.IfNull(myReaderX1(0), 0)
            '            End If
            '            myReaderX1.Close()

            '            If contrattodialer.Value = "0" Then
            '                Response.Write("<script>alert('ATTENZIONE...Trattasi di contratto NON STIPULATO dal Gestore!');</script>")
            '            End If

            '            'If contrattodialer.Value = "1" Then
            '            SstringaSql = SstringaSql & "<font size='2' face='Courier New'>CANONE ANNUO ATTUALE (comprensivo agg.ISTAT):............." & Format(CanoneCorrente, "##,##0.00") & "</br>"
            '            SstringaSql = SstringaSql & "CANONE MENSILE ATTUALE...................................." & Format(CanoneCorrente / 12, "##,##0.00") & "</br>"
            '            SstringaSql = SstringaSql & "NUOVO CANONE MENSILE PROVVISORIO *........................<B>" & Format(IMPORTO / 12, "##,##0.00") & "</B></br>"

            '            If CanoneCorrente > IMPORTO Then
            '                SstringaSql = SstringaSql & "RIDUZIONE DA APPLICARE...................................." & Format(((CanoneCorrente - IMPORTO) * 100) / CanoneCorrente, "0.00") & "%</br>"
            '                ' SstringaSql = SstringaSql & "RIDUZIONE ANNUA IN BOLLETTA .............................." & Format((CanoneCorrente - IMPORTO), "##,##0.00") & "</br>"
            '                SstringaSql = SstringaSql & "RIDUZIONE MENSILE IN BOLLETTA ............................" & Format(((CanoneCorrente - IMPORTO) / 12), "##,##0.00") & "</font></br></br>"
            '            Else
            '                SstringaSql = SstringaSql & "AUMENTO DA APPLICARE...................................." & Format((((CanoneCorrente - IMPORTO) * 100) / CanoneCorrente) * -1, "0.00") & "%</br>"
            '                'SstringaSql = SstringaSql & "AUMENTO ANNUA IN BOLLETTA .............................." & Format((CanoneCorrente - IMPORTO) * -1, "##,##0.00") & "</br>"
            '                SstringaSql = SstringaSql & "AUMENTO MENSILE IN BOLLETTA ............................" & Format(((CanoneCorrente - IMPORTO) / 12) * -1, "##,##0.00") & "</font></br></br>"
            '            End If

            '            TestoFile = TestoFile & vbCrLf & vbCrLf & "CANONE ANNUO ATTUALE (comprensivo agg.ISTAT):............." & Format(CanoneCorrente, "##,##0.00") & vbCrLf
            '            TestoFile = TestoFile & "CANONE MENSILE ATTUALE...................................." & Format(CanoneCorrente / 12, "##,##0.00") & vbCrLf
            '            TestoFile = TestoFile & "NUOVO CANONE MENSILE PROVVISORIO *........................" & Format(IMPORTO / 12, "##,##0.00") & vbCrLf

            '            If CanoneCorrente > IMPORTO Then
            '                TestoFile = TestoFile & "RIDUZIONE DA APPLICARE...................................." & Format(((CanoneCorrente - IMPORTO) * 100) / CanoneCorrente, "0.00") & "%" & vbCrLf
            '                'TestoFile = TestoFile & "RIDUZIONE ANNUA IN BOLLETTA .............................." & Format((CanoneCorrente - IMPORTO), "##,##0.00") & vbCrLf
            '                TestoFile = TestoFile & "RIDUZIONE MENSILE IN BOLLETTA .............................." & Format(((CanoneCorrente - IMPORTO) / 12), "##,##0.00") & vbCrLf
            '            Else
            '                TestoFile = TestoFile & "AUMENTO DA APPLICARE......................................" & Format((((CanoneCorrente - IMPORTO) * 100) / CanoneCorrente) * -1, "0.00") & "%" & vbCrLf
            '                'TestoFile = TestoFile & "AUMENTO ANNUA IN BOLLETTA .............................." & Format((CanoneCorrente - IMPORTO) * -1, "##,##0.00") & vbCrLf
            '                TestoFile = TestoFile & "AUMENTO MENSILE IN BOLLETTA .............................." & Format(((CanoneCorrente - IMPORTO) / 12) * -1, "##,##0.00") & vbCrLf
            '            End If

            '            'par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET IMP_CANONE_PROVV=" & par.VirgoleInPunti(IMPORTO) & " WHERE ID=" & idc
            '            'par.cmd.ExecuteNonQuery()

            '            'par.cmd.CommandText = "delete from siscom_mi.bol_schema where id_voce=675 and id_contratto=" & idc & " and anno=" & Year(Now)
            '            'par.cmd.ExecuteNonQuery()

            '            'If CanoneCorrente > IMPORTO Then
            '            'par.cmd.CommandText = "insert into siscom_mi.bol_schema values (siscom_mi.seq_bol_schema.nextval," & idc & "," & IDUNITA & "," & par.RicavaEsercizioCorrente & ",675," & par.VirgoleInPunti(Format((CanoneCorrente - IMPORTO) * -1, "0.00")) & ",1,12," & par.VirgoleInPunti(Format(((CanoneCorrente - IMPORTO) * -1) / 12, "0.00")) & "," & Year(Now) & ")"
            '            'par.cmd.ExecuteNonQuery()
            '            'Else
            '            'par.cmd.CommandText = "insert into siscom_mi.bol_schema values (siscom_mi.seq_bol_schema.nextval," & idc & "," & IDUNITA & "," & par.RicavaEsercizioCorrente & ",675," & par.VirgoleInPunti(Format((IMPORTO - CanoneCorrente), "0.00")) & ",1,12," & par.VirgoleInPunti(Format(((IMPORTO - CanoneCorrente)) / 12, "0.00")) & "," & Year(Now) & ")"
            '            'par.cmd.ExecuteNonQuery()
            '            'End If

            '            'par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) VALUES (" & idc & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','F02','INSERITA VOCE RIDUZIONE CANONE LOCAZIONE NELLO SCHEMA DI EURO " & par.VirgoleInPunti(Format(((IMPORTO - CanoneCorrente)) / 12, "0.00")) & "')"
            '            'par.cmd.ExecuteNonQuery()

            '############# DA COPIARE ##############
            '            If CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text <> "" Then
            '                Dim NumBollette As Integer = 0
            '                Dim NumBollettePagate As Integer = 0

            '                par.cmd.CommandText = "select * from siscom_mi.bol_bollette where data_emissione>" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) & " and id_contratto=" & idc & " and fl_annullata='0'"
            '                myReaderX1 = par.cmd.ExecuteReader()
            '                Do While myReaderX1.Read
            '                    NumBollette = NumBollette + 1
            '                Loop
            '                myReaderX1.Close()

            '                par.cmd.CommandText = "select * from siscom_mi.bol_bollette where data_pagamento is not null and data_emissione>" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) & " and id_contratto=" & idc & " and fl_annullata='0'"
            '                myReaderX1 = par.cmd.ExecuteReader()
            '                Do While myReaderX1.Read
            '                    NumBollettePagate = NumBollettePagate + 1
            '                Loop

            '                If NumBollette > 0 Then
            '                    SstringaSql = SstringaSql & "<br /><font size='2' face='arial'><strong>CREDITO TEORICO</strong><br />Dalla data di presentazione della richiesta, " & CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text & ", al " & Format(Now, "dd/MM/yyyyy") & ", sono state emesse n. " & NumBollette & " bollette mensili (di cui pagate n. " & NumBollettePagate & ") a carico dell'inquilino. Il credito teorico, salvo verifiche, ammonta a euro " & Format(NumBollette * ((CanoneCorrente - IMPORTO) / 12), "##,##0.00") & ".</font>"
            '                    TestoFile = TestoFile & vbCrLf & "CREDITO TEORICO" & vbCrLf & "Dalla data di presentazione della richiesta, " & CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text & ", al " & Format(Now, "dd/MM/yyyyy") & ", sono state emesse n. " & NumBollette & " bollette mensili (di cui pagate n. " & NumBollettePagate & ") a carico dell'inquilino. Il credito teorico, salvo verifiche, ammonta a euro " & Format(NumBollette * ((CanoneCorrente - IMPORTO) / 12), "##,##0.00") & "."
            '                End If
            '                myReaderX1.Close()
            '            End If
            '############# FINE DA COPIARE ##############


            '            SstringaSql = SstringaSql & "<br /><br /><font size='1' face='arial'>* Il nuovo canone mensile indicato ha carattere di provvisorietà ed è da intendersi valido fino all'applicazione della prossima Anagrafe dell’Utenza. <br />Nel corso della stessa Anagrafe dell’Utenza la situazione economica presunta, dichiarata ai fini della presente istanza, sarà oggetto di revisione sulla base dei dati economici definitivi del nucleo familiare ed il canone provvisorio  sarà soggetto a conguaglio.<br />Il canone provvisorio sarà applicato automaticamente dalla prossima bollettazione bimestrale utile. </font>"
            '            TestoFile = TestoFile & vbCrLf & vbCrLf & "* Il nuovo canone mensile indicato ha carattere di provvisorieta' ed è da intendersi valido fino all'applicazione della prossima Anagrafe dell'Utenza." & vbCrLf & "Nel corso della stessa Anagrafe dell'Utenza la situazione economica presunta, dichiarata ai fini della presente istanza, sara' oggetto di revisione sulla base dei dati economici definitivi del nucleo familiare ed il canone provvisorio  sara' soggetto a conguaglio." & vbCrLf & "Il canone provvisorio sara' applicato automaticamente dalla prossima bollettazione bimestrale utile."


            '            'Dim fileName As String = CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt"

            '            'If System.IO.File.Exists(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt")) = True Then
            '            'System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt"))
            '            'End If

            '            'Dim sr As StreamWriter = New StreamWriter(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, False, System.Text.Encoding.Default)
            '            'sr.WriteLine(TestoFile)
            '            'sr.Close()

            '            'par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,TESTO) " _
            '            '                   & "VALUES (" & idc & ",'" & Format(My.Computer.FileSystem.GetFileInfo(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt")).CreationTime, "yyyyMMddhhmmss") & "'," & AreaEconomica & ",'" & sISEE & "',:TESTO) "


            '            'Dim objStream As Stream = File.Open(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt"), FileMode.Open)
            '            'Dim buffer(objStream.Length) As Byte
            '            'objStream.Read(buffer, 0, objStream.Length)
            '            'objStream.Close()

            '            'Dim parmData As New Oracle.DataAccess.Client.OracleParameter
            '            'With parmData
            '            ' .Direction = Data.ParameterDirection.Input
            '            '.OracleDbType = Oracle.DataAccess.Client.OracleDbType.Blob
            '            '.ParameterName = "TESTO"
            '            '.Value = Buffer
            '            'End With

            '            'par.cmd.Parameters.Add(parmData)
            '            'par.cmd.ExecuteNonQuery()
            '            'System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt"))
            '            'par.cmd.Parameters.Remove(parmData)

            '            'Buffer = Nothing
            '            'objStream = Nothing

            '            'Else
            '            'SstringaSql = SstringaSql & "<font size='1' face='arial'>Le variazioni al canone corrente saranno applicate dopo la verifica da parte del Comune di Milano.</font>"
            '            'End If
            '        End If


            '    End If


            'End If
            ''If ESCLUSIONE = "" Then
            ''    If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = 3 Then

            ''        cmbAccolta.ClearSelection()
            ''        cmbAccolta.Items.FindByText("SI").Selected = True
            ''        cmbAccolta.Enabled = False

            ''        Dim IMPORTO As Double = 0
            ''        Dim LOCATIVO As String = ""
            ''        Dim IDUNITA As Long = 0
            ''        Dim comunicazioni As String = ""
            ''        Dim AreaEconomica As Integer = 0



            ''        par.cmd.CommandText = "SELECT ID FROM SISCOM_MI.UNITA_IMMOBILIARI WHERE COD_UNITA_IMMOBILIARE='" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "'"
            ''        Dim myReader1234 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            ''        If myReader1234.Read() Then
            ''            IDUNITA = par.IfNull(myReader1234("ID"), 0)
            ''        End If
            ''        myReader1234.Close()

            ''        Dim TestoFile As String = Replace(par.CalcolaCanone27(CDbl(HiddenID.Value), 3, IDUNITA, Request.QueryString("COD"), IMPORTO, LOCATIVO, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone), "CALCOLO CANONE L.R. 27/07", "CALCOLO CANONE L.R. 27/07 E L.R. 36/2008")

            ''        SstringaSql = SstringaSql & "<p style='page-break-after: always' class='mini'><font face='Arial' size='2'>&nbsp;</font></p>" & vbCrLf
            ''        SstringaSql = SstringaSql & "<font size='2' face='Courier New'>" & Replace(TestoFile, vbCrLf, "</br>") & "</font></br></br>"

            ''        If IMPORTO = 0 Then
            ''            cmbAccolta.ClearSelection()
            ''            cmbAccolta.Items.FindByText("-").Selected = True
            ''            cmbAccolta.Enabled = True
            ''        Else
            ''            'operazioni aggiornamento canone
            ''            Dim CanoneCorrente As Double = 0
            ''            Dim idc As Long = 0


            ''            par.cmd.CommandText = "SELECT imp_canone_iniziale,id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            ''            Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            ''            If myReaderX1.Read Then
            ''                CanoneCorrente = par.IfNull(myReaderX1(0), 0)
            ''                idc = myReaderX1("id")
            ''            End If
            ''            myReaderX1.Close()

            ''            par.cmd.CommandText = "select SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE ID_CONTRATTO=" & idc
            ''            myReaderX1 = par.cmd.ExecuteReader()
            ''            If myReaderX1.Read Then
            ''                CanoneCorrente = CanoneCorrente + par.IfNull(myReaderX1(0), 0)
            ''            End If
            ''            myReaderX1.Close()

            ''            If contrattodialer.Value = "0" Then
            ''                Response.Write("<script>alert('ATTENZIONE...Trattasi di contratto NON STIPULATO dal Gestore, si prega di porre particolare attenzione!');</script>")
            ''            End If

            ''            'If contrattodialer.Value = "1" Then
            ''            SstringaSql = SstringaSql & "<font size='2' face='Courier New'>CANONE ANNUO ATTUALE (comprensivo agg.ISTAT):............." & Format(CanoneCorrente, "##,##0.00") & "</br>"
            ''            SstringaSql = SstringaSql & "CANONE MENSILE ATTUALE...................................." & Format(CanoneCorrente / 12, "##,##0.00") & "</br>"
            ''            SstringaSql = SstringaSql & "NUOVO CANONE MENSILE PROVVISORIO *........................<B>" & Format(IMPORTO / 12, "##,##0.00") & "</B></br>"

            ''            If CanoneCorrente > IMPORTO Then
            ''                SstringaSql = SstringaSql & "RIDUZIONE DA APPLICARE...................................." & Format(((CanoneCorrente - IMPORTO) * 100) / CanoneCorrente, "0.00") & "%</br>"
            ''                ' SstringaSql = SstringaSql & "RIDUZIONE ANNUA IN BOLLETTA .............................." & Format((CanoneCorrente - IMPORTO), "##,##0.00") & "</br>"
            ''                SstringaSql = SstringaSql & "RIDUZIONE MENSILE IN BOLLETTA ............................" & Format(((CanoneCorrente - IMPORTO) / 12), "##,##0.00") & "</font></br></br>"
            ''            Else
            ''                SstringaSql = SstringaSql & "AUMENTO DA APPLICARE...................................." & Format((((CanoneCorrente - IMPORTO) * 100) / CanoneCorrente) * -1, "0.00") & "%</br>"
            ''                'SstringaSql = SstringaSql & "AUMENTO ANNUA IN BOLLETTA .............................." & Format((CanoneCorrente - IMPORTO) * -1, "##,##0.00") & "</br>"
            ''                SstringaSql = SstringaSql & "AUMENTO MENSILE IN BOLLETTA ............................" & Format(((CanoneCorrente - IMPORTO) / 12) * -1, "##,##0.00") & "</font></br></br>"
            ''            End If

            ''            TestoFile = TestoFile & vbCrLf & vbCrLf & "CANONE ANNUO ATTUALE (comprensivo agg.ISTAT):............." & Format(CanoneCorrente, "##,##0.00") & vbCrLf
            ''            TestoFile = TestoFile & "CANONE MENSILE ATTUALE...................................." & Format(CanoneCorrente / 12, "##,##0.00") & vbCrLf
            ''            TestoFile = TestoFile & "NUOVO CANONE MENSILE PROVVISORIO *........................" & Format(IMPORTO / 12, "##,##0.00") & vbCrLf

            ''            If CanoneCorrente > IMPORTO Then
            ''                TestoFile = TestoFile & "RIDUZIONE DA APPLICARE...................................." & Format(((CanoneCorrente - IMPORTO) * 100) / CanoneCorrente, "0.00") & "%" & vbCrLf
            ''                'TestoFile = TestoFile & "RIDUZIONE ANNUA IN BOLLETTA .............................." & Format((CanoneCorrente - IMPORTO), "##,##0.00") & vbCrLf
            ''                TestoFile = TestoFile & "RIDUZIONE MENSILE IN BOLLETTA .............................." & Format(((CanoneCorrente - IMPORTO) / 12), "##,##0.00") & vbCrLf
            ''            Else
            ''                TestoFile = TestoFile & "AUMENTO DA APPLICARE......................................" & Format((((CanoneCorrente - IMPORTO) * 100) / CanoneCorrente) * -1, "0.00") & "%" & vbCrLf
            ''                'TestoFile = TestoFile & "AUMENTO ANNUA IN BOLLETTA .............................." & Format((CanoneCorrente - IMPORTO) * -1, "##,##0.00") & vbCrLf
            ''                TestoFile = TestoFile & "AUMENTO MENSILE IN BOLLETTA .............................." & Format(((CanoneCorrente - IMPORTO) / 12) * -1, "##,##0.00") & vbCrLf
            ''            End If

            ''            par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET IMP_CANONE_PROVV=" & par.VirgoleInPunti(IMPORTO) & " WHERE ID=" & idc
            ''            par.cmd.ExecuteNonQuery()

            ''            par.cmd.CommandText = "delete from siscom_mi.bol_schema where id_voce=675 and id_contratto=" & idc & " and anno=" & Year(Now)
            ''            par.cmd.ExecuteNonQuery()

            ''            If CanoneCorrente > IMPORTO Then
            ''                par.cmd.CommandText = "insert into siscom_mi.bol_schema values (siscom_mi.seq_bol_schema.nextval," & idc & "," & IDUNITA & "," & par.RicavaEsercizioCorrente & ",675," & par.VirgoleInPunti(Format((CanoneCorrente - IMPORTO) * -1, "0.00")) & ",1,12," & par.VirgoleInPunti(Format(((CanoneCorrente - IMPORTO) * -1) / 12, "0.00")) & "," & Year(Now) & ")"
            ''                par.cmd.ExecuteNonQuery()
            ''            Else
            ''                par.cmd.CommandText = "insert into siscom_mi.bol_schema values (siscom_mi.seq_bol_schema.nextval," & idc & "," & IDUNITA & "," & par.RicavaEsercizioCorrente & ",675," & par.VirgoleInPunti(Format((IMPORTO - CanoneCorrente), "0.00")) & ",1,12," & par.VirgoleInPunti(Format(((IMPORTO - CanoneCorrente)) / 12, "0.00")) & "," & Year(Now) & ")"
            ''                par.cmd.ExecuteNonQuery()
            ''            End If

            ''            par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) VALUES (" & idc & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','F02','INSERITA VOCE RIDUZIONE CANONE LOCAZIONE NELLO SCHEMA DI EURO " & par.VirgoleInPunti(Format(((IMPORTO - CanoneCorrente)) / 12, "0.00")) & "')"
            ''            par.cmd.ExecuteNonQuery()

            ''            If CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text <> "" Then
            ''                Dim NumBollette As Integer = 0
            ''                Dim NumBollettePagate As Integer = 0

            ''                par.cmd.CommandText = "select * from siscom_mi.bol_bollette where data_emissione>" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) & " and id_contratto=" & idc & " and fl_annullata='0'"
            ''                myReaderX1 = par.cmd.ExecuteReader()
            ''                Do While myReaderX1.Read
            ''                    NumBollette = NumBollette + 1
            ''                Loop
            ''                myReaderX1.Close()

            ''                par.cmd.CommandText = "select * from siscom_mi.bol_bollette where data_pagamento is not null and data_emissione>" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) & " and id_contratto=" & idc & " and fl_annullata='0'"
            ''                myReaderX1 = par.cmd.ExecuteReader()
            ''                Do While myReaderX1.Read
            ''                    NumBollettePagate = NumBollettePagate + 1
            ''                Loop

            ''                If NumBollette > 0 Then
            ''                    SstringaSql = SstringaSql & "<br /><font size='2' face='arial'><strong>CREDITO TEORICO</strong><br />Dalla data di presentazione della richiesta, " & CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text & ", al " & Format(Now, "dd/MM/yyyyy") & ", sono state emesse n. " & NumBollette & " bollette mensili (di cui pagate n. " & NumBollettePagate & ") a carico dell'inquilino. Il credito teorico, salvo verifiche, ammonta a euro " & Format(NumBollette * ((CanoneCorrente - IMPORTO) / 12), "##,##0.00") & ".</font>"
            ''                    TestoFile = TestoFile & vbCrLf & "CREDITO TEORICO" & vbCrLf & "Dalla data di presentazione della richiesta, " & CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text & ", al " & Format(Now, "dd/MM/yyyyy") & ", sono state emesse n. " & NumBollette & " bollette mensili (di cui pagate n. " & NumBollettePagate & ") a carico dell'inquilino. Il credito teorico, salvo verifiche, ammonta a euro " & Format(NumBollette * ((CanoneCorrente - IMPORTO) / 12), "##,##0.00") & "."
            ''                End If
            ''                myReaderX1.Close()
            ''            End If

            ''            SstringaSql = SstringaSql & "<br /><br /><font size='1' face='arial'>* Il nuovo canone mensile indicato ha carattere di provvisorietà ed è da intendersi valido fino all'applicazione della prossima Anagrafe dell’Utenza. <br />Nel corso della stessa Anagrafe dell’Utenza la situazione economica presunta, dichiarata ai fini della presente istanza, sarà oggetto di revisione sulla base dei dati economici definitivi del nucleo familiare ed il canone provvisorio  sarà soggetto a conguaglio.<br />Il canone provvisorio sarà applicato automaticamente dalla prossima bollettazione bimestrale utile. </font>"
            ''            TestoFile = TestoFile & vbCrLf & vbCrLf & "* Il nuovo canone mensile indicato ha carattere di provvisorieta' ed è da intendersi valido fino all'applicazione della prossima Anagrafe dell'Utenza." & vbCrLf & "Nel corso della stessa Anagrafe dell'Utenza la situazione economica presunta, dichiarata ai fini della presente istanza, sara' oggetto di revisione sulla base dei dati economici definitivi del nucleo familiare ed il canone provvisorio  sara' soggetto a conguaglio." & vbCrLf & "Il canone provvisorio sara' applicato automaticamente dalla prossima bollettazione bimestrale utile."


            ''            Dim fileName As String = CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt"

            ''            If System.IO.File.Exists(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt")) = True Then
            ''                System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt"))
            ''            End If

            ''            Dim sr As StreamWriter = New StreamWriter(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, False, System.Text.Encoding.Default)
            ''            sr.WriteLine(TestoFile)
            ''            sr.Close()

            ''            par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,TESTO) " _
            ''                               & "VALUES (" & idc & ",'" & Format(My.Computer.FileSystem.GetFileInfo(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt")).CreationTime, "yyyyMMddhhmmss") & "'," & AreaEconomica & ",'" & sISEE & "',:TESTO) "


            ''            Dim objStream As Stream = File.Open(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt"), FileMode.Open)
            ''            Dim buffer(objStream.Length) As Byte
            ''            objStream.Read(buffer, 0, objStream.Length)
            ''            objStream.Close()

            ''            Dim parmData As New Oracle.DataAccess.Client.OracleParameter
            ''            With parmData
            ''                .Direction = Data.ParameterDirection.Input
            ''                .OracleDbType = Oracle.DataAccess.Client.OracleDbType.Blob
            ''                .ParameterName = "TESTO"
            ''                .Value = buffer
            ''            End With

            ''            par.cmd.Parameters.Add(parmData)
            ''            par.cmd.ExecuteNonQuery()
            ''            System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt"))
            ''            par.cmd.Parameters.Remove(parmData)

            ''            buffer = Nothing
            ''            objStream = Nothing

            ''            'Else
            ''            'SstringaSql = SstringaSql & "<font size='1' face='arial'>Le variazioni al canone corrente saranno applicate dopo la verifica da parte del Comune di Milano.</font>"
            ''            'End If
            ''        End If


            ''    End If

            ''    If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = 5 Then
            ''        cmbAccolta.ClearSelection()
            ''        cmbAccolta.Items.FindByText("SI").Selected = True
            ''        cmbAccolta.Enabled = False
            ''    End If


            ''Else
            ''    If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = 5 Then
            ''        cmbAccolta.ClearSelection()
            ''        cmbAccolta.Items.FindByText("NO").Selected = True
            ''        cmbAccolta.Enabled = False
            ''    End If

            ''    If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = 3 Then
            ''        cmbAccolta.ClearSelection()
            ''        cmbAccolta.Items.FindByText("NO").Selected = True
            ''        cmbAccolta.Enabled = False

            ''        Dim idc As Long = 0


            ''        par.cmd.CommandText = "SELECT imp_canone_iniziale,id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            ''        Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            ''        If myReaderX1.Read Then
            ''            idc = myReaderX1("id")
            ''        End If
            ''        myReaderX1.Close()

            ''        par.cmd.CommandText = "delete from siscom_mi.bol_schema where id_voce=675 and id_contratto=" & idc & " and anno=" & Year(Now)
            ''        par.cmd.ExecuteNonQuery()

            ''    End If
            ''End If

            If CType(Dom_Decisioni1.FindControl("autorizzFinale"), HiddenField).Value = 0 And tipoRichiesta.Value <> 4 Then
                lIndice_Bando = glIndice_Bando_Origine
                If Fl_DerogaInCorso = "" Then
                    If ESCLUSIONE = "" Then
                        If tipoRichiesta.Value <> 5 Then
                            If FL_VECCHIO_BANDO = "1" Then
                                sStato = "8"
                                par.cmd.CommandText = "update domande_bando_vsa set FL_CONTROLLA_REQUISITI='2',FL_ASS_ESTERNA='1', FL_COMPLETA='1',FL_RINNOVO='0'," _
                                                        & "ID_VECCHIO_STATO='',ID_TIPO_CONTENZIOSO=NULL," _
                                                        & "FL_ISTRUTTORIA_COMPLETA='1',ID_STATO='8'," _
                                                        & "FL_ESAMINATA='1',ISE_ERP=" & par.VirgoleInPunti(ISE_ERP) _
                                                        & ",ISR_ERP=" & par.VirgoleInPunti(ISR_ERP) & ",ISP_ERP=" _
                                                        & par.VirgoleInPunti(ISP_ERP) & ",REDDITO_ISEE=" _
                                                        & par.VirgoleInPunti(ISEE_ERP) & ", TIPO_ALLOGGIO=" _
                                                        & TIPO_ALLOGGIO & ",ISBARC=" & "0" _
                                                        & ",ISBAR=" & "0" & ",ISBARC_R=" _
                                                        & "0" & ",DISAGIO_A=" _
                                                        & "0" & ",DISAGIO_F=" _
                                                        & "0" & ",DISAGIO_E=" _
                                                        & "0" & ",PSE='" & PARAMETRO & "',VSE='" & VSE & "' WHERE ID=" & lIdDomanda


                            Else
                                sStato = "8"
                                par.cmd.CommandText = "update domande_bando_vsa set FL_CONTROLLA_REQUISITI='2',FL_ASS_ESTERNA='1',FL_COMPLETA='1',FL_RINNOVO='0'," _
                                                        & "ID_VECCHIO_STATO='',ID_TIPO_CONTENZIOSO=NULL," _
                                                        & "FL_ISTRUTTORIA_COMPLETA='1',ID_STATO='8'," _
                                                        & "FL_ESAMINATA='1',ISE_ERP=" & par.VirgoleInPunti(ISE_ERP) _
                                                        & ",ISR_ERP=" & par.VirgoleInPunti(ISR_ERP) & ",ISP_ERP=" _
                                                        & par.VirgoleInPunti(ISP_ERP) & ",REDDITO_ISEE=" _
                                                        & par.VirgoleInPunti(ISEE_ERP) & ", TIPO_ALLOGGIO=" _
                                                        & TIPO_ALLOGGIO & ",ISBARC=" & "0" _
                                                         & ",ISBAR=" & "0" & ",ISBARC_R=" _
                                                        & "0" & ",DISAGIO_A=" _
                                                        & "0" & ",DISAGIO_F=" _
                                                        & "0" & ",DISAGIO_E=" _
                                                        & "0" & ",PSE='" & PARAMETRO & "',VSE='" & VSE & "' WHERE ID=" & lIdDomanda
                                'End If
                            End If
                            par.cmd.ExecuteNonQuery()
                        Else
                            sStato = "4"
                            par.cmd.CommandText = "update domande_bando_vsa set FL_CONTROLLA_REQUISITI='2',FL_ASS_ESTERNA='1',FL_COMPLETA='1',FL_RINNOVO='0'," _
                               & "ID_VECCHIO_STATO='',ID_TIPO_CONTENZIOSO=NULL," _
                               & "FL_ISTRUTTORIA_COMPLETA='1',ID_STATO='4'," _
                               & "FL_ESAMINATA='1',ISE_ERP=" & par.VirgoleInPunti(ISE_ERP) _
                               & ",ISR_ERP=" & par.VirgoleInPunti(ISR_ERP) _
                               & ",ISP_ERP=" & par.VirgoleInPunti(ISP_ERP) _
                               & ",REDDITO_ISEE=" & par.VirgoleInPunti(ISEE_ERP) _
                               & ",TIPO_ALLOGGIO=" & TIPO_ALLOGGIO _
                               & ",ISBARC=" & "0" _
                               & ",ISBAR=" & "0" _
                               & ",ISBARC_R=" & "0" _
                               & ",DISAGIO_A=" & "0" _
                               & ",DISAGIO_F=" & "0" _
                               & ",DISAGIO_E=" & "0" _
                               & ",PSE='" & PARAMETRO & "',VSE='" & VSE & "' WHERE ID=" & lIdDomanda
                            par.cmd.ExecuteNonQuery()
                        End If
                    Else
                        sStato = "4"
                        par.cmd.CommandText = "update domande_bando_vsa set FL_CONTROLLA_REQUISITI='2',FL_ASS_ESTERNA='1',FL_COMPLETA='1',FL_RINNOVO='0'," _
                                                   & "ID_VECCHIO_STATO='',ID_TIPO_CONTENZIOSO=NULL," _
                                                   & "FL_ISTRUTTORIA_COMPLETA='1',ID_STATO='4'," _
                                                   & "FL_ESAMINATA='1',ISE_ERP=" & par.VirgoleInPunti(ISE_ERP) _
                                                   & ",ISR_ERP=" & par.VirgoleInPunti(ISR_ERP) _
                                                   & ",ISP_ERP=" & par.VirgoleInPunti(ISP_ERP) _
                                                   & ",REDDITO_ISEE=" & par.VirgoleInPunti(ISEE_ERP) _
                                                   & ",TIPO_ALLOGGIO=" & TIPO_ALLOGGIO _
                                                   & ",ISBARC=" & "0" _
                                                   & ",ISBAR=" & "0" _
                                                   & ",ISBARC_R=" & "0" _
                                                   & ",DISAGIO_A=" & "0" _
                                                   & ",DISAGIO_F=" & "0" _
                                                   & ",DISAGIO_E=" & "0" _
                                                   & ",PSE='" & PARAMETRO & "',VSE='" & VSE & "' WHERE ID=" & lIdDomanda
                        par.cmd.ExecuteNonQuery()
                    End If
                Else
                    ''in caso di deroga in corso
                    If ESCLUSIONE = "" Then
                        If FL_RINNOVO = "0" Then
                            par.cmd.CommandText = "update domande_bando_vsa set  FL_CONTROLLA_REQUISITI='2',FL_ASS_ESTERNA='1',FL_COMPLETA='1',FL_RINNOVO='0'," _
                                                    & "ISE_ERP=" & par.VirgoleInPunti(ISE_ERP) _
                                                    & ",ISR_ERP=" & par.VirgoleInPunti(ISR_ERP) & ",ISP_ERP=" _
                                                    & par.VirgoleInPunti(ISP_ERP) & ",REDDITO_ISEE=" _
                                                    & par.VirgoleInPunti(ISEE_ERP) & ", TIPO_ALLOGGIO=" _
                                                    & TIPO_ALLOGGIO & ",ISBARC=" & "0" _
                                                    & ",ISBAR=" & "0" & ",ISBARC_R=" _
                                                    & "0" & ",DISAGIO_A=" _
                                                    & "0" & ",DISAGIO_F=" _
                                                    & "0" & ",DISAGIO_E=" _
                                                    & "0" & ",PSE='" & PARAMETRO & "',VSE='" & VSE & "' WHERE ID=" & lIdDomanda
                        Else
                            par.cmd.CommandText = "update domande_bando_vsa set FL_CONTROLLA_REQUISITI='2',FL_ASS_ESTERNA='1', FL_COMPLETA='1',FL_RINNOVO='0'," _
                                                    & "ISE_ERP=" & par.VirgoleInPunti(ISE_ERP) _
                                                    & ",ISR_ERP=" & par.VirgoleInPunti(ISR_ERP) & ",ISP_ERP=" _
                                                    & par.VirgoleInPunti(ISP_ERP) & ",REDDITO_ISEE=" _
                                                    & par.VirgoleInPunti(ISEE_ERP) & ", TIPO_ALLOGGIO=" _
                                                    & TIPO_ALLOGGIO & ",ISBARC=" & "0" _
                                                     & ",ISBAR=" & "0" & ",ISBARC_R=" _
                                                    & "0" & ",DISAGIO_A=" _
                                                    & "0" & ",DISAGIO_F=" _
                                                    & "0" & ",DISAGIO_E=" _
                                                    & "0" & ",PSE='" & PARAMETRO & "',VSE='" & VSE & "' WHERE ID=" & lIdDomanda
                        End If
                        par.cmd.ExecuteNonQuery()
                    Else
                        par.cmd.CommandText = "update domande_bando_vsa set  FL_CONTROLLA_REQUISITI='2',FL_ASS_ESTERNA='1',FL_COMPLETA='1',FL_RINNOVO='0'," _
                                                   & "ISE_ERP=" & par.VirgoleInPunti(ISE_ERP) _
                                                   & ",ISR_ERP=" & par.VirgoleInPunti(ISR_ERP) _
                                                   & ",ISP_ERP=" & par.VirgoleInPunti(ISP_ERP) _
                                                   & ",REDDITO_ISEE=" & par.VirgoleInPunti(ISEE_ERP) _
                                                   & ",TIPO_ALLOGGIO=" & TIPO_ALLOGGIO _
                                                   & ",ISBARC=" & "0" _
                                                   & ",ISBAR=" & "0" _
                                                   & ",ISBARC_R=" & "0" _
                                                   & ",DISAGIO_A=0" _
                                                   & ",DISAGIO_F=0" _
                                                   & ",DISAGIO_E=0" _
                                                   & ",PSE='" & PARAMETRO & "',VSE='" & VSE & "' WHERE ID=" & lIdDomanda
                        par.cmd.ExecuteNonQuery()
                    End If

                End If
            End If


            If ESCLUSIONE = "" Then
                If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = 3 Then

                    '    'cmbAccolta.ClearSelection()
                    '    'cmbAccolta.Items.FindByText("SI").Selected = True
                    '    'cmbAccolta.Enabled = False

                    '    Dim IMPORTO As Double = 0
                    '    Dim LOCATIVO As String = ""
                    '    Dim IDUNITA As Long = 0
                    '    Dim comunicazioni As String = ""
                    '    Dim AreaEconomica As Integer = 0



                    '    par.cmd.CommandText = "SELECT ID FROM SISCOM_MI.UNITA_IMMOBILIARI WHERE COD_UNITA_IMMOBILIARE='" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "'"
                    '    Dim myReader1234 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    '    If myReader1234.Read() Then
                    '        IDUNITA = par.IfNull(myReader1234("ID"), 0)
                    '    End If
                    '    myReader1234.Close()

                    '    Dim TestoFile As String = Replace(par.CalcolaCanone27(CDbl(HiddenID.Value), 3, IDUNITA, Request.QueryString("COD"), IMPORTO, LOCATIVO, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPIANO, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL), "CALCOLO CANONE L.R. 27/07", "CALCOLO CANONE L.R. 27/07 E L.R. 36/2008")

                    '    SstringaSql = SstringaSql & "<p style='page-break-after: always' class='mini'><font face='Arial' size='2'>&nbsp;</font></p>" & vbCrLf
                    '    SstringaSql = SstringaSql & "<font size='2' face='Courier New'>" & Replace(TestoFile, vbCrLf, "</br>") & "</font></br></br>"

                    '    If IMPORTO = 0 Then
                    '        'cmbAccolta.ClearSelection()
                    '        'cmbAccolta.Items.FindByText("-").Selected = True
                    '        'cmbAccolta.Enabled = True
                    '    Else
                    '        'operazioni aggiornamento canone
                    '        Dim CanoneCorrente As Double = 0
                    '        Dim idc As Long = 0


                    '        par.cmd.CommandText = "SELECT imp_canone_iniziale,id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
                    '        Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    '        If myReaderX1.Read Then
                    '            CanoneCorrente = par.IfNull(myReaderX1(0), 0)
                    '            idc = myReaderX1("id")
                    '        End If
                    '        myReaderX1.Close()

                    '        par.cmd.CommandText = "select SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE ID_CONTRATTO=" & idc
                    '        myReaderX1 = par.cmd.ExecuteReader()
                    '        If myReaderX1.Read Then
                    '            CanoneCorrente = CanoneCorrente + par.IfNull(myReaderX1(0), 0)
                    '        End If
                    '        myReaderX1.Close()

                    '        If contrattodialer.Value = "0" Then
                    '            Response.Write("<script>alert('ATTENZIONE...Trattasi di contratto NON STIPULATO dal Gestore!');</script>")
                    '        End If

                    '        'If contrattodialer.Value = "1" Then
                    '        SstringaSql = SstringaSql & "<font size='2' face='Courier New'>CANONE ANNUO ATTUALE (comprensivo agg.ISTAT):............." & Format(CanoneCorrente, "##,##0.00") & "</br>"
                    '        SstringaSql = SstringaSql & "CANONE MENSILE ATTUALE...................................." & Format(CanoneCorrente / 12, "##,##0.00") & "</br>"
                    '        SstringaSql = SstringaSql & "NUOVO CANONE MENSILE PROVVISORIO *........................<B>" & Format(IMPORTO / 12, "##,##0.00") & "</B></br>"

                    '        If CanoneCorrente > IMPORTO Then
                    '            SstringaSql = SstringaSql & "RIDUZIONE DA APPLICARE...................................." & Format(((CanoneCorrente - IMPORTO) * 100) / CanoneCorrente, "0.00") & "%</br>"
                    '            ' SstringaSql = SstringaSql & "RIDUZIONE ANNUA IN BOLLETTA .............................." & Format((CanoneCorrente - IMPORTO), "##,##0.00") & "</br>"
                    '            SstringaSql = SstringaSql & "RIDUZIONE MENSILE IN BOLLETTA ............................" & Format(((CanoneCorrente - IMPORTO) / 12), "##,##0.00") & "</font></br></br>"
                    '        Else
                    '            SstringaSql = SstringaSql & "AUMENTO DA APPLICARE...................................." & Format((((CanoneCorrente - IMPORTO) * 100) / CanoneCorrente) * -1, "0.00") & "%</br>"
                    '            'SstringaSql = SstringaSql & "AUMENTO ANNUA IN BOLLETTA .............................." & Format((CanoneCorrente - IMPORTO) * -1, "##,##0.00") & "</br>"
                    '            SstringaSql = SstringaSql & "AUMENTO MENSILE IN BOLLETTA ............................" & Format(((CanoneCorrente - IMPORTO) / 12) * -1, "##,##0.00") & "</font></br></br>"
                    '        End If

                    '        TestoFile = TestoFile & vbCrLf & vbCrLf & "CANONE ANNUO ATTUALE (comprensivo agg.ISTAT):............." & Format(CanoneCorrente, "##,##0.00") & vbCrLf
                    '        TestoFile = TestoFile & "CANONE MENSILE ATTUALE...................................." & Format(CanoneCorrente / 12, "##,##0.00") & vbCrLf
                    '        TestoFile = TestoFile & "NUOVO CANONE MENSILE PROVVISORIO *........................" & Format(IMPORTO / 12, "##,##0.00") & vbCrLf

                    '        If CanoneCorrente > IMPORTO Then
                    '            TestoFile = TestoFile & "RIDUZIONE DA APPLICARE...................................." & Format(((CanoneCorrente - IMPORTO) * 100) / CanoneCorrente, "0.00") & "%" & vbCrLf
                    '            'TestoFile = TestoFile & "RIDUZIONE ANNUA IN BOLLETTA .............................." & Format((CanoneCorrente - IMPORTO), "##,##0.00") & vbCrLf
                    '            TestoFile = TestoFile & "RIDUZIONE MENSILE IN BOLLETTA .............................." & Format(((CanoneCorrente - IMPORTO) / 12), "##,##0.00") & vbCrLf
                    '        Else
                    '            TestoFile = TestoFile & "AUMENTO DA APPLICARE......................................" & Format((((CanoneCorrente - IMPORTO) * 100) / CanoneCorrente) * -1, "0.00") & "%" & vbCrLf
                    '            'TestoFile = TestoFile & "AUMENTO ANNUA IN BOLLETTA .............................." & Format((CanoneCorrente - IMPORTO) * -1, "##,##0.00") & vbCrLf
                    '            TestoFile = TestoFile & "AUMENTO MENSILE IN BOLLETTA .............................." & Format(((CanoneCorrente - IMPORTO) / 12) * -1, "##,##0.00") & vbCrLf
                    '        End If

                    '        'par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET IMP_CANONE_PROVV=" & par.VirgoleInPunti(IMPORTO) & " WHERE ID=" & idc
                    '        'par.cmd.ExecuteNonQuery()

                    '        'par.cmd.CommandText = "delete from siscom_mi.bol_schema where id_voce=675 and id_contratto=" & idc & " and anno=" & Year(Now)
                    '        'par.cmd.ExecuteNonQuery()

                    '        'If CanoneCorrente > IMPORTO Then
                    '        'par.cmd.CommandText = "insert into siscom_mi.bol_schema values (siscom_mi.seq_bol_schema.nextval," & idc & "," & IDUNITA & "," & par.RicavaEsercizioCorrente & ",675," & par.VirgoleInPunti(Format((CanoneCorrente - IMPORTO) * -1, "0.00")) & ",1,12," & par.VirgoleInPunti(Format(((CanoneCorrente - IMPORTO) * -1) / 12, "0.00")) & "," & Year(Now) & ")"
                    '        'par.cmd.ExecuteNonQuery()
                    '        'Else
                    '        'par.cmd.CommandText = "insert into siscom_mi.bol_schema values (siscom_mi.seq_bol_schema.nextval," & idc & "," & IDUNITA & "," & par.RicavaEsercizioCorrente & ",675," & par.VirgoleInPunti(Format((IMPORTO - CanoneCorrente), "0.00")) & ",1,12," & par.VirgoleInPunti(Format(((IMPORTO - CanoneCorrente)) / 12, "0.00")) & "," & Year(Now) & ")"
                    '        'par.cmd.ExecuteNonQuery()
                    '        'End If

                    '        'par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) VALUES (" & idc & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','F02','INSERITA VOCE RIDUZIONE CANONE LOCAZIONE NELLO SCHEMA DI EURO " & par.VirgoleInPunti(Format(((IMPORTO - CanoneCorrente)) / 12, "0.00")) & "')"
                    '        'par.cmd.ExecuteNonQuery()

                    '        If CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text <> "" Then
                    '            Dim NumBollette As Integer = 0
                    '            Dim NumBollettePagate As Integer = 0

                    '            par.cmd.CommandText = "select * from siscom_mi.bol_bollette where data_emissione>" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) & " and id_contratto=" & idc & " and fl_annullata='0'"
                    '            myReaderX1 = par.cmd.ExecuteReader()
                    '            Do While myReaderX1.Read
                    '                NumBollette = NumBollette + 1
                    '            Loop
                    '            myReaderX1.Close()

                    '            par.cmd.CommandText = "select * from siscom_mi.bol_bollette where data_pagamento is not null and data_emissione>" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) & " and id_contratto=" & idc & " and fl_annullata='0'"
                    '            myReaderX1 = par.cmd.ExecuteReader()
                    '            Do While myReaderX1.Read
                    '                NumBollettePagate = NumBollettePagate + 1
                    '            Loop

                    '            If NumBollette > 0 Then
                    '                Dim tipo As String = "DEBITO"
                    '                If NumBollette * ((CanoneCorrente - IMPORTO) / 12) < 0 Then
                    '                    tipo = "CREDITO"
                    '                End If
                    '                SstringaSql = SstringaSql & "<br /><font size='2' face='arial'><strong>" & tipo & " TEORICO</strong><br />Dalla data di presentazione della richiesta, " & CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text & ", al " & Format(Now, "dd/MM/yyyyy") & ", sono state emesse n. " & NumBollette & " bollette mensili (di cui pagate n. " & NumBollettePagate & ") a carico dell'inquilino. Il " & tipo & " teorico, salvo verifiche, ammonta a euro " & Format(Math.Abs(NumBollette * ((CanoneCorrente - IMPORTO) / 12)), "##,##0.00") & ".</font>"
                    '                TestoFile = TestoFile & vbCrLf & "" & tipo & " TEORICO" & vbCrLf & "Dalla data di presentazione della richiesta, " & CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text & ", al " & Format(Now, "dd/MM/yyyyy") & ", sono state emesse n. " & NumBollette & " bollette mensili (di cui pagate n. " & NumBollettePagate & ") a carico dell'inquilino. Il " & tipo & " teorico, salvo verifiche, ammonta a euro " & Format(Math.Abs(NumBollette * ((CanoneCorrente - IMPORTO) / 12)), "##,##0.00") & "."
                    '            End If
                    '            myReaderX1.Close()
                    '        End If

                    '        SstringaSql = SstringaSql & "<br /><br /><font size='1' face='arial'>* Il nuovo canone mensile indicato ha carattere di provvisorietà ed è da intendersi valido fino all'applicazione della prossima Anagrafe dell’Utenza. <br />Nel corso della stessa Anagrafe dell’Utenza la situazione economica presunta, dichiarata ai fini della presente istanza, sarà oggetto di revisione sulla base dei dati economici definitivi del nucleo familiare ed il canone provvisorio  sarà soggetto a conguaglio.<br />Il canone provvisorio sarà applicato automaticamente dalla prossima bollettazione bimestrale utile. </font>"
                    '        TestoFile = TestoFile & vbCrLf & vbCrLf & "* Il nuovo canone mensile indicato ha carattere di provvisorieta' ed è da intendersi valido fino all'applicazione della prossima Anagrafe dell'Utenza." & vbCrLf & "Nel corso della stessa Anagrafe dell'Utenza la situazione economica presunta, dichiarata ai fini della presente istanza, sara' oggetto di revisione sulla base dei dati economici definitivi del nucleo familiare ed il canone provvisorio  sara' soggetto a conguaglio." & vbCrLf & "Il canone provvisorio sara' applicato automaticamente dalla prossima bollettazione bimestrale utile."


                    '        'Dim fileName As String = CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt"

                    '        'If System.IO.File.Exists(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt")) = True Then
                    '        'System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt"))
                    '        'End If

                    '        'Dim sr As StreamWriter = New StreamWriter(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, False, System.Text.Encoding.Default)
                    '        'sr.WriteLine(TestoFile)
                    '        'sr.Close()

                    '        'par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,TESTO) " _
                    '        '                   & "VALUES (" & idc & ",'" & Format(My.Computer.FileSystem.GetFileInfo(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt")).CreationTime, "yyyyMMddhhmmss") & "'," & AreaEconomica & ",'" & sISEE & "',:TESTO) "


                    '        'Dim objStream As Stream = File.Open(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt"), FileMode.Open)
                    '        'Dim buffer(objStream.Length) As Byte
                    '        'objStream.Read(buffer, 0, objStream.Length)
                    '        'objStream.Close()

                    '        'Dim parmData As New Oracle.DataAccess.Client.OracleParameter
                    '        'With parmData
                    '        ' .Direction = Data.ParameterDirection.Input
                    '        '.OracleDbType = Oracle.DataAccess.Client.OracleDbType.Blob
                    '        '.ParameterName = "TESTO"
                    '        '.Value = Buffer
                    '        'End With

                    '        'par.cmd.Parameters.Add(parmData)
                    '        'par.cmd.ExecuteNonQuery()
                    '        'System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ".txt"))
                    '        'par.cmd.Parameters.Remove(parmData)

                    '        'Buffer = Nothing
                    '        'objStream = Nothing

                    '        'Else
                    '        'SstringaSql = SstringaSql & "<font size='1' face='arial'>Le variazioni al canone corrente saranno applicate dopo la verifica da parte del Comune di Milano.</font>"
                    '        'End If
                    '    End If


                End If


            End If



            SstringaSql = SstringaSql & "<br/><br/><br/><br/><table><tr><td width='80%'>&nbsp</td><td align='center'><b>FIRMA RICHIEDENTE</b><br/><font face='Arial' size='2'><br/><br/>_____________________________</td></font></tr>"
            SstringaSql = SstringaSql & "</BODY>" & vbCrLf
            HttpContext.Current.Session.Add("DOMANDA", SstringaSql)
            If tipoRichiesta.Value = 3 Or tipoRichiesta.Value = 4 Or Request.QueryString("GLocat") <> "" Then
                Response.Write("<script>window.open('../StampaDomanda.aspx','DomandaSS','');</script>")
            End If




            'txtIndici.Text = "V1=0&V2=0&V3=0&V4=0&V5=0&V6=0&V7 = " & par.Converti(ISEE_ERP) & "&V8=" & par.Converti(ISR_ERP) _
            '           & "&V9=" & par.Converti(ISP_ERP) _
            '           & "&V10=" & par.Converti(ISE_ERP) _
            '           & "&V11=0" _
            '           & "&V12=" & PARAMETRO _
            '           & "&V13=" & VSE _
            '           & "&PG=" & lblPG.Text & "&UJ=3"

            ' ''SstringaSql = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
            ' ''            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
            ' ''      & "','F133','','I')"
            ' ''par.cmd.CommandText = SstringaSql
            ' ''par.cmd.ExecuteNonQuery()

            If ESCLUSIONE = "" Then
                ' ''SstringaSql = "INSERT INTO EVENTI_BANDI_VSA (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                ' ''            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                ' ''      & "','F02','','I')"
                ' ''par.cmd.CommandText = SstringaSql
                ' ''par.cmd.ExecuteNonQuery()

                If Fl_DerogaInCorso = "" Then
                    ' ''SstringaSql = "INSERT INTO EVENTI_BANDI_VSA (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                    ' ''            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                    ' ''      & "','F37','','I')"
                    ' ''par.cmd.CommandText = SstringaSql
                    ' ''par.cmd.ExecuteNonQuery()


                    'par.cmd.CommandText = "DELETE FROM BANDI_GRADUATORIA_CAMBI WHERE ID_DOMANDA=" & lIdDomanda
                    'par.cmd.ExecuteNonQuery()

                    'SstringaSql = "INSERT INTO BANDI_GRADUATORIA_CAMBI (ID,ID_BANDO,ID_DOMANDA," _
                    '            & "ISBARC_R,TIPO,DISAGIO_A,DISAGIO_E,DISAGIO_F,ISE,ISEE,ISBAR) " _
                    '            & "VALUES (SEQ_BANDI_GRADUATORIA_CAMBI.NEXTVAL," & lIndice_Bando _
                    '            & "," & lIdDomanda & "," & par.VirgoleInPunti(par.IfNull(ISBARC_R, 0)) _
                    '            & ",0," & par.VirgoleInPunti(par.IfNull(DISAGIO_A, 0)) & "," _
                    '            & par.VirgoleInPunti(par.IfNull(DISAGIO_E, 0)) & "," _
                    '            & par.VirgoleInPunti(par.IfNull(DISAGIO_F, 0)) & "," _
                    '            & par.VirgoleInPunti(par.IfNull(ISE_ERP, 0)) & "," _
                    '            & par.VirgoleInPunti(par.IfNull(ISEE_ERP, 0)) _
                    '            & "," & par.VirgoleInPunti(par.IfNull(ISBAR, 0)) & ")"
                    'par.cmd.CommandText = SstringaSql
                    'par.cmd.ExecuteNonQuery()
                End If
            Else
                ' ''SstringaSql = "INSERT INTO EVENTI_BANDI_VSA (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                ' ''        & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                ' ''        & "','F57','','I')"
                ' ''par.cmd.CommandText = SstringaSql
                ' ''par.cmd.ExecuteNonQuery()
                ' ''If Fl_DerogaInCorso = "" Then
                ' ''    SstringaSql = "INSERT INTO EVENTI_BANDI_VSA (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                ' ''            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                ' ''            & "','F37','','I')"
                ' ''    par.cmd.CommandText = SstringaSql
                ' ''    par.cmd.ExecuteNonQuery()
                ' ''End If
            End If

            lIndice_Bando = glIndice_Bando_Origine


            '********** EVENTO CALCOLO ISEE *********
            'par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
            '    & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
            '    & "','F191','','')"
            'par.cmd.ExecuteNonQuery()

            par.cmd.CommandText = "UPDATE DOMANDE_BANDO_VSA SET REDDITO_ISEE=" & par.VirgoleInPunti(ISEE_ERP) & " WHERE ID=" & lIdDomanda
            par.cmd.ExecuteNonQuery()




            par.myTrans.Commit()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)

            par.cmd.CommandText = "SELECT * FROM DOMANDE_BANDO_VSA WHERE ID=" & lIdDomanda & " FOR UPDATE NOWAIT"
            myReader = par.cmd.ExecuteReader()
            myReader.Close()

            lblISBAR.Text = par.Tronca(ISEE_ERP)
            If lblISBAR.Text = 0 Then
                ISEEnullo.Value = 1
            End If

        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        Finally

        End Try

    End Function

    'Protected Sub btnIniziaVerifica_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnIniziaVerifica.Click
    '    Try
    '        Dim SstringaSql As String

    '        par.OracleConn = CType(HttpContext.Current.Session.Item("CONNESSIONE"), Oracle.DataAccess.Client.OracleConnection)
    '        par.SettaCommand(par)
    '        par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE"), Oracle.DataAccess.Client.OracleTransaction)
    '        ‘‘par.cmd.Transaction = par.myTrans


    '        If par.OracleConn.State = Data.ConnectionState.Closed Then
    '            par.OracleConn.Open()
    '        End If

    '        par.cmd.CommandText = "update domande_bando_cambi set FL_CONTROLLA_REQUISITI='1',ID_STATO='2',fl_inizio_req='1',DATA_INIZIO_REQ='" & Format(Now, "yyyyMMdd") & "' where id= " & lIdDomanda
    '        par.cmd.ExecuteNonQuery()

    '        SstringaSql = "INSERT INTO EVENTI_BANDI_CAMBI (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
    '                    & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
    '                    & "','F106','','I')"
    '        par.cmd.CommandText = SstringaSql
    '        par.cmd.ExecuteNonQuery()

    '        par.myTrans.Commit()
    '        par.myTrans = par.OracleConn.BeginTransaction()
    '        HttpContext.Current.Session.Add("TRANSAZIONE", par.myTrans)

    '        'btnIniziaVerifica.Visible = False
    '        'Label6.Visible = False

    '        'btnInviaAss.Visible = False
    '        'Label9.Visible = False

    '        'Label11.Visible = False
    '        'btnNonInviare.Visible = False

    '        'btnFineVerifica.Visible = True
    '        'Label8.Visible = True

    '        Response.Write("<script>document.getElementById('Verifica').style.visibility='hidden';</script>")
    '        Label5.Visible = True

    '    Catch ex As Exception
    '        Label10.Text = ex.Message
    '        par.myTrans.Rollback()
    '        par.myTrans = par.OracleConn.BeginTransaction()
    '        HttpContext.Current.Session.Add("TRANSAZIONE", par.myTrans)
    '    End Try
    'End Sub

    'Protected Sub btnFineVerifica_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnFineVerifica.Click
    '    Try
    '        Dim SstringaSql As String

    '        par.OracleConn = CType(HttpContext.Current.Session.Item("CONNESSIONE"), Oracle.DataAccess.Client.OracleConnection)
    '        par.SettaCommand(par)
    '        par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE"), Oracle.DataAccess.Client.OracleTransaction)
    '        ‘‘par.cmd.Transaction = par.myTrans


    '        If par.OracleConn.State = Data.ConnectionState.Closed Then
    '            par.OracleConn.Open()
    '        End If

    '        par.cmd.CommandText = "update domande_bando_cambi set FL_VERIFICA_CONCLUSA='1' where id= " & lIdDomanda
    '        par.cmd.ExecuteNonQuery()

    '        SstringaSql = "INSERT INTO EVENTI_BANDI_CAMBI (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
    '                    & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
    '                    & "','F38','','I')"
    '        par.cmd.CommandText = SstringaSql
    '        par.cmd.ExecuteNonQuery()

    '        par.myTrans.Commit()
    '        par.myTrans = par.OracleConn.BeginTransaction()
    '        HttpContext.Current.Session.Add("TRANSAZIONE", par.myTrans)

    '        'btnIniziaVerifica.Visible = False
    '        'Label6.Visible = False

    '        'btnInviaAss.Visible = True
    '        'Label9.Visible = True

    '        'Label11.Visible = True
    '        'btnNonInviare.Visible = True

    '        'btnFineVerifica.Visible = False
    '        'Label8.Visible = False

    '        Response.Write("<script>document.getElementById('Verifica').style.visibility='hidden';</script>")
    '        Label5.Visible = True
    '        Label5.Text = "VERIFICA REQUISITI CONCLUSA"

    '    Catch ex As Exception
    '        Label10.Text = ex.Message
    '        par.myTrans.Rollback()
    '        par.myTrans = par.OracleConn.BeginTransaction()
    '        HttpContext.Current.Session.Add("TRANSAZIONE", par.myTrans)


    '    End Try

    'End Sub

    'Protected Sub btnInviaAss_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnInviaAss.Click
    '    Try
    '        Dim SstringaSql As String

    '        par.OracleConn = CType(HttpContext.Current.Session.Item("CONNESSIONE"), Oracle.DataAccess.Client.OracleConnection)
    '        par.SettaCommand(par)
    '        par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE"), Oracle.DataAccess.Client.OracleTransaction)
    '        ‘‘par.cmd.Transaction = par.myTrans


    '        If par.OracleConn.State = Data.ConnectionState.Closed Then
    '            par.OracleConn.Open()
    '        End If

    '        par.cmd.CommandText = "update domande_bando_cambi set ID_STATO='9',FL_CONTROLLA_REQUISITI='2' where id= " & lIdDomanda
    '        par.cmd.ExecuteNonQuery()

    '        SstringaSql = "INSERT INTO EVENTI_BANDI_CAMBI (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
    '                    & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
    '                    & "','F39','','I')"
    '        par.cmd.CommandText = SstringaSql
    '        par.cmd.ExecuteNonQuery()

    '        par.myTrans.Commit()
    '        par.myTrans = par.OracleConn.BeginTransaction()
    '        HttpContext.Current.Session.Add("TRANSAZIONE", par.myTrans)

    '        'btnIniziaVerifica.Visible = False
    '        'Label6.Visible = False

    '        'btnInviaAss.Visible = True
    '        'Label9.Visible = True

    '        'Label11.Visible = True
    '        'btnNonInviare.Visible = True

    '        'btnFineVerifica.Visible = False
    '        'Label8.Visible = False

    '        imgStampa.Visible = False


    '        Response.Write("<script>document.getElementById('Verifica').style.visibility='hidden';</script>")
    '        Label5.Visible = True
    '        Label5.Text = "IN ASSEGNAZIONE"

    '    Catch ex As Exception
    '        Label10.Text = ex.Message
    '        par.myTrans.Rollback()
    '        par.myTrans = par.OracleConn.BeginTransaction()
    '        HttpContext.Current.Session.Add("TRANSAZIONE", par.myTrans)


    '    End Try
    'End Sub

    'Protected Sub btnNonInviare_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnNonInviare.Click
    '    Try
    '        'Dim SstringaSql As String

    '        par.OracleConn = CType(HttpContext.Current.Session.Item("CONNESSIONE"), Oracle.DataAccess.Client.OracleConnection)
    '        par.SettaCommand(par)
    '        par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE"), Oracle.DataAccess.Client.OracleTransaction)
    '        ‘‘par.cmd.Transaction = par.myTrans


    '        If par.OracleConn.State = Data.ConnectionState.Closed Then
    '            par.OracleConn.Open()
    '        End If

    '        par.cmd.CommandText = "update domande_bando_cambi set fl_verifica_conclusa='0',ID_STATO='8',FL_CONTROLLA_REQUISITI='0',fl_inizio_req='0',DATA_INIZIO_REQ='' where id= " & lIdDomanda
    '        par.cmd.ExecuteNonQuery()

    '        'par.cmd.CommandText = "update domande_bando_cambi set ID_STATO='8',FL_VERIFICA_CONCLUSA='1' where id= " & lIdDomanda
    '        'par.cmd.ExecuteNonQuery()

    '        'SstringaSql = "INSERT INTO EVENTI_BANDI_CAMBI (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
    '        '            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
    '        '            & "','F38','','E')"
    '        'par.cmd.CommandText = SstringaSql
    '        'par.cmd.ExecuteNonQuery()

    '        par.myTrans.Commit()
    '        par.myTrans = par.OracleConn.BeginTransaction()
    '        HttpContext.Current.Session.Add("TRANSAZIONE", par.myTrans)

    '        'btnIniziaVerifica.Visible = True
    '        'Label6.Visible = True

    '        'btnInviaAss.Visible = False
    '        'Label9.Visible = False

    '        'Label11.Visible = False
    '        'btnNonInviare.Visible = False

    '        'btnFineVerifica.Visible = False
    '        'Label8.Visible = False

    '        Response.Write("<script>document.getElementById('Verifica').style.visibility='hidden';</script>")
    '        Label5.Visible = False
    '        Label5.Text = ""

    '    Catch ex As Exception
    '        Label10.Text = ex.Message
    '        par.myTrans.Rollback()
    '        par.myTrans = par.OracleConn.BeginTransaction()
    '        HttpContext.Current.Session.Add("TRANSAZIONE", par.myTrans)


    '    End Try
    'End Sub

    Public Property sCanone() As String
        Get
            If Not (ViewState("par_sCanone") Is Nothing) Then
                Return CStr(ViewState("par_sCanone"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCanone") = value
        End Set
    End Property


    Public Property sISEE() As String
        Get
            If Not (ViewState("par_sISEE") Is Nothing) Then
                Return CStr(ViewState("par_sISEE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sISEE") = value
        End Set

    End Property


    Public Property sISE() As String
        Get
            If Not (ViewState("par_sISE") Is Nothing) Then
                Return CStr(ViewState("par_sISE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sISE") = value
        End Set
    End Property

    Public Property sVSE() As String
        Get
            If Not (ViewState("par_sVSE") Is Nothing) Then
                Return CStr(ViewState("par_sVSE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sVSE") = value
        End Set
    End Property


    Public Property sPSE() As String
        Get
            If Not (ViewState("par_sPSE") Is Nothing) Then
                Return CStr(ViewState("par_sPSE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sPSE") = value
        End Set
    End Property

    Public Property sISP() As String
        Get
            If Not (ViewState("par_sISP") Is Nothing) Then
                Return CStr(ViewState("par_sISP"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sISP") = value
        End Set
    End Property


    Public Property sISR() As String
        Get
            If Not (ViewState("par_sISR") Is Nothing) Then
                Return CStr(ViewState("par_sISR"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sISR") = value
        End Set
    End Property

    Public Property sREDD_DIP() As String
        Get
            If Not (ViewState("par_sREDD_DIP") Is Nothing) Then
                Return CStr(ViewState("par_sREDD_DIP"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sREDD_DIP") = value
        End Set
    End Property

    Public Property sREDD_ALT() As String
        Get
            If Not (ViewState("par_sREDD_ALT") Is Nothing) Then
                Return CStr(ViewState("par_sREDD_ALT"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sREDD_ALT") = value
        End Set
    End Property

    Public Property sLimitePensione() As String
        Get
            If Not (ViewState("par_sLimitePensione") Is Nothing) Then
                Return CStr(ViewState("par_sLimitePensione"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sLimitePensione") = value
        End Set
    End Property

    Public Property sPER_VAL_LOC() As String
        Get
            If Not (ViewState("par_sPER_VAL_LOC") Is Nothing) Then
                Return CStr(ViewState("par_sPER_VAL_LOC"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sPER_VAL_LOC") = value
        End Set
    End Property


    Public Property sPERC_INC_MAX_ISE_ERP() As String
        Get
            If Not (ViewState("par_sPERC_INC_MAX_ISE_ERP") Is Nothing) Then
                Return CStr(ViewState("par_sPERC_INC_MAX_ISE_ERP"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sPERC_INC_MAX_ISE_ERP") = value
        End Set
    End Property

    Public Property sCANONE_MIN() As String
        Get
            If Not (ViewState("par_sCANONE_MIN") Is Nothing) Then
                Return CStr(ViewState("par_sCANONE_MIN"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCANONE_MIN") = value
        End Set
    End Property

    Public Property sISE_MIN() As String
        Get
            If Not (ViewState("par_sISE_MIN") Is Nothing) Then
                Return CStr(ViewState("par_sISE_MIN"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sISE_MIN") = value
        End Set
    End Property

    'Protected Sub cmbAccolta_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbAccolta.SelectedIndexChanged
    '    If cmbAccolta.Text = "SI" Then
    '        If sStato = "4" Then
    '            Response.Write("<script>alert('Attenzione, la domanda è in stato respinta, non è possibile accettare la domanda!');</script>")


    '            cmbAccolta.SelectedIndex = -1
    '            cmbAccolta.Items.FindByValue(2).Selected = True

    '            cmbAccolta.Visible = False
    '            Label13.Visible = False

    '        End If
    '    End If
    'End Sub

    Public Sub ApplicaContabilizzazione()
        Try
            Dim IDUNITA As Long = 0
            Dim idc As Long = 0
            Dim Aggiorna As Boolean = False
            Dim inCondominio As Boolean = False
            Dim inGestionale As Boolean = False

            Dim idAnagrIntest As Long = 0
            Dim maxFineVal As String = ""
            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans

            'par.cmd.CommandText = "select * from VSA_BOL_RID_CANONE WHERE ID_DOMANDA=" & lIdDomanda & " AND ID_BOLLETTA IN (SELECT ID_BOLLETTA FROM VSA_BOL_RID_CANONE WHERE FL_CONTABILIZZATO=1 AND ID_DOMANDA<>" & lIdDomanda & ")"
            'Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            'If myReaderC.HasRows = True Then
            '    Response.Write("<script>alert('Impossibile Procedere! Il Credito/Debito teorico indicato non corrisponde! Una o più bollette sono state contabilizzate tramite altra domanda di riduzione canone.');</script>")
            '    myReaderC.Close()
            '    Exit Sub
            'Else
            par.cmd.CommandText = "UPDATE VSA_BOL_RID_CANONE SET FL_CONTABILIZZATO=1 WHERE ID_DOMANDA=" & lIdDomanda
            par.cmd.ExecuteNonQuery()
            'End If
            'myReaderC.Close()

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=41"
            Dim myReaderPar As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderPar.Read Then
                If par.IfNull(myReaderPar("VALORE"), 0) = 1 Then
                    inGestionale = True
                Else
                    inGestionale = False
                End If
            End If

            Dim CanoneCalcolato As String = "0"
            Dim numRate As Integer = 0
            par.cmd.CommandText = "select CANONE_CALCOLATO,CREDITO_TEORICO from DOMANDE_BANDO_VSA WHERE ID=" & lIdDomanda
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader.Read Then

                CanoneCalcolato = par.IfNull(myReader("canone_calcolato"), "0")
                par.cmd.CommandText = "SELECT id,NRO_RATE FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
                Dim myReader0 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader0.Read Then
                    idc = myReader0("id")
                    numRate = par.IfNull(myReader0("NRO_RATE"), 12)
                End If
                myReader0.Close()

                par.cmd.CommandText = "SELECT * FROM siscom_mi.soggetti_contrattuali WHERE id_contratto=" & idc & " AND COD_TIPOLOGIA_OCCUPANTE='INTE'"
                Dim myReaderAn As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderAn.Read Then
                    idAnagrIntest = par.IfNull(myReaderAn("ID_ANAGRAFICA"), 0)
                End If
                myReaderAn.Close()
                par.cmd.CommandText = "SELECT ID_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE COD_UNITA_IMMOBILIARE='" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "' AND ID_UNITA_PRINCIPALE IS NULL"
                Dim myReader1234 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader1234.Read() Then
                    IDUNITA = par.IfNull(myReader1234("ID_UNITA"), 0)
                End If
                myReader1234.Close()

                Dim DataScadenza As String = DateAdd("d", 10, Now)
                Dim INIZIO As String = ""
                Dim FINE As String = ""
                Dim canone_iniziale As String = "0"
                Dim idBollGest As Long = 0

                par.cmd.CommandText = "select RAPPORTI_UTENZA.*,EDIFICI.ID_COMPLESSO,UNITA_CONTRATTUALE.ID_EDIFICIO FROM SISCOM_MI.UNITA_CONTRATTUALE,SISCOM_MI.EDIFICI,SISCOM_MI.RAPPORTI_UTENZA WHERE UNITA_CONTRATTUALE.ID_UNITA_PRINCIPALE IS NULL AND RAPPORTI_UTENZA.ID=" & idc & " AND UNITA_CONTRATTUALE.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND EDIFICI.ID=UNITA_CONTRATTUALE.ID_EDIFICIO"
                Dim myReaderS As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderS.Read Then
                    canone_iniziale = par.IfNull(myReaderS("IMP_CANONE_INIZIALE"), "")
                    par.cmd.CommandText = "select * from VSA_CREDITI_RID_CANONE where id_domanda=" & lIdDomanda & " order by anno desc"
                    Dim myReaderX As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    Do While myReaderX.Read

                        If par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtInizioVal"), TextBox).Text) > myReaderX("ANNO") & "0101" Then
                            INIZIO = par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtInizioVal"), TextBox).Text)
                        Else
                            INIZIO = myReaderX("ANNO") & "0101"
                        End If

                        If par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtFineVal"), TextBox).Text) < myReaderX("ANNO") & "1231" Then
                            FINE = par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtFineVal"), TextBox).Text)
                        Else
                            FINE = myReaderX("ANNO") & "1231"
                        End If

                        If inGestionale = "0" Then

                            par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE " _
                                                                    & "(ID, N_RATA, DATA_EMISSIONE, DATA_SCADENZA, DATA_I_SOLLECITO, " _
                                                                    & "DATA_II_SOLLECITO, DATA_PAGAMENTO, NOTE, ID_CONTRATTO, ID_ESERCIZIO_F, " _
                                                                    & "ID_UNITA, FL_ANNULLATA, PAGABILE_PRESSO, COD_AFFITTUARIO, INTESTATARIO, " _
                                                                    & "INDIRIZZO, CAP_CITTA, PRESSO, RIFERIMENTO_DA, RIFERIMENTO_A, " _
                                                                    & "FL_STAMPATO, ID_COMPLESSO, DATA_INS_PAGAMENTO, IMPORTO_PAGATO, NOTE_PAGAMENTO, " _
                                                                    & "ANNO, OPERATORE_PAG, ID_EDIFICIO, DATA_ANNULLO_PAG, OPERATORE_ANNULLO_PAG,RIF_FILE,ID_TIPO) " _
                                                                    & "Values " _
                                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE.NEXTVAL, 999, '" & Format(Now, "yyyyMMdd") _
                                                                    & "', '29991231', NULL,NULL,NULL,'CONTAB. ANNO " & myReaderX("ANNO") & "'," _
                                                                    & "" & idc _
                                                                    & " ," & par.RicavaEsercizioCorrente & ", " _
                                                                    & IDUNITA _
                                                                    & ", '0', '', " & idAnagrIntest _
                                                                    & ", '" & par.PulisciStrSql(par.IfNull(myReaderS("PRESSO_COR"), "")) & "', " _
                                                                    & "'" & par.PulisciStrSql(par.IfNull(myReaderS("TIPO_COR"), "") & " " & par.IfNull(myReaderS("VIA_COR"), "") & ", " & par.PulisciStrSql(par.IfNull(myReaderS("CIVICO_COR"), ""))) _
                                                                    & "', '" & par.PulisciStrSql(par.IfNull(myReaderS("CAP_COR"), "") & " " & par.IfNull(myReaderS("LUOGO_COR"), "") & "(" & par.IfNull(myReaderS("SIGLA_COR"), "") & ")") _
                                                                    & "', '', '" & INIZIO _
                                                                    & "', '" & FINE & "', " _
                                                                    & "'0', " & myReaderS("ID_COMPLESSO") & ", '', NULL, '', " _
                                                                    & Year(Now) & ", '', " & myReaderS("ID_EDIFICIO") & ", NULL, NULL,'MOD',12)"

                            par.cmd.ExecuteNonQuery()
                            par.cmd.CommandText = "select SISCOM_MI.SEQ_BOL_BOLLETTE.CURRVAL FROM DUAL"
                            Dim myReaderA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()

                            If myReaderA.Read Then
                                Dim ID_BOLLETTA As Long = myReaderA(0)

                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                    & ",686" _
                                                    & "," & par.VirgoleInPunti(myReaderX("IMPORTO")) & ",'" & myReaderX("ANNO") & "')"
                                par.cmd.ExecuteNonQuery()
                            End If
                            myReaderA.Close()
                        Else
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_GEST (ID, ID_CONTRATTO, ID_ESERCIZIO_F, ID_UNITA, ID_ANAGRAFICA, RIFERIMENTO_DA, RIFERIMENTO_A," _
                                 & "IMPORTO_TOTALE, DATA_EMISSIONE, DATA_PAGAMENTO, DATA_VALUTA, ID_TIPO, TIPO_APPLICAZIONE, DATA_APPLICAZIONE, ID_OPERATORE_APPLICAZIONE, NOTE, ID_EVENTO_PAGAMENTO) " _
                                 & "VALUES (SISCOM_MI.SEQ_BOL_BOLLETTE_GEST.NEXTVAL, " & idc & ", " & par.RicavaEsercizioCorrente & ", " & IDUNITA & "," _
                                 & idAnagrIntest & ",'" & INIZIO & "', '" & FINE & "', " & par.VirgoleInPunti(myReaderX("IMPORTO")) & ", '" & Format(Now, "yyyyMMdd") & "'," _
                                 & "'','',56, 'N', NULL,NULL,'CONTAB. ANNO " & myReaderX("ANNO") & "', NULL)"
                            par.cmd.ExecuteNonQuery()

                            par.cmd.CommandText = "SELECT SISCOM_MI.SEQ_BOL_BOLLETTE_GEST.CURRVAL FROM DUAL"
                            Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            If myReader1.Read Then
                                idBollGest = myReader1(0)
                            End If
                            myReader1.Close()

                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI_GEST (ID, ID_BOLLETTA_GEST, ID_VOCE, IMPORTO, IMP_PAGATO, FL_ACCERTATO) " _
                            & "VALUES (SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI_GEST.NEXTVAL, " & idBollGest & ", 686, " & par.VirgoleInPunti(myReaderX("IMPORTO")) & ", NULL, NULL)"
                            par.cmd.ExecuteNonQuery()
                        End If
                    Loop
                    myReaderX.Close()
                End If
                myReaderS.Close()

                par.cmd.CommandText = "UPDATE DOMANDE_BANDO_VSA SET FL_CONTABILIZZATO=1 WHERE ID=" & lIdDomanda
                par.cmd.ExecuteNonQuery()

                par.cmd.CommandText = "SELECT MAX(FINE_VALIDITA_CAN) as maxFineVal FROM SISCOM_MI.CANONI_EC WHERE ID_CONTRATTO=" & idc & " AND TIPO_PROVENIENZA IN (SELECT ID FROM T_TIPO_PROVENIENZA WHERE VALIDA=1)"
                Dim myReaderF As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderF.Read Then
                    maxFineVal = par.IfNull(myReaderF("maxFineVal"), "")
                End If
                myReaderF.Close()

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) VALUES (" & idc & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','F02','INSERITA BOLLETTA DI CONTABILIZZAZIONE (EURO " & myReader("CREDITO_TEORICO") & ") DOMANDA PG " & lblPG.Text & "')"
                par.cmd.ExecuteNonQuery()

            End If
            myReader.Close()

            Dim rataProssima As String = ""
            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA_PROSSIMA_BOL WHERE ID_CONTRATTO=" & idc & " ORDER BY PROSSIMA_BOLLETTA DESC"
            Dim myReaderP As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderP.Read Then
                rataProssima = Right(par.IfNull(myReaderP("PROSSIMA_BOLLETTA"), ""), "2")
            End If
            myReaderP.Close()

            If Left(rataProssima, 1) = "0" Then
                rataProssima = Right(rataProssima, 1)
            End If

            'If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 28 Or CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = 29 Then
            '    Aggiorna = True
            'End If

            CType(Dom_Decisioni1.FindControl("btnContabilizza"), Button).Visible = False


            '********** 06/06/2013 CONTROLLI SU CONTRIBUTO CALORE **********
            Dim inizioValidita As String = ""
            Dim fineValidita As String = ""
            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.CANONI_EC_LOCATARI WHERE ID_CONTRATTO=" & idc & " AND ID_DICHIARAZIONE=" & lIdDichiarazione & " order by FINE_VALIDITA_CAN desc"
            Dim myReaderCL As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderCL.Read Then
                inizioValidita = par.IfNull(myReaderCL("INIZIO_VALIDITA_CAN"), "")
                fineValidita = par.IfNull(myReaderCL("FINE_VALIDITA_CAN"), "")
            End If
            myReaderCL.Close()

            Dim anno1 As Integer = 0
            Dim anno2 As Integer = 0

            aggVoce = False
            anno1 = Mid(inizioValidita, 1, 4)
            anno2 = Mid(fineValidita, 1, 4)

            For j As Integer = anno1 To anno2
                If j = Year(Now) Then
                    aggVoce = True
                End If
            Next

            If fineValidita >= maxFineVal Then
                Aggiorna = True
            Else
                Aggiorna = False
            End If

            If Aggiorna = True Then
                Session.Add("AGGCANONE", CanoneCalcolato)

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) VALUES (" & idc & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','F02','CANONE MODIFICATO PER " & par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedItem.Text) & " PG " & lblPG.Text & " (CANONE PRECEDENTE: EURO " & CanoneCalcolato & " )')"
                par.cmd.ExecuteNonQuery()
            End If

            Dim idAreaEconomica As Integer = 0
            Dim importoContrCalore As Decimal = 0
            Dim VoceDaCancell As Boolean = False
            Dim impContrCaloreDaCanc As Decimal = True

            If Aggiorna = True Then
                '**** CALCOLA 
                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.CANONI_EC_LOCATARI WHERE ID_CONTRATTO=" & idc & " AND ID_DICHIARAZIONE=" & lIdDichiarazione & " AND ID_BANDO_AU IS NOT NULL"
                Dim myReaderEC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderEC.Read Then
                    idAreaEconomica = par.IfNull(myReaderEC("ID_AREA_ECONOMICA"), "")
                End If
                myReaderEC.Close()

                importoContrCalore = par.CalcolaContribCalore(idc, idAreaEconomica, VoceDaCancell, impContrCaloreDaCanc)

                If VoceDaCancell = True Then
                    par.cmd.CommandText = "DELETE FROM SISCOM_MI.BOL_SCHEMA WHERE ID_CONTRATTO=" & idc & " AND ANNO=" & Year(Now) & " AND ID_VOCE=803" 'AND ID_VOCE=693"
                    par.cmd.ExecuteNonQuery()

                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                    & "VALUES (" & idc & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                    & "'F184','ELIMINATA VOCE Contrib.risc/serv GC 2761/14 (euro " & par.VirgoleInPunti(Format(impContrCaloreDaCanc * -1, "##,##0.00")) & ") IN SEGUITO A RECA')"
                    par.cmd.ExecuteNonQuery()

                    If importoContrCalore > 0 Then
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE,IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO) Values " _
                        & " (SISCOM_MI.SEQ_BOL_SCHEMA.NEXTVAL, " & idc & ", " & IDUNITA & ", " & par.RicavaEsercizioCorrente & ", 803," & (par.VirgoleInPunti(Format(importoContrCalore, "##,##0.00") * (-1))) & ", " & CInt(rataProssima) & ", " & numRate & ", " _
                        & "" & par.VirgoleInPunti((importoContrCalore / numRate) * -1) & ", " & Year(Now) & ")"
                        par.cmd.ExecuteNonQuery()

                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                            & "VALUES (" & idc & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                            & "'F184','AGGIUNTA VOCE Contrib.risc/serv GC 2761/14 (euro " & (par.VirgoleInPunti(Format(importoContrCalore / numRate, "##,##0.00") * (-1))) & " mensili) IN SEGUITO A RECA')"
                        par.cmd.ExecuteNonQuery()
                    End If
                Else
                    If importoContrCalore > 0 Then
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE,IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO) Values " _
                        & " (SISCOM_MI.SEQ_BOL_SCHEMA.NEXTVAL, " & idc & ", " & IDUNITA & ", " & par.RicavaEsercizioCorrente & ", 803," & (par.VirgoleInPunti(Format(importoContrCalore, "##,##0.00") * (-1))) & ", " & CInt(rataProssima) & ", " & numRate & ", " _
                        & "" & par.VirgoleInPunti((importoContrCalore / numRate) * -1) & ", " & Year(Now) & ")"
                        par.cmd.ExecuteNonQuery()

                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                            & "VALUES (" & idc & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                            & "'F184','AGGIUNTA VOCE Contrib.risc/serv GC 2761/14 (euro " & (par.VirgoleInPunti(Format(importoContrCalore / numRate, "##,##0.00") * (-1))) & " mensili) IN SEGUITO A RECA')"
                        par.cmd.ExecuteNonQuery()
                    End If
                End If

            End If
            '********** 06/06/2013 FINE CONTROLLI SU CONTRIBUTO CALORE **********



            If Aggiorna = True Then
                If Request.QueryString("CONT") <> "0" Then
                    If Not IsNothing(Session.Item("lIdConnessione")) Then
                        Dim par1 As New CM.Global
                        par1.OracleConn = CType(HttpContext.Current.Session.Item(Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleConnection)
                        par1.cmd = par1.OracleConn.CreateCommand()
                        par1.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleTransaction)
                        ''par1.cmd.Transaction = par1.myTrans

                        par1.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET IMP_CANONE_INIZIALE=" & par.VirgoleInPunti(CanoneCalcolato) & " WHERE ID=" & idc
                        par1.cmd.ExecuteNonQuery()

                        nuovocanone.Value = par.VirgoleInPunti(CanoneCalcolato)

                        par1.cmd.CommandText = "DELETE FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo=2 and ID_CONTRATTO=" & idc
                        par1.cmd.ExecuteNonQuery()

                        par1.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC SELECT * FROM SISCOM_MI.CANONI_EC_LOCATARI WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND ID_CONTRATTO = " & idc & " "
                        par1.cmd.ExecuteNonQuery()

                        Dim dataCalcolo As Date = Now
                        par1.cmd.CommandText = "SELECT ID FROM SISCOM_MI.CANONI_EC WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND ID_CONTRATTO = " & idc & " order by competenza asc"
                        Dim myReaderEC As Oracle.DataAccess.Client.OracleDataReader = par1.cmd.ExecuteReader()
                        Do While myReaderEC.Read
                            par1.cmd.CommandText = "UPDATE SISCOM_MI.CANONI_EC SET DATA_CALCOLO='" & Format(dataCalcolo, "yyyyMMddHHmmss") & "' WHERE ID = " & myReaderEC("ID")
                            par1.cmd.ExecuteNonQuery()
                            dataCalcolo = DateAdd("s", 10, dataCalcolo)
                        Loop
                        myReaderEC.Close()

                        par1.myTrans.Commit()
                        par1.myTrans = par1.OracleConn.BeginTransaction()
                        HttpContext.Current.Session.Add("TRANSAZIONE" & Session.Item("lIdConnessione"), par1.myTrans)
                        par1.Dispose()
                        Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                    Else
                        par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET IMP_CANONE_INIZIALE=" & par.VirgoleInPunti(CanoneCalcolato) & " WHERE ID=" & idc
                        par.cmd.ExecuteNonQuery()
                        par.cmd.CommandText = "DELETE FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo=2 and ID_CONTRATTO=" & idc
                        par.cmd.ExecuteNonQuery()

                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC SELECT * FROM SISCOM_MI.CANONI_EC_LOCATARI WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND ID_CONTRATTO = " & idc & " "
                        par.cmd.ExecuteNonQuery()

                        Dim dataCalcolo As Date = Now
                        par.cmd.CommandText = "SELECT ID FROM SISCOM_MI.CANONI_EC WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND ID_CONTRATTO = " & idc & " order by competenza asc"
                        Dim myReaderEC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        Do While myReaderEC.Read
                            par.cmd.CommandText = "UPDATE SISCOM_MI.CANONI_EC SET DATA_CALCOLO='" & Format(dataCalcolo, "yyyyMMddHHmmss") & "' WHERE ID = " & myReaderEC("ID")
                            par.cmd.ExecuteNonQuery()
                            dataCalcolo = DateAdd("s", 10, dataCalcolo)
                        Loop
                        myReaderEC.Close()
                    End If
                Else
                    par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET IMP_CANONE_INIZIALE=" & par.VirgoleInPunti(CanoneCalcolato) & " WHERE ID=" & idc
                    par.cmd.ExecuteNonQuery()
                    par.cmd.CommandText = "DELETE FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo=2 and ID_CONTRATTO=" & idc
                    par.cmd.ExecuteNonQuery()

                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC SELECT * FROM SISCOM_MI.CANONI_EC_LOCATARI WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND ID_CONTRATTO = " & idc & " "
                    par.cmd.ExecuteNonQuery()

                    Dim dataCalcolo As Date = Now
                    par.cmd.CommandText = "SELECT ID FROM SISCOM_MI.CANONI_EC WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND ID_CONTRATTO = " & idc & " order by competenza asc"
                    Dim myReaderEC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    Do While myReaderEC.Read
                        par.cmd.CommandText = "UPDATE SISCOM_MI.CANONI_EC SET DATA_CALCOLO='" & Format(dataCalcolo, "yyyyMMddHHmmss") & "' WHERE ID = " & myReaderEC("ID")
                        par.cmd.ExecuteNonQuery()
                        dataCalcolo = DateAdd("s", 10, dataCalcolo)
                    Loop
                    myReaderEC.Close()
                End If

                Dim STRdettaglio As String = ""
                CalcolaScontoCostoBase(idc, CDec(rataProssima), STRdettaglio)
            Else
                par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC SELECT * FROM SISCOM_MI.CANONI_EC_LOCATARI WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND ID_CONTRATTO = " & idc & " "
                par.cmd.ExecuteNonQuery()

                Dim dataCalcolo As Date = Now
                par.cmd.CommandText = "SELECT ID FROM SISCOM_MI.CANONI_EC WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND ID_CONTRATTO = " & idc & " order by competenza asc"
                Dim myReaderEC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                Do While myReaderEC.Read
                    par.cmd.CommandText = "UPDATE SISCOM_MI.CANONI_EC SET DATA_CALCOLO='" & Format(dataCalcolo, "yyyyMMddHHmmss") & "' WHERE ID = " & myReaderEC("ID")
                    par.cmd.ExecuteNonQuery()
                    dataCalcolo = DateAdd("s", 10, dataCalcolo)
                Loop
                myReaderEC.Close()
            End If

            par.myTrans.Commit()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)

            fl_contab = 1
            SetMenuStampe(tipoRichiesta.Value)

            Response.Write("<script>alert('Operazione Effettuata. Le bollette di contabilizzazione saranno visibili nella scheda BOLLETTE del contratto.');</script>")

            Response.Write("<script>window.open('../StampeDoc.aspx?IDDICHIARAZ=" & lIdDichiarazione & "&CODUNITA=" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "&NUMCONT=" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "&TIPO=RapportoRECA', '', 'top=250,left=250,width=0,height=0,resizable=yes,menubar=no,toolbar=no,scrollbars=no','StampaRapp');</script>")


        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        Finally

        End Try

    End Sub

    Private Sub CalcolaScontoCostoBase(ByVal idContratto As Long, ByVal rataProssima As Integer, ByRef STRdettaglio As String)
        Try
            Dim canoneMIN As Decimal = 0
            Dim nuovoCostoBase As Decimal = 0
            Dim valoreConvenz As Decimal = 0
            Dim valoreLocativo As Decimal = 0
            Dim canoneSopp As Decimal = 0
            Dim canoneApp As Decimal = 0
            Dim esclusione As String = ""
            Dim idEdificio As Long = 0
            Dim idUnita As Long = 0
            Dim scontoCostoBase As Integer = 0
            Dim scontoOk As Boolean = False
            Dim canoneClasse As Decimal = 0
            Dim CanoneErpRegime As Decimal = 0
            Dim tipoCanone As String = ""
            Dim numRate As Integer = 0
            Dim calcoloUltimoAnno As Boolean = False
            Dim codContratto As String = ""

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & idContratto
            Dim myReader0 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader0.Read Then
                idEdificio = par.IfNull(myReader0("ID_EDIFICIO"), "")
                idUnita = par.IfNull(myReader0("ID_UNITA"), "")
            End If
            myReader0.Close()

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & idContratto
            myReader0 = par.cmd.ExecuteReader()
            If myReader0.Read Then
                numRate = par.IfNull(myReader0("NRO_RATE"), 0)
                codContratto = par.IfNull(myReader0("COD_CONTRATTO"), 0)
            End If
            myReader0.Close()

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.EDIFICI WHERE ID=" & idEdificio
            myReader0 = par.cmd.ExecuteReader()
            If myReader0.Read Then
                scontoCostoBase = par.IfNull(myReader0("SCONTO_COSTO_BASE"), 0)
            End If
            myReader0.Close()

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.CANONI_EC WHERE ID_CONTRATTO=" & idContratto & " AND ID_DICHIARAZIONE=" & lIdDichiarazione & " AND ID_BANDO_AU IS NOT NULL"
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                calcoloUltimoAnno = True

                If par.IfNull(myReader("ID_AREA_ECONOMICA"), 0) = 4 Then
                    esclusione = "a)"
                End If
                If par.IfNull(myReader("CANONE"), 0) = par.IfNull(myReader("CANONE_MINIMO_AREA"), 0) Then
                    esclusione = "b)"
                End If
                If par.IfNull(myReader("CANONE"), 0) < par.IfNull(myReader("CANONE_91"), 0) Then
                    esclusione = "c)"
                End If

                If scontoCostoBase <> 0 Then
                    scontoOk = True
                End If

                canoneMIN = par.IfNull(myReader("CANONE_MINIMO_AREA"), "0") * 12
                nuovoCostoBase = par.IfNull(myReader("COSTOBASE"), "0") + ((par.IfNull(myReader("SCONTO_COSTO_BASE"), "0") / 100) * par.IfNull(myReader("COSTOBASE"), "0"))
                valoreConvenz = nuovoCostoBase * par.IfNull(myReader("SUPCONVENZIONALE"), "0") * par.IfNull(myReader("DEM"), "0") * par.IfNull(myReader("ZONA"), "0") * par.IfNull(myReader("PIANO"), "0") * par.IfNull(myReader("CONSERVAZIONE"), "0") * par.IfNull(myReader("VETUSTA"), "0")
                valoreLocativo = (valoreConvenz * 5) / 100
                canoneSopp = par.IfNull(myReader("CANONE_SOPPORTABILE"), "0")
                canoneApp = Format((par.IfNull(myReader("PERC_VAL_LOC"), "0") * valoreLocativo) / 100, "0.00")

                canoneClasse = (canoneApp + ((canoneApp * CDec(par.IfNull(myReader("PERC_ISTAT_APPLICATA"), "0"))) / 100)) * par.IfNull(myReader("COEFF_NUCLEO_FAM"), "0")
                If CDec(canoneSopp) < CDec(canoneClasse) Then
                    If CDec(canoneSopp) > CDec(canoneMIN) Then
                        CanoneErpRegime = canoneSopp
                        tipoCanone = "SOPPORTABILE"
                    Else
                        CanoneErpRegime = canoneMIN
                        tipoCanone = "MINIMO AREA"
                    End If
                Else
                    If CDec(canoneClasse) > CDec(canoneMIN) Then
                        CanoneErpRegime = canoneClasse
                        tipoCanone = "CLASSE"
                    Else
                        CanoneErpRegime = canoneMIN
                        tipoCanone = "MINIMO AREA"
                    End If
                End If

            End If
            myReader.Close()

            Dim canoneScontato As Decimal = 0
            Dim delta As Decimal = 0
            Dim importo694 As Decimal = 0

            If calcoloUltimoAnno = True Then
                'CONTROLLO SE IN BOL_SCHEMA ESISTE LA VOCE 694
                If tipoCanone <> "CLASSE" Or esclusione <> "" Then
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.BOL_SCHEMA WHERE ID_CONTRATTO=" & idContratto & " AND ANNO=" & Year(Now) & " AND ID_VOCE=802" 'AND ID_VOCE=694"
                    Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderC.Read Then
                        importo694 = par.IfNull(myReaderC("IMPORTO_SINGOLA_RATA"), 0)

                        par.cmd.CommandText = "DELETE FROM SISCOM_MI.BOL_SCHEMA WHERE ID_CONTRATTO=" & idContratto & " AND ANNO=" & Year(Now) & " AND ID_VOCE=802" 'AND ID_VOCE=694"
                        par.cmd.ExecuteNonQuery()

                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                        & "VALUES (" & idContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                        & "'F184','ELIMINATA VOCE Riduzione Canone GC 2761/14 (euro " & par.VirgoleInPunti(Format(importo694 * -1, "##,##0.00")) & ") IN SEGUITO A RECA')"
                        par.cmd.ExecuteNonQuery()
                    End If
                    myReaderC.Close()
                End If

                If tipoCanone = "CLASSE" And scontoOk = True Then
                    canoneScontato = CanoneErpRegime - ((CanoneErpRegime * (scontoCostoBase * -1)) / 100)
                    delta = CanoneErpRegime - canoneScontato

                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.BOL_SCHEMA WHERE ID_CONTRATTO=" & idContratto & " AND ANNO=" & Year(Now) & " AND ID_VOCE=802 ORDER BY ID DESC" 'AND ID_VOCE=694 ORDER BY ID DESC"
                    Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderC.Read = False Then
                        If delta > 0 Then
                            par.cmd.CommandText = "UPDATE SISCOM_MI.CANONI_EC SET SCONTO_COSTO_BASE='" & scontoCostoBase & "',DELTA_1243_12='" & Format(delta * -1, "0.00") & "',CANONE_1243_12='" & Format(canoneScontato, "0.00") & "',TIPO_CANONE_APP='" & tipoCanone & "' WHERE ID_CONTRATTO=" & idContratto & " AND ID_DICHIARAZIONE=" & lIdDichiarazione & " AND ID_BANDO_AU IS NOT NULL"
                            par.cmd.ExecuteNonQuery()

                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE,IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO) Values (SISCOM_MI.SEQ_BOL_SCHEMA.NEXTVAL, " & idContratto & ", " & idUnita & ", " & par.RicavaEsercizioCorrente & ", 802," & par.VirgoleInPunti(Format((delta / numRate) * ((numRate - rataProssima) + 1) * -1, "##,##0.00")) & ", " & rataProssima & ", " & (numRate - rataProssima) + 1 & ", " & par.VirgoleInPunti(Format((delta * -1) / numRate, "##,##0.00")) & ", " & Year(Now) & ")"
                            par.cmd.ExecuteNonQuery()

                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) VALUES (" & idContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','F184','AGGIUNTA VOCE Riduzione Canone GC 2761/14 (euro " & par.VirgoleInPunti(Format((delta * -1) / numRate, "##,##0.00")) & ") DA RATA " & rataProssima & " PER " & (numRate - rataProssima) + 1 & " RATE')"
                            par.cmd.ExecuteNonQuery()
                        End If
                    Else
                        If delta > 0 Then
                            par.cmd.CommandText = "UPDATE SISCOM_MI.CANONI_EC SET SCONTO_COSTO_BASE='" & scontoCostoBase & "',DELTA_1243_12='" & Format(delta * -1, "0.00") & "',CANONE_1243_12='" & Format(canoneScontato, "0.00") & "',TIPO_CANONE_APP='" & tipoCanone & "' WHERE ID_CONTRATTO=" & idContratto & " AND ID_DICHIARAZIONE=" & lIdDichiarazione & " AND ID_BANDO_AU IS NOT NULL"
                            par.cmd.ExecuteNonQuery()

                            par.cmd.CommandText = "UPDATE SISCOM_MI.BOL_SCHEMA SET IMPORTO=" & par.VirgoleInPunti(Format((delta / numRate) * ((numRate - rataProssima) + 1) * -1, "##,##0.00")) & ",DA_RATA=" & rataProssima & ",PER_RATE=" & (numRate - rataProssima) + 1 & ",IMPORTO_SINGOLA_RATA=" & par.VirgoleInPunti(Format((delta * -1) / numRate, "##,##0.00")) & " WHERE ID=" & par.IfNull(myReaderC("ID"), "")
                            par.cmd.ExecuteNonQuery()

                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) VALUES (" & idContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','F184','MODIFICATA VOCE Riduzione Canone GC 2761/14 DA euro " & par.VirgoleInPunti(par.IfNull(myReaderC("IMPORTO_SINGOLA_RATA"), "")) & " A euro " & par.VirgoleInPunti(Format((delta * -1) / numRate, "##,##0.00")) & " IN SEGUITO A RECA')"
                            par.cmd.ExecuteNonQuery()
                        End If
                    End If
                    myReaderC.Close()
                End If
                If esclusione <> "" Then
                    par.cmd.CommandText = "UPDATE SISCOM_MI.CANONI_EC SET ESCLUSIONE_1243_12='" & esclusione & "' WHERE ID_CONTRATTO=" & idContratto & " AND ID_DICHIARAZIONE=" & lIdDichiarazione & " AND ID_BANDO_AU IS NOT NULL"
                    par.cmd.ExecuteNonQuery()
                End If
            End If

            'Dim TestoFile As String = ""
            'Dim fileName As String = codContratto & ".txt"
            'Dim NuovoCanone As Double = 0
            'Dim NuovoTransitorio As Double = 0
            'Dim LOCATIVO As String = ""

            'Dim comunicazioni As String = ""
            'Dim AreaEcono As Integer = 0

            'Dim parte1 As String = ""
            'Dim parte2 As String = ""
            'Dim parte3 As String = ""
            'Dim parte4 As String = ""

            'TestoFile = Replace(par.CalcolaCanone27RECA(CDbl(HiddenID.Value), 3, idUnita, codContratto, nuovocanone, NuovoTransitorio, LOCATIVO, comunicazioni, AreaEcono, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPIANO, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL, parte1, parte2, parte3, parte4, Year(Now)), "CALCOLO CANONE L.R. 27/07", "CALCOLO CANONE L.R. 27/07 ANNO " & Year(Now))

            'STRdettaglio = STRdettaglio & vbCrLf & vbTab & "SCONTO COSTO BASE:........................................" & scontoCostoBase * -1 & "%"
            'STRdettaglio = STRdettaglio & vbCrLf & vbTab & "CANONE SCONTATO:.........................................." & Format(canoneScontato, "##,##0.00")
            'STRdettaglio = STRdettaglio & vbCrLf & vbTab & "DIFFERENZA DA APPLIC. IN BOLLETTA:........................" & Format(delta, "##,##0.00")

            'TestoFile = TestoFile & STRdettaglio

            'Dim sr As StreamWriter = New StreamWriter(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, False, System.Text.Encoding.Default)
            'sr.WriteLine(TestoFile)
            'sr.Close()

            'If System.IO.File.Exists(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName) = True Then

            '    par.cmd.CommandText = "UPDATE SISCOM_MI.CANONI_EC SET TESTO=:TESTO WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND ID_CONTRATTO = " & idContratto & " AND ID_BANDO_AU IS NOT NULL"

            '    Dim objStream As Stream = File.Open(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, FileMode.Open)
            '    Dim buffer(objStream.Length) As Byte
            '    objStream.Read(buffer, 0, objStream.Length)
            '    objStream.Close()

            '    Dim parmData As New Oracle.DataAccess.Client.OracleParameter
            '    With parmData
            '        .Direction = Data.ParameterDirection.Input
            '        .OracleDbType = Oracle.DataAccess.Client.OracleDbType.Blob
            '        .ParameterName = "TESTO"
            '        .Value = buffer
            '    End With

            '    par.cmd.Parameters.Add(parmData)
            '    par.cmd.ExecuteNonQuery()
            '    System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName)
            '    par.cmd.Parameters.Remove(parmData)

            '    buffer = Nothing
            '    objStream = Nothing
            'End If

        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try
    End Sub



    Public Sub ApplicaRiduzCanone()


        Dim CONTRATTO_30_ANNI As Boolean = False
        Try


            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans

            'FUNZIONE PER AGGIORNARE I COMPONENTI DEL CONTRATTO, NEL CASO IN CUI NE VENISSE ELIMINATO QUALCUNO NEL CORSO DELLA DOMANDA
            AggComponentiContratto()


            If sStato <> "4" Then
                If tipoRichiesta.Value = 3 Then 'Domanda di Riduzione Canone
                    'RevisioneXRiduzioneC()
                    NuovaRevisioneXRiduzioneC()
                ElseIf tipoRichiesta.Value = 2 Then ' Domanda di Ampliamento
                    RevisioneXAmpliamento()
                ElseIf tipoRichiesta.Value = 1 Then
                    RevisioneXSubentro()
                ElseIf tipoRichiesta.Value = 0 Then
                    ProvaVoltura()
                    'ElseIf tipoRichiesta.Value = 8 Then 'CAMBIO INTEST. FF.OO.
                    '    ProvaVoltura()
                    '    CambiaProvenienzaASS()
                ElseIf tipoRichiesta.Value = 6 Then 'SUBENTRO FF.OO.
                    RevisioneXSubentro()
                    CambiaProvenienzaASS()
                ElseIf tipoRichiesta.Value = 7 Then
                    InserimentoOspite()
                ElseIf tipoRichiesta.Value = 4 Then
                    ConfermaCambioArt22()
                ElseIf tipoRichiesta.Value = 8 Then
                    CreazionePosAbus()
                ElseIf tipoRichiesta.Value = 9 Then
                    CreazioneAbusammvo()
                ElseIf tipoRichiesta.Value = 10 Then
                    CreazioneERPda392()
                End If
            Else
                If tipoRichiesta.Value = 5 Then
                    CambioConsensuale()
                Else
                    Response.Write("<script>alert('Impossibile Procedere! Domanda non completa!');</script>")
                    errore = True
                End If
            End If

            If errore = False Then

                par.cmd.CommandText = "UPDATE DOMANDE_BANDO_VSA SET FL_AUTORIZZAZIONE='1',DATA_AUTORIZZAZIONE='" & par.AggiustaData(CType(Dom_Decisioni1.FindControl("txtdataAUTORIZ"), TextBox).Text) & "' WHERE ID=" & lIdDomanda
                par.cmd.ExecuteNonQuery()

                If lIdDomScambio <> 0 Then
                    par.cmd.CommandText = "UPDATE DOMANDE_BANDO_VSA SET FL_AUTORIZZAZIONE='1',DATA_AUTORIZZAZIONE='" & par.AggiustaData(CType(Dom_Decisioni1.FindControl("txtdataAUTORIZ"), TextBox).Text) & "' WHERE ID=" & lIdDomScambio
                    par.cmd.ExecuteNonQuery()
                End If

                If tipoRichiesta.Value = 0 Or tipoRichiesta.Value = 8 Or tipoRichiesta.Value = 9 Or tipoRichiesta.Value = 10 Then
                    If nuovoCodContr.Value <> "0" Then
                        par.cmd.CommandText = "UPDATE DOMANDE_BANDO_VSA SET FL_AUTORIZZAZIONE='1',DATA_AUTORIZZAZIONE='" & par.AggiustaData(CType(Dom_Decisioni1.FindControl("txtdataAUTORIZ"), TextBox).Text) & "', COD_CONTRATTO_BOZZA='" & nuovoCodContr.Value & "' WHERE ID=" & lIdDomanda
                        par.cmd.ExecuteNonQuery()

                    End If
                End If

                par.myTrans.Commit()
                par.myTrans = par.OracleConn.BeginTransaction()
                HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)

                par.myTrans.Commit()
                par.myTrans = par.OracleConn.BeginTransaction()
                HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)

                par.cmd.CommandText = "SELECT * FROM DOMANDE_BANDO_VSA WHERE ID=" & lIdDomanda & " FOR UPDATE NOWAIT"
                Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                myReader.Close()


                If tipoRichiesta.Value = 3 Then
                    '######## Label per Calcolo teorico ########
                    par.cmd.CommandText = "SELECT * FROM DOMANDE_BANDO_VSA WHERE ID = " & lIdDomanda & " AND CREDITO_TEORICO IS NOT NULL"
                    myReader = par.cmd.ExecuteReader
                    If myReader.Read Then
                        Dim tipo As String = "Debito"

                        If par.IfNull(myReader("CREDITO_TEORICO"), 0) < 0 Then
                            tipo = "Credito"
                        End If
                        'CType(Dom_Decisioni1.FindControl("lblCredito"), Label).Text = "" & tipo & " teorico: <b><a href='DettaglioCredito.aspx?ID=" & lIdDomanda & "' target='_blank'>" & Format(Math.Abs(par.IfNull(myReader("CREDITO_TEORICO"), 0)), "##,##0.00") & "</a></b> - Dal: <b>" & par.FormattaData(myReader("CT_DAL")) & "</b> Al: <b>" & par.FormattaData(myReader("CT_AL")) & "</b> - <a href='DettaglioTeorico.aspx?ID=" & lIdDomanda & "' target='_blank'>Dettagli Bollettato</a>"
                        CType(Dom_Decisioni1.FindControl("lblCredito"), Label).Text = "" & tipo & " teorico: <b><a href='../DettaglioCredito.aspx?ID=" & lIdDomanda & "' target='_blank'>" & Format(Math.Abs(par.IfNull(myReader("CREDITO_TEORICO"), 0)), "##,##0.00") & "</a></b> - Dal: <b>" & par.FormattaData(myReader("CT_DAL")) & "</b> Al: <b>" & par.FormattaData(myReader("CT_AL")) & "</b>"

                    End If
                    myReader.Close()
                    '######## fine Label per Calcolo teorico ########
                End If


                'If data_riconsegna.Value <> "" Then
                '    Session.Add("dataRicons", data_riconsegna.Value)
                'End If
                Response.Write("<script>alert('Operazione effettuata con successo!')</script>")

                If tipoRichiesta.Value = 3 Then
                    If Not String.IsNullOrEmpty(CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text) Then
                        Response.Write("<script>window.open('../Canone.aspx?ID=" & Me.HiddenID.Value & "&T=" & CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedValue & "&COD=" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "&IDUNITA=" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "&A=1', '', 'top=250,left=250,width=0,height=0,resizable=yes,menubar=yes,toolbar=no,scrollbars=yes','CanoneRegime');</script>")
                    End If
                End If
            End If

        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        Finally

        End Try


    End Sub

    '#####################
    '#####################
    '#####################
    Private Function RicavaInizioValidita(ByVal causaleDom As String, ByVal annoReddito As Integer, ByVal dataEvento As String) As String
        Dim dataInizioValidita As String = ""
        Dim meseSuccessDataEvento As String = ""
        Dim dataEventoPIU1 As String = ""
        Dim annoDataOggi As String = ""
        If Month(Now) = 12 Then
            annoDataOggi = Year(Now) + 1
        Else
            annoDataOggi = Year(Now)
        End If

        Try
            If dataEvento <> "" Then
                dataEventoPIU1 = par.FormattaData(Date.Parse(par.FormattaData(dataEvento), New System.Globalization.CultureInfo("it-IT", False)).AddMonths(1).ToString("dd/MM/yyyy"))
                meseSuccessDataEvento = Month(CDate(par.FormattaData(dataEventoPIU1)))
                If meseSuccessDataEvento < 10 Then
                    meseSuccessDataEvento = "0" & meseSuccessDataEvento
                End If
            End If

            Select Case causaleDom
                Case 17
                    dataInizioValidita = annoReddito + 1 & "0101"
                Case 18, 23
                    If annoReddito = "2007" Then
                        dataInizioValidita = annoReddito + 1 & "0101"
                    Else
                        If annoReddito Mod 2 = 0 Then
                            dataInizioValidita = Left(dataEvento, 4) & meseSuccessDataEvento & "01"
                        Else
                            If par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) <= annoReddito & "1231" Then
                                dataInizioValidita = Left(dataEvento, 4) & meseSuccessDataEvento & "01"
                            ElseIf par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) >= annoReddito + 1 & "0101" Then
                                dataInizioValidita = annoReddito + 1 & "0101"
                            End If
                        End If
                    End If
                Case 19
                    dataEventoPIU1 = par.FormattaData(Date.Parse(par.FormattaData(Format(Now, "yyyyMMdd")), New System.Globalization.CultureInfo("it-IT", False)).AddMonths(1).ToString("dd/MM/yyyy"))
                    meseSuccessDataEvento = Month(CDate(par.FormattaData(dataEventoPIU1)))
                    If meseSuccessDataEvento < 10 Then
                        meseSuccessDataEvento = "0" & meseSuccessDataEvento
                    End If
                    dataInizioValidita = annoDataOggi & meseSuccessDataEvento & "01"
                Case 20
                    If annoReddito Mod 2 = 0 Then 'ANNO PARI
                        dataInizioValidita = annoReddito + 2 & "0101"
                    Else
                        dataInizioValidita = annoReddito + 1 & "0101"
                    End If
                Case 21
                    If annoReddito = "2007" Then
                        dataInizioValidita = annoReddito + 1 & "0101"
                    Else
                        dataInizioValidita = Left(dataEvento, 4) & meseSuccessDataEvento & "01"
                    End If
                Case 22
                    If annoReddito = "2006" Then
                        dataInizioValidita = annoReddito + 2 & "0101"
                    ElseIf annoReddito = "2007" Then
                        dataInizioValidita = annoReddito + 1 & "0101"
                    Else
                        dataInizioValidita = dataEvento
                    End If
            End Select

        Catch ex As Exception
            Response.Write(ex.Message)
        End Try

        Return dataInizioValidita

    End Function

    Private Function RicavaFineValidita(ByVal causaleDom As String, ByVal annoReddito As Integer) As String
        Dim dataFineValidita As String = ""
        Try
            Select Case causaleDom
                Case 17
                    If annoReddito Mod 2 = 0 Then 'ANNO PARI
                        dataFineValidita = annoReddito + 1 & "1231"
                    Else
                        dataFineValidita = annoReddito + 2 & "1231"
                    End If
                Case 18
                    If annoReddito = "2007" Then
                        dataFineValidita = annoReddito + 2 & "1231"
                    Else
                        If annoReddito Mod 2 = 0 Then
                            dataFineValidita = annoReddito + 1 & "1231"

                        Else
                            If par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) <= annoReddito & "1231" Then
                                dataFineValidita = annoReddito & "1231"
                            ElseIf par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) >= annoReddito + 1 & "0101" Then
                                dataFineValidita = annoReddito + 2 & "1231"
                            End If
                        End If
                    End If
                Case 19, 20
                    If annoReddito Mod 2 = 0 Then
                        dataFineValidita = annoReddito + 3 & "1231"
                    Else
                        dataFineValidita = annoReddito + 2 & "1231"
                    End If
                Case 21
                    If annoReddito = "2007" Then
                        dataFineValidita = annoReddito + 1 & "1231"
                    Else
                        If annoReddito Mod 2 = 0 Then
                            dataFineValidita = annoReddito + 1 & "1231"
                        Else
                            dataFineValidita = annoReddito + 2 & "1231"
                        End If
                    End If
                Case 22
                    If annoReddito = "2006" Then
                        dataFineValidita = annoReddito + 2 & "1231"
                    ElseIf annoReddito = "2007" Then
                        dataFineValidita = annoReddito + 1 & "1231"
                    Else
                        If annoReddito Mod 2 = 0 Then
                            dataFineValidita = annoReddito + 3 & "1231"
                        Else
                            dataFineValidita = annoReddito + 2 & "1231"
                        End If
                    End If

            End Select

        Catch ex As Exception
            Response.Write(ex.Message)
        End Try

        Return dataFineValidita

    End Function

    Private Sub NuovaRevisioneXRiduzioneC()
        Try


            Dim SstringaSql As String = ""

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = 3 Then

                Dim NuovoCanone As Double = 0
                Dim NuovoTransitorio As Double = 0
                Dim LOCATIVO As String = ""
                Dim IDUNITA As Long = 0
                Dim comunicazioni As String = ""
                Dim AreaEconomica As Integer = 0

                Dim causaDom As String = ""
                Dim annoredd As Integer
                Dim dataInizio As String = ""
                Dim dataFine As String = ""
                Dim dataEvento As String = ""
                Dim idc As Long = 0
                Dim CanonePagato As Double = 0
                Dim InizioValidita As String = ""
                Dim FineValidita As String = ""
                Dim ANNO_INIZIO As Integer = 0
                Dim PER_ANNI As Integer = 0
                Dim I As Integer = 0
                Dim codContr As String = ""
                Dim canoneIniz As Double = 0
                Dim dataBollettUltima As String = ""
                Dim dataBollettazGener As String = ""
                'Dim ANNICONGUAGLIO As Integer = 0

                causaDom = CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue

                par.cmd.CommandText = "SELECT DICHIARAZIONI_VSA.DATA_INIZIO_VAL,DICHIARAZIONI_VSA.DATA_FINE_VAL,DICHIARAZIONI_VSA.ANNO_SIT_ECONOMICA,DOMANDE_BANDO_vsa.DATA_EVENTO,DOMANDE_BANDO_vsa.ID_CAUSALE_DOMANDA FROM DICHIARAZIONI_vsa,DOMANDE_BANDO_vsa WHERE DOMANDE_BANDO_vsa.ID=" & lIdDomanda & " AND DOMANDE_BANDO_vsa.ID_DICHIARAZIONE=DICHIARAZIONI_vsa.ID"
                Dim myReader0 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader0.Read Then
                    annoredd = par.IfNull(myReader0("ANNO_SIT_ECONOMICA"), "")
                    dataEvento = par.IfNull(myReader0("DATA_EVENTO"), "")
                    'InizioValidita = dataEvento 
                    InizioValidita = par.IfNull(myReader0("DATA_INIZIO_VAL"), "")

                    FineValidita = par.IfNull(myReader0("DATA_FINE_VAL"), "")

                    ANNO_INIZIO = CInt(Mid(par.IfNull(myReader0("DATA_INIZIO_VAL"), Year(Now)), 1, 4))

                    PER_ANNI = DateDiff(DateInterval.Year, CDate(par.FormattaData(myReader0("DATA_INIZIO_VAL"))), CDate(par.FormattaData(FineValidita)))


                    'PROROGA ASSEGNAZIONE TEMPORANEA
                    'If par.IfNull(myReader0("ID_CAUSALE_DOMANDA"), "") = "27" Then
                    '    PER_ANNI = 0
                    'End If

                End If
                myReader0.Close()

                'par.cmd.CommandText = "SELECT id,cod_contratto,IMP_CANONE_INIZIALE FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
                'myReader0 = par.cmd.ExecuteReader()
                'If myReader0.Read Then
                '    idc = myReader0("id")
                '    codContr = par.IfNull(myReader0("cod_contratto"), "")
                '    canoneIniz = par.IfNull(myReader0("IMP_CANONE_INIZIALE"), 0)
                'End If
                'myReader0.Close()

                par.cmd.CommandText = "SELECT * FROM siscom_mi.rapporti_utenza_prossima_bol WHERE prossima_bolletta IS NOT NULL ORDER BY prossima_bolletta DESC"
                Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader.Read Then
                    Select Case Mid(par.IfNull(myReader("PROSSIMA_BOLLETTA"), ""), 5, 2)
                        Case "01", "03", "05", "07", "08", "10", "12"
                            dataBollettazGener = DateAdd(DateInterval.Month, -1, CDate(par.FormattaData(par.IfNull(myReader("PROSSIMA_BOLLETTA"), "") & "31")))
                        Case "02"
                            dataBollettazGener = DateAdd(DateInterval.Month, -1, CDate(par.FormattaData(par.IfNull(myReader("PROSSIMA_BOLLETTA"), "") & "28")))
                        Case "04", "06", "09", "11"
                            dataBollettazGener = DateAdd(DateInterval.Month, -1, CDate(par.FormattaData(par.IfNull(myReader("PROSSIMA_BOLLETTA"), "") & "30")))
                    End Select
                End If
                myReader.Close()

                par.cmd.CommandText = "SELECT RAPPORTI_UTENZA.cod_contratto,rapporti_utenza.IMP_CANONE_INIZIALE,RAPPORTI_UTENZA.id,RAPPORTI_UTENZA_PROSSIMA_BOL.PROSSIMA_BOLLETTA FROM SISCOM_MI.RAPPORTI_UTENZA_PROSSIMA_BOL,SISCOM_MI.RAPPORTI_UTENZA WHERE RAPPORTI_UTENZA_PROSSIMA_BOL.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
                myReader0 = par.cmd.ExecuteReader()
                If myReader0.Read Then
                    idc = myReader0("id")
                    codContr = par.IfNull(myReader0("cod_contratto"), "")
                    canoneIniz = par.IfNull(myReader0("IMP_CANONE_INIZIALE"), 0)
                    Select Case Mid(par.IfNull(myReader0("PROSSIMA_BOLLETTA"), ""), 5, 2)
                        Case "01", "03", "05", "07", "08", "10", "12"
                            dataBollettUltima = DateAdd(DateInterval.Month, -1, CDate(par.FormattaData(par.IfNull(myReader0("PROSSIMA_BOLLETTA"), "") & "31")))
                        Case "02"
                            dataBollettUltima = DateAdd(DateInterval.Month, -1, CDate(par.FormattaData(par.IfNull(myReader0("PROSSIMA_BOLLETTA"), "") & "28")))
                        Case "04", "06", "09", "11"
                            dataBollettUltima = DateAdd(DateInterval.Month, -1, CDate(par.FormattaData(par.IfNull(myReader0("PROSSIMA_BOLLETTA"), "") & "30")))
                    End Select
                End If
                myReader0.Close()

                '03/06/2014 CERCO APPLICAZIONI DI CANONE SUCCESSIVE ALLA VALIDITA' DELLA DOMANDA
                Dim maxFineVal As String = ""
                par.cmd.CommandText = "SELECT MAX(FINE_VALIDITA_CAN) as maxFineVal FROM SISCOM_MI.CANONI_EC WHERE ID_CONTRATTO=" & idc & " AND TIPO_PROVENIENZA IN (SELECT ID FROM T_TIPO_PROVENIENZA WHERE VALIDA=1)"
                Dim myReaderF As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderF.Read Then
                    maxFineVal = par.IfNull(myReaderF("maxFineVal"), "")
                End If
                myReaderF.Close()

                Dim anno1 As Integer = 0
                Dim anno2 As Integer = 0

                aggVoce = False
                anno1 = Mid(InizioValidita, 1, 4)
                anno2 = Year(Now)

                If FineValidita >= maxFineVal Then
                    PER_ANNI = 0
                    For j As Integer = anno1 To anno2 - 1
                        PER_ANNI += 1
                    Next
                End If
                '03/06/2014 FINE

                par.cmd.CommandText = "SELECT ID FROM SISCOM_MI.UNITA_IMMOBILIARI WHERE ID= (SELECT ID_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE COD_UNITA_IMMOBILIARE ='" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "' and ID_cONTRATTO=" & idc & ")"
                Dim myReader1234 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader1234.Read() Then
                    IDUNITA = par.IfNull(myReader1234("ID"), 0)
                End If
                myReader1234.Close()

                Dim fileName As String = codContr & ".txt"
                Dim TestoFile As String = ""

                Dim TotaleCreditoDebito As Decimal = 0
                Dim TotaleCreditoANNO As Decimal = 0
                Dim TotaleCredito As Decimal = 0
                Dim TotaleCredito2 As Decimal = 0
                Dim parte1 As String = ""
                Dim parte2 As String = ""
                Dim parte3 As String = ""
                Dim parte4 As String = ""

                Dim TotSecondi As Integer = 0

                For I = ANNO_INIZIO To ANNO_INIZIO + PER_ANNI
                    TotSecondi = TotSecondi + 10
                    TotaleCreditoANNO = 0
                    LOCATIVO = ""
                    comunicazioni = ""
                    sISEE = ""
                    sISE = ""
                    sISR = ""
                    sISP = ""
                    sVSE = ""
                    sREDD_DIP = ""
                    sREDD_ALT = ""
                    sLimitePensione = ""
                    sPER_VAL_LOC = ""
                    sPERC_INC_MAX_ISE_ERP = ""
                    sCANONE_MIN = ""
                    sISE_MIN = ""
                    sCanone = ""
                    sNOTE = ""
                    sDEM = ""
                    sSUPCONVENZIONALE = ""
                    sCOSTOBASE = ""
                    sZONA = ""
                    sMOTIVODECADENZA = ""
                    parte1 = ""
                    parte2 = ""
                    parte3 = ""
                    parte4 = ""

                    TestoFile = Replace(par.CalcolaCanone27RECA(CDbl(HiddenID.Value), 3, IDUNITA, codContr, NuovoCanone, NuovoTransitorio, LOCATIVO, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPIANO, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL, parte1, parte2, parte3, parte4, I), "CALCOLO CANONE L.R. 27/07", "CALCOLO CANONE L.R. 27/07 ANNO " & I)

                    Dim tipoCanoneApp As String = ""

                    If NuovoCanone = sCANONECLASSEISTAT Then
                        tipoCanoneApp = "CLASSE"
                    ElseIf NuovoCanone = (sCANONE_MIN * 12) Then
                        tipoCanoneApp = "MINIMO AREA"
                    ElseIf NuovoCanone <> sCANONECLASSEISTAT Then
                        tipoCanoneApp = "SOPPORTABILE"
                    End If

                    If NuovoCanone <> 0 Then

                        'AGGIORNAMENTI M.TERESA 13/02/2012 - Calcolo del debito/credito teorico sulla base del canone che pagava nel periodo "inizio validità" - "fine validità"
                        Dim GiorniDiffEmesso As Long = 0
                        Dim MesiDiffEmesso As Integer = 0
                        Dim TotGiorniEmesso As Decimal = 0
                        Dim transit As Boolean = False

                        Dim GiorniDiffEmessoNuovo As Long = 0
                        Dim TotGiorniEmessoNuovo As Decimal = 0
                        Dim DeltaMensile As Decimal = 0
                        Dim DeltaGiorn As Decimal = 0
                        Dim DiffDaApplicare As Decimal = 0

                        Dim nuovoRiferimento As Decimal = 0

                        TotGiorniEmessoNuovo = Format(NuovoCanone / 12, "0.00")
                        Dim inizioCalcolo As String = ""
                        Dim fineCalcolo As String = ""

                        Dim canoneOLD As Decimal = 0

                        Select Case I
                            Case 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015
                                par.cmd.CommandText = "SELECT IMPORTO FROM CANONI_PRE_RECA WHERE ID_DOMANDA = " & lIdDomanda & " AND ANNO_RIFERIMENTO = " & I & " AND NUM_PARTE = 4"
                                Dim myReaderCanone As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                If myReaderCanone.Read Then
                                    If par.IfNull(myReaderCanone("IMPORTO"), 0) = 0 Then
                                        canoneOLD = canoneIniz
                                    Else
                                        canoneOLD = par.IfNull(myReaderCanone("IMPORTO"), 0)
                                    End If
                                Else
                                    canoneOLD = canoneIniz
                                End If
                                myReaderCanone.Close()
                                'Case 2008
                                '    par.cmd.CommandText = "SELECT CANONE_COMPETENZA_2008 FROM SISCOM_MI.ELABORAZIONE_CONGUAGLI WHERE COD_CONTRATTO='" & codContr & "'"
                                '    Dim myReaderCanone As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                '    If myReaderCanone.Read Then
                                '        canoneOLD = par.IfNull(myReaderCanone("CANONE_COMPETENZA_2008"), 0)
                                '    Else
                                '        par.cmd.CommandText = "SELECT IMPORTO FROM CANONI_PRE_RECA WHERE ID_DOMANDA = " & lIdDomanda & " AND ANNO_RIFERIMENTO = " & I & " AND NUM_PARTE = 4"
                                '        Dim myReaderCanone1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                '        If myReaderCanone1.Read Then
                                '            canoneOLD = par.IfNull(myReaderCanone1("IMPORTO"), 0)
                                '        Else
                                '            canoneOLD = canoneIniz
                                '        End If
                                '        myReaderCanone1.Close()
                                '    End If
                                '    myReaderCanone.Close()
                                'Case 2009
                                '    par.cmd.CommandText = "SELECT CANONE_COMPETENZA_2009 FROM SISCOM_MI.ELABORAZIONE_CONGUAGLI WHERE COD_CONTRATTO='" & codContr & "'"
                                '    Dim myReaderCanone As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                '    If myReaderCanone.Read Then
                                '        canoneOLD = par.IfNull(myReaderCanone("CANONE_COMPETENZA_2009"), 0)
                                '    Else
                                '        par.cmd.CommandText = "SELECT IMPORTO FROM CANONI_PRE_RECA WHERE ID_DOMANDA = " & lIdDomanda & " AND ANNO_RIFERIMENTO = " & I & " AND NUM_PARTE = 4"
                                '        Dim myReaderCanone1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                '        If myReaderCanone1.Read Then
                                '            canoneOLD = par.IfNull(myReaderCanone1("IMPORTO"), 0)
                                '        Else
                                '            canoneOLD = canoneIniz
                                '        End If
                                '        myReaderCanone1.Close()
                                '    End If
                                '    myReaderCanone.Close()
                                'Case 2010
                                '    par.cmd.CommandText = "SELECT CANONE_COMPETENZA_2010 FROM SISCOM_MI.ELABORAZIONE_CONGUAGLI WHERE COD_CONTRATTO='" & codContr & "'"
                                '    Dim myReaderCanone As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                '    If myReaderCanone.Read Then
                                '        canoneOLD = par.IfNull(myReaderCanone("CANONE_COMPETENZA_2010"), 0)
                                '    Else
                                '        par.cmd.CommandText = "SELECT IMPORTO FROM CANONI_PRE_RECA WHERE ID_DOMANDA = " & lIdDomanda & " AND ANNO_RIFERIMENTO = " & I & " AND NUM_PARTE = 4"
                                '        Dim myReaderCanone1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                '        If myReaderCanone1.Read Then
                                '            canoneOLD = par.IfNull(myReaderCanone1("IMPORTO"), 0)
                                '        Else
                                '            canoneOLD = canoneIniz
                                '        End If
                                '        myReaderCanone1.Close()
                                '    End If
                                '    myReaderCanone.Close()
                                'Case 2011
                                '    par.cmd.CommandText = "SELECT CANONE_COMPETENZA_2011 FROM SISCOM_MI.ELABORAZIONE_CONGUAGLI WHERE COD_CONTRATTO='" & codContr & "'"
                                '    Dim myReaderCanone As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                '    If myReaderCanone.Read Then
                                '        canoneOLD = par.IfNull(myReaderCanone("CANONE_COMPETENZA_2011"), 0)
                                '    Else
                                '        par.cmd.CommandText = "SELECT IMPORTO FROM CANONI_PRE_RECA WHERE ID_DOMANDA = " & lIdDomanda & " AND ANNO_RIFERIMENTO = " & I & " AND NUM_PARTE = 4"
                                '        Dim myReaderCanone1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                '        If myReaderCanone1.Read Then
                                '            canoneOLD = par.IfNull(myReaderCanone1("IMPORTO"), 0)
                                '        Else
                                '            canoneOLD = canoneIniz
                                '        End If
                                '        myReaderCanone1.Close()
                                '    End If
                                '    myReaderCanone.Close()

                                'Case 2012
                                '    par.cmd.CommandText = "SELECT CANONE_COMPETENZA_2012 FROM SISCOM_MI.ELABORAZIONE_CONGUAGLI WHERE COD_CONTRATTO='" & codContr & "'"
                                '    Dim myReaderCanone As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                '    If myReaderCanone.Read Then
                                '        canoneOLD = par.IfNull(myReaderCanone("CANONE_COMPETENZA_2012"), 0)
                                '    Else
                                '        par.cmd.CommandText = "SELECT IMPORTO FROM CANONI_PRE_RECA WHERE ID_DOMANDA = " & lIdDomanda & " AND ANNO_RIFERIMENTO = " & I & " AND NUM_PARTE = 4"
                                '        Dim myReaderCanone1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                '        If myReaderCanone1.Read Then
                                '            canoneOLD = par.IfNull(myReaderCanone1("IMPORTO"), 0)
                                '        Else
                                '            canoneOLD = canoneIniz
                                '        End If
                                '        myReaderCanone1.Close()
                                '    End If
                                '    myReaderCanone.Close()

                        End Select



                        TotaleCredito = 0

                        'DeltaMensile = (canoneOLD / 12) - TotGiorniEmessoNuovo
                        DeltaMensile = NuovoCanone - canoneOLD

                        Dim ggCredito As Integer = 0
                        Dim mesiCredito As Integer = 0

                        Dim riferimentoDa As String = ""

                        riferimentoDa = I & "1231"

                        ' ''par.cmd.CommandText = "SELECT SUM(BOL_BOLLETTE_VOCI.IMPORTO) AS IMP_EMESSO FROM SISCOM_MI.BOL_BOLLETTE,SISCOM_MI.BOL_BOLLETTE_VOCI,SISCOM_MI.T_VOCI_BOLLETTA WHERE BOL_BOLLETTE_VOCI.ID_BOLLETTA=BOL_BOLLETTE.ID " _
                        ' ''    & "AND T_VOCI_BOLLETTA.ID=BOL_BOLLETTE_VOCI.ID_VOCE AND T_VOCI_BOLLETTA.ID IN (" _
                        ' ''    & "525,10001,10002,30003,530," _
                        ' ''    & "30075,1,10072,10087,10125," _
                        ' ''    & "10135,20003,20019,20020," _
                        ' ''    & "20023,20096,20097,553," _
                        ' ''    & "10075,10128,20021,10127," _
                        ' ''    & "10126,512,10074,534,10073," _
                        ' ''    & "604,30071,603,30068,506," _
                        ' ''    & "647,653,599,648,30080,622," _
                        ' ''    & "30123,30124,508,10160,509," _
                        ' ''    & "10161,10162,30081,575,650,686,687,688,689,690,691,36,10003,701,702,703,704,705) " _
                        ' ''    & "AND RIFERIMENTO_DA<='" & I & "1231' AND RIFERIMENTO_A>='" & I & "0101' AND ID_TIPO<>5 AND ID_TIPO<>4 AND (FL_ANNULLATA=0 OR (FL_ANNULLATA<>0 AND NVL(IMPORTO_PAGATO,0)>0)) " _
                        ' ''    & "AND ID_CONTRATTO=" & idc & " ORDER BY RIFERIMENTO_DA DESC,RIFERIMENTO_A DESC"
                        ' ''myReader0 = par.cmd.ExecuteReader()
                        ' ''Do While myReader0.Read
                        'GiorniDiffEmesso = DateDiff(DateInterval.Day, CDate(par.FormattaData(myReader0("riferimento_da"))), CDate(par.FormattaData(myReader0("riferimento_a"))))


                        'If GiorniDiffEmesso = 0 Then GiorniDiffEmesso = 1
                        'If GiorniDiffEmesso = 27 Then GiorniDiffEmesso = 30
                        'If GiorniDiffEmesso = 28 Then GiorniDiffEmesso = 30
                        'If GiorniDiffEmesso = 29 Then GiorniDiffEmesso = 30
                        'If GiorniDiffEmesso = 31 Then GiorniDiffEmesso = 30
                        'If GiorniDiffEmesso = 91 Then GiorniDiffEmesso = 90
                        'If GiorniDiffEmesso = 92 Then GiorniDiffEmesso = 90
                        'If GiorniDiffEmesso = 59 Then GiorniDiffEmesso = 60
                        'If GiorniDiffEmesso = 61 Then GiorniDiffEmesso = 60
                        'If GiorniDiffEmesso = 364 Then GiorniDiffEmesso = 360
                        'If GiorniDiffEmesso = 365 Then GiorniDiffEmesso = 360
                        'If GiorniDiffEmesso = 366 Then GiorniDiffEmesso = 360

                        'TotGiorniEmesso = par.IfNull(myReader0("imp_EMESSO"), 0) / GiorniDiffEmesso

                        'DIFFERENZA IN GIORNI TRA INIZIO VALIDITA' E FINE VALIDITA'
                        If I & "0101" < InizioValidita Then
                            inizioCalcolo = InizioValidita
                        Else
                            inizioCalcolo = I & "0101"
                        End If

                        If I & "1231" < FineValidita Then
                            fineCalcolo = I & "1231"
                            If fineCalcolo > par.AggiustaData(dataBollettUltima) Then
                                fineCalcolo = par.AggiustaData(dataBollettUltima)
                            End If
                        Else
                            If I >= Year(Now) Then
                                fineCalcolo = par.AggiustaData(dataBollettUltima)
                            Else
                                fineCalcolo = FineValidita
                            End If
                        End If

                        'GiorniDiffEmesso = DateDiff(DateInterval.Day, CDate(par.FormattaData(inizioCalcolo)), CDate(par.FormattaData(fineCalcolo)))

                        Dim numMesiBolle As Integer = 0
                        numMesiBolle = DateDiff(DateInterval.Month, CDate(par.FormattaData(inizioCalcolo)), CDate(par.FormattaData(fineCalcolo))) - 1
                        If GiorniDiffEmesso < 0 Then
                            GiorniDiffEmesso = 0
                        End If
                        GiorniDiffEmesso = numMesiBolle * 30
                        Dim giorniPrimoMese As Integer = 0
                        Dim giorniUltimoMese As Integer = 0

                        If CInt(inizioCalcolo.Substring(6, 2)) > 30 Then
                            giorniPrimoMese = 30
                        Else
                            giorniPrimoMese = (30 - inizioCalcolo.Substring(6, 2)) + 1
                        End If
                        If CInt(fineCalcolo.Substring(6, 2)) = 28 And CInt(fineCalcolo.Substring(4, 2)) = 2 Then
                            giorniUltimoMese = 30
                        Else
                            If CInt(fineCalcolo.Substring(6, 2)) = 31 Then
                                giorniUltimoMese = 30
                            Else
                                giorniUltimoMese = fineCalcolo.Substring(6, 2)
                            End If
                        End If

                        GiorniDiffEmesso = GiorniDiffEmesso + giorniPrimoMese + giorniUltimoMese


                        'If GiorniDiffEmesso = 0 Then GiorniDiffEmesso = 1
                        'If GiorniDiffEmesso = 27 Then GiorniDiffEmesso = 30
                        'If GiorniDiffEmesso = 28 Then GiorniDiffEmesso = 30
                        'If GiorniDiffEmesso = 29 Then GiorniDiffEmesso = 30
                        'If GiorniDiffEmesso = 31 Then GiorniDiffEmesso = 30
                        'If GiorniDiffEmesso = 91 Then GiorniDiffEmesso = 90
                        'If GiorniDiffEmesso = 92 Then GiorniDiffEmesso = 90
                        'If GiorniDiffEmesso = 58 Then GiorniDiffEmesso = 60
                        'If GiorniDiffEmesso = 59 Then GiorniDiffEmesso = 60
                        'If GiorniDiffEmesso = 61 Then GiorniDiffEmesso = 60
                        'If GiorniDiffEmesso = 364 Then GiorniDiffEmesso = 360
                        'If GiorniDiffEmesso = 365 Then GiorniDiffEmesso = 360
                        'If GiorniDiffEmesso = 366 Then GiorniDiffEmesso = 360

                        'If GiorniDiffEmesso Mod 30 <> 0 And GiorniDiffEmesso >= 30 Then GiorniDiffEmesso = GiorniDiffEmesso - (GiorniDiffEmesso Mod 30)

                        If I = Year(Now) Then
                            TotGiorniEmesso = ((DeltaMensile / 360) * GiorniDiffEmesso) ' - (((par.IfNull(myReader0("imp_EMESSO"), 0) * (360 / GiorniDiffEmesso)) / 360) * GiorniDiffEmesso)
                        Else
                            TotGiorniEmesso = ((DeltaMensile / 360) * GiorniDiffEmesso) ' - (((par.IfNull(myReader0("imp_EMESSO"), 0) * (1)) / 360) * GiorniDiffEmesso)
                        End If



                        'DeltaGiorn = DeltaMensile / 30

                        'If par.IfNull(myReader0("ID_TIPO"), "") = 12 Or TotGiorniEmesso < 0 Then
                        '    DiffDaApplicare = TotGiorniEmesso * -1
                        'Else
                        '    If Format(TotGiorniEmesso * GiorniDiffEmesso, "0.00") = Format((canoneOLD / 12) * (GiorniDiffEmesso / 30), "0.00") Then
                        '        DiffDaApplicare = DeltaGiorn * -1
                        '    Else
                        '        DiffDaApplicare = (DeltaGiorn - (((canoneOLD / 12) / 30) - TotGiorniEmesso)) * -1
                        '    End If
                        'End If

                        'If myReader0("riferimento_da") < InizioValidita Then
                        '    inizioCalcolo = InizioValidita
                        'Else
                        '    inizioCalcolo = myReader0("riferimento_da")
                        'End If

                        'If myReader0("riferimento_a") < FineValidita Then
                        '    fineCalcolo = myReader0("riferimento_a")
                        'Else
                        '    fineCalcolo = FineValidita
                        'End If

                        'ggCredito = DateDiff(DateInterval.Day, CDate(par.FormattaData(inizioCalcolo)), CDate(par.FormattaData(fineCalcolo)))

                        'If ggCredito = 0 Then ggCredito = 1
                        'If ggCredito = 27 Then ggCredito = 30
                        'If ggCredito = 28 Then ggCredito = 30
                        'If ggCredito = 29 Then ggCredito = 30
                        'If ggCredito = 31 Then ggCredito = 30
                        'If ggCredito = 91 Then ggCredito = 90
                        'If ggCredito = 92 Then ggCredito = 90
                        'If ggCredito = 59 Then ggCredito = 60
                        'If ggCredito = 61 Then ggCredito = 60
                        'If ggCredito = 364 Then ggCredito = 360
                        'If ggCredito = 365 Then ggCredito = 360
                        'If ggCredito = 366 Then ggCredito = 360
                        'If ggCredito Mod 30 <> 0 And ggCredito >= 30 Then ggCredito = ggCredito - (ggCredito Mod 30)

                        'If DateDiff(DateInterval.Day, CDate(par.FormattaData(inizioCalcolo)), CDate(par.FormattaData(fineCalcolo))) > 0 Then
                        '    TotaleCredito = TotaleCredito + Format(ggCredito * DiffDaApplicare, "0.00")
                        '    par.cmd.CommandText = "INSERT INTO VSA_BOL_RID_CANONE (ID_DOMANDA,ID_BOLLETTA,IMPORTO,FL_CONTABILIZZATO,IMPORTO_CR_DB) VALUES (" & lIdDomanda & "," & myReader0("ID") & "," & par.VirgoleInPunti(Format(ggCredito * TotGiorniEmesso, "0.00")) & ",0," & par.VirgoleInPunti(Format(ggCredito * DiffDaApplicare, "0.00")) & ")"
                        '    par.cmd.ExecuteNonQuery()
                        'End If

                        '''Loop
                        '''myReader0.Close()

                        'par.cmd.CommandText = "INSERT INTO VSA_CREDITI_RID_CANONE (ID_DOMANDA,IMPORTO,ANNO) VALUES (" & lIdDomanda & "," & par.VirgoleInPunti(Format(TotaleCredito, "0.00")) & "," & I & ")"
                        'par.cmd.ExecuteNonQuery()

                        If I <= Mid(FineValidita, 1, 4) Then
                            par.cmd.CommandText = "INSERT INTO VSA_CREDITI_RID_CANONE (ID_DOMANDA,IMPORTO,ANNO) VALUES (" & lIdDomanda & "," & par.VirgoleInPunti(Format(TotGiorniEmesso, "0.00")) & "," & I & ")"
                            par.cmd.ExecuteNonQuery()

                            TotaleCreditoDebito = TotaleCreditoDebito + TotGiorniEmesso
                        End If
                        Dim sr As StreamWriter = New StreamWriter(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, False, System.Text.Encoding.Default)
                        sr.WriteLine(TestoFile)
                        sr.Close()

                        'VARIABILE TIPO PROV.
                        Dim tipoProv As Integer = 0
                        Dim ultimoAnno As String = ""

                        If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = "27" Then
                            tipoProv = 6
                        Else
                            tipoProv = 1
                        End If

                        If I = 2013 Then
                            ultimoAnno = "3"
                        End If
                        If I = 2014 Then
                            ultimoAnno = "5"
                        End If


                        Dim dataCalcolo As Date = DateAdd("s", TotSecondi, Now)

                        If System.IO.File.Exists(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName) = True Then
                            If sNOTE = "" Then
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC_LOCATARI (CANONE_CLASSE,CANONE_SOPPORTABILE,DECADENZA_ALL_ADEGUATO,DECADENZA_VAL_ICI,CANONE_MINIMO_AREA,VALORE_LOCATIVO,SUP_ACCESSORI,MINORI_15,MAGGIORI_65,DATA_STIPULA,COD_CONTRATTO,ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,ISE, ISR, ISP, PSE, VSE, REDDITI_DIP, REDDITI_ATRI, LIMITE_PENSIONI, " _
                                                    & "ISEE_27, PERC_VAL_LOC, INC_MAX, CANONE,TESTO,NOTE,ID_BANDO_AU,DEM, SUPCONVENZIONALE, COSTOBASE, ZONA, PIANO, CONSERVAZIONE, VETUSTA,INCIDENZA_ISE," _
                                                    & "COEFF_NUCLEO_FAM,SOTTO_AREA,ANNOTAZIONI,PATRIMONIO_SUP,NON_RISPONDENTE,LIMITE_ISEE,ID_DICHIARAZIONE,CANONE_ATTUALE,ADEGUAMENTO,ISTAT," _
                                                    & "NUM_COMP,NUM_COMP_66,NUM_COMP_100,NUM_COMP_100_CON,REDD_PREV_DIP,DETRAZIONI,REDD_MOBILIARI,REDD_IMMOBILIARI,REDD_COMPLESSIVO,DETRAZIONI_FRAGILITA,ANNO_COSTRUZIONE," _
                                                    & "LOCALITA,PRESENTE_ASCENSORE,NUMERO_PIANO,SUP_NETTA,ALTRE_SUP,PERC_ISTAT_APPLICATA,CANONE_CLASSE_ISTAT,CANONE_91,INIZIO_VALIDITA_CAN,FINE_VALIDITA_CAN,TIPO_PROVENIENZA,COMPETENZA,TIPO_CANONE_APP) " _
                                                    & "VALUES ('" & sCANONECLASSE & "','" & sCANONESOPP & "','" & sALLOGGIOIDONEO & "','" & sVALOCIICI & "','" & sCANONE_MIN & "','" & sVALORELOCATIVO & "','" & par.PulisciStrSql(sSUPACCESSORI) & "'," & sMINORI15 & "," & sMAGGIORI65 & ",'" & par.AggiustaData(CType(Dom_Alloggio_ERP1.FindControl("txtDecorrenza"), TextBox).Text) & "','" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'," & idc & ",'" & Format(dataCalcolo, "yyyyMMddHHmmss") _
                                                    & "'," & AreaEconomica & ",'" & sISEE & "','" & sISE & "','" & sISR & "','" & sISP & "','" & sPSE & "','" & sVSE & "','" & sREDD_DIP & "','" _
                                                    & sREDD_ALT & "','" & sLimitePensione & "','" & sISE_MIN & "','" & sPER_VAL_LOC & "','" & sPERC_INC_MAX_ISE_ERP & "','" & sCanone & "',:TESTO,'" _
                                                    & par.PulisciStrSql(sNOTE) & "','" & ultimoAnno & "','" & sDEM & "','" & sSUPCONVENZIONALE & "','" & sCOSTOBASE & "','" & sZONA & "','" & sPIANO & "','" _
                                                    & sCONSERVAZIONE & "','" & sVETUSTA & "','" & sINCIDENZAISE & "','" & sCOEFFFAM & "','" & sSOTTOAREA & "','" & sMOTIVODECADENZA & "'," _
                                                    & "0" & ",0," & "0" & "," & "" & lIdDichiarazione & "" _
                                                    & ",'" & "0" & "','" & "0" & "','" _
                                                    & "0" & "'," & sNUMCOMP & "," & sNUMCOMP66 & "," & sNUMCOMP100 & "," & sNUMCOMP100C & "," & sPREVDIP _
                                                    & ",'" & sDETRAZIONI & "','" & sMOBILIARI & "','" & sIMMOBILIARI & "','" & sCOMPLESSIVO & "','" & sDETRAZIONEF & "','" & sANNOCOSTRUZIONE & "','" & par.PulisciStrSql(sLOCALITA) _
                                                    & "','" & sASCENSORE & "','" & par.PulisciStrSql(sDESCRIZIONEPIANO) & "','" & sSUPNETTA & "','" & par.PulisciStrSql(sALTRESUP) & "','" & sISTAT & "','" & sCANONECLASSEISTAT & "','0','" & sANNOINIZIOVAL & "','" & sANNOFINEVAL & "'," & tipoProv & "," & I & ",'" & tipoCanoneApp & "') "
                            Else
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC_LOCATARI (CANONE_CLASSE,CANONE_SOPPORTABILE,DECADENZA_ALL_ADEGUATO,DECADENZA_VAL_ICI,CANONE_MINIMO_AREA,VALORE_LOCATIVO,SUP_ACCESSORI,MINORI_15,MAGGIORI_65,DATA_STIPULA,COD_CONTRATTO,ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,ISE, ISR, ISP, PSE, VSE, REDDITI_DIP, REDDITI_ATRI," _
                                                    & "LIMITE_PENSIONI, ISEE_27, PERC_VAL_LOC, INC_MAX, CANONE,TESTO,NOTE,ID_BANDO_AU,ANNOTAZIONI,PATRIMONIO_SUP,NON_RISPONDENTE,LIMITE_ISEE,ID_DICHIARAZIONE," _
                                                    & "CANONE_ATTUALE,ADEGUAMENTO,ISTAT,NUM_COMP,NUM_COMP_66,NUM_COMP_100,NUM_COMP_100_CON,REDD_PREV_DIP,DETRAZIONI,REDD_MOBILIARI,REDD_IMMOBILIARI," _
                                                    & "REDD_COMPLESSIVO,DETRAZIONI_FRAGILITA,ANNO_COSTRUZIONE,LOCALITA,PRESENTE_ASCENSORE,NUMERO_PIANO,SUP_NETTA,ALTRE_SUP,PERC_ISTAT_APPLICATA,CANONE_CLASSE_ISTAT,CANONE_91,INIZIO_VALIDITA_CAN,FINE_VALIDITA_CAN,TIPO_PROVENIENZA,COMPETENZA,TIPO_CANONE_APP) " _
                                                    & "VALUES ('" & sCANONECLASSE & "','" & sCANONESOPP & "','" & sALLOGGIOIDONEO & "','" & sVALOCIICI & "','" & sCANONE_MIN & "','" & sVALORELOCATIVO & "','" & par.PulisciStrSql(sSUPACCESSORI) & "'," & sMINORI15 & "," & sMAGGIORI65 & ",'" & par.AggiustaData(CType(Dom_Alloggio_ERP1.FindControl("txtDecorrenza"), TextBox).Text) & "','" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'," & idc & ",'" & Format(dataCalcolo, "yyyyMMddHHmmss") & "',NULL,'','','','','','','','','','','','','',:TESTO,'" & _
                                                    par.PulisciStrSql(sNOTE) & "','" & ultimoAnno & "','" & sMOTIVODECADENZA & "',0,0,0," _
                                                    & "" & lIdDichiarazione & "" & ",'0','0" _
                                                    & "','0'," & sNUMCOMP & "," & sNUMCOMP66 & "," & sNUMCOMP100 & "," & sNUMCOMP100C & "," & sPREVDIP _
                                                    & ",'" & sDETRAZIONI & "','" & sMOBILIARI & "','" & sIMMOBILIARI & "','" & sCOMPLESSIVO & "','" & sDETRAZIONEF & "','" & sANNOCOSTRUZIONE & "','" _
                                                    & par.PulisciStrSql(sLOCALITA) & "','" & sASCENSORE & "','" & par.PulisciStrSql(sDESCRIZIONEPIANO) & "','" & sSUPNETTA & "','" & par.PulisciStrSql(sALTRESUP) & "','" & sISTAT & "','" & sCANONECLASSEISTAT & "','0','" & sANNOINIZIOVAL & "','" & sANNOFINEVAL & "'," & tipoProv & "," & I & ",'" & tipoCanoneApp & "') "

                            End If

                            Dim objStream As Stream = File.Open(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, FileMode.Open)
                            Dim buffer(objStream.Length) As Byte
                            objStream.Read(buffer, 0, objStream.Length)
                            objStream.Close()

                            Dim parmData As New Oracle.DataAccess.Client.OracleParameter
                            With parmData
                                .Direction = Data.ParameterDirection.Input
                                .OracleDbType = Oracle.DataAccess.Client.OracleDbType.Blob
                                .ParameterName = "TESTO"
                                .Value = buffer
                            End With

                            par.cmd.Parameters.Add(parmData)
                            par.cmd.ExecuteNonQuery()


                            System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName)
                            par.cmd.Parameters.Remove(parmData)

                            buffer = Nothing
                            objStream = Nothing
                        End If
                    End If
                Next

                Dim contaRighe As Integer = 0
                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.CANONI_EC_LOCATARI WHERE ID_CONTRATTO=" & idc & " AND ID_DICHIARAZIONE=" & lIdDichiarazione & " ORDER BY COMPETENZA ASC"
                Dim daCL As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
                Dim dtCL As New Data.DataTable
                daCL.Fill(dtCL)
                If dtCL.Rows.Count Then
                    For Each row As Data.DataRow In dtCL.Rows
                        contaRighe = contaRighe + 1
                        If contaRighe = 1 Then
                            par.cmd.CommandText = "UPDATE SISCOM_MI.CANONI_EC_LOCATARI SET INIZIO_VALIDITA_CAN='" & sANNOINIZIOVAL & "',FINE_VALIDITA_CAN='" & row.Item("COMPETENZA") & "1231' WHERE ID_CONTRATTO=" & idc & " AND ID_DICHIARAZIONE=" & lIdDichiarazione & " AND COMPETENZA=" & row.Item("COMPETENZA")
                        Else
                            'If contaRighe = dtCL.Rows.Count Then
                            '    par.cmd.CommandText = "UPDATE SISCOM_MI.CANONI_EC_LOCATARI SET INIZIO_VALIDITA_CAN='" & row.Item("COMPETENZA") & "0101',FINE_VALIDITA_CAN='" & row.Item("COMPETENZA") & "1231' WHERE ID_CONTRATTO=" & idc & " AND ID_DICHIARAZIONE=" & lIdDichiarazione & " AND COMPETENZA=" & row.Item("COMPETENZA")
                            'Else
                            par.cmd.CommandText = "UPDATE SISCOM_MI.CANONI_EC_LOCATARI SET INIZIO_VALIDITA_CAN='" & row.Item("COMPETENZA") & "0101',FINE_VALIDITA_CAN='" & row.Item("COMPETENZA") & "1231' WHERE ID_CONTRATTO=" & idc & " AND ID_DICHIARAZIONE=" & lIdDichiarazione & " AND COMPETENZA=" & row.Item("COMPETENZA")
                            'End If
                        End If
                        par.cmd.ExecuteNonQuery()
                    Next
                End If

                par.cmd.CommandText = "UPDATE DOMANDE_BANDO_VSA SET CANONE_CALCOLATO='" & NuovoCanone & "',CT_DAL = '" & InizioValidita & "', CT_AL = '" & FineValidita & "', CREDITO_TEORICO = " & par.VirgoleInPunti(Format(TotaleCreditoDebito, "0.00")) & " WHERE ID = " & lIdDomanda & " AND ID_DICHIARAZIONE = " & lIdDichiarazione
                par.cmd.ExecuteNonQuery()


                '*************evento revisione canone
                SstringaSql = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                                & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                                & "','F179','','')"
                par.cmd.CommandText = SstringaSql
                par.cmd.ExecuteNonQuery()
                CType(Dom_Decisioni1.FindControl("autorizzFinale"), HiddenField).Value = 1
                IMGCanone.Visible = False

            Else
                'alert impossibile avviare riduzione canone
                Response.Write("<script>alert('La domanda non è di tipo riduzione canone!');</script>")
            End If
        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try
    End Sub




    Private Sub RevisioneXAmpliamento()
        Try
            Dim SstringaSql As String = ""
            Dim idc As Long = 0

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = 2 Then

                par.cmd.CommandText = "SELECT imp_canone_iniziale,id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
                Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderX1.Read Then
                    idc = myReaderX1("id")
                End If
                myReaderX1.Close()

                '######### AGGIORNAMENTO DI SOGGETTI CONTRATTUALI PER NUOVI COMPONENTI DEL NUCLEO
                par.cmd.CommandText = "SELECT COMP_NUCLEO_VSA.ID,id_dichiarazione,cod_fiscale,cognome,nome,sesso,data_nascita,perc_inval,indennita_acc,grado_parentela," _
                                    & "DICHIARAZIONI_VSA.id_luogo_res_dnte,DICHIARAZIONI_VSA.id_tipo_ind_res_dnte,DICHIARAZIONI_VSA.ind_res_dnte,DICHIARAZIONI_VSA.civico_res_dnte,DICHIARAZIONI_VSA.cap_res_dnte " _
                                    & "FROM NUOVI_COMP_NUCLEO_VSA,COMP_NUCLEO_VSA,DICHIARAZIONI_VSA " _
                                    & "WHERE id_componente = COMP_NUCLEO_VSA.ID " _
                                    & "AND DICHIARAZIONI_VSA.ID=COMP_NUCLEO_VSA.id_dichiarazione " _
                                    & "AND id_dichiarazione = " & lIdDichiarazione

                Dim da As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
                Dim dt As New Data.DataTable
                da.Fill(dt)
                For Each row As Data.DataRow In dt.Rows
                    par.cmd.CommandText = "select id from siscom_mi.anagrafica where cod_fiscale = '" & par.IfNull(row.Item("COD_FISCALE"), "") & "'"
                    Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
                    Dim idAnagrafico As String = ""
                    Dim codParentela As String = ""
                    If myReader.Read Then
                        idAnagrafico = par.IfNull(myReader("ID"), "")
                    End If
                    myReader.Close()

                    If idAnagrafico = "" Then
                        idAnagrafico = InserInAnagrafica(row)
                    End If


                    '****** GRADO PARENTELA ******
                    par.cmd.CommandText = "select * from t_tipo_parentela where cod=" & par.IfNull(row.Item("grado_parentela"), "")
                    myReader = par.cmd.ExecuteReader
                    If myReader.Read Then
                        codParentela = par.IfNull(myReader("cod_siscom_mi"), "")
                    End If
                    myReader.Close()
                    '****** fine GRADO PARENTELA ******


                    par.cmd.CommandText = ""
                    If idc > 0 Then
                        par.cmd.CommandText = "insert into siscom_mi.soggetti_contrattuali " _
                                            & "(id_anagrafica,id_contratto,cod_tipologia_parentela,cod_tipologia_occupante,cod_tipologia_titolo,data_inizio,data_fine) values" _
                                            & "(" & idAnagrafico & "," & idc & ",'" & codParentela & "','ALTR','LEGIT','" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text) & "','29991231')"
                        par.cmd.ExecuteNonQuery()
                    Else
                        'Blocco perchè non trovo id_contratto
                    End If

                Next
                '######### FINE AGGIORNAMENTO DI SOGGETTI CONTRATTUALI PER NUOVI COMPONENTI DEL NUCLEO


                '*************evento AMPLIAMENTO
                SstringaSql = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                                & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                                & "','F179','','')"
                par.cmd.CommandText = SstringaSql
                par.cmd.ExecuteNonQuery()
                CType(Dom_Decisioni1.FindControl("autorizzFinale"), HiddenField).Value = 1


                'par.cmd.CommandText = "select * from comp_nucleo_vsa"

            Else
                Response.Write("<script>alert('La domanda non è di tipo ampliamento!');</script>")
            End If

        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try
    End Sub

    Private Sub CambiaProvenienzaASS()
        Dim par1 As New CM.Global
        Try
            par.cmd.CommandText = "UPDATE SISCOM_MI.UNITA_IMMOBILIARI SET ID_DESTINAZIONE_USO=1 WHERE ID IN (SELECT id_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE COD_UNITA_IMMOBILIARE='" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "' AND ID_UNITA_PRINCIPALE IS NULL)"
            par.cmd.ExecuteNonQuery()

            If Not IsNothing(Session.Item("lIdConnessione")) Then
                par1.OracleConn = CType(HttpContext.Current.Session.Item(Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleConnection)
                par1.cmd = par1.OracleConn.CreateCommand()
                par1.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleTransaction)
                ''par1.cmd.Transaction = par1.myTrans

                par1.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET PROVENIENZA_ASS=1 WHERE ID IN (SELECT id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "')"
                par1.cmd.ExecuteNonQuery()

                par1.myTrans.Commit()
                par1.myTrans = par1.OracleConn.BeginTransaction()
                HttpContext.Current.Session.Add("TRANSAZIONE" & Session.Item("lIdConnessione"), par1.myTrans)
                par1.Dispose()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            End If

        Catch ex As Exception
            par1.myTrans.Commit()
            par1.myTrans = par1.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & Session.Item("lIdConnessione"), par1.myTrans)
            par1.Dispose()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
        End Try
    End Sub

    Private Sub ConfermaCambioArt22()
        Try
            Dim SstringaSql As String = ""
            Dim IdContratto As Long = 0

            par.cmd.CommandText = "SELECT id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderX1.Read Then
                IdContratto = myReaderX1("id")
            End If
            myReaderX1.Close()

            'par.cmd.CommandText = "SELECT * FROM DOMANDE_BANDO_VSA WHERE ID=" & lIdDomanda
            'myReaderX1 = par.cmd.ExecuteReader()
            'If myReaderX1.Read Then
            '    If par.IfNull(myReaderX1("FL_ASS_ESTERNA"), "") = "0" Then
            '        Response.Write("<script>alert('Attenzione! Stampare la domanda prima di procedere!');</script>")
            '        errore = True
            '        Exit Sub
            '    End If
            'End If
            'myReaderX1.Close()

            par.cmd.CommandText = "update domande_bando_vsa set ID_STATO='9',FL_CONTROLLA_REQUISITI='2' where id= " & lIdDomanda
            par.cmd.ExecuteNonQuery()

            SstringaSql = "INSERT INTO EVENTI_BANDI_VSA (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                        & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                        & "','F208','','I')"
            par.cmd.CommandText = SstringaSql
            par.cmd.ExecuteNonQuery()


            '************* 08/11/2012 INSERIMENTO AVVISO PER CONDOMINI ********
            Dim IdUI As Long = 0
            par.cmd.CommandText = "SELECT id_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & IdContratto
            Dim myReaderUI As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderUI.Read Then
                IdUI = myReaderUI("id_UNITA")
            End If
            myReaderUI.Close()

            '************* 08/11/2012 FINE SCRITTURA EVENTO PER CONDOMINI ********
            par.cmd.CommandText = "SELECT cond_edifici.* FROM SISCOM_MI.COND_EDIFICI,SISCOM_MI.EDIFICI,SISCOM_MI.UNITA_IMMOBILIARI WHERE UNITA_IMMOBILIARI.ID=" & IdUI & " AND EDIFICI.ID=UNITA_IMMOBILIARI.ID_EDIFICIO AND COND_EDIFICI.ID_EDIFICIO=EDIFICI.ID"
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            Do While myReader.Read
                par.cmd.CommandText = "INSERT INTO SISCOM_MI.COND_AVVISI (ID_TIPO,ID_UI,DATA,VISTO,ID_CONDOMINIO,ID_CONTRATTO) VALUES (6," & IdUI & ",'" & Format(Now, "yyyyMMdd") & "',0," & myReader("ID_CONDOMINIO") & "," & IdContratto & ")"
                par.cmd.ExecuteNonQuery()
            Loop
            myReader.Close()
            '************* 08/11/2012 FINE SCRITTURA EVENTO PER CONDOMINI ********

        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try
    End Sub
    Private Sub RevisioneXSubentro()
        Try
            Dim IdContratto As String = ""
            Dim IdAnagRichiedente As String = ""
            Dim IdExintestatario As String = ""
            Dim CognomeNome As String = ""
            Dim TipoIndir As String = ""
            Dim Indirizzo As String = ""
            Dim Civico As String = ""
            Dim LuogoRec As String = ""
            Dim Sigla As String = ""
            Dim Cap As String = ""
            Dim IdUI As Long = 0
            Dim codFiscRich As String = ""

            par.cmd.CommandText = "SELECT id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderX1.Read Then
                IdContratto = myReaderX1("id")
            End If
            myReaderX1.Close()

            'If tipoRichiesta.Value = 1 Then

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.ANAGRAFICA WHERE COD_FISCALE = (SELECT COD_FISCALE FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND PROGR = 0) ORDER BY ID DESC"
            myReaderX1 = par.cmd.ExecuteReader
            If myReaderX1.Read Then
                IdAnagRichiedente = myReaderX1("id")
                codFiscRich = par.IfNull(myReaderX1("COD_FISCALE"), "")
                CognomeNome = Trim(par.IfNull(myReaderX1("COGNOME"), "")) & " " & Trim(par.IfNull(myReaderX1("NOME"), ""))
            End If
            myReaderX1.Close()


            '05/02/2013 ****** AGGIUNGO CONTROLLO PER L'ID_ANAGRAFICA POICHE' IN ANAGRAFICA POTREBBERO ESSERCENE DIVERSI PER UNA STESSA PERSONA
            Dim controlloID As Integer = 0
            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & IdContratto
            Dim daIdOK As Oracle.DataAccess.Client.OracleDataAdapter
            Dim dtIdOK As New Data.DataTable
            daIdOK = New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)

            daIdOK.Fill(dtIdOK)
            daIdOK.Dispose()
            For Each row As Data.DataRow In dtIdOK.Rows
                If row.Item("ID_ANAGRAFICA") = par.IfEmpty(IdAnagRichiedente, "0") Then
                    controlloID = 1
                End If
            Next

            If controlloID = 0 Then
                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI,SISCOM_MI.ANAGRAFICA WHERE SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA=ANAGRAFICA.ID AND ID_CONTRATTO=" & IdContratto & " AND COD_FISCALE='" & codFiscRich & "'"
                myReaderX1 = par.cmd.ExecuteReader
                If myReaderX1.Read Then
                    IdAnagRichiedente = myReaderX1("ID_ANAGRAFICA")
                End If
                myReaderX1.Close()
            End If
            '05/02/2013 ****** FINE AGGIUNGO CONTROLLO PER L'ID_ANAGRAFICA 



            '------------ 23/03/2012 Ricavo Dati relativi alla Residenza del Nuovo Intestatario --------
            par.cmd.CommandText = "SELECT * FROM DICHIARAZIONI_VSA WHERE ID = " & lIdDichiarazione
            myReaderX1 = par.cmd.ExecuteReader
            If myReaderX1.Read Then
                par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE ID='" & par.IfNull(myReaderX1("ID_LUOGO_RES_DNTE"), "") & "'"
                Dim myReaderIDluogoRES As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderIDluogoRES.Read Then
                    Sigla = par.IfNull(myReaderIDluogoRES("SIGLA"), "")
                    LuogoRec = par.PulisciStrSql(par.IfNull(myReaderIDluogoRES("NOME"), ""))
                End If
                myReaderIDluogoRES.Close()

                par.cmd.CommandText = "SELECT * FROM T_TIPO_INDIRIZZO WHERE COD='" & par.IfNull(myReaderX1("ID_TIPO_IND_RES_DNTE"), "") & "'"
                Dim myReaderTipoIndir As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderTipoIndir.Read Then
                    TipoIndir = par.IfNull(myReaderTipoIndir("DESCRIZIONE"), "")
                End If
                myReaderTipoIndir.Close()

                Indirizzo = par.PulisciStrSql(par.IfNull(myReaderX1("IND_RES_DNTE"), ""))
                Civico = par.PulisciStrSql(par.IfNull(myReaderX1("CIVICO_RES_DNTE"), ""))
                Cap = par.IfNull(myReaderX1("CAP_RES_DNTE"), "")
            End If
            myReaderX1.Close()
            '------------ FINE 23/03/2012 Ricavo Dati relativi alla Residenza del Nuovo Intestatario --------

            If IdAnagRichiedente = "" Then
                Response.Write("<script>alert('Attenzione...Probabile errore nel codice fiscale dei componenti nel nucleo. Operazione interrotta.')</script>")
                Exit Sub
            End If

            par.cmd.CommandText = "SELECT * FROM siscom_mi.soggetti_contrattuali WHERE id_contratto = " & IdContratto & " and  cod_tipologia_occupante = 'INTE'"
            Dim da As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            Dim dt As New Data.DataTable
            da.Fill(dt)
            IdExintestatario = dt.Rows(0).Item("id_anagrafica")



            '################## INSERT INTO INTESTATARI CONTRATTI

            par.cmd.CommandText = "INSERT INTO SISCOM_MI.INTESTATARI_RAPPORTO ( ID_CONTRATTO, ID_ANAGRAFICA, DATA_INIZIO,DATA_FINE ) " _
                & "VALUES ( " & IdContratto & ", " & IdAnagRichiedente & ", '" & par.AggiustaData(Date.Parse(par.FormattaData(CType(Dom_Decisioni1.FindControl("txtdataAUTORIZ"), TextBox).Text), New System.Globalization.CultureInfo("it-IT", False)).AddDays(1).ToString("dd/MM/yyyy")) & "', '29991231')"
            par.cmd.ExecuteNonQuery()

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbSiNo"), DropDownList).Visible = True Then
                If CType(Dom_Dichiara_Cambi1.FindControl("cmbSiNo"), DropDownList).SelectedValue = 1 Then
                    '################## UPDATE DI SOGGETTI CONTRATTUALI PER VECCHIO INTESTATARIO
                    par.cmd.CommandText = "UPDATE SISCOM_MI.SOGGETTI_CONTRATTUALI SET COD_TIPOLOGIA_OCCUPANTE = 'COINT' WHERE ID_ANAGRAFICA = " & IdExintestatario & " AND ID_CONTRATTO = " & IdContratto
                    par.cmd.ExecuteNonQuery()
                Else
                    '################# UPDATE INTO INTESTATARI CONTRATTI, DATA FINE A EX INTESTATARIO
                    par.cmd.CommandText = "UPDATE SISCOM_MI.INTESTATARI_RAPPORTO SET DATA_FINE = '" & par.AggiustaData(CType(Dom_Decisioni1.FindControl("txtdataAUTORIZ"), TextBox).Text) & "' WHERE ID_ANAGRAFICA = " & IdExintestatario & " AND ID_CONTRATTO = " & IdContratto
                    par.cmd.ExecuteNonQuery()

                    '################## UPDATE DI SOGGETTI CONTRATTUALI PER VECCHIO INTESTATARIO
                    par.cmd.CommandText = "UPDATE SISCOM_MI.SOGGETTI_CONTRATTUALI SET COD_TIPOLOGIA_OCCUPANTE = 'EXINTE',DATA_FINE = '" & par.AggiustaData(CType(Dom_Decisioni1.FindControl("txtdataAUTORIZ"), TextBox).Text) & "' WHERE ID_ANAGRAFICA = " & IdExintestatario & " AND ID_CONTRATTO = " & IdContratto
                    par.cmd.ExecuteNonQuery()

                End If
            Else
                '################# UPDATE INTO INTESTATARI CONTRATTI, DATA FINE A EX INTESTATARIO
                par.cmd.CommandText = "UPDATE SISCOM_MI.INTESTATARI_RAPPORTO SET DATA_FINE = '" & par.AggiustaData(CType(Dom_Decisioni1.FindControl("txtdataAUTORIZ"), TextBox).Text) & "' WHERE ID_ANAGRAFICA = " & IdExintestatario & " AND ID_CONTRATTO = " & IdContratto
                par.cmd.ExecuteNonQuery()

                '################## UPDATE DI SOGGETTI CONTRATTUALI PER VECCHIO INTESTATARIO
                par.cmd.CommandText = "UPDATE SISCOM_MI.SOGGETTI_CONTRATTUALI SET COD_TIPOLOGIA_OCCUPANTE = 'EXINTE',DATA_FINE = '" & par.AggiustaData(CType(Dom_Decisioni1.FindControl("txtdataAUTORIZ"), TextBox).Text) & "' " & _
                   "WHERE ID_ANAGRAFICA = " & IdExintestatario & " AND ID_CONTRATTO = " & IdContratto
                par.cmd.ExecuteNonQuery()

            End If


            '################## UPDATE DI SOGGETTI CONTRATTUALI PER NUOVO INTESTATARIO
            par.cmd.CommandText = "UPDATE SISCOM_MI.SOGGETTI_CONTRATTUALI SET COD_TIPOLOGIA_OCCUPANTE = 'INTE',DATA_INIZIO = '" & par.AggiustaData(Date.Parse(par.FormattaData(CType(Dom_Decisioni1.FindControl("txtdataAUTORIZ"), TextBox).Text), New System.Globalization.CultureInfo("it-IT", False)).AddDays(1).ToString("dd/MM/yyyy")) & "'," & _
                "DATA_FINE='29991231' WHERE ID_ANAGRAFICA = " & IdAnagRichiedente & " and NVL(data_fine,'29991231') >= '" & Format(Now(), "yyyyMMdd") & "' AND ID_CONTRATTO = " & IdContratto
            par.cmd.ExecuteNonQuery()



            '********************* AGGIORNO ANCHE IL PRESSO_COR,ecc. DEL NUOVO INTESTATARIO SUBENTRATO *********************

            Dim par1 As New CM.Global
            If Not IsNothing(Session.Item("lIdConnessione")) Then
                par1.OracleConn = CType(HttpContext.Current.Session.Item(Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleConnection)
                par1.cmd = par1.OracleConn.CreateCommand()
                par1.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleTransaction)
                ''par1.cmd.Transaction = par1.myTrans

                par1.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET PRESSO_COR='" & par.PulisciStrSql(CognomeNome) & "',TIPO_COR='" & TipoIndir & "'," _
                & "LUOGO_COR='" & LuogoRec & "',VIA_COR='" & Indirizzo & "',CIVICO_COR='" & Civico & "',CAP_COR='" & Cap & "' WHERE ID=" & IdContratto
                par1.cmd.ExecuteNonQuery()

                'PRESSO_COR
                pressoCOR.Value = par.PulisciStrSql(CognomeNome)

                par1.myTrans.Commit()
                par1.myTrans = par1.OracleConn.BeginTransaction()
                HttpContext.Current.Session.Add("TRANSAZIONE" & Session.Item("lIdConnessione"), par1.myTrans)
                par1.Dispose()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            Else
                par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET PRESSO_COR='" & par.PulisciStrSql(CognomeNome) & "',TIPO_COR='" & TipoIndir & "'," _
                & "LUOGO_COR='" & LuogoRec & "',VIA_COR='" & Indirizzo & "',CIVICO_COR='" & Civico & "',CAP_COR='" & Cap & "' WHERE ID=" & IdContratto
                par.cmd.ExecuteNonQuery()
            End If

            'End If
            '*************evento revisione per subentro
            par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                            & "','F196','','')"
            par.cmd.ExecuteNonQuery()

            If tipoRichiesta.Value = 1 Then
                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                & "VALUES (" & IdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                & "'F185','')"
            Else
                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                & "VALUES (" & IdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                & "'F185','" & par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedItem.Text) & " - (DA ALLOGGIO FF.OO. DIVENTA ALLOGGIO ERP)')"
            End If
            par.cmd.ExecuteNonQuery()


            '************* 30/07/2012 INSERIMENTO AVVISO PER CONDOMINI ********
            par.cmd.CommandText = "SELECT id_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & IdContratto
            Dim myReaderUI As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderUI.Read Then
                IdUI = myReaderUI("id_UNITA")
            End If
            myReaderUI.Close()

            par.cmd.CommandText = "SELECT cond_edifici.* FROM SISCOM_MI.COND_EDIFICI,SISCOM_MI.EDIFICI,SISCOM_MI.UNITA_IMMOBILIARI WHERE UNITA_IMMOBILIARI.ID=" & IdUI & " AND EDIFICI.ID=UNITA_IMMOBILIARI.ID_EDIFICIO AND COND_EDIFICI.ID_EDIFICIO=EDIFICI.ID"
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            Do While myReader.Read
                par.cmd.CommandText = "INSERT INTO SISCOM_MI.COND_AVVISI (ID_TIPO,ID_UI,DATA,VISTO,ID_CONDOMINIO,ID_CONTRATTO) VALUES (5," & IdUI & ",'" & Format(Now, "yyyyMMdd") & "',0," & myReader("ID_CONDOMINIO") & "," & IdContratto & ")"
                par.cmd.ExecuteNonQuery()
            Loop
            myReader.Close()
            '************* 30/07/2012 FINE SCRITTURA EVENTO PER CONDOMINI ********

            CType(Dom_Decisioni1.FindControl("autorizzFinale"), HiddenField).Value = 1


        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try
    End Sub

    Private Function ControllaSeIntest() As Boolean

        Dim intestatario As Boolean = False
        Dim IdAnagRichiedente As Long = 0
        Dim Idintestatario As Long = 0
        Dim IdContratto As Long = 0

        Try
            par.cmd.CommandText = "SELECT id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderX1.Read Then
                IdContratto = myReaderX1("id")
            End If
            myReaderX1.Close()

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.ANAGRAFICA WHERE COD_FISCALE = (SELECT COD_FISCALE FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND PROGR = 0) ORDER BY ID DESC"
            myReaderX1 = par.cmd.ExecuteReader()
            If myReaderX1.Read Then
                IdAnagRichiedente = myReaderX1("id")
            End If
            myReaderX1.Close()

            par.cmd.CommandText = "SELECT * FROM siscom_mi.soggetti_contrattuali WHERE id_contratto = " & IdContratto & " and  cod_tipologia_occupante = 'INTE'"
            myReaderX1 = par.cmd.ExecuteReader()
            If myReaderX1.Read Then
                Idintestatario = myReaderX1("id_anagrafica")
            End If
            myReaderX1.Close()

            If IdAnagRichiedente = Idintestatario Then
                intestatario = True
            Else
                intestatario = False
            End If

        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try

        Return intestatario

    End Function

    Private Sub AggComponentiContratto()
        Try
            Dim idAnagr As Long = 0
            Dim IDCont As Long = 0
            Dim codOccupante As String = ""

            par.cmd.CommandText = "SELECT id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderX1.Read Then
                IDCont = myReaderX1("id")
            End If
            myReaderX1.Close()

            par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_CANCELL WHERE ID_DICHIARAZIONE = " & lIdDichiarazione
            Dim myReaderCancell As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            While myReaderCancell.Read
                par.cmd.CommandText = "SELECT ANAGRAFICA.ID AS IDANAGR,SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE FROM SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA = ANAGRAFICA.ID AND COD_FISCALE = '" & par.IfNull(myReaderCancell("COD_FISCALE"), "") & "'"
                Dim myReaderIDanag As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderIDanag.Read Then
                    idAnagr = par.IfNull(myReaderIDanag("IDANAGR"), "")
                    codOccupante = par.IfNull(myReaderIDanag("COD_TIPOLOGIA_OCCUPANTE"), "")
                End If
                myReaderIDanag.Close()

                If codOccupante <> "INTE" Then
                    par.cmd.CommandText = "UPDATE SISCOM_MI.SOGGETTI_CONTRATTUALI SET DATA_FINE = '" & par.IfNull(myReaderCancell("DATA_USCITA"), "") & "' WHERE ID_ANAGRAFICA = " & idAnagr & " AND ID_CONTRATTO = " & IDCont
                    par.cmd.ExecuteNonQuery()
                End If
            End While
            myReaderCancell.Close()

        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try

    End Sub

    Private Sub CambioConsensuale()
        Try
            Dim IdContratto1 As Long = 0
            Dim IdContratto2 As Long = 0

            par.cmd.CommandText = "update domande_bando_vsa set ID_STATO='8',cod_contratto_scambio='" & UCase(CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text) & "'" _
                                    & " WHERE ID=" & lIdDomanda
            par.cmd.ExecuteNonQuery()

            par.cmd.CommandText = "update domande_bando_vsa set ID_STATO='8' WHERE ID=" & lIdDomScambio
            par.cmd.ExecuteNonQuery()

            '*************evento revisione per subentro
            par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','8'" _
                            & ",'F204','','')"
            par.cmd.ExecuteNonQuery()

            par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                & "VALUES (" & lIdDomScambio & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','8'" _
                & ",'F204','','')"
            par.cmd.ExecuteNonQuery()

            CType(Dom_Decisioni1.FindControl("autorizzFinale"), HiddenField).Value = 1

            par.cmd.CommandText = "SELECT id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderX1.Read Then
                IdContratto1 = myReaderX1("id")
            End If
            myReaderX1.Close()

            Dim codContratto As String = ""
            par.cmd.CommandText = "SELECT CONTRATTO_NUM FROM DOMANDE_BANDO_VSA WHERE ID = " & lIdDomScambio
            myReaderX1 = par.cmd.ExecuteReader()
            If myReaderX1.Read Then
                codContratto = myReaderX1("CONTRATTO_NUM")
            End If
            myReaderX1.Close()

            par.cmd.CommandText = "SELECT id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & codContratto & "'"
            myReaderX1 = par.cmd.ExecuteReader()
            If myReaderX1.Read Then
                IdContratto2 = myReaderX1("id")
            End If
            myReaderX1.Close()


            '************* 30/07/2012 INSERIMENTO AVVISO PER CONDOMINI ********
            Dim IdUI As Long = 0
            par.cmd.CommandText = "SELECT id_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & IdContratto1
            Dim myReaderUI As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderUI.Read Then
                IdUI = myReaderUI("id_UNITA")
            End If
            myReaderUI.Close()

            par.cmd.CommandText = "SELECT cond_edifici.* FROM SISCOM_MI.COND_EDIFICI,SISCOM_MI.EDIFICI,SISCOM_MI.UNITA_IMMOBILIARI WHERE UNITA_IMMOBILIARI.ID=" & IdUI & " AND EDIFICI.ID=UNITA_IMMOBILIARI.ID_EDIFICIO AND COND_EDIFICI.ID_EDIFICIO=EDIFICI.ID"
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            Do While myReader.Read
                par.cmd.CommandText = "INSERT INTO SISCOM_MI.COND_AVVISI (ID_TIPO,ID_UI,DATA,VISTO,ID_CONDOMINIO,ID_CONTRATTO) VALUES (6," & IdUI & ",'" & Format(Now, "yyyyMMdd") & "',0," & myReader("ID_CONDOMINIO") & "," & IdContratto1 & ")"
                par.cmd.ExecuteNonQuery()
            Loop
            myReader.Close()
            '''''*********************30/07/2012

            Dim IdUI2 As Long = 0
            par.cmd.CommandText = "SELECT id_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & IdContratto2
            myReaderUI = par.cmd.ExecuteReader()
            If myReaderUI.Read Then
                IdUI2 = myReaderUI("id_UNITA")
            End If
            myReaderUI.Close()

            par.cmd.CommandText = "SELECT cond_edifici.* FROM SISCOM_MI.COND_EDIFICI,SISCOM_MI.EDIFICI,SISCOM_MI.UNITA_IMMOBILIARI WHERE UNITA_IMMOBILIARI.ID=" & IdUI2 & " AND EDIFICI.ID=UNITA_IMMOBILIARI.ID_EDIFICIO AND COND_EDIFICI.ID_EDIFICIO=EDIFICI.ID"
            myReader = par.cmd.ExecuteReader()
            Do While myReader.Read
                par.cmd.CommandText = "INSERT INTO SISCOM_MI.COND_AVVISI (ID_TIPO,ID_UI,DATA,VISTO,ID_CONDOMINIO,ID_CONTRATTO) VALUES (6," & IdUI2 & ",'" & Format(Now, "yyyyMMdd") & "',0," & myReader("ID_CONDOMINIO") & "," & IdContratto2 & ")"
                par.cmd.ExecuteNonQuery()
            Loop
            myReader.Close()
            '''''************* 30/07/2012 FINE SCRITTURA EVENTO PER CONDOMINI ********


        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try
    End Sub

    Private Sub InserimentoOspite()
        Try
            Dim idcontr As String = ""
            Dim idOspiti As String = ""

            par.cmd.CommandText = "SELECT ID FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderX1.Read Then
                idcontr = myReaderX1("id")
            End If
            myReaderX1.Close()

            par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_OSPITI_VSA WHERE ID_DOMANDA=" & lIdDomanda & ""
            Dim da As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            Dim dt As New Data.DataTable
            da.Fill(dt)

            For Each row As Data.DataRow In dt.Rows
                par.cmd.CommandText = "select siscom_mi.SEQ_OSPITI.nextval from dual"
                Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
                If lettore.Read Then
                    idOspiti = lettore(0)
                End If
                lettore.Close()

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.OSPITI (ID,ID_CONTRATTO,DATA_AGG,DATA_INIZIO_OSPITE,DATA_FINE_OSPITE,NOMINATIVO,COD_FISCALE) " _
                    & "VALUES (" & idOspiti & "," & idcontr & ",'" & Format(Now, "yyyyMMdd") & "','" & row.Item("DATA_INIZIO_OSPITE") & "','" & row.Item("DATA_FINE_OSPITE") & "','" _
                    & "" & par.PulisciStrSql(row.Item("COGNOME")) & " " & par.PulisciStrSql(row.Item("NOME")) & "','" & row.Item("COD_FISCALE") & "')"
                par.cmd.ExecuteNonQuery()
            Next

            If dt.Rows.Count = 0 Then
                Response.Write("<script>alert('Attenzione...per procedere è necessario prima inserire l\'ospite per cui è stata creata l\'istanza.')</script>")
                errore = True
            End If


            '****** EVENTO PER APPLICA OSPITALITA' ******
            If errore = False Then
                CType(Dom_Decisioni1.FindControl("autorizzFinale"), HiddenField).Value = 1
                par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                    & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                    & "','F197','','')"
                par.cmd.ExecuteNonQuery()
            End If

        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try
    End Sub


    Private Sub ProvaVoltura()
        Try
            Dim codFisca As String = ""
            'par.cmd.CommandText = "SELECT cod_fiscale FROM SISCOM_MI.RAPPORTI_UTENZA,SISCOM_MI.SOGGETTI_CONTRATTUALI,SISCOM_MI.ANAGRAFICA WHERE RAPPORTI_UTENZA.ID=SOGGETTI_CONTRATTUALI.ID_CONTRATTO " _
            '    & "AND ID_ANAGRAFICA=ANAGRAFICA.ID AND COD_TIPOLOGIA_OCCUPANTE='INTE' AND COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            par.cmd.CommandText = "SELECT COD_FISCALE FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " AND PROGR=0"
            Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
            If lettore.Read Then
                codFisca = lettore(0)
            End If
            lettore.Close()

            ChiudiPerRinnovo(codFisca)

            If tipoRichiesta.Value = 8 Then
                par.cmd.CommandText = "UPDATE SISCOM_MI.UNITA_IMMOBILIARI SET ID_DESTINAZIONE_USO=1 WHERE ID IN (SELECT id_unita FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE COD_UNITA_IMMOBILIARE='" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "' AND ID_UNITA_PRINCIPALE IS NULL)"
                par.cmd.ExecuteNonQuery()

                Dim par1 As New CM.Global
                If Not IsNothing(Session.Item("lIdConnessione")) Then
                    par1.OracleConn = CType(HttpContext.Current.Session.Item(Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleConnection)
                    par1.cmd = par1.OracleConn.CreateCommand()
                    par1.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleTransaction)
                    ''par1.cmd.Transaction = par1.myTrans

                    par1.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET PROVENIENZA_ASS=1 WHERE ID =" & INDICE_CONTRATTO
                    par1.cmd.ExecuteNonQuery()

                    par1.myTrans.Commit()
                    par1.myTrans = par1.OracleConn.BeginTransaction()
                    HttpContext.Current.Session.Add("TRANSAZIONE" & Session.Item("lIdConnessione"), par1.myTrans)
                    par1.Dispose()
                    Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                End If

            End If

            'UPDATE SU SOGGETTI CONTRATTUALI
            'par.cmd.CommandText = "UPDATE SISCOM_MI.SOGGETTI_CONTRATTUALI SET COD_TIPOLOGIA_OCCUPANTE = 'COINT' WHERE ID_ANAGRAFICA = " & IdExintestatario & " AND ID_CONTRATTO = " & IdContratto
            'par.cmd.ExecuteNonQuery()


        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try

    End Sub



    Private Sub CreazioneERPda392()
        Try
            Dim codFisca As String = ""
            par.cmd.CommandText = "SELECT COD_FISCALE FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " AND PROGR=0"
            Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
            If lettore.Read Then
                codFisca = lettore(0)
            End If
            lettore.Close()

            CreaNuovoContrattoERP(codFisca)

            Dim id_destinaz_uso As String = ""
            Dim idunita As Long = 0
            par.cmd.CommandText = "SELECT id,id_destinazione_uso FROM SISCOM_MI.UNITA_IMMOBILIARI WHERE COD_UNITA_IMMOBILIARE='" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "' AND ID_UNITA_PRINCIPALE IS NULL"
            lettore = par.cmd.ExecuteReader
            If lettore.Read Then
                id_destinaz_uso = par.IfNull(lettore("id_destinazione_uso"), "")
                idunita = par.IfNull(lettore("id"), "")
            End If
            lettore.Close()

            Dim IdContratto1 As Long = 0
            Dim IdContrOrigine As Long = 0
            Dim unitaAssegn As Boolean = False
            Dim impCauzione As Decimal = 0
            Dim idAnagrafe As Long = 0
            Dim idBollDeposito As String = "NULL"
            Dim dataEmissione As String = ""
            Dim dataDecorr As String = ""
            par.cmd.CommandText = "SELECT * FROM siscom_mi.UNITA_ASSEGNATE WHERE ID_DICHIARAZIONE=" & lIdDichiarazione
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
            If myReader.Read Then
                unitaAssegn = True
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * FROM siscom_mi.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderX1.Read Then
                IdContratto1 = myReaderX1("id")
                impCauzione = par.IfNull(myReaderX1("IMP_DEPOSITO_CAUZ"), 0)
                dataDecorr = par.IfNull(myReaderX1("DATA_DECORRENZA"), "")
            End If
            myReaderX1.Close()

            par.cmd.CommandText = "SELECT * FROM siscom_mi.BOL_BOLLETTE WHERE ID_CONTRATTO=" & IdContratto1 & " AND ID_TIPO=9"
            Dim myReaderB1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderB1.Read Then
                idBollDeposito = par.IfNull(myReaderB1("ID"), "NULL")
                dataEmissione = par.IfNull(myReaderB1("DATA_EMISSIONE"), "")
            End If
            myReaderB1.Close()

            If dataEmissione = "" Then dataEmissione = dataDecorr

            par.cmd.CommandText = "SELECT * FROM siscom_mi.SOGGETTI_CONTRATTUALI WHERE COD_TIPOLOGIA_OCCUPANTE='INTE' AND ID_CONTRATTO=" & IdContratto1
            Dim myReaderS1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderS1.Read Then
                idAnagrafe = par.IfNull(myReaderS1("ID_ANAGRAFICA"), 0)
            End If
            myReaderS1.Close()

            If restituisciCauz.Value = "1" Then
                par.cmd.CommandText = "insert into siscom_mi.GESTIONE_CAMBIO_TIPO_CONTR (id_contratto_origine, id_contratto_nuovo, FL_CAUZ_DA_RESTITUIRE, importo_cauzione,FL_IMPORT_DATI_REGISTR) values (" & IdContratto1 & "," & INDICE_CONTRATTO & ",0," & par.VirgoleInPunti(impCauzione) & "," & fl_import_registr.Value & ")"
                par.cmd.ExecuteNonQuery()

                par.cmd.CommandText = "INSERT INTO siscom_mi.STORICO_DEP_CAUZIONALE (ID, ID_ANAGRAFICA, ID_CONTRATTO, DATA, IMPORTO,ID_BOLLETTA, NOTE) VALUES (siscom_mi.SEQ_STORICO_DEP_CAUZIONALE.NEXTVAL," & idAnagrafe & "," & IdContratto1 & ",'" & dataEmissione & "'," & par.VirgoleInPunti(impCauzione) & "," & idBollDeposito & ",'Deposito restituito su nuovo contratto a seguito Cambio Tipologia Contrattuale')"
                par.cmd.ExecuteNonQuery()

                par.cmd.CommandText = "INSERT INTO siscom_mi.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                    & "VALUES (" & INDICE_CONTRATTO & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                    & "'F248','')"
                par.cmd.ExecuteNonQuery()

                If idBollDeposito <> "NULL" Then
                    StornaBolletta(idBollDeposito, "Stornata per cambio tipologia contrattuale", "")
                End If

                If Request.QueryString("CONT") <> "0" Then
                    If Not IsNothing(Session.Item("lIdConnessione")) Then
                        Dim par1 As New CM.Global
                        par1.OracleConn = CType(HttpContext.Current.Session.Item(Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleConnection)
                        par1.cmd = par1.OracleConn.CreateCommand()
                        par1.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleTransaction)

                        par1.cmd.CommandText = "UPDATE siscom_mi.RAPPORTI_UTENZA SET IMP_DEPOSITO_CAUZ=0 WHERE ID=" & IdContratto1
                        par1.cmd.ExecuteNonQuery()

                        par1.myTrans.Commit()
                        par1.myTrans = par1.OracleConn.BeginTransaction()
                        HttpContext.Current.Session.Add("TRANSAZIONE" & Session.Item("lIdConnessione"), par1.myTrans)
                        par1.Dispose()
                        Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                    Else
                        par.cmd.CommandText = "UPDATE siscom_mi.RAPPORTI_UTENZA SET IMP_DEPOSITO_CAUZ=0 WHERE ID=" & IdContratto1
                        par.cmd.ExecuteNonQuery()
                    End If
                Else
                    par.cmd.CommandText = "UPDATE siscom_mi.RAPPORTI_UTENZA SET IMP_DEPOSITO_CAUZ=0 WHERE ID=" & IdContratto1
                    par.cmd.ExecuteNonQuery()
                End If

                par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                        & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','8'" _
                        & ",'F213','','')"
                par.cmd.ExecuteNonQuery()

                'Calcolo interessi
                Dim DataCalcolo As String = ""
                Dim DataInizio As String = ""
                Dim tasso As Double = 0
                Dim Giorni As Integer = 0
                Dim GiorniAnno As Integer = 0
                Dim dataPartenza As String = ""
                Dim Totale As Double = 0
                Dim TotalePeriodo As Double = 0
                Dim indice As Long = 0
                Dim DataFine As String = ""
                Dim Interessi As New SortedDictionary(Of Integer, Double)

                DataCalcolo = Format(DateAdd(DateInterval.Day, -1, CDate(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text)), "yyyyMMdd")
                If impCauzione > 0 Then
                    par.cmd.CommandText = "select * from siscom_mi.tab_interessi_legali order by anno desc"
                    Interessi.Clear()
                    Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    Do While myReaderC.Read
                        Interessi.Add(myReaderC("anno"), myReaderC("tasso"))
                    Loop
                    myReaderC.Close()

                    par.cmd.CommandText = "select * from siscom_mi.adeguamento_interessi where id_contratto=" & IdContratto1 & " and fl_applicato=0 order by id desc"
                    Dim myReaderZ As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderZ.HasRows = False Then
                        DataInizio = dataDecorr
                    End If
                    If myReaderZ.Read Then
                        DataInizio = Format(DateAdd(DateInterval.Day, 1, CDate(par.FormattaData(myReaderZ("data")))), "yyyyMMdd")
                    End If
                    myReaderZ.Close()

                    If DataInizio < "20091001" Then
                        DataInizio = "20091001"
                    End If

                    Giorni = 0
                    GiorniAnno = 0
                    dataPartenza = DataInizio
                    Totale = 0
                    TotalePeriodo = 0

                    par.cmd.CommandText = "insert into siscom_mi.adeguamento_interessi (id,id_contratto,data,fl_applicato) values (siscom_mi.seq_adeguamento_interessi.nextval," & IdContratto1 & ",'" & DataCalcolo & "',0)"
                    par.cmd.ExecuteNonQuery()
                    par.cmd.CommandText = "select siscom_mi.seq_adeguamento_interessi.currval from dual"
                    myReaderZ = par.cmd.ExecuteReader()
                    indice = 0

                    If myReaderZ.Read Then
                        indice = myReaderZ(0)
                    End If
                    myReaderZ.Close()

                    For I = CInt(Mid(DataInizio, 1, 4)) To CInt(Mid(DataCalcolo, 1, 4))
                        If I = CInt(Mid(DataCalcolo, 1, 4)) Then
                            DataFine = par.FormattaData(DataCalcolo)
                        Else
                            DataFine = "31/12/" & I
                        End If

                        GiorniAnno = DateDiff(DateInterval.Day, CDate("01/01/" & I), CDate("31/12/" & I)) + 1
                        Giorni = DateDiff(DateInterval.Day, CDate(par.FormattaData(dataPartenza)), CDate(DataFine)) + 1

                        If I < 1990 Then
                            tasso = 5
                        Else
                            If Interessi.ContainsKey(I) = True Then
                                tasso = Interessi(I)
                            End If
                        End If

                        TotalePeriodo = Format((((impCauzione * tasso) / 100) / GiorniAnno) * Giorni, "0.00")
                        Totale = Totale + TotalePeriodo

                        par.cmd.CommandText = "insert into siscom_mi.adeguamento_interessi_voci (id_adeguamento,dal,al,giorni,tasso,importo) values (" & indice & ",'" & dataPartenza & "','" & Format(CDate(DataFine), "yyyyMMdd") & "'," & Giorni & "," & par.VirgoleInPunti(tasso) & "," & par.VirgoleInPunti(TotalePeriodo) & ")"
                        par.cmd.ExecuteNonQuery()

                        dataPartenza = I + 1 & "0101"
                    Next
                    par.cmd.CommandText = "update siscom_mi.adeguamento_interessi set importo=" & par.VirgoleInPunti(Format(Totale, "0.00")) & " where id=" & indice
                    par.cmd.ExecuteNonQuery()
                    'FINE Calcolo interessi
                End If
            Else
                'Imposto nel contratto un flag che mi faccia capire che bisogna rimborsare la cauzione
                par.cmd.CommandText = "insert into siscom_mi.GESTIONE_CAMBIO_TIPO_CONTR (id_contratto_origine, id_contratto_nuovo, FL_CAUZ_DA_RESTITUIRE,FL_IMPORT_DATI_REGISTR) values (" & IdContratto1 & "," & INDICE_CONTRATTO & ",1," & fl_import_registr.Value & ")"
                par.cmd.ExecuteNonQuery()
            End If

            If id_destinaz_uso <> 1 Then
                par.cmd.CommandText = "UPDATE SISCOM_MI.UNITA_IMMOBILIARI SET ID_DESTINAZIONE_USO=1 WHERE ID IN (SELECT id_unita FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE COD_UNITA_IMMOBILIARE='" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "' AND ID_UNITA_PRINCIPALE IS NULL)"
                par.cmd.ExecuteNonQuery()

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_UI (ID_UI,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) VALUES ( " & idunita & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "', 'F02','Modificata destinazione d''uso per cambio tipologia contrattuale')"
                par.cmd.ExecuteNonQuery()
            End If

        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try

    End Sub

    Function StornaBolletta(ByVal idBolletta As String, ByVal motivoStorno As String, ByRef errore As String, Optional parziale As Boolean = False) As Boolean
        StornaBolletta = False

        errore = "StornaBolletta"

        Dim pagata As Boolean = False
        Dim dataPagamento As String = ""
        Dim dataValuta As String = ""
        par.cmd.CommandText = "SELECT * from siscom_mi.BOL_BOLLETTE where ID=" & idBolletta
        Dim daBolStorno As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
        Dim dtStorno As New Data.DataTable
        daBolStorno.Fill(dtStorno)
        daBolStorno.Dispose()
        If dtStorno.Rows.Count > 0 Then
            If par.IfNull(dtStorno.Rows(0).Item("IMPORTO_PAGATO"), 0) > 0 Or (par.IfNull(dtStorno.Rows(0).Item("FL_ANNULLATA"), 0) <> 0 And par.IfNull(dtStorno.Rows(0).Item("IMPORTO_PAGATO"), 0) > 0) Then
                pagata = True
                dataPagamento = par.IfNull(dtStorno.Rows(0).Item("DATA_PAGAMENTO"), "")
                dataValuta = par.IfNull(dtStorno.Rows(0).Item("DATA_VALUTA"), "")
            Else
                pagata = False
                parziale = False ' SE NON è PAGATA, è INUTILE CERCARE DI FARE LO STORNO PARZIALE
                dataPagamento = Format(Now, "yyyyMMdd")
                dataValuta = Format(Now, "yyyyMMdd")
            End If
        Else
            'id bolletta passato non valido
            StornaBolletta = False
            Exit Function
        End If
        'ricava id Anagrafica
        Dim idAnagr As Long = 0
        Dim intestatario As String = ""
        par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA, CASE WHEN anagrafica.ragione_sociale is not null THEN ragione_sociale  ELSE RTRIM(LTRIM(COGNOME ||' ' ||ANAGRAFICA.NOME)) END AS INTEST  FROM siscom_mi.RAPPORTI_UTENZA,siscom_mi.SOGGETTI_CONTRATTUALI,siscom_mi.ANAGRAFICA WHERE " _
                        & " RAPPORTI_UTENZA.ID=SOGGETTI_CONTRATTUALI.ID_CONTRATTO AND SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA=ANAGRAFICA.ID AND RAPPORTI_UTENZA.ID=" & par.IfEmpty(dtStorno.Rows(0).Item("ID_CONTRATTO").ToString, "0") & " AND COD_TIPOLOGIA_OCCUPANTE='INTE'"
        Dim lettoreDati As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
        If lettoreDati.Read Then
            idAnagr = par.IfNull(lettoreDati("ID_ANAGRAFICA"), 0)
            intestatario = par.IfNull(lettoreDati("INTEST"), "")
        End If
        lettoreDati.Close()

        Dim dataAttuale As String = ""
        Dim dataInizioCompet As String = ""
        Dim dataFineCompet As String = ""
        dataAttuale = Format(Now, "dd/MM/yyyy")
        If dataAttuale <> "" Then
            dataInizioCompet = Right(dataAttuale, 4) & dataAttuale.Substring(3, 2) & "01"
            dataFineCompet = Right(dataAttuale, 4) & dataAttuale.Substring(3, 2) & DateTime.DaysInMonth(Right(dataAttuale, 4), dataAttuale.Substring(3, 2))
        End If

        Dim NumBOlletta As String = dtStorno.Rows(0).Item("num_bolletta").ToString
        Dim noteBolletta As String = motivoStorno & " NUM. BOLLETTA STORNATA:" & NumBOlletta

        Dim pagataParz As Boolean = False
        Dim ID_BOLLETTA_STORNO As Integer = 0

        'STORNA BOLLETTA SELEZIONATA
        If pagata = True Then
            If parziale = False Then
                Dim importoTot As Decimal = 0
                importoTot = par.IfNull(dtStorno.Rows(0).Item("IMPORTO_TOTALE"), 0)
                'se pagata parzialmente viene creata l'eccedenza per l'importo pagato
                If par.IfNull(dtStorno.Rows(0).Item("IMPORTO_TOTALE"), 0) > par.IfNull(dtStorno.Rows(0).Item("IMPORTO_PAGATO"), 0) Then
                    importoTot = par.IfNull(dtStorno.Rows(0).Item("IMPORTO_PAGATO"), 0)
                    pagataParz = True
                End If

                par.cmd.CommandText = "INSERT INTO siscom_mi.BOL_BOLLETTE_GEST (ID, ID_CONTRATTO, ID_ESERCIZIO_F, ID_UNITA, ID_ANAGRAFICA,RIFERIMENTO_DA, RIFERIMENTO_A," _
                            & "IMPORTO_TOTALE, DATA_EMISSIONE, DATA_PAGAMENTO, DATA_VALUTA, ID_TIPO,TIPO_APPLICAZIONE, ID_OPERATORE_APPLICAZIONE, NOTE) " _
                            & "VALUES (siscom_mi.SEQ_BOL_BOLLETTE_GEST.NEXTVAL," & par.IfEmpty(dtStorno.Rows(0).Item("ID_CONTRATTO").ToString, "0") & "," & par.RicavaEsercizioCorrente() & "," & dtStorno.Rows(0).Item("ID_UNITA") & "," & idAnagr & ",'" & dataInizioCompet & "','" & dataFineCompet & "'," & par.VirgoleInPunti(importoTot * -1) & "," _
                            & "'" & Format(Now, "yyyyMMdd") & "','" & dtStorno.Rows(0).Item("DATA_PAGAMENTO") & "','" & dtStorno.Rows(0).Item("DATA_VALUTA") & "',50,'N'," & System.Web.HttpContext.Current.Session.Item("ID_OPERATORE") & ",'ECCEDENZA PER PAGAMENTO BOLLETTA STORNATA " & dtStorno.Rows(0).Item("NUM_BOLLETTA") & "')"
                par.cmd.ExecuteNonQuery()

                Dim idBollGest As Long = 0
                par.cmd.CommandText = "SELECT siscom_mi.SEQ_BOL_BOLLETTE_GEST.CURRVAL FROM DUAL"
                Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader.Read() Then
                    idBollGest = myReader(0)
                End If
                myReader.Close()

                par.cmd.CommandText = "INSERT INTO siscom_mi.BOL_BOLLETTE_VOCI_GEST (ID, ID_BOLLETTA_GEST, ID_VOCE, IMPORTO) " _
                            & "VALUES (siscom_mi.SEQ_BOL_BOLLETTE_VOCI_GEST.NEXTVAL," & idBollGest & ",712," & par.VirgoleInPunti(importoTot * -1) & ")"
                par.cmd.ExecuteNonQuery()

                par.cmd.CommandText = "INSERT INTO siscom_mi.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                    & "VALUES (" & par.IfEmpty(dtStorno.Rows(0).Item("ID_CONTRATTO").ToString, "0") & "," & System.Web.HttpContext.Current.Session("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                    & "'F204','IMPORTO PARI A EURO " & Format(importoTot, "##,##0.00") & "')"
                par.cmd.ExecuteNonQuery()
            Else
                pagataParz = True
            End If
        End If

        par.cmd.CommandText = "select siscom_mi.SEQ_BOL_BOLLETTE.NEXTVAL FROM DUAL"
        Dim myReaderST As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
        If myReaderST.Read Then
            ID_BOLLETTA_STORNO = myReaderST(0)
        End If
        myReaderST.Close()

        For Each row As Data.DataRow In dtStorno.Rows
            par.cmd.CommandText = "Insert into siscom_mi.BOL_BOLLETTE " _
                    & "(ID, N_RATA, DATA_EMISSIONE, DATA_SCADENZA, DATA_I_SOLLECITO, " _
                    & "DATA_II_SOLLECITO, DATA_PAGAMENTO, NOTE, ID_CONTRATTO, ID_ESERCIZIO_F, " _
                    & "ID_UNITA, FL_ANNULLATA, PAGABILE_PRESSO, COD_AFFITTUARIO, INTESTATARIO, " _
                    & "INDIRIZZO, CAP_CITTA, PRESSO, RIFERIMENTO_DA, RIFERIMENTO_A, " _
                    & "FL_STAMPATO, ID_COMPLESSO, DATA_INS_PAGAMENTO, NOTE_PAGAMENTO, " _
                    & "ANNO, OPERATORE_PAG, ID_EDIFICIO, DATA_ANNULLO_PAG, OPERATORE_ANNULLO_PAG,RIF_FILE,ID_TIPO) " _
                    & "Values " _
                    & "(" & ID_BOLLETTA_STORNO & ", 999, '" & Format(Now, "yyyyMMdd") _
                    & "', '" & Format(Now, "yyyyMMdd") & "', NULL,NULL,NULL,'" & par.PulisciStrSql(noteBolletta) & "'," _
                    & "" & par.IfNull(row.Item("ID_CONTRATTO"), 0) _
                    & " ," & par.RicavaEsercizioCorrente() & ", " _
                    & par.IfNull(row.Item("ID_UNITA"), 0) _
                    & ", '0', '" & par.PulisciStrSql(par.IfNull(row.Item("PAGABILE_PRESSO"), "")) & "', " & par.IfNull(row.Item("COD_AFFITTUARIO"), 0) & "" _
                    & ", '" & par.PulisciStrSql(intestatario).ToUpper & "', " _
                    & "'" & par.PulisciStrSql(par.IfNull(row.Item("INDIRIZZO"), "")) _
                    & "', '" & par.PulisciStrSql(par.IfNull(row.Item("CAP_CITTA"), "")) _
                    & "', '" & par.PulisciStrSql(par.IfNull(row.Item("PRESSO"), "")) & "', '" & par.IfNull(row.Item("RIFERIMENTO_DA"), "") _
                    & "', '" & par.IfNull(row.Item("RIFERIMENTO_A"), "") & "', " _
                    & "'1', " & par.IfNull(row.Item("ID_COMPLESSO"), 0) & ", '', '', " _
                    & Year(Now) & ", '', " & par.IfNull(row.Item("ID_EDIFICIO"), 0) & ", NULL, NULL,'MOD',22)"
            par.cmd.ExecuteNonQuery()
        Next

        Dim ID_VOCE_STORNO As Long = 0
        'Dim SumImportoVOCI As Decimal = 0
        par.cmd.CommandText = "SELECT BOL_BOLLETTE_VOCI.* FROM siscom_mi.BOL_BOLLETTE_VOCI WHERE BOL_BOLLETTE_VOCI.ID_BOLLETTA = " & idBolletta


        Dim daBVoci As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
        Dim dtBVoci As New Data.DataTable
        daBVoci.Fill(dtBVoci)
        daBVoci.Dispose()
        Dim ImpVoceBolStorno As Decimal = 0
        For Each row As Data.DataRow In dtBVoci.Rows
            ImpVoceBolStorno = 0
            par.cmd.CommandText = "select siscom_mi.SEQ_BOL_BOLLETTE_VOCI.nextval FROM DUAL"
            Dim myReaderIDV As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderIDV.Read Then
                ID_VOCE_STORNO = myReaderIDV(0)
            End If
            myReaderIDV.Close()
            If parziale = False Then
                ImpVoceBolStorno = par.IfNull(row.Item("IMPORTO"), 0)

            ElseIf parziale = True Then
                ImpVoceBolStorno = par.IfNull(row.Item("IMPORTO"), 0) - par.IfNull(row.Item("imp_pagato"), 0)

            End If
            par.cmd.CommandText = "INSERT INTO siscom_mi.BOL_BOLLETTE_VOCI ( ID, ID_BOLLETTA, ID_VOCE, IMPORTO, NOTE, IMP_PAGATO_OLD," _
                            & "IMP_PAGATO_BAK, IMPORTO_RICLASSIFICATO, IMPORTO_RICLASSIFICATO_PAGATO" _
                            & ") " _
                            & "VALUES ( " & ID_VOCE_STORNO & ", " & ID_BOLLETTA_STORNO & ", " & row.Item("ID_VOCE") & ", " & par.VirgoleInPunti(ImpVoceBolStorno * -1) & ",'STORNO'," _
                            & par.VirgoleInPunti(par.IfNull(row.Item("IMP_PAGATO_OLD"), 0)) & ", " & par.VirgoleInPunti(par.IfNull(row.Item("IMP_PAGATO_BAK"), 0)) & ", " & par.VirgoleInPunti(par.IfNull(row.Item("IMPORTO_RICLASSIFICATO"), 0)) & ", " & par.VirgoleInPunti(par.IfNull(row.Item("IMPORTO_RICLASSIFICATO_PAGATO"), 0)) & "" _
                            & ")"
            par.cmd.ExecuteNonQuery()


            par.cmd.CommandText = "UPDATE siscom_mi.bol_bollette_voci set IMP_PAGATO=" & par.VirgoleInPunti(ImpVoceBolStorno * -1) & " WHERE ID=" & ID_VOCE_STORNO
            par.cmd.ExecuteNonQuery()

            'If parziale = False Then
            par.cmd.CommandText = "UPDATE siscom_mi.bol_bollette_voci set IMP_PAGATO=" & par.VirgoleInPunti(par.IfNull(row.Item("IMPORTO"), 0)) & " WHERE ID=" & row.Item("ID")
            par.cmd.ExecuteNonQuery()
            'End If

            'SumImportoVOCI = SumImportoVOCI + par.IfNull(row.Item("IMPORTO"), 0)
        Next



        par.cmd.CommandText = "UPDATE siscom_mi.bol_bollette set ID_BOLLETTA_STORNO=" & ID_BOLLETTA_STORNO & ",FL_STAMPATO='1',DATA_PAGAMENTO='" & dataPagamento & "',DATA_VALUTA='" & dataValuta & "' WHERE ID=" & idBolletta
        par.cmd.ExecuteNonQuery()

        par.cmd.CommandText = "UPDATE siscom_mi.bol_bollette set DATA_PAGAMENTO='" & dataPagamento & "',DATA_VALUTA='" & dataValuta & "' WHERE ID=" & ID_BOLLETTA_STORNO
        par.cmd.ExecuteNonQuery()

        Dim noteEvento As String = ""
        noteEvento = noteBolletta
        If pagata = True Then
            If pagataParz = True Then
                noteEvento &= "(parzialm. pagata)"
            Else
                noteEvento &= "(precedentam. pagata)"
            End If
        Else
            noteEvento &= "(non precedentem. pagata)"
        End If

        par.cmd.CommandText = "INSERT INTO siscom_mi.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
            & "VALUES (" & dtStorno.Rows(0).Item("ID_CONTRATTO") & "," & System.Web.HttpContext.Current.Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
            & "'F203','" & noteBolletta & "')"
        par.cmd.ExecuteNonQuery()

        StornaBolletta = True
        errore = ""
    End Function
    Private Sub CreazionePosAbus()
        Try
            Dim codFisca As String = ""
            'par.cmd.CommandText = "SELECT cod_fiscale FROM SISCOM_MI.RAPPORTI_UTENZA,SISCOM_MI.SOGGETTI_CONTRATTUALI,SISCOM_MI.ANAGRAFICA WHERE RAPPORTI_UTENZA.ID=SOGGETTI_CONTRATTUALI.ID_CONTRATTO " _
            '    & "AND ID_ANAGRAFICA=ANAGRAFICA.ID AND COD_TIPOLOGIA_OCCUPANTE='INTE' AND COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            par.cmd.CommandText = "SELECT COD_FISCALE FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " AND PROGR=0"
            Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
            If lettore.Read Then
                codFisca = lettore(0)
            End If
            lettore.Close()

            CreazBozzaPosAbus(codFisca)



        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try

    End Sub






    Private Sub CreazioneAbusammvo()
        Try
            Dim codFisca As String = ""
            'par.cmd.CommandText = "SELECT cod_fiscale FROM SISCOM_MI.RAPPORTI_UTENZA,SISCOM_MI.SOGGETTI_CONTRATTUALI,SISCOM_MI.ANAGRAFICA WHERE RAPPORTI_UTENZA.ID=SOGGETTI_CONTRATTUALI.ID_CONTRATTO " _
            '    & "AND ID_ANAGRAFICA=ANAGRAFICA.ID AND COD_TIPOLOGIA_OCCUPANTE='INTE' AND COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            par.cmd.CommandText = "SELECT COD_FISCALE FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " AND PROGR=0"
            Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
            If lettore.Read Then
                codFisca = lettore(0)
            End If
            lettore.Close()

            CreazBozzaAbusAmmvo(codFisca)



        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try

    End Sub

    Private Function CaricaCapoluoghi()
        Capoluoghi = "AGRIGENTO (SICILIA) " _
        & "ALESSANDRIA(PIEMONTE) " _
        & "ANCONA(MARCHE) " _
        & "AOSTA (VALLE D'AOSTA) " _
        & "AREZZO(TOSCANA) " _
        & "ASCOLI PICENO(MARCHE)) " _
        & "ASTI(PIEMONTE) " _
        & "AVELLINO(CAMPANIA) " _
        & "BARI(PUGLIA)  " _
        & "TRANI() " _
        & "ANDRIA() " _
        & "BARLETTA() " _
        & "BELLUNO(VENETO) " _
        & "BENEVENTO(CAMPANIA) " _
        & "BERGAMO(LOMBARDIA) " _
        & "BIELLA(PIEMONTE) " _
        & "BOLOGNA(EMILIA - ROMAGNA) " _
        & "BOLZANO (TRENTINO-ALTO ADIGE) " _
        & "BRESCIA(LOMBARDIA) " _
        & "BRINDISI(PUGLIA) " _
        & "CAGLIARI(SARDEGNA) " _
        & "CALTANISSETTA(SICILIA) " _
        & "CAMPOBASSO(MOLISE) " _
        & "CARBONIA-IGLESIAS(SARDEGNA)) " _
        & "CASERTA(CAMPANIA) " _
        & "CATANIA(SICILIA) " _
        & "CATANZARO(CALABRIA) " _
        & "CHIETI(ABRUZZO) " _
        & "COMO(LOMBARDIA) " _
        & "COSENZA(CALABRIA) " _
        & "CREMONA(LOMBARDIA) " _
        & "CROTONE(CALABRIA) " _
        & "CUNEO(PIEMONTE) " _
        & "ENNA(SICILIA) " _
        & "FERMO(MARCHE) " _
        & "FERRARA(EMILIA - ROMAGNA) " _
        & "FIRENZE(TOSCANA) " _
        & "FOGGIA(PUGLIA) " _
        & "FORLÌ-CESENA(EMILIA - ROMAGNA) " _
        & "FROSINONE(LAZIO) " _
        & "GENOVA(LIGURIA) " _
        & "GORIZIA (FRIULI-VENEZIA GIULIA) " _
        & "GROSSETO(TOSCANA) " _
        & "IMPERIA(LIGURIA) " _
        & "ISERNIA(MOLISE) " _
        & "LA SPEZIA(LIGURIA)) " _
        & "L'AQUILA (ABRUZZO) " _
        & "LATINA(LAZIO) " _
        & "LECCE(PUGLIA) " _
        & "LECCO(LOMBARDIA) " _
        & "LIVORNO(TOSCANA) " _
        & "LODI(LOMBARDIA) " _
        & "LUCCA(TOSCANA) " _
        & "MACERATA(MARCHE) " _
        & "MANTOVA(LOMBARDIA) " _
        & "MASSA-CARRARA(TOSCANA)) " _
        & "MATERA(BASILICATA) " _
        & "MESSINA(SICILIA) " _
        & " " _
        & "MODENA(EMILIA - ROMAGNA) " _
        & "MONZA() " _
        & "NAPOLI(CAMPANIA) " _
        & "NOVARA(PIEMONTE) " _
        & "NUORO(SARDEGNA) " _
        & "OLBIA(-TEMPIO(SARDEGNA)) " _
        & "ORISTANO(SARDEGNA) " _
        & "PADOVA(VENETO)" _
        & "PALERMO(SICILIA) " _
        & "PARMA(EMILIA - ROMAGNA) " _
        & "PAVIA(LOMBARDIA) " _
        & "PERUGIA(UMBRIA) " _
        & "PESARO E URBINO (MARCHE) " _
        & "PESCARA(ABRUZZO) " _
        & "  PIACENZA(EMILIA - ROMAGNA) " _
        & "PISA(TOSCANA) " _
        & "PISTOIA(TOSCANA) " _
        & "PORDENONE (FRIULI-VENEZIA GIULIA) " _
        & "POTENZA(BASILICATA) " _
        & "PRATO(TOSCANA) " _
        & "RAGUSA(SICILIA) " _
        & "RAVENNA(EMILIA - ROMAGNA) " _
        & "REGGIO CALABRIA(CALABRIA)) " _
        & "REGGIO EMILIA(EMILIA - ROMAGNA)) " _
        & "RIETI(LAZIO)  " _
        & "RIMINI(EMILIA - ROMAGNA) " _
        & "ROMA(LAZIO) " _
        & "ROVIGO(VENETO) " _
        & "SALERNO(CAMPANIA) " _
        & "MEDIO CAMPIDANO(SARDEGNA))  " _
        & "SASSARI(SARDEGNA)  " _
        & "SAVONA(LIGURIA) " _
        & "SIENA(TOSCANA) " _
        & "SIRACUSA(SICILIA) " _
        & "SONDRIO(LOMBARDIA) " _
        & "TARANTO(PUGLIA) " _
        & "TERAMO(ABRUZZO) " _
        & "TERNI(UMBRIA) " _
        & "TORINO(PIEMONTE) " _
        & "OGLIASTRA(SARDEGNA) " _
        & "TRAPANI(SICILIA) " _
        & "TRENTO (TRENTINO-ALTO ADIGE) " _
        & "TREVISO(VENETO) " _
        & "TRIESTE (FRIULI-VENEZIA GIULIA) " _
        & "UDINE (FRIULI-VENEZIA GIULIA) " _
        & "     OSSOLA() " _
        & "  VARESE(LOMBARDIA) " _
        & "CUSIO() " _
        & "VENEZIA(VENETO) " _
        & "VERBANIA() " _
        & "VERBANO() " _
        & "VERCELLI(PIEMONTE) " _
        & "VERONA(VENETO) " _
        & "VIBO VALENTIA(CALABRIA)) " _
        & "VICENZA(VENETO) " _
        & "VITERBO(LAZIO)"
    End Function

    Public Property Capoluoghi() As String
        Get
            If Not (ViewState("par_Capoluoghi") Is Nothing) Then
                Return CStr(ViewState("par_Capoluoghi"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_Capoluoghi") = value
        End Set

    End Property

    Private Function InserInAnagrafica(ByVal r As Data.DataRow)
        Dim IdAna As String = ""
        Dim cittadinanza As String = ""
        Dim residenza As String = ""
        Dim comuresid As String = ""
        Dim provresid As String = ""
        Dim indirizzresid As String = ""
        Dim idrecapito As String = ""
        Dim idindrecapito As String = ""
        Dim codComuRecap As String = ""

        Try
            '*************** campo CITTADINANZA **************
            par.cmd.CommandText = "select * from comuni_nazioni where cod='" & par.IfNull(r.Item("COD_FISCALE"), "F205").ToString.Substring(11, 4) & "'"
            Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
            lettore = par.cmd.ExecuteReader
            If lettore.Read Then
                If par.IfNull(lettore("cod"), "").ToString.Contains("Z") Then
                    cittadinanza = par.PulisciStrSql(par.IfNull(lettore("nome"), ""))
                Else
                    cittadinanza = "ITALIA"
                End If
            End If
            lettore.Close()
            '*************** fine CITTADINANZA **********


            '*************** campo RESIDENZA **************
            par.cmd.CommandText = "select * from comuni_nazioni where id=" & par.IfNull(r.Item("id_luogo_res_dnte"), "")
            lettore = par.cmd.ExecuteReader
            If lettore.Read Then
                comuresid = par.PulisciStrSql(par.IfNull(lettore("nome"), ""))
                provresid = par.IfNull(lettore("sigla"), "")
                residenza = comuresid & " (" & provresid & ") CAP " & par.IfNull(r.Item("cap_res_dnte"), "") & " "
            End If
            lettore.Close()
            par.cmd.CommandText = "select * from t_tipo_indirizzo where cod='" & par.IfNull(r.Item("id_tipo_ind_res_dnte"), "") & "'"
            lettore = par.cmd.ExecuteReader
            If lettore.Read Then
                indirizzresid = par.PulisciStrSql(par.IfNull(lettore("descrizione"), "")) & " " & par.PulisciStrSql(par.IfNull(r.Item("ind_res_dnte"), ""))
                residenza &= indirizzresid & ", " & par.IfNull(r.Item("civico_res_dnte"), "")
            End If
            lettore.Close()
            '*************** fine RESIDENZA **************


            '********* campo ID_INDIRIZZO_RECAPITO **********
            par.cmd.CommandText = "select siscom_mi.SEQ_INDIRIZZI.nextval from dual"
            lettore = par.cmd.ExecuteReader
            If lettore.Read Then
                idindrecapito = lettore(0)
            End If
            lettore.Close()

            par.cmd.CommandText = "select * from siscom_mi.rapporti_utenza where cod_contratto='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            lettore = par.cmd.ExecuteReader
            If lettore.Read Then
                par.cmd.CommandText = "select cod from comuni_nazioni where nome = '" & par.PulisciStrSql(par.IfNull(lettore("luogo_cor"), "")) & "'"
                Dim lettoreCod As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
                If lettoreCod.Read Then
                    codComuRecap = par.IfNull(lettoreCod("cod"), "")
                End If
                lettoreCod.Close()

                par.cmd.CommandText = "insert into siscom_mi.indirizzi_anagrafica (id,descrizione,civico,cap,localita," _
                    & "cod_comune) values (" & idindrecapito & ",'" & par.PulisciStrSql(par.IfNull(lettore("tipo_cor"), "")) & " " _
                    & par.PulisciStrSql(par.IfNull(lettore("via_cor"), "")) & "','" & par.IfNull(lettore("civico_cor"), "") & "','" & par.IfNull(lettore("cap_cor"), "") & "'," _
                    & "'" & par.PulisciStrSql(par.IfNull(lettore("luogo_cor"), "")) & "','" & codComuRecap & "') "
                par.cmd.ExecuteNonQuery()

                par.cmd.CommandText = "select id from siscom_mi.indirizzi_anagrafica where descrizione='" & par.PulisciStrSql(par.IfNull(lettore("tipo_cor"), "")) & " " _
                    & par.PulisciStrSql(par.IfNull(lettore("via_cor"), "")) & "' and civico ='" & par.IfNull(lettore("civico_cor"), "") & "'"
                Dim lettoreInd As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
                If lettoreInd.Read Then
                    idrecapito = par.IfNull(lettoreInd("id"), " ")
                End If
                lettoreInd.Close()
            End If
            lettore.Close()
            '************** fine ID_INDIRIZZO_RECAPITO *************



            '************* INSERIMENTO IN ANAGRAFICA **************
            par.cmd.CommandText = "select siscom_mi.SEQ_ANAGRAFICA.nextval from dual"
            lettore = par.cmd.ExecuteReader
            If lettore.Read Then
                IdAna = lettore(0)
            End If
            lettore.Close()
            par.cmd.CommandText = "insert into siscom_mi.anagrafica (id,cognome,nome,data_nascita,cod_fiscale,sesso,cod_comune_nascita,cittadinanza,residenza,id_indirizzo_recapito," _
                                & "comune_residenza,provincia_residenza,indirizzo_residenza,civico_residenza,cap_residenza,tipo_r) values " _
                                & "(" & IdAna & ",'" & par.PulisciStrSql(LTrim(RTrim(par.IfNull(r.Item("COGNOME"), "")))) & "', " _
                                & "'" & par.PulisciStrSql(LTrim(RTrim(par.IfNull(r.Item("NOME"), "")))) & "', " _
                                & "'" & par.IfNull(r.Item("DATA_NASCITA"), "") & "', " _
                                & "'" & par.PulisciStrSql(par.IfNull(r.Item("cod_fiscale"), "")) & "', " _
                                & "'" & par.PulisciStrSql(par.IfNull(r.Item("sesso"), "")) & "','" & par.IfNull(r.Item("COD_FISCALE"), "F205").ToString.Substring(11, 4) & "'," _
                                & "'" & cittadinanza & "','" & residenza & "','" & idrecapito & "','" & comuresid & "','" & provresid & "','" & indirizzresid & "'," _
                                & "'" & par.IfNull(r.Item("civico_res_dnte"), "") & "','" & par.IfNull(r.Item("cap_res_dnte"), "") & "',0)"
            par.cmd.ExecuteNonQuery()
            '************* fine INSERIMENTO IN ANAGRAFICA **************

        Catch ex As Exception
            'Label10.Visible = True
            'Label10.Text = "err " & ex.ToString
            errore = True
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try
        Return IdAna

    End Function

    Private Function RicavaEsercizio(ByVal Anno As Integer) As Integer
        Try
            RicavaEsercizio = 0
            par.cmd.CommandText = "select * from siscom_mi.t_esercizio_finanziario where inizio< = '" & Anno & "0101' and fine>='" & Anno & "1231'"
            Dim myReaderW As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderW.Read Then
                RicavaEsercizio = par.IfNull(myReaderW("id"), 0)
            End If
            myReaderW.Close()

            Return RicavaEsercizio
        Catch ex As Exception

        End Try
    End Function

    'DATI INSERITI DALL'UTENTE PRIMA DEL CAMBIO INTESTAZIONE
    'document.getElementById('RinnovoDataChiusura').value = f.RDataSloggio;
    'document.getElementById('RinnovoDataPG').value = f.RPgData;
    'document.getElementById('RinnovoNumeroPG').value = f.RPgMilano;
    'document.getElementById('RinnovoCanone').value = f.RImportoCanone;
    'document.getElementById('FaiCambioBox').value = "1";
    'document.getElementById('CFRinnovoBoxUSD').value = f.CFCambioBox;

    'Private Function ChiudiPerRinnovo(ByVal CodFis As String)
    '    Try

    '        Dim DESTINAZIONE As String = ""

    '        Dim Risoluzione As Boolean = False
    '        Dim importoRisoluzione As Double = 0
    '        Dim IMPORTOINTERESSI As Double = 0
    '        Dim sAggiunta As String = ""
    '        Dim DataCalcolo As String = ""
    '        Dim DataInizio As String = ""

    '        Dim tasso As Double = 0
    '        Dim baseCalcolo As Double = 0

    '        Dim Giorni As Integer = 0
    '        Dim GiorniAnno As Integer = 0
    '        Dim dataPartenza As String = ""

    '        Dim Totale As Double = 0
    '        Dim TotalePeriodo As Double = 0
    '        Dim indice As Long = 0
    '        Dim DataFine As String = ""
    '        Dim num_bolletta As String = ""
    '        Dim importobolletta As Double = 0
    '        Dim I As Integer = 0

    '        Dim importodanni As Double = 0
    '        Dim importotrasporto As Double = 0

    '        Dim Interessi As New SortedDictionary(Of Integer, Double)

    '        Dim RIASSUNTO_BOLLETTA As String = ""
    '        Dim lIdConnessione As String = ""

    '        '-----------06/12/2011
    '        Dim IdContratto As String = ""
    '        Dim sNuovoCodiceRapporto As String = ""
    '        Dim lNuovoIdRapporto As String = ""
    '        Dim UnitaContratto As Long

    '        Dim RinnovoDataChiusura As String = ""
    '        Dim RinnovoDataPG As String = ""
    '        Dim RinnovoNumeroPG As String = ""
    '        Dim RinnovoCanone As String = ""
    '        Dim FaiCambioBox As String = "1"
    '        Dim CFNuovoIntest As String = ""
    '        'Dim data_riconsegna As String = ""
    '        '-----------fine 06/12/2011


    '        'par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
    '        'par.SettaCommand(par)




    '        data_riconsegna.Value = par.AggiustaData(Date.Parse(par.FormattaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text), New System.Globalization.CultureInfo("it-IT", False)).AddDays(-1).ToString("dd/MM/yyyy"))

    '        '-----------06/12/2011
    '        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
    '        Dim da1 As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
    '        Dim dt1 As New Data.DataTable
    '        da1.Fill(dt1)
    '        IdContratto = dt1.Rows(0).Item("id")

    '        RinnovoCanone = dt1.Rows(0).Item("IMP_CANONE_ATTUALE")
    '        RinnovoDataChiusura = par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text)

    '        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.UNITA_IMMOBILIARI WHERE COD_UNITA_IMMOBILIARE='" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "'"
    '        Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '        If lettore.Read Then
    '            UnitaContratto = par.IfNull(lettore("ID"), "")
    '        End If
    '        lettore.Close()

    '        par.cmd.CommandText = "SELECT * FROM DICHIARAZIONI_VSA,COMP_NUCLEO_VSA WHERE DICHIARAZIONI_VSA.ID = COMP_NUCLEO_VSA.ID_DICHIARAZIONE AND DICHIARAZIONI_VSA.ID=" & lIdDichiarazione & " AND PROGR=0"
    '        lettore = par.cmd.ExecuteReader()
    '        If lettore.Read Then
    '            RinnovoDataPG = par.IfNull(lettore("DATA_PG"), "")
    '            RinnovoNumeroPG = par.IfNull(lettore("PG"), "")
    '            CFNuovoIntest = par.IfNull(lettore("COD_FISCALE"), "")
    '        End If
    '        lettore.Close()
    '        '-----------fine 06/12/2011

    '        If data_riconsegna.Value <> "" Then

    '            'If CodFis <> "-1" Then
    '            '    par.cmd.CommandText = "select anagrafica.* from siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='INTE' AND anagrafica.cod_fiscale='" & UCase(par.PulisciStrSql(CodFis)) & "'"
    '            '    Dim myReaderABCD As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '            '    If myReaderABCD.HasRows = False Then
    '            '        Response.Write("<script>alert('ATTENZIONE...il Codife Fiscale inserito non risulta essere intestatario di contratto ERP! Operazione Annullata');</script>")
    '            '        myReaderABCD.Close()
    '            '        Exit Function
    '            '    End If
    '            '    myReaderABCD.Close()
    '            'End If

    '            Risoluzione = True
    '            par.cmd.CommandText = "select * from siscom_mi.parametri_bolletta where id=1"
    '            Dim myReaderAa As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '            If myReaderAa.Read Then
    '                importoRisoluzione = CDbl(par.PuntiInVirgole(myReaderAa("valore")))
    '            End If
    '            myReaderAa.Close()
    '            importodanni = 0
    '            importotrasporto = 0

    '            If data_riconsegna.Value = par.IfNull(dt1.Rows(0).Item("DATA_SCADENZA_RINNOVO"), "") Or data_riconsegna.Value = par.IfNull(dt1.Rows(0).Item("DATA_SCADENZA"), "") Then
    '                importoRisoluzione = 0
    '            End If

    '            par.cmd.CommandText = "select * from siscom_mi.tab_interessi_legaLI order by anno desc"
    '            Interessi.Clear()
    '            Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '            Do While myReaderC.Read
    '                Interessi.Add(myReaderC("anno"), myReaderC("tasso"))
    '            Loop
    '            myReaderC.Close()

    '            DataCalcolo = data_riconsegna.Value
    '            baseCalcolo = dt1.Rows(0).Item("IMP_DEPOSITO_CAUZ")
    '            If baseCalcolo > 0 And dt1.Rows(0).Item("INTERESSI_CAUZIONE") = 1 Then

    '                par.cmd.CommandText = "select * from siscom_mi.adeguamento_interessi where id_contratto=" & IdContratto & " and fl_applicato=1 order by id desc"
    '                Dim myReaderZ As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '                If myReaderZ.HasRows = False Then
    '                    DataInizio = dt1.Rows(0).Item("DATA_DECORRENZA")
    '                End If
    '                If myReaderZ.Read Then
    '                    DataInizio = Format(DateAdd(DateInterval.Day, 1, CDate(par.FormattaData(myReaderZ("data")))), "yyyyMMdd")
    '                End If
    '                myReaderZ.Close()

    '                Giorni = 0
    '                GiorniAnno = 0
    '                dataPartenza = DataInizio
    '                Totale = 0
    '                TotalePeriodo = 0

    '                par.cmd.CommandText = "insert into siscom_mi.adeguamento_interessi (id,id_contratto,data,fl_applicato) values (siscom_mi.seq_adeguamento_interessi.nextval," & IdContratto & ",'" & DataCalcolo & "',1)"
    '                par.cmd.ExecuteNonQuery()
    '                par.cmd.CommandText = "select siscom_mi.seq_adeguamento_interessi.currval from dual"
    '                myReaderZ = par.cmd.ExecuteReader()
    '                indice = 0
    '                If myReaderZ.Read Then
    '                    indice = myReaderZ(0)
    '                End If

    '                For I = CInt(Mid(DataInizio, 1, 4)) To CInt(Mid(DataCalcolo, 1, 4))

    '                    If I = CInt(Mid(DataCalcolo, 1, 4)) Then
    '                        DataFine = par.FormattaData(DataCalcolo)
    '                    Else
    '                        DataFine = "31/12/" & I

    '                    End If

    '                    GiorniAnno = DateDiff(DateInterval.Day, CDate("01/01/" & I), CDate("31/12/" & I)) + 1

    '                    Giorni = DateDiff(DateInterval.Day, CDate(par.FormattaData(dataPartenza)), CDate(DataFine)) + 1

    '                    If I < 1990 Then
    '                        tasso = 5
    '                    Else
    '                        If Interessi.ContainsKey(I) = True Then
    '                            tasso = Interessi(I)
    '                        End If
    '                    End If

    '                    TotalePeriodo = Format((((baseCalcolo * tasso) / 100) / GiorniAnno) * Giorni, "0.00")
    '                    Totale = Totale + TotalePeriodo
    '                    par.cmd.CommandText = "insert into siscom_mi.adeguamento_interessi_voci (id_adeguamento,dal,al,giorni,tasso,importo) values (" & indice & ",'" & dataPartenza & "','" & Format(CDate(DataFine), "yyyyMMdd") & "'," & Giorni & "," & par.VirgoleInPunti(tasso) & "," & par.VirgoleInPunti(TotalePeriodo) & ")"
    '                    par.cmd.ExecuteNonQuery()
    '                    dataPartenza = I + 1 & "0101"
    '                Next
    '                par.cmd.CommandText = "update siscom_mi.adeguamento_interessi set importo=" & par.VirgoleInPunti(Format(Totale, "0.00")) & " where id=" & indice
    '                par.cmd.ExecuteNonQuery()
    '            End If

    '            'If CodFis <> "-1" Then

    '            '    'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & IdContratto & ""
    '            '    'Dim myReaderS1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '            '    'If myReaderS1.Read = True Then
    '            '    par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET TIPO_COR='" & par.IfNull(dt1.Rows(0).Item("TIPO_COR"), "VIA") _
    '            '                        & "',LUOGO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("LUOGO_COR"), "")) _
    '            '                        & "',VIA_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("VIA_COR"), "")) _
    '            '                        & "',DATA_RICONSEGNA='" & CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text _
    '            '                        & "',CIVICO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("CIVICO_COR"), "")) _
    '            '                        & "',SIGLA_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("SIGLA_COR"), "")) _
    '            '                        & "',CAP_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("CAP_COR"), "")) _
    '            '                        & "',PRESSO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("PRESSO_COR"), "")) _
    '            '                        & "' WHERE ID=" & IdContratto
    '            '    par.cmd.ExecuteNonQuery()
    '            '    'End If
    '            '    'myReaderS1.Close()
    '            'End If

    '            Dim IdAnagRichiedente As String = ""
    '            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.ANAGRAFICA WHERE COD_FISCALE = (SELECT COD_FISCALE FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND PROGR = 0) ORDER BY ID DESC"
    '            Dim myReaderIdA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
    '            If myReaderIdA.Read Then
    '                IdAnagRichiedente = myReaderIdA("id")
    '            End If
    '            myReaderIdA.Close()

    '            Dim DataScadenza As String = DateAdd("d", 10, Now)
    '            Dim TOTALE_BOLLETTA As Double = 0

    '            par.cmd.CommandText = "select RAPPORTI_UTENZA.*,EDIFICI.ID_COMPLESSO,UNITA_CONTRATTUALE.ID_EDIFICIO FROM SISCOM_MI.UNITA_CONTRATTUALE,SISCOM_MI.EDIFICI,SISCOM_MI.RAPPORTI_UTENZA WHERE UNITA_CONTRATTUALE.ID_UNITA_PRINCIPALE IS NULL AND RAPPORTI_UTENZA.ID=" & IdContratto & " AND UNITA_CONTRATTUALE.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND EDIFICI.ID=UNITA_CONTRATTUALE.ID_EDIFICIO"
    '            Dim myReaderS As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '            If myReaderS.Read Then


    '                'DESTINAZIONE = par.IfNull(myReaderS("TIPO_COR"), "")


    '                par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE " _
    '                                                & "(ID, N_RATA, DATA_EMISSIONE, DATA_SCADENZA, DATA_I_SOLLECITO, " _
    '                                                & "DATA_II_SOLLECITO, DATA_PAGAMENTO, NOTE, ID_CONTRATTO, ID_ESERCIZIO_F, " _
    '                                                & "ID_UNITA, FL_ANNULLATA, PAGABILE_PRESSO, COD_AFFITTUARIO, INTESTATARIO, " _
    '                                                & "INDIRIZZO, CAP_CITTA, PRESSO, RIFERIMENTO_DA, RIFERIMENTO_A, " _
    '                                                & "FL_STAMPATO, ID_COMPLESSO, DATA_INS_PAGAMENTO, IMPORTO_PAGATO, NOTE_PAGAMENTO, " _
    '                                                & "ANNO, OPERATORE_PAG, ID_EDIFICIO, DATA_ANNULLO_PAG, OPERATORE_ANNULLO_PAG,RIF_FILE,ID_TIPO) " _
    '                                                & "Values " _
    '                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE.NEXTVAL, 999, '" & Format(Now, "yyyyMMdd") _
    '                                                & "', '" & Format(CDate(DataScadenza), "yyyyMMdd") & "', NULL,NULL,NULL,'FINE CONTRATTO'," _
    '                                                & "" & IdContratto _
    '                                                & " ," & par.RicavaEsercizioCorrente & ", " _
    '                                                & UnitaContratto _
    '                                                & ", '0', '', " & IdAnagRichiedente _
    '                                                & ", '" & par.PulisciStrSql(par.IfNull(myReaderS("PRESSO_COR"), "")) & "', " _
    '                                                & "'" & par.PulisciStrSql(par.IfNull(myReaderS("TIPO_COR"), "") & " " & par.IfNull(myReaderS("VIA_COR"), "") & ", " & par.PulisciStrSql(par.IfNull(myReaderS("CIVICO_COR"), ""))) _
    '                                                & "', '" & par.PulisciStrSql(par.IfNull(myReaderS("CAP_COR"), "") & " " & par.IfNull(myReaderS("LUOGO_COR"), "") & "(" & par.IfNull(myReaderS("SIGLA_COR"), "") & ")") _
    '                                                & "', '', '" & Format(Now, "yyyyMMdd") _
    '                                                & "', '" & Format(Now, "yyyyMMdd") & "', " _
    '                                                & "'0', " & myReaderS("ID_COMPLESSO") & ", '', NULL, '', " _
    '                                                & Year(Now) & ", '', " & myReaderS("ID_EDIFICIO") & ", NULL, NULL,'FIN',3)"

    '                par.cmd.ExecuteNonQuery()
    '                par.cmd.CommandText = "select SISCOM_MI.SEQ_BOL_BOLLETTE.CURRVAL FROM DUAL"
    '                Dim myReaderA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '                If myReaderA.Read Then
    '                    Dim ID_BOLLETTA As Long = myReaderA(0)


    '                    If importoRisoluzione > 0 Then
    '                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
    '                                            & ",35" _
    '                                            & "," & par.VirgoleInPunti(importoRisoluzione) & ")"
    '                        RIASSUNTO_BOLLETTA = "Risoluzione: " & par.VirgoleInPunti(importoRisoluzione) & " Euro;\n"
    '                        par.cmd.ExecuteNonQuery()

    '                        TOTALE_BOLLETTA = importoRisoluzione
    '                    End If

    '                    If importodanni > 0 Then
    '                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
    '                                            & ",100" _
    '                                            & "," & par.VirgoleInPunti(importodanni) & ")"
    '                        RIASSUNTO_BOLLETTA = "Risoluzione: " & par.VirgoleInPunti(importodanni) & " Euro;\n"
    '                        par.cmd.ExecuteNonQuery()

    '                        TOTALE_BOLLETTA = TOTALE_BOLLETTA + importodanni
    '                    End If

    '                    If importotrasporto > 0 Then
    '                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
    '                                            & ",101" _
    '                                            & "," & par.VirgoleInPunti(importotrasporto) & ")"
    '                        RIASSUNTO_BOLLETTA = "Risoluzione: " & par.VirgoleInPunti(importotrasporto) & " Euro;\n"
    '                        par.cmd.ExecuteNonQuery()

    '                        TOTALE_BOLLETTA = TOTALE_BOLLETTA + importotrasporto
    '                    End If


    '                    If Totale > 0 And dt1.Rows(0).Item("INTERESSI_CAUZIONE") = 1 Then
    '                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
    '                                            & ",15" _
    '                                            & "," & par.VirgoleInPunti(Format(Totale * -1, "0.00")) & ")"
    '                        par.cmd.ExecuteNonQuery()
    '                        RIASSUNTO_BOLLETTA = RIASSUNTO_BOLLETTA & "Rimborso Interessi Annuo Cauzione: " & par.VirgoleInPunti(Format(Totale * -1, "0.00")) & " Euro;\n"
    '                        TOTALE_BOLLETTA = TOTALE_BOLLETTA + (Totale * -1)

    '                    End If

    '                    If baseCalcolo > 0 Then
    '                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
    '                                            & ",50" _
    '                                            & "," & par.VirgoleInPunti(Format(baseCalcolo * -1, "0.00")) & ")"
    '                        par.cmd.ExecuteNonQuery()
    '                        RIASSUNTO_BOLLETTA = RIASSUNTO_BOLLETTA & "Rimborso Deposito Cauzionale: " & par.VirgoleInPunti(Format(baseCalcolo * -1, "0.00")) & " Euro;\n"
    '                        TOTALE_BOLLETTA = TOTALE_BOLLETTA + (baseCalcolo * -1)

    '                    End If

    '                    Dim Giorni1 As Integer = 0
    '                    Dim Giorni2 As Integer = 0
    '                    Dim SPESEmav As Double = 0
    '                    Dim BOLLO As Double = 0
    '                    Dim APPLICABOLLO As Double = 0

    '                    Dim PARTENZA As String = ""
    '                    Dim FINE As String = ""


    '                    par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=26"
    '                    myReaderA = par.cmd.ExecuteReader()
    '                    If myReaderA.Read Then
    '                        SPESEmav = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
    '                    End If
    '                    myReaderA.Close()

    '                    par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=0"
    '                    myReaderA = par.cmd.ExecuteReader()
    '                    If myReaderA.Read Then
    '                        BOLLO = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
    '                    End If
    '                    myReaderA.Close()

    '                    par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=25"
    '                    myReaderA = par.cmd.ExecuteReader()
    '                    If myReaderA.Read Then
    '                        APPLICABOLLO = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
    '                    End If
    '                    myReaderA.Close()

    '                    Dim SPESEPOSTALI As Double = 0
    '                    Dim SPESEPOSTALI_CAPOLUOGHI As Double = 0
    '                    Dim SPESEPOSTALI_ALTRI As Double = 0
    '                    Dim SPESEPOSTALI_DA_APPLICARE As Double = 0

    '                    par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=17"
    '                    myReaderA = par.cmd.ExecuteReader()
    '                    If myReaderA.Read Then
    '                        SPESEPOSTALI = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
    '                    End If
    '                    myReaderA.Close()

    '                    par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=29"
    '                    myReaderA = par.cmd.ExecuteReader()
    '                    If myReaderA.Read Then
    '                        SPESEPOSTALI_CAPOLUOGHI = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
    '                    End If
    '                    myReaderA.Close()

    '                    par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=30"
    '                    myReaderA = par.cmd.ExecuteReader()
    '                    If myReaderA.Read Then
    '                        SPESEPOSTALI_ALTRI = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
    '                    End If
    '                    myReaderA.Close()

    '                    If dt1.Rows(0).Item("LUOGO_COR") = "MILANO" Then
    '                        SPESEPOSTALI_DA_APPLICARE = SPESEPOSTALI
    '                    Else
    '                        If InStr(Capoluoghi, dt1.Rows(0).Item("LUOGO_COR")) > 0 Then
    '                            SPESEPOSTALI_DA_APPLICARE = SPESEPOSTALI_CAPOLUOGHI
    '                        Else
    '                            SPESEPOSTALI_DA_APPLICARE = SPESEPOSTALI_ALTRI
    '                        End If
    '                    End If


    '                    par.cmd.CommandText = "select * FROM SISCOM_MI.BOL_BOLLETTE WHERE FL_ANNULLATA='0' AND N_RATA<>99 AND N_RATA<>999 AND N_RATA<>99999 AND ID_CONTRATTO=" & IdContratto & " ORDER BY ID DESC"
    '                    myReaderA = par.cmd.ExecuteReader()
    '                    If myReaderA.Read Then
    '                        PARTENZA = myReaderA("RIFERIMENTO_A")
    '                    End If
    '                    myReaderA.Close()

    '                    FINE = data_riconsegna.Value

    '                    If PARTENZA <> "" And FINE <> "" Then
    '                        Giorni1 = DateDiff("d", CDate(par.FormattaData(PARTENZA)), CDate(par.FormattaData(FINE)))


    '                        If Giorni1 > 0 Then
    '                            'calcolo l'importo dell'affitto in base al numero di rate annue

    '                            Dim affitto As Double = 0

    '                            If par.IfNull(myReaderS("imp_CANONE_INIZIALE"), 0) > 0 Then
    '                                affitto = Format((par.IfNull(myReaderS("imp_CANONE_INIZIALE"), 1) / 365) * (Giorni1), "0.00")
    '                                TOTALE_BOLLETTA = TOTALE_BOLLETTA + (par.IfNull(myReaderS("imp_CANONE_INIZIALE"), 1) / 365) * (Giorni1)

    '                                If par.IfNull(myReaderS("PROVENIENZA_ASS"), "") <> "7" Then
    '                                    If FINE = par.IfNull(myReaderS("data_scadenza_rinnovo"), "") Then
    '                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",36" _
    '                                                            & "," & par.VirgoleInPunti(affitto) & ")"
    '                                        par.cmd.ExecuteNonQuery()
    '                                    Else
    '                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",1" _
    '                                                            & "," & par.VirgoleInPunti(affitto) & ")"
    '                                        par.cmd.ExecuteNonQuery()
    '                                    End If
    '                                Else
    '                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",560" _
    '                                        & "," & par.VirgoleInPunti(affitto) & ")"
    '                                    par.cmd.ExecuteNonQuery()
    '                                End If


    '                            End If
    '                        End If
    '                    End If

    '                    If Giorni1 > 0 Then
    '                        Dim aggiornamento_istat As Double = 0
    '                        Dim AltriAdeguamenti As Double = 0

    '                        par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo=2 and ID_CONTRATTO=" & IdContratto
    '                        myReaderA = par.cmd.ExecuteReader()
    '                        If myReaderA.Read Then
    '                            aggiornamento_istat = par.IfNull(myReaderA(0), 0)
    '                        End If
    '                        myReaderA.Close()

    '                        par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo<>2 and ID_CONTRATTO=" & IdContratto
    '                        myReaderA = par.cmd.ExecuteReader()
    '                        If myReaderA.Read Then
    '                            AltriAdeguamenti = par.IfNull(myReaderA(0), 0)
    '                        End If
    '                        myReaderA.Close()

    '                        If aggiornamento_istat > 0 Then

    '                            TOTALE_BOLLETTA = TOTALE_BOLLETTA + Format((aggiornamento_istat / 365) * Giorni1, "0.00")
    '                            aggiornamento_istat = (aggiornamento_istat / 365) * Giorni1

    '                            If FINE = par.IfNull(myReaderS("data_scadenza_rinnovo"), "") Or par.IfNull(myReaderS("PROVENIENZA_ASS"), "") = "7" Then
    '                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",405" _
    '                                                    & "," & par.VirgoleInPunti(Format(aggiornamento_istat, "0.00")) & ")"
    '                                par.cmd.ExecuteNonQuery()
    '                            Else
    '                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",404" _
    '                                                    & "," & par.VirgoleInPunti(Format(aggiornamento_istat, "0.00")) & ")"
    '                                par.cmd.ExecuteNonQuery()
    '                            End If
    '                        End If

    '                        If AltriAdeguamenti > 0 Then

    '                            TOTALE_BOLLETTA = TOTALE_BOLLETTA + Format((AltriAdeguamenti / 365) * Giorni1, "0.00")
    '                            AltriAdeguamenti = (AltriAdeguamenti / 365) * Giorni1


    '                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",652" _
    '                                                & "," & par.VirgoleInPunti(Format(AltriAdeguamenti, "0.00")) & ")"
    '                            par.cmd.ExecuteNonQuery()

    '                        End If

    '                        par.cmd.CommandText = "select bol_schema.*,t_voci_bolletta.descrizione from siscom_mi.bol_schema,siscom_mi.t_voci_bolletta where anno=" & Year(Now) & " and da_rata=1 And per_rate=12 AND t_voci_bolletta.id=bol_schema.id_voce and  bol_schema.id_contratto=" & IdContratto
    '                        myReaderA = par.cmd.ExecuteReader()
    '                        Do While myReaderA.Read

    '                            TOTALE_BOLLETTA = TOTALE_BOLLETTA + CDbl((myReaderA("importo") / 365) * Giorni1)

    '                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & "," & myReaderA("ID_VOCE") _
    '                                                & "," & par.VirgoleInPunti(Format((myReaderA("importo") / 365) * Giorni1, "0.00")) & ")"
    '                            par.cmd.ExecuteNonQuery()


    '                        Loop
    '                        myReaderA.Close()
    '                    End If

    '                    If SPESEmav > 0 Then
    '                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",407" _
    '                        & "," & par.VirgoleInPunti(Format(SPESEmav, "0.00")) & ")"
    '                        par.cmd.ExecuteNonQuery()

    '                        TOTALE_BOLLETTA = TOTALE_BOLLETTA + SPESEmav
    '                    End If


    '                    Dim TotMorosita As Double = 0
    '                    Dim TotMorositaSB As Double = 0
    '                    par.cmd.CommandText = "select BOL_BOLLETTE.id,(SELECT NVL(SUM(BOL_BOLLETTE_VOCI.importo),0)-NVL(SUM(BOL_BOLLETTE_VOCI.imp_pagato),0) FROM siscom_mi.BOL_BOLLETTE_VOCI,siscom_mi.T_VOCI_BOLLETTA WHERE T_VOCI_BOLLETTA.competenza=3 AND T_VOCI_BOLLETTA.ID=BOL_BOLLETTE_VOCI.id_voce AND BOL_BOLLETTE_VOCI.id_bolletta=BOL_BOLLETTE.ID) AS importo_sindacati,(SELECT NVL(SUM(BOL_BOLLETTE_VOCI.importo),0)-NVL(SUM(BOL_BOLLETTE_VOCI.imp_pagato),0) FROM siscom_mi.BOL_BOLLETTE_VOCI,siscom_mi.T_VOCI_BOLLETTA WHERE T_VOCI_BOLLETTA.competenza<>3 AND T_VOCI_BOLLETTA.ID=BOL_BOLLETTE_VOCI.id_voce AND BOL_BOLLETTE_VOCI.id_bolletta=BOL_BOLLETTE.ID) AS importo_altri FROM SISCOM_MI.BOL_BOLLETTE WHERE bol_bollette.data_scadenza<" & Format(Now, "yyyyMMdd") & " and FL_ANNULLATA='0' AND ID_BOLLETTA_RIC IS NULL AND (ID_TIPO=1 OR ID_TIPO=2 OR ID_TIPO=6 or id_tipo=8) AND  importo_totale<>nvl(importo_pagato,0) and ID_CONTRATTO=" & IdContratto
    '                    myReaderA = par.cmd.ExecuteReader()
    '                    Do While myReaderA.Read
    '                        TotMorositaSB = 0
    '                        TotMorositaSB = par.IfNull(myReaderA("IMPORTO_altri"), 0)
    '                        If TotMorositaSB > 0 Then
    '                            par.cmd.CommandText = "UPDATE SISCOM_MI.BOL_BOLLETTE SET fl_sollecito='1',ID_BOLLETTA_RIC=" & ID_BOLLETTA & " WHERE ID=" & myReaderA("ID")
    '                            par.cmd.ExecuteNonQuery()
    '                            TotMorosita = TotMorosita + TotMorositaSB
    '                        End If
    '                    Loop
    '                    myReaderA.Close()

    '                    If TotMorosita > 0 Then
    '                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                       & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",151" _
    '                                       & "," & par.VirgoleInPunti(Format(TotMorosita, "0.00")) & ")"
    '                        par.cmd.ExecuteNonQuery()
    '                        TOTALE_BOLLETTA = TOTALE_BOLLETTA + TotMorosita
    '                    End If


    '                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",403" _
    '                                        & "," & par.VirgoleInPunti(Format(SPESEPOSTALI_DA_APPLICARE, "0.00")) & ")"
    '                    par.cmd.ExecuteNonQuery()
    '                    TOTALE_BOLLETTA = TOTALE_BOLLETTA + SPESEPOSTALI_DA_APPLICARE

    '                    If TOTALE_BOLLETTA > APPLICABOLLO Then
    '                        If BOLLO > 0 Then
    '                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
    '                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",95" _
    '                                                & "," & par.VirgoleInPunti(Format(BOLLO, "0.00")) & ")"
    '                            par.cmd.ExecuteNonQuery()
    '                        End If
    '                    End If

    '                    If TOTALE_BOLLETTA <= SPESEmav And TOTALE_BOLLETTA > 0 Then
    '                        par.cmd.CommandText = "DELETE FROM SISCOM_MI.BOL_BOLLETTE WHERE ID=" & ID_BOLLETTA
    '                        par.cmd.ExecuteNonQuery()
    '                        RIASSUNTO_BOLLETTA = ""
    '                    End If

    '                End If

    '            End If
    '            myReaderS.Close()




    '            'imgChiudiContratto.Visible = False

    '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
    '                & "VALUES (" & IdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
    '                & "'F18','')"
    '            par.cmd.ExecuteNonQuery()


    '            If CodFis = "-1" Then
    '                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
    '                    & "VALUES (" & IdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
    '                    & "'F102','')"
    '            Else
    '                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
    '                    & "VALUES (" & IdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
    '                    & "'F103','')"
    '            End If
    '            par.cmd.ExecuteNonQuery()




    '            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.UNITA_STATO_MANUTENTIVO WHERE ID_UNITA=" & UnitaContratto
    '            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '            If myReader.Read Then

    '                par.cmd.CommandText = "Insert into siscom_mi.UNITA_STATO_MAN_S (id_unita,id_contratto,data_memo) values (" & UnitaContratto & "," & IdContratto & ",'" & Format(Now, "yyyyMMdd") & "')"
    '                par.cmd.ExecuteNonQuery()

    '                par.cmd.CommandText = "update siscom_mi.UNITA_STATO_MAN_S set DATA_RIPRESA_STR='" & par.IfNull(myReader("DATA_RIPRESA_STR"), "") _
    '                & "', DATA_CONSEGNA_STR='" & par.IfNull(myReader("DATA_CONSEGNA_STR"), "") _
    '                & "',ID_STRUTTURA_COMP=" & par.IfNull(myReader("ID_STRUTTURA_COMP"), "NULL") _
    '                & ",ST_DEP_CHIAVI=" & par.IfNull(myReader("ST_DEP_CHIAVI"), "NULL") _
    '                                    & ",DATA_S='" & par.IfNull(myReader("DATA_S"), "") & "'" _
    '                                    & ",RILEVAZIONE=" & par.IfNull(myReader("RILEVAZIONE"), 0) _
    '                                    & ",RIASSEGNABILE=" & par.IfNull(myReader("RIASSEGNABILE"), 0) _
    '                                    & ", P_BLINDATA=" & par.IfNull(myReader("P_BLINDATA"), 0) _
    '                                    & ",SOL_GP=" & par.IfNull(myReader("SOL_GP"), 0) _
    '                                    & ",SOL_GF=" & par.IfNull(myReader("SOL_GF"), 0) _
    '                                    & ",SOL_PB=" & par.IfNull(myReader("SOL_PB"), 0) _
    '                                    & ",SOL_LA=" & par.IfNull(myReader("SOL_LA"), 0) _
    '                                    & ",SOL_AL=" & par.IfNull(myReader("SOL_AL"), 0) _
    '                                    & ",HANDICAP=" & par.IfNull(myReader("HANDICAP"), 0) _
    '                                    & ",DATA_PRE_S='" & par.IfNull(myReader("DATA_PRE_S"), "") _
    '                                    & "',DATA_PRE_SLOGGIO='" & par.IfNull(myReader("DATA_PRE_SLOGGIO"), "") _
    '                                    & "', NOTE='" & par.PulisciStrSql(par.IfNull(myReader("NOTE"), "")) _
    '                                    & "',ALLARME=" & par.IfNull(myReader("ALLARME"), 0) _
    '                                    & ", MOTIVAZIONI='" & par.PulisciStrSql(par.IfNull(myReader("MOTIVAZIONI"), "")) _
    '                                    & "', ZONA='" & par.PulisciStrSql(par.IfNull(myReader("ZONA"), "")) _
    '                                    & "', NUM_LOCALI='" & par.PulisciStrSql(par.IfNull(myReader("NUM_LOCALI"), "")) _
    '                                    & "',NUM_SERVIZI='" & par.PulisciStrSql(par.IfNull(myReader("NUM_SERVIZI"), "")) _
    '                                    & "', TIPO_ALLOGGIO=" & par.IfNull(myReader("TIPO_ALLOGGIO"), "NULL") _
    '                                    & ", DATA_CONSEGNA_CHIAVI='" & par.PulisciStrSql(par.IfNull(myReader("DATA_CONSEGNA_CHIAVI"), "")) _
    '                                    & "', CONSEGNATE_A='" & par.PulisciStrSql(par.IfNull(myReader("CONSEGNATE_A"), "")) _
    '                                    & "', DATA_RIPRESA_CHIAVI='" & par.PulisciStrSql(par.IfNull(myReader("DATA_RIPRESA_CHIAVI"), "")) _
    '                                    & "',ID_QUARTIERE=" & par.IfNull(myReader("ID_QUARTIERE"), 0) _
    '                                    & ", DATA_RILEVAZIONE='" & par.PulisciStrSql(par.IfNull(myReader("DATA_RILEVAZIONE"), "")) _
    '                                    & "', NOTEGRTP='" & par.PulisciStrSql(par.IfNull(myReader("NOTEGRTP"), "")) _
    '                                    & "', SOL_PB1=" & par.IfNull(myReader("SOL_PB1"), 0) _
    '                                    & ", SOL_PB2=" & par.IfNull(myReader("SOL_PB2"), 0) _
    '                                    & ", SOL_PB3=" & par.IfNull(myReader("SOL_PB3"), 0) _
    '                                    & ", SOL_LA1=" & par.IfNull(myReader("SOL_LA1"), 0) _
    '                                    & ", TIPO_RIASSEGNABILE=" & par.IfNull(myReader("TIPO_RIASSEGNABILE"), 0) _
    '                                    & ", FINE_LAVORI='" & par.IfNull(myReader("FINE_LAVORI"), 0) _
    '                                    & "', DATA_Q='" & par.IfNull(myReader("DATA_Q"), 0) _
    '                                    & "',IMPORTO_DANNI=" & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO_DANNI"), 0)) _
    '                                    & ", IMPORTO_TRASPORTO=" & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO_DANNI"), 0)) _
    '                                    & ", NOTE_DANNI='" & par.PulisciStrSql(par.IfNull(myReader("NOTE_DANNI"), "")) _
    '                                    & "', FL_AUTORIZZATI_IMP='" & par.IfNull(myReader("FL_AUTORIZZATI_IMP"), 0) _
    '                                    & "', REC_GRTP=" & par.IfNull(myReader("REC_GRTP"), 0) _
    '                                    & " WHERE ID_UNITA=" & UnitaContratto & " AND ID_CONTRATTO=" _
    '                                    & IdContratto & " AND DATA_MEMO='" & Format(Now, "yyyyMMdd") & "'"





    '                par.cmd.ExecuteNonQuery()
    '            End If
    '            myReader.Close()

    '            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.UNITA_STATO_MANUTENTIVO_INT WHERE ID_UNITA=" & UnitaContratto
    '            myReader = par.cmd.ExecuteReader()
    '            Do While myReader.Read
    '                par.cmd.CommandText = "INSERT INTO SISCOM_MI.UNITA_STATO_MAN_INT_S (ID_UNITA,ID_INTERVENTO,DATA_MEMO) VALUES (" & UnitaContratto & "," & myReader("ID_INTERVENTO") & ",'" & Format(Now, "yyyyMMdd") & "')"
    '                par.cmd.ExecuteNonQuery()
    '            Loop
    '            myReader.Close()

    '            par.cmd.CommandText = "update siscom_mi.intestatari_rapporto set data_fine='" & data_riconsegna.Value & "' where id_contratto=" & IdContratto
    '            par.cmd.ExecuteNonQuery()


    '            Dim progressivo As Integer
    '            par.cmd.CommandText = "select MAX(TO_NUMBER(TRANSLATE(SUBSTR(cod_contratto,18,2),'A','0'))) from SISCOM_MI.rapporti_utenza where id=" & IdContratto
    '            Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '            If myReader1.Read Then
    '                progressivo = par.IfNull(myReader1(0), 0) + 1
    '            Else
    '                progressivo = 1
    '            End If
    '            myReader1.Close()
    '            Dim NuovoCodiceContratto As String = Mid(CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text, 1, 17) & Format((progressivo), "00")

    '            Dim nome As String = ""
    '            Dim Cognome As String = ""
    '            Dim CF As String = ""

    '            If CodFis = "-1" Then
    '                par.cmd.CommandText = "select anagrafica.* from siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND soggetti_contrattuali.id_CONTRATTO=" & IdContratto
    '            Else
    '                par.cmd.CommandText = "select anagrafica.* from siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND anagrafica.cod_fiscale='" & UCase(par.PulisciStrSql(CodFis)) & "'"
    '            End If


    '            Dim myReaderX As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()

    '            If myReaderX.Read = True Then
    '                If par.IfNull(myReaderX("ragione_sociale"), "") = "" Then
    '                    Cognome = par.IfNull(myReaderX("cognome"), "")
    '                    nome = par.IfNull(myReaderX("nome"), "")
    '                Else
    '                    Cognome = par.IfNull(myReaderX("ragione_sociale"), "")
    '                    nome = ""
    '                End If
    '                If par.IfNull(myReaderX("partita_iva"), "") = "" Then
    '                    CF = par.IfNull(myReaderX("cod_fiscale"), "")
    '                Else
    '                    CF = par.IfNull(myReaderX("partita_iva"), "")
    '                End If



    '                par.cmd.CommandText = "Insert into siscom_mi.UNITA_ASSEGNATE (ID_DOMANDA, ID_UNITA, DATA_ASSEGNAZIONE, " _
    '                                    & "GENERATO_CONTRATTO, ID_DICHIARAZIONE, COGNOME_RS, NOME, CF_PIVA, PROVENIENZA, N_OFFERTA,CANONE,ID_ANAGRAFICA,PROVVEDIMENTO,DATA_PROVVEDIMENTO) " _
    '                                    & " Values " _
    '                                    & "(-1, " & UnitaContratto & ", '" & RinnovoDataPG & "', 1, -1, " _
    '                                    & "'" & par.PulisciStrSql(Cognome) & "', '" & par.PulisciStrSql(nome) _
    '                                    & "', '" & par.PulisciStrSql(CF) & "', 'U', 0," & par.VirgoleInPunti(RinnovoCanone) & "," & par.IfNull(myReaderX("id"), "0") & ",'" & RinnovoNumeroPG & "','" & RinnovoDataPG & "')"
    '                par.cmd.ExecuteNonQuery()
    '            End If
    '            myReaderX.Close()


    '            'INSERISCO IL CONTRATTO
    '            Dim CAUZIONE As Double = 0
    '            CAUZIONE = Format(Format((RinnovoCanone / 12), "0.00") * 3, "0.00")

    '            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & IdContratto
    '            myReaderX = par.cmd.ExecuteReader()
    '            If myReaderX.Read = True Then
    '                par.cmd.CommandText = "Insert into SISCOM_MI.RAPPORTI_UTENZA    (ID, COD_CONTRATTO_GIMI, COD_CONTRATTO, COD_TIPOLOGIA_RAPP_CONTR, COD_TIPOLOGIA_CONTR_LOC," _
    '                                    & "DURATA_ANNI, DURATA_MESI, DURATA_GIORNI, DATA_DECORRENZA, DATA_SCADENZA,     DATA_DISDETTA_LOCATARIO, NUM_REGISTRAZIONE, SERIE_REGISTRAZIONE, " _
    '                                    & "IMP_CANONE_INIZIALE, IMP_DEPOSITO_CAUZ,     COD_FASCIA_REDDITO, MESSA_IN_MORA, PRATICA_AL_LEGALE, ISCRIZIONE_RUOLO, RATEIZZAZIONI_IN_CORSO,     " _
    '                                    & "DECADENZA, SFRATTO, NOTE, DATA_REG, COD_UFFICIO_REG,     DATA_STIPULA, DATA_CONSEGNA, DATA_SCADENZA_RINNOVO, DURATA_RINNOVO, MESI_DISDETTA,     " _
    '                                    & "DATA_RICONSEGNA, DELIBERA, DATA_DELIBERA, NRO_RATE, FREQ_VAR_ISTAT,     VERSAMENTO_TR, PER_BANDO, TIPO_COR, LUOGO_COR, VIA_COR,     " _
    '                                    & "NOTE_COR, CIVICO_COR, SIGLA_COR, CAP_COR, PRESSO_COR,     BOZZA, INTERESSI_CAUZIONE, NRO_REPERTORIO, DATA_REPERTORIO, NRO_ASSEGNAZIONE_PG,     " _
    '                                    & "DATA_ASSEGNAZIONE_PG, INIZIO_PERIODO, LIBRETTO_DEPOSITO, ID_DEST_RATE, INVIO_BOLLETTA,     FL_CONGUAGLIO, PERC_RINNOVO_CONTRATTO, PERC_ISTAT, " _
    '                                    & "IMP_CANONE_ATTUALE, PROVENIENZA_ASS,     INTERESSI_RIT_PAG, IMPORTO_ANTICIPO, ID_DOMANDA, ID_AU, ID_ISEE,     ID_COMMISSARIATO, REG_TELEMATICA, " _
    '                                    & "DEST_USO, DESCR_DEST_USO, DATA_INVIO_RIC_DISDETTA,MOTIVO_REC_FORZOSO, FL_STAMPATO, BOLLO, N_OFFERTA, DATA_NOTIFICA_DISDETTA,     " _
    '                                    & "MITTENTE_DISDETTA, DATA_CONVALIDA_SFRATTO, DATA_ESECUZIONE_SFRATTO, DATA_RINVIO_SFRATTO, DATA_CONFERMA_FP) " _
    '                                    & "Values   (SISCOM_MI.SEQ_RAPPORTI_UTENZA.NEXTVAL, '', '" & NuovoCodiceContratto & "', '" _
    '                                    & par.IfNull(myReaderX("COD_TIPOLOGIA_RAPP_CONTR"), "") & "', '" & par.IfNull(myReaderX("COD_TIPOLOGIA_CONTR_LOC"), "") _
    '                                    & "', " & par.IfNull(myReaderX("DURATA_ANNI"), "0") & ", " & par.IfNull(myReaderX("DURATA_MESI"), "0") _
    '                                    & ", NULL, '', '',  '' , NULL, NULL, " & par.VirgoleInPunti(RinnovoCanone) & ", " & par.VirgoleInPunti(CAUZIONE) & " ,  NULL, NULL, NULL, NULL, NULL,  NULL, NULL, NULL, NULL, '" _
    '                                    & par.IfNull(myReaderX("COD_UFFICIO_REG"), "TNP") & "',  '', '', '', " & par.IfNull(myReaderX("DURATA_RINNOVO"), "NULL") _
    '                                    & ", " & par.IfNull(myReaderX("MESI_DISDETTA"), "6") & ",     NULL, '" & RinnovoNumeroPG _
    '                                    & "', '" & RinnovoDataPG & "', 12, '" & par.IfNull(myReaderX("FREQ_VAR_ISTAT"), "0") _
    '                                    & "' ,'" & par.IfNull(myReaderX("VERSAMENTO_TR"), "NULL") & "', NULL, '" & par.IfNull(myReaderX("TIPO_COR"), "VIA") _
    '                                    & "', '" & par.PulisciStrSql(par.IfNull(myReaderX("LUOGO_COR"), "")) & "', '" _
    '                                    & par.PulisciStrSql(par.IfNull(myReaderX("VIA_COR"), "")) _
    '                                    & "', NULL, '" & par.PulisciStrSql(par.IfNull(myReaderX("CIVICO_COR"), "")) & "', '" _
    '                                    & par.PulisciStrSql(par.IfNull(myReaderX("SIGLA_COR"), "")) & "', '" _
    '                                    & par.PulisciStrSql(par.IfNull(myReaderX("CAP_COR"), "")) & "', '" _
    '                                    & par.PulisciStrSql(par.IfNull(myReaderX("PRESSO_COR"), "")) & "',     1, NULL, NULL, NULL, NULL,     NULL, '" _
    '                                    & par.IfNull(myReaderX("INIZIO_PERIODO"), "") & "', '" & par.IfNull(myReaderX("LIBRETTO_DEPOSITO"), "") _
    '                                    & "', " & par.IfNull(myReaderX("ID_DEST_RATE"), "1") & ", " & par.IfNull(myReaderX("INVIO_BOLLETTA"), "1") _
    '                                    & ",'" & par.IfNull(myReaderX("FL_CONGUAGLIO"), "1") & "', " & par.IfNull(myReaderX("PERC_RINNOVO_CONTRATTO"), "0") _
    '                                    & ", " & par.IfNull(myReaderX("PERC_ISTAT"), "0") & ", " & par.VirgoleInPunti(RinnovoCanone) _
    '                                    & ", " & par.IfNull(myReaderX("PROVENIENZA_ASS"), "0") & " ,     '0', 0, " & par.IfNull(myReaderX("ID_DOMANDA"), "NULL") _
    '                                    & ", " & par.IfNull(myReaderX("ID_AU"), "NULL") & ", " & par.IfNull(myReaderX("ID_ISEE"), "NULL") _
    '                                    & "," & par.IfNull(myReaderX("ID_COMMISSARIATO"), "1") & ", NULL, '" & par.IfNull(myReaderX("DEST_USO"), "N") _
    '                                    & "', '" & par.PulisciStrSql(par.IfNull(myReaderX("DESCR_DEST_USO"), "0")) _
    '                                    & "', NULL, 4, 0, NULL, NULL, NULL,     -1, NULL, NULL, NULL, NULL)"
    '                par.cmd.ExecuteNonQuery()


    '            End If
    '            myReaderX.Close()

    '            'Dim indice_anagrafica As String = "0"
    '            Dim INDICE_CONTRATTO As Long = 0

    '            par.cmd.CommandText = "select siscom_mi.seq_RAPPORTI_UTENZA.currval from dual"
    '            myReaderX = par.cmd.ExecuteReader()
    '            If myReaderX.Read Then
    '                INDICE_CONTRATTO = myReaderX(0)
    '            End If
    '            myReaderX.Close()


    '            If CodFis <> "-1" Then
    '                'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & IdContratto
    '                'myReaderX = par.cmd.ExecuteReader()
    '                'If myReaderX.Read = True Then
    '                par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET TIPO_COR='" & par.IfNull(dt1.Rows(0).Item("TIPO_COR"), "VIA") _
    '                                    & "',LUOGO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("LUOGO_COR"), "")) _
    '                                    & "',VIA_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("VIA_COR"), "")) _
    '                                    & "',CIVICO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("CIVICO_COR"), "")) _
    '                                    & "',SIGLA_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("SIGLA_COR"), "")) _
    '                                    & "',CAP_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("CAP_COR"), "")) _
    '                                    & "',PRESSO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("PRESSO_COR"), "")) _
    '                                    & "' WHERE ID=" & INDICE_CONTRATTO
    '                par.cmd.ExecuteNonQuery()
    '                'End If
    '            End If

    '            If CodFis = "-1" Then
    '                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & IdContratto
    '                myReaderX = par.cmd.ExecuteReader()
    '                Do While myReaderX.Read
    '                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
    '                                        & par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
    '                                        & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
    '                    par.cmd.ExecuteNonQuery()

    '                    'If par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") = "INTE" Then
    '                    '    indice_anagrafica = par.IfNull(myReaderX("ID_ANAGRAFICA"), "0")
    '                    'End If
    '                Loop
    '                myReaderX.Close()
    '            Else
    '                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & IdContratto & ""
    '                myReaderX = par.cmd.ExecuteReader()
    '                Do While myReaderX.Read
    '                    If par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") = IdAnagRichiedente Then
    '                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
    '                        & IdAnagRichiedente & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
    '                        & "','INTE','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
    '                    ElseIf par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") = "INTE" Then
    '                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
    '                        & par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
    '                        & "','VOLT','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
    '                    Else
    '                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
    '                        & par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
    '                        & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
    '                    End If
    '                    par.cmd.ExecuteNonQuery()

    '                    'If par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") = "INTE" Then
    '                    '    indice_anagrafica = par.IfNull(myReaderX("ID_ANAGRAFICA"), "0")
    '                    'End If

    '                    'If par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") = IdAnagRichiedente Then
    '                    '    par.cmd.CommandText = "UPDATE SISCOM_MI.SOGGETTI_CONTRATTUALI " _
    '                    '        & " SET ID_ANAGRAFICA=" & IdAnagRichiedente & ",ID_CONTRATTO=" & INDICE_CONTRATTO & ",COD_TIPOLOGIA_PARENTELA='" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") & "'," _
    '                    '        & "COD_TIPOLOGIA_OCCUPANTE='INTE',COD_TIPOLOGIA_TITOLO='" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "' WHERE ID_ANAGRAFICA=" & IdAnagRichiedente
    '                    '    par.cmd.ExecuteNonQuery()
    '                    'End If
    '                Loop
    '                myReaderX.Close()

    '            End If


    '            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & IdContratto
    '            myReaderX = par.cmd.ExecuteReader()
    '            If myReaderX.Read Then
    '                par.cmd.CommandText = "Insert into SISCOM_MI.UNITA_CONTRATTUALE (ID_CONTRATTO, ID_UNITA, COD_UNITA_IMMOBILIARE, TIPOLOGIA, ID_EDIFICIO, SCALA, COD_TIPO_LIVELLO_PIANO, " _
    '                                 & "INTERNO, ID_UNITA_PRINCIPALE, SEZIONE, FOGLIO, NUMERO, SUB, COD_TIPOLOGIA_CATASTO, RENDITA, COD_CATEGORIA_CATASTALE, COD_CLASSE_CATASTALE," _
    '                                 & "COD_QUALITA_CATASTALE, SUPERFICIE_MQ, CUBATURA, NUM_VANI, SUPERFICIE_CATASTALE, RENDITA_STORICA, IMMOBILE_STORICO, REDDITO_DOMINICALE, VALORE_IMPONIBILE, " _
    '                                 & "REDDITO_AGRARIO, VALORE_BILANCIO, DATA_ACQUISIZIONE, DATA_FINE_VALIDITA, DITTA, NUM_PARTITA, ESENTE_ICI, PERC_POSSESSO, INAGIBILE, MICROZONA_CENSUARIA, " _
    '                                 & "ZONA_CENSUARIA, COD_STATO_CATASTALE, INDIRIZZO, CIVICO, CAP, LOCALITA, COD_COMUNE, SUP_CONVENZIONALE, VAL_LOCATIVO_UNITA) Values (" _
    '                                 & INDICE_CONTRATTO & "," & par.IfNull(myReaderX("id_unita"), "") & ", '" & par.IfNull(myReaderX("cod_unita_immobiliare"), "") _
    '                                 & "', '" & par.IfNull(myReaderX("tipologia"), "") & "', " & par.IfNull(myReaderX("id_edificio"), "") _
    '                                 & ", '" & par.IfNull(myReaderX("scala"), "null") & "', '" & par.IfNull(myReaderX("cod_tipo_livello_piano"), "") _
    '                                 & "', '" & par.IfNull(myReaderX("interno"), "") & "', " & par.IfNull(myReaderX("id_unita_principale"), "null") _
    '                                 & ", '" & par.IfNull(myReaderX("sezione"), "") & "','" & par.IfNull(myReaderX("foglio"), "") & "','" & par.IfNull(myReaderX("numero"), "") _
    '                                 & "', '" & par.IfNull(myReaderX("sub"), "") & "', '" & par.IfNull(myReaderX("COD_TIPOLOGIA_catasto"), "") & "', " & par.VirgoleInPunti(par.IfNull(myReaderX("rendita"), "null")) _
    '                                 & " ,'" & par.IfNull(myReaderX("cod_categoria_catastale"), "") & "', '" & par.IfNull(myReaderX("cod_classe_catastale"), "") _
    '                                 & "', " & par.VirgoleInPunti(par.IfNull(myReaderX("superficie_mq"), "null")) & ", " & par.VirgoleInPunti(par.IfNull(myReaderX("cubatura"), "null")) & ", " _
    '                                 & par.VirgoleInPunti(par.IfNull(myReaderX("num_vani"), "null")) & ", " & par.VirgoleInPunti(par.IfNull(myReaderX("superficie_catastale"), "null")) _
    '                                 & ", " & par.VirgoleInPunti(par.IfNull(myReaderX("rendita_storica"), "null")) & ", " & par.VirgoleInPunti(par.IfNull(myReaderX("immobile_storico"), "null")) _
    '                                 & ", " & par.VirgoleInPunti(par.IfNull(myReaderX("reddito_dominicale"), "null")) & ", " & par.VirgoleInPunti(par.IfNull(myReaderX("valore_imponibile"), "null")) _
    '                                 & ",  " & par.VirgoleInPunti(par.IfNull(myReaderX("reddito_agrario"), "null")) & ", " & par.VirgoleInPunti(par.IfNull(myReaderX("valore_bilancio"), "null")) _
    '                                 & ",null, '" & par.IfNull(myReaderX("data_acquisizione"), "") & "', '" & par.IfNull(myReaderX("data_fine_validita"), "null") _
    '                                 & "', '" & par.IfNull(myReaderX("ditta"), "") & "', '" & par.IfNull(myReaderX("num_partita"), "") & "', NULL, NULL, NULL, NULL,  NULL, NULL, '" _
    '                                 & par.PulisciStrSql(par.IfNull(myReaderX("indirizzo"), "")) & "', '" & par.IfNull(myReaderX("civico"), "") _
    '                                 & "', '" & par.IfNull(myReaderX("cap"), "") & "', NULL, '" & par.IfNull(myReaderX("cod_comune"), "") & "', NULL, NULL)"
    '                par.cmd.ExecuteNonQuery()


    '            End If
    '            myReaderX.Close()

    '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.INTESTATARI_RAPPORTO (ID_CONTRATTO,ID_ANAGRAFICA,DATA_INIZIO,DATA_FINE) VALUES (" & INDICE_CONTRATTO & "," & IdAnagRichiedente & ",'" & RinnovoDataPG & "','29991231')"
    '            par.cmd.ExecuteNonQuery()

    '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
    '            & "VALUES (" & INDICE_CONTRATTO & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
    '            & "'F01','')"
    '            par.cmd.ExecuteNonQuery()




    '            txtModificato.Value = "0"
    '            'Tab_Contratto1.DisabilitaTutto()

    '            'Response.Write("<script>alert('Operazione Effettuata! La bolletta di fine rapporto è stata regolarmente creata.\nOra sarai reindirizzato sul nuovo rapporto (" & NuovoCodiceContratto & ") !');</script>")

    '            sNuovoCodiceRapporto = NuovoCodiceContratto
    '            lNuovoIdRapporto = INDICE_CONTRATTO

    '            '*************evento per voltura
    '            par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
    '                            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
    '                            & "','F165','','')"
    '            par.cmd.ExecuteNonQuery()
    '            CType(Dom_Decisioni1.FindControl("autorizzFinale"), HiddenField).Value = 1


    '            'Response.Write("<script>popupWindow = window.open('../Contratti/Contratto.aspx?ID=" & lNuovoIdRapporto & "&COD=" & sNuovoCodiceRapporto & "', '" & sNuovoCodiceRapporto & "', 'height=700,width=900');</script>")


    '            'Generale1.Provenienza = TipoContratto
    '            'Generale1.IndiceDichiarazione = lIdDichiarazione
    '            'Generale1.IndiceDomanda = lIdDomandaERP
    '            'Generale1.IndiceAnagrafe = lIdAU
    '        End If

    '    Catch ex As Exception
    '        Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
    '        Response.Write("<script>top.location.href='../Errore.aspx';</script>")
    '        par.myTrans.Rollback()
    '        par.myTrans = par.OracleConn.BeginTransaction()
    '        HttpContext.Current.Session.Add("TRANSAZIONE", par.myTrans)
    '    End Try
    'End Function

    Private Function ChiudiPerRinnovo(ByVal CodFis As String)
        Try

            Dim DESTINAZIONE As String = ""

            Dim Risoluzione As Boolean = False
            Dim importoRisoluzione As Double = 0
            Dim IMPORTOINTERESSI As Double = 0
            Dim sAggiunta As String = ""
            Dim DataCalcolo As String = ""
            Dim DataInizio As String = ""

            Dim tasso As Double = 0
            Dim baseCalcolo As Double = 0

            Dim Giorni As Integer = 0
            Dim GiorniAnno As Integer = 0
            Dim dataPartenza As String = ""

            Dim Totale As Double = 0
            Dim TotalePeriodo As Double = 0
            Dim indice As Long = 0
            Dim DataFine As String = ""
            Dim num_bolletta As String = ""
            Dim importobolletta As Double = 0
            Dim I As Integer = 0

            Dim importodanni As Double = 0
            Dim importotrasporto As Double = 0

            Dim Interessi As New SortedDictionary(Of Integer, Double)

            Dim RIASSUNTO_BOLLETTA As String = ""
            Dim lIdConnessione As String = ""

            '-----------06/12/2011
            Dim IdContratto As String = ""
            Dim sNuovoCodiceRapporto As String = ""
            Dim lNuovoIdRapporto As String = ""
            Dim UnitaContratto As Long

            Dim RinnovoDataChiusura As String = ""
            Dim RinnovoDataPG As String = ""
            Dim RinnovoNumeroPG As String = ""
            Dim RinnovoCanone As String = ""
            Dim FaiCambioBox As String = "1"
            Dim CFNuovoIntest As String = ""
            Dim IdUI As Long = 0
            Dim CognomeNome As String = ""
            Dim TipoIndir As String = ""
            Dim Indirizzo As String = ""
            Dim Civico As String = ""
            Dim LuogoRec As String = ""
            Dim Sigla As String = ""
            Dim Cap As String = ""
            'Dim data_riconsegna As String = ""
            '-----------fine 06/12/2011


            'par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            'par.SettaCommand(par)




            data_riconsegna.Value = par.AggiustaData(Date.Parse(par.FormattaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text), New System.Globalization.CultureInfo("it-IT", False)).AddDays(-1).ToString("dd/MM/yyyy"))

            '-----------06/12/2011
            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            Dim da1 As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            Dim dt1 As New Data.DataTable
            da1.Fill(dt1)
            IdContratto = dt1.Rows(0).Item("id")

            RinnovoCanone = dt1.Rows(0).Item("IMP_CANONE_INIZIALE")
            RinnovoDataChiusura = par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text)

            Dim aggiornamento_istat As Double = 0
            Dim AltriAdeguamenti As Double = 0

            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo=2 and ID_CONTRATTO=" & IdContratto
            Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If lettore.Read Then
                aggiornamento_istat = par.IfNull(lettore(0), 0)
            End If
            lettore.Close()

            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo<>2 and ID_CONTRATTO=" & IdContratto
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                AltriAdeguamenti = par.IfNull(lettore(0), 0)
            End If
            lettore.Close()

            par.cmd.CommandText = "SELECT ID_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE COD_UNITA_IMMOBILIARE='" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "' AND ID_UNITA_PRINCIPALE IS NULL"
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                UnitaContratto = par.IfNull(lettore("ID_UNITA"), "")
            End If
            lettore.Close()

            par.cmd.CommandText = "SELECT * FROM DICHIARAZIONI_VSA,COMP_NUCLEO_VSA WHERE DICHIARAZIONI_VSA.ID = COMP_NUCLEO_VSA.ID_DICHIARAZIONE AND DICHIARAZIONI_VSA.ID=" & lIdDichiarazione & " AND PROGR=0"
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                RinnovoDataPG = par.IfNull(lettore("DATA_PG"), "")
                RinnovoNumeroPG = par.IfNull(lettore("PG"), "")
                CFNuovoIntest = par.IfNull(lettore("COD_FISCALE"), "")

                CognomeNome = Trim(par.IfNull(lettore("COGNOME"), "")) & " " & Trim(par.IfNull(lettore("NOME"), ""))

                par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE ID='" & par.IfNull(lettore("ID_LUOGO_RES_DNTE"), "") & "'"
                Dim myReaderIDluogoRES As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderIDluogoRES.Read Then
                    Sigla = par.IfNull(myReaderIDluogoRES("SIGLA"), "")
                    LuogoRec = par.PulisciStrSql(par.IfNull(myReaderIDluogoRES("NOME"), ""))
                End If
                myReaderIDluogoRES.Close()

                par.cmd.CommandText = "SELECT * FROM T_TIPO_INDIRIZZO WHERE COD='" & par.IfNull(lettore("ID_TIPO_IND_RES_DNTE"), "") & "'"
                Dim myReaderTipoIndir As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderTipoIndir.Read Then
                    TipoIndir = par.IfNull(myReaderTipoIndir("DESCRIZIONE"), "")
                End If
                myReaderTipoIndir.Close()

                Indirizzo = par.PulisciStrSql(par.IfNull(lettore("IND_RES_DNTE"), ""))
                Civico = par.PulisciStrSql(par.IfNull(lettore("CIVICO_RES_DNTE"), ""))
                Cap = par.IfNull(lettore("CAP_RES_DNTE"), "")
            End If
            lettore.Close()
            '-----------fine 06/12/2011


            If data_riconsegna.Value <> "" Then

                'If CodFis <> "-1" Then
                '    par.cmd.CommandText = "select anagrafica.* from siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='INTE' AND anagrafica.cod_fiscale='" & UCase(par.PulisciStrSql(CodFis)) & "'"
                '    Dim myReaderABCD As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                '    If myReaderABCD.HasRows = False Then
                '        Response.Write("<script>alert('ATTENZIONE...il Codife Fiscale inserito non risulta essere intestatario di contratto ERP! Operazione Annullata');</script>")
                '        myReaderABCD.Close()
                '        Exit Function
                '    End If
                '    myReaderABCD.Close()
                'End If

                'Risoluzione = True
                'par.cmd.CommandText = "select * from siscom_mi.parametri_bolletta where id=1"
                'Dim myReaderAa As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                'If myReaderAa.Read Then
                '    importoRisoluzione = CDbl(par.PuntiInVirgole(myReaderAa("valore")))
                'End If
                'myReaderAa.Close()
                'importodanni = 0
                'importotrasporto = 0

                'If data_riconsegna.Value = par.IfNull(dt1.Rows(0).Item("DATA_SCADENZA_RINNOVO"), "") Or data_riconsegna.Value = par.IfNull(dt1.Rows(0).Item("DATA_SCADENZA"), "") Then
                '    importoRisoluzione = 0
                'End If

                'par.cmd.CommandText = "select * from siscom_mi.tab_interessi_legaLI order by anno desc"
                'Interessi.Clear()
                'Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                'Do While myReaderC.Read
                '    Interessi.Add(myReaderC("anno"), myReaderC("tasso"))
                'Loop
                'myReaderC.Close()

                'DataCalcolo = data_riconsegna.Value
                'baseCalcolo = dt1.Rows(0).Item("IMP_DEPOSITO_CAUZ")
                'If baseCalcolo > 0 And dt1.Rows(0).Item("INTERESSI_CAUZIONE") = 1 Then

                '    par.cmd.CommandText = "select * from siscom_mi.adeguamento_interessi where id_contratto=" & IdContratto & " and fl_applicato=1 order by id desc"
                '    Dim myReaderZ As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                '    If myReaderZ.HasRows = False Then
                '        DataInizio = dt1.Rows(0).Item("DATA_DECORRENZA")
                '    End If
                '    If myReaderZ.Read Then
                '        DataInizio = Format(DateAdd(DateInterval.Day, 1, CDate(par.FormattaData(myReaderZ("data")))), "yyyyMMdd")
                '    End If
                '    myReaderZ.Close()

                '    Giorni = 0
                '    GiorniAnno = 0
                '    dataPartenza = DataInizio
                '    Totale = 0
                '    TotalePeriodo = 0

                '    par.cmd.CommandText = "insert into siscom_mi.adeguamento_interessi (id,id_contratto,data,fl_applicato) values (siscom_mi.seq_adeguamento_interessi.nextval," & IdContratto & ",'" & DataCalcolo & "',1)"
                '    par.cmd.ExecuteNonQuery()
                '    par.cmd.CommandText = "select siscom_mi.seq_adeguamento_interessi.currval from dual"
                '    myReaderZ = par.cmd.ExecuteReader()
                '    indice = 0
                '    If myReaderZ.Read Then
                '        indice = myReaderZ(0)
                '    End If

                '    For I = CInt(Mid(DataInizio, 1, 4)) To CInt(Mid(DataCalcolo, 1, 4))

                '        If I = CInt(Mid(DataCalcolo, 1, 4)) Then
                '            DataFine = par.FormattaData(DataCalcolo)
                '        Else
                '            DataFine = "31/12/" & I

                '        End If

                '        GiorniAnno = DateDiff(DateInterval.Day, CDate("01/01/" & I), CDate("31/12/" & I)) + 1

                '        Giorni = DateDiff(DateInterval.Day, CDate(par.FormattaData(dataPartenza)), CDate(DataFine)) + 1

                '        If I < 1990 Then
                '            tasso = 5
                '        Else
                '            If Interessi.ContainsKey(I) = True Then
                '                tasso = Interessi(I)
                '            End If
                '        End If

                '        TotalePeriodo = Format((((baseCalcolo * tasso) / 100) / GiorniAnno) * Giorni, "0.00")
                '        Totale = Totale + TotalePeriodo
                '        par.cmd.CommandText = "insert into siscom_mi.adeguamento_interessi_voci (id_adeguamento,dal,al,giorni,tasso,importo) values (" & indice & ",'" & dataPartenza & "','" & Format(CDate(DataFine), "yyyyMMdd") & "'," & Giorni & "," & par.VirgoleInPunti(tasso) & "," & par.VirgoleInPunti(TotalePeriodo) & ")"
                '        par.cmd.ExecuteNonQuery()
                '        dataPartenza = I + 1 & "0101"
                '    Next
                '    par.cmd.CommandText = "update siscom_mi.adeguamento_interessi set importo=" & par.VirgoleInPunti(Format(Totale, "0.00")) & " where id=" & indice
                '    par.cmd.ExecuteNonQuery()
                'End If

                ''If CodFis <> "-1" Then

                ''    'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & IdContratto & ""
                ''    'Dim myReaderS1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                ''    'If myReaderS1.Read = True Then
                ''    par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET TIPO_COR='" & par.IfNull(dt1.Rows(0).Item("TIPO_COR"), "VIA") _
                ''                        & "',LUOGO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("LUOGO_COR"), "")) _
                ''                        & "',VIA_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("VIA_COR"), "")) _
                ''                        & "',DATA_RICONSEGNA='" & CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text _
                ''                        & "',CIVICO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("CIVICO_COR"), "")) _
                ''                        & "',SIGLA_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("SIGLA_COR"), "")) _
                ''                        & "',CAP_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("CAP_COR"), "")) _
                ''                        & "',PRESSO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("PRESSO_COR"), "")) _
                ''                        & "' WHERE ID=" & IdContratto
                ''    par.cmd.ExecuteNonQuery()
                ''    'End If
                ''    'myReaderS1.Close()
                ''End If

                Dim IdAnagRichiedente As String = ""
                par.cmd.CommandText = "SELECT DISTINCT(ANAGRAFICA.ID) FROM SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND COD_FISCALE = (SELECT COD_FISCALE FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND PROGR = 0) ORDER BY ID DESC"
                Dim myReaderIdA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
                If myReaderIdA.Read Then
                    IdAnagRichiedente = myReaderIdA("id")
                End If
                myReaderIdA.Close()

                par.cmd.CommandText = "SELECT id_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & IdContratto
                Dim myReaderUI As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderUI.Read Then
                    IdUI = myReaderUI("id_UNITA")
                End If
                myReaderUI.Close()

                'Dim DataScadenza As String = DateAdd("d", 10, Now)
                'Dim TOTALE_BOLLETTA As Double = 0

                'par.cmd.CommandText = "select RAPPORTI_UTENZA.*,EDIFICI.ID_COMPLESSO,UNITA_CONTRATTUALE.ID_EDIFICIO FROM SISCOM_MI.UNITA_CONTRATTUALE,SISCOM_MI.EDIFICI,SISCOM_MI.RAPPORTI_UTENZA WHERE UNITA_CONTRATTUALE.ID_UNITA_PRINCIPALE IS NULL AND RAPPORTI_UTENZA.ID=" & IdContratto & " AND UNITA_CONTRATTUALE.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND EDIFICI.ID=UNITA_CONTRATTUALE.ID_EDIFICIO"
                'Dim myReaderS As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                'If myReaderS.Read Then


                '    'DESTINAZIONE = par.IfNull(myReaderS("TIPO_COR"), "")


                '    par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE " _
                '                                    & "(ID, N_RATA, DATA_EMISSIONE, DATA_SCADENZA, DATA_I_SOLLECITO, " _
                '                                    & "DATA_II_SOLLECITO, DATA_PAGAMENTO, NOTE, ID_CONTRATTO, ID_ESERCIZIO_F, " _
                '                                    & "ID_UNITA, FL_ANNULLATA, PAGABILE_PRESSO, COD_AFFITTUARIO, INTESTATARIO, " _
                '                                    & "INDIRIZZO, CAP_CITTA, PRESSO, RIFERIMENTO_DA, RIFERIMENTO_A, " _
                '                                    & "FL_STAMPATO, ID_COMPLESSO, DATA_INS_PAGAMENTO, IMPORTO_PAGATO, NOTE_PAGAMENTO, " _
                '                                    & "ANNO, OPERATORE_PAG, ID_EDIFICIO, DATA_ANNULLO_PAG, OPERATORE_ANNULLO_PAG,RIF_FILE,ID_TIPO) " _
                '                                    & "Values " _
                '                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE.NEXTVAL, 999, '" & Format(Now, "yyyyMMdd") _
                '                                    & "', '" & Format(CDate(DataScadenza), "yyyyMMdd") & "', NULL,NULL,NULL,'FINE CONTRATTO'," _
                '                                    & "" & IdContratto _
                '                                    & " ," & par.RicavaEsercizioCorrente & ", " _
                '                                    & UnitaContratto _
                '                                    & ", '0', '', " & IdAnagRichiedente _
                '                                    & ", '" & par.PulisciStrSql(par.IfNull(myReaderS("PRESSO_COR"), "")) & "', " _
                '                                    & "'" & par.PulisciStrSql(par.IfNull(myReaderS("TIPO_COR"), "") & " " & par.IfNull(myReaderS("VIA_COR"), "") & ", " & par.PulisciStrSql(par.IfNull(myReaderS("CIVICO_COR"), ""))) _
                '                                    & "', '" & par.PulisciStrSql(par.IfNull(myReaderS("CAP_COR"), "") & " " & par.IfNull(myReaderS("LUOGO_COR"), "") & "(" & par.IfNull(myReaderS("SIGLA_COR"), "") & ")") _
                '                                    & "', '', '" & Format(Now, "yyyyMMdd") _
                '                                    & "', '" & Format(Now, "yyyyMMdd") & "', " _
                '                                    & "'0', " & myReaderS("ID_COMPLESSO") & ", '', NULL, '', " _
                '                                    & Year(Now) & ", '', " & myReaderS("ID_EDIFICIO") & ", NULL, NULL,'FIN',3)"

                '    par.cmd.ExecuteNonQuery()
                '    par.cmd.CommandText = "select SISCOM_MI.SEQ_BOL_BOLLETTE.CURRVAL FROM DUAL"
                '    Dim myReaderA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                '    If myReaderA.Read Then
                '        Dim ID_BOLLETTA As Long = myReaderA(0)


                '        If importoRisoluzione > 0 Then
                '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                '                                & ",35" _
                '                                & "," & par.VirgoleInPunti(importoRisoluzione) & ")"
                '            RIASSUNTO_BOLLETTA = "Risoluzione: " & par.VirgoleInPunti(importoRisoluzione) & " Euro;\n"
                '            par.cmd.ExecuteNonQuery()

                '            TOTALE_BOLLETTA = importoRisoluzione
                '        End If

                '        If importodanni > 0 Then
                '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                '                                & ",100" _
                '                                & "," & par.VirgoleInPunti(importodanni) & ")"
                '            RIASSUNTO_BOLLETTA = "Risoluzione: " & par.VirgoleInPunti(importodanni) & " Euro;\n"
                '            par.cmd.ExecuteNonQuery()

                '            TOTALE_BOLLETTA = TOTALE_BOLLETTA + importodanni
                '        End If

                '        If importotrasporto > 0 Then
                '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                '                                & ",101" _
                '                                & "," & par.VirgoleInPunti(importotrasporto) & ")"
                '            RIASSUNTO_BOLLETTA = "Risoluzione: " & par.VirgoleInPunti(importotrasporto) & " Euro;\n"
                '            par.cmd.ExecuteNonQuery()

                '            TOTALE_BOLLETTA = TOTALE_BOLLETTA + importotrasporto
                '        End If


                '        If Totale > 0 And dt1.Rows(0).Item("INTERESSI_CAUZIONE") = 1 Then
                '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                '                                & ",15" _
                '                                & "," & par.VirgoleInPunti(Format(Totale * -1, "0.00")) & ")"
                '            par.cmd.ExecuteNonQuery()
                '            RIASSUNTO_BOLLETTA = RIASSUNTO_BOLLETTA & "Rimborso Interessi Annuo Cauzione: " & par.VirgoleInPunti(Format(Totale * -1, "0.00")) & " Euro;\n"
                '            TOTALE_BOLLETTA = TOTALE_BOLLETTA + (Totale * -1)

                '        End If

                '        If baseCalcolo > 0 Then
                '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                '                                & ",50" _
                '                                & "," & par.VirgoleInPunti(Format(baseCalcolo * -1, "0.00")) & ")"
                '            par.cmd.ExecuteNonQuery()
                '            RIASSUNTO_BOLLETTA = RIASSUNTO_BOLLETTA & "Rimborso Deposito Cauzionale: " & par.VirgoleInPunti(Format(baseCalcolo * -1, "0.00")) & " Euro;\n"
                '            TOTALE_BOLLETTA = TOTALE_BOLLETTA + (baseCalcolo * -1)

                '        End If

                '        Dim Giorni1 As Integer = 0
                '        Dim Giorni2 As Integer = 0
                '        Dim SPESEmav As Double = 0
                '        Dim BOLLO As Double = 0
                '        Dim APPLICABOLLO As Double = 0

                '        Dim PARTENZA As String = ""
                '        Dim FINE As String = ""


                '        par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=26"
                '        myReaderA = par.cmd.ExecuteReader()
                '        If myReaderA.Read Then
                '            SPESEmav = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                '        End If
                '        myReaderA.Close()

                '        par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=0"
                '        myReaderA = par.cmd.ExecuteReader()
                '        If myReaderA.Read Then
                '            BOLLO = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                '        End If
                '        myReaderA.Close()

                '        par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=25"
                '        myReaderA = par.cmd.ExecuteReader()
                '        If myReaderA.Read Then
                '            APPLICABOLLO = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                '        End If
                '        myReaderA.Close()

                '        Dim SPESEPOSTALI As Double = 0
                '        Dim SPESEPOSTALI_CAPOLUOGHI As Double = 0
                '        Dim SPESEPOSTALI_ALTRI As Double = 0
                '        Dim SPESEPOSTALI_DA_APPLICARE As Double = 0

                '        par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=17"
                '        myReaderA = par.cmd.ExecuteReader()
                '        If myReaderA.Read Then
                '            SPESEPOSTALI = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                '        End If
                '        myReaderA.Close()

                '        par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=29"
                '        myReaderA = par.cmd.ExecuteReader()
                '        If myReaderA.Read Then
                '            SPESEPOSTALI_CAPOLUOGHI = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                '        End If
                '        myReaderA.Close()

                '        par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=30"
                '        myReaderA = par.cmd.ExecuteReader()
                '        If myReaderA.Read Then
                '            SPESEPOSTALI_ALTRI = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                '        End If
                '        myReaderA.Close()

                '        If dt1.Rows(0).Item("LUOGO_COR") = "MILANO" Then
                '            SPESEPOSTALI_DA_APPLICARE = SPESEPOSTALI
                '        Else
                '            If InStr(Capoluoghi, dt1.Rows(0).Item("LUOGO_COR")) > 0 Then
                '                SPESEPOSTALI_DA_APPLICARE = SPESEPOSTALI_CAPOLUOGHI
                '            Else
                '                SPESEPOSTALI_DA_APPLICARE = SPESEPOSTALI_ALTRI
                '            End If
                '        End If


                '        par.cmd.CommandText = "select * FROM SISCOM_MI.BOL_BOLLETTE WHERE FL_ANNULLATA='0' AND N_RATA<>99 AND N_RATA<>999 AND N_RATA<>99999 AND ID_CONTRATTO=" & IdContratto & " ORDER BY ID DESC"
                '        myReaderA = par.cmd.ExecuteReader()
                '        If myReaderA.Read Then
                '            PARTENZA = myReaderA("RIFERIMENTO_A")
                '        End If
                '        myReaderA.Close()

                '        FINE = data_riconsegna.Value

                '        If PARTENZA <> "" And FINE <> "" Then
                '            Giorni1 = DateDiff("d", CDate(par.FormattaData(PARTENZA)), CDate(par.FormattaData(FINE)))


                '            If Giorni1 > 0 Then
                '                'calcolo l'importo dell'affitto in base al numero di rate annue

                '                Dim affitto As Double = 0

                '                If par.IfNull(myReaderS("imp_CANONE_INIZIALE"), 0) > 0 Then
                '                    affitto = Format((par.IfNull(myReaderS("imp_CANONE_INIZIALE"), 1) / 365) * (Giorni1), "0.00")
                '                    TOTALE_BOLLETTA = TOTALE_BOLLETTA + (par.IfNull(myReaderS("imp_CANONE_INIZIALE"), 1) / 365) * (Giorni1)

                '                    If par.IfNull(myReaderS("PROVENIENZA_ASS"), "") <> "7" Then
                '                        If FINE = par.IfNull(myReaderS("data_scadenza_rinnovo"), "") Then
                '                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",36" _
                '                                                & "," & par.VirgoleInPunti(affitto) & ")"
                '                            par.cmd.ExecuteNonQuery()
                '                        Else
                '                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",1" _
                '                                                & "," & par.VirgoleInPunti(affitto) & ")"
                '                            par.cmd.ExecuteNonQuery()
                '                        End If
                '                    Else
                '                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",560" _
                '                            & "," & par.VirgoleInPunti(affitto) & ")"
                '                        par.cmd.ExecuteNonQuery()
                '                    End If


                '                End If
                '            End If
                '        End If

                '        If Giorni1 > 0 Then
                '            Dim aggiornamento_istat As Double = 0
                '            Dim AltriAdeguamenti As Double = 0

                '            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo=2 and ID_CONTRATTO=" & IdContratto
                '            myReaderA = par.cmd.ExecuteReader()
                '            If myReaderA.Read Then
                '                aggiornamento_istat = par.IfNull(myReaderA(0), 0)
                '            End If
                '            myReaderA.Close()

                '            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo<>2 and ID_CONTRATTO=" & IdContratto
                '            myReaderA = par.cmd.ExecuteReader()
                '            If myReaderA.Read Then
                '                AltriAdeguamenti = par.IfNull(myReaderA(0), 0)
                '            End If
                '            myReaderA.Close()

                '            If aggiornamento_istat > 0 Then

                '                TOTALE_BOLLETTA = TOTALE_BOLLETTA + Format((aggiornamento_istat / 365) * Giorni1, "0.00")
                '                aggiornamento_istat = (aggiornamento_istat / 365) * Giorni1

                '                If FINE = par.IfNull(myReaderS("data_scadenza_rinnovo"), "") Or par.IfNull(myReaderS("PROVENIENZA_ASS"), "") = "7" Then
                '                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",405" _
                '                                        & "," & par.VirgoleInPunti(Format(aggiornamento_istat, "0.00")) & ")"
                '                    par.cmd.ExecuteNonQuery()
                '                Else
                '                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",404" _
                '                                        & "," & par.VirgoleInPunti(Format(aggiornamento_istat, "0.00")) & ")"
                '                    par.cmd.ExecuteNonQuery()
                '                End If
                '            End If

                '            If AltriAdeguamenti > 0 Then

                '                TOTALE_BOLLETTA = TOTALE_BOLLETTA + Format((AltriAdeguamenti / 365) * Giorni1, "0.00")
                '                AltriAdeguamenti = (AltriAdeguamenti / 365) * Giorni1


                '                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",652" _
                '                                    & "," & par.VirgoleInPunti(Format(AltriAdeguamenti, "0.00")) & ")"
                '                par.cmd.ExecuteNonQuery()

                '            End If

                '            par.cmd.CommandText = "select bol_schema.*,t_voci_bolletta.descrizione from siscom_mi.bol_schema,siscom_mi.t_voci_bolletta where anno=" & Year(Now) & " and da_rata=1 And per_rate=12 AND t_voci_bolletta.id=bol_schema.id_voce and  bol_schema.id_contratto=" & IdContratto
                '            myReaderA = par.cmd.ExecuteReader()
                '            Do While myReaderA.Read

                '                TOTALE_BOLLETTA = TOTALE_BOLLETTA + CDbl((myReaderA("importo") / 365) * Giorni1)

                '                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & "," & myReaderA("ID_VOCE") _
                '                                    & "," & par.VirgoleInPunti(Format((myReaderA("importo") / 365) * Giorni1, "0.00")) & ")"
                '                par.cmd.ExecuteNonQuery()


                '            Loop
                '            myReaderA.Close()
                '        End If

                '        If SPESEmav > 0 Then
                '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",407" _
                '            & "," & par.VirgoleInPunti(Format(SPESEmav, "0.00")) & ")"
                '            par.cmd.ExecuteNonQuery()

                '            TOTALE_BOLLETTA = TOTALE_BOLLETTA + SPESEmav
                '        End If


                '        Dim TotMorosita As Double = 0
                '        Dim TotMorositaSB As Double = 0
                '        par.cmd.CommandText = "select BOL_BOLLETTE.id,(SELECT NVL(SUM(BOL_BOLLETTE_VOCI.importo),0)-NVL(SUM(BOL_BOLLETTE_VOCI.imp_pagato),0) FROM siscom_mi.BOL_BOLLETTE_VOCI,siscom_mi.T_VOCI_BOLLETTA WHERE T_VOCI_BOLLETTA.competenza=3 AND T_VOCI_BOLLETTA.ID=BOL_BOLLETTE_VOCI.id_voce AND BOL_BOLLETTE_VOCI.id_bolletta=BOL_BOLLETTE.ID) AS importo_sindacati,(SELECT NVL(SUM(BOL_BOLLETTE_VOCI.importo),0)-NVL(SUM(BOL_BOLLETTE_VOCI.imp_pagato),0) FROM siscom_mi.BOL_BOLLETTE_VOCI,siscom_mi.T_VOCI_BOLLETTA WHERE T_VOCI_BOLLETTA.competenza<>3 AND T_VOCI_BOLLETTA.ID=BOL_BOLLETTE_VOCI.id_voce AND BOL_BOLLETTE_VOCI.id_bolletta=BOL_BOLLETTE.ID) AS importo_altri FROM SISCOM_MI.BOL_BOLLETTE WHERE bol_bollette.data_scadenza<" & Format(Now, "yyyyMMdd") & " and FL_ANNULLATA='0' AND ID_BOLLETTA_RIC IS NULL AND (ID_TIPO=1 OR ID_TIPO=2 OR ID_TIPO=6 or id_tipo=8) AND  importo_totale<>nvl(importo_pagato,0) and ID_CONTRATTO=" & IdContratto
                '        myReaderA = par.cmd.ExecuteReader()
                '        Do While myReaderA.Read
                '            TotMorositaSB = 0
                '            TotMorositaSB = par.IfNull(myReaderA("IMPORTO_altri"), 0)
                '            If TotMorositaSB > 0 Then
                '                par.cmd.CommandText = "UPDATE SISCOM_MI.BOL_BOLLETTE SET fl_sollecito='1',ID_BOLLETTA_RIC=" & ID_BOLLETTA & " WHERE ID=" & myReaderA("ID")
                '                par.cmd.ExecuteNonQuery()
                '                TotMorosita = TotMorosita + TotMorositaSB
                '            End If
                '        Loop
                '        myReaderA.Close()

                '        If TotMorosita > 0 Then
                '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                           & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",151" _
                '                           & "," & par.VirgoleInPunti(Format(TotMorosita, "0.00")) & ")"
                '            par.cmd.ExecuteNonQuery()
                '            TOTALE_BOLLETTA = TOTALE_BOLLETTA + TotMorosita
                '        End If


                '        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",403" _
                '                            & "," & par.VirgoleInPunti(Format(SPESEPOSTALI_DA_APPLICARE, "0.00")) & ")"
                '        par.cmd.ExecuteNonQuery()
                '        TOTALE_BOLLETTA = TOTALE_BOLLETTA + SPESEPOSTALI_DA_APPLICARE

                '        If TOTALE_BOLLETTA > APPLICABOLLO Then
                '            If BOLLO > 0 Then
                '                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                '                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",95" _
                '                                    & "," & par.VirgoleInPunti(Format(BOLLO, "0.00")) & ")"
                '                par.cmd.ExecuteNonQuery()
                '            End If
                '        End If

                '        If TOTALE_BOLLETTA <= SPESEmav And TOTALE_BOLLETTA > 0 Then
                '            par.cmd.CommandText = "DELETE FROM SISCOM_MI.BOL_BOLLETTE WHERE ID=" & ID_BOLLETTA
                '            par.cmd.ExecuteNonQuery()
                '            RIASSUNTO_BOLLETTA = ""
                '        End If

                '    End If

                'End If
                'myReaderS.Close()




                'imgChiudiContratto.Visible = False

                'par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                '    & "VALUES (" & IdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                '    & "'F18','')"
                'par.cmd.ExecuteNonQuery()


                If CodFis = "-1" Then
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                        & "VALUES (" & IdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                        & "'F102','')"
                Else
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                        & "VALUES (" & IdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                        & "'F103','')"
                End If
                par.cmd.ExecuteNonQuery()




                'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.UNITA_STATO_MANUTENTIVO WHERE ID_UNITA=" & UnitaContratto
                'Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                'If myReader.Read Then

                '    par.cmd.CommandText = "Insert into siscom_mi.UNITA_STATO_MAN_S (id_unita,id_contratto,data_memo) values (" & UnitaContratto & "," & IdContratto & ",'" & Format(Now, "yyyyMMdd") & "')"
                '    par.cmd.ExecuteNonQuery()

                '    par.cmd.CommandText = "update siscom_mi.UNITA_STATO_MAN_S set DATA_RIPRESA_STR='" & par.IfNull(myReader("DATA_RIPRESA_STR"), "") _
                '    & "', DATA_CONSEGNA_STR='" & par.IfNull(myReader("DATA_CONSEGNA_STR"), "") _
                '    & "',ID_STRUTTURA_COMP=" & par.IfNull(myReader("ID_STRUTTURA_COMP"), "NULL") _
                '    & ",ST_DEP_CHIAVI=" & par.IfNull(myReader("ST_DEP_CHIAVI"), "NULL") _
                '                        & ",DATA_S='" & par.IfNull(myReader("DATA_S"), "") & "'" _
                '                        & ",RILEVAZIONE=" & par.IfNull(myReader("RILEVAZIONE"), 0) _
                '                        & ",RIASSEGNABILE=" & par.IfNull(myReader("RIASSEGNABILE"), 0) _
                '                        & ", P_BLINDATA=" & par.IfNull(myReader("P_BLINDATA"), 0) _
                '                        & ",SOL_GP=" & par.IfNull(myReader("SOL_GP"), 0) _
                '                        & ",SOL_GF=" & par.IfNull(myReader("SOL_GF"), 0) _
                '                        & ",SOL_PB=" & par.IfNull(myReader("SOL_PB"), 0) _
                '                        & ",SOL_LA=" & par.IfNull(myReader("SOL_LA"), 0) _
                '                        & ",SOL_AL=" & par.IfNull(myReader("SOL_AL"), 0) _
                '                        & ",HANDICAP=" & par.IfNull(myReader("HANDICAP"), 0) _
                '                        & ",DATA_PRE_S='" & par.IfNull(myReader("DATA_PRE_S"), "") _
                '                        & "',DATA_PRE_SLOGGIO='" & par.IfNull(myReader("DATA_PRE_SLOGGIO"), "") _
                '                        & "', NOTE='" & par.PulisciStrSql(par.IfNull(myReader("NOTE"), "")) _
                '                        & "',ALLARME=" & par.IfNull(myReader("ALLARME"), 0) _
                '                        & ", MOTIVAZIONI='" & par.PulisciStrSql(par.IfNull(myReader("MOTIVAZIONI"), "")) _
                '                        & "', ZONA='" & par.PulisciStrSql(par.IfNull(myReader("ZONA"), "")) _
                '                        & "', NUM_LOCALI='" & par.PulisciStrSql(par.IfNull(myReader("NUM_LOCALI"), "")) _
                '                        & "',NUM_SERVIZI='" & par.PulisciStrSql(par.IfNull(myReader("NUM_SERVIZI"), "")) _
                '                        & "', TIPO_ALLOGGIO=" & par.IfNull(myReader("TIPO_ALLOGGIO"), "NULL") _
                '                        & ", DATA_CONSEGNA_CHIAVI='" & par.PulisciStrSql(par.IfNull(myReader("DATA_CONSEGNA_CHIAVI"), "")) _
                '                        & "', CONSEGNATE_A='" & par.PulisciStrSql(par.IfNull(myReader("CONSEGNATE_A"), "")) _
                '                        & "', DATA_RIPRESA_CHIAVI='" & par.PulisciStrSql(par.IfNull(myReader("DATA_RIPRESA_CHIAVI"), "")) _
                '                        & "',ID_QUARTIERE=" & par.IfNull(myReader("ID_QUARTIERE"), 0) _
                '                        & ", DATA_RILEVAZIONE='" & par.PulisciStrSql(par.IfNull(myReader("DATA_RILEVAZIONE"), "")) _
                '                        & "', NOTEGRTP='" & par.PulisciStrSql(par.IfNull(myReader("NOTEGRTP"), "")) _
                '                        & "', SOL_PB1=" & par.IfNull(myReader("SOL_PB1"), 0) _
                '                        & ", SOL_PB2=" & par.IfNull(myReader("SOL_PB2"), 0) _
                '                        & ", SOL_PB3=" & par.IfNull(myReader("SOL_PB3"), 0) _
                '                        & ", SOL_LA1=" & par.IfNull(myReader("SOL_LA1"), 0) _
                '                        & ", TIPO_RIASSEGNABILE=" & par.IfNull(myReader("TIPO_RIASSEGNABILE"), 0) _
                '                        & ", FINE_LAVORI='" & par.IfNull(myReader("FINE_LAVORI"), 0) _
                '                        & "', DATA_Q='" & par.IfNull(myReader("DATA_Q"), 0) _
                '                        & "',IMPORTO_DANNI=" & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO_DANNI"), 0)) _
                '                        & ", IMPORTO_TRASPORTO=" & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO_DANNI"), 0)) _
                '                        & ", NOTE_DANNI='" & par.PulisciStrSql(par.IfNull(myReader("NOTE_DANNI"), "")) _
                '                        & "', FL_AUTORIZZATI_IMP='" & par.IfNull(myReader("FL_AUTORIZZATI_IMP"), 0) _
                '                        & "', REC_GRTP=" & par.IfNull(myReader("REC_GRTP"), 0) _
                '                        & " WHERE ID_UNITA=" & UnitaContratto & " AND ID_CONTRATTO=" _
                '                        & IdContratto & " AND DATA_MEMO='" & Format(Now, "yyyyMMdd") & "'"





                '    par.cmd.ExecuteNonQuery()
                'End If
                'myReader.Close()

                'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.UNITA_STATO_MANUTENTIVO_INT WHERE ID_UNITA=" & UnitaContratto
                'myReader = par.cmd.ExecuteReader()
                'Do While myReader.Read
                '    par.cmd.CommandText = "INSERT INTO SISCOM_MI.UNITA_STATO_MAN_INT_S (ID_UNITA,ID_INTERVENTO,DATA_MEMO) VALUES (" & UnitaContratto & "," & myReader("ID_INTERVENTO") & ",'" & Format(Now, "yyyyMMdd") & "')"
                '    par.cmd.ExecuteNonQuery()
                'Loop
                'myReader.Close()

                'par.cmd.CommandText = "update siscom_mi.intestatari_rapporto set data_fine='" & data_riconsegna.Value & "' where id_contratto=" & IdContratto
                'par.cmd.ExecuteNonQuery()


                Dim progressivo As Integer
                'par.cmd.CommandText = "select MAX(TO_NUMBER(TRANSLATE(SUBSTR(cod_contratto,18,2),'A','0'))) from SISCOM_MI.rapporti_utenza where id=" & IdContratto
                par.cmd.CommandText = "select MAX(TO_NUMBER(TRANSLATE(SUBSTR(cod_contratto,18,2),'A','0'))) from SISCOM_MI.rapporti_utenza,siscom_mi.unita_contrattuale,siscom_mi.unita_immobiliari where id_unita=" & IdUI & " and rapporti_utenza.id=unita_contrattuale.id_contratto and unita_contrattuale.id_unita=siscom_mi.unita_immobiliari.id"
                Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader1.Read Then
                    progressivo = par.IfNull(myReader1(0), 0) + 1
                Else
                    progressivo = 1
                End If
                myReader1.Close()
                Dim NuovoCodiceContratto As String = Mid(CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text, 1, 17) & Format((progressivo), "00")

                Dim nome As String = ""
                Dim Cognome As String = ""
                Dim CF As String = ""

                If CodFis = "-1" Then
                    par.cmd.CommandText = "select anagrafica.* from siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND soggetti_contrattuali.id_CONTRATTO=" & IdContratto
                Else
                    par.cmd.CommandText = "select anagrafica.* from siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND anagrafica.cod_fiscale='" & UCase(par.PulisciStrSql(CodFis)) & "'"
                End If


                Dim myReaderX As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()

                If myReaderX.Read = True Then
                    If par.IfNull(myReaderX("ragione_sociale"), "") = "" Then
                        Cognome = par.IfNull(myReaderX("cognome"), "")
                        nome = par.IfNull(myReaderX("nome"), "")
                    Else
                        Cognome = par.IfNull(myReaderX("ragione_sociale"), "")
                        nome = ""
                    End If
                    If par.IfNull(myReaderX("partita_iva"), "") = "" Then
                        CF = par.IfNull(myReaderX("cod_fiscale"), "")
                    Else
                        CF = par.IfNull(myReaderX("partita_iva"), "")
                    End If



                    par.cmd.CommandText = "Insert into siscom_mi.UNITA_ASSEGNATE (ID_DOMANDA, ID_UNITA, DATA_ASSEGNAZIONE, " _
                                        & "GENERATO_CONTRATTO, ID_DICHIARAZIONE, COGNOME_RS, NOME, CF_PIVA, PROVENIENZA, N_OFFERTA,CANONE,ID_ANAGRAFICA,PROVVEDIMENTO,DATA_PROVVEDIMENTO) " _
                                        & " Values " _
                                        & "(-1, " & UnitaContratto & ", '" & RinnovoDataPG & "', 1, -1, " _
                                        & "'" & par.PulisciStrSql(Cognome) & "', '" & par.PulisciStrSql(nome) _
                                        & "', '" & par.PulisciStrSql(CF) & "', 'U', 0," & par.VirgoleInPunti(RinnovoCanone) & "," & par.IfNull(myReaderX("id"), "0") & ",'" & RinnovoNumeroPG & "','" & RinnovoDataPG & "')"
                    par.cmd.ExecuteNonQuery()
                End If
                myReaderX.Close()


                'INSERISCO IL CONTRATTO
                'Dim indice_anagrafica As String = "0"

                Dim proxBolletta As String = ""

                par.cmd.CommandText = "SELECT RAPPORTI_UTENZA.*,RAPPORTI_UTENZA_PROSSIMA_BOL.PROSSIMA_BOLLETTA FROM SISCOM_MI.RAPPORTI_UTENZA_PROSSIMA_BOL,SISCOM_MI.RAPPORTI_UTENZA WHERE RAPPORTI_UTENZA_PROSSIMA_BOL.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND ID=" & IdContratto
                myReaderX = par.cmd.ExecuteReader()
                If myReaderX.Read = True Then
                    par.cmd.CommandText = "Insert into SISCOM_MI.RAPPORTI_UTENZA    (ID, COD_CONTRATTO_GIMI, COD_CONTRATTO, COD_TIPOLOGIA_RAPP_CONTR, COD_TIPOLOGIA_CONTR_LOC," _
                                        & "DURATA_ANNI, DURATA_MESI, DURATA_GIORNI, DATA_DECORRENZA, DATA_SCADENZA,     DATA_DISDETTA_LOCATARIO, NUM_REGISTRAZIONE, SERIE_REGISTRAZIONE, " _
                                        & "IMP_CANONE_INIZIALE, IMP_DEPOSITO_CAUZ,     COD_FASCIA_REDDITO, MESSA_IN_MORA, PRATICA_AL_LEGALE, ISCRIZIONE_RUOLO, RATEIZZAZIONI_IN_CORSO,     " _
                                        & "DECADENZA, SFRATTO, NOTE, DATA_REG, COD_UFFICIO_REG,     DATA_STIPULA, DATA_CONSEGNA, DATA_SCADENZA_RINNOVO, DURATA_RINNOVO, MESI_DISDETTA,     " _
                                        & "DATA_RICONSEGNA, DELIBERA, DATA_DELIBERA, NRO_RATE, FREQ_VAR_ISTAT,     VERSAMENTO_TR, PER_BANDO, TIPO_COR, LUOGO_COR, VIA_COR,     " _
                                        & "NOTE_COR, CIVICO_COR, SIGLA_COR, CAP_COR, PRESSO_COR,     BOZZA, INTERESSI_CAUZIONE, NRO_REPERTORIO, DATA_REPERTORIO, NRO_ASSEGNAZIONE_PG,     " _
                                        & "DATA_ASSEGNAZIONE_PG, INIZIO_PERIODO, LIBRETTO_DEPOSITO, ID_DEST_RATE, INVIO_BOLLETTA,     FL_CONGUAGLIO, PERC_RINNOVO_CONTRATTO, PERC_ISTAT, " _
                                        & "IMP_CANONE_ATTUALE, PROVENIENZA_ASS,     INTERESSI_RIT_PAG, IMPORTO_ANTICIPO, ID_DOMANDA, ID_AU, ID_ISEE,     ID_COMMISSARIATO, REG_TELEMATICA, " _
                                        & "DEST_USO, DESCR_DEST_USO, DATA_INVIO_RIC_DISDETTA,MOTIVO_REC_FORZOSO, FL_STAMPATO, BOLLO, N_OFFERTA, DATA_NOTIFICA_DISDETTA,     " _
                                        & "MITTENTE_DISDETTA, DATA_CONVALIDA_SFRATTO, DATA_ESECUZIONE_SFRATTO, DATA_RINVIO_SFRATTO, DATA_CONFERMA_FP) " _
                                        & "Values   (SISCOM_MI.SEQ_RAPPORTI_UTENZA.NEXTVAL, '', '" & NuovoCodiceContratto & "', '" _
                                        & par.IfNull(myReaderX("COD_TIPOLOGIA_RAPP_CONTR"), "") & "', '" & par.IfNull(myReaderX("COD_TIPOLOGIA_CONTR_LOC"), "") _
                                        & "', " & par.IfNull(myReaderX("DURATA_ANNI"), "0") & ", " & par.IfNull(myReaderX("DURATA_MESI"), "0") _
                                        & ", NULL, '', '',  '' , NULL, NULL, " & par.VirgoleInPunti(RinnovoCanone) & ",0,  NULL, NULL, NULL, NULL, NULL,  NULL, NULL, NULL, NULL, '" _
                                        & "TNP',  '', '', '', " & par.IfNull(myReaderX("DURATA_RINNOVO"), "NULL") _
                                        & ", " & par.IfNull(myReaderX("MESI_DISDETTA"), "6") & ",     NULL, '" & RinnovoNumeroPG _
                                        & "', '" & RinnovoDataPG & "', 12, '" & par.IfNull(myReaderX("FREQ_VAR_ISTAT"), "0") _
                                        & "' ,'" & par.IfNull(myReaderX("VERSAMENTO_TR"), "NULL") & "', NULL, '" & par.IfNull(myReaderX("TIPO_COR"), "VIA") _
                                        & "', '" & par.PulisciStrSql(par.IfNull(myReaderX("LUOGO_COR"), "")) & "', '" _
                                        & par.PulisciStrSql(par.IfNull(myReaderX("VIA_COR"), "")) _
                                        & "', NULL, '" & par.PulisciStrSql(par.IfNull(myReaderX("CIVICO_COR"), "")) & "', '" _
                                        & par.PulisciStrSql(par.IfNull(myReaderX("SIGLA_COR"), "")) & "', '" _
                                        & par.PulisciStrSql(par.IfNull(myReaderX("CAP_COR"), "")) & "', '" _
                                        & par.PulisciStrSql(par.IfNull(myReaderX("PRESSO_COR"), "")) & "',     1, NULL, NULL, NULL, NULL,     NULL, '" _
                                        & par.IfNull(myReaderX("PROSSIMA_BOLLETTA"), "") & "', '" & par.IfNull(myReaderX("LIBRETTO_DEPOSITO"), "") _
                                        & "', " & par.IfNull(myReaderX("ID_DEST_RATE"), "1") & ", " & par.IfNull(myReaderX("INVIO_BOLLETTA"), "1") _
                                        & ",'" & par.IfNull(myReaderX("FL_CONGUAGLIO"), "1") & "', " & par.IfNull(myReaderX("PERC_RINNOVO_CONTRATTO"), "0") _
                                        & ", " & par.IfNull(myReaderX("PERC_ISTAT"), "0") & ", " & par.VirgoleInPunti(RinnovoCanone) _
                                        & ", " & par.IfNull(myReaderX("PROVENIENZA_ASS"), "0") & " ,     '0', 0, " & par.IfNull(myReaderX("ID_DOMANDA"), "NULL") _
                                        & ", " & par.IfNull(myReaderX("ID_AU"), "NULL") & ", " & par.IfNull(myReaderX("ID_ISEE"), "NULL") _
                                        & "," & par.IfNull(myReaderX("ID_COMMISSARIATO"), "1") & ", NULL, '" & par.IfNull(myReaderX("DEST_USO"), "N") _
                                        & "', '" & par.PulisciStrSql(par.IfNull(myReaderX("DESCR_DEST_USO"), "0")) _
                                        & "', NULL, 4, 0, NULL, 0, NULL,     -1, NULL, NULL, NULL, NULL)"
                    par.cmd.ExecuteNonQuery()

                    proxBolletta = par.IfNull(myReaderX("PROSSIMA_BOLLETTA"), "")

                End If
                myReaderX.Close()


                par.cmd.CommandText = "select siscom_mi.seq_RAPPORTI_UTENZA.currval from dual"
                Dim myReaderX2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderX2.Read Then
                    INDICE_CONTRATTO = myReaderX2(0)
                End If
                myReaderX2.Close()


                par.cmd.CommandText = "INSERT INTO SISCOM_MI.RAPPORTI_UTENZA_PROSSIMA_BOL (ID_CONTRATTO,PROSSIMA_BOLLETTA) VALUES (" & INDICE_CONTRATTO & ",'" & proxBolletta & "')"
                par.cmd.ExecuteNonQuery()


                Dim s As String
                Dim comunicazioni As String = ""
                Dim LBLNOMEFILECANONE As String = ""
                Dim fileName As String = NuovoCodiceContratto & ".txt"

                s = par.CalcolaCanone27(lIdDomanda, 3, UnitaContratto, NuovoCodiceContratto, CanoneCorrente, VAL_LOCATIVO_UNITA, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPIANO, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL, annoSitEconom)


                If comunicazioni <> "" Then
                    Response.Write("<script>alert('" & comunicazioni & "');</script>")
                End If


                Dim sr As StreamWriter = New StreamWriter(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, False, System.Text.Encoding.Default)
                sr.WriteLine(s)
                sr.Close()
                LBLNOMEFILECANONE = Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName


                If System.IO.File.Exists(LBLNOMEFILECANONE) = True Then

                    Dim sr1 As StreamReader = New StreamReader(LBLNOMEFILECANONE, System.Text.Encoding.GetEncoding("iso-8859-1"))
                    Dim contenuto As String = sr1.ReadToEnd()
                    sr1.Close()

                    'par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,ISE, ISR, ISP, PSE, VSE, REDDITI_DIP, REDDITI_ATRI, LIMITE_PENSIONI, ISEE_27, PERC_VAL_LOC, INC_MAX, CANONE,TESTO) " _
                    '                    & "VALUES (" & lIdContratto & ",'" & Format(My.Computer.FileSystem.GetFileInfo(LBLNOMEFILECANONE.Value).CreationTime, "yyyyMMddhhmmss") _
                    '                    & "'," & AreaEconomica & ",'" & sISEE & "','" & sISE & "','" & sISR & "','" & sISP & "','" & sPSE & "','" & sVSE & "','" & sREDD_DIP & "','" & sREDD_ALT & "','" & sLimitePensione & "','" & sISE_MIN & "','" & sPER_VAL_LOC & "','" & sPERC_INC_MAX_ISE_ERP & "','" & sCanone & "',:TESTO) "
                    If sNOTE = "" Then
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (CANONE_CLASSE,CANONE_SOPPORTABILE,DECADENZA_ALL_ADEGUATO,DECADENZA_VAL_ICI,CANONE_MINIMO_AREA,VALORE_LOCATIVO,SUP_ACCESSORI,MINORI_15,MAGGIORI_65,DATA_STIPULA,COD_CONTRATTO,ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,ISE, ISR, ISP, PSE, VSE, REDDITI_DIP, REDDITI_ATRI, LIMITE_PENSIONI, " _
                                            & "ISEE_27, PERC_VAL_LOC, INC_MAX, CANONE,TESTO,NOTE,ID_BANDO_AU,DEM, SUPCONVENZIONALE, COSTOBASE, ZONA, PIANO, CONSERVAZIONE, VETUSTA,INCIDENZA_ISE," _
                                            & "COEFF_NUCLEO_FAM,SOTTO_AREA,ANNOTAZIONI,PATRIMONIO_SUP,NON_RISPONDENTE,LIMITE_ISEE,ID_DICHIARAZIONE,CANONE_ATTUALE,ADEGUAMENTO,ISTAT," _
                                            & "NUM_COMP,NUM_COMP_66,NUM_COMP_100,NUM_COMP_100_CON,REDD_PREV_DIP,DETRAZIONI,REDD_MOBILIARI,REDD_IMMOBILIARI,REDD_COMPLESSIVO,DETRAZIONI_FRAGILITA,ANNO_COSTRUZIONE," _
                                            & "LOCALITA,PRESENTE_ASCENSORE,NUMERO_PIANO,SUP_NETTA,ALTRE_SUP,PERC_ISTAT_APPLICATA,CANONE_CLASSE_ISTAT,CANONE_91,INIZIO_VALIDITA_CAN,FINE_VALIDITA_CAN) " _
                                            & "VALUES ('" & sCANONECLASSE & "','" & sCANONESOPP & "','" & sALLOGGIOIDONEO & "','" & sVALOCIICI & "','" & sCANONE_MIN & "','" & sVALORELOCATIVO & "','" & par.PulisciStrSql(sSUPACCESSORI) & "'," & sMINORI15 & "," & sMAGGIORI65 & ",'','" & NuovoCodiceContratto & "'," & INDICE_CONTRATTO & ",'" & Format(Now, "yyyyMMddHHmmss") _
                                            & "'," & AreaEconomica & ",'" & sISEE & "','" & sISE & "','" & sISR & "','" & sISP & "','" & sPSE & "','" & sVSE & "','" & sREDD_DIP & "','" _
                                            & sREDD_ALT & "','" & sLimitePensione & "','" & sISE_MIN & "','" & sPER_VAL_LOC & "','" & sPERC_INC_MAX_ISE_ERP & "','" & sCanone & "',:TESTO,'" _
                                            & par.PulisciStrSql(sNOTE) & "',NULL,'" & sDEM & "','" & sSUPCONVENZIONALE & "','" & sCOSTOBASE & "','" & sZONA & "','" & sPIANO & "','" _
                                            & sCONSERVAZIONE & "','" & sVETUSTA & "','" & sINCIDENZAISE & "','" & sCOEFFFAM & "','" & sSOTTOAREA & "','" & sMOTIVODECADENZA & "'," _
                                            & "0" & ",0," & "0" & "," & "null" _
                                            & ",'" & "0" & "','" & "0" & "','" _
                                            & "0" & "'," & sNUMCOMP & "," & sNUMCOMP66 & "," & sNUMCOMP100 & "," & sNUMCOMP100C & "," & sPREVDIP _
                                            & ",'" & sDETRAZIONI & "','" & sMOBILIARI & "','" & sIMMOBILIARI & "','" & sCOMPLESSIVO & "','" & sDETRAZIONEF & "','" & sANNOCOSTRUZIONE & "','" & par.PulisciStrSql(sLOCALITA) _
                                            & "','" & sASCENSORE & "','" & par.PulisciStrSql(sDESCRIZIONEPIANO) & "','" & sSUPNETTA & "','" & par.PulisciStrSql(sALTRESUP) & "','" & sISTAT & "','" & sCANONECLASSEISTAT & "','0','" & sANNOINIZIOVAL & "','" & sANNOFINEVAL & "') "
                    Else
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (CANONE_CLASSE,CANONE_SOPPORTABILE,DECADENZA_ALL_ADEGUATO,DECADENZA_VAL_ICI,CANONE_MINIMO_AREA,VALORE_LOCATIVO,SUP_ACCESSORI,MINORI_15,MAGGIORI_65,DATA_STIPULA,COD_CONTRATTO,ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,ISE, ISR, ISP, PSE, VSE, REDDITI_DIP, REDDITI_ATRI," _
                                            & "LIMITE_PENSIONI, ISEE_27, PERC_VAL_LOC, INC_MAX, CANONE,TESTO,NOTE,ID_BANDO_AU,ANNOTAZIONI,PATRIMONIO_SUP,NON_RISPONDENTE,LIMITE_ISEE,ID_DICHIARAZIONE," _
                                            & "CANONE_ATTUALE,ADEGUAMENTO,ISTAT,NUM_COMP,NUM_COMP_66,NUM_COMP_100,NUM_COMP_100_CON,REDD_PREV_DIP,DETRAZIONI,REDD_MOBILIARI,REDD_IMMOBILIARI," _
                                            & "REDD_COMPLESSIVO,DETRAZIONI_FRAGILITA,ANNO_COSTRUZIONE,LOCALITA,PRESENTE_ASCENSORE,NUMERO_PIANO,SUP_NETTA,ALTRE_SUP,PERC_ISTAT_APPLICATA,CANONE_CLASSE_ISTAT,CANONE_91,INIZIO_VALIDITA_CAN,FINE_VALIDITA_CAN) " _
                                            & "VALUES ('" & sCANONECLASSE & "','" & sCANONESOPP & "','" & sALLOGGIOIDONEO & "','" & sVALOCIICI & "','" & sCANONE_MIN & "','" & sVALORELOCATIVO & "','" & par.PulisciStrSql(sSUPACCESSORI) & "'," & sMINORI15 & "," & sMAGGIORI65 & ",'','" & NuovoCodiceContratto & "'," & INDICE_CONTRATTO & ",'" & Format(Now, "yyyyMMddHHmmss") & "',NULL,'','','','','','','','','','','','','',:TESTO,'" & _
                                            par.PulisciStrSql(sNOTE) & "',NULL,'" & sMOTIVODECADENZA & "',0,0,0," _
                                            & "null" & ",'0','0" _
                                            & "','0'," & sNUMCOMP & "," & sNUMCOMP66 & "," & sNUMCOMP100 & "," & sNUMCOMP100C & "," & sPREVDIP _
                                            & ",'" & sDETRAZIONI & "','" & sMOBILIARI & "','" & sIMMOBILIARI & "','" & sCOMPLESSIVO & "','" & sDETRAZIONEF & "','" & sANNOCOSTRUZIONE & "','" _
                                            & par.PulisciStrSql(sLOCALITA) & "','" & sASCENSORE & "','" & par.PulisciStrSql(sDESCRIZIONEPIANO) & "','" & sSUPNETTA & "','" & par.PulisciStrSql(sALTRESUP) & "','" & sISTAT & "','" & sCANONECLASSEISTAT & "','0','" & sANNOINIZIOVAL & "','" & sANNOFINEVAL & "') "

                    End If

                    Dim objStream As Stream = File.Open(LBLNOMEFILECANONE, FileMode.Open)
                    Dim buffer(objStream.Length) As Byte
                    objStream.Read(buffer, 0, objStream.Length)
                    objStream.Close()

                    Dim parmData As New Oracle.DataAccess.Client.OracleParameter
                    With parmData
                        .Direction = Data.ParameterDirection.Input
                        .OracleDbType = Oracle.DataAccess.Client.OracleDbType.Blob
                        .ParameterName = "TESTO"
                        .Value = buffer
                    End With

                    par.cmd.Parameters.Add(parmData)
                    par.cmd.ExecuteNonQuery()
                    System.IO.File.Delete(LBLNOMEFILECANONE)
                    par.cmd.Parameters.Remove(parmData)

                    buffer = Nothing
                    objStream = Nothing
                End If

                Dim CAUZIONE As Double = 0
                CAUZIONE = Format(Format((CanoneCorrente / 12), "0.00") * 3, "0.00")

                par.cmd.CommandText = "update siscom_mi.rapporti_utenza set imp_canone_iniziale=" & par.VirgoleInPunti(CanoneCorrente) & ",IMP_DEPOSITO_CAUZ=" & par.VirgoleInPunti(CAUZIONE) & " WHERE ID=" & INDICE_CONTRATTO
                par.cmd.ExecuteNonQuery()

                'If aggiornamento_istat <> 0 Then
                '    par.cmd.CommandText = "INSERT INTO SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE VALUES (" & INDICE_CONTRATTO & ",'" & Format(Now, "yyyyMMdd") & "',2," & par.VirgoleInPunti(aggiornamento_istat) & ",'DOMANDA CAMBIO INTESTAZIONE')"
                '    par.cmd.ExecuteNonQuery()
                'End If
                'par.cmd.CommandText = "select * FROM siscom_mi.CANONI_EC WHERE ID_CONTRATTO=" & IdContratto & " ORDER BY DATA_CALCOLO DESC"
                'myReaderX = par.cmd.ExecuteReader()
                'If myReaderX.Read Then
                '    par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC SELECT " & INDICE_CONTRATTO & ", DATA_CALCOLO, TESTO, " _
                '    & "ID_AREA_ECONOMICA, ISEE, ISE, " _
                '    & "ISR, ISP, PSE, " _
                '    & "VSE, REDDITI_DIP, REDDITI_ATRI, " _
                '    & "LIMITE_PENSIONI, ISEE_27, PERC_VAL_LOC, " _
                '    & "INC_MAX, INCIDENZA_ISE, CANONE, " _
                '    & "ID_BANDO_AU, NOTE, DEM, " _
                '    & "SUPCONVENZIONALE, COSTOBASE, ZONA," _
                '    & "PIANO, CONSERVAZIONE, VETUSTA," _
                '    & "COEFF_NUCLEO_FAM, SOTTO_AREA, ANNOTAZIONI, " _
                '    & "PATRIMONIO_SUP, NON_RISPONDENTE, LIMITE_ISEE, " _
                '    & "ID_DICHIARAZIONE, CANONE_ATTUALE, ADEGUAMENTO, " _
                '    & "ISTAT, NUM_COMP, NUM_COMP_66, " _
                '    & "NUM_COMP_100, NUM_COMP_100_CON, REDD_PREV_DIP, " _
                '    & "DETRAZIONI, DETRAZIONI_FRAGILITA, REDD_MOBILIARI," _
                '    & "REDD_IMMOBILIARI, REDD_COMPLESSIVO, ANNO_COSTRUZIONE, " _
                '    & "LOCALITA, NUMERO_PIANO, PRESENTE_ASCENSORE, " _
                '    & "SUP_NETTA, ALTRE_SUP, COD_CONTRATTO, " _
                '    & "DATA_STIPULA, MINORI_15, MAGGIORI_65," _
                '    & "SUP_ACCESSORI, VALORE_LOCATIVO, CANONE_MINIMO_AREA, " _
                '    & "DECADENZA_ALL_ADEGUATO, DECADENZA_VAL_ICI, CANONE_CLASSE, " _
                '    & "CANONE_SOPPORTABILE, PERC_ISTAT_APPLICATA, CANONE_CLASSE_ISTAT, " _
                '    & "CANONE_91, INIZIO_VALIDITA_CAN, FINE_VALIDITA_CAN FROM SISCOM_MI.CANONI_EC WHERE ID_CONTRATTO=" & IdContratto & " ORDER BY DATA_CALCOLO DESC"
                '    par.cmd.ExecuteNonQuery()
                'End If

                'myReaderX.Close()



                If CodFis <> "-1" Then
                    'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & IdContratto
                    'myReaderX = par.cmd.ExecuteReader()
                    'If myReaderX.Read = True Then
                    par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET TIPO_COR='" & par.IfNull(dt1.Rows(0).Item("TIPO_COR"), "VIA") _
                                        & "',LUOGO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("LUOGO_COR"), "")) _
                                        & "',VIA_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("VIA_COR"), "")) _
                                        & "',CIVICO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("CIVICO_COR"), "")) _
                                        & "',SIGLA_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("SIGLA_COR"), "")) _
                                        & "',CAP_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("CAP_COR"), "")) _
                                        & "',PRESSO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("PRESSO_COR"), "")) _
                                        & "' WHERE ID=" & INDICE_CONTRATTO
                    par.cmd.ExecuteNonQuery()
                    'End If
                End If

                If CodFis = "-1" Then
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & IdContratto & " AND COD_TIPOLOGIA_OCCUPANTE<>'INTE' and NVL(data_fine,'29991231') >= '" & Format(Now(), "yyyyMMdd") & "'"
                    myReaderX = par.cmd.ExecuteReader()
                    Do While myReaderX.Read
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                                            & par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                                            & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                        par.cmd.ExecuteNonQuery()

                        'If par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") = "INTE" Then
                        '    indice_anagrafica = par.IfNull(myReaderX("ID_ANAGRAFICA"), "0")
                        'End If
                    Loop
                    myReaderX.Close()
                Else
                    '******** NEL NUOVO CONTRATTO NON RIPORTO L'INTESTATARIO DEL CONTRATTO 24/10/2012 ********
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & IdContratto & " AND COD_TIPOLOGIA_OCCUPANTE<>'INTE' and NVL(data_fine,'29991231') >= '" & Format(Now(), "yyyyMMdd") & "'"
                    myReaderX = par.cmd.ExecuteReader()
                    Do While myReaderX.Read
                        If par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") = IdAnagRichiedente Then
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                            & IdAnagRichiedente & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                            & "','INTE','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                            'ElseIf par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") = "INTE" Then
                            '    par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                            '    & par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                            '    & "','VOLT','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                        Else
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                            & par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                            & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                        End If
                        par.cmd.ExecuteNonQuery()

                        'If par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") = "INTE" Then
                        '    indice_anagrafica = par.IfNull(myReaderX("ID_ANAGRAFICA"), "0")
                        'End If

                        'If par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") = IdAnagRichiedente Then
                        '    par.cmd.CommandText = "UPDATE SISCOM_MI.SOGGETTI_CONTRATTUALI " _
                        '        & " SET ID_ANAGRAFICA=" & IdAnagRichiedente & ",ID_CONTRATTO=" & INDICE_CONTRATTO & ",COD_TIPOLOGIA_PARENTELA='" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") & "'," _
                        '        & "COD_TIPOLOGIA_OCCUPANTE='INTE',COD_TIPOLOGIA_TITOLO='" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "' WHERE ID_ANAGRAFICA=" & IdAnagRichiedente
                        '    par.cmd.ExecuteNonQuery()
                        'End If
                    Loop
                    myReaderX.Close()

                End If



                par.cmd.CommandText = "INSERT INTO SISCOM_MI.UNITA_CONTRATTUALE (SELECT " _
                    & INDICE_CONTRATTO & ", ID_UNITA, COD_UNITA_IMMOBILIARE," _
                    & " TIPOLOGIA, ID_EDIFICIO, SCALA," _
                    & " COD_TIPO_LIVELLO_PIANO, INTERNO, ID_UNITA_PRINCIPALE," _
                    & " SEZIONE, FOGLIO, NUMERO," _
                    & " SUB, COD_TIPOLOGIA_CATASTO, RENDITA," _
                    & " COD_CATEGORIA_CATASTALE, COD_CLASSE_CATASTALE, COD_QUALITA_CATASTALE," _
                    & " SUPERFICIE_MQ, CUBATURA, NUM_VANI," _
                    & " SUPERFICIE_CATASTALE, RENDITA_STORICA, IMMOBILE_STORICO," _
                    & " REDDITO_DOMINICALE, VALORE_IMPONIBILE, REDDITO_AGRARIO," _
                    & " VALORE_BILANCIO, DATA_ACQUISIZIONE, DATA_FINE_VALIDITA," _
                    & " DITTA, NUM_PARTITA, ESENTE_ICI," _
                    & " PERC_POSSESSO, INAGIBILE, MICROZONA_CENSUARIA," _
                    & " ZONA_CENSUARIA, COD_STATO_CATASTALE, INDIRIZZO," _
                    & " CIVICO, CAP, LOCALITA," _
                    & " COD_COMUNE, SUP_CONVENZIONALE, VAL_LOCATIVO_UNITA" _
                    & " FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & IdContratto & ")"
                par.cmd.ExecuteNonQuery()


                par.cmd.CommandText = "INSERT INTO SISCOM_MI.INTESTATARI_RAPPORTO (ID_CONTRATTO,ID_ANAGRAFICA,DATA_INIZIO,DATA_FINE) VALUES (" & INDICE_CONTRATTO & "," & IdAnagRichiedente & ",'" & RinnovoDataPG & "','29991231')"
                par.cmd.ExecuteNonQuery()

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                & "VALUES (" & INDICE_CONTRATTO & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                & "'F01','')"
                par.cmd.ExecuteNonQuery()




                txtModificato.Value = "0"
                'Tab_Contratto1.DisabilitaTutto()

                'Response.Write("<script>alert('Operazione Effettuata! La bolletta di fine rapporto è stata regolarmente creata.\nOra sarai reindirizzato sul nuovo rapporto (" & NuovoCodiceContratto & ") !');</script>")

                sNuovoCodiceRapporto = NuovoCodiceContratto
                lNuovoIdRapporto = INDICE_CONTRATTO
                nuovoCodContr.Value = NuovoCodiceContratto

                '*************evento per voltura
                par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                                & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                                & "','F165','','')"
                par.cmd.ExecuteNonQuery()
                CType(Dom_Decisioni1.FindControl("autorizzFinale"), HiddenField).Value = 1


                ''''************* 30/07/2012 INSERIMENTO AVVISO PER CONDOMINI ********


                par.cmd.CommandText = "SELECT cond_edifici.* FROM SISCOM_MI.COND_EDIFICI,SISCOM_MI.EDIFICI,SISCOM_MI.UNITA_IMMOBILIARI WHERE UNITA_IMMOBILIARI.ID=" & IdUI & " AND EDIFICI.ID=UNITA_IMMOBILIARI.ID_EDIFICIO AND COND_EDIFICI.ID_EDIFICIO=EDIFICI.ID"
                Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                Do While myReader.Read
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.COND_AVVISI (ID_TIPO,ID_UI,DATA,VISTO,ID_CONDOMINIO,ID_CONTRATTO) VALUES (2," & IdUI & ",'" & Format(Now, "yyyyMMdd") & "',0," & myReader("ID_CONDOMINIO") & "," & IdContratto & ")"
                    par.cmd.ExecuteNonQuery()
                Loop
                myReader.Close()
                '''************* 30/07/2012 FINE SCRITTURA EVENTO PER CONDOMINI ********


                par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET PRESSO_COR='" & par.PulisciStrSql(CognomeNome) & "',TIPO_COR='" & TipoIndir & "'," _
                & "LUOGO_COR='" & LuogoRec & "',VIA_COR='" & Indirizzo & "',CIVICO_COR='" & Civico & "',CAP_COR='" & Cap & "' WHERE ID=" & INDICE_CONTRATTO
                par.cmd.ExecuteNonQuery()


                'Response.Write("<script>popupWindow = window.open('../Contratti/Contratto.aspx?ID=" & lNuovoIdRapporto & "&COD=" & sNuovoCodiceRapporto & "', '" & sNuovoCodiceRapporto & "', 'height=700,width=900');</script>")


                'Generale1.Provenienza = TipoContratto
                'Generale1.IndiceDichiarazione = lIdDichiarazione
                'Generale1.IndiceDomanda = lIdDomandaERP
                'Generale1.IndiceAnagrafe = lIdAU
            End If

        Catch ex As Exception
            errore = True
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../../Errore.aspx';</script>")
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try
    End Function

    Private Sub CreaNuovoContrattoERP(ByVal CodFis As String)
        Try

            Dim DESTINAZIONE As String = ""

            Dim Risoluzione As Boolean = False
            Dim importoRisoluzione As Double = 0
            Dim IMPORTOINTERESSI As Double = 0
            Dim sAggiunta As String = ""
            Dim DataCalcolo As String = ""
            Dim DataInizio As String = ""

            Dim tasso As Double = 0
            Dim baseCalcolo As Double = 0

            Dim Giorni As Integer = 0
            Dim GiorniAnno As Integer = 0
            Dim dataPartenza As String = ""

            Dim Totale As Double = 0
            Dim TotalePeriodo As Double = 0
            Dim indice As Long = 0
            Dim DataFine As String = ""
            Dim num_bolletta As String = ""
            Dim importobolletta As Double = 0
            Dim I As Integer = 0

            Dim importodanni As Double = 0
            Dim importotrasporto As Double = 0

            Dim Interessi As New SortedDictionary(Of Integer, Double)

            Dim RIASSUNTO_BOLLETTA As String = ""
            Dim lIdConnessione As String = ""

            '-----------06/12/2011
            Dim IdContratto As String = ""
            Dim sNuovoCodiceRapporto As String = ""
            Dim lNuovoIdRapporto As String = ""
            Dim UnitaContratto As Long

            Dim RinnovoDataChiusura As String = ""
            Dim RinnovoDataPG As String = ""
            Dim RinnovoNumeroPG As String = ""
            Dim RinnovoCanone As String = ""
            Dim FaiCambioBox As String = "1"
            Dim CFNuovoIntest As String = ""
            Dim IdUI As Long = 0
            Dim CognomeNome As String = ""
            Dim TipoIndir As String = ""
            Dim Indirizzo As String = ""
            Dim Civico As String = ""
            Dim LuogoRec As String = ""
            Dim Sigla As String = ""
            Dim Cap As String = ""
            'Dim data_riconsegna As String = ""
            '-----------fine 06/12/2011

            data_riconsegna.Value = par.AggiustaData(Date.Parse(par.FormattaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text), New System.Globalization.CultureInfo("it-IT", False)).AddDays(-1).ToString("dd/MM/yyyy"))

            '-----------06/12/2011
            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            Dim da1 As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            Dim dt1 As New Data.DataTable
            da1.Fill(dt1)
            IdContratto = dt1.Rows(0).Item("id")

            RinnovoCanone = dt1.Rows(0).Item("IMP_CANONE_INIZIALE")
            RinnovoDataChiusura = par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text)

            Dim aggiornamento_istat As Double = 0
            Dim AltriAdeguamenti As Double = 0

            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo=2 and ID_CONTRATTO=" & IdContratto
            Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If lettore.Read Then
                aggiornamento_istat = par.IfNull(lettore(0), 0)
            End If
            lettore.Close()

            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo<>2 and ID_CONTRATTO=" & IdContratto
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                AltriAdeguamenti = par.IfNull(lettore(0), 0)
            End If
            lettore.Close()

            par.cmd.CommandText = "SELECT ID_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE COD_UNITA_IMMOBILIARE='" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "' AND ID_UNITA_PRINCIPALE IS NULL"
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                UnitaContratto = par.IfNull(lettore("ID_UNITA"), "")
            End If
            lettore.Close()

            par.cmd.CommandText = "SELECT * FROM DICHIARAZIONI_VSA,COMP_NUCLEO_VSA WHERE DICHIARAZIONI_VSA.ID = COMP_NUCLEO_VSA.ID_DICHIARAZIONE AND DICHIARAZIONI_VSA.ID=" & lIdDichiarazione & " AND PROGR=0"
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                RinnovoDataPG = par.IfNull(lettore("DATA_PG"), "")
                RinnovoNumeroPG = par.IfNull(lettore("PG"), "")
                CFNuovoIntest = par.IfNull(lettore("COD_FISCALE"), "")

                CognomeNome = Trim(par.IfNull(lettore("COGNOME"), "")) & " " & Trim(par.IfNull(lettore("NOME"), ""))

                par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE ID='" & par.IfNull(lettore("ID_LUOGO_RES_DNTE"), "") & "'"
                Dim myReaderIDluogoRES As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderIDluogoRES.Read Then
                    Sigla = par.IfNull(myReaderIDluogoRES("SIGLA"), "")
                    LuogoRec = par.PulisciStrSql(par.IfNull(myReaderIDluogoRES("NOME"), ""))
                End If
                myReaderIDluogoRES.Close()

                par.cmd.CommandText = "SELECT * FROM T_TIPO_INDIRIZZO WHERE COD='" & par.IfNull(lettore("ID_TIPO_IND_RES_DNTE"), "") & "'"
                Dim myReaderTipoIndir As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderTipoIndir.Read Then
                    TipoIndir = par.IfNull(myReaderTipoIndir("DESCRIZIONE"), "")
                End If
                myReaderTipoIndir.Close()

                Indirizzo = par.PulisciStrSql(par.IfNull(lettore("IND_RES_DNTE"), ""))
                Civico = par.PulisciStrSql(par.IfNull(lettore("CIVICO_RES_DNTE"), ""))
                Cap = par.IfNull(lettore("CAP_RES_DNTE"), "")
            End If
            lettore.Close()
            '-----------fine 06/12/2011


            If data_riconsegna.Value <> "" Then

                Dim IdAnagRichiedente As String = ""
                par.cmd.CommandText = "SELECT ID FROM SISCOM_MI.ANAGRAFICA WHERE id = (SELECT NVL(ID_INTEST_NEW_RU,0) FROM DOMANDE_BANDO_VSA WHERE ID = " & lIdDomanda & ")"
                Dim myReaderIdA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
                If myReaderIdA.Read Then
                    IdAnagRichiedente = myReaderIdA("id")
                End If
                myReaderIdA.Close()

                par.cmd.CommandText = "SELECT id_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & IdContratto
                Dim myReaderUI As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderUI.Read Then
                    IdUI = myReaderUI("id_UNITA")
                End If
                myReaderUI.Close()


                'If CodFis = "-1" Then
                '    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                '        & "VALUES (" & IdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                '        & "'F102','')"
                'Else
                '    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                '        & "VALUES (" & IdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                '        & "'F103','')"
                'End If
                'par.cmd.ExecuteNonQuery()

                Dim progressivo As Integer
                par.cmd.CommandText = "select MAX(TO_NUMBER(TRANSLATE(SUBSTR(cod_contratto,18,2),'A','0'))) from SISCOM_MI.rapporti_utenza,siscom_mi.unita_contrattuale,siscom_mi.unita_immobiliari where id_unita=" & IdUI & " and rapporti_utenza.id=unita_contrattuale.id_contratto and unita_contrattuale.id_unita=siscom_mi.unita_immobiliari.id"
                Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader1.Read Then
                    progressivo = par.IfNull(myReader1(0), 0) + 1
                Else
                    progressivo = 1
                End If
                myReader1.Close()
                Dim NuovoCodiceContratto As String = Mid(CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text, 1, 17) & Format((progressivo), "00")

                Dim nome As String = ""
                Dim Cognome As String = ""
                Dim CF As String = ""

                If CodFis = "-1" Then
                    par.cmd.CommandText = "select anagrafica.* from siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND soggetti_contrattuali.id_CONTRATTO=" & IdContratto
                Else
                    par.cmd.CommandText = "select anagrafica.* from siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND anagrafica.cod_fiscale='" & UCase(par.PulisciStrSql(CodFis)) & "'"
                End If


                Dim myReaderX As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()

                If myReaderX.Read = True Then
                    If par.IfNull(myReaderX("ragione_sociale"), "") = "" Then
                        Cognome = par.IfNull(myReaderX("cognome"), "")
                        nome = par.IfNull(myReaderX("nome"), "")
                    Else
                        Cognome = par.IfNull(myReaderX("ragione_sociale"), "")
                        nome = ""
                    End If
                    If par.IfNull(myReaderX("partita_iva"), "") = "" Then
                        CF = par.IfNull(myReaderX("cod_fiscale"), "")
                    Else
                        CF = par.IfNull(myReaderX("partita_iva"), "")
                    End If



                    par.cmd.CommandText = "Insert into siscom_mi.UNITA_ASSEGNATE (ID_DOMANDA, ID_UNITA, DATA_ASSEGNAZIONE, " _
                                        & "GENERATO_CONTRATTO, ID_DICHIARAZIONE, COGNOME_RS, NOME, CF_PIVA, PROVENIENZA, N_OFFERTA,CANONE,ID_ANAGRAFICA,PROVVEDIMENTO,DATA_PROVVEDIMENTO) " _
                                        & " Values " _
                                        & "(-1, " & UnitaContratto & ", '" & RinnovoDataPG & "', 1, " & lIdDichiarazione & ", " _
                                        & "'" & par.PulisciStrSql(Cognome) & "', '" & par.PulisciStrSql(nome) _
                                        & "', '" & par.PulisciStrSql(CF) & "', 'U', 0," & par.VirgoleInPunti(RinnovoCanone) & "," & par.IfNull(myReaderX("id"), "0") & ",'" & RinnovoNumeroPG & "','" & RinnovoDataPG & "')"
                    par.cmd.ExecuteNonQuery()
                End If
                myReaderX.Close()

                Dim proxBolletta As String = ""
                Dim numRegistr As String = ""
                Dim serieReistr As String = ""
                Dim dataRegistr As String = ""
                par.cmd.CommandText = "SELECT RAPPORTI_UTENZA.*,RAPPORTI_UTENZA_PROSSIMA_BOL.PROSSIMA_BOLLETTA FROM SISCOM_MI.RAPPORTI_UTENZA_PROSSIMA_BOL,SISCOM_MI.RAPPORTI_UTENZA WHERE RAPPORTI_UTENZA_PROSSIMA_BOL.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND ID=" & IdContratto
                myReaderX = par.cmd.ExecuteReader()
                If myReaderX.Read = True Then
                    If fl_import_registr.Value = "1" Then
                        numRegistr = par.IfNull(myReaderX("NUM_REGISTRAZIONE"), "")
                        serieReistr = par.IfNull(myReaderX("SERIE_REGISTRAZIONE"), "")
                        dataRegistr = par.IfNull(myReaderX("DATA_REG"), "")
                    End If

                    par.cmd.CommandText = "Insert into SISCOM_MI.RAPPORTI_UTENZA    (ID, COD_CONTRATTO_GIMI, COD_CONTRATTO, COD_TIPOLOGIA_RAPP_CONTR, COD_TIPOLOGIA_CONTR_LOC," _
                                        & "DURATA_ANNI, DURATA_MESI, DURATA_GIORNI, DATA_DECORRENZA, DATA_SCADENZA,     DATA_DISDETTA_LOCATARIO, NUM_REGISTRAZIONE, SERIE_REGISTRAZIONE, " _
                                        & "IMP_CANONE_INIZIALE, IMP_DEPOSITO_CAUZ,     COD_FASCIA_REDDITO, MESSA_IN_MORA, PRATICA_AL_LEGALE, ISCRIZIONE_RUOLO, RATEIZZAZIONI_IN_CORSO,     " _
                                        & "DECADENZA, SFRATTO, NOTE, DATA_REG, COD_UFFICIO_REG,     DATA_STIPULA, DATA_CONSEGNA, DATA_SCADENZA_RINNOVO, DURATA_RINNOVO, MESI_DISDETTA,     " _
                                        & "DATA_RICONSEGNA, DELIBERA, DATA_DELIBERA, NRO_RATE, FREQ_VAR_ISTAT,     VERSAMENTO_TR, PER_BANDO, TIPO_COR, LUOGO_COR, VIA_COR,     " _
                                        & "NOTE_COR, CIVICO_COR, SIGLA_COR, CAP_COR, PRESSO_COR,     BOZZA, INTERESSI_CAUZIONE, NRO_REPERTORIO, DATA_REPERTORIO, NRO_ASSEGNAZIONE_PG,     " _
                                        & "DATA_ASSEGNAZIONE_PG, INIZIO_PERIODO, LIBRETTO_DEPOSITO, ID_DEST_RATE, INVIO_BOLLETTA,     FL_CONGUAGLIO, PERC_RINNOVO_CONTRATTO, PERC_ISTAT, " _
                                        & "IMP_CANONE_ATTUALE, PROVENIENZA_ASS,     INTERESSI_RIT_PAG, IMPORTO_ANTICIPO, ID_DOMANDA, ID_AU, ID_ISEE,     ID_COMMISSARIATO, REG_TELEMATICA, " _
                                        & "DEST_USO, DESCR_DEST_USO, DATA_INVIO_RIC_DISDETTA,MOTIVO_REC_FORZOSO, FL_STAMPATO, BOLLO, N_OFFERTA, DATA_NOTIFICA_DISDETTA,     " _
                                        & "MITTENTE_DISDETTA, DATA_CONVALIDA_SFRATTO, DATA_ESECUZIONE_SFRATTO, DATA_RINVIO_SFRATTO, DATA_CONFERMA_FP) " _
                                        & "Values   (SISCOM_MI.SEQ_RAPPORTI_UTENZA.NEXTVAL, '', '" & NuovoCodiceContratto & "', '" _
                                        & "LEGIT', 'ERP'" _
                                        & ", 4, " & par.IfNull(myReaderX("DURATA_MESI"), "0") _
                                        & ", NULL, '" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text) & "', '',  '' , '" & numRegistr & "', '" & serieReistr & "', " & par.VirgoleInPunti(RinnovoCanone) & ",0,  NULL, NULL, NULL, NULL, NULL,  NULL, NULL, NULL, '" & dataRegistr & "', '" _
                                        & "" & par.IfNull(myReaderX("COD_UFFICIO_REG"), "TNP") & "',  '" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text) & "', '', '', 4" _
                                        & ", " & par.IfNull(myReaderX("MESI_DISDETTA"), "6") & ",     NULL, '" & RinnovoNumeroPG _
                                        & "', '" & RinnovoDataPG & "', 12, '" & par.IfNull(myReaderX("FREQ_VAR_ISTAT"), "0") _
                                        & "' ,'" & par.IfNull(myReaderX("VERSAMENTO_TR"), "NULL") & "', NULL, '" & par.IfNull(myReaderX("TIPO_COR"), "VIA") _
                                        & "', '" & par.PulisciStrSql(par.IfNull(myReaderX("LUOGO_COR"), "")) & "', '" _
                                        & par.PulisciStrSql(par.IfNull(myReaderX("VIA_COR"), "")) _
                                        & "', NULL, '" & par.PulisciStrSql(par.IfNull(myReaderX("CIVICO_COR"), "")) & "', '" _
                                        & par.PulisciStrSql(par.IfNull(myReaderX("SIGLA_COR"), "")) & "', '" _
                                        & par.PulisciStrSql(par.IfNull(myReaderX("CAP_COR"), "")) & "', '" _
                                        & par.PulisciStrSql(par.IfNull(myReaderX("PRESSO_COR"), "")) & "',     1, NULL, NULL, NULL, NULL,     NULL, '" _
                                        & par.IfNull(myReaderX("PROSSIMA_BOLLETTA"), "") & "', '" & par.IfNull(myReaderX("LIBRETTO_DEPOSITO"), "") _
                                        & "', " & par.IfNull(myReaderX("ID_DEST_RATE"), "1") & ", " & par.IfNull(myReaderX("INVIO_BOLLETTA"), "1") _
                                        & ",'" & par.IfNull(myReaderX("FL_CONGUAGLIO"), "1") & "', " & par.IfNull(myReaderX("PERC_RINNOVO_CONTRATTO"), "0") _
                                        & ", " & par.IfNull(myReaderX("PERC_ISTAT"), "0") & ", " & par.VirgoleInPunti(RinnovoCanone) _
                                        & ", 1 ,     '0', 0, " & par.IfNull(myReaderX("ID_DOMANDA"), "NULL") _
                                        & ", " & par.IfNull(myReaderX("ID_AU"), "NULL") & ", " & par.IfNull(myReaderX("ID_ISEE"), "NULL") _
                                        & "," & par.IfNull(myReaderX("ID_COMMISSARIATO"), "1") & ", NULL, '" & par.IfNull(myReaderX("DEST_USO"), "N") _
                                        & "', '" & par.PulisciStrSql(par.IfNull(myReaderX("DESCR_DEST_USO"), "0")) _
                                        & "', NULL, 4, 0, NULL, 0, NULL,     -1, NULL, NULL, NULL, NULL)"
                    par.cmd.ExecuteNonQuery()

                    proxBolletta = par.IfNull(myReaderX("PROSSIMA_BOLLETTA"), "")

                End If
                myReaderX.Close()


                par.cmd.CommandText = "select siscom_mi.seq_RAPPORTI_UTENZA.currval from dual"
                Dim myReaderX2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderX2.Read Then
                    INDICE_CONTRATTO = myReaderX2(0)
                End If
                myReaderX2.Close()


                par.cmd.CommandText = "INSERT INTO SISCOM_MI.RAPPORTI_UTENZA_PROSSIMA_BOL (ID_CONTRATTO,PROSSIMA_BOLLETTA) VALUES (" & INDICE_CONTRATTO & ",'" & proxBolletta & "')"
                par.cmd.ExecuteNonQuery()


                Dim s As String
                Dim comunicazioni As String = ""
                Dim LBLNOMEFILECANONE As String = ""
                Dim fileName As String = NuovoCodiceContratto & ".txt"

                s = par.CalcolaCanone27(lIdDomanda, 3, UnitaContratto, NuovoCodiceContratto, CanoneCorrente, VAL_LOCATIVO_UNITA, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPIANO, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL, annoSitEconom)
                If comunicazioni <> "" Then
                    Response.Write("<script>alert('" & comunicazioni & "');</script>")
                End If

                Dim sr As StreamWriter = New StreamWriter(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, False, System.Text.Encoding.Default)
                sr.WriteLine(s)
                sr.Close()
                LBLNOMEFILECANONE = Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName


                If System.IO.File.Exists(LBLNOMEFILECANONE) = True Then

                    Dim sr1 As StreamReader = New StreamReader(LBLNOMEFILECANONE, System.Text.Encoding.GetEncoding("iso-8859-1"))
                    Dim contenuto As String = sr1.ReadToEnd()
                    sr1.Close()

                    If sNOTE = "" Then
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (CANONE_CLASSE,CANONE_SOPPORTABILE,DECADENZA_ALL_ADEGUATO,DECADENZA_VAL_ICI,CANONE_MINIMO_AREA,VALORE_LOCATIVO,SUP_ACCESSORI,MINORI_15,MAGGIORI_65,DATA_STIPULA,COD_CONTRATTO,ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,ISE, ISR, ISP, PSE, VSE, REDDITI_DIP, REDDITI_ATRI, LIMITE_PENSIONI, " _
                                            & "ISEE_27, PERC_VAL_LOC, INC_MAX, CANONE,TESTO,NOTE,ID_BANDO_AU,DEM, SUPCONVENZIONALE, COSTOBASE, ZONA, PIANO, CONSERVAZIONE, VETUSTA,INCIDENZA_ISE," _
                                            & "COEFF_NUCLEO_FAM,SOTTO_AREA,ANNOTAZIONI,PATRIMONIO_SUP,NON_RISPONDENTE,LIMITE_ISEE,ID_DICHIARAZIONE,CANONE_ATTUALE,ADEGUAMENTO,ISTAT," _
                                            & "NUM_COMP,NUM_COMP_66,NUM_COMP_100,NUM_COMP_100_CON,REDD_PREV_DIP,DETRAZIONI,REDD_MOBILIARI,REDD_IMMOBILIARI,REDD_COMPLESSIVO,DETRAZIONI_FRAGILITA,ANNO_COSTRUZIONE," _
                                            & "LOCALITA,PRESENTE_ASCENSORE,NUMERO_PIANO,SUP_NETTA,ALTRE_SUP,PERC_ISTAT_APPLICATA,CANONE_CLASSE_ISTAT,CANONE_91,INIZIO_VALIDITA_CAN,FINE_VALIDITA_CAN) " _
                                            & "VALUES ('" & sCANONECLASSE & "','" & sCANONESOPP & "','" & sALLOGGIOIDONEO & "','" & sVALOCIICI & "','" & sCANONE_MIN & "','" & sVALORELOCATIVO & "','" & par.PulisciStrSql(sSUPACCESSORI) & "'," & sMINORI15 & "," & sMAGGIORI65 & ",'','" & NuovoCodiceContratto & "'," & INDICE_CONTRATTO & ",'" & Format(Now, "yyyyMMddHHmmss") _
                                            & "'," & AreaEconomica & ",'" & sISEE & "','" & sISE & "','" & sISR & "','" & sISP & "','" & sPSE & "','" & sVSE & "','" & sREDD_DIP & "','" _
                                            & sREDD_ALT & "','" & sLimitePensione & "','" & sISE_MIN & "','" & sPER_VAL_LOC & "','" & sPERC_INC_MAX_ISE_ERP & "','" & sCanone & "',:TESTO,'" _
                                            & par.PulisciStrSql(sNOTE) & "',NULL,'" & sDEM & "','" & sSUPCONVENZIONALE & "','" & sCOSTOBASE & "','" & sZONA & "','" & sPIANO & "','" _
                                            & sCONSERVAZIONE & "','" & sVETUSTA & "','" & sINCIDENZAISE & "','" & sCOEFFFAM & "','" & sSOTTOAREA & "','" & sMOTIVODECADENZA & "'," _
                                            & "0" & ",0," & "0" & "," & "null" _
                                            & ",'" & "0" & "','" & "0" & "','" _
                                            & "0" & "'," & sNUMCOMP & "," & sNUMCOMP66 & "," & sNUMCOMP100 & "," & sNUMCOMP100C & "," & sPREVDIP _
                                            & ",'" & sDETRAZIONI & "','" & sMOBILIARI & "','" & sIMMOBILIARI & "','" & sCOMPLESSIVO & "','" & sDETRAZIONEF & "','" & sANNOCOSTRUZIONE & "','" & par.PulisciStrSql(sLOCALITA) _
                                            & "','" & sASCENSORE & "','" & par.PulisciStrSql(sDESCRIZIONEPIANO) & "','" & sSUPNETTA & "','" & par.PulisciStrSql(sALTRESUP) & "','" & sISTAT & "','" & sCANONECLASSEISTAT & "','0','" & sANNOINIZIOVAL & "','" & sANNOFINEVAL & "') "
                    Else
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (CANONE_CLASSE,CANONE_SOPPORTABILE,DECADENZA_ALL_ADEGUATO,DECADENZA_VAL_ICI,CANONE_MINIMO_AREA,VALORE_LOCATIVO,SUP_ACCESSORI,MINORI_15,MAGGIORI_65,DATA_STIPULA,COD_CONTRATTO,ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,ISE, ISR, ISP, PSE, VSE, REDDITI_DIP, REDDITI_ATRI," _
                                            & "LIMITE_PENSIONI, ISEE_27, PERC_VAL_LOC, INC_MAX, CANONE,TESTO,NOTE,ID_BANDO_AU,ANNOTAZIONI,PATRIMONIO_SUP,NON_RISPONDENTE,LIMITE_ISEE,ID_DICHIARAZIONE," _
                                            & "CANONE_ATTUALE,ADEGUAMENTO,ISTAT,NUM_COMP,NUM_COMP_66,NUM_COMP_100,NUM_COMP_100_CON,REDD_PREV_DIP,DETRAZIONI,REDD_MOBILIARI,REDD_IMMOBILIARI," _
                                            & "REDD_COMPLESSIVO,DETRAZIONI_FRAGILITA,ANNO_COSTRUZIONE,LOCALITA,PRESENTE_ASCENSORE,NUMERO_PIANO,SUP_NETTA,ALTRE_SUP,PERC_ISTAT_APPLICATA,CANONE_CLASSE_ISTAT,CANONE_91,INIZIO_VALIDITA_CAN,FINE_VALIDITA_CAN) " _
                                            & "VALUES ('" & sCANONECLASSE & "','" & sCANONESOPP & "','" & sALLOGGIOIDONEO & "','" & sVALOCIICI & "','" & sCANONE_MIN & "','" & sVALORELOCATIVO & "','" & par.PulisciStrSql(sSUPACCESSORI) & "'," & sMINORI15 & "," & sMAGGIORI65 & ",'','" & NuovoCodiceContratto & "'," & INDICE_CONTRATTO & ",'" & Format(Now, "yyyyMMddHHmmss") & "',NULL,'','','','','','','','','','','','','',:TESTO,'" & _
                                            par.PulisciStrSql(sNOTE) & "',NULL,'" & sMOTIVODECADENZA & "',0,0,0," _
                                            & "null" & ",'0','0" _
                                            & "','0'," & sNUMCOMP & "," & sNUMCOMP66 & "," & sNUMCOMP100 & "," & sNUMCOMP100C & "," & sPREVDIP _
                                            & ",'" & sDETRAZIONI & "','" & sMOBILIARI & "','" & sIMMOBILIARI & "','" & sCOMPLESSIVO & "','" & sDETRAZIONEF & "','" & sANNOCOSTRUZIONE & "','" _
                                            & par.PulisciStrSql(sLOCALITA) & "','" & sASCENSORE & "','" & par.PulisciStrSql(sDESCRIZIONEPIANO) & "','" & sSUPNETTA & "','" & par.PulisciStrSql(sALTRESUP) & "','" & sISTAT & "','" & sCANONECLASSEISTAT & "','0','" & sANNOINIZIOVAL & "','" & sANNOFINEVAL & "') "

                    End If

                    Dim objStream As Stream = File.Open(LBLNOMEFILECANONE, FileMode.Open)
                    Dim buffer(objStream.Length) As Byte
                    objStream.Read(buffer, 0, objStream.Length)
                    objStream.Close()

                    Dim parmData As New Oracle.DataAccess.Client.OracleParameter
                    With parmData
                        .Direction = Data.ParameterDirection.Input
                        .OracleDbType = Oracle.DataAccess.Client.OracleDbType.Blob
                        .ParameterName = "TESTO"
                        .Value = buffer
                    End With

                    par.cmd.Parameters.Add(parmData)
                    par.cmd.ExecuteNonQuery()
                    System.IO.File.Delete(LBLNOMEFILECANONE)
                    par.cmd.Parameters.Remove(parmData)

                    buffer = Nothing
                    objStream = Nothing
                End If

                Dim CAUZIONE As Double = 0
                CAUZIONE = Format(Format((CanoneCorrente / 12), "0.00") * 3, "0.00")

                par.cmd.CommandText = "update siscom_mi.rapporti_utenza set imp_canone_iniziale=" & par.VirgoleInPunti(CanoneCorrente) & ",IMP_DEPOSITO_CAUZ=" & par.VirgoleInPunti(CAUZIONE) & " WHERE ID=" & INDICE_CONTRATTO
                par.cmd.ExecuteNonQuery()


                If CodFis <> "-1" Then
                    par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET TIPO_COR='" & par.IfNull(dt1.Rows(0).Item("TIPO_COR"), "VIA") _
                                        & "',LUOGO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("LUOGO_COR"), "")) _
                                        & "',VIA_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("VIA_COR"), "")) _
                                        & "',CIVICO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("CIVICO_COR"), "")) _
                                        & "',SIGLA_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("SIGLA_COR"), "")) _
                                        & "',CAP_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("CAP_COR"), "")) _
                                        & "',PRESSO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("PRESSO_COR"), "")) _
                                        & "' WHERE ID=" & INDICE_CONTRATTO
                    par.cmd.ExecuteNonQuery()
                End If

                If CodFis = "-1" Then
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & IdContratto & " AND COD_TIPOLOGIA_OCCUPANTE<>'INTE' and NVL(data_fine,'29991231') >= '" & Format(Now(), "yyyyMMdd") & "'"
                    myReaderX = par.cmd.ExecuteReader()
                    Do While myReaderX.Read
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                                            & par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                                            & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                        par.cmd.ExecuteNonQuery()
                    Loop
                    myReaderX.Close()
                Else
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & IdContratto & " and NVL(data_fine,'29991231') >= '" & Format(Now(), "yyyyMMdd") & "'"
                    myReaderX = par.cmd.ExecuteReader()
                    Do While myReaderX.Read
                        If par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") = IdAnagRichiedente Then
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                            & IdAnagRichiedente & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                            & "','INTE','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                        Else
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                            & par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                            & "','ALTR','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                        End If
                        par.cmd.ExecuteNonQuery()

                    Loop
                    myReaderX.Close()
                End If



                par.cmd.CommandText = "INSERT INTO SISCOM_MI.UNITA_CONTRATTUALE (SELECT " _
                    & INDICE_CONTRATTO & ", ID_UNITA, COD_UNITA_IMMOBILIARE," _
                    & " TIPOLOGIA, ID_EDIFICIO, SCALA," _
                    & " COD_TIPO_LIVELLO_PIANO, INTERNO, ID_UNITA_PRINCIPALE," _
                    & " SEZIONE, FOGLIO, NUMERO," _
                    & " SUB, COD_TIPOLOGIA_CATASTO, RENDITA," _
                    & " COD_CATEGORIA_CATASTALE, COD_CLASSE_CATASTALE, COD_QUALITA_CATASTALE," _
                    & " SUPERFICIE_MQ, CUBATURA, NUM_VANI," _
                    & " SUPERFICIE_CATASTALE, RENDITA_STORICA, IMMOBILE_STORICO," _
                    & " REDDITO_DOMINICALE, VALORE_IMPONIBILE, REDDITO_AGRARIO," _
                    & " VALORE_BILANCIO, DATA_ACQUISIZIONE, DATA_FINE_VALIDITA," _
                    & " DITTA, NUM_PARTITA, ESENTE_ICI," _
                    & " PERC_POSSESSO, INAGIBILE, MICROZONA_CENSUARIA," _
                    & " ZONA_CENSUARIA, COD_STATO_CATASTALE, INDIRIZZO," _
                    & " CIVICO, CAP, LOCALITA," _
                    & " COD_COMUNE, SUP_CONVENZIONALE, VAL_LOCATIVO_UNITA" _
                    & " FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & IdContratto & ")"
                par.cmd.ExecuteNonQuery()


                par.cmd.CommandText = "INSERT INTO SISCOM_MI.INTESTATARI_RAPPORTO (ID_CONTRATTO,ID_ANAGRAFICA,DATA_INIZIO,DATA_FINE) VALUES (" & INDICE_CONTRATTO & "," & IdAnagRichiedente & ",'" & RinnovoDataPG & "','29991231')"
                par.cmd.ExecuteNonQuery()

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                & "VALUES (" & INDICE_CONTRATTO & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                & "'F01','CAMBIO TIPOLOGIA CONTRATTUALE (vecchia posizione cod. " & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & ")')"
                par.cmd.ExecuteNonQuery()

                txtModificato.Value = "0"

                sNuovoCodiceRapporto = NuovoCodiceContratto
                lNuovoIdRapporto = INDICE_CONTRATTO
                nuovoCodContr.Value = NuovoCodiceContratto

                '*************evento per voltura
                par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                                & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                                & "','F165','','')"
                par.cmd.ExecuteNonQuery()
                CType(Dom_Decisioni1.FindControl("autorizzFinale"), HiddenField).Value = 1


                ''''************* 30/07/2012 INSERIMENTO AVVISO PER CONDOMINI ********


                par.cmd.CommandText = "SELECT cond_edifici.* FROM SISCOM_MI.COND_EDIFICI,SISCOM_MI.EDIFICI,SISCOM_MI.UNITA_IMMOBILIARI WHERE UNITA_IMMOBILIARI.ID=" & IdUI & " AND EDIFICI.ID=UNITA_IMMOBILIARI.ID_EDIFICIO AND COND_EDIFICI.ID_EDIFICIO=EDIFICI.ID"
                Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                Do While myReader.Read
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.COND_AVVISI (ID_TIPO,ID_UI,DATA,VISTO,ID_CONDOMINIO,ID_CONTRATTO) VALUES (2," & IdUI & ",'" & Format(Now, "yyyyMMdd") & "',0," & myReader("ID_CONDOMINIO") & "," & IdContratto & ")"
                    par.cmd.ExecuteNonQuery()
                Loop
                myReader.Close()
                '''************* 30/07/2012 FINE SCRITTURA EVENTO PER CONDOMINI ********


                par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET PRESSO_COR='" & par.PulisciStrSql(CognomeNome) & "',TIPO_COR='" & TipoIndir & "'," _
                & "LUOGO_COR='" & LuogoRec & "',VIA_COR='" & Indirizzo & "',CIVICO_COR='" & Civico & "',CAP_COR='" & Cap & "' WHERE ID=" & INDICE_CONTRATTO
                par.cmd.ExecuteNonQuery()

            End If

        Catch ex As Exception
            errore = True
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../../Errore.aspx';</script>")
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try
    End Sub
    Private Sub CreazBozzaPosAbus(ByVal CodFis As String)
        Try
            Dim DESTINAZIONE As String = ""

            Dim Risoluzione As Boolean = False
            Dim importoRisoluzione As Double = 0
            Dim IMPORTOINTERESSI As Double = 0
            Dim sAggiunta As String = ""
            Dim DataCalcolo As String = ""
            Dim DataInizio As String = ""

            Dim tasso As Double = 0
            Dim baseCalcolo As Double = 0

            Dim Giorni As Integer = 0
            Dim GiorniAnno As Integer = 0
            Dim dataPartenza As String = ""

            Dim Totale As Double = 0
            Dim TotalePeriodo As Double = 0
            Dim indice As Long = 0
            Dim DataFine As String = ""
            Dim num_bolletta As String = ""
            Dim importobolletta As Double = 0
            Dim I As Integer = 0

            Dim importodanni As Double = 0
            Dim importotrasporto As Double = 0

            Dim Interessi As New SortedDictionary(Of Integer, Double)

            Dim RIASSUNTO_BOLLETTA As String = ""
            Dim lIdConnessione As String = ""

            Dim IdContratto As String = ""
            Dim sNuovoCodiceRapporto As String = ""
            Dim lNuovoIdRapporto As String = ""
            Dim UnitaContratto As Long

            Dim RinnovoDataChiusura As String = ""
            Dim RinnovoDataPG As String = ""
            Dim RinnovoNumeroPG As String = ""
            Dim RinnovoCanone As Long = 0
            Dim FaiCambioBox As String = "1"
            Dim CFNuovoIntest As String = ""
            Dim IdUI As Long = 0
            Dim CognomeNome As String = ""
            Dim TipoIndir As String = ""
            Dim Indirizzo As String = ""
            Dim Civico As String = ""
            Dim LuogoRec As String = ""
            Dim Sigla As String = ""
            Dim Cap As String = ""
            Dim tipo_occup As String = ""


            Dim importo As Double = 0
            Dim testo As String = ""
            Dim comunicazioni As String = ""
            Dim LOCATIVO As String = ""



            data_riconsegna.Value = par.AggiustaData(Date.Parse(par.FormattaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text), New System.Globalization.CultureInfo("it-IT", False)).AddDays(-1).ToString("dd/MM/yyyy"))

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            Dim da1 As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            Dim dt1 As New Data.DataTable
            da1.Fill(dt1)
            IdContratto = dt1.Rows(0).Item("id")

            'RinnovoCanone = dt1.Rows(0).Item("IMP_CANONE_INIZIALE")
            RinnovoDataChiusura = par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text)

            Dim aggiornamento_istat As Double = 0
            Dim AltriAdeguamenti As Double = 0

            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo=2 and ID_CONTRATTO=" & IdContratto
            Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If lettore.Read Then
                aggiornamento_istat = par.IfNull(lettore(0), 0)
            End If
            lettore.Close()

            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo<>2 and ID_CONTRATTO=" & IdContratto
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                AltriAdeguamenti = par.IfNull(lettore(0), 0)
            End If
            lettore.Close()

            par.cmd.CommandText = "SELECT ID_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE COD_UNITA_IMMOBILIARE='" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "' AND ID_UNITA_PRINCIPALE IS NULL"
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                UnitaContratto = par.IfNull(lettore("ID_UNITA"), "")
            End If
            lettore.Close()

            par.cmd.CommandText = "SELECT * FROM DICHIARAZIONI_VSA,COMP_NUCLEO_VSA WHERE DICHIARAZIONI_VSA.ID = COMP_NUCLEO_VSA.ID_DICHIARAZIONE AND DICHIARAZIONI_VSA.ID=" & lIdDichiarazione & " AND PROGR=0"
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                RinnovoDataPG = par.IfNull(lettore("DATA_PG"), "")
                RinnovoNumeroPG = par.IfNull(lettore("PG"), "")
                CFNuovoIntest = par.IfNull(lettore("COD_FISCALE"), "")

                CognomeNome = Trim(par.IfNull(lettore("COGNOME"), "")) & " " & Trim(par.IfNull(lettore("NOME"), ""))

                par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE ID='" & par.IfNull(lettore("ID_LUOGO_RES_DNTE"), "") & "'"
                Dim myReaderIDluogoRES As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderIDluogoRES.Read Then
                    Sigla = par.IfNull(myReaderIDluogoRES("SIGLA"), "")
                    LuogoRec = par.PulisciStrSql(par.IfNull(myReaderIDluogoRES("NOME"), ""))
                End If
                myReaderIDluogoRES.Close()

                par.cmd.CommandText = "SELECT * FROM T_TIPO_INDIRIZZO WHERE COD='" & par.IfNull(lettore("ID_TIPO_IND_RES_DNTE"), "") & "'"
                Dim myReaderTipoIndir As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderTipoIndir.Read Then
                    TipoIndir = par.IfNull(myReaderTipoIndir("DESCRIZIONE"), "")
                End If
                myReaderTipoIndir.Close()

                Indirizzo = par.PulisciStrSql(par.IfNull(lettore("IND_RES_DNTE"), ""))
                Civico = par.PulisciStrSql(par.IfNull(lettore("CIVICO_RES_DNTE"), ""))
                Cap = par.IfNull(lettore("CAP_RES_DNTE"), "")
            End If
            lettore.Close()



            If data_riconsegna.Value <> "" Then

                Dim IdAnagRichiedente As String = ""
                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.ANAGRAFICA WHERE COD_FISCALE = (SELECT COD_FISCALE FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND PROGR = 0) ORDER BY ID DESC"
                Dim myReaderIdA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
                If myReaderIdA.Read Then
                    IdAnagRichiedente = myReaderIdA("id")
                End If
                myReaderIdA.Close()

                par.cmd.CommandText = "SELECT id_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & IdContratto
                Dim myReaderUI As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderUI.Read Then
                    IdUI = myReaderUI("id_UNITA")
                End If
                myReaderUI.Close()


                If CodFis = "-1" Then
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                        & "VALUES (" & IdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                        & "'F102','')"
                Else
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                        & "VALUES (" & IdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                        & "'F228','')"
                End If
                par.cmd.ExecuteNonQuery()

                Dim progressivo As Integer
                'par.cmd.CommandText = "select MAX(TO_NUMBER(TRANSLATE(SUBSTR(cod_contratto,18,2),'A','0'))) from SISCOM_MI.rapporti_utenza where id=" & IdContratto
                par.cmd.CommandText = "select MAX(TO_NUMBER(TRANSLATE(SUBSTR(cod_contratto,18,2),'A','0'))) from SISCOM_MI.rapporti_utenza,siscom_mi.unita_contrattuale,siscom_mi.unita_immobiliari where id_unita=" & IdUI & " and rapporti_utenza.id=unita_contrattuale.id_contratto and unita_contrattuale.id_unita=siscom_mi.unita_immobiliari.id"
                Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader1.Read Then
                    progressivo = par.IfNull(myReader1(0), 0) + 1
                Else
                    progressivo = 1
                End If
                myReader1.Close()
                Dim NuovoCodiceContratto As String = Mid(CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text, 1, 17) & Format((progressivo), "00")
                nuovoCodContr.Value = NuovoCodiceContratto
                Dim nome As String = ""
                Dim Cognome As String = ""
                Dim CF As String = ""

                If CodFis = "-1" Then
                    par.cmd.CommandText = "select anagrafica.* from siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND soggetti_contrattuali.id_CONTRATTO=" & IdContratto
                Else
                    par.cmd.CommandText = "select anagrafica.* from siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND anagrafica.cod_fiscale='" & UCase(par.PulisciStrSql(CodFis)) & "'"
                End If


                Dim myReaderX As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()

                If myReaderX.Read = True Then
                    If par.IfNull(myReaderX("ragione_sociale"), "") = "" Then
                        Cognome = par.IfNull(myReaderX("cognome"), "")
                        nome = par.IfNull(myReaderX("nome"), "")
                    Else
                        Cognome = par.IfNull(myReaderX("ragione_sociale"), "")
                        nome = ""
                    End If
                    If par.IfNull(myReaderX("partita_iva"), "") = "" Then
                        CF = par.IfNull(myReaderX("cod_fiscale"), "")
                    Else
                        CF = par.IfNull(myReaderX("partita_iva"), "")
                    End If


                    par.cmd.CommandText = "Insert into siscom_mi.UNITA_ASSEGNATE (ID_DOMANDA, ID_UNITA, DATA_ASSEGNAZIONE, " _
                                        & "GENERATO_CONTRATTO, ID_DICHIARAZIONE, COGNOME_RS, NOME, CF_PIVA, PROVENIENZA, N_OFFERTA,CANONE,ID_ANAGRAFICA,PROVVEDIMENTO,DATA_PROVVEDIMENTO) " _
                                        & " Values " _
                                        & "(-1, " & UnitaContratto & ", '" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text) & "', 1, -1, " _
                                        & "'" & par.PulisciStrSql(Cognome) & "', '" & par.PulisciStrSql(nome) _
                                        & "', '" & par.PulisciStrSql(CF) & "', 'X', 0," & par.VirgoleInPunti(RinnovoCanone) & "," & par.IfNull(myReaderX("id"), "0") & ",'ABUSIVO','" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text) & "')"
                    par.cmd.ExecuteNonQuery()
                End If
                myReaderX.Close()

                Dim proxBolletta As String = ""

                par.cmd.CommandText = "SELECT RAPPORTI_UTENZA.*,RAPPORTI_UTENZA_PROSSIMA_BOL.PROSSIMA_BOLLETTA FROM SISCOM_MI.RAPPORTI_UTENZA_PROSSIMA_BOL,SISCOM_MI.RAPPORTI_UTENZA WHERE RAPPORTI_UTENZA_PROSSIMA_BOL.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND ID=" & IdContratto
                myReaderX = par.cmd.ExecuteReader()
                If myReaderX.Read = True Then

                    par.cmd.CommandText = "Insert into SISCOM_MI.RAPPORTI_UTENZA    (ID, COD_CONTRATTO_GIMI, COD_CONTRATTO, COD_TIPOLOGIA_RAPP_CONTR, COD_TIPOLOGIA_CONTR_LOC," _
                                   & "DURATA_ANNI, DATA_DECORRENZA, DATA_SCADENZA,     DATA_DISDETTA_LOCATARIO, NUM_REGISTRAZIONE, SERIE_REGISTRAZIONE, " _
                                   & "IMP_CANONE_INIZIALE, IMP_DEPOSITO_CAUZ,     COD_FASCIA_REDDITO, MESSA_IN_MORA, PRATICA_AL_LEGALE, ISCRIZIONE_RUOLO, RATEIZZAZIONI_IN_CORSO,     " _
                                   & "DECADENZA, SFRATTO, NOTE, DATA_REG, COD_UFFICIO_REG,     DATA_STIPULA, DATA_CONSEGNA, DATA_SCADENZA_RINNOVO, DURATA_RINNOVO, MESI_DISDETTA,     " _
                                   & "DATA_RICONSEGNA, DELIBERA, DATA_DELIBERA, NRO_RATE, FREQ_VAR_ISTAT,     VERSAMENTO_TR, PER_BANDO, TIPO_COR, LUOGO_COR, VIA_COR,     " _
                                   & "NOTE_COR, CIVICO_COR, SIGLA_COR, CAP_COR, PRESSO_COR,     BOZZA, INTERESSI_CAUZIONE, NRO_REPERTORIO, DATA_REPERTORIO, NRO_ASSEGNAZIONE_PG,     " _
                                   & "DATA_ASSEGNAZIONE_PG, ID_DEST_RATE, INVIO_BOLLETTA,     FL_CONGUAGLIO, PERC_ISTAT, " _
                                   & "IMP_CANONE_ATTUALE, PROVENIENZA_ASS,     INTERESSI_RIT_PAG, IMPORTO_ANTICIPO, ID_DOMANDA, ID_ISEE,     ID_COMMISSARIATO, REG_TELEMATICA, " _
                                   & "DEST_USO, DESCR_DEST_USO, DATA_INVIO_RIC_DISDETTA, FL_STAMPATO, BOLLO, N_OFFERTA, DATA_NOTIFICA_DISDETTA,     " _
                                   & "MITTENTE_DISDETTA, DATA_CONVALIDA_SFRATTO, DATA_ESECUZIONE_SFRATTO, DATA_RINVIO_SFRATTO, DATA_CONFERMA_FP, ID_DOMANDA_ABUS) " _
                                   & "Values   (SISCOM_MI.SEQ_RAPPORTI_UTENZA.NEXTVAL, '', '" & NuovoCodiceContratto & "', '" _
                                   & "ILLEG', 'NONE" _
                                   & "', 4" _
                                   & ",  '" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text) & "', '',  '' , NULL, NULL, 0, 0,  NULL, NULL, NULL, NULL, NULL,  NULL, NULL, NULL, NULL, '" _
                                   & "-1',  '" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text) & "', '" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text) & "', '', 4" _
                                   & ", NULL,     NULL, 'ABUSIVO" _
                                   & "', '" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text) & "', 12, 'A" _
                                   & "' ,'A', 1, '" & par.IfNull(myReaderX("TIPO_COR"), "VIA") _
                                   & "', '" & par.PulisciStrSql(par.IfNull(myReaderX("LUOGO_COR"), "")) & "', '" _
                                   & par.PulisciStrSql(par.IfNull(myReaderX("VIA_COR"), "")) _
                                   & "', NULL, '" & par.PulisciStrSql(par.IfNull(myReaderX("CIVICO_COR"), "")) & "', '" _
                                   & par.PulisciStrSql(par.IfNull(myReaderX("SIGLA_COR"), "")) & "', '" _
                                   & par.PulisciStrSql(par.IfNull(myReaderX("CAP_COR"), "")) & "', '" _
                                   & par.PulisciStrSql(par.IfNull(myReaderX("PRESSO_COR"), "")) & "',     1, 1, NULL, NULL, NULL,     NULL" _
                                   & ", 1, 1" _
                                   & ",'1'" _
                                   & ", 75, 0" _
                                   & ", 7,     '1', 0, " & par.IfNull(myReaderX("ID_DOMANDA"), "NULL") _
                                   & ", " & par.IfNull(myReaderX("ID_ISEE"), "NULL") _
                                   & "," & par.IfNull(myReaderX("ID_COMMISSARIATO"), "1") & ", NULL, '" & par.IfNull(myReaderX("DEST_USO"), "N") _
                                   & "', '" & par.PulisciStrSql(par.IfNull(myReaderX("DESCR_DEST_USO"), "0")) _
                                   & "', NULL, 0, NULL, 0, NULL,     -1, NULL, NULL, NULL, NULL, " & lIdDomanda & ")"
                    par.cmd.ExecuteNonQuery()

                    proxBolletta = par.IfNull(myReaderX("PROSSIMA_BOLLETTA"), "")
                End If
                myReaderX.Close()


                par.cmd.CommandText = "select siscom_mi.seq_RAPPORTI_UTENZA.currval from dual"
                Dim myReaderX2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderX2.Read Then
                    INDICE_CONTRATTO = myReaderX2(0)
                End If
                myReaderX2.Close()


                'par.cmd.CommandText = "INSERT INTO SISCOM_MI.RAPPORTI_UTENZA_PROSSIMA_BOL (ID_CONTRATTO,PROSSIMA_BOLLETTA) VALUES (" & INDICE_CONTRATTO & ",'" & proxBolletta & "')"
                'par.cmd.ExecuteNonQuery()

                'Dim CAUZIONE As Double = 0
                'CAUZIONE = Format(Format((CanoneCorrente / 12), "0.00") * 3, "0.00")

                testo = par.CalcolaCanone27Abusivi(-1, -1, CLng(UnitaContratto), "", importo, LOCATIVO, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPIANO, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL)

                If comunicazioni <> "" Then
                    'mettere avviso errore calcolo canone
                End If

                Dim fileName As String = NuovoCodiceContratto & ".txt"
                Dim sr As StreamWriter = New StreamWriter(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, False, System.Text.Encoding.Default)
                sr.WriteLine(testo)
                sr.Close()

                par.cmd.CommandText = "update siscom_mi.rapporti_utenza set imp_canone_iniziale=" & par.VirgoleInPunti(importo) & " WHERE ID=" & INDICE_CONTRATTO
                par.cmd.ExecuteNonQuery()

                If CodFis <> "-1" Then
                    par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET TIPO_COR='" & par.IfNull(dt1.Rows(0).Item("TIPO_COR"), "VIA") _
                                        & "',LUOGO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("LUOGO_COR"), "")) _
                                        & "',VIA_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("VIA_COR"), "")) _
                                        & "',CIVICO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("CIVICO_COR"), "")) _
                                        & "',SIGLA_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("SIGLA_COR"), "")) _
                                        & "',CAP_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("CAP_COR"), "")) _
                                        & "',PRESSO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("PRESSO_COR"), "")) _
                                        & "' WHERE ID=" & INDICE_CONTRATTO
                    par.cmd.ExecuteNonQuery()
                End If

                If CodFis = "-1" Then
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & IdContratto & " AND COD_TIPOLOGIA_OCCUPANTE<>'INTE' and NVL(data_fine,'29991231') >= '" & Format(Now(), "yyyyMMdd") & "'"
                    myReaderX = par.cmd.ExecuteReader()
                    Do While myReaderX.Read
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                                            & par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                                            & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                        par.cmd.ExecuteNonQuery()
                    Loop
                    myReaderX.Close()
                Else
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & IdContratto & " and NVL(data_fine,'29991231') >= '" & Format(Now(), "yyyyMMdd") & "'"
                    myReaderX = par.cmd.ExecuteReader()
                    Do While myReaderX.Read
                        If par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") = IdAnagRichiedente Then
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                            & IdAnagRichiedente & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                            & "','INTE','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                        Else
                            If par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") = "INTE" Then
                                tipo_occup = "ALTR"
                            Else
                                tipo_occup = par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "")

                            End If
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                            & par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                            & "','" & tipo_occup & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                        End If

                        par.cmd.ExecuteNonQuery()
                    Loop
                    myReaderX.Close()
                End If

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (CANONE_CLASSE,CANONE_SOPPORTABILE,DECADENZA_ALL_ADEGUATO,DECADENZA_VAL_ICI,CANONE_MINIMO_AREA,VALORE_LOCATIVO,SUP_ACCESSORI,MINORI_15,MAGGIORI_65,DATA_STIPULA,COD_CONTRATTO,ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,ISE, ISR, ISP, PSE, VSE, REDDITI_DIP, REDDITI_ATRI, LIMITE_PENSIONI, " _
                    & "ISEE_27, PERC_VAL_LOC, INC_MAX, CANONE,TESTO,NOTE,ID_BANDO_AU,DEM, SUPCONVENZIONALE, COSTOBASE, ZONA, PIANO, CONSERVAZIONE, VETUSTA,INCIDENZA_ISE," _
                    & "COEFF_NUCLEO_FAM,SOTTO_AREA,ANNOTAZIONI,PATRIMONIO_SUP,NON_RISPONDENTE,LIMITE_ISEE,ID_DICHIARAZIONE,CANONE_ATTUALE,ADEGUAMENTO,ISTAT," _
                    & "NUM_COMP,NUM_COMP_66,NUM_COMP_100,NUM_COMP_100_CON,REDD_PREV_DIP,DETRAZIONI,REDD_MOBILIARI,REDD_IMMOBILIARI,REDD_COMPLESSIVO,DETRAZIONI_FRAGILITA,ANNO_COSTRUZIONE," _
                    & "LOCALITA,PRESENTE_ASCENSORE,NUMERO_PIANO,SUP_NETTA,ALTRE_SUP,PERC_ISTAT_APPLICATA,CANONE_CLASSE_ISTAT,CANONE_91,INIZIO_VALIDITA_CAN,FINE_VALIDITA_CAN) " _
                    & "VALUES ('" & sCANONECLASSE & "','" & sCANONESOPP & "','" & sALLOGGIOIDONEO & "','" & sVALOCIICI & "','" & sCANONE_MIN & "','" & sVALORELOCATIVO & "','" & par.PulisciStrSql(sSUPACCESSORI) & "'," & sMINORI15 & "," & sMAGGIORI65 & ",'" & Format(Now(), "yyyyMMdd") & "','" & NuovoCodiceContratto & "'," & INDICE_CONTRATTO & ",'" & Format(Now, "yyyyMMddHHmmss") _
                    & "'," & AreaEconomica & ",'" & sISEE & "','" & sISE & "','" & sISR & "','" & sISP & "','" & sPSE & "','" & sVSE & "','" & sREDD_DIP & "','" _
                    & sREDD_ALT & "','" & sLimitePensione & "','" & sISE_MIN & "','" & sPER_VAL_LOC & "','" & sPERC_INC_MAX_ISE_ERP & "','" & sCanone & "',:TESTO,'" _
                    & par.PulisciStrSql(sNOTE) & "',NULL,'" & sDEM & "','" & sSUPCONVENZIONALE & "','" & sCOSTOBASE & "','" & sZONA & "','" & sPIANO & "','" _
                    & sCONSERVAZIONE & "','" & sVETUSTA & "','" & sINCIDENZAISE & "','" & sCOEFFFAM & "','" & sSOTTOAREA & "','" & sMOTIVODECADENZA & "'," _
                    & "0" & ",0," & "0" & "," & "null" _
                    & ",'" & "0" & "','" & "0" & "','" _
                    & "0" & "'," & sNUMCOMP & "," & sNUMCOMP66 & "," & sNUMCOMP100 & "," & sNUMCOMP100C & "," & sPREVDIP _
                    & ",'" & sDETRAZIONI & "','" & sMOBILIARI & "','" & sIMMOBILIARI & "','" & sCOMPLESSIVO & "','" & sDETRAZIONEF & "','" & sANNOCOSTRUZIONE & "','" & par.PulisciStrSql(sLOCALITA) _
                    & "','" & sASCENSORE & "','" & par.PulisciStrSql(sDESCRIZIONEPIANO) & "','" & sSUPNETTA & "','" & par.PulisciStrSql(sALTRESUP) & "','" & sISTAT & "','" & sCANONECLASSEISTAT & "','0','" & sANNOINIZIOVAL & "','" & sANNOFINEVAL & "') "

                Dim objStream As Stream = File.Open(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, FileMode.Open)
                Dim buffer(objStream.Length) As Byte
                objStream.Read(buffer, 0, objStream.Length)
                objStream.Close()

                Dim parmData As New Oracle.DataAccess.Client.OracleParameter
                With parmData
                    .Direction = Data.ParameterDirection.Input
                    .OracleDbType = Oracle.DataAccess.Client.OracleDbType.Blob
                    .ParameterName = "TESTO"
                    .Value = buffer
                End With

                par.cmd.Parameters.Add(parmData)
                par.cmd.ExecuteNonQuery()
                System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName)
                par.cmd.Parameters.Remove(parmData)

                buffer = Nothing
                objStream = Nothing

                Dim idAnagrAltroComp As String = ""
                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & INDICE_CONTRATTO & " and COD_TIPOLOGIA_OCCUPANTE='INTE'"
                myReaderX = par.cmd.ExecuteReader()
                If myReaderX.Read = False Then

                    'Controllo presenza altro componente inserito
                    par.cmd.CommandText = "SELECT COMP_NUCLEO_VSA.ID,id_dichiarazione,cod_fiscale,cognome,nome,sesso,data_nascita,perc_inval,indennita_acc,grado_parentela," _
                                    & "DICHIARAZIONI_VSA.id_luogo_res_dnte,DICHIARAZIONI_VSA.id_tipo_ind_res_dnte,DICHIARAZIONI_VSA.ind_res_dnte,DICHIARAZIONI_VSA.civico_res_dnte,DICHIARAZIONI_VSA.cap_res_dnte " _
                                    & "FROM COMP_NUCLEO_VSA,DICHIARAZIONI_VSA " _
                                    & "WHERE " _
                                    & "DICHIARAZIONI_VSA.ID=COMP_NUCLEO_VSA.id_dichiarazione and progr<>0 " _
                                    & "AND id_dichiarazione = " & lIdDichiarazione
                    Dim da As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
                    Dim dt As New Data.DataTable
                    da.Fill(dt)
                    For Each row As Data.DataRow In dt.Rows
                        par.cmd.CommandText = "select id from siscom_mi.anagrafica where cod_fiscale = '" & par.IfNull(row.Item("COD_FISCALE"), "") & "'"
                        Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader

                        If myReader.Read Then
                            idAnagrAltroComp = par.IfNull(myReader("ID"), "")
                        End If
                        myReader.Close()

                        If idAnagrAltroComp = "" Then
                            idAnagrAltroComp = InserInAnagrafica(row)
                        End If
                    Next

                    par.cmd.CommandText = "SELECT T_TIPO_PARENTELA.*,COMP_NUCLEO_VSA.PROGR FROM COMP_NUCLEO_VSA,T_TIPO_PARENTELA WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " AND COMP_NUCLEO_VSA.GRADO_PARENTELA=T_TIPO_PARENTELA.COD ORDER BY PROGR ASC"
                    Dim myReaderABUS As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    Do While myReaderABUS.Read
                        If par.IfNull(myReaderABUS("PROGR"), "0") = "0" Then
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                              & IdAnagRichiedente & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderABUS("COD_SISCOM_MI"), "") _
                              & "','INTE','LEGIT')"
                            par.cmd.ExecuteNonQuery()

                            par.cmd.CommandText = "DELETE FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & INDICE_CONTRATTO & " AND COD_TIPOLOGIA_OCCUPANTE<>'INTE'"
                            par.cmd.ExecuteNonQuery()
                        Else
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                              & idAnagrAltroComp & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderABUS("COD_SISCOM_MI"), "") _
                              & "','ALTR','LEGIT')"
                            par.cmd.ExecuteNonQuery()
                        End If


                    Loop
                    myReaderABUS.Close()
                End If
                myReaderX.Close()

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.UNITA_CONTRATTUALE (SELECT " _
                      & INDICE_CONTRATTO & ", ID_UNITA, COD_UNITA_IMMOBILIARE," _
                      & " TIPOLOGIA, ID_EDIFICIO, SCALA," _
                      & " COD_TIPO_LIVELLO_PIANO, INTERNO, ID_UNITA_PRINCIPALE," _
                      & " SEZIONE, FOGLIO, NUMERO," _
                      & " SUB, COD_TIPOLOGIA_CATASTO, RENDITA," _
                      & " COD_CATEGORIA_CATASTALE, COD_CLASSE_CATASTALE, COD_QUALITA_CATASTALE," _
                      & " SUPERFICIE_MQ, CUBATURA, NUM_VANI," _
                      & " SUPERFICIE_CATASTALE, RENDITA_STORICA, IMMOBILE_STORICO," _
                      & " REDDITO_DOMINICALE, VALORE_IMPONIBILE, REDDITO_AGRARIO," _
                      & " VALORE_BILANCIO, DATA_ACQUISIZIONE, DATA_FINE_VALIDITA," _
                      & " DITTA, NUM_PARTITA, ESENTE_ICI," _
                      & " PERC_POSSESSO, INAGIBILE, MICROZONA_CENSUARIA," _
                      & " ZONA_CENSUARIA, COD_STATO_CATASTALE, INDIRIZZO," _
                      & " CIVICO, CAP, LOCALITA," _
                      & " COD_COMUNE, SUP_CONVENZIONALE, VAL_LOCATIVO_UNITA" _
                      & " FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & IdContratto & ")"
                par.cmd.ExecuteNonQuery()


                par.cmd.CommandText = "INSERT INTO SISCOM_MI.INTESTATARI_RAPPORTO (ID_CONTRATTO,ID_ANAGRAFICA,DATA_INIZIO,DATA_FINE) VALUES (" & INDICE_CONTRATTO & "," & IdAnagRichiedente & ",'" & RinnovoDataPG & "','29991231')"
                par.cmd.ExecuteNonQuery()

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                & "VALUES (" & INDICE_CONTRATTO & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                & "'F01','')"
                par.cmd.ExecuteNonQuery()

                txtModificato.Value = "0"

                sNuovoCodiceRapporto = NuovoCodiceContratto
                lNuovoIdRapporto = INDICE_CONTRATTO

                '*************evento per posiz. abusiva
                par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                                & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                                & "','F210','','')"
                par.cmd.ExecuteNonQuery()
                CType(Dom_Decisioni1.FindControl("autorizzFinale"), HiddenField).Value = 1


                par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET PRESSO_COR='" & par.PulisciStrSql(CognomeNome) & "',TIPO_COR='" & TipoIndir & "'," _
                & "LUOGO_COR='" & LuogoRec & "',VIA_COR='" & Indirizzo & "',CIVICO_COR='" & Civico & "',CAP_COR='" & Cap & "' WHERE ID=" & INDICE_CONTRATTO
                par.cmd.ExecuteNonQuery()
            End If

        Catch ex As Exception
            errore = True
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../../Errore.aspx';</script>")
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try
    End Sub



    Private Sub CreazBozzaAbusAmmvo(ByVal CodFis As String)
        Try

            Dim DESTINAZIONE As String = ""

            Dim Risoluzione As Boolean = False
            Dim importoRisoluzione As Double = 0
            Dim IMPORTOINTERESSI As Double = 0
            Dim sAggiunta As String = ""
            Dim DataCalcolo As String = ""
            Dim DataInizio As String = ""

            Dim tasso As Double = 0
            Dim baseCalcolo As Double = 0

            Dim Giorni As Integer = 0
            Dim GiorniAnno As Integer = 0
            Dim dataPartenza As String = ""

            Dim Totale As Double = 0
            Dim TotalePeriodo As Double = 0
            Dim indice As Long = 0
            Dim DataFine As String = ""
            Dim num_bolletta As String = ""
            Dim importobolletta As Double = 0
            Dim I As Integer = 0

            Dim importodanni As Double = 0
            Dim importotrasporto As Double = 0

            Dim Interessi As New SortedDictionary(Of Integer, Double)

            Dim RIASSUNTO_BOLLETTA As String = ""
            Dim lIdConnessione As String = ""

            Dim IdContratto As String = ""
            Dim sNuovoCodiceRapporto As String = ""
            Dim lNuovoIdRapporto As String = ""
            Dim UnitaContratto As Long

            Dim RinnovoDataChiusura As String = ""
            Dim RinnovoDataPG As String = ""
            Dim RinnovoNumeroPG As String = ""
            Dim RinnovoCanone As String = ""
            Dim FaiCambioBox As String = "1"
            Dim CFNuovoIntest As String = ""
            Dim IdUI As Long = 0
            Dim CognomeNome As String = ""
            Dim TipoIndir As String = ""
            Dim Indirizzo As String = ""
            Dim Civico As String = ""
            Dim LuogoRec As String = ""
            Dim Sigla As String = ""
            Dim Cap As String = ""
            Dim tipo_occup As String = ""

            data_riconsegna.Value = par.AggiustaData(Date.Parse(par.FormattaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text), New System.Globalization.CultureInfo("it-IT", False)).AddDays(-1).ToString("dd/MM/yyyy"))

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
            Dim da1 As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            Dim dt1 As New Data.DataTable
            da1.Fill(dt1)
            IdContratto = dt1.Rows(0).Item("id")

            RinnovoCanone = dt1.Rows(0).Item("IMP_CANONE_INIZIALE")
            RinnovoDataChiusura = par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text)

            Dim aggiornamento_istat As Double = 0
            Dim AltriAdeguamenti As Double = 0

            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo=2 and ID_CONTRATTO=" & IdContratto
            Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If lettore.Read Then
                aggiornamento_istat = par.IfNull(lettore(0), 0)
            End If
            lettore.Close()

            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo<>2 and ID_CONTRATTO=" & IdContratto
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                AltriAdeguamenti = par.IfNull(lettore(0), 0)
            End If
            lettore.Close()

            par.cmd.CommandText = "SELECT ID_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE COD_UNITA_IMMOBILIARE='" & CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text & "' AND ID_UNITA_PRINCIPALE IS NULL"
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                UnitaContratto = par.IfNull(lettore("ID_UNITA"), "")
            End If
            lettore.Close()

            par.cmd.CommandText = "SELECT * FROM DICHIARAZIONI_VSA,COMP_NUCLEO_VSA WHERE DICHIARAZIONI_VSA.ID = COMP_NUCLEO_VSA.ID_DICHIARAZIONE AND DICHIARAZIONI_VSA.ID=" & lIdDichiarazione & " AND PROGR=0"
            lettore = par.cmd.ExecuteReader()
            If lettore.Read Then
                RinnovoDataPG = par.IfNull(lettore("DATA_PG"), "")
                RinnovoNumeroPG = par.IfNull(lettore("PG"), "")
                CFNuovoIntest = par.IfNull(lettore("COD_FISCALE"), "")

                CognomeNome = Trim(par.IfNull(lettore("COGNOME"), "")) & " " & Trim(par.IfNull(lettore("NOME"), ""))

                par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE ID='" & par.IfNull(lettore("ID_LUOGO_RES_DNTE"), "") & "'"
                Dim myReaderIDluogoRES As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderIDluogoRES.Read Then
                    Sigla = par.IfNull(myReaderIDluogoRES("SIGLA"), "")
                    LuogoRec = par.PulisciStrSql(par.IfNull(myReaderIDluogoRES("NOME"), ""))
                End If
                myReaderIDluogoRES.Close()

                par.cmd.CommandText = "SELECT * FROM T_TIPO_INDIRIZZO WHERE COD='" & par.IfNull(lettore("ID_TIPO_IND_RES_DNTE"), "") & "'"
                Dim myReaderTipoIndir As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderTipoIndir.Read Then
                    TipoIndir = par.IfNull(myReaderTipoIndir("DESCRIZIONE"), "")
                End If
                myReaderTipoIndir.Close()

                Indirizzo = par.PulisciStrSql(par.IfNull(lettore("IND_RES_DNTE"), ""))
                Civico = par.PulisciStrSql(par.IfNull(lettore("CIVICO_RES_DNTE"), ""))
                Cap = par.IfNull(lettore("CAP_RES_DNTE"), "")
            End If
            lettore.Close()

            If data_riconsegna.Value <> "" Then
                Dim IdAnagRichiedente As String = ""
                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.ANAGRAFICA WHERE COD_FISCALE = (SELECT COD_FISCALE FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE = " & lIdDichiarazione & " AND PROGR = 0) ORDER BY ID DESC"
                Dim myReaderIdA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
                If myReaderIdA.Read Then
                    IdAnagRichiedente = myReaderIdA("id")
                End If
                myReaderIdA.Close()

                par.cmd.CommandText = "SELECT id_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & IdContratto
                Dim myReaderUI As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderUI.Read Then
                    IdUI = myReaderUI("id_UNITA")
                End If
                myReaderUI.Close()

                If CodFis = "-1" Then
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                        & "VALUES (" & IdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                        & "'F102','')"
                Else
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                        & "VALUES (" & IdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                        & "'F229','')"
                End If
                par.cmd.ExecuteNonQuery()

                Dim progressivo As Integer
                'par.cmd.CommandText = "select MAX(TO_NUMBER(TRANSLATE(SUBSTR(cod_contratto,18,2),'A','0'))) from SISCOM_MI.rapporti_utenza where id=" & IdContratto
                par.cmd.CommandText = "select MAX(TO_NUMBER(TRANSLATE(SUBSTR(cod_contratto,18,2),'A','0'))) from SISCOM_MI.rapporti_utenza,siscom_mi.unita_contrattuale,siscom_mi.unita_immobiliari where id_unita=" & IdUI & " and rapporti_utenza.id=unita_contrattuale.id_contratto and unita_contrattuale.id_unita=siscom_mi.unita_immobiliari.id"
                Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader1.Read Then
                    progressivo = par.IfNull(myReader1(0), 0) + 1
                Else
                    progressivo = 1
                End If
                myReader1.Close()
                Dim NuovoCodiceContratto As String = Mid(CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text, 1, 17) & Format((progressivo), "00")
                nuovoCodContr.Value = NuovoCodiceContratto
                Dim nome As String = ""
                Dim Cognome As String = ""
                Dim CF As String = ""

                If CodFis = "-1" Then
                    par.cmd.CommandText = "select anagrafica.* from siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND soggetti_contrattuali.id_CONTRATTO=" & IdContratto
                Else
                    par.cmd.CommandText = "select anagrafica.* from siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND anagrafica.cod_fiscale='" & UCase(par.PulisciStrSql(CodFis)) & "'"
                End If


                Dim myReaderX As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()

                If myReaderX.Read = True Then
                    If par.IfNull(myReaderX("ragione_sociale"), "") = "" Then
                        Cognome = par.IfNull(myReaderX("cognome"), "")
                        nome = par.IfNull(myReaderX("nome"), "")
                    Else
                        Cognome = par.IfNull(myReaderX("ragione_sociale"), "")
                        nome = ""
                    End If
                    If par.IfNull(myReaderX("partita_iva"), "") = "" Then
                        CF = par.IfNull(myReaderX("cod_fiscale"), "")
                    Else
                        CF = par.IfNull(myReaderX("partita_iva"), "")
                    End If

                    par.cmd.CommandText = "Insert into siscom_mi.UNITA_ASSEGNATE (ID_DOMANDA, ID_UNITA, DATA_ASSEGNAZIONE, " _
                                        & "GENERATO_CONTRATTO, ID_DICHIARAZIONE, COGNOME_RS, NOME, CF_PIVA, PROVENIENZA, N_OFFERTA,CANONE,ID_ANAGRAFICA,PROVVEDIMENTO,DATA_PROVVEDIMENTO) " _
                                        & " Values " _
                                        & "(-1, " & UnitaContratto & ", '" & RinnovoDataPG & "', 1, -1, " _
                                        & "'" & par.PulisciStrSql(Cognome) & "', '" & par.PulisciStrSql(nome) _
                                        & "', '" & par.PulisciStrSql(CF) & "', 'V', 0," & par.VirgoleInPunti(CDec(importoCanone.Value)) & "," & par.IfNull(myReaderX("id"), "0") & ",'" & RinnovoNumeroPG & "','" & RinnovoDataPG & "')"
                    par.cmd.ExecuteNonQuery()
                End If
                myReaderX.Close()


                Dim proxBolletta As String = ""

                par.cmd.CommandText = "SELECT RAPPORTI_UTENZA.*,RAPPORTI_UTENZA_PROSSIMA_BOL.PROSSIMA_BOLLETTA FROM SISCOM_MI.RAPPORTI_UTENZA_PROSSIMA_BOL,SISCOM_MI.RAPPORTI_UTENZA WHERE RAPPORTI_UTENZA_PROSSIMA_BOL.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND ID=" & IdContratto
                myReaderX = par.cmd.ExecuteReader()
                If myReaderX.Read = True Then
                    par.cmd.CommandText = "Insert into SISCOM_MI.RAPPORTI_UTENZA (ID, COD_CONTRATTO, COD_TIPOLOGIA_RAPP_CONTR, COD_TIPOLOGIA_CONTR_LOC," _
                                   & "DURATA_ANNI, DATA_DECORRENZA, DATA_SCADENZA, " _
                                   & "IMP_CANONE_INIZIALE, IMP_DEPOSITO_CAUZ," _
                                   & "COD_UFFICIO_REG, DATA_STIPULA, DATA_CONSEGNA, DATA_SCADENZA_RINNOVO, DURATA_RINNOVO, MESI_DISDETTA," _
                                   & "DELIBERA, DATA_DELIBERA, NRO_RATE, FREQ_VAR_ISTAT,VERSAMENTO_TR, PER_BANDO, TIPO_COR, LUOGO_COR, VIA_COR,     " _
                                   & "CIVICO_COR, SIGLA_COR, CAP_COR, PRESSO_COR,BOZZA, INTERESSI_CAUZIONE," _
                                   & "ID_DEST_RATE, INVIO_BOLLETTA,FL_CONGUAGLIO, PERC_ISTAT, " _
                                   & "IMP_CANONE_ATTUALE, PROVENIENZA_ASS,INTERESSI_RIT_PAG, IMPORTO_ANTICIPO, ID_DOMANDA, ID_ISEE, " _
                                   & "DEST_USO, MOTIVO_REC_FORZOSO, FL_STAMPATO, BOLLO, N_OFFERTA,     " _
                                   & "MITTENTE_DISDETTA,ART_15, ID_DOMANDA_ABUS) " _
                                   & "Values (SISCOM_MI.SEQ_RAPPORTI_UTENZA.NEXTVAL, '" & NuovoCodiceContratto & "', '" _
                                   & "LEGIT', 'L43198" _
                                   & "', 2,'" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text) & "','" & par.AggiustaData(DateAdd(DateInterval.Year, 2, CDate(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text))) & "'," & par.VirgoleInPunti(CDec(importoCanone.Value)) & "," & par.VirgoleInPunti((CDec(importoCanone.Value) / 12) * 3) & "" _
                                   & ",'TNP','" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text) & "','" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text) & "','" & par.AggiustaData(DateAdd(DateInterval.Year, 2, CDate(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text))) & "',0,6,'" & numProvvedim.Value & "','" & par.AggiustaData(dataProvvedim.Value) & "',12,'A','A', 1, '" & par.IfNull(myReaderX("TIPO_COR"), "VIA") _
                                   & "', '" & par.PulisciStrSql(par.IfNull(myReaderX("LUOGO_COR"), "")) & "', '" _
                                   & par.PulisciStrSql(par.IfNull(myReaderX("VIA_COR"), "")) _
                                   & "', '" & par.PulisciStrSql(par.IfNull(myReaderX("CIVICO_COR"), "")) & "', '" _
                                   & par.PulisciStrSql(par.IfNull(myReaderX("SIGLA_COR"), "")) & "', '" _
                                   & par.PulisciStrSql(par.IfNull(myReaderX("CAP_COR"), "")) & "', '" _
                                   & par.PulisciStrSql(par.IfNull(myReaderX("PRESSO_COR"), "")) & "',1,1,1,1,'1'" _
                                   & ", 75," & par.VirgoleInPunti(CDec(importoCanone.Value)) & "" _
                                   & ",6,'1', 0, " & par.IfNull(myReaderX("ID_DOMANDA"), "NULL") _
                                   & ", " & par.IfNull(myReaderX("ID_ISEE"), "NULL") _
                                   & ",'V',4,0,'73.10','0',-1,3," & lIdDomanda & ")"

                    par.cmd.ExecuteNonQuery()

                    proxBolletta = par.IfNull(myReaderX("PROSSIMA_BOLLETTA"), "")

                End If
                myReaderX.Close()


                par.cmd.CommandText = "select siscom_mi.seq_RAPPORTI_UTENZA.currval from dual"
                Dim myReaderX2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderX2.Read Then
                    INDICE_CONTRATTO = myReaderX2(0)
                End If
                myReaderX2.Close()


                'par.cmd.CommandText = "INSERT INTO SISCOM_MI.RAPPORTI_UTENZA_PROSSIMA_BOL (ID_CONTRATTO,PROSSIMA_BOLLETTA) VALUES (" & INDICE_CONTRATTO & ",'" & proxBolletta & "')"
                'par.cmd.ExecuteNonQuery()

                If CodFis <> "-1" Then
                    'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & IdContratto
                    'myReaderX = par.cmd.ExecuteReader()
                    'If myReaderX.Read = True Then
                    par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET TIPO_COR='" & par.IfNull(dt1.Rows(0).Item("TIPO_COR"), "VIA") _
                                        & "',LUOGO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("LUOGO_COR"), "")) _
                                        & "',VIA_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("VIA_COR"), "")) _
                                        & "',CIVICO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("CIVICO_COR"), "")) _
                                        & "',SIGLA_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("SIGLA_COR"), "")) _
                                        & "',CAP_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("CAP_COR"), "")) _
                                        & "',PRESSO_COR='" & par.PulisciStrSql(par.IfNull(dt1.Rows(0).Item("PRESSO_COR"), "")) _
                                        & "' WHERE ID=" & INDICE_CONTRATTO
                    par.cmd.ExecuteNonQuery()
                    'End If
                End If
                Dim idAnagrAltroComp As String = ""

                If CodFis = "-1" Then
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & IdContratto & " AND COD_TIPOLOGIA_OCCUPANTE<>'INTE' and NVL(data_fine,'29991231') >= '" & Format(Now(), "yyyyMMdd") & "'"
                    myReaderX = par.cmd.ExecuteReader()
                    Do While myReaderX.Read
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                                            & par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                                            & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                        par.cmd.ExecuteNonQuery()
                    Loop
                    myReaderX.Close()
                Else

                    'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & IdContratto & " and NVL(data_fine,'29991231') >= '" & Format(Now(), "yyyyMMdd") & "'"
                    'myReaderX = par.cmd.ExecuteReader()
                    'Do While myReaderX.Read
                    '    If par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") = IdAnagRichiedente Then
                    '        par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                    '        & IdAnagRichiedente & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                    '        & "','INTE','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                    '    Else
                    '        If par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") = "INTE" Then
                    '            tipo_occup = "ALTR"
                    '        Else
                    '            tipo_occup = par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "")

                    '        End If
                    '        par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                    '        & par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                    '        & "','" & tipo_occup & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                    '    End If

                    '    par.cmd.ExecuteNonQuery()
                    'Loop
                    'myReaderX.Close()

                    par.cmd.CommandText = "SELECT COMP_NUCLEO_VSA.ID,COMP_NUCLEO_VSA.PROGR,id_dichiarazione,cod_fiscale,cognome,nome,sesso,data_nascita,perc_inval,indennita_acc,grado_parentela," _
                                    & "DICHIARAZIONI_VSA.id_luogo_res_dnte,DICHIARAZIONI_VSA.id_tipo_ind_res_dnte,DICHIARAZIONI_VSA.ind_res_dnte,DICHIARAZIONI_VSA.civico_res_dnte,DICHIARAZIONI_VSA.cap_res_dnte " _
                                    & "FROM COMP_NUCLEO_VSA,DICHIARAZIONI_VSA " _
                                    & "WHERE " _
                                    & "DICHIARAZIONI_VSA.ID=COMP_NUCLEO_VSA.id_dichiarazione " _
                                    & "AND id_dichiarazione = " & lIdDichiarazione
                    Dim da As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
                    Dim dt As New Data.DataTable
                    da.Fill(dt)
                    For Each row As Data.DataRow In dt.Rows
                        idAnagrAltroComp = ""
                        par.cmd.CommandText = "select id from siscom_mi.anagrafica where cod_fiscale = '" & par.IfNull(row.Item("COD_FISCALE"), "") & "'"
                        Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
                        If par.IfNull(row.Item("PROGR"), "0") <> "0" Then
                            If myReader.Read Then
                                idAnagrAltroComp = par.IfNull(myReader("ID"), "")
                            End If
                            myReader.Close()

                            If idAnagrAltroComp = "" Then
                                idAnagrAltroComp = InserInAnagrafica(row)
                            End If
                        End If
                        par.cmd.CommandText = "SELECT T_TIPO_PARENTELA.*,COMP_NUCLEO_VSA.PROGR FROM COMP_NUCLEO_VSA,T_TIPO_PARENTELA WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " AND COD_FISCALE='" & par.IfNull(row.Item("COD_FISCALE"), "") & "' AND COMP_NUCLEO_VSA.GRADO_PARENTELA=T_TIPO_PARENTELA.COD ORDER BY PROGR ASC"
                        Dim myReaderABUS As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderABUS.Read Then
                            If par.IfNull(myReaderABUS("PROGR"), "0") = "0" Then
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                                  & IdAnagRichiedente & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderABUS("COD_SISCOM_MI"), "") _
                                  & "','INTE','LEGIT')"
                                par.cmd.ExecuteNonQuery()

                                par.cmd.CommandText = "DELETE FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & INDICE_CONTRATTO & " AND COD_TIPOLOGIA_OCCUPANTE<>'INTE'"
                                par.cmd.ExecuteNonQuery()
                            Else
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                                  & idAnagrAltroComp & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderABUS("COD_SISCOM_MI"), "") _
                                  & "','ALTR','LEGIT')"
                                par.cmd.ExecuteNonQuery()
                            End If

                        End If
                        myReaderABUS.Close()
                    Next


                End If


                par.cmd.CommandText = "INSERT INTO SISCOM_MI.UNITA_CONTRATTUALE (SELECT " _
                          & INDICE_CONTRATTO & ", ID_UNITA, COD_UNITA_IMMOBILIARE," _
                          & " TIPOLOGIA, ID_EDIFICIO, SCALA," _
                          & " COD_TIPO_LIVELLO_PIANO, INTERNO, ID_UNITA_PRINCIPALE," _
                          & " SEZIONE, FOGLIO, NUMERO," _
                          & " SUB, COD_TIPOLOGIA_CATASTO, RENDITA," _
                          & " COD_CATEGORIA_CATASTALE, COD_CLASSE_CATASTALE, COD_QUALITA_CATASTALE," _
                          & " SUPERFICIE_MQ, CUBATURA, NUM_VANI," _
                          & " SUPERFICIE_CATASTALE, RENDITA_STORICA, IMMOBILE_STORICO," _
                          & " REDDITO_DOMINICALE, VALORE_IMPONIBILE, REDDITO_AGRARIO," _
                          & " VALORE_BILANCIO, DATA_ACQUISIZIONE, DATA_FINE_VALIDITA," _
                          & " DITTA, NUM_PARTITA, ESENTE_ICI," _
                          & " PERC_POSSESSO, INAGIBILE, MICROZONA_CENSUARIA," _
                          & " ZONA_CENSUARIA, COD_STATO_CATASTALE, INDIRIZZO," _
                          & " CIVICO, CAP, LOCALITA," _
                          & " COD_COMUNE, SUP_CONVENZIONALE, VAL_LOCATIVO_UNITA" _
                          & " FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & IdContratto & ")"
                par.cmd.ExecuteNonQuery()


                par.cmd.CommandText = "INSERT INTO SISCOM_MI.INTESTATARI_RAPPORTO (ID_CONTRATTO,ID_ANAGRAFICA,DATA_INIZIO,DATA_FINE) VALUES (" & INDICE_CONTRATTO & "," & IdAnagRichiedente & ",'" & RinnovoDataPG & "','29991231')"
                par.cmd.ExecuteNonQuery()

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                & "VALUES (" & INDICE_CONTRATTO & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                & "'F01','')"
                par.cmd.ExecuteNonQuery()

                txtModificato.Value = "0"

                sNuovoCodiceRapporto = NuovoCodiceContratto
                lNuovoIdRapporto = INDICE_CONTRATTO

                '*************evento per voltura
                par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                                & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                                & "','F212','','')"
                par.cmd.ExecuteNonQuery()
                CType(Dom_Decisioni1.FindControl("autorizzFinale"), HiddenField).Value = 1

                par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET PRESSO_COR='" & par.PulisciStrSql(CognomeNome) & "',TIPO_COR='" & TipoIndir & "'," _
                & "LUOGO_COR='" & LuogoRec & "',VIA_COR='" & Indirizzo & "',CIVICO_COR='" & Civico & "',CAP_COR='" & Cap & "' WHERE ID=" & INDICE_CONTRATTO
                par.cmd.ExecuteNonQuery()
            End If

        Catch ex As Exception
            errore = True
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../../Errore.aspx';</script>")
            par.myTrans.Rollback()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)
        End Try
    End Sub







    Private Function tempoProcesso(ByVal tipoDomanda As Integer) As Integer
        Try
            tempoProcesso = 0
            par.cmd.CommandText = "select * from TEMPI_PROCESSI_VSA where ID_MOTIVO_DOMANDA=" & tipoDomanda
            Dim myReaderGG As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderGG.Read Then
                tempoProcesso = par.IfNull(myReaderGG("TEMPO_GG"), 0)
            End If
            myReaderGG.Close()

            Return tempoProcesso

        Catch ex As Exception
            par.cmd.Dispose()
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../../Errore.aspx';</script>")
        End Try
    End Function
    Public Property sNOTE() As String
        Get
            If Not (ViewState("par_sNOTE") Is Nothing) Then
                Return CStr(ViewState("par_sNOTE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sNOTE") = value
        End Set
    End Property

    Public Property AreaEconomica() As Integer
        Get
            If Not (ViewState("par_AreaEconomica") Is Nothing) Then
                Return CInt(ViewState("par_AreaEconomica"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Integer)
            ViewState("par_AreaEconomica") = value
        End Set

    End Property

    Public Property sDEM() As String
        Get
            If Not (ViewState("par_sDEM") Is Nothing) Then
                Return CStr(ViewState("par_sDEM"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sDEM") = value
        End Set
    End Property

    Public Property sSUPCONVENZIONALE() As String
        Get
            If Not (ViewState("par_sSUPCONVENZIONALE") Is Nothing) Then
                Return CStr(ViewState("par_sSUPCONVENZIONALE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sSUPCONVENZIONALE") = value
        End Set
    End Property

    Public Property sCOSTOBASE() As String
        Get
            If Not (ViewState("par_sCOSTOBASE") Is Nothing) Then
                Return CStr(ViewState("par_sCOSTOBASE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCOSTOBASE") = value
        End Set
    End Property

    Public Property sZONA() As String
        Get
            If Not (ViewState("par_sZONA") Is Nothing) Then
                Return CStr(ViewState("par_sZONA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sZONA") = value
        End Set
    End Property

    Public Property sPIANO() As String
        Get
            If Not (ViewState("par_sPIANO") Is Nothing) Then
                Return CStr(ViewState("par_sPIANO"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sPIANO") = value
        End Set
    End Property

    Public Property sCONSERVAZIONE() As String
        Get
            If Not (ViewState("par_sCONSERVAZIONE") Is Nothing) Then
                Return CStr(ViewState("par_sCONSERVAZIONE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCONSERVAZIONE") = value
        End Set
    End Property

    Public Property sVETUSTA() As String
        Get
            If Not (ViewState("par_sVETUSTA") Is Nothing) Then
                Return CStr(ViewState("par_sVETUSTA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sVETUSTA") = value
        End Set
    End Property

    Public Property sINCIDENZAISE() As String
        Get
            If Not (ViewState("par_sINCIDENZAISE") Is Nothing) Then
                Return CStr(ViewState("par_sINCIDENZAISE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sINCIDENZAISE") = value
        End Set
    End Property


    Public Property sCOEFFFAM() As String
        Get
            If Not (ViewState("par_sCOEFFFAM") Is Nothing) Then
                Return CStr(ViewState("par_sCOEFFFAM"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCOEFFFAM") = value
        End Set
    End Property

    Public Property sSOTTOAREA() As String
        Get
            If Not (ViewState("par_sSOTTOAREA") Is Nothing) Then
                Return CStr(ViewState("par_sSOTTOAREA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sSOTTOAREA") = value
        End Set
    End Property

    Public Property sMOTIVODECADENZA() As String
        Get
            If Not (ViewState("par_sMOTIVODECADENZA") Is Nothing) Then
                Return CStr(ViewState("par_sMOTIVODECADENZA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sMOTIVODECADENZA") = value
        End Set
    End Property

    Public Property sNUMCOMP() As String
        Get
            If Not (ViewState("par_sNUMCOMP") Is Nothing) Then
                Return CStr(ViewState("par_sNUMCOMP"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sNUMCOMP") = value
        End Set
    End Property

    Public Property sNUMCOMP66() As String
        Get
            If Not (ViewState("par_sNUMCOMP66") Is Nothing) Then
                Return CStr(ViewState("par_sNUMCOMP66"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sNUMCOMP66") = value
        End Set
    End Property

    Public Property sNUMCOMP100() As String
        Get
            If Not (ViewState("par_sNUMCOMP100") Is Nothing) Then
                Return CStr(ViewState("par_sNUMCOMP100"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sNUMCOMP100") = value
        End Set
    End Property

    Public Property sNUMCOMP100C() As String
        Get
            If Not (ViewState("par_sNUMCOMP100C") Is Nothing) Then
                Return CStr(ViewState("par_sNUMCOMP100C"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sNUMCOMP100C") = value
        End Set
    End Property

    Public Property sPREVDIP() As String
        Get
            If Not (ViewState("par_sPREVDIP") Is Nothing) Then
                Return CStr(ViewState("par_sPREVDIP"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sPREVDIP") = value
        End Set
    End Property

    Public Property sDETRAZIONI() As String
        Get
            If Not (ViewState("par_sDETRAZIONI") Is Nothing) Then
                Return CStr(ViewState("par_sDETRAZIONI"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sDETRAZIONI") = value
        End Set
    End Property

    Public Property sMOBILIARI() As String
        Get
            If Not (ViewState("par_sMOBILIARI") Is Nothing) Then
                Return CStr(ViewState("par_sMOBILIARI"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sMOBILIARI") = value
        End Set
    End Property


    Public Property sIMMOBILIARI() As String
        Get
            If Not (ViewState("par_sIMMOBILIARI") Is Nothing) Then
                Return CStr(ViewState("par_sIMMOBILIARI"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sIMMOBILIARI") = value
        End Set
    End Property

    Public Property sCOMPLESSIVO() As String
        Get
            If Not (ViewState("par_sCOMPLESSIVO") Is Nothing) Then
                Return CStr(ViewState("par_sCOMPLESSIVO"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCOMPLESSIVO") = value
        End Set
    End Property

    Public Property sDETRAZIONEF() As String
        Get
            If Not (ViewState("par_sDETRAZIONEF") Is Nothing) Then
                Return CStr(ViewState("par_sDETRAZIONEF"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sDETRAZIONEF") = value
        End Set
    End Property

    Public Property sANNOCOSTRUZIONE() As String
        Get
            If Not (ViewState("par_sANNOCOSTRUZIONE") Is Nothing) Then
                Return CStr(ViewState("par_sANNOCOSTRUZIONE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sANNOCOSTRUZIONE") = value
        End Set
    End Property

    Public Property sLOCALITA() As String
        Get
            If Not (ViewState("par_sLOCALITA") Is Nothing) Then
                Return CStr(ViewState("par_sLOCALITA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sLOCALITA") = value
        End Set
    End Property

    Public Property sASCENSORE() As String
        Get
            If Not (ViewState("par_sASCENSORE") Is Nothing) Then
                Return CStr(ViewState("par_sASCENSORE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sASCENSORE") = value
        End Set
    End Property

    Public Property sDESCRIZIONEPIANO() As String
        Get
            If Not (ViewState("par_sDESCRIZIONEPIANO") Is Nothing) Then
                Return CStr(ViewState("par_sDESCRIZIONEPIANO"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sDESCRIZIONEPIANO") = value
        End Set
    End Property

    Public Property sSUPNETTA() As String
        Get
            If Not (ViewState("par_sSUPNETTA") Is Nothing) Then
                Return CStr(ViewState("par_sSUPNETTA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sSUPNETTA") = value
        End Set
    End Property

    Public Property sALTRESUP() As String
        Get
            If Not (ViewState("par_sALTRESUP") Is Nothing) Then
                Return CStr(ViewState("par_sALTRESUP"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sALTRESUP") = value
        End Set
    End Property

    Public Property sMINORI15() As String
        Get
            If Not (ViewState("par_sMINORI15") Is Nothing) Then
                Return CStr(ViewState("par_sMINORI15"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sMINORI15") = value
        End Set
    End Property


    Public Property sMAGGIORI65() As String
        Get
            If Not (ViewState("par_sMAGGIORI65") Is Nothing) Then
                Return CStr(ViewState("par_sMAGGIORI65"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sMAGGIORI65") = value
        End Set
    End Property

    Public Property sSUPACCESSORI() As String
        Get
            If Not (ViewState("par_sSUPACCESSORI") Is Nothing) Then
                Return CStr(ViewState("par_sSUPACCESSORI"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sSUPACCESSORI") = value
        End Set
    End Property

    Public Property sVALORELOCATIVO() As String
        Get
            If Not (ViewState("par_sVALORELOCATIVO") Is Nothing) Then
                Return CStr(ViewState("par_sVALORELOCATIVO"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sVALORELOCATIVO") = value
        End Set
    End Property

    Public Property sCANONEMINIMO() As String
        Get
            If Not (ViewState("par_sCANONEMINIMO") Is Nothing) Then
                Return CStr(ViewState("par_sCANONEMINIMO"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCANONEMINIMO") = value
        End Set
    End Property

    Public Property sCANONECLASSE() As String
        Get
            If Not (ViewState("par_sCANONECLASSE") Is Nothing) Then
                Return CStr(ViewState("par_sCANONECLASSE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCANONECLASSE") = value
        End Set
    End Property

    Public Property sCANONESOPP() As String
        Get
            If Not (ViewState("par_sCANONESOPP") Is Nothing) Then
                Return CStr(ViewState("par_sCANONESOPP"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCANONESOPP") = value
        End Set
    End Property


    Public Property sVALOCIICI() As String
        Get
            If Not (ViewState("par_sVALOCIICI") Is Nothing) Then
                Return CStr(ViewState("par_sVALOCIICI"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sVALOCIICI") = value
        End Set
    End Property

    Public Property sALLOGGIOIDONEO() As String
        Get
            If Not (ViewState("par_sALLOGGIOIDONEO") Is Nothing) Then
                Return CStr(ViewState("par_sALLOGGIOIDONEO"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sALLOGGIOIDONEO") = value
        End Set
    End Property

    Public Property sISTAT() As String
        Get
            If Not (ViewState("par_sISTAT") Is Nothing) Then
                Return CStr(ViewState("par_sISTAT"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sISTAT") = value
        End Set
    End Property

    Public Property sCANONECLASSEISTAT() As String
        Get
            If Not (ViewState("par_sCANONECLASSEISTAT") Is Nothing) Then
                Return CStr(ViewState("par_sCANONECLASSEISTAT"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCANONECLASSEISTAT") = value
        End Set
    End Property

    Public Property VAL_LOCATIVO_UNITA() As String
        Get
            If Not (ViewState("par_VAL_LOCATIVO_UNITA") Is Nothing) Then
                Return CStr(ViewState("par_VAL_LOCATIVO_UNITA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_VAL_LOCATIVO_UNITA") = value
        End Set

    End Property



    Public Property CanoneCorrente() As Double
        Get
            If Not (ViewState("par_CanoneCorrente") Is Nothing) Then
                Return CDbl(ViewState("par_CanoneCorrente"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Double)
            ViewState("par_CanoneCorrente") = value
        End Set

    End Property


    Public Property sANNOINIZIOVAL() As String
        Get
            If Not (ViewState("par_sANNOINIZIOVAL") Is Nothing) Then
                Return CStr(ViewState("par_sANNOINIZIOVAL"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sANNOINIZIOVAL") = value
        End Set
    End Property

    Public Property sANNOFINEVAL() As String
        Get
            If Not (ViewState("par_sANNOFINEVAL") Is Nothing) Then
                Return CStr(ViewState("par_sANNOFINEVAL"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sANNOFINEVAL") = value
        End Set
    End Property

    Protected Overrides Sub Finalize()
        MyBase.Finalize()
    End Sub

    Protected Sub btnVisualizzaDich_Click(sender As Object, e As System.Web.UI.ImageClickEventArgs) Handles btnVisualizzaDich.Click
        CType(Dom_DocAllegati.FindControl("chkListDocumenti"), CheckBoxList).Items.Clear()
        Dom_DocAllegati.CaricaLista()
    End Sub

    Private Function Dic_Note1() As Object
        Throw New NotImplementedException
    End Function

    Protected Sub Page_LoadComplete(sender As Object, e As System.EventArgs) Handles Me.LoadComplete
        If Request.QueryString("GLocat") = "" Then
            SetMenuStampe(par.IfEmpty(tipoRichiesta.Value, -1))
        End If
    End Sub

    Protected Sub btnSalva_Click(sender As Object, e As System.EventArgs) Handles btnSalva.Click

        Dim S As String

        Try
            bMemorizzato = False

            If Request.QueryString("GLocat") <> "" Then
                CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue = -1
            End If

            Dim motSelected As Boolean = False
            Dim motSelectedRies As Boolean = False

            'Dim noteNegativo As String = ""
            'noteNegativo = CType(Dom_Decisioni1.FindControl("txtNoteDecisione"), TextBox).Text
            If par.IfEmpty(CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue, 0) = 3 Then
                Dim i As Integer
                For i = 0 To CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items.Count - 1
                    If CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items(i).Selected = True Then
                        'If Not noteNegativo.Contains(CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items(i).Text) Then
                        '    noteNegativo += CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items(i).Text & vbCrLf
                        'End If
                        motSelected = True
                    End If
                Next
            Else
                motSelected = True
            End If


            If par.IfEmpty(CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue, 0) = 6 Then
                Dim i As Integer
                For i = 0 To CType(Dom_Decisioni1.FindControl("ChkMotiviRies"), CheckBoxList).Items.Count - 1
                    If CType(Dom_Decisioni1.FindControl("ChkMotiviRies"), CheckBoxList).Items(i).Selected = True Then
                        motSelectedRies = True
                    End If
                Next
            Else
                motSelectedRies = True
            End If

            If par.IfEmpty(CType(Dom_Decisioni1.FindControl("rdbListDecis0"), RadioButtonList).SelectedValue, 0) = 8 Then
                If CType(Dom_Decisioni1.FindControl("txtNoteDec0"), TextBox).Text = "" Then
                    Response.Write("<script>alert('Attenzione...Inserire la motivazione per la decisione NON ACCOLTA!\n                                    Operazione ANNULLATA!')</script>")
                    Exit Sub
                End If
            End If

            If par.IfEmpty(CType(Dom_Decisioni1.FindControl("rdbListRies0"), RadioButtonList).SelectedValue, 0) = 10 Then
                If CType(Dom_Decisioni1.FindControl("txtNoteRies0"), TextBox).Text = "" Then
                    Response.Write("<script>alert('Attenzione...Inserire la motivazione per il riesame NON ACCOLTO!\n                                    Operazione ANNULLATA!')</script>")
                    Exit Sub
                End If
            End If

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedValue <> "8" And CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedValue <> "9" Then

                If motSelectedRies = False Then
                    Response.Write("<script>alert('Attenzione...Selezionare almeno una motivazione per il riesame NON ACCOLTO!\n                                    Operazione ANNULLATA!')</script>")
                    Exit Sub
                End If

                If motSelected = False Then
                    Response.Write("<script>alert('Attenzione...Selezionare almeno una motivazione per la decisione NON ACCOLTA!\n                                    Operazione ANNULLATA!')</script>")
                    Exit Sub
                End If
            End If
            tipoRichiesta.Value = CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedValue

            'VERIFICO CHE LA DATA DI AUTORIZZAZIONE SIA VALIDA 02/04/2012
            If CType(Dom_Decisioni1.FindControl("txtdataAUTORIZ"), TextBox).Text <> "" Then
                If IsDate(CType(Dom_Decisioni1.FindControl("txtdataAUTORIZ"), TextBox).Text) = False Then
                    Response.Write("<script>alert('Attenzione...La data di autorizzazione inserita non è valida!')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If
                If par.AggiustaData(CType(Dom_Decisioni1.FindControl("txtdataAUTORIZ"), TextBox).Text) < par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) Then
                    Response.Write("<script>alert('Attenzione...La data di autorizzazione non può essere antecedente alla data di presentazione della domanda!')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If
            End If


            'If CType(Dom_Note1.FindControl("chkSoprall"), CheckBox).Checked = True Then
            '    If CType(Dom_Note1.FindControl("txtDataSoprall"), TextBox).Text = "" Then
            '        Response.Write("<script>alert('Attenzione...Inserire la data di sopralluogo!')</script>")
            '        imgStampa.Enabled = False
            '        imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
            '        Exit Try
            '    End If
            '    'If CType(Dom_Note1.FindControl("txtNoteSoprall"), TextBox).Text = "" Then
            '    '    Response.Write("<script>alert('Attenzione...Inserire le note del sopralluogo!')</script>")
            '    '    imgStampa.Enabled = False
            '    '    imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
            '    '    Exit Try
            '    'End If
            'End If

            If CType(Dom_Note1.FindControl("txtDataSoprall"), TextBox).Text <> "" Then
                If CType(Dom_Note1.FindControl("chkSoprall"), CheckBox).Checked = False Then
                    Response.Write("<script>alert('Attenzione...per inserire la data di sopralluogo spuntare prima il flag!')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If
                If IsDate(CType(Dom_Note1.FindControl("txtDataSoprall"), TextBox).Text) = False Then
                    Response.Write("<script>alert('Attenzione...La data di sopralluogo inserita non è valida!')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If
                If par.AggiustaData(CType(Dom_Note1.FindControl("txtDataSoprall"), TextBox).Text) < par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) Then
                    Response.Write("<script>alert('Attenzione...La data di sopralluogo non può essere antecedente alla data di presentazione della domanda!')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If
            End If

            '07/09/2012 ***** CONTROLLI DATA OSSERVAZIONI *****
            If CType(Dom_Decisioni1.FindControl("txtDataOsserv"), TextBox).Text <> "" Then
                If CType(Dom_Decisioni1.FindControl("chkOsserv"), CheckBox).Checked = False Then
                    Response.Write("<script>alert('Attenzione...per inserire la data di present. delle osservazioni spuntare prima il flag!')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If
                If IsDate(CType(Dom_Decisioni1.FindControl("txtDataOsserv"), TextBox).Text) = False Then
                    Response.Write("<script>alert('Attenzione...La data di present. delle osservazioni inserita non è valida!')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If
                If par.AggiustaData(CType(Dom_Decisioni1.FindControl("txtDataOsserv"), TextBox).Text) < par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) Then
                    Response.Write("<script>alert('Attenzione...La data di present. delle osservazioni non può essere antecedente alla data di presentazione della domanda!')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If
            Else
                If CType(Dom_Decisioni1.FindControl("chkOsserv"), CheckBox).Checked = True Then
                    Response.Write("<script>alert('Attenzione...Inserire la data di present. delle osservazioni!')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If
            End If

            If CType(Dom_Note1.FindControl("txtNoteSoprall"), TextBox).Text <> "" And CType(Dom_Note1.FindControl("chkSoprall"), CheckBox).Checked = False Then
                Response.Write("<script>alert('Attenzione...per inserire il sopralluogo spuntare prima il flag!')</script>")
                imgStampa.Enabled = False
                'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                Exit Try
            End If


            'RICHIEDENTE
            If Len(CType(Me.Page.FindControl("txtCapRes"), TextBox).Text) < 5 Then
                Response.Write("<script>alert('Attenzione...Il CAP di Residenza deve essere 5 caratteri! Memorizzazione non effettuata.')</script>")
                imgStampa.Enabled = False
                'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                Exit Try
            End If

            If Len(CType(Me.Page.FindControl("txtCapRec"), TextBox).Text) < 5 Then
                Response.Write("<script>alert('Attenzione...Il CAP di Recapito deve essere 5 caratteri! Memorizzazione non effettuata.')</script>")
                imgStampa.Enabled = False
                'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                Exit Try
            End If

            ' ''--------------------- 23/03/2012 ---------------------
            ''If CType(Dom_Dichiara_Cambi1.FindControl("txtCINum"), TextBox).Text = "" And CType(Dom_Dichiara_Cambi1.FindControl("txtPSNum"), TextBox).Text = "" And CType(Dom_Dichiara_Cambi1.FindControl("txtCSNum"), TextBox).Text = "" Then
            ''    Response.Write("<script>alert('Attenzione...Inserire gli estremi del documento di riconoscimento! Memorizzazione non effettuata.')</script>")
            ''    imgStampa.Enabled = False
            ''    imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
            ''    Exit Try
            ''End If


            If par.IfEmpty(CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue, 0) = 5 Then
                If CType(Dom_Decisioni1.FindControl("chkOsserv"), CheckBox).Checked = False Then
                    Response.Write("<script>alert('Attenzione...il flag osservazioni deve essere valorizzato!')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If
            End If


            '******************* 12/04/2012 CONTROLLI SUI DOCUMENTI DI RICONOSCIMENTO ********************
            Dim COMUNITARIO As Boolean = True

            If CType(Me.Page.FindControl("cmbNazioneNas"), DropDownList).SelectedItem.Text <> "ITALIA" Then
                par.OracleConn.Open()
                par.SettaCommand(par)

                par.cmd.CommandText = "SELECT * FROM COMUNI_NAZIONI WHERE NOME='" & par.PulisciStrSql(CType(Me.Page.FindControl("cmbNazioneNas"), DropDownList).SelectedItem.Text) & "'"
                Dim myReadernaz As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReadernaz.Read() Then
                    If par.IfNull(myReadernaz("SIGLA"), "") = "C" Or par.IfNull(myReadernaz("SIGLA"), "") = "I" Then
                        COMUNITARIO = True
                    Else
                        COMUNITARIO = False
                    End If
                Else
                    COMUNITARIO = False
                End If
                myReadernaz.Close()
                par.OracleConn.Close()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()


                If CType(Dom_Dichiara_Cambi1.FindControl("txtCINum"), TextBox).Text = "" Then
                    If CType(Me.Page.FindControl("cmbNazioneNas"), DropDownList).SelectedItem.Text <> "ITALIA" And COMUNITARIO = False Then
                        If CType(Dom_Dichiara_Cambi1.FindControl("txtPSNum"), TextBox).Text = "" And CType(Dom_Dichiara_Cambi1.FindControl("txtCSNum"), TextBox).Text = "" Then
                            Response.Write("<script>alert('Attenzione! Intestatario extra comunitario. Inserire gli estremi del permesso o carta di soggiorno! Memorizzazione non effettuata.')</script>")
                            imgStampa.Enabled = False
                            'imgStampa.ImageUrl = "..\NuoveImm\Img_No_Stampa.png"
                            Exit Try
                        End If

                        If par.IfEmpty(CType(Dom_Dichiara_Cambi1.FindControl("txtCSNum"), TextBox).Text, "") = "" Then
                            If Len(par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtPSScade"), TextBox).Text))) = 8 Then
                                If par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtPSScade"), TextBox).Text)) < Format(Now, "yyyyMMdd") Then
                                    If par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtPSRinnovo"), TextBox).Text)) = "" Or par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtPSRinnovo"), TextBox).Text)) < par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtPSScade"), TextBox).Text)) Then
                                        Response.Write("<script>alert('Attenzione...Intestatario extra comunitario. Il permesso di soggiorno è scaduto! Memorizzazione non effettuata.')</script>")
                                        imgStampa.Enabled = False
                                        'imgStampa.ImageUrl = "..\NuoveImm\Img_No_Stampa.png"
                                        Exit Try
                                    End If
                                End If
                            Else
                                If par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtPSScade"), TextBox).Text)) < Format(Now, "yyyyMMdd") Then
                                    If par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtPSRinnovo"), TextBox).Text)) = "" Or par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtPSRinnovo"), TextBox).Text)) < par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtPSScade"), TextBox).Text)) Then
                                        Response.Write("<script>alert('Attenzione...Intestatario extra comunitario. Il permesso di soggiorno è scaduto! Memorizzazione non effettuata.')</script>")
                                        imgStampa.Enabled = False
                                        'imgStampa.ImageUrl = "..\NuoveImm\Img_No_Stampa.png"
                                        Exit Try
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
            Else
                If CType(Dom_Dichiara_Cambi1.FindControl("txtCINum"), TextBox).Text = "" Or CType(Dom_Dichiara_Cambi1.FindControl("txtCIData"), TextBox).Text = "" Or CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoDocumento"), DropDownList).SelectedItem.Text = "--" Then
                    Response.Write("<script>alert('Attenzione...Inserire la tipologia, il numero e la data del documento di riconoscimento! Memorizzazione non effettuata.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "..\NuoveImm\Img_No_Stampa.png"
                    Exit Try
                End If
            End If
            '******************* 12/04/2012 FINE CONTROLLI SUI DOCUMENTI DI RICONOSCIMENTO ********************



            'ALLOGGIO
            If CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).SelectedItem.Value = 0 Then


                If CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text = "" Then
                    Response.Write("<script>alert('Attenzione...Valorizzare il campo Codice Unità del tab Alloggio! Memorizzazione non effettuata.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If

                If CType(Dom_Alloggio_ERP1.FindControl("txtComune"), TextBox).Text = "" Then
                    Response.Write("<script>alert('Attenzione...Valorizzare il campo Comune del tab Alloggio! Memorizzazione non effettuata.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If

                If CType(Dom_Alloggio_ERP1.FindControl("txtIndirizzo"), TextBox).Text = "" Then
                    Response.Write("<script>alert('Attenzione...Valorizzare il campo Indirizzo del tab Alloggio! Memorizzazione non effettuata.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If


                If CType(Dom_Alloggio_ERP1.FindControl("txtCAP"), TextBox).Text = "" Then
                    Response.Write("<script>alert('Attenzione...Valorizzare il campo CAP del tab Alloggio! Memorizzazione non effettuata.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If

                If Len(CType(Dom_Alloggio_ERP1.FindControl("txtCAP"), TextBox).Text) < 5 Then
                    Response.Write("<script>alert('Attenzione...Il campo CAP del tab Alloggio deve contenere 5 numeri! Memorizzazione non effettuata.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If


                If CType(Dom_Alloggio_ERP1.FindControl("txtCivico"), TextBox).Text = "" Then
                    Response.Write("<script>alert('Attenzione...Valorizzare il campo Numero Civico del tab Alloggio! Memorizzazione non effettuata.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If


                If CType(Dom_Alloggio_ERP1.FindControl("txtInterno"), TextBox).Text = "" Then
                    Response.Write("<script>alert('Attenzione...Valorizzare il campo Interno del tab Alloggio! Memorizzazione non effettuata.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If

                'If CType(Dom_Alloggio_ERP1.FindControl("txtPiano"), TextBox).Text = "" Then
                '    Response.Write("<script>alert('Attenzione...Valorizzare il campo Piano del tab Alloggio! Memorizzazione non effettuata.')</script>")
                '    imgStampa.Enabled = False
                '    imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                '    Exit Try
                'End If
                If CType(Dom_Alloggio_ERP1.FindControl("cmbPianoUnita"), DropDownList).SelectedItem.Value = "78" Then
                    Response.Write("<script>alert('Attenzione...Valorizzare il campo Piano del tab Alloggio! Memorizzazione non effettuata.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If



                If CType(Dom_Alloggio_ERP1.FindControl("txtNetta"), TextBox).Text = "" Then
                    Response.Write("<script>alert('Attenzione...Valorizzare il campo Sup.Netta del tab Alloggio! Memorizzazione non effettuata.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If

                If CType(Dom_Alloggio_ERP1.FindControl("cmbAscensore"), DropDownList).SelectedItem.Value = -1 Then
                    Response.Write("<script>alert('Attenzione...Verificare che il campo <Ascensore> sia valorizzato! Risolvere il problema prima di salvare e stampare la domanda.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If


                'If CType(Dom_Alloggio_ERP1.FindControl("txtLocali"), TextBox).Text = "" Then
                '    Response.Write("<script>alert('Attenzione...Valorizzare il campo Numero Locali del tab Alloggio! Memorizzazione non effettuata.')</script>")
                '    imgStampa.Enabled = False
                '    imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                '    Exit Try
                'End If

                If CType(Dom_Alloggio_ERP1.FindControl("txtLocali"), TextBox).Text <> "" And IsNumeric(Replace(CType(Dom_Alloggio_ERP1.FindControl("txtLocali"), TextBox).Text, ",", ".")) = False Then
                    Response.Write("<script>alert('Attenzione...Valorizzare il campo Numero Locali con un valore numerico! Memorizzazione non effettuata.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If



                'If CType(Dom_Alloggio_ERP1.FindControl("cmbTipoRapporto"), DropDownList).SelectedItem.Value = -1 Then
                '    Response.Write("<script>alert('Attenzione...Verificare il campo <Tipologia Rapporto> sia valorizzato! Risolvere il problema prima di salvare e stampare la domanda.')</script>")
                '    imgStampa.Enabled = False
                '    imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                '    Exit Try
                'End If

                If CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text = "" Then
                    Response.Write("<script>alert('Attenzione...Valorizzare il campo Numero Contratto del tab Alloggio! Memorizzazione non effettuata.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If

                If Len(CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text) <> 19 Then
                    Response.Write("<script>alert('Attenzione...Numero Contratto Errato nel tab Alloggio! Memorizzazione non effettuata.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If
            End If


            If CType(Dom_Alloggio_ERP1.FindControl("txtCognome"), TextBox).Text = "" Or CType(Dom_Alloggio_ERP1.FindControl("txtNome"), TextBox).Text = "" Or CType(Dom_Alloggio_ERP1.FindControl("txtCF"), TextBox).Text = "" Then
                Response.Write("<script>alert('Attenzione...Verificare i campi relativi all\'intestatario del contratto siano valorizzati! Risolvere il problema prima di salvare e stampare la domanda.')</script>")
                imgStampa.Enabled = False
                'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                Exit Try
            End If

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbFattaAU"), DropDownList).SelectedItem.Value = -1 Then
                Response.Write("<script>alert('Attenzione...Verificare il campo <Adempimenti Anagrafe Utenza> sia valorizzato! Risolvere il problema prima di salvare e stampare la domanda.')</script>")
                imgStampa.Enabled = False
                'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                Exit Try
            End If

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).Visible = True Then
                If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value <> 3 And CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value <> 5 Then
                    If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedItem.Value = -1 And CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value <> 4 Then
                        Response.Write("<script>alert('Attenzione...Verificare che il campo <Tipologia Domanda> sia valorizzato! Risolvere il problema prima di salvare e stampare la domanda.')</script>")
                        imgStampa.Enabled = False
                        'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                        Exit Try
                    End If
                End If
            Else
                If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Text = "" Then
                    Response.Write("<script>alert('Attenzione...Verificare che il campo <Tipologia Domanda> sia valorizzato! Risolvere il problema prima di salvare e stampare la domanda.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If

            End If


            'If Request.QueryString("GLocat") = "" Then
            '    If CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text <> "" And CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Checked = False Then


            If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = "5" Then
                If Request.QueryString("GLocat") = "" Then
                    If Len(CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text) <> 19 Then 'and CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Checked = False Then
                        Response.Write("<script>alert('Attenzione...Numero Contratto oggetto dello scambio errato nel tab Dichiara! Memorizzazione non effettuata.')</script>")
                        imgStampa.Enabled = False
                        'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                        Exit Try
                    End If
                Else
                    If Len(CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text) <> 19 Then
                        Response.Write("<script>alert('Attenzione...Numero Contratto oggetto dello scambio errato nel tab Dichiara! Memorizzazione non effettuata.')</script>")
                        imgStampa.Enabled = False
                        'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                        Exit Try
                    End If
                End If
            End If

            If CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text = "" Or IsDate(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) = False Then
                Response.Write("<script>alert('Attenzione...Specificare una data di presentazione della richiesta valida! Risolvere il problema prima di salvare e stampare la domanda.')</script>")
                imgStampa.Enabled = False
                'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                Exit Try
            End If

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = -1 Then
                Response.Write("<script>alert('Attenzione...Verificare che il campo <Motivo Presentazione Domanda> sia valorizzato! Risolvere il problema prima di salvare e stampare la domanda.')</script>")
                imgStampa.Enabled = False
                'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                Exit Try
            End If

            'If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedItem.Value = 0 And Val(CType(Dom_Alloggio_ERP1.FindControl("txtLocali"), TextBox).Text) >= iNumPersone Then
            '    Response.Write("<script>alert('Attenzione...In caso di sovraffollamento il numero dei locali deve essere minore del numero dei componenti! Risolvere il problema prima di salvare e stampare la domanda.')</script>")
            '    imgStampa.Enabled = False
            '    imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
            '    Exit Try
            'End If

            'If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedItem.Value = 1 And Val(CType(Dom_Alloggio_ERP1.FindControl("txtLocali"), TextBox).Text) <= iNumPersone Then
            '    Response.Write("<script>alert('Attenzione...In caso di sottoutilizzo il numero dei locali deve essere maggiore del numero dei componenti! Risolvere il problema prima di salvare e stampare la domanda.')</script>")
            '    imgStampa.Enabled = False
            '    imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
            '    Exit Try
            'End If


            'If iNumPersone <= Val(CType(Dom_Alloggio_ERP1.FindControl("txtLocali"), TextBox).Text) And CType(Dom_Abitative_1_1.FindControl("cmbA4"), DropDownList).SelectedItem.Value > 0 Then
            '    Response.Write("<script>alert('Attenzione...se il numero dei componenti è minore o uguale al numero di locali non può essere dato il punteggio per sovraffolammento!Risolvere il problema prima di salvare e stampare la domanda.')</script>")
            '    imgStampa.Enabled = False
            '    imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
            '    CType(Dom_Abitative_1_1.FindControl("Alert15"), Image).Visible = True
            '    Exit Try
            'Else
            '    CType(Dom_Abitative_1_1.FindControl("Alert15"), Image).Visible = False
            'End If


            'ABITATIVE 2

            If CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text <> "" Then
                If par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) < par.AggiustaData(par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtDecorrenza"), TextBox).Text)) Then
                    Response.Write("<script>alert('Attenzione...La data di presentazione della richiesta deve essere successiva alla data di decorrenza del rapporto.')</script>")
                    imgStampa.Enabled = False
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    Exit Try
                End If
            End If



            S = ""
            If VerificaDati(S) = False Then
                Response.Write("<script>alert('Attenzione...Sono state riscontrate anomalie nella domanda. La domanda potra essere comunque salvata e stampata!')</script>")
                If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = 3 Then
                    imgStampa.Enabled = True
                    'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                End If
            End If


            If Ccodicetrovato.Value <> "" Then
                CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text = Trim(Ccodicetrovato.Value)
                Ccodicetrovato.Value = ""
            End If

            If Ucodicetrovato.Value <> "" Then
                CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text = Ucodicetrovato.Value
                Ucodicetrovato.Value = ""
            End If

            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessDOMANDA), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans


            '************* 16/12/2011 INSERIMENTO/CANCELL. OSPITI NELLA TABELLA SEPA.COMP_NUCLEO_OSPITI_VSA
            If tipoRichiesta.Value = "7" Then
                Dim idOspiti As String = ""
                Dim listaOspiti As String = ""
                Dim inserOspite As Boolean = False

                If Dom_Ospiti1.ProgrDaCancellare <> "" Then
                    par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_OSPITI_VSA WHERE ID_DOMANDA =" & lIdDomanda & Dom_Ospiti1.ProgrDaCancellare & ")"
                    Dim myReaderN As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    While myReaderN.Read
                        par.cmd.CommandText = "DELETE FROM COMP_NUCLEO_OSPITI_VSA WHERE ID=" & myReaderN("ID")
                        par.cmd.ExecuteNonQuery()
                    End While
                    myReaderN.Close()
                End If

                'if CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items.Count > 0 Then
                If CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items.Count > 0 Then
                    'For i As Integer = 0 To CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items.Count - 1
                    For i As Integer = 0 To CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items.Count - 1
                        'par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_OSPITI_VSA WHERE ID_DOMANDA=" & lIdDomanda & " AND ID=" & CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items(i).Cells(0).Text().Trim()
                        par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_OSPITI_VSA WHERE ID_DOMANDA=" & lIdDomanda & " AND ID=" & CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items(i).Value
                        Dim myReader0 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReader0.Read Then

                            If par.IfEmpty(CType(Dom_Ospiti1.FindControl("txtIDospite"), HiddenField).Value, -1) = myReader0("ID") Then
                                par.cmd.CommandText = "UPDATE COMP_NUCLEO_OSPITI_VSA SET " _
                                        & "COGNOME='" & par.PulisciStrSql(par.RicavaTesto(CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items(i).Text, 1, 25)) & "'," _
                                        & "NOME='" & par.PulisciStrSql(par.RicavaTesto(CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items(i).Text, 27, 25)) & "'," _
                                        & "COD_FISCALE='" & par.RicavaTesto(CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items(i).Text, 64, 16) & "'," _
                                        & "DATA_INIZIO_OSPITE='" & par.AggiustaData(par.RicavaTesto(CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items(i).Text, 85, 11)) & "'," _
                                        & "DATA_FINE_OSPITE='" & par.AggiustaData(par.RicavaTesto(CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items(i).Text, 102, 11)) & "'," _
                                        & "DATA_NASC='" & par.AggiustaData(par.RicavaTesto(CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items(i).Text, 52, 11)) & "'," _
                                        & "ID_TIPO_IND_RES_DNTE=" & CType(Dom_Ospiti1.FindControl("txtidTipoVIA"), HiddenField).Value & "," _
                                        & "IND_RES_DNTE='" & par.PulisciStrSql(CType(Dom_Ospiti1.FindControl("txtVIA"), HiddenField).Value.ToUpper) & "'," _
                                        & "CIVICO_RES_DNTE='" & par.PulisciStrSql(CType(Dom_Ospiti1.FindControl("txtCIVICO"), HiddenField).Value) & "'," _
                                        & "COMUNE_RES_DNTE='" & par.PulisciStrSql(CType(Dom_Ospiti1.FindControl("txtCOMUNE"), HiddenField).Value.ToUpper) & "'," _
                                        & "CAP_RES_DNTE='" & CType(Dom_Ospiti1.FindControl("txtCAP"), HiddenField).Value & "'," _
                                        & "CARTA_I='" & CType(Dom_Ospiti1.FindControl("txtDOCIDENT"), HiddenField).Value.ToUpper & "'," _
                                        & "CARTA_I_DATA='" & par.AggiustaData(CType(Dom_Ospiti1.FindControl("txtDATADOC"), HiddenField).Value) & "', " _
                                        & "CARTA_I_RILASCIATA='" & par.PulisciStrSql(CType(Dom_Ospiti1.FindControl("txtRILASCIO"), HiddenField).Value.ToUpper) & "', " _
                                        & "PERMESSO_SOGG_N='" & CType(Dom_Ospiti1.FindControl("txtSOGGIORNO"), HiddenField).Value.ToUpper & "', " _
                                        & "PERMESSO_SOGG_DATA='" & par.AggiustaData(CType(Dom_Ospiti1.FindControl("txtDATASogg"), HiddenField).Value) & "', " _
                                        & "FL_REFERENTE='" & CType(Dom_Ospiti1.FindControl("txtREFERENTE"), HiddenField).Value & "' " _
                                        & "WHERE ID=" & myReader0("ID")

                                '& "COGNOME='" & par.PulisciStrSql(CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items(i).Cells(1).Text().Trim()) & "'," _
                                '& "NOME='" & par.PulisciStrSql(CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items(i).Cells(2).Text().Trim()) & "'," _
                                '& "COD_FISCALE='" & CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items(i).Cells(4).Text().Trim() & "'," _
                                '& "DATA_INIZIO_OSPITE='" & par.AggiustaData(CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items(i).Cells(5).Text().Trim()) & "'," _
                                '& "DATA_FINE_OSPITE='" & par.AggiustaData(CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items(i).Cells(6).Text().Trim()) & "'," _
                                '& "DATA_NASC='" & par.AggiustaData(CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items(i).Cells(3).Text().Trim()) & "'," _

                                par.cmd.ExecuteNonQuery()
                            End If
                        Else
                            par.cmd.CommandText = "select seq_comp_nucleo_ospiti_vsa.nextval from dual"
                            Dim lettore0 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
                            If lettore0.Read Then
                                idOspiti = lettore0(0)
                            End If
                            lettore0.Close()
                            par.cmd.CommandText = "INSERT INTO COMP_NUCLEO_OSPITI_VSA (ID,ID_DOMANDA,DATA_AGG,COGNOME,NOME,COD_FISCALE,DATA_INIZIO_OSPITE,DATA_FINE_OSPITE,DATA_NASC,ID_TIPO_IND_RES_DNTE,IND_RES_DNTE,CIVICO_RES_DNTE,COMUNE_RES_DNTE,CAP_RES_DNTE,CARTA_I,CARTA_I_DATA,CARTA_I_RILASCIATA,PERMESSO_SOGG_N,PERMESSO_SOGG_DATA,FL_REFERENTE) " _
                                & "VALUES (" & idOspiti & "," & lIdDomanda & ",'" & Format(Now, "yyyyMMdd") & "','" _
                                & par.PulisciStrSql(par.RicavaTesto(CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items(i).Text, 1, 25)) & "','" & par.PulisciStrSql(par.RicavaTesto(CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items(i).Text, 27, 25)) & "','" _
                                & par.RicavaTesto(CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items(i).Text, 64, 16) & "','" & par.AggiustaData(par.RicavaTesto(CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items(i).Text, 85, 11)) & "','" _
                                & par.AggiustaData(par.RicavaTesto(CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items(i).Text, 102, 11)) & "','" & par.AggiustaData(par.RicavaTesto(CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items(i).Text, 52, 11)) & "'," _
                                & "'" & CType(Dom_Ospiti1.FindControl("txtidTipoVIA"), HiddenField).Value & "','" & par.PulisciStrSql(CType(Dom_Ospiti1.FindControl("txtVIA"), HiddenField).Value.ToUpper) & "'," _
                                & "'" & par.PulisciStrSql(CType(Dom_Ospiti1.FindControl("txtCIVICO"), HiddenField).Value.ToUpper) & "','" & par.PulisciStrSql(CType(Dom_Ospiti1.FindControl("txtCOMUNE"), HiddenField).Value.ToUpper) & "'," _
                                & "'" & CType(Dom_Ospiti1.FindControl("txtCAP"), HiddenField).Value & "','" & CType(Dom_Ospiti1.FindControl("txtDOCIDENT"), HiddenField).Value.ToUpper & "'," _
                                & "'" & par.AggiustaData(CType(Dom_Ospiti1.FindControl("txtDATADOC"), HiddenField).Value) & "','" & par.PulisciStrSql(CType(Dom_Ospiti1.FindControl("txtRILASCIO"), HiddenField).Value.ToUpper) & "'," _
                                & "'" & CType(Dom_Ospiti1.FindControl("txtSOGGIORNO"), HiddenField).Value.ToUpper & "','" & par.AggiustaData(CType(Dom_Ospiti1.FindControl("txtDATASogg"), HiddenField).Value) & "'," _
                                & "'" & CType(Dom_Ospiti1.FindControl("txtREFERENTE"), HiddenField).Value & "')"

                            '& par.PulisciStrSql(CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items(i).Cells(1).Text().Trim()) & "','" & par.PulisciStrSql(CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items(i).Cells(2).Text().Trim()) & "','" _
                            '& CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items(i).Cells(4).Text().Trim() & "','" & par.AggiustaData(CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items(i).Cells(5).Text().Trim()) & "','" _
                            '& par.AggiustaData(CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items(i).Cells(6).Text().Trim()) & "','" & par.AggiustaData(CType(Dom_Ospiti1.FindControl("DataGridOspiti"), DataGrid).Items(i).Cells(3).Text().Trim()) & "'," _

                            par.cmd.ExecuteNonQuery()
                            inserOspite = True
                        End If
                    Next
                    CType(Dom_Ospiti1.FindControl("listbox1"), ListBox).Items.Clear()
                    par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_OSPITI_VSA WHERE ID_DOMANDA = " & lIdDomanda & " ORDER BY DATA_AGG DESC"
                    Dim myReaderOspiti As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    While myReaderOspiti.Read
                        listaOspiti = par.MiaFormat(par.IfNull(myReaderOspiti("COGNOME"), ""), 25) & " " & par.MiaFormat(par.IfNull(myReaderOspiti("NOME"), ""), 25) & " " & par.MiaFormat(par.FormattaData(myReaderOspiti("DATA_NASC")), 11) & "" & par.MiaFormat(par.IfNull(myReaderOspiti("COD_FISCALE"), ""), 22) _
                            & par.MiaFormat(par.FormattaData(par.IfNull(myReaderOspiti("DATA_INIZIO_OSPITE"), "")), 16) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReaderOspiti("DATA_FINE_OSPITE"), "")), 10)

                        CType(Dom_Ospiti1.FindControl("ListBox1"), ListBox).Items.Add(New ListItem(listaOspiti, myReaderOspiti("ID")))
                    End While
                    myReaderOspiti.Close()
                    'CaricaOspiti()
                Else
                    Response.Write("<script>alert('Attenzione...nessun ospite è stato inserito. Memorizzazione non effettuata!')</script>")
                End If

                ',,,,,,,,,,,,,,,,,,, 20/12/2011 EVENTO PER OSPITI ,,,,,,,,,,,,,,,,,,,
                If inserOspite = True Then

                    par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                                & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                                & "','F195','','')"
                    par.cmd.ExecuteNonQuery()
                End If
                ',,,,,,,,,,,,,,,,,,, 20/12/2011 FINE EVENTO PER OSPITI ,,,,,,,,,,,,,,,,,,,
            End If
            '************* 16/12/2011 fine INSERIMENTO OSPITI NELLA TABELLA SEPA.COMP_NUCLEO_OSPITI_VSA


            par.cmd.CommandText = "SELECT COUNT(COMP_NUCLEO_OSPITI_VSA.ID) AS NUM_REFE FROM COMP_NUCLEO_OSPITI_VSA,DOMANDE_BANDO_VSA WHERE COMP_NUCLEO_OSPITI_VSA.ID_DOMANDA = DOMANDE_BANDO_VSA.ID AND " _
            & "DOMANDE_BANDO_VSA.ID =" & lIdDomanda & " AND FL_REFERENTE = 1 GROUP BY (FL_REFERENTE)"
            Dim myReaderR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderR.Read Then
                If myReaderR("NUM_REFE") > 1 Then
                    Response.Write("<script>alert('Attenzione...il nuovo nucleo non può avere più di un referente!')</script>")
                    Exit Try
                End If
            End If
            myReaderR.Close()





            '****** controllo se è stato aggiunto un componente *****
            If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = "2" Then
                If CType(Dom_Decisioni1.FindControl("ChkDecidi"), CheckBox).Checked = True Then
                    par.cmd.CommandText = "SELECT * FROM NUOVI_COMP_NUCLEO_VSA,COMP_NUCLEO_VSA WHERE COMP_NUCLEO_VSA.ID = " _
                    & "NUOVI_COMP_NUCLEO_VSA.ID_COMPONENTE and ID_DICHIARAZIONE=" & lIdDichiarazione
                    Dim myReaderN As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderN.Read = False Then
                        Response.Write("<script>alert('ATTENZIONE...nella dichiarazione non risultano esser stati aggiunti nuovi componenti. Memorizzazione non effettuata!')</script>")
                        Exit Try
                    End If
                    myReaderN.Close()
                End If
            End If
            '****** fine controllo se è stato aggiunto un componente *****


            If CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text <> "" Then
                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA,SISCOM_MI.UNITA_CONTRATTUALE WHERE RAPPORTI_UTENZA.ID=UNITA_CONTRATTUALE.ID_CONTRATTO AND ID_UNITA_PRINCIPALE IS NULL AND COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
                Dim myReaderN As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderN.Read Then
                    If par.IfNull(myReaderN("COD_UNITA_IMMOBILIARE"), "") <> CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text Then
                        Response.Write("<script>alert('ATTENZIONE...Verificare il codice dell\'alloggio. Memorizzazione non effettuata!')</script>")
                        Exit Try
                    End If
                End If
                myReaderN.Close()
            End If

            If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = "8" Then
                If CType(Dom_Decisioni1.FindControl("ChkDecidi"), CheckBox).Checked = True Then
                    par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_VSA WHERE GRADO_PARENTELA IS NULL AND " _
                    & "ID_DICHIARAZIONE=" & lIdDichiarazione
                    Dim myReaderN As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderN.Read = True Then
                        Response.Write("<script>alert('ATTENZIONE...nella dichiarazione non risulta specificato il grado di parentela per tutti i componenti. Memorizzazione non effettuata!')</script>")
                        Exit Try
                    End If
                    myReaderN.Close()
                End If
            End If

            If Request.QueryString("GLocat") = "" Then
                If CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text <> "" Then 'And CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Checked = False Then
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE upper(COD_CONTRATTO)='" & UCase(CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text) & "'"
                    Dim myReader112 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader112.HasRows = False Then
                        Response.Write("<script>alert('Attenzione...Il codice contratto oggetto dello scambio non è presente nel sistema. Il campo sarà azzerato ma la domanda sarà comunque salvata!')</script>")
                        imgStampa.Enabled = True
                        'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                        CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text = ""
                    Else
                        If myReader112.Read Then
                            If par.IfNull(myReader112("COD_TIPOLOGIA_CONTR_LOC"), "") <> "ERP" Then
                                Response.Write("<script>alert('Attenzione...Il contratto oggetto dello scambio deve essere di tipo ERP! Il campo sarà azzerato ma la domanda sarà comunque salvata!')</script>")
                                imgStampa.Enabled = True
                                'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                                CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text = ""
                            End If
                        End If
                    End If
                    myReader112.Close()
                ElseIf CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text <> "" Then 'And CType(Dom_Dichiara_Cambi1.FindControl("chkAler"), CheckBox).Checked = True Then
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE upper(COD_CONTRATTO)='" & UCase(CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text) & "'"
                    Dim myReaderCOD As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderCOD.Read Then
                        Response.Write("<script>alert('Attenzione...Il codice contratto oggetto dello scambio non appartiene al Gestore!')</script>")
                        imgStampa.Enabled = True
                        'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                    End If
                    myReaderCOD.Close()
                End If
            Else
                If CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text <> "" Then
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE upper(COD_CONTRATTO)='" & UCase(CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text) & "'"
                    Dim myReader112 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader112.HasRows = False Then
                        Response.Write("<script>alert('Attenzione...Il codice contratto oggetto dello scambio non è stato trovato nella banca dati. Il campo sarà azzerato ma la domanda sarà comunque salvata!')</script>")
                        imgStampa.Enabled = True
                        'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                        CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text = ""
                    Else
                        If myReader112.Read Then
                            If par.IfNull(myReader112("COD_TIPOLOGIA_CONTR_LOC"), "") <> "ERP" Then
                                Response.Write("<script>alert('Attenzione...Il contratto oggetto dello scambio deve essere di tipo ERP! Il campo sarà azzerato ma la domanda sarà comunque salvata!')</script>")
                                imgStampa.Enabled = True
                                'imgStampa.ImageUrl = "../NuoveImm/Img_No_Stampa.png"
                                CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text = ""
                            End If
                        End If
                    End If
                    myReader112.Close()
                End If
            End If



            '***** 23/11/11 MTeresa CONTROLLO SE CONV_EX_ART20 COMPONENTI > 75 ANNI E/O DISABILI ******
            'If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = "2" Then
            '    Dim condizioneNO As Integer = 0
            '    Dim condizioneSI As Integer = 0
            '    If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedItem.Value = "5" Then
            '        par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE=" & lIdDichiarazione
            '        Dim myReaderEta As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            '        While myReaderEta.Read
            '            If par.RicavaEta(par.IfNull(myReaderEta("DATA_NASCITA"), Format(Now, "yyyyMMdd"))) <= 75 And par.IfNull(myReaderEta("PERC_INVAL"), "0") < 66 Then
            '                condizioneNO = 1
            '            Else
            '                condizioneSI = 1
            '            End If
            '        End While
            '        myReaderEta.Close()
            '    End If
            '    If condizioneNO = 1 And condizioneSI = 0 Then
            '        Response.Write("<script>alert('Attezione! Per la tipologia di ampliamento richiesta è necessaria la presenza di un " _
            '        & "componente \n con età maggiore di 75 o con percentuale di invalidità pari o superiore al 66%.')</script>")
            '        Exit Try
            '    End If
            'End If
            '***** FINE CONTROLLO SE CONV_EX_ART20 COMPONENTI > 75 ANNI E/O DISABILI ******


            '***** 02/12/11 MTeresa CONTROLLO COINTESTATARIO ******
            If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = "1" Then
                If par.IfEmpty(CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedItem.Value, "") <> "8" Then
                    Dim idc As Long = 0
                    par.cmd.CommandText = "SELECT id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
                    Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderX1.Read Then
                        idc = myReaderX1("id")
                    End If
                    myReaderX1.Close()

                    par.cmd.CommandText = "select * from siscom_mi.bol_bollette where id_tipo = 4 and id_contratto = " & idc & " and importo_totale <> NVL(importo_pagato,0)"
                    Dim lettMorosita As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If lettMorosita.Read Then
                        CType(Dom_Dichiara_Cambi1.FindControl("lblCointest"), Label).Visible = True
                        CType(Dom_Dichiara_Cambi1.FindControl("cmbSiNo"), DropDownList).Visible = True
                    End If
                    lettMorosita.Close()
                End If
            End If
            '***** 02/12/11 MTeresa FINE CONTROLLO COINTESTATARIO ******


            '10/02/2012 MTeresa CONTROLLO DATA PRESENTAZIONE E DATA EVENTO
            'If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = "3" Then

            '    par.cmd.CommandText = "SELECT ANNO_SIT_ECONOMICA FROM DICHIARAZIONI_VSA WHERE ID=" & lIdDichiarazione
            '    Dim da0 As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            '    Dim dt0 As New Data.DataTable
            '    da0.Fill(dt0)
            '    da0.Dispose()

            '    ControlloDataPresent(dt0.Rows(0).Item("ANNO_SIT_ECONOMICA"), CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue, CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text)

            '    If CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Visible = True Then
            '        ControlloDataEvento(dt0.Rows(0).Item("ANNO_SIT_ECONOMICA"), CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue, CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text)
            '    End If
            'End If
            '10/02/2012 MTeresa FINE CONTROLLO DATA PRESENTAZIONE E DATA EVENTO



            'If par.OracleConn.State = Data.ConnectionState.Closed Then
            '    par.OracleConn.Open()
            'End If

            Dim sStringaSql As String


            'If CType(Dom_Dichiara_Cambi1.FindControl("txtPgERP"), TextBox).Text <> "" Then
            '    par.cmd.CommandText = "SELECT * FROM DOMANDE_BANDO WHERE PG='" & par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtPgERP"), TextBox).Text) & "'"
            '    Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            '    If myReader1.Read = False Then
            '        Response.Write("<script>alert('Attenzione...Il protocollo della domanda inserita nel tab <Dichiara> non è stato trovato! La domanda sarà comunque salvata/stampata.')</script>")
            '        CType(Dom_Dichiara_Cambi1.FindControl("txtPgERP"), TextBox).Text = ""
            '    Else
            '        par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO WHERE ID_DICHIARAZIONE=" & myReader1("ID_DICHIARAZIONE") & " AND COD_FISCALE='" & par.PulisciStrSql(CType(Dom_Richiedente1.FindControl("txtcf"), TextBox).Text) & "'"
            '        Dim myReader2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            '        If myReader2.Read = False Then
            '            Response.Write("<script>alert('Attenzione...Il protocollo della domanda inserita nel tab <Dichiara> è stato trovato ma non risulta il codice fiscale inserito nel tab RICHIEDENTE! La domanda sarà comunque salvata/stampata.')</script>")
            '            CType(Dom_Dichiara_Cambi1.FindControl("txtPgERP"), TextBox).Text = ""
            '        End If
            '        myReader2.Close()
            '    End If
            '    myReader1.Close()
            'End If


            'txtDataPrRichiesta
            contrattodialer.Value = "0"
            If CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text <> "" Then
                par.cmd.CommandText = "SELECT DATA_STIPULA FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "'"
                Dim myReader11 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader11.Read Then
                    If par.IfNull(myReader11("data_stipula"), "0") >= "20091001" Then
                        contrattodialer.Value = "1"
                    End If
                End If
            End If

            sStringaSql = "UPDATE DOMANDE_BANDO_VSA SET DATA_PRESENTAZIONE='" & par.AggiustaData(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text) & "',TIPO_U=" & CType(Dom_Alloggio_ERP1.FindControl("cmbTipoU"), DropDownList).SelectedItem.Value & ", ID_BANDO=" & lIndice_Bando _
                      & ",ID_DICHIARAZIONE=" & lIdDichiarazione & "," _
                      & " PROGR_COMPONENTE=" & lProgr _
                      & ",PRESSO_REC_DNTE='" & par.PulisciStrSql(CType(Me.Page.FindControl("txtPresso"), TextBox).Text) _
                      & "',ID_LUOGO_REC_DNTE=" & CType(Me.Page.FindControl("cmbComuneRec"), DropDownList).SelectedItem.Value _
                      & ",ID_TIPO_IND_REC_DNTE=" & CType(Me.Page.FindControl("cmbTipoIRec"), DropDownList).SelectedItem.Value _
                      & ",IND_REC_DNTE='" & par.PulisciStrSql(CType(Me.Page.FindControl("txtIndirizzoRec"), TextBox).Text) _
                      & "',CAP_REC_DNTE='" & par.PulisciStrSql(CType(Me.Page.FindControl("txtCAPRec"), TextBox).Text) & "',CIVICO_REC_DNTE='" & par.PulisciStrSql(CType(Me.Page.FindControl("txtCivicoRec"), TextBox).Text) _
                      & "',TELEFONO_REC_DNTE='" & par.PulisciStrSql(CType(Me.Page.FindControl("txtTelRec"), TextBox).Text) _
                      & "',PERIODO_RES=" & CType(Me.Page.FindControl("cmbResidenza"), DropDownList).SelectedItem.Value _
                      & ",PG='" & lblPG.Text
            sStringaSql = sStringaSql _
                       & "',DATA_PG='" & par.AggiustaData(txtDataPG.Text) _
                       & "',FL_FAM_1='" _
                       & "',FL_FAM_2='" _
                       & "',FL_FAM_3='" _
                       & "',FL_FAM_4='" _
                       & "',FL_FATTA_ERP='0" _
                       & "',FL_FATTA_AU='" & CType(Dom_Dichiara_Cambi1.FindControl("cmbFattaAU"), DropDownList).SelectedItem.Value _
                       & "',PG_FATTA_ERP='0" _
                       & "',FL_FAI_ERP='0"

            sStringaSql = sStringaSql _
                       & "',ID_CAUSALE_DOMANDA=" & par.IfEmpty(CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue, -1) _
                       & ",ID_motivo_DOMANDA=" & CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value _
                       & ",FL_PROFUGO='0" _
                       & "',ANNO_RIF_CANONE='" _
                       & "',IMPORTO_CANONE=NULL"
            sStringaSql = sStringaSql _
                       & ",ANNO_RIF_SPESE_ACC='" _
                       & "',IMPORTO_SPESE_ACC=NULL" _
                       & ",FL_MOROSITA='" _
                       & "',NOTE_WEB='" & par.PulisciStrSql(CType(Dom_Note1.FindControl("txtNote"), TextBox).Text) _
                       & "',COD_CONTRATTO_SCAMBIO='" & CType(Dom_Dichiara_Cambi1.FindControl("txtCodContrattoScambio"), TextBox).Text & "',"
            sStringaSql = sStringaSql _
                       & "REQUISITO1='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR1"), CheckBox).Checked) _
                       & "',REQUISITO2='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR2"), CheckBox).Checked) _
                       & "',REQUISITO3='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR3"), CheckBox).Checked) _
                       & "',REQUISITO4='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR4"), CheckBox).Checked) _
                       & "',REQUISITO5='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR5"), CheckBox).Checked) _
                       & "',REQUISITO7='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR6"), CheckBox).Checked) _
                       & "',REQUISITO8='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR7"), CheckBox).Checked) _
                       & "',REQUISITO9='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR8"), CheckBox).Checked) _
                       & "',REQUISITO10='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR9"), CheckBox).Checked) _
                       & "',REQUISITO11='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR10"), CheckBox).Checked) _
                       & "',REQUISITO12='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR11"), CheckBox).Checked) _
                       & "',REQUISITO13='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR12"), CheckBox).Checked) _
                       & "',REQUISITO14='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR13"), CheckBox).Checked) _
                       & "',REQUISITO15='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR14"), CheckBox).Checked) _
                       & "',REQUISITO16='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR15"), CheckBox).Checked) _
                       & "',REQUISITO17='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR16"), CheckBox).Checked) _
                       & "',REQUISITO18='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR17"), CheckBox).Checked) _
                       & "',REQUISITO19='" & Valore01(CType(Dom_Requisiti_Cambi1.FindControl("chR18"), CheckBox).Checked)
            sStringaSql = sStringaSql _
                       & "',ID_PARA_0=-1," _
                       & "ID_PARA_1=" & "-1" & "," _
                       & "ID_PARA_2=" & "-1" & "," _
                       & "ID_PARA_3=" & "-1" & "," _
                       & "ID_PARA_4=" & "-1" & "," _
                       & "ID_PARA_5=" & "-1" & "," _
                       & "ID_PARA_6=" & "-1" & "," _
                       & "ID_PARA_7=" & "-1" & "," _
                       & "ID_PARA_8=" & "-1" & "," _
                       & "ID_PARA_9=" & "-1" & "," _
                       & "ID_PARA_10=" & "-1" & "," _
                       & "ID_PARA_11=" & "-1" & "," _
                       & "ID_PARA_12=" & "-1" & "," _
                       & "ID_PARA_13=" & "-1" & "," _
                       & "ID_PARA_14=" & "-1" & "," _
                       & "ID_PARA_15=" & "-1" & " " _
                       & ",FL_MOROSITA_G='" & "0" & "'," _
                       & "FL_AFF_ONEROSO='" & "0" _
                       & "',CARTA_I='" & par.PulisciStrSql(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtCINum"), TextBox).Text)) & "'," _
                       & "CARTA_I_DATA='" & par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtCIData"), TextBox).Text)) & "'," _
                       & "CARTA_I_RILASCIATA='" & par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtCIRilascio"), TextBox).Text) & "'," _
                       & "PERMESSO_SOGG_N='" & par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtPSNum"), TextBox).Text) & "'," _
                       & "PERMESSO_SOGG_DATA='" & par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtPSData"), TextBox).Text)) & "'," _
                       & "PERMESSO_SOGG_SCADE='" & par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtPSScade"), TextBox).Text)) & "'," _
                       & "PERMESSO_SOGG_RINNOVO='" & par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtPSRinnovo"), TextBox).Text)) & "'," _
                       & "CARTA_SOGG_N='" & par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtCSNum"), TextBox).Text) & "'," _
                       & "CARTA_SOGG_DATA='" & par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtCSData"), TextBox).Text)) & "'," _
                       & "DATA_EVENTO='" & par.AggiustaData(par.PulisciStrSql(CType(Dom_Dichiara_Cambi1.FindControl("txtDataEvento"), TextBox).Text)) & "'," _
                       & "TIPO_DOCUMENTO='" & CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoDocumento"), DropDownList).SelectedItem.Value & "'," _
                       & "REDDITO_ISEE=" & par.VirgoleInPunti(CDec(lblISBAR.Text)) _
                       & "WHERE ID = " & lIdDomanda
            par.cmd.CommandText = sStringaSql
            par.cmd.ExecuteNonQuery()

            Dim ASCENSORE As String = ""
            If CType(Dom_Alloggio_ERP1.FindControl("cmbascensore"), DropDownList).SelectedItem.Value = -1 Then
                ASCENSORE = "NULL"
            Else
                ASCENSORE = "'" & CType(Dom_Alloggio_ERP1.FindControl("cmbascensore"), DropDownList).SelectedItem.Value & "'"
            End If

            'par.cmd.CommandText = "UPDATE DOMANDE_VSA_ALLOGGIO SET COMUNE='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtCOMUNE"), TextBox).Text) _
            '                    & "',INDIRIZZO='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtIndirizzo"), TextBox).Text) _
            '                    & "',CAP='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtCAP"), TextBox).Text) _
            '                    & "',CIVICO='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtCivico"), TextBox).Text) _
            '                    & "',INTERNO='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtInterno"), TextBox).Text) _
            '                    & "',SCALA='" & CType(Dom_Alloggio_ERP1.FindControl("txtScala"), TextBox).Text _
            '                    & "',PIANO='" & CType(Dom_Alloggio_ERP1.FindControl("txtPiano"), TextBox).Text _
            '                    & "',SUP_NETTA='" & CType(Dom_Alloggio_ERP1.FindControl("txtNetta"), TextBox).Text _
            '                    & "',N_LOCALI='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtLocali"), TextBox).Text) _
            '                    & "',Num_Contratto='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text) _
            '                    & " ',DEC_CONTRATTO='" & par.AggiustaData(par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtDecorrenza"), TextBox).Text)) _
            '                    & "',id_tipo_gestore=9" _
            '                    & ",id_tipo_contratto=0" _
            '                    & ",id_tipo_rapporto=NULL" _
            '                    & ",ASCENSORE=" & ASCENSORE _
            '                    & ",ASS_TEMPORANEA='0" _
            '                    & "',COD_UNITA_IMMOBILIARE='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text) & "' WHERE ID_DOMANDA=" & lIdDomanda

            par.cmd.CommandText = "UPDATE DOMANDE_VSA_ALLOGGIO SET COMUNE='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtCOMUNE"), TextBox).Text) _
                                & "',INDIRIZZO='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtIndirizzo"), TextBox).Text) _
                                & "',CAP='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtCAP"), TextBox).Text) _
                                & "',CIVICO='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtCivico"), TextBox).Text) _
                                & "',INTERNO='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtInterno"), TextBox).Text) _
                                & "',SCALA='" & CType(Dom_Alloggio_ERP1.FindControl("txtScala"), TextBox).Text _
                                & "',PIANO='" & CType(Dom_Alloggio_ERP1.FindControl("cmbPianoUnita"), DropDownList).SelectedItem.Value _
                                & "',SUP_NETTA='" & CType(Dom_Alloggio_ERP1.FindControl("txtNetta"), TextBox).Text _
                                & "',N_LOCALI='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtLocali"), TextBox).Text) _
                                & "',Num_Contratto='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text) _
                                & "',DEC_CONTRATTO='" & par.AggiustaData(par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtDecorrenza"), TextBox).Text)) _
                                & "',id_tipo_gestore=9" _
                                & ",id_tipo_contratto=0" _
                                & ",id_tipo_rapporto=NULL" _
                                & ",ASCENSORE=" & ASCENSORE _
                                & ",ASS_TEMPORANEA='0" _
                                & "',COD_UNITA_IMMOBILIARE='" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtCodiceUnita"), TextBox).Text) & "' WHERE ID_DOMANDA=" & lIdDomanda



            par.cmd.ExecuteNonQuery()

            If CType(Dom_Alloggio_ERP1.FindControl("txtCognome"), TextBox).Text <> "" Then
                par.cmd.CommandText = "DELETE FROM INTESTATARI_CONTRATTI_VSA WHERE ID_DOMANDA=" & lIdDomanda
                par.cmd.ExecuteNonQuery()
                If CType(Dom_Alloggio_ERP1.FindControl("cmbNazioneNas"), DropDownList).Text = "ITALIA" Then

                    par.cmd.CommandText = "INSERT INTO INTESTATARI_CONTRATTI_VSA (ID_DOMANDA,COGNOME,NOME,SESSO,COD_FISCALE,ID_LUOGO_NAS_DNTE,DATA_NASCITA_DNTE) VALUES (" & lIdDomanda & ",'" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtCognome"), TextBox).Text) & "','" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtNome"), TextBox).Text) & "','" & CType(Dom_Alloggio_ERP1.FindControl("cmbSesso"), DropDownList).SelectedItem.Text & "','" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtCF"), TextBox).Text) & "'," & CType(Dom_Alloggio_ERP1.FindControl("cmbComuneNas"), DropDownList).SelectedItem.Value & ",'" & par.AggiustaData(CType(Dom_Alloggio_ERP1.FindControl("txtDataNascita"), TextBox).Text) & "')"
                    par.cmd.ExecuteNonQuery()
                Else

                    par.cmd.CommandText = "INSERT INTO INTESTATARI_CONTRATTI_VSA (ID_DOMANDA,COGNOME,NOME,SESSO,COD_FISCALE,ID_LUOGO_NAS_DNTE,DATA_NASCITA_DNTE) VALUES (" & lIdDomanda & ",'" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtCognome"), TextBox).Text) & "','" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtNome"), TextBox).Text) & "','" & CType(Dom_Alloggio_ERP1.FindControl("cmbSesso"), DropDownList).SelectedItem.Text & "','" & par.PulisciStrSql(CType(Dom_Alloggio_ERP1.FindControl("txtCF"), TextBox).Text) & "'," & CType(Dom_Alloggio_ERP1.FindControl("cmbNazioneNas"), DropDownList).SelectedItem.Value & ",'" & par.AggiustaData(CType(Dom_Alloggio_ERP1.FindControl("txtDataNascita"), TextBox).Text) & "')"
                    par.cmd.ExecuteNonQuery()
                End If
            End If

            '****************************peppe modify
            'par.cmd.CommandText = "DELETE FROM VSA_DOC_MANCANTi WHERE ID_DICHIARAZIONE=" & lIdDichiarazione
            'par.cmd.ExecuteNonQuery()

            'For i = 0 To CType(Dom_Note1.FindControl("listbox1"), ListBox).Items.Count - 1
            '    par.cmd.CommandText = "INSERT INTO VSA_DOC_MANCANTI (ID_DICHIARAZIONE,ID_DOC,DESCRIZIONE) VALUES (" & lIdDichiarazione & "," & CType(Dom_Note1.FindControl("listbox1"), ListBox).Items(i).Value & ",'" & par.PulisciStrSql(CType(Dom_Note1.FindControl("listbox1"), ListBox).Items(i).Text) & "')"
            '    par.cmd.ExecuteNonQuery()
            '    docMancanti = True
            'Next


            '****** 21/12/2011 Modifica DOC MANCANTI per evento *******
            Dim dt As New Data.DataTable

            If Dom_Note1.idCOMPMOB <> "" Then
                par.cmd.CommandText = "SELECT * FROM VSA_DOC_MANCANTI WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & Dom_Note1.idCOMPMOB & ")"
                Dim myReaderN As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                While myReaderN.Read
                    par.cmd.CommandText = "DELETE FROM VSA_DOC_MANCANTI WHERE ID_DOC=" & myReaderN("ID_DOC")
                    par.cmd.ExecuteNonQuery()
                End While
                myReaderN.Close()
            End If

            For i = 0 To CType(Dom_Note1.FindControl("listbox1"), ListBox).Items.Count - 1
                par.cmd.CommandText = "SELECT * FROM VSA_DOC_MANCANTI WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " AND ID_DOC=" & CType(Dom_Note1.FindControl("listbox1"), ListBox).Items(i).Value
                Dim lettDocManc As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
                If lettDocManc.Read = False Then
                    par.cmd.CommandText = "INSERT INTO VSA_DOC_MANCANTI (ID_DICHIARAZIONE,ID_DOC,DESCRIZIONE) VALUES (" & lIdDichiarazione & "," & CType(Dom_Note1.FindControl("listbox1"), ListBox).Items(i).Value & ",'" & par.PulisciStrSql(CType(Dom_Note1.FindControl("listbox1"), ListBox).Items(i).Text) & "')"
                    par.cmd.ExecuteNonQuery()
                    docMancanti = True
                    CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1
                Else
                    CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1
                End If
                lettDocManc.Close()
            Next
            If docMancanti = True Then
                par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                            & "','F193','','')"
                par.cmd.ExecuteNonQuery()
            End If

            If CType(Dom_Note1.FindControl("listbox1"), ListBox).Items.Count = 0 Then
                CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 0
            End If


            'If CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1 Then
            '    imgAvvisoSospesa.Visible = True
            '    lblSospesa.Visible = True
            'Else
            '    imgAvvisoSospesa.Visible = False
            '    lblSospesa.Visible = False
            'End If

            'If CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1 Then
            '    Dom_Decisioni1.DisattivaTutto()
            '    Response.Write("<script type='text/javascript' language='javascript'>return divSospesione();</script>")
            'Else
            '    Response.Write("<script type='text/javascript' language='javascript'>return divSospesione();</script>")
            'End If


            'If CType(Dom_Note1.FindControl("listbox1"), ListBox).Items.Count > 0 Then
            '    For i = 0 To CType(Dom_Note1.FindControl("listbox1"), ListBox).Items.Count - 1
            '        par.cmd.CommandText = "SELECT * FROM VSA_DOC_MANCANTI WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " ORDER BY ID_DOC ASC"
            '        Dim da As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            '        da.Fill(dt)
            '        For Each row As Data.DataRow In dt.Rows
            '            docPresenti = True
            '            If row.Item("ID_DOC") = CType(Dom_Note1.FindControl("listbox1"), ListBox).Items(i).Value Then
            '                par.cmd.CommandText = "UPDATE VSA_DOC_MANCANTI SET ID_DICHIARAZIONE=" & lIdDichiarazione & "," _
            '                    & "ID_DOC=" & CType(Dom_Note1.FindControl("listbox1"), ListBox).Items(i).Value & "," _
            '                    & "DESCRIZIONE='" & par.PulisciStrSql(CType(Dom_Note1.FindControl("listbox1"), ListBox).Items(i).Text) & "' WHERE ID_DOC=" & CType(Dom_Note1.FindControl("listbox1"), ListBox).Items(i).Value
            '                par.cmd.ExecuteNonQuery()
            '            End If
            '            i = i + 1
            '        Next
            '            If docPresenti = True Then
            '                If CType(Dom_Note1.FindControl("listbox1"), ListBox).Items.Count > i Then
            '                    par.cmd.CommandText = "INSERT INTO VSA_DOC_MANCANTI (ID_DICHIARAZIONE,ID_DOC,DESCRIZIONE) VALUES (" & lIdDichiarazione & "," & CType(Dom_Note1.FindControl("listbox1"), ListBox).Items(i).Value & ",'" & par.PulisciStrSql(CType(Dom_Note1.FindControl("listbox1"), ListBox).Items(i).Text) & "')"
            '                    par.cmd.ExecuteNonQuery()
            '                    docMancanti = True
            '                End If
            '            End If
            '    Next
            '    If docPresenti = False Then
            '        For i = 0 To CType(Dom_Note1.FindControl("listbox1"), ListBox).Items.Count - 1
            '            par.cmd.CommandText = "INSERT INTO VSA_DOC_MANCANTI (ID_DICHIARAZIONE,ID_DOC,DESCRIZIONE) VALUES (" & lIdDichiarazione & "," & CType(Dom_Note1.FindControl("listbox1"), ListBox).Items(i).Value & ",'" & par.PulisciStrSql(CType(Dom_Note1.FindControl("listbox1"), ListBox).Items(i).Text) & "')"
            '            par.cmd.ExecuteNonQuery()
            '            docMancanti = True
            '        Next
            '    End If
            '    If docMancanti = True Then
            '        par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
            '                    & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
            '                    & "','F193','','')"
            '        par.cmd.ExecuteNonQuery()
            '    End If
            'End If
            '****** 21/12/2011 fine Modifica DOC MANCANTI per evento *******


            '*****************************peppe modify
            'par.cmd.CommandText = "DELETE FROM VSA_DOC_ALLEGATI WHERE ID_DICHIARAZIONE=" & lIdDichiarazione
            'par.cmd.ExecuteNonQuery()
            'For i = 0 To CType(Dom_DocAllegati.FindControl("chkListDocumenti"), CheckBoxList).Items.Count - 1
            '    If CType(Dom_DocAllegati.FindControl("chkListDocumenti"), CheckBoxList).Items(i).Selected = True Then
            '        par.cmd.CommandText = "INSERT INTO VSA_DOC_ALLEGATI (ID_DICHIARAZIONE,ID_DOC) VALUES (" & lIdDichiarazione & "," & CType(Dom_DocAllegati.FindControl("chkListDocumenti"), CheckBoxList).Items(i).Value & ")"
            '        par.cmd.ExecuteNonQuery()
            '    End If
            'Next



            '****** 22/12/2011 Modifica DOC ALLEGATI per evento *******
            Dim docAllegati As Boolean = False
            For i = 0 To CType(Dom_DocAllegati.FindControl("chkListDocumenti"), CheckBoxList).Items.Count - 1
                If CType(Dom_DocAllegati.FindControl("chkListDocumenti"), CheckBoxList).Items(i).Selected = True Then
                    CType(Dom_DocAllegati.FindControl("documAlleg"), HiddenField).Value = 1
                    par.cmd.CommandText = "SELECT * FROM VSA_DOC_ALLEGATI WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " AND ID_DOC=" & CType(Dom_DocAllegati.FindControl("chkListDocumenti"), CheckBoxList).Items(i).Value & ""
                    Dim lett As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
                    If lett.Read = False Then
                        par.cmd.CommandText = "INSERT INTO VSA_DOC_ALLEGATI (ID_DICHIARAZIONE,ID_DOC) VALUES (" & lIdDichiarazione & "," & CType(Dom_DocAllegati.FindControl("chkListDocumenti"), CheckBoxList).Items(i).Value & ")"
                        par.cmd.ExecuteNonQuery()
                        docAllegati = True
                    End If
                    lett.Close()
                Else
                    par.cmd.CommandText = "SELECT * FROM VSA_DOC_ALLEGATI WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " AND ID_DOC=" & CType(Dom_DocAllegati.FindControl("chkListDocumenti"), CheckBoxList).Items(i).Value & ""
                    Dim lett2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
                    If lett2.Read Then
                        par.cmd.CommandText = "DELETE FROM VSA_DOC_ALLEGATI WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " AND ID_DOC=" & CType(Dom_DocAllegati.FindControl("chkListDocumenti"), CheckBoxList).Items(i).Value & ""
                        par.cmd.ExecuteNonQuery()
                        CType(Dom_DocAllegati.FindControl("documAlleg"), HiddenField).Value = 0

                        'EVENTO CANCELLAZIONE DOC.ALLEGATI
                        par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                            & "','F206','','')"
                        par.cmd.ExecuteNonQuery()
                    End If
                    lett2.Close()
                End If
            Next
            If docAllegati = True Then
                par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                            & "','F194','','')"
                par.cmd.ExecuteNonQuery()
            End If
            '****** 22/12/2011 fine Modifica DOC ALLEGATI per evento *******

            'IMPEDISCO DI PRENDERE DECISIONI SE NON CI SONO DOC.ALLEGATI
            If CType(Dom_Dichiara_Cambi1.FindControl("cmbPresentaD"), DropDownList).SelectedValue <> "30" Then
                If CType(Dom_Decisioni1.FindControl("ChkDecidi"), CheckBox).Checked = True Then
                    If CType(Dom_DocAllegati.FindControl("documAlleg"), HiddenField).Value = 0 Then
                        scriptblock = "<script language='javascript' type='text/javascript'>" _
                            & "alert('ATTENZIONE, indicare la documentazione da allegare alla richiesta prima di procedere!');" _
                            & "</script>"
                        Response.Write(scriptblock)
                        Exit Try
                    End If
                End If
            End If

            '****************************puccettone modify blocco per le decisioni
            Dim lettore As Oracle.DataAccess.Client.OracleDataReader

            '-********************CHK DECISIONE
            par.cmd.CommandText = "select * from vsa_decisioni_rev_c where id_domanda = " & lIdDomanda & " and cod_decisione = 1"
            lettore = par.cmd.ExecuteReader
            If lettore.Read Then
                If CType(Dom_Decisioni1.FindControl("ChkDecidi"), CheckBox).Checked = False Then
                    par.cmd.CommandText = "delete from vsa_decisioni_rev_c where id_domanda = " & lIdDomanda
                    par.cmd.ExecuteNonQuery()
                End If
            Else
                If CType(Dom_Decisioni1.FindControl("ChkDecidi"), CheckBox).Checked = True Then
                    If CType(Dom_Decisioni1.FindControl("rdbListDecis0"), RadioButtonList).SelectedValue = "" Then
                        Response.Write("<script>alert('Attenzione...Selezionare il parere in prima istanza!')</script>")
                        Exit Sub
                    Else
                        If CType(Dom_Decisioni1.FindControl("rdbListDecis0"), RadioButtonList).SelectedValue = 7 Then
                            CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1
                            CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 0
                        Else
                            CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 0
                            CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1
                        End If

                        par.cmd.CommandText = "INSERT INTO VSA_DECISIONI_REV_C (id_domanda,cod_decisione,data,note) values " _
                        & " (" & lIdDomanda & ",'" & CType(Dom_Decisioni1.FindControl("rdbListDecis0"), RadioButtonList).SelectedValue & "','','" & par.IfNull(par.PulisciStrSql(CType(Dom_Decisioni1.FindControl("txtNoteDec0"), TextBox).Text), "") & "')"
                        par.cmd.ExecuteNonQuery()

                        par.cmd.CommandText = "INSERT INTO VSA_DECISIONI_REV_C (id_domanda,cod_decisione,data,note) values " _
                            & " (" & lIdDomanda & ",1,'" & Format(Now, "yyyyMMddHHmmss") & "','" & par.IfNull(par.PulisciStrSql(CType(Dom_Decisioni1.FindControl("txtNoteDecisione"), TextBox).Text), "") & "')"
                        par.cmd.ExecuteNonQuery()


                        'INSERT DECISIONI ANCHE PER LA DOMANDA DI CAMBIO CONSENSUALE
                        If lIdDomScambio <> 0 Then
                            If statoDichCollegata = True Then
                                par.cmd.CommandText = "INSERT INTO VSA_DECISIONI_REV_C (id_domanda,cod_decisione,data,note) values " _
                                    & " (" & lIdDomScambio & ",'" & CType(Dom_Decisioni1.FindControl("rdbListDecis0"), RadioButtonList).SelectedValue & "','','" & par.IfNull(par.PulisciStrSql(CType(Dom_Decisioni1.FindControl("txtNoteDec0"), TextBox).Text), "") & "')"
                                par.cmd.ExecuteNonQuery()

                                par.cmd.CommandText = "INSERT INTO VSA_DECISIONI_REV_C (id_domanda,cod_decisione,data,note) values " _
                                    & " (" & lIdDomScambio & ",1,'" & Format(Now, "yyyyMMddHHmmss") & "','')"
                                par.cmd.ExecuteNonQuery()

                                par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                                & "VALUES (" & lIdDomScambio & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                                & "','F198','','')"
                                par.cmd.ExecuteNonQuery()
                            Else
                                Response.Write("<script>alert('Attenzione...per procedere completare prima la dichiarazione della pratica collegata!')</script>")
                                Exit Sub
                            End If

                        End If
                        'FINE INSERT DECISIONI ANCHE PER LA DOMANDA DI CAMBIO CONSENSUALE



                        'EVENTO PER RICHIESTA DA SOTTOPORRE A DECISIONE
                        par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                            & "','F198','','')"
                        par.cmd.ExecuteNonQuery()
                    End If
                End If
            End If

            '-***************************CHK RIESAME
            par.cmd.CommandText = "select * from vsa_decisioni_rev_c where id_domanda = " & lIdDomanda & " and cod_decisione = 4"
            lettore = par.cmd.ExecuteReader
            If lettore.Read Then
                If CType(Dom_Decisioni1.FindControl("chkRiesame"), CheckBox).Checked = False Then
                    par.cmd.CommandText = "delete from vsa_decisioni_rev_c where id_domanda = " & lIdDomanda & " and cod_decisione = 4"
                    par.cmd.ExecuteNonQuery()

                End If
            Else
                If CType(Dom_Decisioni1.FindControl("chkRiesame"), CheckBox).Checked = True Then
                    If CType(Dom_Decisioni1.FindControl("rdbListRies0"), RadioButtonList).SelectedValue = "" Then
                        Response.Write("<script>alert('Attenzione...Selezionare il parere in seconda istanza!')</script>")
                        Exit Sub
                    Else
                        par.cmd.CommandText = "INSERT INTO VSA_DECISIONI_REV_C (id_domanda,cod_decisione,data,note) values " _
                        & " (" & lIdDomanda & ",'" & CType(Dom_Decisioni1.FindControl("rdbListRies0"), RadioButtonList).SelectedValue & "','','" & par.IfNull(par.PulisciStrSql(CType(Dom_Decisioni1.FindControl("txtNoteRies0"), TextBox).Text), "") & "')"
                        par.cmd.ExecuteNonQuery()

                        If CType(Dom_Decisioni1.FindControl("rdbListRies0"), RadioButtonList).SelectedValue = 9 Then
                            CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 1
                            CType(Dom_Decisioni1.FindControl("esNegaRiesame"), HiddenField).Value = 0
                        Else
                            CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 0
                            CType(Dom_Decisioni1.FindControl("esNegaRiesame"), HiddenField).Value = 1
                        End If

                        par.cmd.CommandText = "INSERT INTO VSA_DECISIONI_REV_C (id_domanda,cod_decisione,data,note) values " _
                            & " (" & lIdDomanda & ",4,'" & Format(Now, "yyyyMMddHHmmss") & "','" & par.IfNull(par.PulisciStrSql(CType(Dom_Decisioni1.FindControl("txtNoteRiesame"), TextBox).Text), "") & "')"
                        par.cmd.ExecuteNonQuery()


                        'INSERT DECISIONI ANCHE PER LA DOMANDA DI CAMBIO CONSENSUALE
                        If lIdDomScambio <> 0 Then
                            If decisioneConMotivi = True Then
                                par.cmd.CommandText = "INSERT INTO VSA_DECISIONI_REV_C (id_domanda,cod_decisione,data,note) values " _
                                    & " (" & lIdDomScambio & ",'" & CType(Dom_Decisioni1.FindControl("rdbListRies0"), RadioButtonList).SelectedValue & "','','" & par.IfNull(par.PulisciStrSql(CType(Dom_Decisioni1.FindControl("txtNoteRies0"), TextBox).Text), "") & "')"
                                par.cmd.ExecuteNonQuery()

                                par.cmd.CommandText = "INSERT INTO VSA_DECISIONI_REV_C (id_domanda,cod_decisione,data,note) values " _
                                    & " (" & lIdDomScambio & ",4,'" & Format(Now, "yyyyMMddHHmmss") & "','')"
                                par.cmd.ExecuteNonQuery()

                                par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                                & "VALUES (" & lIdDomScambio & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                                & "','F201','','')"
                                par.cmd.ExecuteNonQuery()
                            Else
                                Response.Write("<script>alert('Attenzione...per procedere aggiungere le motivazioni della domanda collegata!')</script>")
                                Exit Sub
                            End If
                        End If
                        'FINE INSERT DECISIONI ANCHE PER LA DOMANDA DI CAMBIO CONSENSUALE


                        'EVENTO PER RICHIESTA DA SOTTOPORRE A REVISIONE
                        par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                            & "','F201','','')"
                        par.cmd.ExecuteNonQuery()
                    End If
                End If
            End If

            '*******************RDB DECISIONE
            Dim noteDomScambio As String = ""
            If par.IfEmpty(CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue, 0) > 0 Then
                If lIdDomScambio <> 0 Then
                    par.cmd.CommandText = "select * from vsa_decisioni_rev_c where id_domanda = " & lIdDomScambio & " and (cod_decisione = 2 or cod_decisione = 3) order by data desc"
                    lettore = par.cmd.ExecuteReader
                    If lettore.Read Then
                        noteDomScambio = par.PulisciStrSql(par.IfNull(lettore("NOTE"), ""))
                    End If
                    lettore.Close()
                End If
                par.cmd.CommandText = "select * from vsa_decisioni_rev_c where id_domanda = " & lIdDomanda & " and (cod_decisione = 2 or cod_decisione = 3) order by data desc"
                lettore = par.cmd.ExecuteReader
                If lettore.Read Then
                    If par.IfNull(lettore("COD_DECISIONE"), 1) <> CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue Or par.IfNull(lettore("note"), "") <> CType(Dom_Decisioni1.FindControl("txtNoteDecisione"), TextBox).Text Then

                        If CType(Dom_Decisioni1.FindControl("chkRiesame"), CheckBox).Checked = False Then
                            par.cmd.CommandText = "UPDATE VSA_DECISIONI_REV_C SET COD_DECISIONE=" & CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue _
                            & ", NOTE= '" & par.PulisciStrSql(CType(Dom_Decisioni1.FindControl("txtNoteDecisione"), TextBox).Text) & "', DATA = '" & Format(Now, "yyyyMMddHHmmss") & "' " _
                            & " WHERE ID_DOMANDA = " & lIdDomanda & " and cod_decisione = " & par.IfNull(lettore("COD_DECISIONE"), 1)
                            par.cmd.ExecuteNonQuery()
                            If lIdDomScambio <> 0 Then
                                If par.IfNull(lettore("COD_DECISIONE"), 1) <> CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue Then
                                    par.cmd.CommandText = "UPDATE VSA_DECISIONI_REV_C SET COD_DECISIONE=" & CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue _
                                    & ", NOTE='" & noteDomScambio & "',DATA = '" & Format(Now, "yyyyMMddHHmmss") & "' " _
                                    & " WHERE ID_DOMANDA = " & lIdDomScambio & " and cod_decisione = " & par.IfNull(lettore("COD_DECISIONE"), 1)
                                    par.cmd.ExecuteNonQuery()
                                End If
                            End If
                        End If
                    End If

                    If par.IfNull(lettore("COD_DECISIONE"), 1) <> CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue Then
                        If CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue = "2" Then
                            'EVENTO PER DECISIONE ACCOLTA
                            CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1
                            CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 0
                            par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                                & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                                & "','F199','','')"
                            par.cmd.ExecuteNonQuery()

                            '***** (CONTRATTO DELLE FFOO) ESITO POSITIVO VALORIZZO IL FLAG DECADENZA A ZERO ******
                            If tipoRichiesta.Value = 6 Or tipoRichiesta.Value = 8 Then
                                If Not IsNothing(Session.Item("lIdConnessione")) Then
                                    Dim par1 As New CM.Global
                                    par1.OracleConn = CType(HttpContext.Current.Session.Item(Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleConnection)
                                    par1.cmd = par1.OracleConn.CreateCommand()
                                    par1.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleTransaction)
                                    ''par1.cmd.Transaction = par1.myTrans

                                    par1.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET FL_PROP_DECADENZA=0 WHERE ID IN (SELECT id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "')"
                                    par1.cmd.ExecuteNonQuery()

                                    par1.myTrans.Commit()
                                    par1.myTrans = par1.OracleConn.BeginTransaction()
                                    HttpContext.Current.Session.Add("TRANSAZIONE" & Session.Item("lIdConnessione"), par1.myTrans)
                                    par1.Dispose()
                                    Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                                End If
                            End If

                        Else
                            'EVENTO PER DECISIONE NON ACCOLTA
                            CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1
                            CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 0
                            par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                                & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                                & "','F200','','')"
                            par.cmd.ExecuteNonQuery()

                            '***** (CONTRATTO DELLE FFOO) ESITO NEGATIVO = DECADENZA VALORIZZO IL FLAG A UNO ******
                            If tipoRichiesta.Value = 6 Or tipoRichiesta.Value = 8 Then
                                If Not IsNothing(Session.Item("lIdConnessione")) Then
                                    Dim par1 As New CM.Global
                                    par1.OracleConn = CType(HttpContext.Current.Session.Item(Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleConnection)
                                    par1.cmd = par1.OracleConn.CreateCommand()
                                    par1.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleTransaction)
                                    ''par1.cmd.Transaction = par1.myTrans

                                    par1.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET FL_PROP_DECADENZA=1 WHERE ID IN (SELECT id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "')"
                                    par1.cmd.ExecuteNonQuery()

                                    par1.myTrans.Commit()
                                    par1.myTrans = par1.OracleConn.BeginTransaction()
                                    HttpContext.Current.Session.Add("TRANSAZIONE" & Session.Item("lIdConnessione"), par1.myTrans)
                                    par1.Dispose()
                                    Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                                End If
                            End If
                        End If
                    End If
                    ''End If
                    '*****************************puccettone modify
                    If CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue = 3 Then
                        par.cmd.CommandText = "DELETE FROM VSA_DOM_ESITI_NEG WHERE ID_DOMANDA = " & lIdDomanda
                        par.cmd.ExecuteNonQuery()

                        For i = 0 To CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items.Count - 1
                            If CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items(i).Selected = True Then
                                par.cmd.CommandText = "INSERT INTO VSA_DOM_ESITI_NEG (ID_DOMANDA,ID_COND_ESITO,COD_DECISIONE) VALUES (" & lIdDomanda & "," & CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items(i).Value & "," & CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue & ")"
                                par.cmd.ExecuteNonQuery()
                            End If
                        Next
                    End If



                Else

                    If CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue = "2" Then

                        CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 1
                        CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 0
                        'EVENTO PER DECISIONE ACCOLTA
                        par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                            & "','F199','','')"
                        par.cmd.ExecuteNonQuery()

                        If lIdDomScambio <> 0 Then
                            par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                                & "VALUES (" & lIdDomScambio & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                                & "','F199','','')"
                            par.cmd.ExecuteNonQuery()
                        End If

                        '***** (CONTRATTO DELLE FFOO) ESITO POSITIVO VALORIZZO IL FLAG DECADENZA A ZERO ******
                        If tipoRichiesta.Value = 6 Or tipoRichiesta.Value = 8 Then
                            If Not IsNothing(Session.Item("lIdConnessione")) Then
                                Dim par1 As New CM.Global
                                par1.OracleConn = CType(HttpContext.Current.Session.Item(Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleConnection)
                                par1.cmd = par1.OracleConn.CreateCommand()
                                par1.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleTransaction)
                                ''par1.cmd.Transaction = par1.myTrans

                                par1.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET FL_PROP_DECADENZA=0 WHERE ID IN (SELECT id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "')"
                                par1.cmd.ExecuteNonQuery()

                                par1.myTrans.Commit()
                                par1.myTrans = par1.OracleConn.BeginTransaction()
                                HttpContext.Current.Session.Add("TRANSAZIONE" & Session.Item("lIdConnessione"), par1.myTrans)
                                par1.Dispose()
                                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                            End If
                        End If
                    Else
                        'EVENTO PER DECISIONE NON ACCOLTA
                        CType(Dom_Decisioni1.FindControl("esNegativo1"), HiddenField).Value = 1
                        CType(Dom_Decisioni1.FindControl("esPositivo"), HiddenField).Value = 0
                        par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                            & "','F200','','')"
                        par.cmd.ExecuteNonQuery()
                        If lIdDomScambio <> 0 Then
                            par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                                & "VALUES (" & lIdDomScambio & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                                & "','F200','','')"
                            par.cmd.ExecuteNonQuery()
                        End If

                        '***** (CONTRATTO DELLE FFOO) ESITO NEGATIVO = DECADENZA VALORIZZO IL FLAG A UNO ******
                        If tipoRichiesta.Value = 6 Or tipoRichiesta.Value = 8 Then
                            If Not IsNothing(Session.Item("lIdConnessione")) Then
                                Dim par1 As New CM.Global
                                par1.OracleConn = CType(HttpContext.Current.Session.Item(Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleConnection)
                                par1.cmd = par1.OracleConn.CreateCommand()
                                par1.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & Session.Item("lIdConnessione")), Oracle.DataAccess.Client.OracleTransaction)
                                ''par1.cmd.Transaction = par1.myTrans

                                par1.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET FL_PROP_DECADENZA=1 WHERE ID IN (SELECT id FROM SISCOM_MI.RAPPORTI_UTENZA WHERE COD_CONTRATTO='" & CType(Dom_Alloggio_ERP1.FindControl("txtNumContratto"), TextBox).Text & "')"
                                par1.cmd.ExecuteNonQuery()

                                par1.myTrans.Commit()
                                par1.myTrans = par1.OracleConn.BeginTransaction()
                                HttpContext.Current.Session.Add("TRANSAZIONE" & Session.Item("lIdConnessione"), par1.myTrans)
                                par1.Dispose()
                                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                            End If
                        End If

                    End If

                    par.cmd.CommandText = "INSERT INTO VSA_DECISIONI_REV_C (id_domanda,cod_decisione,note,data) values " _
                                        & " (" & lIdDomanda & ", " & CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue & "," _
                                        & "'" & par.PulisciStrSql(CType(Dom_Decisioni1.FindControl("txtNoteDecisione"), TextBox).Text) & "','" & Format(Now, "yyyyMMddHHmmss") & "')"
                    par.cmd.ExecuteNonQuery()

                    If lIdDomScambio <> 0 Then
                        par.cmd.CommandText = "INSERT INTO VSA_DECISIONI_REV_C (id_domanda,cod_decisione,note,data) values " _
                                        & " (" & lIdDomScambio & ", " & CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue & "," _
                                        & "'','" & Format(Now, "yyyyMMddHHmmss") & "')"
                        par.cmd.ExecuteNonQuery()
                    End If

                    '************* ||||| COMMENTO TEMPORANEO PER TESTARE LA TEMPISTICA DEL PROCESSO ||||| ****************
                    'par.cmd.CommandText = "INSERT INTO VSA_DECISIONI_REV_C (id_domanda,cod_decisione,note,data) values " _
                    '                    & " (" & lIdDomanda & ", " & CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue & "," _
                    '                    & "'" & par.PulisciStrSql(CType(Dom_Decisioni1.FindControl("txtNoteDecisione"), TextBox).Text) & "','" & par.IfEmpty(par.AggiustaData(CType(Dom_Decisioni1.FindControl("txtDataScelta"), TextBox).Text), Format(Now, "yyyyMMdd")) & "')"
                    'par.cmd.ExecuteNonQuery()


                    '*****************************puccettone modify
                    If CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue = 3 Then
                        'For i = 0 To CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items.Count - 1

                        For i = 0 To CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items.Count - 1
                            If CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items(i).Selected = True Then
                                par.cmd.CommandText = "INSERT INTO VSA_DOM_ESITI_NEG (ID_DOMANDA,ID_COND_ESITO,COD_DECISIONE) VALUES (" & lIdDomanda & "," & CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items(i).Value & "," & CType(Dom_Decisioni1.FindControl("rdbListDecisione"), RadioButtonList).SelectedValue & ")"
                                par.cmd.ExecuteNonQuery()

                            End If
                        Next

                    End If

                End If

            End If


            '********************RDB RIESAME
            Dim codRiesame As String = ""
            Dim noteDomScambior As String = ""
            If par.IfEmpty(CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue, 0) > 0 Then
                If lIdDomScambio <> 0 Then
                    par.cmd.CommandText = "select * from vsa_decisioni_rev_c where id_domanda = " & lIdDomScambio & " and (cod_decisione = 5 or cod_decisione = 6) order by data desc"
                    lettore = par.cmd.ExecuteReader
                    If lettore.Read Then
                        noteDomScambior = par.PulisciStrSql(par.IfNull(lettore("NOTE"), ""))
                    End If
                    lettore.Close()
                End If

                par.cmd.CommandText = "select * from vsa_decisioni_rev_c where id_domanda = " & lIdDomanda & " and (cod_decisione = 5 or cod_decisione = 6) order by data desc"
                lettore = par.cmd.ExecuteReader
                If lettore.Read Then
                    ''If par.IfNull(lettore("COD_DECISIONE"), 1) <> CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue Or par.IfNull(lettore("note"), "") <> CType(Dom_Decisioni1.FindControl("txtNoteRiesame"), TextBox).Text Then
                    par.cmd.CommandText = "UPDATE VSA_DECISIONI_REV_C SET COD_DECISIONE=" & CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue _
                                        & ", NOTE= '" & par.PulisciStrSql(CType(Dom_Decisioni1.FindControl("txtNoteRiesame"), TextBox).Text) & "', DATA = '" & Format(Now, "yyyyMMddHHmmss") & "' " _
                                        & " WHERE ID_DOMANDA = " & lIdDomanda & " and cod_decisione = " & par.IfNull(lettore("COD_DECISIONE"), 1)
                    par.cmd.ExecuteNonQuery()
                    If lIdDomScambio <> 0 Then
                        If par.IfNull(lettore("COD_DECISIONE"), 1) <> CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue Then
                            par.cmd.CommandText = "UPDATE VSA_DECISIONI_REV_C SET COD_DECISIONE=" & CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue _
                                & ", NOTE='" & noteDomScambior & "',DATA = '" & Format(Now, "yyyyMMddHHmmss") & "' " _
                                & " WHERE ID_DOMANDA = " & lIdDomScambio & " and cod_decisione = " & par.IfNull(lettore("COD_DECISIONE"), 1)
                            par.cmd.ExecuteNonQuery()
                        End If
                    End If
                    If CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue = "5" Then
                        CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 1
                        CType(Dom_Decisioni1.FindControl("esNegaRiesame"), HiddenField).Value = 0
                        codRiesame = "F202"
                    Else
                        CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 0
                        CType(Dom_Decisioni1.FindControl("esNegaRiesame"), HiddenField).Value = 1
                        codRiesame = "F203"
                    End If
                    If par.IfNull(lettore("COD_DECISIONE"), 1) <> CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue Then
                        par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                        & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                        & "','" & codRiesame & "','','')"
                        par.cmd.ExecuteNonQuery()
                    End If

                    ''End If
                    If CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue = 6 Then
                        'For i = 0 To CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items.Count - 1

                        For i = 0 To CType(Dom_Decisioni1.FindControl("ChkMotiviRies"), CheckBoxList).Items.Count - 1
                            If CType(Dom_Decisioni1.FindControl("ChkMotiviRies"), CheckBoxList).Items(i).Selected = True Then
                                par.cmd.CommandText = "INSERT INTO VSA_DOM_ESITI_NEG (ID_DOMANDA,ID_COND_ESITO,COD_DECISIONE) VALUES (" & lIdDomanda & "," & CType(Dom_Decisioni1.FindControl("ChkMotiviRies"), CheckBoxList).Items(i).Value & "," & CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue & ")"
                                par.cmd.ExecuteNonQuery()

                            End If
                        Next

                    End If


                Else
                    If CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue = "5" Then
                        CType(Dom_Decisioni1.FindControl("esPosiRiesame"), HiddenField).Value = 1
                        codRiesame = "F202"
                    Else
                        CType(Dom_Decisioni1.FindControl("esNegaRiesame"), HiddenField).Value = 1
                        codRiesame = "F203"
                    End If

                    par.cmd.CommandText = "INSERT INTO VSA_DECISIONI_REV_C (id_domanda,cod_decisione,note,data) values " _
                                        & " (" & lIdDomanda & "," & CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue & "," _
                                        & "'" & par.PulisciStrSql(CType(Dom_Decisioni1.FindControl("txtNoteRiesame"), TextBox).Text) & "','" & Format(Now, "yyyyMMddHHmmss") & "')"
                    par.cmd.ExecuteNonQuery()

                    If lIdDomScambio <> 0 Then
                        par.cmd.CommandText = "INSERT INTO VSA_DECISIONI_REV_C (id_domanda,cod_decisione,note,data) values " _
                                            & " (" & lIdDomScambio & "," & CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue & "," _
                                            & "'','" & Format(Now, "yyyyMMddHHmmss") & "')"
                        par.cmd.ExecuteNonQuery()
                    End If

                    '************* ||||| COMMENTO TEMPORANEO PER TESTARE LA TEMPISTICA DEL PROCESSO ||||| ****************
                    'par.cmd.CommandText = "INSERT INTO VSA_DECISIONI_REV_C (id_domanda,cod_decisione,note,data) values " _
                    '                    & " (" & lIdDomanda & "," & CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue & "," _
                    '                    & "'" & par.PulisciStrSql(CType(Dom_Decisioni1.FindControl("txtNoteRiesame"), TextBox).Text) & "','" & par.IfEmpty(par.AggiustaData(CType(Dom_Decisioni1.FindControl("txtDatasceltaR"), TextBox).Text), Format(Now, "yyyyMMdd"))


                    par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                        & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                        & "','" & codRiesame & "','','')"
                    par.cmd.ExecuteNonQuery()

                    If lIdDomScambio <> 0 Then
                        par.cmd.CommandText = "INSERT INTO EVENTI_BANDI_vsa (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                            & "VALUES (" & lIdDomScambio & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','" & sStato _
                            & "','" & codRiesame & "','','')"
                        par.cmd.ExecuteNonQuery()
                    End If

                    If CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue = 6 Then
                        'For i = 0 To CType(Dom_Decisioni1.FindControl("ChkMotivi"), CheckBoxList).Items.Count - 1

                        For i = 0 To CType(Dom_Decisioni1.FindControl("ChkMotiviRies"), CheckBoxList).Items.Count - 1
                            If CType(Dom_Decisioni1.FindControl("ChkMotiviRies"), CheckBoxList).Items(i).Selected = True Then
                                par.cmd.CommandText = "INSERT INTO VSA_DOM_ESITI_NEG (ID_DOMANDA,ID_COND_ESITO,COD_DECISIONE) VALUES (" & lIdDomanda & "," & CType(Dom_Decisioni1.FindControl("ChkMotiviRies"), CheckBoxList).Items(i).Value & "," & CType(Dom_Decisioni1.FindControl("rdbListRiesame"), RadioButtonList).SelectedValue & ")"
                                par.cmd.ExecuteNonQuery()

                            End If
                        Next

                    End If

                End If

            End If

            '****************************peppe modify blocco per le decisioni

            'If CType(Dom_Requisiti_Cambi1.FindControl("chR6"), CheckBox).Checked = False Then
            '    par.cmd.CommandText = "update dichiarazioni_VSA set possesso_ui=1,fl_ubicazione='1' where id=" & lIdDichiarazione
            '    par.cmd.ExecuteNonQuery()
            'Else
            '    par.cmd.CommandText = "update dichiarazioni_VSA set possesso_ui=0,fl_ubicazione='0' where id=" & lIdDichiarazione
            '    par.cmd.ExecuteNonQuery()
            'End If


            If lProgr <> 0 Then
                If CType(Me.Page.FindControl("cmbNazioneRes"), DropDownList).SelectedItem.Text = "ITALIA" Then
                    sStringaSql = "UPDATE COMP_NAS_RES_VSA SET CAP_RES='" & par.PulisciStrSql(CType(Me.Page.FindControl("txtCAPRes"), TextBox).Text) & "',ID_LUOGO_RES_DNTE=" & CType(Me.Page.FindControl("cmbComuneRes"), DropDownList).SelectedItem.Value & ",ID_TIPO_IND_RES_DNTE=" & CType(Me.Page.FindControl("cmbTipoIRes"), DropDownList).SelectedItem.Value & ",IND_RES_DNTE='" & par.PulisciStrSql(CType(Me.Page.FindControl("txtIndRes"), TextBox).Text) & "',CIVICO_RES_DNTE='" & par.PulisciStrSql(CType(Me.Page.FindControl("txtCivicoRes"), TextBox).Text) & "',TELEFONO_DNTE='" & par.PulisciStrSql(CType(Me.Page.FindControl("txtTelRes"), TextBox).Text) & "' WHERE ID_COMPONENTE=" & lIndice_Componente
                    par.cmd.CommandText = sStringaSql
                    par.cmd.ExecuteNonQuery()
                Else
                    sStringaSql = "UPDATE COMP_NAS_RES_VSA SET CAP_RES='" & par.PulisciStrSql(CType(Me.Page.FindControl("txtCAPRes"), TextBox).Text) & "',ID_LUOGO_RES_DNTE=" & CType(Me.Page.FindControl("cmbNazioneRes"), DropDownList).SelectedItem.Value & ",ID_TIPO_IND_RES_DNTE=" & CType(Me.Page.FindControl("cmbTipoIRes"), DropDownList).SelectedItem.Value & ",IND_RES_DNTE='" & par.PulisciStrSql(CType(Me.Page.FindControl("txtIndRes"), TextBox).Text) & "',CIVICO_RES_DNTE='" & par.PulisciStrSql(CType(Me.Page.FindControl("txtCivicoRes"), TextBox).Text) & "',TELEFONO_DNTE='" & par.PulisciStrSql(CType(Me.Page.FindControl("txtTelRes"), TextBox).Text) & "' WHERE ID_COMPONENTE=" & lIndice_Componente
                    par.cmd.CommandText = sStringaSql
                    par.cmd.ExecuteNonQuery()
                End If
            End If

            If lNuovaDomanda = 1 Then
                sStringaSql = "INSERT INTO EVENTI_BANDI_VSA (ID_DOMANDA,ID_OPERATORE,DATA_ORA,STATO_PRATICA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                            & "VALUES (" & lIdDomanda & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "','1" _
                      & "','F01','','I')"
                par.cmd.CommandText = sStringaSql
                par.cmd.ExecuteNonQuery()
                Session.Item("ID_NUOVA_DIC") = ""
                lNuovaDomanda = 0
            End If

            For Each Menu As MenuItem In MenuStampe.Items
                Menu.ChildItems.Clear()
            Next

            '-------- 26/03/2012 Abilito Chkbox per Documentazione Mancante Presentata ------------
            Dim dataDocManc As String = ""
            par.cmd.CommandText = "SELECT * FROM EVENTI_BANDI_VSA WHERE ID_DOMANDA = " & lIdDomanda & " AND COD_EVENTO = 'F193' ORDER BY DATA_ORA DESC"
            Dim lettore00 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader
            If lettore00.Read Then
                dataDocManc = par.IfNull(lettore00("DATA_ORA"), "").ToString.Substring(0, 8)
            End If
            lettore00.Close()

            If CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1 Then
                CType(Dom_Note1.FindControl("chkDocManc"), CheckBox).Enabled = True
                CType(Dom_Note1.FindControl("txtDataDocManc"), TextBox).Enabled = True
                CType(Dom_Note1.FindControl("chkSosp"), CheckBox).Visible = True
            Else
                CType(Dom_Note1.FindControl("chkDocManc"), CheckBox).Enabled = False
                CType(Dom_Note1.FindControl("txtDataDocManc"), TextBox).Enabled = False
                CType(Dom_Note1.FindControl("chkSosp"), CheckBox).Visible = False
            End If

            If CType(Dom_Note1.FindControl("txtDataDocManc"), TextBox).Text <> "" And CType(Dom_Note1.FindControl("chkDocManc"), CheckBox).Checked = False Then
                scriptblock = "<script language='javascript' type='text/javascript'>" _
                & "alert('ATTENZIONE, impossibile procedere! Valorizzare il flag relativo alla presentazione della documentaz. mancante, altrimenti cancellare la data!');" _
                & "</script>"
                Response.Write(scriptblock)
                Exit Try
            End If

            If CType(Dom_Note1.FindControl("chkDocManc"), CheckBox).Checked = True Then
                If Not par.ControllaData(CType(Dom_Note1.FindControl("txtDataDocManc"), TextBox)) Then
                    scriptblock = "<script language='javascript' type='text/javascript'>" _
                    & "alert('ATTENZIONE, Inserire una data valida!');" _
                    & "</script>"
                    Response.Write(scriptblock)
                    Exit Try
                Else
                    If CType(Dom_Note1.FindControl("txtDataDocManc"), TextBox).Text <> "" Then
                        If DateDiff(DateInterval.Day, CDate(par.FormattaData(dataDocManc)), CDate(CType(Dom_Note1.FindControl("txtDataDocManc"), TextBox).Text)) <= 30 Then
                            par.cmd.CommandText = "UPDATE DOMANDE_BANDO_VSA SET FL_PRESENT_DOC_MANC = 1,DATA_PRESENT_DOC_MANC='" & par.AggiustaData(CType(Dom_Note1.FindControl("txtDataDocManc"), TextBox).Text) & "'" _
                                & " WHERE ID=" & lIdDomanda
                            par.cmd.ExecuteNonQuery()
                            CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 0
                            'CType(Dom_Note1.FindControl("ListBox1"), ListBox).Enabled = False
                            CType(Dom_Note1.FindControl("Button1"), ImageButton).Enabled = False
                            CType(Dom_Note1.FindControl("Button2"), ImageButton).Enabled = False
                            'CType(Dom_Note1.FindControl("chkDocManc"), CheckBox).Enabled = False
                            'CType(Dom_Note1.FindControl("txtDataDocManc"), TextBox).ReadOnly = True
                        Else
                            scriptblock = "<script language='javascript' type='text/javascript'>" _
                            & "alert('ATTENZIONE, impossibile procedere! Documentazione mancante non integrata entro il termine di 30 gg!');" _
                            & "</script>"
                            Response.Write(scriptblock)
                            Exit Try
                        End If
                    Else
                        scriptblock = "<script language='javascript' type='text/javascript'>" _
                        & "alert('ATTENZIONE, indicare la data in cui è stata presentata la documentazione mancante, altrimenti togliere il flag relativo!');" _
                        & "</script>"
                        Response.Write(scriptblock)
                        Exit Try
                    End If
                End If
            Else
                par.cmd.CommandText = "UPDATE DOMANDE_BANDO_VSA SET FL_PRESENT_DOC_MANC = 0,DATA_PRESENT_DOC_MANC=''" _
                & " WHERE ID=" & lIdDomanda
                par.cmd.ExecuteNonQuery()
                CType(Dom_Note1.FindControl("Button1"), ImageButton).Enabled = True
                CType(Dom_Note1.FindControl("Button2"), ImageButton).Enabled = True
                CType(Dom_Note1.FindControl("chkSosp"), CheckBox).Enabled = True

                'If CType(Dom_Note1.FindControl("listbox1"), ListBox).Items.Count > 0 Then
                '    CType(Dom_Note1.FindControl("documMancante"), HiddenField).Value = 1
                'End If
            End If


            '-------- 27/03/2012 AGGIORNO DOMANDA SE CI SONO OSSERVAZIONI -------
            If CType(Dom_Decisioni1.FindControl("chkOsserv"), CheckBox).Checked = True Then
                par.cmd.CommandText = "UPDATE DOMANDE_BANDO_VSA SET FL_OSSERVAZIONI = 1,DATA_OSSERVAZIONI='" & CType(Dom_Decisioni1.FindControl("txtDataOsserv"), TextBox).Text & "'" _
                & " WHERE ID=" & lIdDomanda
                par.cmd.ExecuteNonQuery()
                fl_osserv = 1
            Else
                par.cmd.CommandText = "UPDATE DOMANDE_BANDO_VSA SET FL_OSSERVAZIONI = 0,DATA_OSSERVAZIONI=''" _
                & " WHERE ID=" & lIdDomanda
                par.cmd.ExecuteNonQuery()
                fl_osserv = 0
            End If
            '-------- 27/03/2012 FINE AGGIORNO DOMANDA SE CI SONO OSSERVAZIONI -------


            '--------- 05/04/2012 INSERISCO/AGGIORNO SOPRALLUOGO
            If CType(Dom_Note1.FindControl("chkSoprall"), CheckBox).Checked = True Then
                par.cmd.CommandText = "SELECT * FROM VSA_SOPRALLUOGHI WHERE ID_DOMANDA=" & lIdDomanda
                Dim myReaderSop As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderSop.Read Then
                    par.cmd.CommandText = "UPDATE VSA_SOPRALLUOGHI SET NOTE = '" & par.PulisciStrSql(CType(Dom_Note1.FindControl("txtNoteSoprall"), TextBox).Text) & "'," _
                    & "DATA_SOPRALLUOGO='" & par.AggiustaData(CType(Dom_Note1.FindControl("txtDataSoprall"), TextBox).Text) & "' WHERE ID_DOMANDA=" & lIdDomanda
                    par.cmd.ExecuteNonQuery()
                Else
                    par.cmd.CommandText = "INSERT INTO VSA_SOPRALLUOGHI (ID_DOMANDA,NOTE,DATA_SOPRALLUOGO) " _
                    & "VALUES (" & lIdDomanda & ",'" & par.PulisciStrSql(CType(Dom_Note1.FindControl("txtNoteSoprall"), TextBox).Text) & "','" & par.AggiustaData(CType(Dom_Note1.FindControl("txtDataSoprall"), TextBox).Text) & "')"
                    par.cmd.ExecuteNonQuery()
                    CType(Dom_Note1.FindControl("chkSoprall"), CheckBox).Enabled = False
                End If
                myReaderSop.Close()
            End If
            '--------- 05/04/2012 INSERISCO/AGGIORNO SOPRALLUOGO



            '-------- 05/06/2012 VERIFICO SE VIENE SBLOCCATA LA SOSPENSIONE -------
            If CType(Dom_Note1.FindControl("chkSosp"), CheckBox).Checked = True Then
                If CType(Dom_Note1.FindControl("chkDocManc"), CheckBox).Checked = False And CType(Dom_Note1.FindControl("listbox1"), ListBox).Items.Count > 0 Then
                    par.cmd.CommandText = "UPDATE DOMANDE_BANDO_VSA SET FL_FINE_SOSPENSIONE = 1" _
                    & " WHERE ID=" & lIdDomanda
                    par.cmd.ExecuteNonQuery()
                End If
                'CType(Dom_Note1.FindControl("chkSosp"), CheckBox).Enabled = False
            Else
                par.cmd.CommandText = "UPDATE DOMANDE_BANDO_VSA SET FL_FINE_SOSPENSIONE = ''" _
                    & " WHERE ID=" & lIdDomanda
                par.cmd.ExecuteNonQuery()

            End If
            '-------- 05/06/2012 FINE VERIFICO SE VIENE SBLOCCATA LA SOSPENSIONE -------


            'CAMBI IN EMERGENZE - VERIFICO SE E' STATA INSERITA LA SUPERFICIE E SE SONO STATE SALVATE LE MOTIVAZIONI
            If CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedItem.Value = "4" Then
                Dim sup As Decimal = 0
                par.cmd.CommandText = "SELECT * FROM domande_VSA_alloggio WHERE ID_domanda=" & lIdDomanda
                Dim myReaderN0 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderN0.Read Then
                    sup = par.IfNull(myReaderN0("sup_netta"), 0)
                End If
                myReaderN0.Close()

                If sup = "0" Then
                    Response.Write("<script>alert('Attenzione, la superficie dell\'unità non è stata caricata. Assecurarsi di aver inserito tale superficie e di aver premuto il pulsante SALVA!');</script>")
                    Exit Try
                End If

                par.cmd.CommandText = "SELECT * FROM DOMANDE_BANDO_VSA_PUNTI_EM WHERE ID_DOMANDA=" & lIdDomanda
                Dim myReaderN As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderN.Read = False Then
                    Response.Write("<script>alert('ATTENZIONE...inserire le motivazioni di cambio alloggio dal tab Dichiara! Memorizzazione non effettuata!')</script>")
                    Exit Try
                End If
                myReaderN.Close()

            End If

            If Request.QueryString("GLocat") = "" Then
                ''SetMenuStampe(tipoRichiesta.Value)
                SegnalazioneTempi(CType(Dom_Dichiara_Cambi1.FindControl("txtDataPrRichiesta"), TextBox).Text, CType(Dom_Dichiara_Cambi1.FindControl("cmbTipoRichiesta"), DropDownList).SelectedValue)
            End If

            par.myTrans.Commit()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessDOMANDA, par.myTrans)

            Dom_DocAllegati.CaricaLista()

            par.cmd.CommandText = "SELECT * FROM DOMANDE_BANDO_VSA WHERE ID=" & lIdDomanda & " FOR UPDATE NOWAIT"
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            myReader.Close()

            Me.txtModificato.Value = 0
            If tipoRichiesta.Value = 3 Or tipoRichiesta.Value = 4 Or Request.QueryString("GLocat") <> "" Then
                imgStampa.Enabled = True
                imgStampa.Visible = True
                'imgStampa.ImageUrl = "../NuoveImm/Img_Stampa.png"
            Else
                imgStampa.Visible = False
            End If
            bMemorizzato = True
            Dom_Decisioni1.GestioneStatoD()

            If tipoRichiesta.Value <> 3 And tipoRichiesta.Value <> 4 And Request.QueryString("GLocat") = "" Then
                CalcolaStampa()
            End If


        Catch EX As Exception
            'Label10.Visible = True
            'Label10.Text = EX.Message
        Finally
        End Try

    End Sub
End Class

