Imports System.IO
Imports ExpertPdf.HtmlToPdf
Imports System.Drawing
Imports System.Collections.Generic
Imports System.Math


Partial Class Contratti_Contratto
    Inherits PageSetIdMode
    Dim par As New CM.Global


    Public Tab1 As String
    Public Tab2 As String
    Public Tab3 As String
    Public Tab4 As String
    Public Tab5 As String
    Public Tab6 As String
    Public Tab7 As String
    Public Tab8 As String
    Public Tab9 As String
    Public Tab10 As String
    Public Tab11 As String
    Public Tab12 As String

    Public Visibile As String = ""
    Public VisibileOA As String = ""

    Public CodContratto As String
    Public StampaContratto As String

    Private Property myReader22 As Oracle.DataAccess.Client.OracleDataReader

    Private Function CaricaSpese(ByVal Inserisci As Boolean) As Boolean
        Try
            Dim Imp303 As Double = 0
            Dim Imp300 As Double = 0
            Dim Imp302 As Double = 0
            Dim IdEF As Integer = 0
            Dim ESERCIZIOF As Integer = 0
            Dim ESERCIZIOF_1 As Integer = 0
            Dim anno As Integer = 0

            CaricaSpese = False

            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans

            par.cmd.CommandText = "select * from siscom_mi.pf_main where applicazione_bol=1 order by id_esercizio_finanziario desc"
            Dim myReaderAb As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderAb.HasRows = True Then
                If myReaderAb.Read Then
                    IdEF = myReaderAb("id")
                End If
                par.cmd.CommandText = "SELECT sum(importo_preventivo) FROM siscom_mi.PF_PREVENTIVI WHERE id_tipo_spesa=1 AND id_pf=" & IdEF & " AND id_unita=" & UnitaContratto
                Dim myReaderAb1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderAb1.Read Then
                    Imp303 = Format(par.IfNull(myReaderAb1(0), "0"), "0.00")
                    If par.IfNull(myReaderAb1(0), "-1") <> "-1" Then
                        CaricaSpese = True
                    End If
                End If
                myReaderAb1.Close()
                par.cmd.CommandText = "SELECT sum(importo_preventivo) FROM siscom_mi.PF_PREVENTIVI WHERE id_tipo_spesa=2 AND id_pf=" & IdEF & " AND id_unita=" & UnitaContratto
                myReaderAb1 = par.cmd.ExecuteReader()
                If myReaderAb1.Read Then
                    Imp302 = Format(par.IfNull(myReaderAb1(0), "0"), "0.00")
                    If par.IfNull(myReaderAb1(0), "-1") <> "-1" Then
                        CaricaSpese = True
                    End If
                End If
                myReaderAb1.Close()
                par.cmd.CommandText = "SELECT sum(importo_preventivo) FROM siscom_mi.PF_PREVENTIVI WHERE id_tipo_spesa=3 AND id_pf=" & IdEF & " AND id_unita=" & UnitaContratto
                myReaderAb1 = par.cmd.ExecuteReader()
                If myReaderAb1.Read Then
                    Imp300 = Format(par.IfNull(myReaderAb1(0), "0"), "0.00")
                    If par.IfNull(myReaderAb1(0), "-1") <> "-1" Then
                        CaricaSpese = True
                    End If
                End If
                myReaderAb1.Close()
            Else
                CaricaSpese = False
            End If
            myReaderAb.Close()


            If CaricaSpese = True Then
                If Inserisci = True Then
                    par.cmd.CommandText = "SELECT cod_tipologia_contr_loc,FL_STAMPATO,DATA_DECORRENZA,NRO_RATE FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & lIdContratto
                    Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader.Read Then
                        If CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text <> "" Then
                            anno = Mid(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 7, 4)

                            If anno < Year(Now) Then
                                anno = Year(Now)
                            End If
                            If Month(Now) = 12 Then
                                anno = Year(Now) + 1
                            End If
                            If anno > Year(Now) Then
                                anno = Year(Now) + 1
                            End If

                            ESERCIZIOF = par.RicavaEsercizio(anno)
                            ESERCIZIOF_1 = par.RicavaEsercizio(anno + 1)

                            If Imp300 <> 0 Then
                                par.cmd.CommandText = "select * from siscom_mi.bol_schema where anno=" & anno & " and id_voce=300 and id_contratto=" & lIdContratto
                                Dim myReader123 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                If myReader123.HasRows = False Then
                                    par.cmd.CommandText = "Insert into siscom_mi.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE, IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO,FL_PREVENTIVI) Values (siscom_mi.seq_bol_schema.nextval, " & lIdContratto & ", " & UnitaContratto & ", " & ESERCIZIOF & ", 300, " & par.VirgoleInPunti(Imp300) & " , 1, " & par.IfNull(myReader("nro_rate"), "1") & ", " & par.VirgoleInPunti(Format(Imp300 / par.IfNull(myReader("nro_rate"), "1"), "0.00")) & " , " & anno & ",1)"
                                    par.cmd.ExecuteNonQuery()
                                    If anno = Year(Now) Then
                                        par.cmd.CommandText = "Insert into siscom_mi.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE, IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO,FL_PREVENTIVI) Values (siscom_mi.seq_bol_schema.nextval, " & lIdContratto & ", " & UnitaContratto & ", " & ESERCIZIOF & ", 300, " & par.VirgoleInPunti(Imp300) & " , 1, " & par.IfNull(myReader("nro_rate"), "1") & ", " & par.VirgoleInPunti(Format(Imp300 / par.IfNull(myReader("nro_rate"), "1"), "0.00")) & " , " & anno + 1 & ",1)"
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                End If
                                myReader123.Close()
                            End If
                            If Imp302 <> 0 Then
                                par.cmd.CommandText = "select * from siscom_mi.bol_schema where  anno=" & anno & " and  id_voce=302 and id_contratto=" & lIdContratto
                                Dim myReader123 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                If myReader123.HasRows = False Then
                                    par.cmd.CommandText = "Insert into siscom_mi.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE, IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO,FL_PREVENTIVI) Values (siscom_mi.seq_bol_schema.nextval, " & lIdContratto & ", " & UnitaContratto & ", " & ESERCIZIOF & ", 302, " & par.VirgoleInPunti(Imp302) & " , 1, " & par.IfNull(myReader("nro_rate"), "1") & ", " & par.VirgoleInPunti(Format(Imp302 / par.IfNull(myReader("nro_rate"), "1"), "0.00")) & " , " & anno & ",1)"
                                    par.cmd.ExecuteNonQuery()
                                    If anno = Year(Now) Then
                                        par.cmd.CommandText = "Insert into siscom_mi.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE, IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO,FL_PREVENTIVI) Values (siscom_mi.seq_bol_schema.nextval, " & lIdContratto & ", " & UnitaContratto & ", " & ESERCIZIOF & ", 302, " & par.VirgoleInPunti(Imp302) & " , 1, " & par.IfNull(myReader("nro_rate"), "1") & ", " & par.VirgoleInPunti(Format(Imp302 / par.IfNull(myReader("nro_rate"), "1"), "0.00")) & " , " & anno + 1 & ",1)"
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                End If
                                myReader123.Close()
                            End If
                            If Imp303 <> 0 Then
                                par.cmd.CommandText = "select * from siscom_mi.bol_schema  where anno=" & anno & " and  id_voce=303 and id_contratto=" & lIdContratto
                                Dim myReader123 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                If myReader123.HasRows = False Then
                                    par.cmd.CommandText = "Insert into siscom_mi.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE, IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO,FL_PREVENTIVI) Values (siscom_mi.seq_bol_schema.nextval, " & lIdContratto & ", " & UnitaContratto & ", " & ESERCIZIOF & ", 303, " & par.VirgoleInPunti(Imp303) & " , 1, " & par.IfNull(myReader("nro_rate"), "1") & ", " & par.VirgoleInPunti(Format(Imp303 / par.IfNull(myReader("nro_rate"), "1"), "0.00")) & " , " & anno & ",1)"
                                    par.cmd.ExecuteNonQuery()
                                    If anno = Year(Now) Then
                                        par.cmd.CommandText = "Insert into siscom_mi.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE, IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO,FL_PREVENTIVI) Values (siscom_mi.seq_bol_schema.nextval, " & lIdContratto & ", " & UnitaContratto & ", " & ESERCIZIOF & ", 303, " & par.VirgoleInPunti(Imp303) & " , 1, " & par.IfNull(myReader("nro_rate"), "1") & ", " & par.VirgoleInPunti(Format(Imp303 / par.IfNull(myReader("nro_rate"), "1"), "0.00")) & " , " & anno + 1 & ",1)"
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                End If
                                myReader123.Close()
                            End If
                        End If
                        myReader.Close()
                    End If
                    par.cmd.Dispose()
                End If
                Dim StringaTabellaONERI As String = ""
                StringaTabellaONERI = StringaTabellaONERI & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">SPESE ASCENSORE</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(Imp300, "0.00") & "</td></tr>"
                StringaTabellaONERI = StringaTabellaONERI & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">SPESE RISCALDAMENTO</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(Imp302, "0.00") & "</td></tr>"
                StringaTabellaONERI = StringaTabellaONERI & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">SPESE GENERALI</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(Imp303, "0.00") & "</td></tr>"
                CType(Tab_SchemaBollette1.FindControl("lblVociOneri"), Label).Text = "<table><tr><td style=" & Chr(34) & "font-family: Arial; font-size: 9px; font-weight: bold" & Chr(34) & ">SPESE ONERI ACCESSORI PREVENTIVATE</td><td></td></tr>" & StringaTabellaONERI & "</table>"
            Else
                Dim StringaTabellaONERI As String = ""
                CType(Tab_SchemaBollette1.FindControl("lblVociOneri"), Label).Text = "<table><tr><td style=" & Chr(34) & "color:red;font-family: Arial; font-size: 9px; font-weight: bold" & Chr(34) & ">NON SONO STATE TROVATE VOCI DI SPESA PREVENTIVATE.<br />PROCEDERE MANUALMENTE ALL'INSERIMENTO NELLO SCHEMA.</td><td></td></tr>" & StringaTabellaONERI & "</table>"
            End If
        Catch ex As Exception
            CaricaSpese = False
        End Try
    End Function

    'Private Function CaricaSpese() As Boolean
    '    Try
    '        Dim Imp303 As Double = 0
    '        Dim Imp300 As Double = 0
    '        Dim Imp302 As Double = 0
    '        Dim IdEF As Integer = 0
    '        Dim ESERCIZIOF As Integer = 0
    '        Dim ESERCIZIOF_1 As Integer = 0
    '        Dim anno As Integer = 0

    '        CaricaSpese = False

    '        par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
    '        par.SettaCommand(par)
    '        par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)
    '        ‘‘par.cmd.Transaction = par.myTrans

    '        par.cmd.CommandText = "select * from siscom_mi.pf_main where applicazione_bol=1 order by id_esercizio_finanziario desc"
    '        Dim myReaderAb As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '        If myReaderAb.HasRows = True Then
    '            If myReaderAb.Read Then
    '                IdEF = myReaderAb("id")
    '            End If
    '            par.cmd.CommandText = "SELECT sum(importo_preventivo) FROM siscom_mi.PF_PREVENTIVI WHERE id_tipo_spesa=1 AND id_pf=" & IdEF & " AND id_unita=" & UnitaContratto
    '            Dim myReaderAb1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '            If myReaderAb1.Read Then
    '                Imp303 = Format(par.IfNull(myReaderAb1(0), "0"), "0.00")
    '                If par.IfNull(myReaderAb1(0), "-1") <> "-1" Then
    '                    CaricaSpese = True
    '                End If
    '            End If
    '            myReaderAb1.Close()
    '            par.cmd.CommandText = "SELECT sum(importo_preventivo) FROM siscom_mi.PF_PREVENTIVI WHERE id_tipo_spesa=2 AND id_pf=" & IdEF & " AND id_unita=" & UnitaContratto
    '            myReaderAb1 = par.cmd.ExecuteReader()
    '            If myReaderAb1.Read Then
    '                Imp302 = Format(par.IfNull(myReaderAb1(0), "0"), "0.00")
    '                If par.IfNull(myReaderAb1(0), "-1") <> "-1" Then
    '                    CaricaSpese = True
    '                End If
    '            End If
    '            myReaderAb1.Close()
    '            par.cmd.CommandText = "SELECT sum(importo_preventivo) FROM siscom_mi.PF_PREVENTIVI WHERE id_tipo_spesa=3 AND id_pf=" & IdEF & " AND id_unita=" & UnitaContratto
    '            myReaderAb1 = par.cmd.ExecuteReader()
    '            If myReaderAb1.Read Then
    '                Imp300 = Format(par.IfNull(myReaderAb1(0), "0"), "0.00")
    '                If par.IfNull(myReaderAb1(0), "-1") <> "-1" Then
    '                    CaricaSpese = True
    '                End If
    '            End If
    '            myReaderAb1.Close()
    '        Else
    '            CaricaSpese = False
    '        End If
    '        myReaderAb.Close()


    '        If CaricaSpese = True Then

    '            par.cmd.CommandText = "SELECT cod_tipologia_contr_loc,FL_STAMPATO,DATA_DECORRENZA,NRO_RATE FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & lIdContratto
    '            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '            If myReader.Read Then
    '                If CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text <> "" Then
    '                    anno = Mid(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 7, 4)

    '                    If anno < Year(Now) Then
    '                        anno = Year(Now)
    '                    End If
    '                    If Month(Now) = 12 Then
    '                        anno = Year(Now) + 1
    '                    End If
    '                    If anno > Year(Now) Then
    '                        anno = Year(Now) + 1
    '                    End If

    '                    ESERCIZIOF = par.RicavaEsercizio(anno)
    '                    ESERCIZIOF_1 = par.RicavaEsercizio(anno + 1)

    '                    If Imp300 <> 0 Then
    '                        par.cmd.CommandText = "select * from siscom_mi.bol_schema where id_voce=300 and id_contratto=" & lIdContratto
    '                        Dim myReader123 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '                        If myReader123.HasRows = False Then
    '                            par.cmd.CommandText = "Insert into siscom_mi.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE, IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO,FL_PREVENTIVI) Values (siscom_mi.seq_bol_schema.nextval, " & lIdContratto & ", " & UnitaContratto & ", " & ESERCIZIOF & ", 300, " & par.VirgoleInPunti(Imp300) & " , 1, " & par.IfNull(myReader("nro_rate"), "1") & ", " & par.VirgoleInPunti(Format(Imp300 / par.IfNull(myReader("nro_rate"), "1"), "0.00")) & " , " & anno & ",1)"
    '                            par.cmd.ExecuteNonQuery()
    '                            If anno = Year(Now) Then
    '                                par.cmd.CommandText = "Insert into siscom_mi.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE, IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO,FL_PREVENTIVI) Values (siscom_mi.seq_bol_schema.nextval, " & lIdContratto & ", " & UnitaContratto & ", " & ESERCIZIOF & ", 300, " & par.VirgoleInPunti(Imp300) & " , 1, " & par.IfNull(myReader("nro_rate"), "1") & ", " & par.VirgoleInPunti(Format(Imp300 / par.IfNull(myReader("nro_rate"), "1"), "0.00")) & " , " & anno + 1 & ",1)"
    '                                par.cmd.ExecuteNonQuery()
    '                            End If
    '                        End If
    '                        myReader123.Close()
    '                    End If
    '                    If Imp302 <> 0 Then
    '                        par.cmd.CommandText = "select * from siscom_mi.bol_schema where id_voce=302 and id_contratto=" & lIdContratto
    '                        Dim myReader123 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '                        If myReader123.HasRows = False Then
    '                            par.cmd.CommandText = "Insert into siscom_mi.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE, IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO,FL_PREVENTIVI) Values (siscom_mi.seq_bol_schema.nextval, " & lIdContratto & ", " & UnitaContratto & ", " & ESERCIZIOF & ", 302, " & par.VirgoleInPunti(Imp302) & " , 1, " & par.IfNull(myReader("nro_rate"), "1") & ", " & par.VirgoleInPunti(Format(Imp302 / par.IfNull(myReader("nro_rate"), "1"), "0.00")) & " , " & anno & ",1)"
    '                            par.cmd.ExecuteNonQuery()
    '                            If anno = Year(Now) Then
    '                                par.cmd.CommandText = "Insert into siscom_mi.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE, IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO,FL_PREVENTIVI) Values (siscom_mi.seq_bol_schema.nextval, " & lIdContratto & ", " & UnitaContratto & ", " & ESERCIZIOF & ", 302, " & par.VirgoleInPunti(Imp302) & " , 1, " & par.IfNull(myReader("nro_rate"), "1") & ", " & par.VirgoleInPunti(Format(Imp302 / par.IfNull(myReader("nro_rate"), "1"), "0.00")) & " , " & anno + 1 & ",1)"
    '                                par.cmd.ExecuteNonQuery()
    '                            End If
    '                        End If
    '                        myReader123.Close()
    '                    End If
    '                    If Imp303 <> 0 Then
    '                        par.cmd.CommandText = "select * from siscom_mi.bol_schema where id_voce=303 and id_contratto=" & lIdContratto
    '                        Dim myReader123 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '                        If myReader123.HasRows = False Then
    '                            par.cmd.CommandText = "Insert into siscom_mi.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE, IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO,FL_PREVENTIVI) Values (siscom_mi.seq_bol_schema.nextval, " & lIdContratto & ", " & UnitaContratto & ", " & ESERCIZIOF & ", 303, " & par.VirgoleInPunti(Imp303) & " , 1, " & par.IfNull(myReader("nro_rate"), "1") & ", " & par.VirgoleInPunti(Format(Imp303 / par.IfNull(myReader("nro_rate"), "1"), "0.00")) & " , " & anno & ",1)"
    '                            par.cmd.ExecuteNonQuery()
    '                            If anno = Year(Now) Then
    '                                par.cmd.CommandText = "Insert into siscom_mi.BOL_SCHEMA (ID, ID_CONTRATTO, ID_UNITA, ID_ESERCIZIO_F, ID_VOCE, IMPORTO, DA_RATA, PER_RATE, IMPORTO_SINGOLA_RATA, ANNO,FL_PREVENTIVI) Values (siscom_mi.seq_bol_schema.nextval, " & lIdContratto & ", " & UnitaContratto & ", " & ESERCIZIOF & ", 303, " & par.VirgoleInPunti(Imp303) & " , 1, " & par.IfNull(myReader("nro_rate"), "1") & ", " & par.VirgoleInPunti(Format(Imp303 / par.IfNull(myReader("nro_rate"), "1"), "0.00")) & " , " & anno + 1 & ",1)"
    '                                par.cmd.ExecuteNonQuery()
    '                            End If
    '                        End If
    '                        myReader123.Close()
    '                    End If
    '                End If
    '                myReader.Close()
    '            End If
    '            par.cmd.Dispose()
    '        End If
    '    Catch ex As Exception
    '        CaricaSpese = False
    '    End Try
    'End Function


    Private Sub CercaAbusivi()
        Try
            par.OracleConn.Open()
            par.SettaCommand(par)
            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA_AU_ABUSIVI WHERE ID_CONTRATTO =" & lIdContratto
            Dim myReaderAb As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderAb.Read Then
                au_abusivi.Value = "1"
            End If
            myReaderAb.Close()
            par.cmd.Dispose()
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
        Catch ex As Exception
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
        End Try

    End Sub


    Public Property sNOTE() As String
        Get
            If Not (ViewState("par_sNOTE") Is Nothing) Then
                Return CStr(ViewState("par_sNOTE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sNOTE") = value
        End Set
    End Property

    Public Property sDEM() As String
        Get
            If Not (ViewState("par_sDEM") Is Nothing) Then
                Return CStr(ViewState("par_sDEM"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sDEM") = value
        End Set
    End Property

    Public Property sSUPCONVENZIONALE() As String
        Get
            If Not (ViewState("par_sSUPCONVENZIONALE") Is Nothing) Then
                Return CStr(ViewState("par_sSUPCONVENZIONALE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sSUPCONVENZIONALE") = value
        End Set
    End Property

    Public Property sCOSTOBASE() As String
        Get
            If Not (ViewState("par_sCOSTOBASE") Is Nothing) Then
                Return CStr(ViewState("par_sCOSTOBASE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCOSTOBASE") = value
        End Set
    End Property

    Public Property sZONA() As String
        Get
            If Not (ViewState("par_sZONA") Is Nothing) Then
                Return CStr(ViewState("par_sZONA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sZONA") = value
        End Set
    End Property



    Public Property sCONSERVAZIONE() As String
        Get
            If Not (ViewState("par_sCONSERVAZIONE") Is Nothing) Then
                Return CStr(ViewState("par_sCONSERVAZIONE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCONSERVAZIONE") = value
        End Set
    End Property

    Public Property sVETUSTA() As String
        Get
            If Not (ViewState("par_sVETUSTA") Is Nothing) Then
                Return CStr(ViewState("par_sVETUSTA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sVETUSTA") = value
        End Set
    End Property

    Public Property sINCIDENZAISE() As String
        Get
            If Not (ViewState("par_sINCIDENZAISE") Is Nothing) Then
                Return CStr(ViewState("par_sINCIDENZAISE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sINCIDENZAISE") = value
        End Set
    End Property


    Public Property sCOEFFFAM() As String
        Get
            If Not (ViewState("par_sCOEFFFAM") Is Nothing) Then
                Return CStr(ViewState("par_sCOEFFFAM"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCOEFFFAM") = value
        End Set
    End Property

    Public Property sSOTTOAREA() As String
        Get
            If Not (ViewState("par_sSOTTOAREA") Is Nothing) Then
                Return CStr(ViewState("par_sSOTTOAREA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sSOTTOAREA") = value
        End Set
    End Property

    Public Property sMOTIVODECADENZA() As String
        Get
            If Not (ViewState("par_sMOTIVODECADENZA") Is Nothing) Then
                Return CStr(ViewState("par_sMOTIVODECADENZA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sMOTIVODECADENZA") = value
        End Set
    End Property

    Public Property sNUMCOMP() As String
        Get
            If Not (ViewState("par_sNUMCOMP") Is Nothing) Then
                Return CStr(ViewState("par_sNUMCOMP"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sNUMCOMP") = value
        End Set
    End Property

    Public Property sNUMCOMP66() As String
        Get
            If Not (ViewState("par_sNUMCOMP66") Is Nothing) Then
                Return CStr(ViewState("par_sNUMCOMP66"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sNUMCOMP66") = value
        End Set
    End Property

    Public Property sNUMCOMP100() As String
        Get
            If Not (ViewState("par_sNUMCOMP100") Is Nothing) Then
                Return CStr(ViewState("par_sNUMCOMP100"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sNUMCOMP100") = value
        End Set
    End Property

    Public Property sNUMCOMP100C() As String
        Get
            If Not (ViewState("par_sNUMCOMP100C") Is Nothing) Then
                Return CStr(ViewState("par_sNUMCOMP100C"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sNUMCOMP100C") = value
        End Set
    End Property

    Public Property sPREVDIP() As String
        Get
            If Not (ViewState("par_sPREVDIP") Is Nothing) Then
                Return CStr(ViewState("par_sPREVDIP"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sPREVDIP") = value
        End Set
    End Property

    Public Property sDETRAZIONI() As String
        Get
            If Not (ViewState("par_sDETRAZIONI") Is Nothing) Then
                Return CStr(ViewState("par_sDETRAZIONI"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sDETRAZIONI") = value
        End Set
    End Property

    Public Property sMOBILIARI() As String
        Get
            If Not (ViewState("par_sMOBILIARI") Is Nothing) Then
                Return CStr(ViewState("par_sMOBILIARI"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sMOBILIARI") = value
        End Set
    End Property


    Public Property sIMMOBILIARI() As String
        Get
            If Not (ViewState("par_sIMMOBILIARI") Is Nothing) Then
                Return CStr(ViewState("par_sIMMOBILIARI"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sIMMOBILIARI") = value
        End Set
    End Property

    Public Property sCOMPLESSIVO() As String
        Get
            If Not (ViewState("par_sCOMPLESSIVO") Is Nothing) Then
                Return CStr(ViewState("par_sCOMPLESSIVO"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCOMPLESSIVO") = value
        End Set
    End Property

    Public Property sDETRAZIONEF() As String
        Get
            If Not (ViewState("par_sDETRAZIONEF") Is Nothing) Then
                Return CStr(ViewState("par_sDETRAZIONEF"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sDETRAZIONEF") = value
        End Set
    End Property

    Public Property sANNOCOSTRUZIONE() As String
        Get
            If Not (ViewState("par_sANNOCOSTRUZIONE") Is Nothing) Then
                Return CStr(ViewState("par_sANNOCOSTRUZIONE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sANNOCOSTRUZIONE") = value
        End Set
    End Property

    Public Property sLOCALITA() As String
        Get
            If Not (ViewState("par_sLOCALITA") Is Nothing) Then
                Return CStr(ViewState("par_sLOCALITA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sLOCALITA") = value
        End Set
    End Property

    Public Property sASCENSORE() As String
        Get
            If Not (ViewState("par_sASCENSORE") Is Nothing) Then
                Return CStr(ViewState("par_sASCENSORE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sASCENSORE") = value
        End Set
    End Property

    Public Property sDESCRIZIONEPIANO() As String
        Get
            If Not (ViewState("par_sDESCRIZIONEPIANO") Is Nothing) Then
                Return CStr(ViewState("par_sDESCRIZIONEPIANO"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sDESCRIZIONEPIANO") = value
        End Set
    End Property

    Public Property sSUPNETTA() As String
        Get
            If Not (ViewState("par_sSUPNETTA") Is Nothing) Then
                Return CStr(ViewState("par_sSUPNETTA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sSUPNETTA") = value
        End Set
    End Property

    Public Property sALTRESUP() As String
        Get
            If Not (ViewState("par_sALTRESUP") Is Nothing) Then
                Return CStr(ViewState("par_sALTRESUP"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sALTRESUP") = value
        End Set
    End Property

    Public Property sMINORI15() As String
        Get
            If Not (ViewState("par_sMINORI15") Is Nothing) Then
                Return CStr(ViewState("par_sMINORI15"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sMINORI15") = value
        End Set
    End Property


    Public Property sMAGGIORI65() As String
        Get
            If Not (ViewState("par_sMAGGIORI65") Is Nothing) Then
                Return CStr(ViewState("par_sMAGGIORI65"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sMAGGIORI65") = value
        End Set
    End Property

    Public Property sSUPACCESSORI() As String
        Get
            If Not (ViewState("par_sSUPACCESSORI") Is Nothing) Then
                Return CStr(ViewState("par_sSUPACCESSORI"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sSUPACCESSORI") = value
        End Set
    End Property

    Public Property sVALORELOCATIVO() As String
        Get
            If Not (ViewState("par_sVALORELOCATIVO") Is Nothing) Then
                Return CStr(ViewState("par_sVALORELOCATIVO"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sVALORELOCATIVO") = value
        End Set
    End Property

    Public Property sCANONEMINIMO() As String
        Get
            If Not (ViewState("par_sCANONEMINIMO") Is Nothing) Then
                Return CStr(ViewState("par_sCANONEMINIMO"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCANONEMINIMO") = value
        End Set
    End Property

    Public Property sCANONECLASSE() As String
        Get
            If Not (ViewState("par_sCANONECLASSE") Is Nothing) Then
                Return CStr(ViewState("par_sCANONECLASSE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCANONECLASSE") = value
        End Set
    End Property

    Public Property sCANONESOPP() As String
        Get
            If Not (ViewState("par_sCANONESOPP") Is Nothing) Then
                Return CStr(ViewState("par_sCANONESOPP"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCANONESOPP") = value
        End Set
    End Property


    Public Property sVALOCIICI() As String
        Get
            If Not (ViewState("par_sVALOCIICI") Is Nothing) Then
                Return CStr(ViewState("par_sVALOCIICI"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sVALOCIICI") = value
        End Set
    End Property

    Public Property sALLOGGIOIDONEO() As String
        Get
            If Not (ViewState("par_sALLOGGIOIDONEO") Is Nothing) Then
                Return CStr(ViewState("par_sALLOGGIOIDONEO"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sALLOGGIOIDONEO") = value
        End Set
    End Property

    Public Property sISTAT() As String
        Get
            If Not (ViewState("par_sISTAT") Is Nothing) Then
                Return CStr(ViewState("par_sISTAT"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sISTAT") = value
        End Set
    End Property

    Public Property sCANONECLASSEISTAT() As String
        Get
            If Not (ViewState("par_sCANONECLASSEISTAT") Is Nothing) Then
                Return CStr(ViewState("par_sCANONECLASSEISTAT"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCANONECLASSEISTAT") = value
        End Set
    End Property



    Public Property sANNOINIZIOVAL() As String
        Get
            If Not (ViewState("par_sANNOINIZIOVAL") Is Nothing) Then
                Return CStr(ViewState("par_sANNOINIZIOVAL"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sANNOINIZIOVAL") = value
        End Set
    End Property

    Public Property sANNOFINEVAL() As String
        Get
            If Not (ViewState("par_sANNOFINEVAL") Is Nothing) Then
                Return CStr(ViewState("par_sANNOFINEVAL"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sANNOFINEVAL") = value
        End Set
    End Property

    Public Function EliminaAvviso()
        Dim DatiAvviso As String = ""
        Try
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)

            par.cmd.CommandText = "SELECT RAPPORTI_UTENZA_AVVISI_LIQ.*,TAB_COD_TRIBUTO.CODICE FROM SISCOM_MI.RAPPORTI_UTENZA_AVVISI_LIQ,SISCOM_MI.TAB_COD_TRIBUTO WHERE TAB_COD_TRIBUTO.ID=RAPPORTI_UTENZA_AVVISI_LIQ.IMPOSTA AND RAPPORTI_UTENZA_AVVISI_LIQ.ID=" & idAvviso.Value
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                DatiAvviso = "IMPOSTA:" & par.IfNull(myReader("CODICE"), "") & " - IMPORTO:" & par.IfNull(myReader("IMPORTO"), "") & " - SANZIONI:" & par.IfNull(myReader("SANZIONI"), "") & " - INTERESSI:" & par.IfNull(myReader("INTERESSI"), "") & " - NOTE:" & Mid(par.IfNull(myReader("NOTE"), ""), 1, 100)
            End If
            myReader.Close()

            par.cmd.CommandText = "DELETE FROM SISCOM_MI.RAPPORTI_UTENZA_AVVISI_LIQ WHERE ID=" & idAvviso.Value
            par.cmd.ExecuteNonQuery()

            par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
               & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
               & "'F02','ELIMINATO AVVISO LIQUIDAZIONE : " & par.PulisciStrSql(DatiAvviso) & "')"
            par.cmd.ExecuteNonQuery()

            SalvaDati()


        Catch ex As Exception
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.OracleConn.Close()
            HttpContext.Current.Session.Remove(lIdConnessione)
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            Session.Add("ERRORE", "EliminaAvviso:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Function


    Public Function AnnullaInvioAE()
        Try
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)

            par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET REG_TELEMATICA=null WHERE ID=" & lIdContratto
            par.cmd.ExecuteNonQuery()

            par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA_IMPOSTE SET ID_FASE_REGISTRAZIONE=3,NOTE='ANNULLATO DA OPERATORE' WHERE ID_FASE_REGISTRAZIONE=1 AND COD_TRIBUTO IN ('107T','115T') AND ID_CONTRATTO=" & lIdContratto
            par.cmd.ExecuteNonQuery()

            par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
               & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
               & "'F02','ANNULLO INVIO FILE XML PRIMA REGISTRAZIONE')"
            par.cmd.ExecuteNonQuery()

            SalvaDati()


            '12/05/2016 MAX CONTROLLO SE CONTRATTO IN PRIMA REGISTRAZIONE
            CType(Tab_Registrazione1.FindControl("lblFaseRegistrazione"), Label).Visible = False
            CType(Tab_Registrazione1.FindControl("btnAnnullaInvio"), ImageButton).Visible = False
            CType(Tab_Registrazione1.FindControl("lblFaseRegistrazione0"), Label).Visible = False
            If Session.Item("CONT_REGISTRAZIONE") = "1" Then
                If CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Text = "" Then
                    If VerificaRegistrazione(lIdContratto) = True Then
                        CType(Tab_Registrazione1.FindControl("lblFaseRegistrazione"), Label).Visible = True
                        If SolaLettura <> "1" Then
                            CType(Tab_Registrazione1.FindControl("btnAnnullaInvio"), ImageButton).Visible = True
                            CType(Tab_Registrazione1.FindControl("lblFaseRegistrazione0"), Label).Visible = True
                        End If
                    End If
                End If
            End If
            'FINE CONTROLLO

        Catch ex As Exception
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.OracleConn.Close()
            HttpContext.Current.Session.Remove(lIdConnessione)
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()

            Session.Add("ERRORE", "Annullo Invio A.E.:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Function


    Public Function RicalcolaCanone()
        Try

            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"

            If lIdDomandaERP = "-1" And lIdDichiarazione = "-1" Then
                Response.Write("<script>alert('Non è possibile calcolare il canone!');</script>")
                Exit Function
            End If

            'Response.Write("<script>alert('Non ancora disponibile');</script>")
            'Exit Function

            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans

            par.cmd.CommandText = "SELECT FL_STAMPATO FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & lIdContratto
            Dim myReaderAA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderAA.Read Then
                If myReaderAA("FL_STAMPATO") = "1" Then
                    Response.Write("<script>alert('Non è possibile calcolare il canone. Il contratto risulta essere stampato!');</script>")
                    myReaderAA.Close()
                    Exit Function
                End If
            End If
            myReaderAA.Close()

            If LetteraERP = "B" Then
                Response.Write("<script>alert('Rapporto con canone Moderato. Non è possibile calcolare il canone ERP!');</script>")
                Exit Function
            End If

            Dim fileName As String = CodContratto1 & ".txt"
            If (TipoContratto = "1" Or TipoContratto = "2") And LetteraERP <> "B" Then
                '---- CALCOLO CANONE 27 ----------
                'CANCELLO TUTTI GLI EVENTUALI FILE DI QUESTO CONTRATTO
                'CHE NON SERVONO PIU ORMAI
                If System.IO.File.Exists(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CodContratto & ".txt")) = True Then
                    fileName = CodContratto1 & "_" & Format(Now, "yyyyMMddHHmmss") & ".txt"
                End If
                'System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CodContratto1 & ".txt"))

                Dim s As String
                Dim comunicazioni As String = ""

                If par.IfEmpty(CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedValue, "-1") = 1 Then
                    s = par.CalcolaCanone27(lIdDomandaERP, 3, UnitaContratto, CodContratto, CanoneCorrente, VAL_LOCATIVO_UNITA, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPiano, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL)
                Else
                    If origineContratto = 5 Then
                        s = par.CalcolaCanone27(lIdAU, 3, UnitaContratto, CodContratto1, CanoneCorrente, VAL_LOCATIVO_UNITA, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPiano, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL)
                    Else
                        If lIdDomandaERP = -1 And lIdDichiarazione <> -1 Then
                            s = par.CalcolaCanone27(lIdDichiarazione, 4, UnitaContratto, CodContratto1, CanoneCorrente, VAL_LOCATIVO_UNITA, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPiano, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL)
                        Else
                            s = par.CalcolaCanone27(lIdDomandaERP, TipoContratto, UnitaContratto, CodContratto1, CanoneCorrente, VAL_LOCATIVO_UNITA, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPiano, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL)
                        End If

                    End If

                End If
                If comunicazioni <> "" Then
                    Response.Write("<script>alert('" & comunicazioni & "');</script>")
                End If


                Dim sr As StreamWriter = New StreamWriter(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, False, System.Text.Encoding.Default)
                sr.WriteLine(s)
                sr.Close()
                LBLNOMEFILECANONE.Value = Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName


                If System.IO.File.Exists(LBLNOMEFILECANONE.Value) = True Then

                    Dim sr1 As StreamReader = New StreamReader(LBLNOMEFILECANONE.Value, System.Text.Encoding.GetEncoding("iso-8859-1"))
                    Dim contenuto As String = sr1.ReadToEnd()
                    sr1.Close()

                    'par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,ISE, ISR, ISP, PSE, VSE, REDDITI_DIP, REDDITI_ATRI, LIMITE_PENSIONI, ISEE_27, PERC_VAL_LOC, INC_MAX, CANONE,TESTO) " _
                    '                    & "VALUES (" & lIdContratto & ",'" & Format(My.Computer.FileSystem.GetFileInfo(LBLNOMEFILECANONE.Value).CreationTime, "yyyyMMddHHmmss") _
                    '                    & "'," & AreaEconomica & ",'" & sISEE & "','" & sISE & "','" & sISR & "','" & sISP & "','" & sPSE & "','" & sVSE & "','" & sREDD_DIP & "','" & sREDD_ALT & "','" & sLimitePensione & "','" & sISE_MIN & "','" & sPER_VAL_LOC & "','" & sPERC_INC_MAX_ISE_ERP & "','" & sCanone & "',:TESTO) "
                    If sNOTE = "" Then
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (CANONE_CLASSE,CANONE_SOPPORTABILE,DECADENZA_ALL_ADEGUATO,DECADENZA_VAL_ICI,CANONE_MINIMO_AREA,VALORE_LOCATIVO,SUP_ACCESSORI,MINORI_15,MAGGIORI_65,DATA_STIPULA,COD_CONTRATTO,ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,ISE, ISR, ISP, PSE, VSE, REDDITI_DIP, REDDITI_ATRI, LIMITE_PENSIONI, " _
                                            & "ISEE_27, PERC_VAL_LOC, INC_MAX, CANONE,TESTO,NOTE,ID_BANDO_AU,DEM, SUPCONVENZIONALE, COSTOBASE, ZONA, PIANO, CONSERVAZIONE, VETUSTA,INCIDENZA_ISE," _
                                            & "COEFF_NUCLEO_FAM,SOTTO_AREA,ANNOTAZIONI,PATRIMONIO_SUP,NON_RISPONDENTE,LIMITE_ISEE,ID_DICHIARAZIONE,CANONE_ATTUALE,ADEGUAMENTO,ISTAT," _
                                            & "NUM_COMP,NUM_COMP_66,NUM_COMP_100,NUM_COMP_100_CON,REDD_PREV_DIP,DETRAZIONI,REDD_MOBILIARI,REDD_IMMOBILIARI,REDD_COMPLESSIVO,DETRAZIONI_FRAGILITA,ANNO_COSTRUZIONE," _
                                            & "LOCALITA,PRESENTE_ASCENSORE,NUMERO_PIANO,SUP_NETTA,ALTRE_SUP,PERC_ISTAT_APPLICATA,CANONE_CLASSE_ISTAT,CANONE_91,INIZIO_VALIDITA_CAN,FINE_VALIDITA_CAN,TIPO_PROVENIENZA) " _
                                            & "VALUES ('" & sCANONECLASSE & "','" & sCANONESOPP & "','" & sALLOGGIOIDONEO & "','" & sVALOCIICI & "','" & sCANONE_MIN & "','" & sVALORELOCATIVO & "','" & par.PulisciStrSql(sSUPACCESSORI) & "'," & sMINORI15 & "," & sMAGGIORI65 & ",'" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Text) & "','" & CType(Tab_Contratto1.FindControl("txtCodContratto"), TextBox).Text & "'," & txtIdContratto.Value & ",'" & Format(Now, "yyyyMMddHHmmss") _
                                            & "'," & AreaEconomica & ",'" & sISEE & "','" & sISE & "','" & sISR & "','" & sISP & "','" & sPSE & "','" & sVSE & "','" & sREDD_DIP & "','" _
                                            & sREDD_ALT & "','" & sLimitePensione & "','" & sISE_MIN & "','" & sPER_VAL_LOC & "','" & sPERC_INC_MAX_ISE_ERP & "','" & sCanone & "',:TESTO,'" _
                                            & par.PulisciStrSql(sNOTE) & "',NULL,'" & sDEM & "','" & sSUPCONVENZIONALE & "','" & sCOSTOBASE & "','" & sZONA & "','" & sPiano & "','" _
                                            & sCONSERVAZIONE & "','" & sVETUSTA & "','" & sINCIDENZAISE & "','" & sCOEFFFAM & "','" & sSOTTOAREA & "','" & sMOTIVODECADENZA & "'," _
                                            & "0" & ",0," & "0" & "," & "null" _
                                            & ",'" & "0" & "','" & "0" & "','" _
                                            & "0" & "'," & sNUMCOMP & "," & sNUMCOMP66 & "," & sNUMCOMP100 & "," & sNUMCOMP100C & "," & sPREVDIP _
                                            & ",'" & sDETRAZIONI & "','" & sMOBILIARI & "','" & sIMMOBILIARI & "','" & sCOMPLESSIVO & "','" & sDETRAZIONEF & "','" & sANNOCOSTRUZIONE & "','" & par.PulisciStrSql(sLOCALITA) _
                                            & "','" & sASCENSORE & "','" & par.PulisciStrSql(sDESCRIZIONEPIANO) & "','" & sSUPNETTA & "','" & par.PulisciStrSql(sALTRESUP) & "','" & sISTAT & "','" & sCANONECLASSEISTAT & "','0','" & sANNOINIZIOVAL & "','" & sANNOFINEVAL & "',4) "
                    Else
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (CANONE_CLASSE,CANONE_SOPPORTABILE,DECADENZA_ALL_ADEGUATO,DECADENZA_VAL_ICI,CANONE_MINIMO_AREA,VALORE_LOCATIVO,SUP_ACCESSORI,MINORI_15,MAGGIORI_65,DATA_STIPULA,COD_CONTRATTO,ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,ISE, ISR, ISP, PSE, VSE, REDDITI_DIP, REDDITI_ATRI," _
                                            & "LIMITE_PENSIONI, ISEE_27, PERC_VAL_LOC, INC_MAX, CANONE,TESTO,NOTE,ID_BANDO_AU,ANNOTAZIONI,PATRIMONIO_SUP,NON_RISPONDENTE,LIMITE_ISEE,ID_DICHIARAZIONE," _
                                            & "CANONE_ATTUALE,ADEGUAMENTO,ISTAT,NUM_COMP,NUM_COMP_66,NUM_COMP_100,NUM_COMP_100_CON,REDD_PREV_DIP,DETRAZIONI,REDD_MOBILIARI,REDD_IMMOBILIARI," _
                                            & "REDD_COMPLESSIVO,DETRAZIONI_FRAGILITA,ANNO_COSTRUZIONE,LOCALITA,PRESENTE_ASCENSORE,NUMERO_PIANO,SUP_NETTA,ALTRE_SUP,PERC_ISTAT_APPLICATA,CANONE_CLASSE_ISTAT,CANONE_91,INIZIO_VALIDITA_CAN,FINE_VALIDITA_CAN,TIPO_PROVENIENZA) " _
                                            & "VALUES ('" & sCANONECLASSE & "','" & sCANONESOPP & "','" & sALLOGGIOIDONEO & "','" & sVALOCIICI & "','" & sCANONE_MIN & "','" & sVALORELOCATIVO & "','" & par.PulisciStrSql(sSUPACCESSORI) & "'," & sMINORI15 & "," & sMAGGIORI65 & ",'" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Text) & "','" & CType(Tab_Contratto1.FindControl("txtCodContratto"), TextBox).Text & "'," & txtIdContratto.Value & ",'" & Format(Now, "yyyyMMddHHmmss") & "',NULL,'','','','','','','','','','','','','',:TESTO,'" & _
                                            par.PulisciStrSql(sNOTE) & "',NULL,'" & sMOTIVODECADENZA & "',0,0,0," _
                                            & "null" & ",'0','0" _
                                            & "','0'," & sNUMCOMP & "," & sNUMCOMP66 & "," & sNUMCOMP100 & "," & sNUMCOMP100C & "," & sPREVDIP _
                                            & ",'" & sDETRAZIONI & "','" & sMOBILIARI & "','" & sIMMOBILIARI & "','" & sCOMPLESSIVO & "','" & sDETRAZIONEF & "','" & sANNOCOSTRUZIONE & "','" _
                                            & par.PulisciStrSql(sLOCALITA) & "','" & sASCENSORE & "','" & par.PulisciStrSql(sDESCRIZIONEPIANO) & "','" & sSUPNETTA & "','" & par.PulisciStrSql(sALTRESUP) & "','" & sISTAT & "','" & sCANONECLASSEISTAT & "','0','" & sANNOINIZIOVAL & "','" & sANNOFINEVAL & "',4) "

                    End If

                    Dim objStream As Stream = File.Open(LBLNOMEFILECANONE.Value, FileMode.Open)
                    Dim buffer(objStream.Length) As Byte
                    objStream.Read(buffer, 0, objStream.Length)
                    objStream.Close()

                    Dim parmData As New Oracle.DataAccess.Client.OracleParameter
                    With parmData
                        .Direction = Data.ParameterDirection.Input
                        .OracleDbType = Oracle.DataAccess.Client.OracleDbType.Blob
                        .ParameterName = "TESTO"
                        .Value = buffer
                    End With

                    par.cmd.Parameters.Add(parmData)
                    par.cmd.ExecuteNonQuery()
                    System.IO.File.Delete(LBLNOMEFILECANONE.Value)
                    par.cmd.Parameters.Remove(parmData)

                    buffer = Nothing
                    objStream = Nothing

                    CaricaDettCanoni(lIdContratto)
                    'Dim testoTabella1 As String = ""

                    'testoTabella1 = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                    '                & "<tr>" _
                    '                & "<td style='height: 15px'>" _
                    '                & "<span style='font-size: 8pt; font-family: Arial'><strong>DATA CALCOLO</strong></span></td>" _
                    '                & "<td style='height: 15px'>" _
                    '                & "<span style='font-size: 8pt; font-family: Arial'><strong>AREA ECONOMICA</strong></span></td>" _
                    '                & "<td style='height: 15px'>" _
                    '                & "<span style='font-size: 8pt; font-family: Arial'><strong>CLASSE</strong></span></td>" _
                    '                & "<td style='height: 15px'>" _
                    '                & "<span style='font-size: 8pt; font-family: Arial'><strong>DATA VALIDITA'</strong></span></td>" _
                    '                & "<td style='height: 15px'>" _
                    '                & "<span style='font-size: 8pt; font-family: Arial'><strong>CANONE</strong></span></td>" _
                    '                & "<td style='height: 15px'>" _
                    '                & "<span style='font-size: 8pt; font-family: Arial'><strong>ORIGINE</strong></span></td>" _
                    '                & "<td style='height: 15px'>" _
                    '                & "<span style='font-size: 8pt; font-family: Arial'><strong></strong></span></td>" _
                    '                & "</tr>"

                    'par.cmd.CommandText = "SELECT CANONI_EC.*,T_TIPO_PROVENIENZA.DESCRIZIONE AS PROVENIENZA FROM SISCOM_MI.CANONI_EC,T_TIPO_PROVENIENZA WHERE CANONI_EC.TIPO_PROVENIENZA=T_TIPO_PROVENIENZA.ID (+) AND ID_CONTRATTO=" & lIdContratto & " ORDER BY DATA_CALCOLO DESC"
                    'myReaderAA = par.cmd.ExecuteReader()
                    'Do While myReaderAA.Read
                    '    testoTabella1 = testoTabella1 _
                    '        & "<tr>" _
                    '        & "<td style='height: 15px'>" _
                    '        & "<span style='font-size: 8pt; font-family: Arial'>" & par.FormattaData(Mid(myReaderAA("DATA_CALCOLO"), 1, 8)) & " " & Mid(myReaderAA("DATA_CALCOLO"), 9, 2) & ":" & Mid(myReaderAA("DATA_CALCOLO"), 11, 2) & "</span></td>" _
                    '        & "<td style='height: 15px'>" _
                    '        & "<span style='font-size: 8pt; font-family: Arial'>" & RicavaTestoAreaEconomica(par.IfNull(myReaderAA("ID_AREA_ECONOMICA"), "0")) & "</span></td>" _
                    '        & "<td style='height: 15px'>" _
                    '        & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReaderAA("SOTTO_AREA"), "") & "</span></td>" _
                    '        & "<td style='height: 15px'>" _
                    '        & "<span style='font-size: 8pt; font-family: Arial'>" & par.FormattaData(par.IfNull(myReaderAA("INIZIO_VALIDITA_CAN"), "")) & "-" & par.FormattaData(par.IfNull(myReaderAA("FINE_VALIDITA_CAN"), "")) & "</span></td>" _
                    '        & "<td style='height: 15px'>" _
                    '        & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReaderAA("CANONE"), "") & "</span></td>" _
                    '        & "<td style='height: 15px'>" _
                    '        & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReaderAA("PROVENIENZA"), "IMPORTATO") & "</span></td>" _
                    '        & "<td style='height: 15px'>" _
                    '        & "<span style='font-size: 8pt; font-family: Arial'>" & "<a href='DettagliCalcolo.aspx?COD=" & CodContratto1 & "&DATA=" & myReaderAA("DATA_CALCOLO") & "&IDC=" & lIdContratto & "' target='_blank'>Visualizza Dettagli</span></td>" _
                    '        & "</tr>"

                    '    'RicavaTestoAreaEconomica
                    'Loop
                    'myReaderAA.Close()
                    'CType(Tab_Canone1.FindControl("lblDettaglioCanoni"), Label).Text = testoTabella1 & "</table>"

                End If


                Dim MESI_ANTICIPO As Integer = 0
                Dim LimiteTassaRegistrazione As Double = 0
                par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=6"
                Dim myReaderJ As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    LimiteTassaRegistrazione = CDbl(par.PuntiInVirgole(par.IfNull(myReaderJ("VALORE"), 0)))
                End If
                myReaderJ.Close()

                par.cmd.CommandText = "SELECT VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=16"
                myReaderJ = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    MESI_ANTICIPO = par.IfNull(myReaderJ("VALORE"), 0)
                End If
                myReaderJ.Close()

                CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text = Format(CanoneCorrente, "0.00")
                CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Text = Format(CanoneCorrente, "0.00")
                CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text = Format(Format((CanoneCorrente / 12), "0.00") * 3, "0.00")
                CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text = Format(Format((CanoneCorrente / 12), "0.00") * MESI_ANTICIPO, "0.00")


                Dim TASSA_REGISTRAZIONE As Double = 0

                TASSA_REGISTRAZIONE = Format((CType(Tab_Registrazione1.FindControl("txtPercTotSu"), Label).Text * CanoneCorrente) / 100, "0")

                If TipoContratto = "6" And (CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Text = "STANDARD" Or CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Text = "431 P.O.R.") Then
                    TASSA_REGISTRAZIONE = Format((CType(Tab_Registrazione1.FindControl("txtPercTotSu"), Label).Text * (CanoneCorrente - ((30 / 100) * CanoneCorrente))) / 100, "0")
                    CType(Tab_Registrazione1.FindControl("Label18"), Label).Text = "RIPARTIZIONE IMPOSTA DI REGISTRAZIONE (contratto agevolato ai sensi dell'art. 2, comma 3)"
                End If

                If TASSA_REGISTRAZIONE > LimiteTassaRegistrazione Then
                    CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text = Format(TASSA_REGISTRAZIONE, "0.00")
                    CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercConduttore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                    CType(Tab_Registrazione1.FindControl("lblRegLoc"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercLocatore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                Else
                    TASSA_REGISTRAZIONE = LimiteTassaRegistrazione
                    CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text = Format(TASSA_REGISTRAZIONE, "0.00")
                    CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercConduttore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                    CType(Tab_Registrazione1.FindControl("lblRegLoc"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercLocatore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                End If

                Dim StringaTabella As String = ""
                Dim adISTAT As Double = 0
                Dim BOLLO_BOLLETTA As Double = 0
                Dim SPESEPOSTALI As Double = 0
                Dim AI As Double = 0
                Dim SPMAV As Double = 0
                Dim AltriAdeguamenti As Double = 0


                AI = (CDbl(par.PuntiInVirgole(CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text)) / CDbl(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedItem.Value))

                par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo=2 and ID_CONTRATTO=" & lIdContratto
                myReaderJ = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    adISTAT = (CDbl(par.PuntiInVirgole(par.IfNull(myReaderJ(0), 0))) / CDbl(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedItem.Value))
                End If
                myReaderJ.Close()

                par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo<>2 and ID_CONTRATTO=" & lIdContratto
                myReaderJ = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    AltriAdeguamenti = (CDbl(par.PuntiInVirgole(par.IfNull(myReaderJ(0), 0))) / CDbl(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedItem.Value))
                End If
                myReaderJ.Close()

                StringaTabella = "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">CANONE/INDENNITA</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(AI, "0.00") & "</td></tr>"
                If adISTAT <> 0 Then
                    StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">MONTANTE/ADEG. ISTAT</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(adISTAT, "0.00") & "</td></tr>"
                End If

                If AltriAdeguamenti <> 0 Then
                    StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">ADEGUAMENTO CANONE/IND.</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(AltriAdeguamenti, "0.00") & "</td></tr>"
                End If

                par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=0"
                myReaderJ = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    BOLLO_BOLLETTA = CDbl(par.PuntiInVirgole(myReaderJ("VALORE")))
                End If
                myReaderJ.Close()

                par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=17"
                myReaderJ = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    SPESEPOSTALI = CDbl(par.PuntiInVirgole(myReaderJ("VALORE")))
                End If
                myReaderJ.Close()

                If BOLLO_BOLLETTA > 0 Then
                    StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">BOLLO</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(BOLLO_BOLLETTA, "0.00") & "</td></tr>"
                End If

                If SPESEPOSTALI > 0 Then
                    StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">SPESE POSTALI</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESEPOSTALI, "0.00") & "</td></tr>"
                End If

                par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=26"
                myReaderJ = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    SPMAV = CDbl(par.PuntiInVirgole(myReaderJ("VALORE")))
                    StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">SPESE MAV</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPMAV, "0.00") & "</td></tr>"
                End If
                myReaderJ.Close()

                CType(Tab_SchemaBollette1.FindControl("lblVociAutomatiche"), Label).Text = "<table><tr><td style=" & Chr(34) & "font-family: Arial; font-size: 9px; font-weight: bold" & Chr(34) & ">OLTRE LE VOCI SOPRA INDICATE, SARANNO AUTOMATICAMENTE INSERITE IN BOLLETTA</td><td></td></tr>" & StringaTabella & "</table>"


                StringaTabella = ""
                Dim SPESE_ISTRUTTORIA As Double = 0

                Dim TotPreventivo As Double = 0
                Dim SPESE_BOLLO As Double = 0

                Select Case TipoContratto
                    Case "1", "2", "10"
                        par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=22"
                    Case "5", "6", "7"
                        par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=23"
                    Case "3"
                        par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=24"
                End Select

                Dim myReaderJJ As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderJJ.Read Then
                    SPESE_ISTRUTTORIA = (CDbl(par.PuntiInVirgole(par.IfNull(myReaderJJ("VALORE"), 0))) * CDbl(par.PuntiInVirgole(CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Text))) / 100
                End If
                myReaderJJ.Close()
                TotPreventivo = TotPreventivo + SPESE_ISTRUTTORIA
                If SPESE_ISTRUTTORIA > 0 Then
                    StringaTabella = "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">SPESE ISTRUTTORIA</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESE_ISTRUTTORIA, "0.00") & "</td></tr>"
                End If

                If CDbl(par.VirgoleInPunti(CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text)) > 0 Then
                    TotPreventivo = TotPreventivo + CDbl(par.PuntiInVirgole(CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text))
                    StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">REGISTRAZIONE CONTRATTO</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text & "</td></tr>"
                End If

                If CDbl(par.VirgoleInPunti(CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text)) > 0 Then
                    TotPreventivo = TotPreventivo + CDbl(par.PuntiInVirgole(CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text))
                    StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">ANTICIPO</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text & "</td></tr>"
                End If

                If CDbl(par.VirgoleInPunti(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text)) > 0 Then
                    TotPreventivo = TotPreventivo + CDbl(par.PuntiInVirgole(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text))
                    StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">CAUZIONE</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text & "</td></tr>"
                End If

                par.cmd.CommandText = "select bollo from siscom_mi.rapporti_utenza where id=" & lIdContratto
                myReaderJJ = par.cmd.ExecuteReader()
                If myReaderJJ.Read Then
                    SPESE_BOLLO = CDbl(par.PuntiInVirgole(par.IfNull(myReaderJJ("BOLLO"), 0)))
                End If
                myReaderJJ.Close()

                If SPESE_BOLLO = 0 Then
                    Dim importoBolloParam As String = ""
                    Dim Pagine As Integer = 1
                    par.cmd.CommandText = "select valore from SISCOM_MI.PARAMETRI_BOLLETTA where ID = 18"
                    Dim myReaderZ1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderZ1.Read Then
                        importoBolloParam = par.IfNull(myReaderZ1("VALORE"), "0")
                    End If
                    myReaderZ1.Close()

                    Dim NumCopie As Integer = 1
                    par.cmd.CommandText = "select valore from SISCOM_MI.PARAMETRI_BOLLETTA where ID = 45"
                    myReaderZ1 = par.cmd.ExecuteReader()
                    If myReaderZ1.Read Then
                        NumCopie = par.IfNull(myReaderZ1("VALORE"), "0")
                    End If
                    myReaderZ1.Close()


                    Select Case TipoContratto
                        Case "1", "2", "10", "6"
                            Pagine = 5
                            SPESE_BOLLO = Ceiling((CDec(Pagine) / 4)) * CDec(par.PuntiInVirgole(importoBolloParam)) * NumCopie
                            StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">BOLLO SU CONTRATTO (STIMATO)</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESE_BOLLO, "0.00") & "</td></tr>"
                        Case "3"
                            Pagine = 6
                            SPESE_BOLLO = Ceiling((CDec(Pagine) / 4)) * CDec(par.PuntiInVirgole(importoBolloParam)) * NumCopie
                            If CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Value = "B" Then
                                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">BOLLO SU CONTRATTO (STIMATO)</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESE_BOLLO, "0.00") & "</td></tr>"
                            Else
                                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">BOLLO SU CONTRATTO (STIMATO)</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESE_BOLLO, "0.00") & "</td></tr>"
                            End If
                        Case "5"
                            Pagine = 6
                            SPESE_BOLLO = Ceiling((CDec(Pagine) / 4)) * CDec(par.PuntiInVirgole(importoBolloParam)) * NumCopie
                            StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">BOLLO SU CONTRATTO (STIMATO)</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESE_BOLLO, "0.00") & "</td></tr>"
                        Case "7"
                            SPESE_BOLLO = 0
                    End Select
                    TotPreventivo = TotPreventivo + SPESE_BOLLO
                Else
                    StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">BOLLO SU CONTRATTO</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESE_BOLLO, "0.00") & "</td></tr>"
                    TotPreventivo = TotPreventivo + SPESE_BOLLO
                End If


                If CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text <> "" And CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text <> "" And CType(Tab_Canone1.FindControl("txtCANONECORRENTE"), TextBox).Text <> "" Then

                    Dim dataProssimoPeriodo As String = ""
                    Dim numerorata As Integer = par.ProssimaRata(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedValue, par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text), dataProssimoPeriodo)
                    Dim iGiorniScad As Double = 10
                    Dim DataScadenza As String = DateAdd("d", iGiorniScad, Now)
                    Dim giorni As Integer = DateDiff("d", CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, par.FormattaData(dataProssimoPeriodo))
                    Dim ImportoResiduo As Double = Format((par.IfEmpty(CType(Tab_Canone1.FindControl("txtCANONECORRENTE"), TextBox).Text, 0) / 365) * giorni, "0.00")
                    If ImportoResiduo < 0 Then ImportoResiduo = 0
                    Dim dataProssimoPeriodo1 As String = ""
                    Dim ImportoResiduo1 As Double = 0

                    Select Case Mid(dataProssimoPeriodo, 5, 2)
                        Case "02", "04", "06", "08", "10", "12"
                            numerorata = par.ProssimaRata(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedValue, par.AggiustaData(DateAdd(DateInterval.Day, 1, CDate(par.FormattaData(dataProssimoPeriodo)))), dataProssimoPeriodo1)
                            ImportoResiduo1 = Format((par.IfEmpty(CType(Tab_Canone1.FindControl("txtCANONECORRENTE"), TextBox).Text, 0) / 12), "0.00")

                        Case Else

                    End Select
                    If ImportoResiduo > 0 Then
                        TotPreventivo = TotPreventivo + ImportoResiduo
                        StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">CANONE MESI PRECEDENTI/MESE CORRENTE</td><td style=" & Chr(34) & "font-family: Arial; font-size: 12px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(ImportoResiduo, "0.00") & "</td></tr>"

                    End If

                    If ImportoResiduo1 > 0 Then
                        TotPreventivo = TotPreventivo + ImportoResiduo1
                        StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">CANONE</td><td style=" & Chr(34) & "font-family: Arial; font-size: 12px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(ImportoResiduo1, "0.00") & "</td></tr>"

                    End If
                End If

                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">Totale</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(TotPreventivo, "0.00") & "</td></tr>"
                CType(Tab_Bollette1.FindControl("lblPreventivo"), Label).Text = "<table><tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">IMPORTO PRESUNTO BOLLETTE DI ATTIVAZIONE</td><td></td></tr>" & StringaTabella & "</table>"


                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                & "'F37','')"
                par.cmd.ExecuteNonQuery()

                SalvaDati()


                'Response.Write("<script>alert('Operazione effettuata');</script>")


            End If




        Catch EX1 As Oracle.DataAccess.Client.OracleException
            If EX1.Number = 54 Then
                Dim scriptblock As String = ""

                par.OracleConn.Close()
                Session.Item("LAVORAZIONE") = "0"
                scriptblock = "<script language='javascript' type='text/javascript'>" _
                & "alert('Contratto in fase d formalizzazione. Non è possibile procedere!');window.close();" _
                & "</script>"
                If (Not Page.ClientScript.IsClientScriptBlockRegistered("clientScript4")) Then
                    Page.ClientScript.RegisterClientScriptBlock(Me.GetType(), "clientScript4", scriptblock)
                End If
            Else
                Session.Item("LAVORAZIONE") = "0"
                par.myTrans.Rollback()
                par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
                par.OracleConn.Close()
                HttpContext.Current.Session.Remove(lIdConnessione)
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()

                Session.Add("ERRORE", "Ricalcolo Canone:" & Page.Title & " - " & EX1.Message)
                Response.Write("<script>top.location.href='../Errore.aspx';</script>")
            End If


        Catch ex As Exception
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.OracleConn.Close()
            HttpContext.Current.Session.Remove(lIdConnessione)
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()

            Session.Add("ERRORE", "Ricalcolo Canone:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Function

    Private Function ControllaCreazBozza(ByVal codContr As String) As String
        Dim codRUAbusivo As String = ""
        Try
            If par.OracleConn.State = Data.ConnectionState.Closed Then
                par.OracleConn.Open()
                par.SettaCommand(par)
            End If

            '***** CONTROLLO PRESENZA DI BOZZA NATA DA UN PROCEDIMENTO DI GESTIONE LOCATARI *****
            par.cmd.CommandText = "SELECT * FROM domande_bando_vsa WHERE contratto_num='" & codContr & "' AND (ID_MOTIVO_DOMANDA=0 or ID_MOTIVO_DOMANDA=8 or ID_MOTIVO_DOMANDA=9 or ID_MOTIVO_DOMANDA=10) AND FL_AUTORIZZAZIONE=1"
            Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader1.Read Then
                codRUAbusivo = par.IfNull(myReader1("COD_CONTRATTO_BOZZA"), "")
            Else
                codRUAbusivo = ""
            End If
            myReader1.Close()

            par.cmd.Dispose()
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()

        Catch ex As Exception
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try

        Return codRUAbusivo

    End Function

    Private Sub RicavaDatiDomandaOriginari()
        Try
            If par.OracleConn.State = Data.ConnectionState.Closed Then
                par.OracleConn.Open()
                par.SettaCommand(par)
            End If

            Dim aggRedd As Integer = 0
            par.cmd.CommandText = "SELECT id_d_import FROM DOMANDE_BANDO_VSA WHERE ID_MOTIVO_DOMANDA = 11 AND ID=" & lIdDomandaERP
            Dim myReaderE As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderE.Read Then
                aggRedd = 1

                par.cmd.CommandText = "select * from domande_bando where id_dichiarazione=" & par.IfNull(myReaderE("id_d_import"), 0)
                Dim myReaderE1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderE1.Read Then
                    idDomandaOrigine.Value = CStr(par.IfNull(myReaderE1("ID"), "0"))
                    idDichOrigine.Value = CStr(par.IfNull(myReaderE1("ID_dichiarazione"), "0"))
                Else
                    par.cmd.CommandText = "select * from domande_bando_cambi where id_dichiarazione=" & par.IfNull(myReaderE("id_d_import"), 0)
                    Dim myReaderE1B As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderE1B.Read Then
                        idDomandaOrigine.Value = CStr(par.IfNull(myReaderE1B("ID"), "0"))
                        idDichOrigine.Value = CStr(par.IfNull(myReaderE1B("ID_dichiarazione"), "0"))
                    End If
                    myReaderE1B.Close()
                End If
                myReaderE1.Close()
            End If
            myReaderE.Close()

            If idDomandaOrigine.Value = "0" Then
                idDomandaOrigine.Value = CStr(lIdDomandaERP)
            End If
            If idDichOrigine.Value = "0" Then
                idDichOrigine.Value = CStr(lIdDichiarazione)
            End If

            par.cmd.Dispose()
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()

        Catch ex As Exception
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try

    End Sub

    Private Function Controlla3bollette(ByVal idContr As Long) As Boolean
        Dim max3bollette As Boolean = True
        Try
            If par.OracleConn.State = Data.ConnectionState.Closed Then
                par.OracleConn.Open()
                par.SettaCommand(par)
            End If

            par.cmd.CommandText = "SELECT COUNT(ID) AS NUM_BOLLETTE FROM SISCOM_MI.BOL_BOLLETTE WHERE ID_CONTRATTO=" & idContr & " AND FL_ANNULLATA=0 AND ID_BOLLETTA_STORNO IS NULL"
            Dim da1 As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            Dim dt1 As New Data.DataTable
            da1.Fill(dt1)
            da1.Dispose()
            If dt1.Rows(0).Item("NUM_BOLLETTE") > "1" And dt1.Rows(0).Item("NUM_BOLLETTE") <= "3" Then
                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.BOL_BOLLETTE WHERE ID_CONTRATTO=" & idContr
                Dim da2 As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
                Dim dt2 As New Data.DataTable
                da2.Fill(dt2)
                da2.Dispose()
                For Each row As Data.DataRow In dt2.Rows
                    If row.Item("N_RATA") <> 999 Then
                        max3bollette = False
                    End If
                Next
            Else
                max3bollette = False
            End If

            par.cmd.Dispose()
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()

        Catch ex As Exception
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try

        Return max3bollette

    End Function

    Private Sub VisualizzaStoricoReg()
        Try
            Dim ConnAperta As Boolean = False
            If par.OracleConn.State = Data.ConnectionState.Closed Then
                ConnAperta = True
                par.OracleConn.Open()
                par.SettaCommand(par)
            End If

            par.cmd.CommandText = "select count(id) as contaRU from siscom_mi.RAPP_UTENZA_INFO_REGISTRAZONE where id_contratto=" & lIdContratto
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                If myReader("contaRU") > 1 Then
                    mostraStoricoReg.Value = "1"
                End If
            End If
            myReader.Close()

            If ConnAperta = True Then
                par.OracleConn.Close()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            End If

        Catch ex As Exception
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Sub


    Private Sub RicavaAU392()
        Try
            Dim ConnAperta As Boolean = False
            If par.OracleConn.State = Data.ConnectionState.Closed Then
                ConnAperta = True
                par.OracleConn.Open()
                par.SettaCommand(par)
            End If

            Dim senzaTitolo As Boolean = False
            Dim contrattoChiuso As Boolean = False

            par.cmd.CommandText = "select id_dichiarazione from UTENZA_DICH_CANONI_EC where id_Contratto=" & lIdContratto & " order by id desc"
            Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader1.Read Then
                idAU392.Value = par.IfNull(myReader1("id_dichiarazione"), 0)
            End If
            myReader1.Close()

            par.cmd.CommandText = "select * from UTENZA_DICHIARAZIONI where id=" & idAU392.Value & " and id_stato=1"
            myReader1 = par.cmd.ExecuteReader()
            If myReader1.Read = False Then
                idAU392.Value = "0"
            End If
            myReader1.Close()

            par.cmd.CommandText = "select * from siscom_mi.eventi_contratti where id_contratto=" & lIdContratto & " and cod_evento='F273'"
            myReader1 = par.cmd.ExecuteReader()
            If myReader1.Read Then
                senzaTitolo = True
            End If
            myReader1.Close()

            par.cmd.CommandText = "select * from siscom_mi.bol_Bollette where id_contratto=" & lIdContratto & " and id_tipo=3 and id_bolletta_storno is null"
            myReader1 = par.cmd.ExecuteReader()
            If myReader1.Read Then
                contrattoChiuso = True
            End If
            myReader1.Close()

            If idAU392.Value <> "0" Then
                par.cmd.CommandText = "select * from siscom_mi.rapporti_utenza where id=" & lIdContratto
                myReader1 = par.cmd.ExecuteReader()
                If myReader1.Read Then
                    If contrattoChiuso = True Then
                        par.cmd.CommandText = "SELECT * FROM siscom_mi.UNITA_ASSEGNATE WHERE " _
                            & " id_dichiarazione=" & idAU392.Value
                        Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If lettore.Read Then
                            idAU392.Value = "0"
                            traformaRUstep2.Value = "0"
                        Else
                            traformaRUstep2.Value = "1"
                        End If
                        lettore.Close()
                    End If
                    If par.IfNull(myReader1("data_disdetta_locatario"), "") <> "" And senzaTitolo = True And par.IfNull(myReader1("data_riconsegna"), "") = "" Then
                        idAU392.Value = "0"
                        traformaRUstep2.Value = "0"
                    End If
                End If
                myReader1.Close()
            End If
            If ConnAperta = True Then
                par.OracleConn.Close()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            End If
        Catch ex As Exception
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Sub

    Private Sub CaricaSchemaBoll()
        Try
            Dim LL As Integer = 0
            'CARICAMENTO schema bollette

            CType(Tab_SchemaBollette1.FindControl("Label4"), Label).Text = "SCHEMA VOCI BOLLETTA" & " " & sAnnoSchema & "  -  <a href='SchemaAltriAnni.aspx?CN=" & lIdConnessione & "&ID=" & lIdContratto & "&A=" & sAnnoSchema & "' target='_blank'>Clicca qui per visualizzare lo schema di altri anni</a>"

            'MODIFICATO ORDINE DI VISUALIZZAZIONE VOCI (PER IMPORTO ASC)
            par.cmd.CommandText = "select bol_schema.*,t_voci_bolletta.descrizione from SISCOM_MI.t_voci_bolletta, SISCOM_MI.bol_schema where t_voci_bolletta.id=bol_schema.id_voce and bol_schema.id_contratto=" & lIdContratto & " and anno=" & sAnnoSchema & " order by t_voci_bolletta.descrizione,(-importo) ASC"
            Dim da As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            Dim ds As New Data.DataSet()
            da.Fill(ds, "BOL_SCHEMA")

            CType(Tab_SchemaBollette1.FindControl("DataGridSchema"), DataGrid).DataSource = ds
            CType(Tab_SchemaBollette1.FindControl("DataGridSchema"), DataGrid).DataBind()


        Catch ex As Exception
            par.myTrans.Rollback()
            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            HttpContext.Current.Session.Remove(lIdConnessione)
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " (funzione CaricaSchemaBoll) - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Sub


    Public Sub CaricaTabBollette()
        Try
            Dim ConnAperta As Boolean = False
            Dim num_bolletta As String = ""
            Dim I As Integer = 0
            Dim importobolletta As Decimal = 0
            Dim importopagato As Decimal = 0
            Dim residuo As Decimal = 0
            Dim morosita As Integer = 0
            Dim riclass As Integer = 0
            Dim indiceMorosita As Integer = 0
            Dim indiceBolletta As Integer = 0
            Dim storno As Integer = 0
            Dim da1 As Oracle.DataAccess.Client.OracleDataAdapter
            Dim NoteBolletta As String = ""

            Dim sAggiuntaStornate As String = ""

            If par.OracleConn.State = Data.ConnectionState.Closed Then
                ConnAperta = True
                par.OracleConn.Open()
                par.SettaCommand(par)
            End If

            If EscludiS.Value = "1" Then
                sAggiuntaStornate = " BOL_BOLLETTE.ID_BOLLETTA_STORNO IS NULL AND BOL_BOLLETTE.ID_TIPO<>22 AND "
            End If
            SaldoContratto = par.CalcolaSaldoAttuale(lIdContratto)
            CType(Tab_Bollette1.FindControl("lblSaldoCont"), Label).Text = "<a href='javascript:void(0)' style='text-decoration: none;' link {color:#993333;} visited {color:#993333;} onclick=" & Chr(34) & "javascript:document.getElementById('USCITA').value='1';window.open('../Contabilita/DatiUtenza.aspx?C=RisUtenza&IDANA=" & txtCodAffittuario.Value & "&IDCONT=" & lIdContratto & "','EstrattoConto','');" & Chr(34) & " alt='Visualizza Dettagli'>" & Format(SaldoContratto, "##,##0.00") & " €</a>"
            CType(Tab_Bollette1.FindControl("lblImpRateizzato"), Label).Text = "<a href='javascript:void(0)' style='text-decoration: none;' link {color:#993333;} visited {color:#993333;} onclick=" & Chr(34) & "javascript:document.getElementById('USCITA').value='1';window.open('../RATEIZZAZIONE/RateizzEmesse.aspx?idcont=" & lIdContratto & "','Rateizzazioni','');" & Chr(34) & " alt='Visualizza Dettagli'>" & Format(par.CalcolaImportoRateizzato(lIdContratto), "##,##0.00") & " €</a>"

            CType(Generale1.FindControl("Label20"), Label).Text = "Saldo al " & Format(Now, "dd/MM/yyyy")
            CType(Generale1.FindControl("lblSaldoAttuale"), Label).Text = "<a href='#' onclick=" & Chr(34) & "javascript:window.open('../Contabilita/DatiUtenza.aspx?C=RisUtenza&IDANA=" & txtCodAffittuario.Value & "&IDCONT=" & lIdContratto & "','EstrattoConto','');" & Chr(34) & " alt='Visualizza Dettagli'>" & Format(SaldoContratto, "##,##0.00") & "</a>"


            par.cmd.CommandText = "select TIPO_BOLL_INGIUNZIONE.DESCRIZIONE AS INGIUNZIONE, TIPO_BOLLETTE.ACRONIMO,bol_bollette.* from SISCOM_MI.TIPO_BOLLETTE,siscom_mi.bol_bollette,SISCOM_MI.TIPO_BOLL_INGIUNZIONE where " & sAggiuntaStornate & " " _
                & " BOL_BOLLETTE.ID_TIPO=TIPO_BOLLETTE.ID (+) AND TIPO_BOLL_INGIUNZIONE.ID(+)=ID_TIPO_INGIUNZIONE And bol_bollette.id_contratto=" & lIdContratto & " order by bol_bollette.data_emissione desc," _
                & " BOL_BOLLETTE.riferimento_da desc,BOL_BOLLETTE.riferimento_a desc,BOL_BOLLETTE.ANNO DESC,BOL_BOLLETTE.N_RATA DESC,bol_bollette.id desc"
            da1 = New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            Dim dtQuery As New Data.DataTable
            Dim dt1 As New Data.DataTable
            Dim rowDT As System.Data.DataRow

            dt1.Columns.Add("id")
            dt1.Columns.Add("num_tipo")
            dt1.Columns.Add("riferimento_da")
            dt1.Columns.Add("riferimento_a")
            dt1.Columns.Add("data_emissione")
            dt1.Columns.Add("data_scadenza")
            dt1.Columns.Add("importo_totale")
            dt1.Columns.Add("importobolletta")
            dt1.Columns.Add("imp_pagato")
            dt1.Columns.Add("imp_residuo")
            dt1.Columns.Add("data_pagamento")
            dt1.Columns.Add("note")
            dt1.Columns.Add("fl_mora")
            dt1.Columns.Add("fl_rateizz")
            dt1.Columns.Add("id_tipo")
            dt1.Columns.Add("dettagli")
            dt1.Columns.Add("anteprima")
            dt1.Columns.Add("importo_ruolo")
            dt1.Columns.Add("imp_ruolo_pagato")
            dt1.Columns.Add("sgravio")
            dt1.Columns.Add("ingiunzione")
            dt1.Columns.Add("importo_ingiunzione")
            dt1.Columns.Add("imp_ingiunzione_pag")

            da1.Fill(dtQuery)
            da1.Dispose()

            Dim TOTimportobolletta As Decimal = 0
            Dim TOTimportopagato As Decimal = 0
            Dim TOTimportoresiduo As Decimal = 0
            Dim TOTimportoEmesso As Decimal = 0
            Dim TOTImpRuoloPag As Decimal = 0
            Dim TOTImpRuolo As Decimal = 0

            Dim TOTImpIngPag As Decimal = 0
            Dim TOTImpIng As Decimal = 0
            For Each row As Data.DataRow In dtQuery.Rows
                indiceMorosita = 0
                indiceBolletta = 0
                rowDT = dt1.NewRow()

                Select Case par.IfNull(row.Item("n_rata"), "")
                    Case "99" 'bolletta manuale
                        num_bolletta = "MA"
                    Case "999" 'bolletta automatica
                        num_bolletta = "AU"
                    Case "99999" 'bolletta di conguaglio
                        num_bolletta = "CO"
                    Case Else
                        num_bolletta = Format(par.IfNull(row.Item("n_rata"), "??"), "00")
                End Select

                importobolletta = par.IfNull(row.Item("IMPORTO_TOTALE"), "0,00") - par.IfNull(row.Item("IMPORTO_RIC_B"), 0) - par.IfNull(row.Item("QUOTA_SIND_B"), 0) '
                If par.IfNull(row.Item("FL_ANNULLATA"), 0) = 0 Or (par.IfNull(row.Item("FL_ANNULLATA"), 0) <> 0 And par.IfNull(row.Item("data_pagamento"), "") = "") Then
                    TOTimportobolletta = TOTimportobolletta + importobolletta
                End If

                importopagato = (par.IfNull(row.Item("IMPORTO_PAGATO"), "0,00") - par.IfNull(row.Item("IMPORTO_RIC_PAGATO_B"), 0) - par.IfNull(row.Item("QUOTA_SIND_PAGATA_B"), 0))
                If par.IfNull(row.Item("FL_ANNULLATA"), 0) = 0 Or (par.IfNull(row.Item("FL_ANNULLATA"), 0) <> 0 And par.IfNull(row.Item("data_pagamento"), "") = "") Then
                    TOTimportopagato = TOTimportopagato + importopagato
                End If



                Dim STATO As String = ""
                If par.IfNull(row.Item("FL_ANNULLATA"), "0") <> "0" Then
                    STATO = "ANNUL."
                Else
                    STATO = "VALIDA"
                End If
                If par.IfNull(row.Item("id_bolletta_ric"), "0") <> "0" Or par.IfNull(row.Item("ID_RATEIZZAZIONE"), "0") <> "0" Then
                    STATO = "RICLA."
                    riclass = 1
                End If

                If par.IfNull(row.Item("id_bolletta_storno"), "0") <> "0" Then
                    STATO = "STORN."
                End If

                'residuo = importobolletta - importopagato
                If par.IfNull(row.Item("FL_ANNULLATA"), "0") <> "0" Then
                    residuo = 0
                Else
                    residuo = importobolletta - (importopagato + par.IfNull(row.Item("imp_ruolo_pagato"), 0) + par.IfNull(row.Item("imp_ingiunzione_pag"), 0))
                End If

                TOTimportoresiduo = TOTimportoresiduo + residuo

                'Select Case par.IfNull(row.Item("ID_TIPO"), "0")
                '    Case "3"
                '        CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "yellow")
                '    Case "4"
                '        CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "yellow")
                'End Select

                rowDT.Item("num_tipo") = num_bolletta & " " & STATO & " " & par.IfNull(row.Item("ACRONIMO"), "---")
                rowDT.Item("riferimento_da") = par.FormattaData(par.IfNull(row.Item("riferimento_da"), ""))
                rowDT.Item("riferimento_a") = par.FormattaData(par.IfNull(row.Item("riferimento_a"), ""))
                rowDT.Item("data_emissione") = par.FormattaData(par.IfNull(row.Item("data_emissione"), ""))
                rowDT.Item("data_scadenza") = par.FormattaData(par.IfNull(row.Item("data_scadenza"), ""))
                rowDT.Item("importobolletta") = Format(importobolletta, "##,##0.00")
                rowDT.Item("imp_pagato") = Format(importopagato, "##,##0.00")
                rowDT.Item("imp_residuo") = Format(residuo, "##,##0.00")
                rowDT.Item("data_pagamento") = par.FormattaData(par.IfNull(row.Item("data_pagamento"), ""))
                NoteBolletta = par.IfNull(row.Item("NOTE"), "")
                rowDT.Item("importo_ruolo") = Format(par.IfNull(row.Item("IMPORTO_RUOLO"), 0), "##,##0.00")
                rowDT.Item("imp_ruolo_pagato") = Format(par.IfNull(row.Item("imp_ruolo_pagato"), 0), "##,##0.00")
                rowDT.Item("importo_totale") = Format(par.IfNull(row.Item("IMPORTO_TOTALE"), 0), "##,##0.00")
                rowDT.Item("INGIUNZIONE") = par.IfNull(row.Item("INGIUNZIONE"), "")
                rowDT.Item("importo_ingiunzione") = Format(par.IfNull(row.Item("importo_ingiunzione"), 0), "##,##0.00")
                rowDT.Item("imp_ingiunzione_pag") = Format(par.IfNull(row.Item("imp_ingiunzione_pag"), 0), "##,##0.00")

                If par.IfNull(row.Item("imp_ruolo_pagato"), 0) > 0 Then
                    rowDT.Item("sgravio") = ImpostaFlSgravio(par.IfNull(row.Item("ID"), 0), CDec(par.IfNull(row.Item("IMPORTO_RUOLO"), 0)))
                Else
                    rowDT.Item("sgravio") = "N"
                End If

                'If par.IfNull(row.Item("ID_TIPO"), "0") = 4 Then
                '    rowDT.Item("fl_mora") = "<a href=javascript:apriMorosita();void(0); onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & ">SI</a>"
                'Else
                '    rowDT.Item("fl_mora") = "NO"
                'End If

                TOTImpRuolo = TOTImpRuolo + rowDT.Item("importo_ruolo")
                TOTImpRuoloPag = TOTImpRuoloPag + rowDT.Item("imp_ruolo_pagato")

                TOTImpIng = TOTImpIng + rowDT.Item("importo_ingiunzione")
                TOTImpIngPag = TOTImpIngPag + rowDT.Item("imp_ingiunzione_pag")

                TOTimportoEmesso = TOTimportoEmesso + rowDT.Item("importo_totale")

                If par.IfNull(row.Item("ID_RATEIZZAZIONE"), "0") <> "0" Then
                    rowDT.Item("fl_rateizz") = "<a href=""javascript:void(0)"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';window.open('DettRateizz.aspx?IDB=" & par.IfNull(row.Item("id"), 0) & "', '', 'height=550,top=0,left=0,width=800');" & Chr(34) & ">SI</a>"
                Else
                    rowDT.Item("fl_rateizz") = "NO"
                End If

                indiceMorosita = par.IfNull(row.Item("id_morosita"), 0)

                If indiceMorosita <> 0 And par.IfNull(row.Item("id_bolletta_ric"), 0) <> 0 Then
                    rowDT.Item("fl_mora") = "<a href=""javascript:apriMorosita();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & ">SI</a>"
                Else
                    rowDT.Item("fl_mora") = "NO"
                End If

                rowDT.Item("id_tipo") = par.IfNull(row.Item("ID_TIPO"), 0)

                rowDT.Item("id") = par.IfNull(row.Item("id"), 0)

                If rowDT.Item("id_tipo") = "3" Or rowDT.Item("id_tipo") = "4" Then
                    morosita = 1
                End If

                Select Case par.IfNull(row.Item("id_tipo"), 0)
                    Case "3"
                        indiceBolletta = par.IfNull(row.Item("id"), 0)
                    Case "4"
                        indiceMorosita = par.IfNull(row.Item("id_morosita"), -1)
                        indiceBolletta = 0
                    Case "5"
                        indiceBolletta = par.IfNull(row.Item("id"), 0)
                        indiceBolletta = 0
                    Case "22"
                        storno = 1
                End Select

                If par.IfNull(row.Item("id_bolletta_ric"), 0) <> 0 Then
                    indiceBolletta = par.IfNull(row.Item("id"), 0)
                End If

                If par.IfNull(row.Item("id_rateizzazione"), 0) <> 0 Then
                    indiceBolletta = par.IfNull(row.Item("id"), 0)
                End If

                If indiceBolletta = 0 Then
                    rowDT.Item("dettagli") = ""
                Else
                    If indiceMorosita = 0 And par.IfNull(row.Item("importo_ric_b"), 0) <> 0 Then
                        CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).Columns(2).Visible = True
                        '   divGestCon.Value = "1"
                        CType(Tab_Bollette1.FindControl("divContabCon"), HiddenField).Value = "1"
                        rowDT.Item("dettagli") = "<a href=""javascript:apriMorosita();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Info bolletta" & Chr(34) & " title=" & Chr(34) & "Dettagli Bolletta" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "../NuoveImm/Img_Info.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                    End If
                End If

                rowDT.Item("anteprima") = "<a href=""javascript:ApriAnteprima();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Info bolletta" & Chr(34) & " title=" & Chr(34) & "Visualizza Bolletta" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "16px" & Chr(34) & " src=" & Chr(34) & "../NuoveImm/search-icon.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"

                If par.IfNull(row.Item("ID_TIPO"), 0) = 22 Then
                    CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).Columns(2).Visible = True
                    CType(Tab_Bollette1.FindControl("divContabCon"), HiddenField).Value = "1"
                    rowDT.Item("dettagli") = "<a href=""javascript:apriMorosita();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Info bolletta" & Chr(34) & " title=" & Chr(34) & "Dettagli Bolletta" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "../NuoveImm/Img_Info.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                End If
                If STATO <> "STORN." Then
                    par.cmd.CommandText = "SELECT ELENCO_BOLL_CDP.ID_CDP,RAPPORTI_UTENZA_DEP_CAUZ.* FROM SISCOM_MI.RAPPORTI_UTENZA_DEP_CAUZ,SISCOM_MI.ELENCO_BOLL_CDP WHERE ELENCO_BOLL_CDP.ID_BOLLETTA=RAPPORTI_UTENZA_DEP_CAUZ.ID_BOLLETTA AND RAPPORTI_UTENZA_DEP_CAUZ.ID_BOLLETTA=" & rowDT.Item("id")
                    Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader1.HasRows = True Then
                        If myReader1.Read Then
                            rowDT.Item("dettagli") = rowDT.Item("dettagli") & "&nbsp;" & "<a href=""javascript:StampaCdp(" & rowDT.Item("id") & ");void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Stampa CdP" & Chr(34) & " title=" & Chr(34) & "Stampa CdP" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "../NuoveImm/Img_CDP.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                            If par.IfNull(myReader1("NUM_MANDATO"), "") <> "" Then
                                NoteBolletta = NoteBolletta & " - Rimborsato - mandato pag. n. " & par.IfNull(myReader1("num_mandato"), "") & "/" & par.IfNull(myReader1("anno_mandato"), "") & " del " & par.FormattaData(par.IfNull(myReader1("data_mandato"), ""))
                            End If
                        End If
                    End If
                    myReader1.Close()

                    par.cmd.CommandText = "SELECT ELENCO_BOLL_CDP.id_cdp,PAGAMENTI.DATA_MANDATO,PAGAMENTI.NUMERO_MANDATO FROM siscom_mi.ELENCO_BOLL_CDP,SISCOM_MI.PAGAMENTI WHERE PAGAMENTI.ID=ELENCO_BOLL_CDP.ID_CDP AND ELENCO_BOLL_CDP.id_boll_gest IS NOT NULL AND ELENCO_BOLL_CDP.id_bolletta=" & rowDT.Item("id")
                    myReader1 = par.cmd.ExecuteReader()
                    If myReader1.HasRows = True Then
                        If myReader1.Read Then
                            rowDT.Item("dettagli") = rowDT.Item("dettagli") & "&nbsp;" & "<a href=""javascript:StampaCdp(" & rowDT.Item("id") & ");void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Stampa CdP" & Chr(34) & " title=" & Chr(34) & "Stampa CdP" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "../NuoveImm/Img_CDP.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                            If par.IfNull(myReader1("NUMERO_MANDATO"), "") <> "" Then
                                NoteBolletta = NoteBolletta & " - Rimborsato - mandato pag. n. " & par.IfNull(myReader1("numERO_mandato"), "") & "/" & Mid(par.IfNull(myReader1("DATA_MANDATO"), ""), 1, 4) & " del " & par.FormattaData(par.IfNull(myReader1("data_mandato"), ""))
                            End If
                        End If
                    End If
                    myReader1.Close()
                End If
                rowDT.Item("note") = NoteBolletta

                dt1.Rows.Add(rowDT)
            Next

            CType(Tab_Bollette1.FindControl("lblImpRuolo"), Label).Text = Format((TOTImpRuolo - TOTImpRuoloPag), "##,##0.00") & " €"
            CType(Tab_Bollette1.FindControl("lblImpIngiunto"), Label).Text = Format((TOTImpIng - TOTImpIngPag), "##,##0.00") & " €"

            If dt1.Rows.Count = 0 Then
                CType(Tab_Bollette1.FindControl("bolletteAssenti"), HiddenField).Value = "1"
            End If

            If dt1.Rows.Count > 0 Then
                rowDT = dt1.NewRow()
                rowDT.Item("id") = "-1"
                rowDT.Item("num_tipo") = ""
                rowDT.Item("riferimento_da") = ""
                rowDT.Item("riferimento_a") = "TOTALE"
                rowDT.Item("data_emissione") = ""
                rowDT.Item("data_scadenza") = ""
                rowDT.Item("importo_totale") = Format(TOTimportoEmesso, "##,##0.00")
                rowDT.Item("importobolletta") = Format(TOTimportobolletta, "##,##0.00")
                rowDT.Item("imp_pagato") = Format(TOTimportopagato, "##,##0.00")
                rowDT.Item("imp_residuo") = Format(TOTimportoresiduo, "##,##0.00")
                rowDT.Item("data_pagamento") = ""
                rowDT.Item("note") = ""
                rowDT.Item("fl_mora") = ""
                rowDT.Item("fl_rateizz") = ""
                rowDT.Item("importo_ruolo") = Format(TOTImpRuolo, "##,##0.00")
                rowDT.Item("imp_ruolo_pagato") = Format(TOTImpRuoloPag, "##,##0.00")
                rowDT.Item("importo_ingiunzione") = Format(TOTImpIng, "##,##0.00")
                rowDT.Item("imp_ingiunzione_pag") = Format(TOTImpIngPag, "##,##0.00")
                rowDT.Item("id_tipo") = ""
                rowDT.Item("dettagli") = ""
                rowDT.Item("anteprima") = ""
                dt1.Rows.Add(rowDT)
            End If

            If NumElementiVisualizzati.Value = "0" Then NumElementiVisualizzati.Value = "10"

            If CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).PageSize <> NumElementiVisualizzati.Value Then
                CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).CurrentPageIndex = 0
            End If
            CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).PageSize = NumElementiVisualizzati.Value
            CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).DataSource = dt1
            CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).DataBind()
            contaBollette.Value = dt1.Rows.Count
            CType(Tab_Bollette1.FindControl("Label10"), Label).Text = " Boll. su " & contaBollette.Value & " (Pag. " & CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).CurrentPageIndex + 1 & " di " & CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).PageCount & ")"
            ''If morosita = 1 Then
            ''    For Each di As DataGridItem In CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).Items
            ''        If di.Cells(15).Text.Contains("3") Or di.Cells(15).Text.Contains("4") Then
            ''            di.ForeColor = Drawing.ColorTranslator.FromHtml("red")
            ''        End If
            ''    Next
            ''End If
            'If contaBollette.Value <= 8 Then
            '    CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).HeaderStyle.BackColor = Drawing.ColorTranslator.FromHtml("#006699")
            'End If


            'If riclass = 1 Then
            '    For Each di As DataGridItem In CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).Items
            '        If di.Cells(3).Text.Contains("RICLA.") Then
            '            di.ForeColor = Drawing.ColorTranslator.FromHtml("blue")
            '        End If
            '    Next
            'End If
            'If storno = 1 Then
            '    For Each di As DataGridItem In CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).Items
            '        If di.Cells(17).Text = "22" Then
            '            di.ForeColor = Drawing.ColorTranslator.FromHtml("red")
            '        End If
            '        If di.Cells(3).Text.Contains("STORN.") Then
            '            di.ForeColor = Drawing.ColorTranslator.FromHtml("red")
            '        End If
            '        If di.Cells(3).Text.Contains("ANNUL.") Then
            '            di.ForeColor = Drawing.ColorTranslator.FromHtml("red")
            '        End If
            '    Next
            'End If
            If contaBollette.Value <= 8 Then
                CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).HeaderStyle.BackColor = Drawing.ColorTranslator.FromHtml("#006699")
            End If

            For Each di As DataGridItem In CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).Items
                If riclass = 1 Then
                    If di.Cells(par.IndDGC(CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid), "num_tipo")).Text.Contains("RICLA.") Then
                        di.ForeColor = Drawing.ColorTranslator.FromHtml("blue")
                    End If
                End If

                If storno = 1 Then
                    If di.Cells(par.IndDGC(CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid), "ID_TIPO")).Text = "22" Then
                        di.ForeColor = Drawing.ColorTranslator.FromHtml("red")
                    End If
                    If di.Cells(par.IndDGC(CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid), "num_tipo")).Text.Contains("STORN.") Then
                        di.ForeColor = Drawing.ColorTranslator.FromHtml("red")
                    End If
                End If
                If di.Cells(par.IndDGC(CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid), "num_tipo")).Text.Contains("ANNUL.") Then
                    di.ForeColor = Drawing.ColorTranslator.FromHtml("red")
                End If
            Next


            For Each di As DataGridItem In CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).Items
                If di.Cells(par.IndDGC(CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid), "riferimento_a")).Text.Contains("TOTALE") Then
                    For j As Integer = 0 To di.Cells.Count - 1
                        If di.Cells(j).Text <> "&nbsp;" And di.Cells(j).Text <> "-1" Then
                            di.Cells(j).Font.Bold = True
                            di.Cells(j).Font.Underline = True
                        End If
                    Next
                    'di.BackColor = Drawing.ColorTranslator.FromHtml("#006699")
                    'di.ForeColor = Drawing.ColorTranslator.FromHtml("white")
                    'di.Attributes.Add("onmouseover", "this.style.backgroundColor='#006699'")
                    'di.Attributes.Add("onmouseout", "this.style.backgroundColor='#006699'")
                End If
            Next

            If ConnAperta = True Then
                par.OracleConn.Close()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            End If
        Catch ex As Exception
            If Not IsNothing(par.myTrans) Then
                par.myTrans.Rollback()
            End If
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " (funzione CaricaTabBoll) - " & ex.Message)
            Response.Redirect("../Errore.aspx", False)
        End Try
    End Sub

    Private Function ImpostaFlSgravio(ByVal idBollRuolo As Long, ByVal importoRuolo As Decimal) As String
        Dim tiposgravio As String = "N"
        Dim impPagatoRuolo As Decimal = 0
        Dim flSgravio As Integer = 0

        par.cmd.CommandText = "select * from siscom_mi.BOL_BOLLETTE_PAGAMENTI_RUOLO,siscom_mi.incassi_ruoli where " _
                & " BOL_BOLLETTE_PAGAMENTI_RUOLO.ID_INCASSO_RUOLO=incassi_ruoli.id and id_bolletta=" & idBollRuolo
        Dim da1 As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
        Dim dt1 As New Data.DataTable
        da1.Fill(dt1)
        da1.Dispose()
        If dt1.Rows.Count > 0 Then
            For Each rowRuolo As Data.DataRow In dt1.Rows
                impPagatoRuolo = impPagatoRuolo + par.IfNull(rowRuolo.Item("importo_pagato"), 0)
                If par.IfNull(rowRuolo.Item("fl_sgravio"), 0) = 1 Then
                    flSgravio = 1
                End If
            Next
        End If

        If flSgravio = 1 Then
            If importoRuolo = impPagatoRuolo Then
                tiposgravio = "ST"
            Else
                tiposgravio = "SP"
            End If
        Else
            tiposgravio = "N"
        End If

        Return tiposgravio
    End Function

    Private Sub CaricaGestionale()
        Try
            Dim ConnAperta As Boolean = False
            Dim num_bolletta As String = ""
            Dim I As Integer = 0
            Dim importobolletta As Decimal = 0
            Dim importobolletta2 As Decimal = 0
            Dim importopagato As Decimal = 0
            Dim residuo As Decimal = 0
            Dim morosita As Integer = 0
            Dim riclass As Integer = 0
            Dim indiceMorosita As Integer = 0
            Dim indiceBolletta As Integer = 0
            If par.OracleConn.State = Data.ConnectionState.Closed Then
                ConnAperta = True
                par.OracleConn.Open()
                par.SettaCommand(par)
            End If

            par.cmd.CommandText = "select TIPO_BOLLETTE_GEST.ACRONIMO,TIPO_BOLLETTE_GEST.FL_RIPARTIBILE,bol_bollette_gest.* from SISCOM_MI.TIPO_BOLLETTE_GEST,siscom_mi.bol_bollette_GEST where BOL_BOLLETTE_GEST.ID_TIPO=TIPO_BOLLETTE_GEST.ID (+)" _
                & " and bol_bollette_gest.id_contratto=" & lIdContratto & " AND FL_VISUALIZZABILE=1 order by bol_bollette_gest.data_emissione desc,bol_bollette_gest.riferimento_da desc, bol_bollette_gest.riferimento_a desc,bol_bollette_gest.id desc"
            Dim da1 As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
            Dim dtQuery2 As New Data.DataTable
            Dim dt1 As New Data.DataTable
            Dim rowDT As System.Data.DataRow

            dt1.Columns.Add("id")
            dt1.Columns.Add("num_tipo")
            dt1.Columns.Add("riferimento_da")
            dt1.Columns.Add("riferimento_a")
            dt1.Columns.Add("data_emissione")
            dt1.Columns.Add("importobolletta")
            dt1.Columns.Add("data_pagamento")
            dt1.Columns.Add("note")
            dt1.Columns.Add("anteprima")
            dt1.Columns.Add("sposta")
            dt1.Columns.Add("dettagli")
            dt1.Columns.Add("id_tipo")
            dt1.Columns.Add("tipo_appl")

            da1.Fill(dtQuery2)
            da1.Dispose()

            Dim TOTimportobolletta As Decimal = 0
            Dim importoVoceEmessa As Decimal = 0

            For Each row As Data.DataRow In dtQuery2.Rows
                indiceMorosita = 0
                indiceBolletta = 0
                rowDT = dt1.NewRow()

                importobolletta = par.IfNull(row.Item("IMPORTO_TOTALE"), "0,00")
                If par.IfNull(row.Item("TIPO_APPLICAZIONE"), "N") = "N" Then
                    importobolletta2 = par.IfNull(row.Item("IMPORTO_TOTALE"), "0,00")
                End If


                'CONTROLLO IN BOL_BOLLETTE_VOCI SE è stata emessa quella bolletta (in bol_bollette)
                par.cmd.CommandText = "SELECT ID AS ID_VOCE_GEST FROM SISCOM_MI.BOL_BOLLETTE_VOCI_GEST WHERE ID_BOLLETTA_GEST=" & par.IfNull(row.Item("ID"), 0)
                Dim daVociGest As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
                Dim dtVociGest As New Data.DataTable
                Dim rowDTVociGest As System.Data.DataRow
                daVociGest.Fill(dtVociGest)
                daVociGest.Dispose()
                par.cmd.Dispose()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                If dtVociGest.Rows.Count > 0 Then
                    For Each rowDTVociGest In dtVociGest.Rows
                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.BOL_BOLLETTE_VOCI WHERE ID_VOCE_BOLLETTA_GEST=" & par.IfNull(rowDTVociGest.Item("ID_VOCE_GEST"), 0)
                        Dim daVociNew As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
                        Dim dtVociNew As New Data.DataTable
                        Dim rowDTVociNew As System.Data.DataRow
                        daVociNew.Fill(dtVociNew)
                        daVociNew.Dispose()
                        par.cmd.Dispose()
                        Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                        If dtVociNew.Rows.Count > 0 Then
                            For Each rowDTVociNew In dtVociNew.Rows
                                importoVoceEmessa += par.IfNull(rowDTVociNew.Item("IMPORTO"), 0)
                            Next
                        End If
                    Next
                End If

                Dim STATO As String = ""

                residuo = importobolletta - importoVoceEmessa

                TOTimportobolletta = TOTimportobolletta + (importobolletta2 - importoVoceEmessa)

                rowDT.Item("num_tipo") = num_bolletta & " " & STATO & " " & par.IfNull(row.Item("ACRONIMO"), "---")
                rowDT.Item("riferimento_da") = par.FormattaData(par.IfNull(row.Item("riferimento_da"), ""))
                rowDT.Item("riferimento_a") = par.FormattaData(par.IfNull(row.Item("riferimento_a"), ""))
                rowDT.Item("data_emissione") = par.FormattaData(par.IfNull(row.Item("data_emissione"), ""))

                rowDT.Item("importobolletta") = Format(residuo, "##,##0.00")
                rowDT.Item("note") = par.IfNull(row.Item("NOTE"), "")
                rowDT.Item("anteprima") = "<a onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & " href=""javascript:window.open('DettaglioVociGest.aspx?IDBOLL=" & par.IfNull(row.Item("id"), 0) & "','DettGest','height=250,top=200,left=410,width=630,resizable=yes,menubar=no,toolbar=no,scrollbars=yes');void(0);""><img alt=" & Chr(34) & "Info bolletta" & Chr(34) & " title=" & Chr(34) & "Visualizza Dettagli" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "Immagini/Details-icon.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                If rowDT.Item("importobolletta") > 0 Then
                    If par.IfNull(row.Item("TIPO_APPLICAZIONE"), "") = "P" Then
                        rowDT.Item("sposta") = "<a href=""javascript:alert('Attenzione questa scrittura risulta già distribuita in rate come voce nello schema bollette!');void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " title=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_move.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                    Else
                        If par.IfNull(row.Item("FL_RIPARTIBILE"), 0) = 0 Then
                            If Session.Item("MOD_RU_CRDE") <> "0" Then
                                If par.IfNull(row.Item("FL_SBLOCCATA"), 0) = 0 Then
                                    rowDT.Item("sposta") = "<a href=""javascript:AttivaSpostamento();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Attiva funzione" & Chr(34) & " title=" & Chr(34) & "Clicca per sbloccare" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "20px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_SwitchOff.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                                Else
                                    rowDT.Item("sposta") = "<a href=""javascript:ScegliElaborazione();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " title=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_move.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>" _
                                        & "<a href=""javascript:AttivaSpostamento();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Attiva funzione" & Chr(34) & " title=" & Chr(34) & "Clicca per bloccare" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "20px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_SwitchOn.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                                End If
                            Else
                                If par.IfNull(row.Item("FL_SBLOCCATA"), 0) = 0 Then
                                    rowDT.Item("sposta") = ""
                                Else
                                    rowDT.Item("sposta") = "<a href=""javascript:ScegliElaborazione();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " title=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_move.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                                End If
                            End If
                        Else
                            If Session.Item("MOD_RU_CRDE") <> "0" Then
                                If par.IfNull(row.Item("FL_SBLOCCATA"), 1) = 0 Then
                                    rowDT.Item("sposta") = "<a href=""javascript:AttivaSpostamento();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Attiva funzione" & Chr(34) & " title=" & Chr(34) & "Clicca per sbloccare" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "20px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_SwitchOff.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                                Else
                                    rowDT.Item("sposta") = "<a href=""javascript:ScegliElaborazione();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " title=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_move.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>" _
                                        & "<a href=""javascript:AttivaSpostamento();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Attiva funzione" & Chr(34) & " title=" & Chr(34) & "Clicca per bloccare" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "20px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_SwitchOn.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                                End If
                            Else
                                If par.IfNull(row.Item("FL_SBLOCCATA"), 1) = 1 Then
                                    rowDT.Item("sposta") = "<a href=""javascript:ScegliElaborazione();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " title=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_move.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                                Else
                                    rowDT.Item("sposta") = ""
                                End If
                            End If
                        End If

                    End If
                Else
                    If par.IfNull(row.Item("TIPO_APPLICAZIONE"), "") = "P" Then
                        rowDT.Item("sposta") = "<a href=""javascript:alert('Attenzione il credito è stato gestito parzialmente!');void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " title=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_move.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                    Else
                        If par.IfNull(row.Item("FL_RIPARTIBILE"), 0) = 0 Then
                            If Session.Item("MOD_RU_CRDE") <> "0" Then
                                If par.IfNull(row.Item("FL_SBLOCCATA"), 0) = 0 Then
                                    rowDT.Item("sposta") = "<a href=""javascript:AttivaSpostamento();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Attiva funzione" & Chr(34) & " title=" & Chr(34) & "Clicca per sbloccare" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "20px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_SwitchOff.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                                Else
                                    rowDT.Item("sposta") = "<a href=""javascript:ScegliElaborazione();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " title=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_move.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>" _
                                        & "<a href=""javascript:AttivaSpostamento();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Attiva funzione" & Chr(34) & " title=" & Chr(34) & "Clicca per bloccare" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "20px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_SwitchOn.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                                End If
                            Else
                                If par.IfNull(row.Item("FL_SBLOCCATA"), 0) = 0 Then
                                    rowDT.Item("sposta") = ""
                                Else
                                    rowDT.Item("sposta") = "<a href=""javascript:ScegliElaborazione();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " title=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_move.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                                End If
                            End If
                        Else
                            If Session.Item("MOD_RU_CRDE") <> "0" Then
                                If par.IfNull(row.Item("FL_SBLOCCATA"), 1) = 0 Then
                                    rowDT.Item("sposta") = "<a href=""javascript:AttivaSpostamento();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Attiva funzione" & Chr(34) & " title=" & Chr(34) & "Clicca per sbloccare" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "20px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_SwitchOff.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                                Else
                                    rowDT.Item("sposta") = "<a href=""javascript:ScegliElaborazione();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " title=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_move.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>" _
                                        & "<a href=""javascript:AttivaSpostamento();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Attiva funzione" & Chr(34) & " title=" & Chr(34) & "Clicca per bloccare" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "20px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_SwitchOn.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                                End If
                            Else
                                If par.IfNull(row.Item("FL_SBLOCCATA"), 1) = 1 Then
                                    rowDT.Item("sposta") = "<a href=""javascript:ScegliElaborazione();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " title=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_move.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                                Else
                                    rowDT.Item("sposta") = ""
                                End If

                            End If
                        End If
                    End If
                End If

                If par.IfNull(row.Item("TIPO_APPLICAZIONE"), "") = "T" Then
                    'rowDT.Item("sposta") = "<img alt=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " title=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_move.png" & Chr(34) & "/>"
                    rowDT.Item("sposta") = ""
                End If
                rowDT.Item("id_tipo") = par.IfNull(row.Item("ID_TIPO"), 0)
                rowDT.Item("id") = par.IfNull(row.Item("id"), 0)


                'rowDT.Item("anteprima") = "<a href=javascript:ApriAnteprima();void(0); onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Info bolletta" & Chr(34) & " title=" & Chr(34) & "Visualizza Bolletta" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "16px" & Chr(34) & " src=" & Chr(34) & "../NuoveImm/search-icon.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                'rowDT.Item("anteprima") = "<a href=""javascript:alert('Non disponibile!');void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Info bolletta" & Chr(34) & " title=" & Chr(34) & "Visualizza Bolletta" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "16px" & Chr(34) & " src=" & Chr(34) & "../NuoveImm/search-icon.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                importobolletta = 0
                importobolletta2 = 0
                rowDT.Item("tipo_appl") = par.IfNull(row.Item("TIPO_APPLICAZIONE"), "")
                Select Case rowDT.Item("TIPO_APPL")
                    Case "P"
                        CType(Tab_Bollette1.FindControl("DataGridGest"), DataGrid).Columns(3).Visible = True
                        CType(Tab_Bollette1.FindControl("divGestCon"), HiddenField).Value = "1"
                        If par.IfNull(rowDT.Item("importobolletta"), 0) < 0 Then
                            rowDT.Item("dettagli") = "<a onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & " href=""javascript:window.showModalDialog('DettagliGestionaleCrediti.aspx?IDBOLL=" & par.IfNull(row.Item("id"), 0) & "','DettGest', 'status:no;dialogWidth:630px;dialogHeight:250px;dialogHide:true;help:no;scroll:yes');void(0);""><img alt=" & Chr(34) & "Dettagli Elaborazione" & Chr(34) & " title=" & Chr(34) & "Dettagli Elaborazione" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "20px" & Chr(34) & " src=" & Chr(34) & "Immagini/ImgDett.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                        Else
                            rowDT.Item("dettagli") = "<a onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & " href=""javascript:window.open('DettagliGestionale.aspx?IDBOLL=" & par.IfNull(row.Item("id"), 0) & "','DettGest','height=250,top=200,left=410,width=630,resizable=yes,menubar=no,toolbar=no,scrollbars=yes');void(0);""><img alt=" & Chr(34) & "Dettagli Elaborazione" & Chr(34) & " title=" & Chr(34) & "Dettagli Elaborazione" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "20px" & Chr(34) & " src=" & Chr(34) & "Immagini/ImgDett.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                        End If
                    Case "T"
                        CType(Tab_Bollette1.FindControl("DataGridGest"), DataGrid).Columns(3).Visible = True
                        CType(Tab_Bollette1.FindControl("divGestCon"), HiddenField).Value = "1"
                        If par.IfNull(rowDT.Item("importobolletta"), 0) < 0 Then
                            rowDT.Item("dettagli") = "<a onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & " href=""javascript:window.showModalDialog('DettagliGestionaleCrediti.aspx?IDBOLL=" & par.IfNull(row.Item("id"), 0) & "','DettGest', 'status:no;dialogWidth:630px;dialogHeight:250px;dialogHide:true;help:no;scroll:yes');void(0);""><img alt=" & Chr(34) & "Dettagli Elaborazione" & Chr(34) & " title=" & Chr(34) & "Dettagli Elaborazione" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "20px" & Chr(34) & " src=" & Chr(34) & "Immagini/ImgDett.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                        Else
                            rowDT.Item("dettagli") = "<a onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & " href=""javascript:window.open('DettagliGestionale.aspx?IDBOLL=" & par.IfNull(row.Item("id"), 0) & "','DettGest','height=250,top=200,left=410,width=630,resizable=yes,menubar=no,toolbar=no,scrollbars=yes');void(0);""><img alt=" & Chr(34) & "Dettagli Elaborazione" & Chr(34) & " title=" & Chr(34) & "Dettagli Elaborazione" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "20px" & Chr(34) & " src=" & Chr(34) & "Immagini/ImgDett.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                        End If
                    Case "N"
                        rowDT.Item("dettagli") = ""
                End Select
                'If par.IfNull(row.Item("FL_RIPARTIBILE"), 0) = 0 Then
                '    If Session.Item("MOD_RU_CRDE") <> "0" Then
                '        If par.IfNull(row.Item("FL_SBLOCCATA"), 0) = 0 Then
                '            rowDT.Item("sposta") = "<a href=""javascript:AttivaSpostamento();void(0);"" onclick=" & Chr(34) & "document.getElementById('USCITA').value='1';" & Chr(34) & "><img alt=" & Chr(34) & "Attiva funzione" & Chr(34) & " title=" & Chr(34) & "Sposta in partita contabile" & Chr(34) & " border=" & Chr(34) & "0" & Chr(34) & " width=" & Chr(34) & "15px" & Chr(34) & " src=" & Chr(34) & "Immagini/Img_divieto.png" & Chr(34) & " style=" & Chr(34) & "cursor:pointer" & Chr(34) & " /></a>"
                '        End If
                '    Else
                '        rowDT.Item("sposta") = ""
                '    End If
                'End If
                dt1.Rows.Add(rowDT)
            Next

            rowDT = dt1.NewRow()
            rowDT.Item("id") = -1
            rowDT.Item("num_tipo") = ""
            rowDT.Item("riferimento_da") = ""
            rowDT.Item("riferimento_a") = "TOTALE"
            rowDT.Item("data_emissione") = ""
            rowDT.Item("importobolletta") = Format(TOTimportobolletta, "##,##0.00")
            rowDT.Item("data_pagamento") = ""
            rowDT.Item("note") = ""
            rowDT.Item("id_tipo") = ""
            rowDT.Item("tipo_appl") = ""
            rowDT.Item("anteprima") = ""
            rowDT.Item("dettagli") = ""
            dt1.Rows.Add(rowDT)

            If Session.Item("MOD_ELAB_SING_GEST") = 1 Then
                CType(Tab_Bollette1.FindControl("DataGridGest"), DataGrid).Columns(1).Visible = True
            Else
                CType(Tab_Bollette1.FindControl("DataGridGest"), DataGrid).Columns(1).Visible = False
            End If

            CType(Tab_Bollette1.FindControl("DataGridGest"), DataGrid).DataSource = dt1
            CType(Tab_Bollette1.FindControl("DataGridGest"), DataGrid).DataBind()



            For Each di As DataGridItem In CType(Tab_Bollette1.FindControl("DataGridGest"), DataGrid).Items
                If di.Cells(6).Text.Contains("TOTALE") Then
                    For j As Integer = 0 To di.Cells.Count - 1
                        If di.Cells(j).Text <> "&nbsp;" And di.Cells(j).Text <> "-1" Then
                            di.Cells(j).Font.Bold = True
                            di.Cells(j).Font.Underline = True
                        End If
                    Next
                    'di.BackColor = Drawing.ColorTranslator.FromHtml("#006699")
                    'di.ForeColor = Drawing.ColorTranslator.FromHtml("white")
                    'di.Attributes.Add("onmouseover", "this.style.backgroundColor='#006699'")
                    'di.Attributes.Add("onmouseout", "this.style.backgroundColor='#006699'")
                End If
            Next

            For Each di As DataGridItem In CType(Tab_Bollette1.FindControl("DataGridGest"), DataGrid).Items
                If di.Cells(12).Text.Contains("P") Then
                    di.ForeColor = Drawing.ColorTranslator.FromHtml("red")
                    di.ToolTip = "Documento già elaborato con scrittura delle voci in schema bollette! L'importo scalerà in base alle future emissioni."
                End If
                If di.Cells(12).Text.Contains("T") Then
                    For j As Integer = 0 To di.Cells.Count - 1
                        di.Cells(j).Font.Strikeout = True
                    Next
                End If
            Next
            If ConnAperta = True Then
                par.OracleConn.Close()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            End If

        Catch ex As Exception
            If Not IsNothing(par.myTrans) Then
                par.myTrans.Rollback()
            End If
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " (funzione CaricaGestionale) - " & ex.Message)
            Response.Redirect("../Errore.aspx", False)
        End Try
    End Sub

    'Function CaricaSchemaBolletta(ByVal IdContratto As Long)
    '    CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items.Clear()
    '    Dim kk As Integer = 0
    '    'CARICAMENTO schema bollette
    '    CType(Tab_SchemaBollette1.FindControl("Label4"), Label).Text = "SCHEMA VOCI BOLLETTA" & " " & sAnnoSchema & "  -  <a href='SchemaAltriAnni.aspx?CN=" & lIdConnessione & "&ID=" & lIdContratto & "&A=" & sAnnoSchema & "' target='_blank'>Clicca qui per visualizzare lo schema di altri anni</a>"
    '    par.cmd.CommandText = "select bol_schema.*,t_voci_bolletta.descrizione from siscom_mi.t_voci_bolletta, siscom_mi.bol_schema where t_voci_bolletta.id=bol_schema.id_voce and bol_schema.id_contratto=" & lIdContratto & " and anno=" & sAnnoSchema & " order by t_voci_bolletta.descrizione,(-importo) asc"
    '    Dim myReader22 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
    '    Do While myReader22.Read
    '        CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader22("descrizione"), ""), 50) & " " & par.MiaFormat(Format(par.IfNull(myReader22("importo_singola_rata"), "0"), "0.00"), 15) & " " & par.MiaFormat(par.IfNull(myReader22("da_rata"), ""), 10) & " " & par.MiaFormat(par.IfNull(myReader22("per_rate"), ""), 10), myReader22("ID")))
    '        If kk Mod 2 <> 0 Then
    '            CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items(kk).Attributes.CssStyle.Add("background-color", "#dcdada")
    '        Else
    '            CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items(kk).Attributes.CssStyle.Add("background-color", "white")
    '        End If
    '        kk = kk + 1
    '    Loop
    '    myReader22.Close()
    'End Function
    Private Sub ControllaProroga()
        Dim ConnAperta As Boolean = False
        Try
            If par.OracleConn.State = Data.ConnectionState.Closed Then
                ConnAperta = True
                par.OracleConn.Open()
                par.SettaCommand(par)
            End If

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID =" & lIdContratto & " AND FL_PROROGA=1"
            Dim myReaderPR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderPR.Read Then
                prorogati.Value = "1"
                CType(Tab_Contratto1.FindControl("chkTemporanea"), CheckBox).Enabled = False
            End If
            myReaderPR.Close()

            If ConnAperta = True Then
                par.cmd.Dispose()
                par.OracleConn.Close()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            End If

        Catch ex As Exception
            par.cmd.Dispose()
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " (funzione ControllaProroga) - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Sub

    Private Sub ControllaAssDef()
        Dim ConnAperta As Boolean = False
        Try
            If par.OracleConn.State = Data.ConnectionState.Closed Then
                ConnAperta = True
                par.OracleConn.Open()
                par.SettaCommand(par)
            End If

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID =" & lIdContratto & " AND FL_ASSEGN_DEF=1"
            Dim myReaderAD As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderAD.Read Then
                assegn_def.Value = "1"
            End If
            myReaderAD.Close()

            If ConnAperta = True Then
                par.cmd.Dispose()
                par.OracleConn.Close()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            End If

        Catch ex As Exception
            par.cmd.Dispose()
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " (funzione ControllaAssDef) - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Sub

    Private Sub VerificaRUModifica()
        par.OracleConn.Open()
        par.SettaCommand(par)

        par.cmd.CommandText = "select valore from PARAMETER where ID=123"
        Dim myReaderA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
        If myReaderA.Read Then
            If par.IfNull(myReaderA("VALORE"), "0") = "0" Then
                Session.Add("CONT_LETTURA_RU", "1")
                Response.Write("<script>alert('Attenzione...Il contratto sarà visualizzato in sola lettura.');</script>")
            Else
                Session.Add("CONT_LETTURA_RU", "0")
            End If
        End If

        myReaderA.Close()

        par.OracleConn.Close()

    End Sub

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If Session.Item("OPERATORE") = "" Then
            Response.Redirect("~/AccessoNegato.htm", True)
            Exit Sub
        End If
        Response.Expires = 0


        If Not IsPostBack Then
            'Response.Write("<div id='dvvvPre' style='position: absolute; width: 100%; height: 100%; top: 0px;" _
            '            & "        left: 0px; background-color: #f0f0f0; visibility: visible; z-index: 500; display: block;'>" _
            '            & "        <img src='../ImmDiv/DivUscitaInCorso2.jpg' alt='caricamento in corso...' style='position: absolute;" _
            '            & "            top: 125px; left: 203px' />" _
            '            & "    </div>")
            'Response.Flush()


            cmbintestazione.Value = "0"


            TipoContratto = Request.QueryString("tipo")
            lIdConnessione = Format(Now, "yyyyMMddHHmmss")
            LetteraProvenienza = Request.QueryString("Lett")

            Session.Add("CONTRATTOAPERTO", "1")

            lIdContratto = Request.QueryString("ID")
            lIdDomandaERP = Request.QueryString("IdDomanda")
            lIdDichiarazione = Request.QueryString("IdDichiarazione")

            Contact.Value = Request.QueryString("CC")

            LBLcodUI.Value = Request.QueryString("COD")
            LBLintest.Value = Request.QueryString("INTEST")

            VerificaRUModifica()
            sceltaDestEcc.Value = Session.Item("FL_SCELTA_DEST_ECCED")

            If Session.Item("CONT_LETTURA") = "1" Then
                SolaLettura = "1"
                lettura.Value = "1"
                CType(Tab_Bollette1.FindControl("MenuStampeG"), Menu).Visible = False
                CType(Tab_Bollette1.FindControl("MenuStampeC"), Menu).Visible = False
            Else
                SolaLettura = "0"
                lettura.Value = "0"
                CType(Tab_Bollette1.FindControl("MenuStampeG"), Menu).Visible = True
                CType(Tab_Bollette1.FindControl("MenuStampeC"), Menu).Visible = True
            End If



            If Session.Item("CONT_DISDETTE") = "1" Then
                opfiliale.Value = "1"
                If Session.Item("MODULO_CONT") = "0" Then
                    SolaLettura = "1"
                    lettura.Value = "1"
                End If

            Else
                opfiliale.Value = "0"
            End If

            If Session.Item("MOD_CONT_P_EXTRA") = "1" Then
                FL_PAG_MANUALI.Value = 1
            Else
                FL_PAG_MANUALI.Value = 0

            End If

            If Session.Item("MOD_PAG_RUOLI") = "1" Then
                FL_PAG_MAN_RUOLI.Value = 1
            Else
                FL_PAG_MAN_RUOLI.Value = 0

            End If

            If Session.Item("MOD_PAG_INGIUNZ") = "1" Then
                FL_PAG_MAN_ING.Value = 1
            Else
                FL_PAG_MAN_ING.Value = 0

            End If

            'Session.Add("CONT_LETTURA", "0")

            If Session("CONT_LETTURA") = "0" And Session.Item("MODULO_CONT") = "0" Then
                SolaLettura = "1"
                lettura.Value = "1"
                'Session.Item("CONT_LETTURA") = "1"
            End If

            If Request.QueryString("LT") = "1" Then
                SolaLettura = "1"
                lettura.Value = "1"
                'Session.Item("CONT_LETTURA") = "1"
            End If

            '-------------- SOLA LETTURA PER APERTURA DA CONTRATTI DI RIFERIMENTO

            If Request.QueryString("LETT") = "READ" Then
                SolaLettura = "1"
                lettura.Value = "1"
            End If


            '-------------------------------
            If Session.Item("MOD_CONT_RATEIZZA") = "0" Then
                Rateizza.Value = "0"
            Else
                Rateizza.Value = "1"
            End If


            If Session.Item("MOD_SPOSTAM_ANNULL") = "0" Then
                spostaAnnulla.Value = "0"
            Else
                If Controlla3bollette(lIdContratto) = True Then
                    spostaAnnulla.Value = "1"
                Else
                    spostaAnnulla.Value = "0"
                End If
            End If

            RicavaAU392()
            VisualizzaStoricoReg()

            If Session.Item("CONT_LETTURA_RU") = "1" Then
                SolaLettura = "1"
                lettura.Value = "1"
                CType(Tab_Bollette1.FindControl("MenuStampeG"), Menu).Visible = False
                CType(Tab_Bollette1.FindControl("MenuStampeC"), Menu).Visible = False
                Session.Remove("CONT_LETTURA_RU")
            End If

            '16/10/2013 FUNZIONE DI TRASFERIMENTO PER ABUSIVI
            If Session.Item("MOD_TRASFERIM_RUA") = "0" Then
                controllaEsistBozza.Value = "0"
            Else
                If ControllaCreazBozza(Request.QueryString("COD")) <> "" Then
                    controllaEsistBozza.Value = ControllaCreazBozza(Request.QueryString("COD"))
                Else
                    controllaEsistBozza.Value = "0"
                End If
            End If


            Generale1.Provenienza = TipoContratto
            Generale1.IndiceAnagrafe = "-1"
            Generale1.lIdConnessione = lIdConnessione

            If TipoContratto = "7" Then
                LBLABUSIVO.Visible = True
            End If

            Select Case TipoContratto
                Case "1", "2"
                    Generale1.IndiceDomanda = CStr(lIdDomandaERP)
                    Generale1.IndiceDichiarazione = CStr(lIdDichiarazione)
                Case "3", "5", "6", "7", "11", "12"
                    Generale1.IndiceDomanda = "-1"
                    Generale1.IndiceDichiarazione = "-1"
                Case "10"
                    Generale1.IndiceDomanda = "-1"
                    Generale1.IndiceDichiarazione = CStr(lIdDichiarazione)
            End Select

            'If TipoContratto <> "3" And TipoContratto <> "5" And TipoContratto <> "6" And TipoContratto <> "7" And TipoContratto <> "8" Then
            '    Generale1.IndiceDomanda = CStr(lIdDomandaERP)
            '    Generale1.IndiceDichiarazione = CStr(lIdDichiarazione)
            'Else
            '    Generale1.IndiceDomanda = "-1"
            '    Generale1.IndiceDichiarazione = "-1"
            'End If

            CType(Tab_SchemaBollette1.FindControl("txtConnessione"), HiddenField).Value = CStr(lIdConnessione)
            CType(Tab_SchemaBollette1.FindControl("txtIdContratto"), HiddenField).Value = CStr(lIdContratto)

            CType(Tab_Bollette1.FindControl("txtConnessione"), HiddenField).Value = CStr(lIdConnessione)
            CType(Tab_Bollette1.FindControl("txtIdContratto"), HiddenField).Value = CStr(lIdContratto)

            Tab_Azioni_Legali1.indicecontratto = lIdContratto
            Tab_Azioni_Legali1.indiceconnessione = lIdConnessione

            ImgCambioIntestazione.Visible = False
            CercaAbusivi()
            CaricaCapoluoghi()
            ControllaProroga()
            ControllaAssDef()
            controllaContrColl()
            RicavaDatiDomandaOriginari()
            RiempiCampiOA()

            If lIdContratto = -1 Then
                Tab1 = "tabbertabdefault"
                Tab2 = ""
                Tab3 = ""
                Tab4 = ""
                Tab5 = ""
                Tab6 = ""
                Tab7 = ""
                Tab8 = ""
                Tab9 = ""
                Tab10 = ""
                Tab11 = ""
                Tab12 = ""
                Visibile = "style=" & Chr(34) & "visibility:hidden" & Chr(34)
                'nuovo contratto
                VisNuovoContratto.Value = "1"
                FL_NuovoContratto = "1"
                Session.Item("LAVORAZIONE") = "1"
                CType(Tab_SchemaBollette1.FindControl("img_EliminaOspite"), ImageButton).Visible = False
                NuovoContratto()
                Tab_Contratto1.indicecontratto = "-1"
                Tab_Contratto1.indiceconnessione = "-1"
            Else
                'visualizza contratto
                lblContratto.Text = "Rapporto Cod. " & Request.QueryString("COD")
                CodContratto1 = Request.QueryString("COD")

                FL_NuovoContratto = "0"
                Session.Item("LAVORAZIONE") = "1"
                VisualizzaContratto()
                Tab1 = "tabbertabdefault"
                Tab2 = ""
                Tab3 = ""
                Tab4 = ""
                Tab5 = ""
                Tab6 = ""
                Tab7 = ""
                Tab8 = ""
                Tab9 = ""
                Tab10 = ""
                Tab11 = ""
                Tab12 = ""
                Visibile = "style=" & Chr(34) & "visibility:visible" & Chr(34)
            End If

            CType(Tab_Comunicazioni1.FindControl("txtPresso"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Comunicazioni1.FindControl("txtCAPCor"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Comunicazioni1.FindControl("txtCivicoCor"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Comunicazioni1.FindControl("txtSiglaCor"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Comunicazioni1.FindControl("txtViaCor"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            'max 23/01/2018
            CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Comunicazioni1.FindControl("chkIrreperibile"), CheckBox).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")

            '15/11/2016 Scala-Piano-Interno SD 1619/2016
            CType(Tab_Comunicazioni1.FindControl("txtScalaCor"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Comunicazioni1.FindControl("txtPianoCor"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Comunicazioni1.FindControl("txtInternoCor"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")


            CType(Tab_Comunicazioni1.FindControl("cmbTipoViaCor"), DropDownList).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Comunicazioni1.FindControl("cmbCommissariato"), DropDownList).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")


            CType(Tab_Canone1.FindControl("checkInteressiCauzione"), CheckBox).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")

            CType(Tab_Canone1.FindControl("checkConguaglioBoll"), CheckBox).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';document.getElementById('txtConguaglio').value='1';")
            CType(Tab_Canone1.FindControl("checkInvioBoll"), CheckBox).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';document.getElementById('txtInvioBollette').value='1';")
            CType(Tab_Canone1.FindControl("chRitardoPagamenti"), CheckBox).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")

            CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Canone1.FindControl("txtLibrettoDeposito"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")


            CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Contratto1.FindControl("txtDescrDestinazione"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")


            CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            'max 18/07/2019
            CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")
            '--------------

            CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Attributes.Add("onchange", "ScriviDate();")
            CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")


            CType(Tab_Contratto1.FindControl("txtDataConsegna"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Contratto1.FindControl("txtDataConsegna"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")


            CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")


            CType(Tab_Contratto1.FindControl("txtEntroCuiDisdettare"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")

            CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';document.getElementById('DataScadCont').value=document.getElementById('Tab_Contratto1_txtDataScadenza').value;")
            CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';document.getElementById('DataScadRinn').value=document.getElementById('Tab_Contratto1_txtDataSecScadenza').value;")
            CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';document.getElementById('disdettato').value='1';")
            CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            CType(Tab_Contratto1.FindControl("txtNotificaDisdetta"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Contratto1.FindControl("txtNotificaDisdetta"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")



            CType(Tab_Contratto1.FindControl("txtDataDisdetta0"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Contratto1.FindControl("txtDataDisdetta0"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")


            CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")



            CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")

            'CType(Tab_Contratto1.FindControl("txtNote"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")



            CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Registrazione1.FindControl("txtSerie"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Registrazione1.FindControl("cmbUfficioRegistro"), DropDownList).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Registrazione1.FindControl("txtNotereg"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")

            'max 13/06/2016
            CType(Tab_Registrazione1.FindControl("cmbTipoPosizione"), DropDownList).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Registrazione1.FindControl("cmbModoPagamento"), DropDownList).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")

            CType(Tab_Bollette1.FindControl("txtPeriodoDa"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")
            CType(Tab_Bollette1.FindControl("txtPeriodoAl"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")
            CType(Tab_Bollette1.FindControl("txtEmissione"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")
            CType(Tab_Bollette1.FindControl("txtScadenza"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            CType(Tab_Bollette1.FindControl("txtCompetenzaDal"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")
            CType(Tab_Bollette1.FindControl("txtCompetenzaAl"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")
            CType(Tab_Bollette1.FindControl("txtDataEmiss"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")
            CType(Tab_Bollette1.FindControl("txtDataScad"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")
            CType(Tab_Conduttore1.FindControl("txtDal"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")
            CType(Tab_Conduttore1.FindControl("txtAl"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            '***** MENU FUNZIONI TAB BOLLETTE NEW *****
            CType(Tab_Bollette1.FindControl("MenuStampeG"), Menu).Attributes.Add("onclick", "javascript:document.getElementById('USCITA').value='1';document.getElementById('menuGest').value='1';")
            CType(Tab_Bollette1.FindControl("MenuStampeC"), Menu).Attributes.Add("onclick", "javascript:document.getElementById('USCITA').value='1';")

            'max 09/06/2015
            CType(Tab_Bollette1.FindControl("txtImportoVoce"), TextBox).Attributes.Add("onkeyup", "javascript:this.value = this.value.replace('.', ',');")
            CType(Tab_SchemaBollette1.FindControl("txtImportoVoce"), TextBox).Attributes.Add("onkeyup", "javascript:this.value = this.value.replace('.', ',');")

            'CType(Tab_Canone1.FindControl("HLink_SchedaDep"), HyperLink).Attributes.Add("onClick", "javascript:document.getElementById('USCITA').value='1';window.open('DepositoCauzionale.aspx?IDC=" & lIdContratto & "', 'DepCauz','height=580,width=800,top=0,left=0');")
            If CType(Tab_Contratto1.FindControl("chkTemporanea"), CheckBox).Checked = True Then
                LBLErpModerato.Visible = True
                LBLErpModerato.Text = "Assegn. Temporanea"
            Else
                If LetteraERP <> "B" Then
                    Select Case TipoContratto
                        'Case "8"
                        '    LBLErpModerato.Visible = True
                        '    LBLErpModerato.Text = "(ART.22 C.10 RR 1/2004)"
                        Case "10"
                            LBLErpModerato.Visible = True
                            LBLErpModerato.Text = "Forze dell'Ordine"
                        Case "12"
                            LBLErpModerato.Visible = True
                            LBLErpModerato.Text = "Canone Convenzionato"
                        Case "1"
                            LBLErpModerato.Visible = True
                            LBLErpModerato.Text = "E.R.P. Sociale"
                        Case "6"
                            If LetteraProvenienza = "V" Then
                                LBLABUSIVO.Visible = True
                                LBLABUSIVO.Text = "ART.15 C.2 RR 1/2004"
                            End If
                        Case Else
                            LBLErpModerato.Visible = False

                    End Select
                Else
                    LBLErpModerato.Visible = False
                End If
            End If

            If CType(Tab_Contratto1.FindControl("ChBolloEsente"), CheckBox).Visible = True Then
                CType(Tab_Contratto1.FindControl("ChBolloEsente"), CheckBox).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            End If

            If CType(Tab_Contratto1.FindControl("chkTemporanea"), CheckBox).Visible = True Then
                CType(Tab_Contratto1.FindControl("chkTemporanea"), CheckBox).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            End If

            CaricaAttributi()
        Else
            ScriptManager.RegisterStartupScript(Page, GetType(Page), "MyScriptKey111", "document.getElementById('Attesa').style.visibility = 'hidden';", True)
        End If


        If AGGBOLL.Value = 1 Then
            AGGBOLL.Value = 0
            CaricaTabBollette()
            SaldoContratto = par.CalcolaSaldoAttuale(lIdContratto)
            CType(Tab_Bollette1.FindControl("lblSaldoCont"), Label).Text = "<a href='javascript:void(0)' style='text-decoration: none;' link {color:#993333;} visited {color:#993333;} onclick=" & Chr(34) & "javascript:document.getElementById('USCITA').value='1';window.open('../Contabilita/DatiUtenza.aspx?C=RisUtenza&IDANA=" & txtCodAffittuario.Value & "&IDCONT=" & lIdContratto & "','EstrattoConto','');" & Chr(34) & " alt='Visualizza Dettagli'>" & Format(SaldoContratto, "##,##0.00") & " €</a>"

        End If

        Tab_Contratto1.indicecontratto = lIdContratto
        Tab_Contratto1.indiceconnessione = lIdConnessione
        Tab_Comunicazioni1.indiceconnessione = lIdConnessione

        Tab_Azioni_Legali1.indicecontratto = lIdContratto
        Tab_Azioni_Legali1.indiceconnessione = lIdConnessione

        'If Session.Item("ANAGRAFE") = "1" Then
        '    CType(Tab_Conduttore1.FindControl("lblSIPO"), Label).Attributes.Add("onclick", "javascript:window.open('../Anagrafe.aspx?ID=" & lIdContratto & "&T=6','Anagrafe','top=0,left=0,width=600,height=400');")
        'Else
        '    CType(Tab_Conduttore1.FindControl("lblSIPO"), Label).Visible = False
        'End If
        If Session.Item("ANAGRAFE") = "1" Then
            CType(Tab_Conduttore1.FindControl("lblSIPO"), Label).Attributes.Add("onclick", "javascript:window.open('../Anagrafe.aspx?ID=" & par.CriptaMolto(lIdContratto) & "&T=6','Anagrafe','top=0,left=0,width=600,height=400');")
        Else
            CType(Tab_Conduttore1.FindControl("lblSIPO"), Label).Visible = False
        End If

        If cmbintestazione.Value = "OK" Then
            CaricaDati()
            cmbintestazione.Value = ""
        End If

        If TipoContratto = "3" Or TipoContratto = "5" Or TipoContratto <> "6" Or TipoContratto <> "7" Then
            If FL_NuovoContratto = "1" Then
                Tab1 = "tabbertabdefault"
                Tab2 = ""
                Tab3 = ""
                Tab4 = ""
                Tab5 = ""
                Tab6 = ""
                Tab7 = ""
                Tab8 = ""
                Tab9 = ""
                Tab10 = ""
                Tab11 = ""
                Tab12 = ""
                Visibile = "style=" & Chr(34) & "visibility:hidden" & Chr(34)


                Generale1.Provenienza = TipoContratto
                Generale1.IndiceAnagrafe = "-1"
                Generale1.IndiceDomanda = "-1"
                Generale1.IndiceDichiarazione = "-1"

            Else
                Tab1 = "tabbertabdefault"
                Tab2 = ""
                Tab3 = ""
                Tab4 = ""
                Tab5 = ""
                Tab6 = ""
                Tab7 = ""
                Tab8 = ""
                Tab9 = ""
                Tab10 = ""
                Tab11 = ""
                Tab12 = ""
                Visibile = "style=" & Chr(34) & "visibility:visible" & Chr(34)
            End If
        End If

        Dim I As Integer

        'For I = 0 To CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items.Count - 1
        '    If I Mod 2 <> 0 Then
        '        CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "#dcdada")
        '    Else
        '        CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "white")
        '    End If

        '    If Mid(CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Text, 12, 3) = "MOR" Then
        '    End If

        '    If InStr(CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Text, "RICLA.") > 0 Then
        '        CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "yellow")
        '    End If
        'Next

        'For I = 0 To CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items.Count - 1
        '    If I Mod 2 <> 0 Then
        '        CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "#dcdada")
        '    Else
        '        CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "white")
        '    End If
        'Next

        Generale1.Provenienza = TipoContratto
        Generale1.IndiceDichiarazione = lIdDichiarazione
        Generale1.IndiceDomanda = lIdDomandaERP
        If lIdAU = 0 Then lIdAU = -1
        Generale1.IndiceAnagrafe = lIdAU


        HStatoContratto.Value = CType(Generale1.FindControl("lblStato"), Label).Text

        If par.IfNull(Mid(CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedItem.Value, 1, 3), "") = "USD" And par.IfNull(CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Value, "") = "N" Then
            RinnovoUSD.Value = "1"
        End If

        If Mid(CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedItem.Value, 1, 3) = "USD" And CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Value <> "N" Then
            CambioBox.Value = "1"
        End If

        If CType(Generale1.FindControl("lblStato"), Label).Text = "CHIUSO" Or CType(Generale1.FindControl("lblStato"), Label).Text = "BOZZA" Then
            RinnovoUSD.Value = "0"
            CambioBox.Value = "0"
        End If

        If SolaLettura = "1" Then
            RinnovoUSD.Value = "0"
            CambioBox.Value = "0"
        End If

        If Session.Item("MOD_CONT_RINN_USD") = "0" Then
            RinnovoUSD.Value = "0"
        End If

        If Session.Item("MOD_CONT_CAMBIO_BOX") = "0" Then
            CambioBox.Value = "0"
        End If

        If Session.Item("OP_RESP_VSA") = "1" Or Session.Item("OP_NORM_VSA") = "1" Then
            GLLETTURA.Value = "0"
        Else
            GLLETTURA.Value = "1"
        End If

        If Session.Item("MOD_AU") = "1" And Session.Item("ANAGRAFE_CONSULTAZIONE") = "0" Then
            AULETTURA.Value = "0"
        Else
            AULETTURA.Value = "1"
        End If

        If SaldoContratto > 0 Then
            'DISABILITO COMANDO SE HA UN SALDO SUPERIORE A 0
            CType(Tab_Bollette1.FindControl("HRimborso"), HiddenField).Value = "0"
            CType(Tab_Bollette1.FindControl("HDeposito"), HiddenField).Value = "0"
        Else
            CType(Tab_Bollette1.FindControl("HRimborso"), HiddenField).Value = "1"
            CType(Tab_Bollette1.FindControl("HDeposito"), HiddenField).Value = "1"
        End If

        CType(Generale1.FindControl("btnArchivio"), System.Web.UI.WebControls.Image).Attributes.Add("onClick", "javascript:ApriSchedaArchivio(" & par.CriptaMolto("LETTURA") & ");")

        '12/05/2016 MAX CONTROLLO SE CONTRATTO IN PRIMA REGISTRAZIONE
        CType(Tab_Registrazione1.FindControl("lblFaseRegistrazione"), Label).Visible = False
        CType(Tab_Registrazione1.FindControl("btnAnnullaInvio"), ImageButton).Visible = False
        CType(Tab_Registrazione1.FindControl("lblFaseRegistrazione0"), Label).Visible = False
        If Session.Item("CONT_REGISTRAZIONE") = "1" Then
            If CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Text = "" Then
                If VerificaRegistrazione(lIdContratto) = True Then
                    CType(Tab_Registrazione1.FindControl("lblFaseRegistrazione"), Label).Visible = True
                    If SolaLettura <> "1" Then
                        CType(Tab_Registrazione1.FindControl("btnAnnullaInvio"), ImageButton).Visible = True
                        CType(Tab_Registrazione1.FindControl("lblFaseRegistrazione0"), Label).Visible = True
                    End If
                End If
            End If
        End If
        'FINE CONTROLLO

        ScriptManager.RegisterStartupScript(Page, Me.GetType(), "Key1", "<script>MakeStaticHeader('" + CType(Tab_Bollette1.FindControl("DataGridGest"), DataGrid).ClientID + "', 180, 1130 , 20 ,true,1); </script>", False)
        ScriptManager.RegisterStartupScript(Page, Me.GetType(), "Key2", "<script>MakeStaticHeader('" + CType(Tab_Bollette1.FindControl("DataGridContab"), DataGrid).ClientID + "', 220, 1130 , 20 ,true,0); </script>", False)
        ScriptManager.RegisterStartupScript(Page, Me.GetType(), "Key3", "<script>MakeStaticHeader('" + CType(Tab_SchemaBollette1.FindControl("DataGridSchema"), DataGrid).ClientID + "', 250, 1000 , 25 ,true,2); </script>", False)
    End Sub

    Private Function ScriviLogOp(ByVal CAMPO As String, ByVal VAL_PRECEDENTE As String, ByVal VAL_IMPOSTATO As String) As Boolean
        Try
            Dim aperto As Boolean = False

            If par.cmd.Connection.State = Data.ConnectionState.Closed Then
                par.OracleConn.Open()
                par.cmd = par.OracleConn.CreateCommand()
                aperto = True
            End If

            par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                    & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                    & "'F02','" & par.PulisciStrSql(CAMPO) & " - PRECEDENTE: " & VAL_PRECEDENTE & " - CORRENTE: " & VAL_IMPOSTATO & "')"
            par.cmd.ExecuteNonQuery()
            eventomodificadati.Value = "1"

            If aperto = True Then
                par.cmd.Dispose()
                par.OracleConn.Close()
            End If
            ScriviLogOp = True
        Catch ex As Exception
            par.OracleConn.Close()
            ScriviLogOp = False
        End Try
    End Function

    Private Function MemorizzaAttributi() As Boolean
        Dim ELENCOERRORI As String = ""
        Try
            Dim Tempo As String = Format(Now, "yyyyMMddHHmmss")
            Dim CTRL As Control = Nothing


            If CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Text.ToUpper Then
                If ScriviLogOp(CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Attributes("NOME").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Text.ToUpper) = False Then

                End If
            End If

            If CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Text.ToUpper Then
                If ScriviLogOp(CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Attributes("NOME").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Text.ToUpper) = False Then

                End If
            End If

            If CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).Text.ToUpper Then
                If ScriviLogOp(CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).Attributes("NOME").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).Text.ToUpper) = False Then

                End If
            End If

            If CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Text.ToUpper Then
                If ScriviLogOp(CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Attributes("NOME").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Text.ToUpper) = False Then

                End If
            End If

            If CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Text.ToUpper Then
                If ScriviLogOp(CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Attributes("NOME").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Text.ToUpper) = False Then

                End If
            End If

            If CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Text.ToUpper Then
                If ScriviLogOp(CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Attributes("NOME").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Text.ToUpper) = False Then

                End If
            End If

            If CType(Tab_Registrazione1.FindControl("cmbTipoPosizione"), DropDownList).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Registrazione1.FindControl("cmbTipoPosizione"), DropDownList).SelectedItem.Text Then
                If ScriviLogOp(CType(Tab_Registrazione1.FindControl("cmbTipoPosizione"), DropDownList).Attributes("NOME").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("cmbTipoPosizione"), DropDownList).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("cmbTipoPosizione"), DropDownList).SelectedItem.Text) = False Then

                End If
            End If

            If CType(Tab_Registrazione1.FindControl("cmbModoPagamento"), DropDownList).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Registrazione1.FindControl("cmbModoPagamento"), DropDownList).SelectedItem.Text Then
                If ScriviLogOp(CType(Tab_Registrazione1.FindControl("cmbModoPagamento"), DropDownList).Attributes("NOME").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("cmbModoPagamento"), DropDownList).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Registrazione1.FindControl("cmbModoPagamento"), DropDownList).SelectedItem.Text) = False Then

                End If
            End If

            If CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedValue <> "" Then
                If CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedItem.Text.ToUpper Then
                    If ScriviLogOp(CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).Attributes("NOME").ToUpper.ToString, CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedItem.Text) = False Then

                    End If
                End If
            End If

            If CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text.ToUpper Then
                If ScriviLogOp(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Attributes("NOME").ToUpper.ToString, CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text.ToUpper) = False Then

                End If
            End If
            If CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Text.ToUpper Then
                If ScriviLogOp(CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Attributes("NOME").ToUpper.ToString, CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Text.ToUpper) = False Then

                End If
            End If

            If CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text.ToUpper Then
                If ScriviLogOp(CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Attributes("NOME").ToUpper.ToString, CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text.ToUpper) = False Then

                End If
            End If

            If CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Text.ToUpper Then
                If ScriviLogOp(CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Attributes("NOME").ToUpper.ToString, CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Text.ToUpper) = False Then

                End If
            End If

            '23/01/2018
            Dim fl_Irreperibile As String = "NO"
            Dim fl_IrreperibileNew As String = "NO"
            If CType(Tab_Comunicazioni1.FindControl("chkIrreperibile"), CheckBox).Attributes("CORRENTE").ToString <> CType(Tab_Comunicazioni1.FindControl("chkIrreperibile"), CheckBox).Checked.ToString Then
                If CType(Tab_Comunicazioni1.FindControl("chkIrreperibile"), CheckBox).Attributes("CORRENTE").ToString = "true" Then
                    fl_Irreperibile = "SI"
                End If
                If CType(Tab_Comunicazioni1.FindControl("chkIrreperibile"), CheckBox).Checked Then
                    fl_IrreperibileNew = "SI"
                End If
                If ScriviLogOp(CType(Tab_Comunicazioni1.FindControl("chkIrreperibile"), CheckBox).Attributes("NOME").ToString, fl_Irreperibile, fl_IrreperibileNew) = False Then

                End If
            End If

            If CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Text.ToUpper Then
                If ScriviLogOp(CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Attributes("NOME").ToUpper.ToString, CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Text.ToUpper) = False Then

                End If
            End If

            If CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Attributes("CORRENTE").ToString.ToUpper <> CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Text.ToUpper Then
                If ScriviLogOp(CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Attributes("NOME").ToUpper.ToString, CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Attributes("CORRENTE").ToUpper.ToString, CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Text.ToUpper) = False Then

                End If
            End If


        Catch ex As Exception

        End Try
    End Function

    Private Function CaricaAttributi()

        'VENGONO CARICATI GLI ATTRIBUTI "CORRENTE" (VALORE CORRENTE) E "NOME" (NOME DEL CAMPO)
        'MENTRE IL VALORE CORRENTE VIENE CARICATO AUTOMATCAMENTE (SOLO PER CHECKBOX, TEXTBOX E DROPDOWNLIST)
        'IL VALORE DELL'ATTRIBUTO "NOME" VIENE CARICATO MANUALMENTE, IN MODO DA INSERIRE DEL TESTO PIU' 
        'SIGNIFICATIVO E NON SEMPLICEMENTE LA PROPRIETA' TEXT

        'Dim CTRL As Control = Nothing

        'For Each CTRL In Me.form1.Controls
        '    If TypeOf CTRL Is TextBox Then
        '        DirectCast(CTRL, TextBox).Attributes.Add("CORRENTE", UCase(DirectCast(CTRL, TextBox).Text))
        '    End If
        '    If TypeOf CTRL Is CheckBox Then
        '        DirectCast(CTRL, CheckBox).Attributes.Add("CORRENTE", Valore01(DirectCast(CTRL, CheckBox).Checked))
        '    End If
        '    If TypeOf CTRL Is DropDownList Then
        '        DirectCast(CTRL, DropDownList).Attributes.Add("CORRENTE", UCase(DirectCast(CTRL, DropDownList).SelectedItem.Text))
        '    End If
        'Next

        'attributi nome da memorizzare
        CType(Tab_Registrazione1.FindControl("txtSerie"), TextBox).Attributes.Add("NOME", "SERIE REGISTRAZIONE")
        CType(Tab_Registrazione1.FindControl("txtSerie"), TextBox).Attributes.Add("CORRENTE", CType(Tab_Registrazione1.FindControl("txtSerie"), TextBox).Text)

        CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Attributes.Add("NOME", "NUMERO REGISTRZIONE")
        CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Attributes.Add("NOME", "DATA REGISTRAZIONE")
        CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).Attributes.Add("NOME", "NUMERO REPERTORIO")
        CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Attributes.Add("NOME", "DATA REPERTORIO")
        CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Attributes.Add("NOME", "NUMERO ASSEGNAZIONE PG")
        CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Attributes.Add("NOME", "DATA ASSEGNAZIONE PG")
        CType(Tab_Registrazione1.FindControl("cmbTipoPosizione"), DropDownList).Attributes.Add("NOME", "TIPOLOGIA POSIZIONE")
        CType(Tab_Registrazione1.FindControl("cmbModoPagamento"), DropDownList).Attributes.Add("NOME", "MODALITA PAGAMENTO")
        CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Attributes.Add("NOME", "DEPOSITO CAUZIONALE")

        CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Attributes.Add("CORRENTE", CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Text)
        CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Attributes.Add("CORRENTE", CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Text)
        CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).Attributes.Add("CORRENTE", CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).Text)
        CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Attributes.Add("CORRENTE", CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Text)
        CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Attributes.Add("CORRENTE", CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Text)
        CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Attributes.Add("CORRENTE", CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Text)

        CType(Tab_Registrazione1.FindControl("cmbTipoPosizione"), DropDownList).Attributes.Add("CORRENTE", CType(Tab_Registrazione1.FindControl("cmbTipoPosizione"), DropDownList).SelectedItem.Text)
        CType(Tab_Registrazione1.FindControl("cmbModoPagamento"), DropDownList).Attributes.Add("CORRENTE", CType(Tab_Registrazione1.FindControl("cmbModoPagamento"), DropDownList).SelectedItem.Text)

        CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Attributes.Add("CORRENTE", CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text)
        '
        If CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedValue <> "" Then
            CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).Attributes.Add("NOME", "ORIGINE CONTRATTO")
            CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).Attributes.Add("CORRENTE", CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedItem.Text)
        End If
        CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Attributes.Add("NOME", "DATA DECORRENZA A.E.")
        CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Attributes.Add("CORRENTE", CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Text)

        CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Attributes.Add("NOME", "DATA SCADENZA")
        CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Attributes.Add("CORRENTE", CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text)

        CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Attributes.Add("NOME", "DATA SECONDA SCADENZA")
        CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Attributes.Add("CORRENTE", CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Text)

        CType(Tab_Comunicazioni1.FindControl("chkIrreperibile"), CheckBox).Attributes.Add("NOME", "FLAG IRREPERIBILITA'")
        CType(Tab_Comunicazioni1.FindControl("chkIrreperibile"), CheckBox).Attributes.Add("CORRENTE", CType(Tab_Comunicazioni1.FindControl("chkIrreperibile"), CheckBox).Checked)

        CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Attributes.Add("NOME", "E-MAIL")
        CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Attributes.Add("CORRENTE", CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Text)

        CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Attributes.Add("NOME", "E-MAIL PEC")
        CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Attributes.Add("CORRENTE", CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Text)

    End Function

    Function VerificaRegistrazione(idc As String) As Boolean
        Dim ConnAperta As Boolean = False
        VerificaRegistrazione = False
        Try
            If par.OracleConn.State = Data.ConnectionState.Closed Then
                ConnAperta = True
                par.OracleConn.Open()
                par.SettaCommand(par)
            End If

            par.cmd.CommandText = "select * from siscom_mi.RAPPORTI_UTENZA_IMPOSTE where cod_tributo in ('107T','115T') and id_fase_registrazione=1 and id_contratto=" & idc
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader.HasRows = True Then
                VerificaRegistrazione = True
            End If
            myReader.Close()

            If ConnAperta = True Then
                par.OracleConn.Close()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            End If
        Catch ex As Exception
            If Not IsNothing(par.myTrans) Then
                par.myTrans.Rollback()
            End If
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " (funzione VerificaRegistrazione) - " & ex.Message)
            Response.Redirect("../Errore.aspx", False)
        End Try
    End Function

    Function NuovoContratto()
        Dim scriptblock As String
        Dim progressivo As Integer

        Dim origine As Integer = 0


        Dim canonedaassegnare As Double = 0


        Try
            par.OracleConn.Open()
            par.SettaCommand(par)
            HttpContext.Current.Session.Add(lIdConnessione, par.OracleConn)
            Session.Add("lIdConnessione", lIdConnessione)
            Tab_Contratto1.DisabilitaMeta()





            If TipoContratto = "1" Or TipoContratto = "2" Or TipoContratto = "10" Or LetteraProvenienza = "D" Or TipoContratto = "11" Then
                CType(Tab_Conduttore1.FindControl("imgEliminaCond"), ImageButton).Enabled = False
                CType(Tab_Conduttore1.FindControl("imgEliminaCond"), ImageButton).ToolTip = "Non disponibile per questo tipo di contratto!"

                CType(Tab_Conduttore1.FindControl("btnAggiungiCond"), ImageButton).Enabled = False
                CType(Tab_Conduttore1.FindControl("btnAggiungiCond"), ImageButton).ToolTip = "Non disponibile per questo tipo di contratto!"

                CType(Tab_Conduttore1.FindControl("btnAggiungiComp"), ImageButton).Enabled = False
                CType(Tab_Conduttore1.FindControl("btnAggiungiComp"), ImageButton).ToolTip = "Non disponibile per questo tipo di contratto!"

                CType(Tab_Conduttore1.FindControl("img_EliminaComp"), ImageButton).Enabled = False
                CType(Tab_Conduttore1.FindControl("img_EliminaComp"), ImageButton).ToolTip = "Non disponibile per questo tipo di contratto!"

                CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).ReadOnly = True
                CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).ReadOnly = True

                CType(Tab_Contratto1.FindControl("txtEntroCuiDisdettare"), TextBox).Text = "6"

            End If

            If TipoContratto = "3" Or TipoContratto = "5" Or TipoContratto = "6" Or TipoContratto = "7" Or TipoContratto = "12" Then

                CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).ReadOnly = True
                CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).ReadOnly = True

            End If


            btnAttivaContratto.Visible = False
            'btnMavAttivazione.Visible = False
            speseunita.Value = "0"


            origine = par.IfEmpty(Request.QueryString("ORIG"), -1)
            If origine = -1 And TipoContratto <> "3" And TipoContratto <> "7" Then
                origine = 4
            End If


            UnitaContratto = Request.QueryString("IdUnita")
            txtIdUnita.Value = CStr(UnitaContratto)

            '***** VERIFICO SE DICHIARAZIONE DI AGG. REDDITI
            Dim aggRedd As Integer = 0
            par.cmd.CommandText = "SELECT id_d_import FROM DOMANDE_BANDO_VSA WHERE ID_MOTIVO_DOMANDA = 11 AND ID=" & lIdDomandaERP
            Dim myReaderE As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderE.Read Then
                aggRedd = 1
            End If
            myReaderE.Close()

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where generato_contratto='0' and id_domanda=" & Request.QueryString("IdDomanda") & " and id_unita=" & Request.QueryString("IdUnita")
            Dim myReaderAA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderAA.Read Then
                DataDisponibilitaAlloggio = par.IfNull(myReaderAA("data_disponibilita"), "")
                NUMERO_OFFERTA = par.IfNull(myReaderAA("N_OFFERTA"), "")
                CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text = par.FormattaData(par.IfNull(myReaderAA("data_PROVVEDIMENTO"), ""))
                CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Text = par.IfNull(myReaderAA("PROVVEDIMENTO"), "")

                TIPO_CANONE_APPLICATO = par.IfNull(myReaderAA("TIPO_APPLICATO"), "")
                CANONE_ALTERNATIVO = par.IfNull(myReaderAA("CANONE_ALT"), "0")

                If TipoContratto = "11" Then
                    CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Text = par.FormattaData(par.IfNull(myReaderAA("data_assegnazione"), ""))
                End If

            End If
            myReaderAA.Close()




            par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=35"
            myReaderAA = par.cmd.ExecuteReader()
            If myReaderAA.Read Then
                sAnnoSchema = par.IfNull(myReaderAA("VALORE"), "2010")
                annoschema.Value = sAnnoSchema
            End If
            myReaderAA.Close()


            LetteraERP = "A"
            par.cmd.CommandText = "SELECT canoni_ui.canone FROM siscom_mi.canoni_ui,SISCOM_MI.unita_immobiliari where unita_immobiliari.id=canoni_ui.id and  unita_immobiliari.id_destinazione_uso=2 and unita_immobiliari.id=" & Request.QueryString("IdUnita") & " order by canoni_ui.data desc"
            myReaderAA = par.cmd.ExecuteReader()
            If myReaderAA.Read Then
                LetteraERP = "B"
                canonedaassegnare = par.IfNull(myReaderAA("canone"), 0)
                LBLErpModerato.Visible = True
            End If
            myReaderAA.Close()


            If TipoContratto <> "3" And TipoContratto <> "5" And TipoContratto <> "6" And TipoContratto <> "7" Then
                'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where id_domanda=" & Request.QueryString("IdDomanda") & " and id_unita=" & Request.QueryString("IdUnita") & " FOR UPDATE NOWAIT"
                'par.cmd.ExecuteNonQuery()

                CType(Tab_Canone1.FindControl("lblistat4"), DropDownList).Items.FindByText("0").Selected = True


                CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedIndex = -1
                CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.FindByValue("R").Selected = True
                CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Enabled = False
                CType(Tab_Contratto1.FindControl("txtDescrDestinazione"), TextBox).Enabled = False

            Else
                If TipoContratto = "3" Then
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("STANDARD", "0"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("COOPERATIVE", "C"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431 P.O.R.", "P"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("RESIDENZIALE", "R"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("392/78 ASSOCIAZIONI", "A"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 Art.15 R.R.1/2004", "D"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 Art.15 C.2 R.R.1/2004", "V"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 SPECIALI", "S"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("FORZE DELL'ORDINE", "Z"))

                    '431/98 Art.15 R.R.1/2004

                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedIndex = -1
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.FindByValue("B").Selected = True

                    'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where PROVENIENZA='U' and id_unita=" & Request.QueryString("IdUnita") & " FOR UPDATE NOWAIT"



                    CType(Tab_Conduttore1.FindControl("Label1"), Label).Text = "ELENCO EX INTESTATARI"

                    CType(Tab_Conduttore1.FindControl("btnAggiungiComp"), System.Web.UI.WebControls.Image).Visible = False
                    CType(Tab_Conduttore1.FindControl("imgDiventaINT"), System.Web.UI.WebControls.Image).Visible = False
                    CType(Tab_Conduttore1.FindControl("img_EliminaComp"), System.Web.UI.WebControls.Image).Visible = False

                    ' CType(Tab_Conduttore1.FindControl("img_EliminaOspite"), System.Web.UI.WebControls.Image).Visible = False
                    CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Visible = False
                    CType(Tab_Conduttore1.FindControl("Label4"), Label).Visible = False
                    CType(Tab_Conduttore1.FindControl("Label2"), Label).Visible = False


                    CType(Tab_Conduttore1.FindControl("btnAggiungiCond"), System.Web.UI.WebControls.Image).Visible = False
                    CType(Tab_Conduttore1.FindControl("imgEliminaCond"), System.Web.UI.WebControls.Image).Visible = False
                    CType(Tab_Conduttore1.FindControl("Img_DiventaComp"), System.Web.UI.WebControls.Image).Visible = False



                    Response.Write("<script>alert('Attenzione, specificare la tipologia, la destinazione d\'uso e la durata del rapporto USI DIVERSI che si sta per inserire agendo sul Nome Ufficiale della scheda CONTRATTO!');</script>")

                End If

                If TipoContratto = "5" Then

                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("POSTO AUTO COPERTO,SCOPERTO,BOX,MOTOBOX ETC.", "B"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("NEGOZIO, MAGAZZINO, LABORATORIO, UFFICIO, ETC.", "N"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("RESIDENZIALE", "R"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("COOPERATIVE", "C"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431 P.O.R.", "P"))
                    'CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("RESIDENZIALE", "R"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 Art.15 R.R.1/2004", "D"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 Art.15 C.2 R.R.1/2004", "V"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 SPECIALI", "S"))

                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedIndex = -1
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.FindByValue("0").Selected = True

                    'MAX 23/04/2015
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("COMODATO D'USO GRATUITO", "Y"))


                    'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where PROVENIENZA='Q' and id_unita=" & Request.QueryString("IdUnita") & " FOR UPDATE NOWAIT"
                    Response.Write("<script>alert('Attenzione, specificare la tipologia e la destinazione d\'uso del rapporto 392/78 che si sta per inserire agendo sul Nome Ufficiale della scheda CONTRATTO!');</script>")
                End If

                If TipoContratto = "6" Then
                    Select Case LetteraProvenienza
                        Case "D"
                            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where (PROVENIENZA='D') and id_unita=" & Request.QueryString("IdUnita") & " FOR UPDATE NOWAIT"

                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("POSTO AUTO COPERTO,SCOPERTO,BOX,MOTOBOX ETC.", "B"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("NEGOZIO, MAGAZZINO, LABORATORIO, UFFICIO, ETC.", "N"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("RESIDENZIALE", "R"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("392/78 ASSOCIAZIONI", "A"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431 P.O.R.", "P"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("COOPERATIVE", "C"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("STANDARD", "0"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 SPECIALI", "S"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 Art.15 C.2 R.R.1/2004", "V"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("CONCESSIONE SPAZI P.", "X"))
                            'CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("CONCESSIONE IMPRESE", "2"))
                            'CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("CONCESSIONE ASSOCIAZIONI", "3"))

                            'MAX 23/04/2015
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("COMODATO D'USO GRATUITO", "Y"))

                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedIndex = -1
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.FindByValue("D").Selected = True
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Enabled = False
                            CType(Tab_Contratto1.FindControl("txtDescrDestinazione"), TextBox).Enabled = False

                            CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).Text = "2"
                            CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).Text = "0"

                        Case "V"
                            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where (PROVENIENZA='V') and id_unita=" & Request.QueryString("IdUnita") & " FOR UPDATE NOWAIT"

                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("POSTO AUTO COPERTO,SCOPERTO,BOX,MOTOBOX ETC.", "B"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("NEGOZIO, MAGAZZINO, LABORATORIO, UFFICIO, ETC.", "N"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("RESIDENZIALE", "R"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("392/78 ASSOCIAZIONI", "A"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431 P.O.R.", "P"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("COOPERATIVE", "C"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("STANDARD", "0"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 SPECIALI", "S"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 Art.15 R.R.1/2004", "D"))

                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("CONCESSIONE SPAZI P.", "X"))
                            'CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("CONCESSIONE IMPRESE", "2"))
                            'CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("CONCESSIONE ASSOCIAZIONI", "3"))

                            'MAX 23/04/2015
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("COMODATO D'USO GRATUITO", "Y"))

                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedIndex = -1
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.FindByValue("V").Selected = True
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Enabled = False
                            CType(Tab_Contratto1.FindControl("txtDescrDestinazione"), TextBox).Enabled = False

                            CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).Text = "2"
                            CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).Text = "0"

                        Case Else
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("POSTO AUTO COPERTO,SCOPERTO,BOX,MOTOBOX ETC.", "B"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("NEGOZIO, MAGAZZINO, LABORATORIO, UFFICIO, ETC.", "N"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("RESIDENZIALE", "R"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("392/78 ASSOCIAZIONI", "A"))
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 Art.15 R.R.1/2004", "D"))

                            'MAX 23/04/2015
                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("COMODATO D'USO GRATUITO", "Y"))

                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedIndex = -1

                            CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.FindByValue("0").Selected = True

                            Response.Write("<script>alert('Attenzione, specificare la tipologia e la destinazione d\'uso del rapporto 431/98 che si sta per inserire agendo sul Nome Ufficiale della scheda CONTRATTO!');</script>")


                    End Select


                End If

                If TipoContratto = "7" Then
                    'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where PROVENIENZA='X' and id_unita=" & Request.QueryString("IdUnita") & " FOR UPDATE NOWAIT"
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedIndex = -1
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.FindByValue("R").Selected = True
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Enabled = False

                    CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Text = "ABUSIVO"
                    CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Enabled = False

                    CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Enabled = False
                    'max 18/07/2019
                    CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).Enabled = False
                    CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).Text = CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text
                    '-------
                    CType(Tab_Contratto1.FindControl("Label26"), Label).Visible = True
                    CType(Tab_Contratto1.FindControl("Image1"), System.Web.UI.WebControls.Image).Visible = True

                End If

                'par.cmd.ExecuteNonQuery()

                If TipoContratto <> "7" Then
                    CType(Tab_Canone1.FindControl("lblistat"), Label).Visible = True
                    CType(Tab_Canone1.FindControl("lblistat1"), Label).Visible = True
                    CType(Tab_Canone1.FindControl("lblistat3"), Label).Visible = True

                    CType(Tab_Canone1.FindControl("ImgIstat"), WebControls.Image).Visible = True
                    HttpContext.Current.Session.Add("BB", "SELECT to_char(to_date(ADEGUAMENTO_ISTAT.DATA_AGG_INIZIO,'yyyymmdd'),'dd/mm/yyyy') as ""INIZIO"",to_char(to_date(ADEGUAMENTO_ISTAT.DATA_AGG_FINE,'yyyymmdd'),'dd/mm/yyyy') as ""FINE"",RAPPORTI_UTENZA.ID,COD_CONTRATTO,to_char(to_date(data_DECORRENZA,'yyyymmdd'),'dd/mm/yyyy') as ""DECORRENZA"",PERC_ISTAT,ADEGUAMENTO_ISTAT.IMPORTO_CANONE_INIZIALE AS ""IMP_CANONE_INIZIALE"" ,IMPORTO_TR_AGG,IMPORTO_CANONE_AGG  FROM SISCOM_MI.ADEGUAMENTO_ISTAT,SISCOM_MI.RAPPORTI_UTENZA WHERE ADEGUAMENTO_ISTAT.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND RAPPORTI_UTENZA.ID=" & lIdContratto & " ORDER BY ID DESC")

                    CType(Tab_Canone1.FindControl("lblistat2"), DropDownList).Visible = True
                    CType(Tab_Canone1.FindControl("lblistat4"), DropDownList).Visible = True

                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Enabled = True
                    CType(Tab_Contratto1.FindControl("txtDescrDestinazione"), TextBox).Enabled = True
                Else
                    'abusivo
                End If

            End If

            'GESTITO DA SINDACATO
            par.RiempiDListConVuoto(Tab_SchemaBollette1, par.OracleConn, "lstSindacati", "select * from sindacati_vsa", "DESCRIZIONE", "ID")

            par.RiempiDList(Tab_SchemaBollette1, par.OracleConn, "cmbVoceSchema", "select * from siscom_mi.t_voci_bolletta where id<>407 AND SELEZIONABILE=1 order by descrizione asc", "DESCRIZIONE", "ID")
            par.RiempiDList(Tab_Bollette1, par.OracleConn, "cmbVoceSchema", "select * from siscom_mi.t_voci_bolletta where id<>407 AND SELEZIONABILE=1 order by descrizione asc", "DESCRIZIONE", "ID")



            If TipoContratto = "3" Then
                par.RiempiDList(Tab_Contratto1, par.OracleConn, "cmbNomeUfficiale", "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE SUBSTR(COD,1,3)='USD' ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
                If origine <> -1 Then
                    par.RiempiDList(Tab_Contratto1, par.OracleConn, "cmbOrigineRU", "SELECT * FROM SISCOM_MI.TAB_ORIGINE_CONTRATTO WHERE COD_TIPOLOGIA_CONTR='USD'", "DESCRIZIONE", "ID")
                End If
            End If
            If TipoContratto = "1" Or TipoContratto = "2" Or TipoContratto = "10" Or TipoContratto = "11" Or TipoContratto = "12" Then
                par.RiempiDListConVuoto(Tab_Contratto1, par.OracleConn, "cmbNomeUfficiale", "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE SUBSTR(COD,1,3)='ERP' ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
                If origine <> -1 Then
                    par.RiempiDList(Tab_Contratto1, par.OracleConn, "cmbOrigineRU", "SELECT * FROM SISCOM_MI.TAB_ORIGINE_CONTRATTO WHERE COD_TIPOLOGIA_CONTR='ERP'", "DESCRIZIONE", "ID")
                End If
            End If
            If TipoContratto = "5" Then
                par.RiempiDListConVuoto(Tab_Contratto1, par.OracleConn, "cmbNomeUfficiale", "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE SUBSTR(COD,1,6)='EQC392' ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
                If origine <> -1 Then
                    par.RiempiDList(Tab_Contratto1, par.OracleConn, "cmbOrigineRU", "SELECT * FROM SISCOM_MI.TAB_ORIGINE_CONTRATTO WHERE COD_TIPOLOGIA_CONTR='EQC392'", "DESCRIZIONE", "ID")
                End If
            End If
            If TipoContratto = "6" Then
                par.RiempiDListConVuoto(Tab_Contratto1, par.OracleConn, "cmbNomeUfficiale", "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE SUBSTR(COD,1,6)='L43198' ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
                If origine <> -1 Then
                    par.RiempiDList(Tab_Contratto1, par.OracleConn, "cmbOrigineRU", "SELECT * FROM SISCOM_MI.TAB_ORIGINE_CONTRATTO WHERE COD_TIPOLOGIA_CONTR='L43198'", "DESCRIZIONE", "ID")
                End If
            End If
            If TipoContratto = "7" Then
                par.RiempiDListConVuoto(Tab_Contratto1, par.OracleConn, "cmbNomeUfficiale", "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE SUBSTR(COD,1,4)='NONE' ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
                If origine <> -1 Then
                    par.RiempiDList(Tab_Contratto1, par.OracleConn, "cmbOrigineRU", "SELECT * FROM SISCOM_MI.TAB_ORIGINE_CONTRATTO WHERE COD_TIPOLOGIA_CONTR='NONE'", "DESCRIZIONE", "ID")
                End If
            End If
            CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).Items.Add(New ListItem("", "-1"))
            CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).Items.Add(New ListItem("Prima assegnazione", "4"))

            If origine <> -1 Then
                CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedValue = origine
                lblOrigineContratto.Text = CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedItem.Text
            End If

            par.RiempiDListConVuoto(Tab_Registrazione1, par.OracleConn, "cmbUfficioRegistro", "SELECT * FROM SISCOM_MI.TAB_UFFICIO_REGISTRO ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
            par.RiempiDListConVuoto(Tab_Comunicazioni1, par.OracleConn, "cmbTipoViaCor", "select * from siscom_mi.tipologia_indirizzo order by descrizione asc", "DESCRIZIONE", "COD")
            par.RiempiDListConNULL(Tab_Comunicazioni1, par.OracleConn, "cmbCommissariato", "select * from siscom_mi.tab_commissariati order by descrizione asc", "DESCRIZIONE", "ID")

            'max 13/06/2016
            par.RiempiDListConVuoto(Tab_Registrazione1, par.OracleConn, "cmbTipoPosizione", "select * from SISCOM_MI.TIPOLOGIA_POSIZIONE ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "ID")
            par.RiempiDListConVuoto(Tab_Registrazione1, par.OracleConn, "cmbModoPagamento", "select * from SISCOM_MI.TIPOLOGIA_PAGAMENTO ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "ID")

            par.myTrans = par.OracleConn.BeginTransaction()
            '‘par.cmd.Transaction = par.myTrans
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)
            Dim LimiteTassaRegistrazione As Double = 0
            par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=6"
            Dim myReaderJ As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderJ.Read Then
                LimiteTassaRegistrazione = CDbl(par.PuntiInVirgole(par.IfNull(myReaderJ("VALORE"), 0)))
            End If
            myReaderJ.Close()

            'Select Case Mid(Request.QueryString("IdUnita"), 1, 1)
            '    Case "1"
            '        Provenienza = "1"
            '    Case "2"
            '        Provenienza = "2"
            '    Case "3"
            '        Provenienza = "3"
            'End Select

            par.cmd.CommandText = "select SISCOM_MI.seq_rapporti_utenza.NEXTVAL from dual"
            Dim myReaderA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                lIdContratto = myReaderA(0) ' CLng(Provenienza & Format(myReaderA(0), "00000000"))
            End If
            myReaderA.Close()

            Select Case TipoContratto
                Case "3"
                    par.cmd.CommandText = "select scale_edifici.descrizione as scala, COMUNI_NAZIONI.SIGLA AS PROVINCIA,COMUNI_NAZIONI.NOME AS COMUNE_DI, (SELECT valore FROM siscom_mi.DIMENSIONI WHERE cod_tipologia='SUP_CONV' AND ID_UNITA_IMMOBILIARE=UNITA_IMMOBILIARI.ID) AS SUP_CONV,(SELECT valore FROM siscom_mi.DIMENSIONI WHERE cod_tipologia='SUP_NETTA' AND ID_UNITA_IMMOBILIARE=UNITA_IMMOBILIARI.ID) AS SUP_NETTA,INDIRIZZI.DESCRIZIONE AS INDIRIZZO,INDIRIZZI.CIVICO,INDIRIZZI.CAP,unita_immobiliari.*,TIPO_LIVELLO_PIANO.DESCRIZIONE AS PIANO,TIPOLOGIA_UNITA_IMMOBILIARI.DESCRIZIONE AS TIPO_ALLOGGIO,IDENTIFICATIVI_CATASTALI.FOGLIO,IDENTIFICATIVI_CATASTALI.NUMERO,IDENTIFICATIVI_CATASTALI.SUB,identificativi_catastali.cod_categoria_catastale,identificativi_catastali.rendita,identificativi_catastali.cod_classe_catastale from siscom_mi.scale_edifici,SEPA.COMUNI_NAZIONI, SISCOM_MI.INDIRIZZI,SISCOM_MI.EDIFICI,SISCOM_MI.IDENTIFICATIVI_CATASTALI,SISCOM_MI.TIPOLOGIA_UNITA_IMMOBILIARI,SISCOM_MI.TIPO_LIVELLO_PIANO,siscom_mi.unita_immobiliari where unita_immobiliari.id_scala=scale_edifici.id (+) and COMUNI_NAZIONI.COD=INDIRIZZI.COD_COMUNE AND EDIFICI.ID=UNITA_IMMOBILIARI.ID_EDIFICIO AND INDIRIZZI.ID=UNITA_IMMOBILIARI.ID_INDIRIZZO AND UNITA_IMMOBILIARI.ID_CATASTALE=IDENTIFICATIVI_CATASTALI.ID (+) AND TIPOLOGIA_UNITA_IMMOBILIARI.COD=UNITA_IMMOBILIARI.COD_TIPOLOGIA (+) AND  TIPO_LIVELLO_PIANO.COD=UNITA_IMMOBILIARI.COD_TIPO_LIVELLO_PIANO AND UNITA_IMMOBILIARI.id=" & Request.QueryString("IdUnita")
                Case "12"
                    par.cmd.CommandText = "select scale_edifici.descrizione as scala,COMUNI_NAZIONI.SIGLA AS ""PROVINCIA"",COMUNI_NAZIONI.NOME AS ""COMUNE_DI"",(SELECT valore FROM siscom_mi.DIMENSIONI WHERE cod_tipologia='SUP_NETTA' AND ID_UNITA_IMMOBILIARE=UNITA_IMMOBILIARI.ID) AS SUP_NETTA, INDIRIZZI.DESCRIZIONE AS ""INDIRIZZO"",INDIRIZZI.CIVICO,INDIRIZZI.CAP,unita_immobiliari.*,TIPO_LIVELLO_PIANO.DESCRIZIONE AS ""PIANO"",TIPOLOGIA_UNITA_IMMOBILIARI.DESCRIZIONE AS ""TIPO_ALLOGGIO"",IDENTIFICATIVI_CATASTALI.FOGLIO,IDENTIFICATIVI_CATASTALI.NUMERO,IDENTIFICATIVI_CATASTALI.SUB,identificativi_catastali.cod_categoria_catastale,identificativi_catastali.rendita,identificativi_catastali.cod_classe_catastale from siscom_mi.scale_edifici,SEPA.COMUNI_NAZIONI, SISCOM_MI.INDIRIZZI,SISCOM_MI.EDIFICI,SISCOM_MI.IDENTIFICATIVI_CATASTALI,SISCOM_MI.TIPOLOGIA_UNITA_IMMOBILIARI,SISCOM_MI.TIPO_LIVELLO_PIANO,siscom_mi.unita_immobiliari where unita_immobiliari.id_scala=scale_edifici.id (+) and COMUNI_NAZIONI.COD=INDIRIZZI.COD_COMUNE AND EDIFICI.ID=UNITA_IMMOBILIARI.ID_EDIFICIO AND INDIRIZZI.ID=UNITA_IMMOBILIARI.ID_INDIRIZZO AND UNITA_IMMOBILIARI.ID_CATASTALE=IDENTIFICATIVI_CATASTALI.ID (+) AND TIPOLOGIA_UNITA_IMMOBILIARI.COD=UNITA_IMMOBILIARI.COD_TIPOLOGIA (+) AND  TIPO_LIVELLO_PIANO.COD=UNITA_IMMOBILIARI.COD_TIPO_LIVELLO_PIANO AND UNITA_IMMOBILIARI.id=" & Request.QueryString("IdUnita")
                Case Else
                    par.cmd.CommandText = "select scale_edifici.descrizione as scala,COMUNI_NAZIONI.SIGLA AS ""PROVINCIA"",COMUNI_NAZIONI.NOME AS ""COMUNE_DI"",(SELECT valore FROM siscom_mi.DIMENSIONI WHERE cod_tipologia='SUP_CONV' AND ID_UNITA_IMMOBILIARE=UNITA_IMMOBILIARI.ID) AS SUP_CONV, INDIRIZZI.DESCRIZIONE AS ""INDIRIZZO"",INDIRIZZI.CIVICO,INDIRIZZI.CAP,unita_immobiliari.*,TIPO_LIVELLO_PIANO.DESCRIZIONE AS ""PIANO"",TIPOLOGIA_UNITA_IMMOBILIARI.DESCRIZIONE AS ""TIPO_ALLOGGIO"",IDENTIFICATIVI_CATASTALI.FOGLIO,IDENTIFICATIVI_CATASTALI.NUMERO,IDENTIFICATIVI_CATASTALI.SUB,identificativi_catastali.cod_categoria_catastale,identificativi_catastali.rendita,identificativi_catastali.cod_classe_catastale from siscom_mi.scale_edifici,SEPA.COMUNI_NAZIONI, SISCOM_MI.INDIRIZZI,SISCOM_MI.EDIFICI,SISCOM_MI.IDENTIFICATIVI_CATASTALI,SISCOM_MI.TIPOLOGIA_UNITA_IMMOBILIARI,SISCOM_MI.TIPO_LIVELLO_PIANO,siscom_mi.unita_immobiliari where unita_immobiliari.id_scala=scale_edifici.id (+) and COMUNI_NAZIONI.COD=INDIRIZZI.COD_COMUNE AND EDIFICI.ID=UNITA_IMMOBILIARI.ID_EDIFICIO AND INDIRIZZI.ID=UNITA_IMMOBILIARI.ID_INDIRIZZO AND UNITA_IMMOBILIARI.ID_CATASTALE=IDENTIFICATIVI_CATASTALI.ID (+) AND TIPOLOGIA_UNITA_IMMOBILIARI.COD=UNITA_IMMOBILIARI.COD_TIPOLOGIA (+) AND  TIPO_LIVELLO_PIANO.COD=UNITA_IMMOBILIARI.COD_TIPO_LIVELLO_PIANO AND UNITA_IMMOBILIARI.id=" & Request.QueryString("IdUnita")
            End Select

            If TipoContratto <> "3" Then

            Else

            End If
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader

            If myReader.Read Then
                CodContratto = par.IfNull(myReader("cod_unita_immobiliare"), "")

                Select Case TipoContratto
                    Case "12"
                        If par.IfNull(myReader("SUP_NETTA"), "0") = "0" Then
                            Response.Write("<script>alert('Attenzione, si è verificato un errore. Verificare che sia stata inserita la superficie NETTA dell\'unita!');</script>")
                        End If
                    Case "3"
                        If UCase(par.IfNull(myReader("TIPO_ALLOGGIO"), "")) = "CARTELLONISTICA" Then
                            If par.IfNull(myReader("SUP_NETTA"), "0") = "0" Then
                                Response.Write("<script>alert('Attenzione, si è verificato un errore. Verificare che sia stata inserita la superficie NETTA dell\'unita!');</script>")
                            End If
                        End If
                    Case Else
                        If par.IfNull(myReader("SUP_CONV"), "0") = "0" Then
                            Response.Write("<script>alert('Attenzione, si è verificato un errore. Verificare che sia stata inserita la superficie CONVENZIONALE dell\'unita!');</script>")
                        End If
                End Select

                'par.cmd.CommandText = "select count(id_CONTRATTO) from siscom_mi.unita_contrattuale where id_unita=" & Request.QueryString("IdUnita")
                par.cmd.CommandText = "select MAX(TO_NUMBER(TRANSLATE(SUBSTR(cod_contratto,18,2),'A','0'))) from SISCOM_MI.rapporti_utenza where SUBSTR(cod_contratto,1,17)='" & CodContratto & "'"
                '
                'MAX(TO_NUMBER(SUBSTR(cod_contratto,18,2)))
                myReader1 = par.cmd.ExecuteReader()
                If myReader1.Read Then
                    progressivo = par.IfNull(myReader1(0), 0) + 1
                Else
                    progressivo = 1
                End If
                myReader1.Close()


                CodContratto = CodContratto & Format((progressivo), "00")
                CodContratto1 = CodContratto
                lblContratto.Text = "Rapporto Cod. " & CodContratto


                'CARICO UNITA PRINCIPALI IN TABELLA


                Dim testoTabella As String = ""

                testoTabella = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                & "<tr>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>COD.UNITA</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>FOGLIO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>MAPPALE</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>SUB</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>TIPO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>INDIRIZZO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>PIANO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>SCALA</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>INTERNO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "</td>" _
                & "<td style='height: 19px'>" _
                & "</td>" _
                & "</tr>"

                '& "<span style='font-size: 8pt; font-family: Arial'>" & "<a href='DettagliUnita.aspx?IDC=" & lIdContratto & "&ID=" & par.IfNull(myReader("cod_unita_immobiliare"), "") & "' target='_blank'>" & par.IfNull(myReader("cod_unita_immobiliare"), "") & "</a>" & "</span></td>" _
                '& "<span style='font-size: 8pt; font-family: Arial'><a href=" & Chr(34) & "document.getElementById('USCITA').value='1';window.open('../CENSIMENTO/InserimentoUniImmob.aspx?LE=1&ID=" & par.IfNull(myReader("cod_unita_immobiliare"), "") & "','Dettagli','height=530,top=0,left=0,width=674');" & Chr(34) & ">" & par.IfNull(myReader("cod_unita_immobiliare"), "") & "</a></span></td>" _
                testoTabella = testoTabella _
                            & "<tr>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'><a href='#' onclick=" & Chr(34) & "if (document.getElementById('txtModificato').value == '1') {alert('Attenzione...Sono state apportate delle modifiche. Salvare prima di proseguire!');}else {document.getElementById('USCITA').value='1';window.open('../CENSIMENTO/InserimentoUniImmob.aspx?F=" & lIdConnessione & "&X=1&LE=1&ID=" & par.IfNull(myReader("ID"), "") & "','Dettagli','height=580,top=0,left=0,width=780');}" & Chr(34) & ">" & par.IfNull(myReader("cod_unita_immobiliare"), "") & "</a></span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader("FOGLIO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader("NUMERO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader("SUB"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader("TIPO_ALLOGGIO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader("INDIRIZZO"), "") & "," & par.IfNull(myReader("CIVICO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader("PIANO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader("SCALA"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader("INTERNO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "</td>" _
                            & "<td style='height: 19px'>" _
                            & "</td>" _
                            & "</tr>"

                sPiano = par.IfNull(myReader("PIANO"), "")
                sInterno = par.IfNull(myReader("INTERNO"), "")
                sSCALA = par.IfNull(myReader("SCALA"), "")
                sFoglio = par.IfNull(myReader("FOGLIO"), "")
                sSub = par.IfNull(myReader("sub"), "")
                sParticella = par.IfNull(myReader("NUMERO"), "")
                sCatastale = par.IfNull(myReader("cod_categoria_catastale"), "")

                sClasse = par.IfNull(myReader("cod_classe_catastale"), "")
                sRendita = par.IfNull(myReader("rendita"), "")

                sIdEdificio = par.IfNull(myReader("id_edificio"), 0)


                CType(Tab_UnitaImmLocate1.FindControl("TBL_UNITA_ALLOCATE"), Label).Text = testoTabella & "</table>"

                'CARICO INFORMAZIONI IMMOBILI SUL PRIMO TAB
                CType(Generale1.FindControl("lblCodUnita"), Label).Text = par.IfNull(myReader("cod_unita_immobiliare"), "")
                CType(Generale1.FindControl("lblIndirizzo"), Label).Text = par.IfNull(myReader("COMUNE_DI"), "") & " (" & par.IfNull(myReader("PROVINCIA"), "") & ") " & " CAP " & par.IfNull(myReader("CAP"), "") & " " & par.IfNull(myReader("INDIRIZZO"), "") & "," & par.IfNull(myReader("CIVICO"), "") '
                CType(Generale1.FindControl("lblTipoImmobile"), Label).Text = par.IfNull(myReader("TIPO_ALLOGGIO"), "")
                If TipoContratto <> "3" Then
                    CType(Generale1.FindControl("lblConvenzionale"), Label).Text = par.IfNull(myReader("sup_conv"), "")
                Else
                    CType(Generale1.FindControl("lblConvenzionale"), Label).Text = ""
                    If UCase(par.IfNull(myReader("TIPO_ALLOGGIO"), "")) = "CARTELLONISTICA" Then
                        CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedIndex = -1
                        CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.FindByValue("X").Selected = True
                        CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Enabled = False
                    End If


                End If
                CType(Generale1.FindControl("lblComplessoEdificio"), Label).Attributes.Add("onclick", "javascript:window.open('DatiComplessoEdificio.aspx?COD=" & par.IfNull(myReader("cod_unita_immobiliare"), "") & "','Dati','');")




                If TipoContratto = "7" And DataDisponibilitaAlloggio = "" Then
                    par.cmd.CommandText = "select * from alloggi where cod_alloggio='" & par.IfNull(myReader("cod_unita_immobiliare"), "") & "'"
                    myReader1 = par.cmd.ExecuteReader()
                    If myReader1.Read Then
                        DataDisponibilitaAlloggio = par.IfNull(myReader1("data_disponibilita"), "")
                    Else
                        par.cmd.CommandText = "select * from siscom_mi.ui_usi_diversi where cod_alloggio='" & par.IfNull(myReader("cod_unita_immobiliare"), "") & "'"
                        Dim myReader12345 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReader12345.Read Then
                            DataDisponibilitaAlloggio = par.IfNull(myReader12345("data_disponibilita"), "")
                        End If
                        myReader12345.Close()
                    End If
                    myReader1.Close()
                End If



                '****** aggiornamento automatico della dest_uso per le ffoo
                If TipoContratto = 10 Then
                    par.cmd.CommandText = "UPDATE SISCOM_MI.UNITA_IMMOBILIARI SET ID_DESTINAZIONE_USO = 6 WHERE ID=" & UnitaContratto
                    par.cmd.ExecuteNonQuery()
                End If
                '****** FINE aggiornamento automatico della dest_uso per le ffoo
                'CARICO EVENTUALI PERTINENZE
                testoTabella = ""
                testoTabella = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                            & "<tr>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'><strong>COD.UNITA</strong></span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'><strong>FOGLIO</strong></span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'><strong>MAPPALE</strong></span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'><strong>SUB</strong></span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'><strong>TIPO</strong></span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'><strong>INDIRIZZO</strong></span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'><strong>PIANO</strong></span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'><strong>SCALA</strong></span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'><strong>INTERNO</strong></span></td>" _
                            & "<td style='height: 19px'>" _
                            & "</td>" _
                            & "<td style='height: 19px'>" _
                            & "</td>" _
                            & "</tr>"


                par.cmd.CommandText = "SELECT ID FROM SISCOM_MI.UNITA_IMMOBILIARI WHERE ID_UNITA_PRINCIPALE=" & Request.QueryString("IdUnita")
                Dim myReader2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                Do While myReader2.Read

                    par.cmd.CommandText = "select SCALE_EDIFICI.DESCRIZIONE AS SCALA,INDIRIZZI.DESCRIZIONE AS ""INDIRIZZO"",INDIRIZZI.CIVICO,unita_immobiliari.*,TIPO_LIVELLO_PIANO.DESCRIZIONE AS ""PIANO"",TIPOLOGIA_UNITA_IMMOBILIARI.DESCRIZIONE AS ""TIPO_ALLOGGIO"",IDENTIFICATIVI_CATASTALI.FOGLIO,IDENTIFICATIVI_CATASTALI.NUMERO,IDENTIFICATIVI_CATASTALI.SUB from SISCOM_MI.SCALE_EDIFICI,SISCOM_MI.INDIRIZZI,SISCOM_MI.EDIFICI,SISCOM_MI.IDENTIFICATIVI_CATASTALI,SISCOM_MI.TIPOLOGIA_UNITA_IMMOBILIARI,SISCOM_MI.TIPO_LIVELLO_PIANO,siscom_mi.unita_immobiliari where UNITA_IMMOBILIARI.ID_SCALA=SCALE_EDIFICI.ID (+) AND EDIFICI.ID=UNITA_IMMOBILIARI.ID_EDIFICIO AND INDIRIZZI.ID=EDIFICI.ID_INDIRIZZO_PRINCIPALE AND UNITA_IMMOBILIARI.ID_CATASTALE=IDENTIFICATIVI_CATASTALI.ID (+) AND TIPOLOGIA_UNITA_IMMOBILIARI.COD=UNITA_IMMOBILIARI.COD_TIPOLOGIA (+) AND  TIPO_LIVELLO_PIANO.COD=UNITA_IMMOBILIARI.COD_TIPO_LIVELLO_PIANO  AND UNITA_IMMOBILIARI.id=" & par.IfNull(myReader2("id"), -1)
                    Dim myReader3 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader3.Read Then
                        '& "<span style='font-size: 8pt; font-family: Arial'>" & "<a href='DettagliUnita.aspx?IDC=" & lIdContratto & "&ID=" & myReader3("cod_unita_immobiliare") & "' target='_blank'>" & par.IfNull(myReader3("cod_unita_immobiliare"), "") & "</a>" & "</span></td>" _

                        testoTabella = testoTabella _
                                    & "<tr>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><a href='#' onclick=" & Chr(34) & "if (document.getElementById('txtModificato').value == '1') {alert('Attenzione...Sono state apportate delle modifiche. Salvare prima di proseguire!');}else {document.getElementById('USCITA').value='1';window.open('../CENSIMENTO/InserimentoUniImmob.aspx?F=" & lIdConnessione & "&X=1&LE=1&ID=" & par.IfNull(myReader3("cod_unita_immobiliare"), "") & "','Dettagli','height=580,top=0,left=0,width=780');}" & Chr(34) & ">" & par.IfNull(myReader3("cod_unita_immobiliare"), "") & "</a></span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader3("FOGLIO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader3("NUMERO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader3("SUB"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader3("TIPO_ALLOGGIO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader3("INDIRIZZO"), "") & "," & par.IfNull(myReader3("CIVICO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader3("PIANO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader3("SCALA"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader3("INTERNO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "</td>" _
                                    & "<td style='height: 19px'>" _
                                    & "</td>" _
                                    & "</tr>"
                    End If
                    myReader3.Close()
                Loop
                myReader2.Close()

                CType(Tab_UnitaImmLocate1.FindControl("TBL_PERTINENZE_ALLOCATE"), Label).Text = testoTabella & "</table>"

            Else
                Response.Write("<script>alert('Attenzione, si è verificato un errore durante il caricamento dei dati dell\'unita!');</script>")
            End If






            'CARICO ALCUNI DATI GENERALI
            CType(Generale1.FindControl("lblStato"), Label).Text = "BOZZA"
            LBLSTATOC.Visible = True
            LBLSTATOC.Text = "Stato: BOZZA"

            CType(Generale1.FindControl("lblDecorrenza"), Label).Text = ""
            CType(Generale1.FindControl("lblScadenza"), Label).Text = ""
            CType(Generale1.FindControl("lblDisdetta"), Label).Text = ""

            CType(Generale1.FindControl("lblCodiceGimi"), Label).Text = ""


            CType(Generale1.FindControl("Label20"), Label).Text = ""
            CType(Generale1.FindControl("lblSaldoAttuale"), Label).Text = ""

            'TAB CONTRATTO

            CType(Tab_Contratto1.FindControl("txtCodContratto"), TextBox).Text = CodContratto
            CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text = ""
            CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Text = ""
            CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Text = ""
            CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text = ""
            CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text = ""
            CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Text = ""
            CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).Text = ""
            CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Text = ""
            CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).Text = ""
            'CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text = ""
            'CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Text = ""
            CType(Tab_Contratto1.FindControl("txtDataConsegna"), TextBox).Text = ""
            CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text = ""
            CType(Tab_Contratto1.FindControl("txtDataDisdetta0"), TextBox).Text = ""
            CType(Tab_Contratto1.FindControl("txtNotificaDisdetta"), TextBox).Text = ""

            CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Text = ""
            'CType(Tab_Contratto1.FindControl("txtNote"), TextBox).Text = ""
            CType(Tab_Contratto1.FindControl("txtEntroCuiDisdettare"), TextBox).Text = ""


            Select Case TipoContratto
                Case "1", "2", "10", "11", "12" 'erp
                    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedIndex = -1
                    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).Items.FindByValue("ERP").Selected = True
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE COD='ERP'"
                    CType(Generale1.FindControl("lblTipologia"), Label).Text = "ERP"

                Case "3" 'usi diversi
                    'non so come fare, poi si pensa

                    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedIndex = -1
                    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).Items.FindByValue("USD").Selected = True
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE COD='USD'"
                    CType(Generale1.FindControl("lblTipologia"), Label).Text = "Usi diversi"
                    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).Enabled = True

                Case "5" '392/78
                    'non so come fare, poi si pensa

                    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedIndex = -1
                    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).Items.FindByValue("EQC392").Selected = True
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE COD='EQC392'"
                    CType(Generale1.FindControl("lblTipologia"), Label).Text = "Equo canone 392/78"
                    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).Enabled = True

                Case "6" '431/98
                    'non so come fare, poi si pensa

                    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedIndex = -1
                    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).Items.FindByValue("L43198").Selected = True
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE COD='L43198'"
                    CType(Generale1.FindControl("lblTipologia"), Label).Text = "Legge 431/98"
                    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).Enabled = True
                Case "7" 'ABUSIVI
                    'non so come fare, poi si pensa

                    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedIndex = -1
                    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).Items.FindByValue("NONE").Selected = True
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE COD='NONE'"
                    CType(Generale1.FindControl("lblTipologia"), Label).Text = ""
                    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).Enabled = True
            End Select


            CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).ReadOnly = False
            CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).ReadOnly = False


            Dim myReaderB As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderB.Read() Then
                CType(Tab_Contratto1.FindControl("txtRifLegislativo"), TextBox).Text = UCase(par.IfNull(myReaderB("RIF_LEGISLATIVO"), ""))
                CType(Tab_Contratto1.FindControl("txtDescrcontratto"), TextBox).Text = UCase(par.IfNull(myReaderB("DESCRIZIONE"), ""))

                CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).Text = UCase(par.IfNull(myReaderB("DURATA"), ""))
                CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).Text = UCase(par.IfNull(myReaderB("DURATA2"), ""))

                If TipoContratto = "1" Then

                    par.cmd.CommandText = "select tipo from bandi_graduatoria_DEF where id_domanda=" & lIdDomandaERP
                    Dim myReaderXX As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderXX.Read Then
                        If myReaderXX(0) = "2" Then
                            CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).Text = "2"
                            CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).Text = "0"

                        End If
                    End If
                    myReaderXX.Close()
                End If

                If LetteraProvenienza = "D" Or LetteraProvenienza = "V" Then
                    CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).Text = "2"
                    CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).Text = "0"
                End If

                CType(Generale1.FindControl("lblTipologia"), Label).Text = UCase(par.IfNull(myReaderB("DESCRIZIONE"), ""))

                If TipoContratto <> "7" Then
                    CType(Tab_Registrazione1.FindControl("txtPercTotSu"), Label).Text = par.IfNull(myReaderB("perc_tr_canone"), "0")
                    CType(Tab_Registrazione1.FindControl("txtPercConduttore"), Label).Text = par.IfNull(myReaderB("perc_conduttore"), "0")
                    CType(Tab_Registrazione1.FindControl("txtPercLocatore"), Label).Text = 100 - par.IfNull(myReaderB("perc_conduttore"), "0")
                Else
                    CType(Tab_Registrazione1.FindControl("txtPercTotSu"), Label).Text = "0"
                    CType(Tab_Registrazione1.FindControl("txtPercConduttore"), Label).Text = "0"
                    CType(Tab_Registrazione1.FindControl("txtPercLocatore"), Label).Text = "0"

                End If

            End If
            myReaderB.Close()

            Dim CONDUTTORE As String = ""
            Dim Conduttore1 As String = ""

            Dim codFiscaleIntest As String = ""

            'RIPORTO INTESTATARIO
            If TipoContratto = "1" Or LetteraProvenienza = "D" Or LetteraProvenienza = "V" Then
                par.cmd.CommandText = "SELECT TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",COMP_NUCLEO.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO,DOMANDE_BANDO WHERE TIPOLOGIA_PARENTELA.ID_SEPA (+)=COMP_NUCLEO.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND DOMANDE_BANDO.ID=" & lIdDomandaERP & " AND COMP_NUCLEO.ID_DICHIARAZIONE=DOMANDE_BANDO.ID_DICHIARAZIONE AND COMP_NUCLEO.PROGR=0"
                myReaderB = par.cmd.ExecuteReader()
                Do While myReaderB.Read
                    CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("COD_FISCALE"), ""), 16) & " " & UCase(par.IfNull(myReaderB("PARENTE"), "CAPOFAMIGLIA")), -1 * myReaderB("ID")))
                    CONDUTTORE = CONDUTTORE & par.IfNull(myReaderB("COGNOME"), "") & " " & par.IfNull(myReaderB("NOME"), "") & " "
                    codFiscaleIntest = par.IfNull(myReaderB("cod_fiscale"), "")
                Loop
                myReaderB.Close()
            End If

            If TipoContratto = "11" Then
                par.cmd.CommandText = "SELECT TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",COMP_NUCLEO_VSA.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO_VSA,DOMANDE_BANDO_VSA WHERE TIPOLOGIA_PARENTELA.ID_SEPA (+)=COMP_NUCLEO_VSA.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND DOMANDE_BANDO_VSA.ID=" & lIdDomandaERP & " AND COMP_NUCLEO_VSA.ID_DICHIARAZIONE=DOMANDE_BANDO_VSA.ID_DICHIARAZIONE AND COMP_NUCLEO_VSA.PROGR=0"
                myReaderB = par.cmd.ExecuteReader()
                Do While myReaderB.Read
                    CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("COD_FISCALE"), ""), 16) & " " & UCase(par.IfNull(myReaderB("PARENTE"), "CAPOFAMIGLIA")), -1 * myReaderB("ID")))
                    CONDUTTORE = CONDUTTORE & par.IfNull(myReaderB("COGNOME"), "") & " " & par.IfNull(myReaderB("NOME"), "") & " "
                    codFiscaleIntest = par.IfNull(myReaderB("cod_fiscale"), "")
                    'Conduttore1 = Conduttore1 & "<a href=" & Chr(34) & "anagrafica/Inserimento.aspx?ID=" & par.IfNull(myReader1("id"), "-1") & Chr(34) & " target=" & Chr(34) & "_blank" & Chr(34) & ">" & par.IfNull(myReader1("INTESTATARIO"), "") & "</a>, "
                Loop
                myReaderB.Close()
            Else
                If par.IfEmpty(CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedValue, "-1") = 1 Or aggRedd = 1 Then
                    par.cmd.CommandText = "SELECT TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",COMP_NUCLEO_VSA.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO_VSA,DOMANDE_BANDO_VSA WHERE TIPOLOGIA_PARENTELA.ID_SEPA (+)=COMP_NUCLEO_VSA.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND DOMANDE_BANDO_VSA.ID=" & lIdDomandaERP & " AND COMP_NUCLEO_VSA.ID_DICHIARAZIONE=DOMANDE_BANDO_VSA.ID_DICHIARAZIONE AND COMP_NUCLEO_VSA.PROGR=0"
                    myReaderB = par.cmd.ExecuteReader()
                    Do While myReaderB.Read
                        CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("COD_FISCALE"), ""), 16) & " " & UCase(par.IfNull(myReaderB("PARENTE"), "CAPOFAMIGLIA")), -1 * myReaderB("ID")))
                        CONDUTTORE = CONDUTTORE & par.IfNull(myReaderB("COGNOME"), "") & " " & par.IfNull(myReaderB("NOME"), "") & " "
                        codFiscaleIntest = par.IfNull(myReaderB("cod_fiscale"), "")
                    Loop
                    myReaderB.Close()
                End If
            End If

            If TipoContratto = "10" Then
                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where PROVENIENZA='Z' and id_unita=" & Request.QueryString("IdUnita") & " and id_dichiarazione=" & lIdDichiarazione
                myReaderB = par.cmd.ExecuteReader()
                If myReaderB.Read Then
                    CanoneCorrente = par.IfNull(myReaderB("CANONE"), "0,00")
                    CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME_RS"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("CF_PIVA"), ""), 16) & " " & "CAPOFAMIGLIA", -1))
                    CONDUTTORE = CONDUTTORE & par.IfNull(myReaderB("COGNOME_RS"), "") & " " & par.IfNull(myReaderB("NOME"), "") & " "
                    codFiscaleIntest = par.IfNull(myReaderB("CF_PIVA"), "")
                End If
                myReaderB.Close()
            End If


            If TipoContratto = "2" Then
                par.cmd.CommandText = "SELECT TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",COMP_NUCLEO_CAMBI.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO_CAMBI,DOMANDE_BANDO_CAMBI WHERE TIPOLOGIA_PARENTELA.ID_SEPA (+)=COMP_NUCLEO_CAMBI.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND DOMANDE_BANDO_CAMBI.ID=" & lIdDomandaERP & " AND COMP_NUCLEO_CAMBI.ID_DICHIARAZIONE=DOMANDE_BANDO_CAMBI.ID_DICHIARAZIONE AND COMP_NUCLEO_CAMBI.PROGR=0"
                myReaderB = par.cmd.ExecuteReader()
                Do While myReaderB.Read
                    CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("COD_FISCALE"), ""), 16) & " " & UCase(par.IfNull(myReaderB("PARENTE"), "CAPOFAMIGLIA")), -1 * myReaderB("ID")))
                    CONDUTTORE = CONDUTTORE & par.IfNull(myReaderB("COGNOME"), "") & " " & par.IfNull(myReaderB("NOME"), "") & " "
                    codFiscaleIntest = par.IfNull(myReaderB("COD_FISCALE"), "")

                Loop
                myReaderB.Close()
            End If

            If TipoContratto = "3" Then
                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where generato_contratto='0' and (PROVENIENZA='U' or PROVENIENZA='H') and id_unita=" & Request.QueryString("IdUnita")
                myReaderB = par.cmd.ExecuteReader()
                If myReaderB.Read Then
                    CanoneCorrente = par.IfNull(myReaderB("CANONE"), "0,00")
                    CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME_RS"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("CF_PIVA"), ""), 16) & " " & "NON ATTRIBUIBILE", -1 * myReaderB("ID_ANAGRAFICA")))
                    CONDUTTORE = CONDUTTORE & par.IfNull(myReaderB("COGNOME_RS"), "") & " " & par.IfNull(myReaderB("NOME"), "") & " "
                    codFiscaleIntest = par.IfNull(myReaderB("CF_PIVA"), "")

                End If
                myReaderB.Close()
            End If

            If TipoContratto = "5" Then
                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where generato_contratto='0' and PROVENIENZA='Q' and id_unita=" & Request.QueryString("IdUnita")
                myReaderB = par.cmd.ExecuteReader()
                If myReaderB.Read Then
                    CanoneCorrente = par.IfNull(myReaderB("CANONE"), "0,00")
                    CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME_RS"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("CF_PIVA"), ""), 16) & " " & "NON ATTRIBUIBILE", -1 * myReaderB("ID_ANAGRAFICA")))
                    CONDUTTORE = CONDUTTORE & par.IfNull(myReaderB("COGNOME_RS"), "") & " " & par.IfNull(myReaderB("NOME"), "") & " "
                    codFiscaleIntest = par.IfNull(myReaderB("CF_PIVA"), "")

                End If
                myReaderB.Close()
            End If

            '*** 29/04/2015 Cerco Intestatario da Assegnazione Fuori MILANO
            If LetteraProvenienza = "FM" Then
                par.cmd.CommandText = "SELECT TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",COMP_NUCLEO_VSA.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO_VSA WHERE TIPOLOGIA_PARENTELA.ID_SEPA (+)=COMP_NUCLEO_VSA.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND comp_nucleo_VSA.ID_dichiarazione=" & lIdDichiarazione & " AND COMP_NUCLEO_VSA.PROGR=0 order by progr asc"
                myReaderB = par.cmd.ExecuteReader()
                If myReaderB.Read Then
                    CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("COD_FISCALE"), ""), 16) & " " & UCase(par.IfNull(myReaderB("PARENTE"), "CAPOFAMIGLIA")), -1 * myReaderB("ID")))
                    CONDUTTORE = CONDUTTORE & par.IfNull(myReaderB("COGNOME"), "") & " " & par.IfNull(myReaderB("NOME"), "") & " "
                    codFiscaleIntest = par.IfNull(myReaderB("cod_Fiscale"), "")
                End If
                myReaderB.Close()
            End If
            '*** 29/04/2015 FINE Cerco Intestatario da Assegnazione Fuori MILANO

            If TipoContratto = "6" Then
                Select Case LetteraProvenienza
                    Case "D"
                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where generato_contratto='0' and (PROVENIENZA='D' ) and id_unita=" & Request.QueryString("IdUnita")
                        myReaderB = par.cmd.ExecuteReader()
                        If myReaderB.Read Then
                            CanoneCorrente = par.IfNull(myReaderB("CANONE"), "0,00")
                            codFiscaleIntest = par.IfNull(myReaderB("CF_PIVA"), "")
                        End If
                        myReaderB.Close()
                    Case "V"
                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where generato_contratto='0' and (PROVENIENZA='V' ) and id_unita=" & Request.QueryString("IdUnita")
                        myReaderB = par.cmd.ExecuteReader()
                        If myReaderB.Read Then
                            CanoneCorrente = par.IfNull(myReaderB("CANONE"), "0,00")
                            codFiscaleIntest = par.IfNull(myReaderB("CF_PIVA"), "")
                        End If
                        myReaderB.Close()
                    Case Else
                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where generato_contratto='0' and (PROVENIENZA='W' ) and id_unita=" & Request.QueryString("IdUnita")
                        myReaderB = par.cmd.ExecuteReader()
                        If myReaderB.Read Then
                            CanoneCorrente = par.IfNull(myReaderB("CANONE"), "0,00")
                            CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME_RS"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("CF_PIVA"), ""), 16) & " " & "NON ATTRIBUIBILE", -1 * myReaderB("ID_ANAGRAFICA")))
                            CONDUTTORE = CONDUTTORE & par.IfNull(myReaderB("COGNOME_RS"), "") & " " & par.IfNull(myReaderB("NOME"), "") & " "
                            codFiscaleIntest = par.IfNull(myReaderB("CF_PIVA"), "")

                        End If
                        myReaderB.Close()
                End Select
            End If

            If TipoContratto = "7" Then
                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where generato_contratto='0' and  PROVENIENZA='X' and id_unita=" & Request.QueryString("IdUnita")
                myReaderB = par.cmd.ExecuteReader()
                If myReaderB.Read Then
                    CanoneCorrente = par.IfNull(myReaderB("CANONE"), "0,00")
                    CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME_RS"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("CF_PIVA"), ""), 16) & " " & "CAPOFAMIGLIA", -1 * myReaderB("ID_ANAGRAFICA")))
                    CONDUTTORE = CONDUTTORE & par.IfNull(myReaderB("COGNOME_RS"), "") & " " & par.IfNull(myReaderB("NOME"), "") & " "
                    codFiscaleIntest = par.IfNull(myReaderB("CF_PIVA"), "")

                    CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Text = "ABUSIVO"
                    CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Enabled = False

                    CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text = par.FormattaData(par.IfNull(myReaderB("data_assegnazione"), ""))
                    CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Text = par.FormattaData(par.IfNull(myReaderB("data_assegnazione"), ""))
                    CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text = par.FormattaData(par.IfNull(myReaderB("data_assegnazione"), ""))
                    CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Text = par.FormattaData(par.IfNull(myReaderB("data_assegnazione"), ""))
                    CType(Tab_Contratto1.FindControl("txtDataConsegna"), TextBox).Text = par.FormattaData(par.IfNull(myReaderB("data_assegnazione"), ""))
                    CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text = "31/12/2999"
                    CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Text = "31/12/2999"

                    DataScadCont.Value = "31/12/2999"
                    DataScadRinn.Value = "31/12/2999"

                    CType(Tab_Contratto1.FindControl("txtEntroCuiDisdettare"), TextBox).Text = "0"

                    par.cmd.CommandText = "update siscom_mi.unita_immobiliari set cod_tipo_disponibilita='OCCU' where id=" & Request.QueryString("IdUnita")
                    par.cmd.ExecuteNonQuery()
                End If
                myReaderB.Close()
            End If

            If TipoContratto = "12" Then
                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where generato_contratto='0' and  PROVENIENZA='A' and id_unita=" & Request.QueryString("IdUnita")
                myReaderB = par.cmd.ExecuteReader()
                If myReaderB.Read Then
                    CanoneCorrente = par.IfNull(myReaderB("CANONE"), "0,00")
                    CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME_RS"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("CF_PIVA"), ""), 16) & " " & "NON ATTRIBUIBILE", -1 * myReaderB("ID_ANAGRAFICA")))
                    CONDUTTORE = CONDUTTORE & par.IfNull(myReaderB("COGNOME_RS"), "") & " " & par.IfNull(myReaderB("NOME"), "") & " "
                    codFiscaleIntest = par.IfNull(myReaderB("CF_PIVA"), "")
                End If
                myReaderB.Close()
            End If

            CType(Generale1.FindControl("lblConduttore"), Label).Text = CONDUTTORE

            If CONDUTTORE = "" Then

            End If


            'RIPORTO COMPONENTI

            If TipoContratto = "1" Or LetteraProvenienza = "D" Or LetteraProvenienza = "V" Then
                par.cmd.CommandText = "SELECT TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",COMP_NUCLEO.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO,DOMANDE_BANDO WHERE TIPOLOGIA_PARENTELA.ID_SEPA (+)=COMP_NUCLEO.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND DOMANDE_BANDO.ID=" & lIdDomandaERP & " AND COMP_NUCLEO.ID_DICHIARAZIONE=DOMANDE_BANDO.ID_DICHIARAZIONE AND COMP_NUCLEO.PROGR<>0"
                myReaderB = par.cmd.ExecuteReader()
                Do While myReaderB.Read
                    CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("COD_FISCALE"), ""), 16) & " " & UCase(par.IfNull(myReaderB("PARENTE"), "CAPOFAMIGLIA")), -1 * myReaderB("ID")))
                Loop
                myReaderB.Close()
            End If

            If TipoContratto = "11" Then
                par.cmd.CommandText = "SELECT TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",COMP_NUCLEO_VSA.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO_VSA,DOMANDE_BANDO_VSA WHERE TIPOLOGIA_PARENTELA.ID_SEPA (+)=COMP_NUCLEO_VSA.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND DOMANDE_BANDO_VSA.ID=" & lIdDomandaERP & " AND COMP_NUCLEO_VSA.ID_DICHIARAZIONE=DOMANDE_BANDO_VSA.ID_DICHIARAZIONE AND COMP_NUCLEO_VSA.PROGR<>0"
                myReaderB = par.cmd.ExecuteReader()
                Do While myReaderB.Read
                    CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("COD_FISCALE"), ""), 16) & " " & UCase(par.IfNull(myReaderB("PARENTE"), "CAPOFAMIGLIA")), -1 * myReaderB("ID")))
                Loop
                myReaderB.Close()
            Else
                If par.IfEmpty(CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedValue, "-1") = 1 Or aggRedd = 1 Then
                    par.cmd.CommandText = "SELECT TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",COMP_NUCLEO_VSA.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO_VSA,DOMANDE_BANDO_VSA WHERE TIPOLOGIA_PARENTELA.ID_SEPA (+)=COMP_NUCLEO_VSA.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND DOMANDE_BANDO_VSA.ID=" & lIdDomandaERP & " AND COMP_NUCLEO_VSA.ID_DICHIARAZIONE=DOMANDE_BANDO_VSA.ID_DICHIARAZIONE AND COMP_NUCLEO_VSA.PROGR<>0"
                    myReaderB = par.cmd.ExecuteReader()
                    Do While myReaderB.Read
                        CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("COD_FISCALE"), ""), 16) & " " & UCase(par.IfNull(myReaderB("PARENTE"), "CAPOFAMIGLIA")), -1 * myReaderB("ID")))
                    Loop
                    myReaderB.Close()
                End If
            End If


            If TipoContratto = "10" Then
                par.cmd.CommandText = "SELECT TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",COMP_NUCLEO_VSA.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO_VSA WHERE TIPOLOGIA_PARENTELA.ID_SEPA (+)=COMP_NUCLEO_VSA.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND comp_nucleo_VSA.ID_dichiarazione=" & lIdDichiarazione & " AND COMP_NUCLEO_VSA.PROGR<>0 order by progr asc"
                myReaderB = par.cmd.ExecuteReader()
                Do While myReaderB.Read
                    CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("COD_FISCALE"), ""), 16) & " " & UCase(par.IfNull(myReaderB("PARENTE"), "CAPOFAMIGLIA")), -1 * myReaderB("ID")))
                Loop
                myReaderB.Close()
                Response.Write("<script>alert('Attenzione, i dati anagrafici relativi al conduttore potrebbero non essere completi. Dopo aver Salvato, fare click sul nome del conduttore, nel tab GENERALE, per inserire le eventuali informazioni mancanti!');</script>")
            End If

            '*** 29/04/2015 Cerco Componenti da Assegnazione Fuori MILANO
            If LetteraProvenienza = "FM" Then
                par.cmd.CommandText = "SELECT TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",COMP_NUCLEO_VSA.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO_VSA WHERE TIPOLOGIA_PARENTELA.ID_SEPA (+)=COMP_NUCLEO_VSA.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND comp_nucleo_VSA.ID_dichiarazione=" & lIdDichiarazione & " AND COMP_NUCLEO_VSA.PROGR<>0 order by progr asc"
                myReaderB = par.cmd.ExecuteReader()
                Do While myReaderB.Read
                    CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("COD_FISCALE"), ""), 16) & " " & UCase(par.IfNull(myReaderB("PARENTE"), "CAPOFAMIGLIA")), -1 * myReaderB("ID")))
                Loop
                myReaderB.Close()
            End If
            '*** 29/04/2015 FINE Cerco Componenti da Assegnazione Fuori MILANO


            If TipoContratto = "2" Then
                par.cmd.CommandText = "SELECT TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",COMP_NUCLEO_CAMBI.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO_CAMBI,DOMANDE_BANDO_CAMBI WHERE TIPOLOGIA_PARENTELA.ID_SEPA (+)=COMP_NUCLEO_CAMBI.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND DOMANDE_BANDO_CAMBI.ID=" & lIdDomandaERP & " AND COMP_NUCLEO_CAMBI.ID_DICHIARAZIONE=DOMANDE_BANDO_CAMBI.ID_DICHIARAZIONE AND COMP_NUCLEO_CAMBI.PROGR<>0"
                myReaderB = par.cmd.ExecuteReader()
                Do While myReaderB.Read
                    CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderB("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReaderB("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReaderB("COD_FISCALE"), ""), 16) & " " & UCase(par.IfNull(myReaderB("PARENTE"), "CAPOFAMIGLIA")), -1 * myReaderB("ID")))
                Loop
                myReaderB.Close()
            End If

            'CARICO TAB COMUNICAZIONI
            'IMPOSTO L'INDIRIZZO DELL'UNITA ASSEGNATA

            Dim TipoIndirizzo As String
            CType(Tab_Comunicazioni1.FindControl("cmbTipoViaCor"), DropDownList).SelectedIndex = -1
            TipoIndirizzo = Trim(RicavaVia1(par.IfNull(myReader("INDIRIZZO"), "VIA")))
            CType(Tab_Comunicazioni1.FindControl("cmbTipoViaCor"), DropDownList).Items.FindByText(TipoIndirizzo).Selected = True



            CType(Tab_Comunicazioni1.FindControl("txtPresso"), TextBox).Text = par.IfEmpty(CONDUTTORE, "?")
            CType(Tab_Comunicazioni1.FindControl("txtViaCor"), TextBox).Text = RicavaInd(par.IfNull(myReader("INDIRIZZO"), ""), TipoIndirizzo)
            CType(Tab_Comunicazioni1.FindControl("txtCivicoCor"), TextBox).Text = par.IfNull(myReader("CIVICO"), "")
            CType(Tab_Comunicazioni1.FindControl("txtCAPCOR"), TextBox).Text = par.IfNull(myReader("CAP"), "")
            CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text = par.IfNull(myReader("COMUNE_DI"), "")
            CType(Tab_Comunicazioni1.FindControl("txtSiglaCor"), TextBox).Text = par.IfNull(myReader("PROVINCIA"), "")
            'max 23/01/2018
            CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Text = ""
            CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Text = ""

            'CARICAMENTO TAB REGISTRAZIONE
            CType(Tab_Registrazione1.FindControl("cmbUfficioRegistro"), DropDownList).SelectedIndex = -1
            CType(Tab_Registrazione1.FindControl("cmbUfficioRegistro"), DropDownList).Items.FindByValue(-1).Selected = True

            CType(Tab_Registrazione1.FindControl("txtSerie"), TextBox).Text = ""
            CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Text = ""
            CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Text = ""
            CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).Text = ""
            CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Text = ""
            CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Text = ""
            CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Text = ""
            CType(Tab_Registrazione1.FindControl("txtNotereg"), TextBox).Text = ""

            CType(Tab_Registrazione1.FindControl("cmbUfficioRegistro"), DropDownList).Enabled = False



            'CARICAMENTO TAB CANONE

            CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text = ""
            CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Text = ""
            CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text = ""
            CType(Tab_Canone1.FindControl("txtLibrettoDeposito"), TextBox).Text = ""

            CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedIndex = -1
            CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).Items.FindByValue(12).Selected = True

            CType(Tab_Canone1.FindControl("cmbDestRate"), DropDownList).SelectedIndex = -1
            CType(Tab_Canone1.FindControl("cmbDestRate"), DropDownList).Items.FindByValue(1).Selected = True

            Dim fileName As String = CodContratto & ".txt"
            If TipoContratto <> "3" And TipoContratto <> "5" And TipoContratto <> "6" And TipoContratto <> "7" And LetteraERP <> "B" And TipoContratto <> "10" And TipoContratto <> "12" And LetteraProvenienza <> "FM" Then
                '---- CALCOLO CANONE 27 ----------
                'CANCELLO TUTTI GLI EVENTUALI FILE DI QUESTO CONTRATTO
                'CHE NON SERVONO PIU ORMAI

                If System.IO.File.Exists(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CodContratto & ".txt")) = True Then
                    fileName = CodContratto & "_" & Format(Now, "yyyyMMddHHmmss") & ".txt"
                End If

                'System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CodContratto & ".txt"))
                Dim comunicazioni As String = ""
                Dim s As String

                If par.IfEmpty(CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedValue, "-1") = 1 Or aggRedd = 1 Then
                    If lIdDomandaERP <> "-1" Then
                        s = par.CalcolaCanone27(lIdDomandaERP, 3, UnitaContratto, CodContratto, CanoneCorrente, VAL_LOCATIVO_UNITA, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPiano, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL)
                    Else
                        If lIdDichiarazione <> "-1" Then
                            s = par.CalcolaCanone27(lIdDichiarazione, 4, UnitaContratto, CodContratto, CanoneCorrente, VAL_LOCATIVO_UNITA, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPiano, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL)
                        End If
                    End If

                Else
                    If lIdDomandaERP <> "-1" Then
                        s = par.CalcolaCanone27(lIdDomandaERP, TipoContratto, UnitaContratto, CodContratto, CanoneCorrente, VAL_LOCATIVO_UNITA, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPiano, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL)
                    Else
                        s = par.CalcolaCanone27(lIdDichiarazione, 4, UnitaContratto, CodContratto, CanoneCorrente, VAL_LOCATIVO_UNITA, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPiano, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL)
                    End If

                End If
                If comunicazioni <> "" Then
                    Response.Write("<script>alert('" & comunicazioni & "');</script>")
                End If

                Dim sr As StreamWriter = New StreamWriter(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, False, System.Text.Encoding.Default)
                sr.WriteLine(s)
                sr.Close()

                LBLNOMEFILECANONE.Value = Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName

                'CType(Tab_Canone1.FindControl("ImgRicalcolaC"), ImageButton).Visible = True

            Else
                If TipoContratto = "7" Then
                    CType(Tab_Canone1.FindControl("ImgRicalcolaC"), ImageButton).Visible = False

                    'System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CodContratto & ".txt"))
                    Dim comunicazioni As String = ""
                    Dim s As String

                    s = par.CalcolaCanone27Abusivi(-1, -1, UnitaContratto, CodContratto, CanoneCorrente, VAL_LOCATIVO_UNITA, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPiano, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL)

                    If comunicazioni <> "" Then
                        Response.Write("<script>alert('" & comunicazioni & "');</script>")
                    End If

                    If System.IO.File.Exists(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CodContratto & ".txt")) = True Then
                        fileName = CodContratto & "_" & Format(Now, "yyyyMMddHHmmss") & ".txt"
                    End If

                    Dim sr As StreamWriter = New StreamWriter(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, False, System.Text.Encoding.Default)
                    sr.WriteLine(s)
                    sr.Close()

                    LBLNOMEFILECANONE.Value = Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName

                    Dim testoTabella As String = ""

                    testoTabella = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                                    & "<tr>" _
                                    & "<td style='height: 15px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><strong>DATA CALCOLO</strong></span></td>" _
                                    & "<td style='height: 15px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><strong>AREA ECONOMICA</strong></span></td>" _
                                    & "<td style='height: 15px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><strong>CLASSE</strong></span></td>" _
                                    & "<td style='height: 15px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><strong>DATA VALIDITA'</strong></span></td>" _
                                    & "<td style='height: 15px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><strong>CANONE</strong></span></td>" _
                                    & "<td style='height: 15px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><strong>ORIGINE</strong></span></td>" _
                                    & "<td style='height: 15px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><strong></strong></span></td>" _
                                    & "</tr>"


                    testoTabella = testoTabella _
                            & "<tr>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & Format(Now, "dd/MM/yyyy") & "</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.RicavaAreaEconomica(AreaEconomica) & "</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & sSOTTOAREA & "</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text & "</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & Format(CanoneCorrente, "0.00") & "</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>CONTRATTO</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & "<a href='#' onclick=" & Chr(34) & "alert('Salvare il contratto per visualizzare la maschera!');" & Chr(34) & ">Visualizza Dettagli</span></td>" _
                            & "</tr>"


                    CType(Tab_Canone1.FindControl("lblDettaglioCanoni"), Label).Text = testoTabella & "</table>"
                End If

                If TipoContratto = "10" Or LetteraProvenienza = "FM" Then
                    If TIPO_CANONE_APPLICATO = "L. 27/2007" Then
                        CType(Tab_Canone1.FindControl("label4"), Label).Text = "E' STATO APPLICATO IL CANONE " & TIPO_CANONE_APPLICATO & ", IL CANONE ALTERNATIVO SAREBBE STATO PARI A EURO " & CANONE_ALTERNATIVO
                        CType(Tab_Canone1.FindControl("ImgRicalcolaC"), ImageButton).Visible = False

                        'System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CodContratto & ".txt"))
                        Dim comunicazioni As String = ""
                        Dim s As String

                        s = par.CalcolaCanone27(lIdDichiarazione, 4, UnitaContratto, CodContratto, CanoneCorrente, VAL_LOCATIVO_UNITA, comunicazioni, AreaEconomica, sISEE, sISE, sISR, sISP, sVSE, sREDD_DIP, sREDD_ALT, sLimitePensione, sPER_VAL_LOC, sPERC_INC_MAX_ISE_ERP, sCANONE_MIN, sISE_MIN, sCanone, sNOTE, sDEM, sSUPCONVENZIONALE, sCOSTOBASE, sZONA, sPiano, sCONSERVAZIONE, sVETUSTA, sPSE, sINCIDENZAISE, sCOEFFFAM, sSOTTOAREA, sMOTIVODECADENZA, sNUMCOMP, sNUMCOMP66, sNUMCOMP100, sNUMCOMP100C, sPREVDIP, sDETRAZIONI, sMOBILIARI, sIMMOBILIARI, sCOMPLESSIVO, sDETRAZIONEF, sANNOCOSTRUZIONE, sLOCALITA, sASCENSORE, sDESCRIZIONEPIANO, sSUPNETTA, sALTRESUP, sMINORI15, sMAGGIORI65, sSUPACCESSORI, sVALORELOCATIVO, sCANONECLASSE, sCANONESOPP, sVALOCIICI, sALLOGGIOIDONEO, sISTAT, sCANONECLASSEISTAT, sANNOINIZIOVAL, sANNOFINEVAL)

                        If comunicazioni <> "" Then
                            Response.Write("<script>alert('" & comunicazioni & "');</script>")
                        End If

                        If System.IO.File.Exists(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CodContratto & ".txt")) = True Then
                            fileName = CodContratto & "_" & Format(Now, "yyyyMMddHHmmss") & ".txt"
                        End If

                        Dim sr As StreamWriter = New StreamWriter(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName, False, System.Text.Encoding.Default)
                        sr.WriteLine(s)
                        sr.Close()




                        LBLNOMEFILECANONE.Value = Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & fileName

                        Dim testoTabella As String = ""

                        testoTabella = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                                        & "<tr>" _
                                        & "<td style='height: 15px'>" _
                                        & "<span style='font-size: 8pt; font-family: Arial'><strong>DATA CALCOLO</strong></span></td>" _
                                        & "<td style='height: 15px'>" _
                                        & "<span style='font-size: 8pt; font-family: Arial'><strong>AREA ECONOMICA</strong></span></td>" _
                                        & "<td style='height: 15px'>" _
                                        & "<span style='font-size: 8pt; font-family: Arial'><strong>CLASSE</strong></span></td>" _
                                        & "<td style='height: 15px'>" _
                                        & "<span style='font-size: 8pt; font-family: Arial'><strong>DATA VALIDITA'</strong></span></td>" _
                                        & "<td style='height: 15px'>" _
                                        & "<span style='font-size: 8pt; font-family: Arial'><strong>CANONE</strong></span></td>" _
                                        & "<td style='height: 15px'>" _
                                        & "<span style='font-size: 8pt; font-family: Arial'><strong>ORIGINE</strong></span></td>" _
                                        & "<td style='height: 15px'>" _
                                        & "<span style='font-size: 8pt; font-family: Arial'><strong></strong></span></td>" _
                                        & "</tr>"


                        testoTabella = testoTabella _
                            & "<tr>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & Format(Now, "dd/MM/yyyy") & "</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.RicavaAreaEconomica(AreaEconomica) & "</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & sSOTTOAREA & "</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'></span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & Format(CanoneCorrente, "0.00") & "</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>CONTRATTO</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & "<a href='#' onclick=" & Chr(34) & "alert('Salvare il contratto per visualizzare la maschera!');" & Chr(34) & ">Visualizza Dettagli</span></td>" _
                            & "</tr>"



                        'RicavaTestoAreaEconomica

                        CType(Tab_Canone1.FindControl("lblDettaglioCanoni"), Label).Text = testoTabella & "</table>"

                    Else
                        CType(Tab_Canone1.FindControl("label4"), Label).Text = "E' STATO APPLICATO IL CANONE " & TIPO_CANONE_APPLICATO & ", IL CANONE ALTERNATIVO SAREBBE STATO PARI A EURO " & CANONE_ALTERNATIVO
                        CType(Tab_Canone1.FindControl("ImgRicalcolaC"), ImageButton).Visible = False
                    End If

                Else
                    CType(Tab_Canone1.FindControl("label4"), Label).Visible = False
                    CType(Tab_Canone1.FindControl("ImgRicalcolaC"), ImageButton).Visible = False

                End If
                myReader.Close()


            End If

            If LetteraERP = "B" Then
                CanoneCorrente = canonedaassegnare
                LBLErpModerato.Visible = True
            End If

            Dim MESI_ANTICIPO As Integer = 0

            par.cmd.CommandText = "SELECT VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=16"
            myReaderB = par.cmd.ExecuteReader()
            If myReaderB.Read Then
                MESI_ANTICIPO = par.IfNull(myReaderB("VALORE"), 0)
            End If
            myReaderB.Close()

            CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text = Format(CanoneCorrente, "0.00")
            CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Text = Format(CanoneCorrente, "0.00")
            If TipoContratto <> "7" Then
                CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text = Format(Format((CanoneCorrente / 12), "0.00") * 3, "0.00")
                CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text = Format(Format((CanoneCorrente / 12), "0.00") * MESI_ANTICIPO, "0.00")

            Else
                CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text = "0,00"
                CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text = "0,00"
                CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Enabled = False
                CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Enabled = False

            End If


            Dim TASSA_REGISTRAZIONE As Double = 0
            If TipoContratto <> "7" Then
                TASSA_REGISTRAZIONE = Format((CType(Tab_Registrazione1.FindControl("txtPercTotSu"), Label).Text * CanoneCorrente) / 100, "0")

                If TipoContratto = "6" And (CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Text = "STANDARD" Or CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Text = "431 P.O.R.") Then
                    TASSA_REGISTRAZIONE = Format((CType(Tab_Registrazione1.FindControl("txtPercTotSu"), Label).Text * (CanoneCorrente - ((30 / 100) * CanoneCorrente))) / 100, "0")
                    CType(Tab_Registrazione1.FindControl("Label18"), Label).Text = "RIPARTIZIONE IMPOSTA DI REGISTRAZIONE (contratto agevolato ai sensi dell'art. 2, comma 3)"
                End If

                If TASSA_REGISTRAZIONE > LimiteTassaRegistrazione Then
                    CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text = Format(TASSA_REGISTRAZIONE, "0.00")
                    CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercConduttore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                    CType(Tab_Registrazione1.FindControl("lblRegLoc"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercLocatore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                Else
                    TASSA_REGISTRAZIONE = LimiteTassaRegistrazione
                    CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text = Format(TASSA_REGISTRAZIONE, "0.00")
                    CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercConduttore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                    CType(Tab_Registrazione1.FindControl("lblRegLoc"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercLocatore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                End If
            Else
                TASSA_REGISTRAZIONE = 0
                CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text = Format(TASSA_REGISTRAZIONE, "0.00")
                CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text = "0,00"
                CType(Tab_Registrazione1.FindControl("lblRegLoc"), Label).Text = "0,00"

            End If


            CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).SelectedIndex = -1
            CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Items.FindByValue("A").Selected = True


            'If TASSA_REGISTRAZIONE = LimiteTassaRegistrazione Then
            '    If par.SoluzioneUnica(CDbl(CanoneCorrente), CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).text) <= LimiteTassaRegistrazione Then
            '        CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Items.FindByValue("U").Selected = True
            '        CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).enabled = False
            '    Else
            '        CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Items.FindByValue("A").Selected = True
            '    End If
            'Else
            '    CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Items.FindByValue("A").Selected = True
            'End If






            Dim testoTabella1 As String = ""

            If TipoContratto <> "3" And TipoContratto <> "5" And TipoContratto <> "6" And TipoContratto <> "7" And LetteraERP = "A" And TipoContratto <> "10" And TipoContratto <> "12" Then
                testoTabella1 = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                                   & "<tr>" _
                                   & "<td style='height: 15px'>" _
                                   & "<span style='font-size: 8pt; font-family: Arial'><strong>DATA CALCOLO</strong></span></td>" _
                                   & "<td style='height: 15px'>" _
                                   & "<span style='font-size: 8pt; font-family: Arial'><strong>AREA ECONOMICA</strong></span></td>" _
                                   & "<td style='height: 15px'>" _
                                   & "<span style='font-size: 8pt; font-family: Arial'><strong>CLASSE</strong></span></td>" _
                                   & "<td style='height: 15px'>" _
                                   & "<span style='font-size: 8pt; font-family: Arial'><strong>DATA VALIDITA'</strong></span></td>" _
                                   & "<td style='height: 15px'>" _
                                   & "<span style='font-size: 8pt; font-family: Arial'><strong>CANONE</strong></span></td>" _
                                   & "<td style='height: 15px'>" _
                                   & "<span style='font-size: 8pt; font-family: Arial'><strong>ORIGINE</strong></span></td>" _
                                   & "<td style='height: 15px'>" _
                                   & "<span style='font-size: 8pt; font-family: Arial'><strong></strong></span></td>" _
                                   & "</tr>"

                'testoTabella1 = testoTabella1 _
                '    & "<tr>" _
                '    & "<td style='height: 15px'>" _
                '    & "<span style='font-size: 8pt; font-family: Arial'>" & Format(Now, "dd/MM/yyyy") & "</span></td>" _
                '    & "<td style='height: 15px'>" _
                '    & "<span style='font-size: 8pt; font-family: Arial'>" & "<a href='DettagliCalcolo.aspx?COD=" & CodContratto & "&DATA=" & Format(Now, "yyyyMMdd") & "&IDC=" & lIdContratto & "&File=" & fileName & "' target='_blank'>Visualizza Dettagli del Canone calcolato</span></td>" _
                '    & "</tr>"
                testoTabella1 = testoTabella1 _
                            & "<tr>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & Format(Now, "dd/MM/yyyy") & "</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.RicavaAreaEconomica(AreaEconomica) & "</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & sSOTTOAREA & "</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'></span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & Format(CanoneCorrente, "0.00") & "</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>CONTRATTO</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & "<a href='#' onclick=" & Chr(34) & "alert('Salvare il contratto per visualizzare la maschera!');" & Chr(34) & ">Visualizza Dettagli</span></td>" _
                            & "</tr>"

                CType(Tab_Canone1.FindControl("lblDettaglioCanoni"), Label).Text = testoTabella1 & "</table>"
            Else
                'CType(Tab_Canone1.FindControl("lblDettaglioCanoni"), Label).Text = ""
            End If
            'CType(Tab_Canone1.FindControl("lblDettaglioCanoni"), Label).Text = testoTabella1 & "</table>"


            txtIdContratto.Value = CStr(lIdContratto)

            Dim SSS As String = ""
            Dim anagra As Long = 0

            par.cmd.CommandText = "select soggetti_contrattuali.id_anagrafica from siscom_mi.soggetti_contrattuali where id_contratto=" & lIdContratto
            myReaderA = par.cmd.ExecuteReader()
            Do While myReaderA.Read
                anagra = par.IfNull(myReaderA("id_anagrafica"), -1)

                par.cmd.CommandText = "select COD_FISCALE FROM SISCOM_MI.ANAGRAFICA where id=" & anagra
                Dim myReaderAX As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderAX.Read Then
                    par.cmd.CommandText = "select rapporti_utenza.id,rapporti_utenza.cod_contratto,rapporti_utenza.COD_TIPOLOGIA_CONTR_LOC,rapporti_utenza.DATA_DECORRENZA,rapporti_utenza.DATA_SCADENZA,SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID) AS ""STATO"" from siscom_mi.rapporti_utenza,siscom_mi.soggetti_contrattuali,SISCOM_MI.ANAGRAFICA where rapporti_utenza.id=soggetti_contrattuali.id_contratto and Soggetti_contrattuali.cod_tipologia_occupante='INTE' AND SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID)<>'CHIUSO' AND ANAGRAFICA.COD_FISCALE='" & par.IfNull(myReaderAX("COD_FISCALE"), "") & "' AND SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA=ANAGRAFICA.ID AND SOGGETTI_CONTRATTUALI.ID_CONTRATTO<>" & lIdContratto
                    Dim myReaderAX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    Do While myReaderAX1.Read
                        SSS = SSS & par.IfNull(myReaderAX1("COD_CONTRATTO"), "") & "-" & par.IfNull(myReaderAX1("COD_TIPOLOGIA_CONTR_LOC"), "") & "-" & par.IfNull(myReaderAX1("STATO"), "") & "</br>"
                    Loop
                    myReaderAX1.Close()
                End If
                myReaderAX.Close()
            Loop
            myReaderA.Close()

            par.cmd.CommandText = "select soggetti_contrattuali.id_anagrafica from siscom_mi.soggetti_contrattuali where id_contratto=" & lIdContratto
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                anagra = par.IfNull(myReaderA("id_anagrafica"), -1)
            End If
            myReaderA.Close()

            'par.cmd.CommandText = "select rapporti_utenza.id,rapporti_utenza.cod_contratto,rapporti_utenza.COD_TIPOLOGIA_CONTR_LOC,rapporti_utenza.DATA_DECORRENZA,rapporti_utenza.DATA_SCADENZA,SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID) AS ""STATO"" from siscom_mi.rapporti_utenza,siscom_mi.soggetti_contrattuali where rapporti_utenza.id=soggetti_contrattuali.id_contratto and soggetti_contrattuali.cod_tipologia_occupante='INTE' AND SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID)<>'CHIUSO' AND ID_ANAGRAFICA=" & anagra & " AND ID_CONTRATTO<>" & lIdContratto
            par.cmd.CommandText = "select rapporti_utenza.id,rapporti_utenza.cod_contratto,rapporti_utenza.COD_TIPOLOGIA_CONTR_LOC,rapporti_utenza.DATA_DECORRENZA,rapporti_utenza.DATA_SCADENZA,SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID) AS ""STATO"" from siscom_mi.rapporti_utenza,siscom_mi.soggetti_contrattuali where rapporti_utenza.id=soggetti_contrattuali.id_contratto and soggetti_contrattuali.cod_tipologia_occupante='INTE' " _
                & " AND ID_ANAGRAFICA in (select id from siscom_mi.anagrafica where cod_fiscale ='" & codFiscaleIntest.ToUpper & "' or partita_iva='" & codFiscaleIntest & "') AND ID_CONTRATTO<>" & lIdContratto
            myReaderA = par.cmd.ExecuteReader()
            Do While myReaderA.Read
                'SSS = SSS & par.IfNull(myReaderA("COD_CONTRATTO"), "") & "-" & par.IfNull(myReaderA("COD_TIPOLOGIA_CONTR_LOC"), "") & "-" & par.IfNull(myReaderA("STATO"), "") & "</br>"
                SSS = SSS & "<a href='#' onclick=" & Chr(34) & "ApriContratto('" & par.IfNull(myReaderA("id"), "") & "','" & par.IfNull(myReaderA("COD_CONTRATTO"), "SENZA CODICE") & "');" & Chr(34) & ">" & par.IfNull(myReaderA("COD_CONTRATTO"), "SENZA CODICE") & "-" & par.IfNull(myReaderA("COD_TIPOLOGIA_CONTR_LOC"), "") & "-" & par.IfNull(myReaderA("STATO"), "") & "</a></br>"
            Loop
            myReaderA.Close()
            If SSS <> "" Then
                CType(Generale1.FindControl("lblAltriAttivi"), Label).Text = SSS
            End If

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.TAB_UFFICIO_REGISTRO WHERE VAL_CORRENTE=1"
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                If TipoContratto <> "7" Then
                    CType(Tab_Registrazione1.FindControl("cmbUfficioRegistro"), DropDownList).SelectedIndex = -1
                    CType(Tab_Registrazione1.FindControl("cmbUfficioRegistro"), DropDownList).Items.FindByValue(myReaderA("COD")).Selected = True
                End If
            End If
            myReaderA.Close()

            par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=39"
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                If par.IfNull(myReaderA("VALORE"), "0") = "0" Then
                    CType(Tab_Bollette1.FindControl("imgModulo"), System.Web.UI.WebControls.Image).Visible = False
                    CType(Tab_Bollette1.FindControl("ImgMavOnLine"), System.Web.UI.WebControls.Image).Visible = False
                End If
            End If
            myReaderA.Close()


            Select Case TipoContratto
                Case "1", "2", "7", "10", "11", "12"
                    CType(Tab_Contratto1.FindControl("ChBolloEsente"), CheckBox).Visible = False
                Case Else
                    If LBLVIRTUALE.Visible = False Then
                        CType(Tab_Contratto1.FindControl("ChBolloEsente"), CheckBox).Visible = True
                    End If
            End Select
            'CaricaDomandeInCorso()
            Dim risultato As Boolean = CaricaSpese(False)






        Catch EX1 As Oracle.DataAccess.Client.OracleException
            If EX1.Number = 54 Then
                par.myTrans.Rollback()
                par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
                par.OracleConn.Close()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                Session.Item("LAVORAZIONE") = "0"
                scriptblock = "<script language='javascript' type='text/javascript'>" _
                & "alert('Contratto in fase d formalizzazione. Non è possibile procedere!');window.close();" _
                & "</script>"
                If (Not Page.ClientScript.IsClientScriptBlockRegistered("clientScript4")) Then
                    Page.ClientScript.RegisterClientScriptBlock(Me.GetType(), "clientScript4", scriptblock)
                End If
            Else
                Session.Item("LAVORAZIONE") = "0"
                par.myTrans.Rollback()
                par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
                par.OracleConn.Close()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
                HttpContext.Current.Session.Remove(lIdConnessione)


                Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & EX1.Message)
                Response.Write("<script>top.location.href='../Errore.aspx';</script>")
                System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CodContratto & ".txt"))

            End If


        Catch ex As Exception
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            HttpContext.Current.Session.Remove(lIdConnessione)


            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
            System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\" & CodContratto & ".txt"))

        End Try
    End Function

    Private Function DettaglioComponenti() As String
        Dim stringaComp As String = "" ' = "<table cellpadding='3' cellspacing='0' width='120%'>"
        Dim motivo As String = ""
        Dim risultato As Boolean = False
        Try
            stringaComp = "<table cellpadding='0' cellspacing='1' width='1010px'>" & vbCrLf _
                        & "<tr>" _
                        & "<td style='height: 15px; width: 250px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial;color:#8080FF'><strong>TIPO DOMANDA</strong></span></td>" _
                        & "<td style='height: 15px; width: 150px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial;color:#8080FF'><strong>NUM.PROTOCOLLO</strong></span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial;color:#8080FF'><strong>DATA DECORRENZA</strong></span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial;color:#8080FF'><strong>INIZIO VALIDITA'</strong></span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial;color:#8080FF'><strong>FINE VALIDITA'</strong></span></td>" _
                        & "<td style='height: 15px; width: 40px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial;color:#8080FF'><strong></strong></span></td>" _
                        & "</tr></table>"

            stringaComp = stringaComp & "<table cellpadding='0' cellspacing='1' width='1010px' style='border: 1px solid #8080FF;'>"
            par.cmd.CommandText = "SELECT DICHIARAZIONI_VSA.ID AS IDDICH,T_MOTIVO_DOMANDA_VSA.DESCRIZIONE AS MOT_DOM,DOMANDE_BANDO_VSA.PG AS PGDOM,DOMANDE_BANDO_VSA.DATA_AUTORIZZAZIONE,DOMANDE_BANDO_VSA.ID_CAUSALE_DOMANDA,DOMANDE_BANDO_VSA.ID AS IDDOM,DICHIARAZIONI_VSA.DATA_INIZIO_VAL,DICHIARAZIONI_VSA.DATA_FINE_VAL FROM DOMANDE_BANDO_VSA,T_MOTIVO_DOMANDA_VSA,DICHIARAZIONI_VSA WHERE DICHIARAZIONI_VSA.ID=DOMANDE_BANDO_VSA.ID_DICHIARAZIONE AND DOMANDE_BANDO_VSA.ID_MOTIVO_DOMANDA = T_MOTIVO_DOMANDA_VSA.ID AND CONTRATTO_NUM='" & CodContratto1 & "' AND FL_AUTORIZZAZIONE = 1 ORDER BY DOMANDE_BANDO_VSA.DATA_PG DESC"
            Dim myReaderA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            While myReaderA.Read
                risultato = True
                'stringaComp = stringaComp & "<tr><td><span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReaderA("MOT_DOM"), "") & " " & par.IfNull(myReaderA("PGDOM"), "") & " " & par.FormattaData(par.IfNull(myReaderA("DATA_INIZIO_VAL"), "")) & " " & par.FormattaData(par.IfNull(myReaderA("DATA_FINE_VAL"), "")) & " " & "</td><td><a href='javascript:void(0)' onclick=" & Chr(34) & "window.open('VisualizzazioneCompNucleo.aspx?ID=" & par.IfNull(myReaderA("IDDICH"), "") & "&T=1','Componenti','height=400,top=200,left=410,width=580,resizable=no,menubar=no,toolbar=no,scrollbars=no');" & Chr(34) & ">Clicca qui per visualizzare la situaz.anagrafica corrispondente</a></span></td></tr>"
                If par.IfNull(myReaderA("ID_CAUSALE_DOMANDA"), "") = "30" Then
                    motivo = "AMPLIAMENTO (d'ufficio)"
                Else
                    motivo = par.IfNull(myReaderA("MOT_DOM"), "")
                End If
                stringaComp = stringaComp & "<tr>" _
                        & "<td style='height: 15px; width: 250px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>" & motivo & "</span></td>" _
                        & "<td style='height: 15px; width: 150px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReaderA("PGDOM"), "") & "</span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>" & par.FormattaData(par.IfNull(myReaderA("DATA_AUTORIZZAZIONE"), "")) & "</span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>" & par.FormattaData(par.IfNull(myReaderA("DATA_INIZIO_VAL"), "")) & "</span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>" & par.FormattaData(par.IfNull(myReaderA("DATA_FINE_VAL"), "")) & "</span></td>" _
                        & "<td style='height: 15px; width: 40px'>" _
                        & "<img alt='Info' title='Visualizza la situazione anagrafica' src='../NuoveImm/Img_Info.png' onclick=" & Chr(34) & "window.open('VisualizzazioneCompNucleo.aspx?ID=" & par.IfNull(myReaderA("IDDICH"), "") & "&IDRU=" & lIdContratto & "&T=1','Componenti','height=400,top=200,left=410,width=670,resizable=no,menubar=no,toolbar=no,scrollbars=no');" & Chr(34) & " style='cursor: pointer' />" _
                        & "</tr>"

                '& "<span style='font-size: 8pt; font-family: Arial'><a href='javascript:void(0)' onclick=" & Chr(34) & "window.open('VisualizzazioneCompNucleo.aspx?ID=" & par.IfNull(myReaderA("IDDICH"), "") & "&T=1','Componenti','height=400,top=200,left=410,width=580,resizable=no,menubar=no,toolbar=no,scrollbars=no');" & Chr(34) & ">Situaz.anagrafica</a></span></td>" _
            End While
            myReaderA.Close()

            Dim dataApplicazione As String = ""

            par.cmd.CommandText = "SELECT UTENZA_DICHIARAZIONI.*,UTENZA_BANDI.DESCRIZIONE AS NOME_BANDO,UTENZA_BANDI.ANNO_ISEE,UTENZA_DICHIARAZIONI.DATA_INIZIO_VAL,UTENZA_DICHIARAZIONI.DATA_FINE_VAL FROM UTENZA_DICHIARAZIONI,UTENZA_BANDI WHERE NVL(FL_GENERAZ_AUTO,0)=0 AND (UTENZA_DICHIARAZIONI.NOTE_WEB IS NULL OR UTENZA_DICHIARAZIONI.NOTE_WEB<>'GENERATA_AUTOMATICAMENTE') AND UTENZA_BANDI.ID = UTENZA_DICHIARAZIONI.ID_BANDO " _
            & "AND RAPPORTO='" & CodContratto1 & "' ORDER BY ID_BANDO DESC"
            myReaderA = par.cmd.ExecuteReader
            While myReaderA.Read
                risultato = True

                par.cmd.CommandText = "SELECT * from siscom_mi.canoni_ec where id_dichiarazione=" & par.IfNull(myReaderA("ID"), 0) & " ORDER by data_Calcolo desc"
                Dim myReaderUD As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()

                If myReaderUD.Read Then
                    dataApplicazione = par.FormattaData(Mid(par.IfNull(myReaderUD("data_calcolo"), ""), 1, 8))
                End If
                myReaderUD.Close()

                'stringaComp = stringaComp & "<tr><td><span style='font-size: 8pt; font-family: Arial'><b>>></b> Presentata domanda di <b>" & par.IfNull(myReaderA("NOME_BANDO"), "").ToString.ToLower & "</b> con inizio validità " & par.FormattaData(par.IfNull(myReaderA("DATA_INIZIO_VAL"), "")) & " e fine validità " & par.FormattaData(par.IfNull(myReaderA("DATA_FINE_VAL"), "")) & ".  " & "</td><td><a href='javascript:void(0)' onclick=" & Chr(34) & "window.open('VisualizzazioneCompNucleo.aspx?ID=" & par.IfNull(myReaderA("ID"), "") & "&T=2','Componenti','height=400,top=200,left=410,width=580,resizable=no,menubar=no,toolbar=no,scrollbars=no');" & Chr(34) & ">Clicca qui per visualizzare la situaz.anagrafica corrispondente</a></span></td></tr>"
                stringaComp = stringaComp & "<tr>" _
                        & "<td style='height: 15px; width: 250px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReaderA("NOME_BANDO"), "") & "</span></td>" _
                        & "<td style='height: 15px; width: 150px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReaderA("PG"), "") & "</span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>" & dataApplicazione & "</span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>" & par.FormattaData(par.IfNull(myReaderA("DATA_INIZIO_VAL"), "")) & "</span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>" & par.FormattaData(par.IfNull(myReaderA("DATA_FINE_VAL"), "")) & "</span></td>" _
                        & "<td style='height: 15px; width: 40px'>" _
                        & "<img alt='Info' title='Visualizza la situazione anagrafica' src='../NuoveImm/Img_Info.png' onclick=" & Chr(34) & "window.open('VisualizzazioneCompNucleo.aspx?ID=" & par.IfNull(myReaderA("ID"), "") & "&IDRU=" & lIdContratto & "&T=2','Componenti2','height=400,top=200,left=410,width=670,resizable=no,menubar=no,toolbar=no,scrollbars=no');" & Chr(34) & " style='cursor: pointer' />" _
                        & "</tr>"

                '& "<span style='font-size: 8pt; font-family: Arial'><a href='javascript:void(0)' onclick=" & Chr(34) & "window.open('VisualizzazioneCompNucleo.aspx?ID=" & par.IfNull(myReaderA("ID"), "") & "&T=2','Componenti','height=400,top=200,left=410,width=580,resizable=no,menubar=no,toolbar=no,scrollbars=no');" & Chr(34) & ">Situaz.anagrafica</a></span></td>" _

            End While
            myReaderA.Close()

            par.cmd.CommandText = "SELECT DOMANDE_BANDO.*,bandi.descrizione FROM BANDI,DOMANDE_BANDO WHERE BANDI.ID=DOMANDE_BANDO.ID_BANDO AND CONTRATTO_NUM='" & CodContratto1 & "'"
            myReaderA = par.cmd.ExecuteReader
            While myReaderA.Read
                risultato = True
                'stringaComp = stringaComp & "<tr><td><span style='font-size: 8pt; font-family: Arial'><b>>></b> Presentata domanda di <b>bando ERP</b> (" & par.IfNull(myReaderA("DESCRIZIONE"), "").ToString.ToLower & ") in data " & par.FormattaData(par.IfNull(myReaderA("DATA_PG"), "")) & ".  " & "</td><td><a href='javascript:void(0)' onclick=" & Chr(34) & "window.open('VisualizzazioneCompNucleo.aspx?ID=" & par.IfNull(myReaderA("ID_DICHIARAZIONE"), "") & "&T=3','Componenti','height=400,top=200,left=410,width=580,resizable=no,menubar=no,toolbar=no,scrollbars=no');" & Chr(34) & ">Clicca qui per visualizzare la situaz.anagrafica corrispondente</a></span></td></tr>"
                stringaComp = stringaComp & "<tr>" _
                        & "<td style='height: 15px; width: 250px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReaderA("DESCRIZIONE"), "") & "</span></td>" _
                        & "<td style='height: 15px; width: 150px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReaderA("PG"), "") & "</span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>&nbsp</span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>&nbsp</span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>&nbsp</span></td>" _
                        & "<td style='height: 15px; width: 40px'>" _
                        & "<img alt='Info' title='Visualizza la situazione anagrafica' src='../NuoveImm/Img_Info.png' onclick=" & Chr(34) & "window.open('VisualizzazioneCompNucleo.aspx?ID=" & par.IfNull(myReaderA("ID_DICHIARAZIONE"), "") & "&IDRU=" & lIdContratto & "&T=3','Componenti3','height=400,top=200,left=410,width=670,resizable=no,menubar=no,toolbar=no,scrollbars=no');" & Chr(34) & " style='cursor: pointer' />" _
                        & "</tr>"
                '& "<span style='font-size: 8pt; font-family: Arial'><a href='javascript:void(0)' onclick=" & Chr(34) & "window.open('VisualizzazioneCompNucleo.aspx?ID=" & par.IfNull(myReaderA("ID_DICHIARAZIONE"), "") & "&T=3','Componenti','height=400,top=200,left=410,width=580,resizable=no,menubar=no,toolbar=no,scrollbars=no');" & Chr(34) & ">Situaz.anagrafica</a></span></td>" _
            End While
            myReaderA.Close()


            par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI_INIZIO.* FROM SISCOM_MI.SOGGETTI_CONTRATTUALI_INIZIO WHERE SOGGETTI_CONTRATTUALI_INIZIO.ID_CONTRATTO = " & lIdContratto
            myReaderA = par.cmd.ExecuteReader
            If myReaderA.Read Then
                risultato = True
                'stringaComp = stringaComp & "<tr><td><span style='font-size: 8pt; font-family: Arial'><b>>></b> Presentata domanda di <b>bando ERP</b> (" & par.IfNull(myReaderA("DESCRIZIONE"), "").ToString.ToLower & ") in data " & par.FormattaData(par.IfNull(myReaderA("DATA_PG"), "")) & ".  " & "</td><td><a href='javascript:void(0)' onclick=" & Chr(34) & "window.open('VisualizzazioneCompNucleo.aspx?ID=" & par.IfNull(myReaderA("ID_DICHIARAZIONE"), "") & "&T=3','Componenti','height=400,top=200,left=410,width=580,resizable=no,menubar=no,toolbar=no,scrollbars=no');" & Chr(34) & ">Clicca qui per visualizzare la situaz.anagrafica corrispondente</a></span></td></tr>"
                stringaComp = stringaComp & "<tr>" _
                        & "<td style='height: 15px; width: 250px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>SITUAZIONE INIZIALE</span></td>" _
                        & "<td style='height: 15px; width: 150px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>&nbsp</span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>&nbsp</span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>&nbsp</span></td>" _
                        & "<td style='height: 15px; width: 130px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'>&nbsp</span></td>" _
                        & "<td style='height: 15px; width: 40px'>" _
                        & "<img alt='Info' title='Visualizza la situazione anagrafica' src='../NuoveImm/Img_Info.png' onclick=" & Chr(34) & "window.open('VisualizzazioneCompNucleo.aspx?ID=" & lIdContratto & "&IDRU=" & lIdContratto & "&T=4','Componenti4','height=400,top=200,left=410,width=670,resizable=no,menubar=no,toolbar=no,scrollbars=no');" & Chr(34) & " style='cursor: pointer' />" _
                        & "</tr>"
                '& "<span style='font-size: 8pt; font-family: Arial'><a href='javascript:void(0)' onclick=" & Chr(34) & "window.open('VisualizzazioneCompNucleo.aspx?ID=" & par.IfNull(myReaderA("ID_DICHIARAZIONE"), "") & "&T=3','Componenti','height=400,top=200,left=410,width=580,resizable=no,menubar=no,toolbar=no,scrollbars=no');" & Chr(34) & ">Situaz.anagrafica</a></span></td>" _
            End If
            myReaderA.Close()

            If risultato = True Then
                stringaComp = stringaComp & "</table>"
            Else
                stringaComp = ""
            End If

        Catch ex As Exception
            If Not IsNothing(par.myTrans) Then
                par.myTrans.Rollback()
            End If
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " (funzione DettaglioComponenti) - " & ex.Message)
            Response.Redirect("../Errore.aspx", False)
        End Try

        Return stringaComp

    End Function


    Function VisualizzaContratto()
        Dim scriptblock As String
        Dim Conduttore As String = ""
        Dim Conduttore1 As String = ""
        Dim testoTabella As String = ""
        Dim ExConduttore As String = ""

        'max 15/12/2014 visualizzazione dati reg.
        Dim TipoPosizione As String = ""
        Dim ModalitaPagamento As String = ""

        Try

            par.OracleConn.Open()
            par.SettaCommand(par)
            HttpContext.Current.Session.Add(lIdConnessione, par.OracleConn)

            Session.Add("lIdConnessione", lIdConnessione)

            Dim LimiteTassaRegistrazione As Double = 0
            par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=6"
            Dim myReaderA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                LimiteTassaRegistrazione = CDbl(par.PuntiInVirgole(par.IfNull(myReaderA("VALORE"), 0)))
            End If
            myReaderA.Close()

            par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=35"
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                sAnnoSchema = par.IfNull(myReaderA("VALORE"), "2010")
                annoschema.Value = sAnnoSchema
            End If
            myReaderA.Close()


            '29/01/2014
            'If CType(Tab_Bollette1.FindControl("menuGest"), HiddenField).Value = "1" Then
            '    par.RiempiDList(Tab_Bollette1, par.OracleConn, "cmbVoceSchema", "select * from siscom_mi.t_voci_bolletta where SELEZIONABILE=1 order by descrizione asc", "DESCRIZIONE", "ID")
            'Else
            par.RiempiDList(Tab_Bollette1, par.OracleConn, "cmbVoceSchema", "select * from siscom_mi.t_voci_bolletta where SELEZIONABILE=1 order by descrizione asc", "DESCRIZIONE", "ID")
            'End If

            par.RiempiDList(Tab_SchemaBollette1, par.OracleConn, "cmbVoceSchema", "select * from siscom_mi.t_voci_bolletta where id<>407 AND SELEZIONABILE=1 order by descrizione asc", "DESCRIZIONE", "ID")


            par.RiempiDList(Tab_Bollette1, par.OracleConn, "cmbVoceSchema2", "select * from siscom_mi.t_voci_bolletta where id<>407 AND SELEZIONABILE=1 order by descrizione asc", "DESCRIZIONE", "ID")
            par.RiempiDListConVuoto(Tab_Registrazione1, par.OracleConn, "cmbUfficioRegistro", "SELECT * FROM SISCOM_MI.TAB_UFFICIO_REGISTRO ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
            par.RiempiDListConVuoto(Tab_Comunicazioni1, par.OracleConn, "cmbTipoViaCor", "select * from siscom_mi.tipologia_indirizzo order by descrizione asc", "DESCRIZIONE", "COD")
            par.RiempiDListConNULL(Tab_Comunicazioni1, par.OracleConn, "cmbCommissariato", "select * from siscom_mi.tab_commissariati order by descrizione asc", "DESCRIZIONE", "ID")

            'GESTITO DA SINDACATO
            par.RiempiDListConVuoto(Tab_SchemaBollette1, par.OracleConn, "lstSindacati", "select * from sindacati_vsa", "DESCRIZIONE", "ID")


            'max 13/06/2016
            par.RiempiDListConVuoto(Tab_Registrazione1, par.OracleConn, "cmbTipoPosizione", "select * from SISCOM_MI.TIPOLOGIA_POSIZIONE ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "ID")
            par.RiempiDListConVuoto(Tab_Registrazione1, par.OracleConn, "cmbModoPagamento", "select * from SISCOM_MI.TIPOLOGIA_PAGAMENTO ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "ID")


            par.cmd.CommandText = "SELECT RAPPORTI_UTENZA.* FROM SISCOM_MI.RAPPORTI_UTENZA WHERE RAPPORTI_UTENZA.ID=" & lIdContratto & " FOR UPDATE NOWAIT"
            'par.cmd.CommandText = "SELECT RAPPORTI_UTENZA.* FROM SISCOM_MI.RAPPORTI_UTENZA WHERE RAPPORTI_UTENZA.ID=" & lIdContratto
InSolaLettura:
            If SolaLettura = "1" Then
                If lettura.Value = "1" Then
                    par.OracleConn.Close()
                End If
                par.OracleConn.Open()
                par.SettaCommand(par)
                HttpContext.Current.Session.Add(lIdConnessione, par.OracleConn)
                Session.Add("lIdConnessione", lIdConnessione)
                par.cmd.CommandText = "SELECT RAPPORTI_UTENZA.* FROM SISCOM_MI.RAPPORTI_UTENZA WHERE RAPPORTI_UTENZA.ID=" & lIdContratto

            End If

            Dim myReaderVer As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()



            par.cmd.CommandText = "SELECT RAPPORTI_UTENZA_PROSSIMA_BOL.PROSSIMA_BOLLETTA,TIPOLOGIA_CONTRATTO_LOCAZIONE.DESCRIZIONE AS ""TIPO_C"",TIPOLOGIA_CONTRATTO_LOCAZIONE.RIF_LEGISLATIVO ,TIPOLOGIA_CONTRATTO_LOCAZIONE.perc_tr_canone,TIPOLOGIA_CONTRATTO_LOCAZIONE.perc_conduttore,RAPPORTI_UTENZA.*,SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID) AS ""STATO"" FROM SISCOM_MI.RAPPORTI_UTENZA_PROSSIMA_BOL,SISCOM_MI.RAPPORTI_UTENZA,SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE RAPPORTI_UTENZA_PROSSIMA_BOL.ID_CONTRATTO (+) =RAPPORTI_UTENZA.ID AND TIPOLOGIA_CONTRATTO_LOCAZIONE.COD=RAPPORTI_UTENZA.COD_TIPOLOGIA_CONTR_LOC AND RAPPORTI_UTENZA.ID=" & lIdContratto
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()

            If myReader.Read Then

                'max 15/12/2014 visualizzazione dati reg.
                TipoPosizione = par.IfNull(myReader("ID_TIPO_POSIZIONE"), "")
                ModalitaPagamento = par.IfNull(myReader("ID_TIPO_PAGAMENTO"), "")

                par.caricaComboBox("SELECT * FROM SISCOM_MI.TAB_ORIGINE_CONTRATTO WHERE (COD_TIPOLOGIA_CONTR='" & par.IfNull(myReader("COD_TIPOLOGIA_CONTR_LOC"), "") & "' or COD_TIPOLOGIA_CONTR is null)", CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList), "ID", "DESCRIZIONE")

                origineContratto = par.IfNull(myReader("ID_ORIGINE_CONTRATTO"), -1)

                If origineContratto <> -1 Then
                    CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedValue = origineContratto
                    lblOrigineContratto.Text = CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedItem.Text
                End If

                If par.IfNull(myReader("imp_canone_provv"), 0) <> 0 Then

                    par.cmd.CommandText = "SELECT DOMANDE_BANDO_VSA.ID,domande_bando_vsa.id_dichiarazione FROM DOMANDE_BANDO_VSA,DOMANDE_VSA_ALLOGGIO where DOMANDE_VSA_ALLOGGIO.ID_DOMANDA=DOMANDE_BANDO_VSA.ID AND DOMANDE_BANDO_VSA.ID_MOTIVO_DOMANDA=3 AND DOMANDE_VSA_ALLOGGIO.num_contratto='" & par.IfNull(myReader("cod_contratto"), "") & "'"
                    Dim myReader432 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader432.HasRows = True Then
                        If myReader432.Read Then
                            CType(Tab_Canone1.FindControl("lblProvvisiorio0"), Label).Visible = True
                            'CType(Tab_Canone1.FindControl("lblProvvisiorio0"), Label).Text = "<a href='#' onclick=" & Chr(34) & "javascript:window.open('../VSA/domanda.aspx?L=1&X=1&ID=" & myReader432("id") & "&ID1=" & myReader432("id_dichiarazione") & "&PROGR=-1&INT=0','Domanda','height=480,top=0,left=0,width=670,scrollbars=no');" & Chr(34) & " alt='Visualizza domanda'>* Domanda Rid. Canone</a>"
                            CType(Tab_Canone1.FindControl("lblProvvisiorio0"), Label).Text = "<a href='#' onclick=" & Chr(34) & "javascript:window.open('../VSA/NuovaDomandaVSA/domandaNuova.aspx?L=1&X=1&ID=" & myReader432("id") & "&ID1=" & myReader432("id_dichiarazione") & "&PROGR=-1&INT=0','Domanda');" & Chr(34) & " alt='Visualizza domanda'>* Domanda Rid. Canone</a>"
                        End If
                    Else
                        CType(Tab_Canone1.FindControl("lblProvvisiorio0"), Label).Visible = False
                    End If
                    myReader432.Close()

                    CType(Tab_Canone1.FindControl("lblProvvisiorio"), Label).Visible = True

                    CType(Tab_Canone1.FindControl("lblCanoneProvvisiorio"), Label).Visible = True
                    CType(Tab_Canone1.FindControl("lblCanoneProvvisiorio"), Label).Text = Format(par.IfNull(myReader("imp_canone_provv"), "0"), "##,##0.00")
                End If

                lblContratto.Text = "Rapporto Cod. " & par.IfNull(myReader("cod_contratto"), "")
                CodContratto1 = par.IfNull(myReader("cod_contratto"), "")
                If par.IfNull(myReader("ART_15"), "0") = "3" Then
                    LetteraProvenienza = "V"
                ElseIf par.IfNull(myReader("ART_15"), "0") = "2" Then
                    LetteraProvenienza = "D"
                Else
                    LetteraProvenienza = "-1"
                End If

                If par.IfNull(myReader("FL_TUTORE_STR"), "0") = "0" Then
                    CType(Tab_Contratto1.FindControl("ChTutore"), CheckBox).Checked = False
                Else
                    CType(Tab_Contratto1.FindControl("ChTutore"), CheckBox).Checked = True
                End If
                If par.IfNull(myReader("sindacato"), "-1") <> "-1" Then
                    CType(Tab_SchemaBollette1.FindControl("lstSindacati"), DropDownList).SelectedIndex = -1
                    CType(Tab_SchemaBollette1.FindControl("lstSindacati"), DropDownList).Items.FindByValue(par.IfNull(myReader("sindacato"), "1")).Selected = True
                End If

                TipoContratto = par.IfNull(myReader("PROVENIENZA_ASS"), 1)




                If TipoContratto = "3" Then
                    par.RiempiDListConVuoto(Tab_Contratto1, par.OracleConn, "cmbNomeUfficiale", "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE SUBSTR(COD,1,3)='USD' OR SUBSTR(COD,1,3)='CON' ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")


                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("STANDARD", "0"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("COOPERATIVE", "C"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431 P.O.R.", "P"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("RESIDENZIALE", "R"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("392/78 ASSOCIAZIONI", "A"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 Art.15 R.R.1/2004", "D"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 Art.15 C.2 R.R.1/2004", "V"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 SPECIALI", "S"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("FORZE DELL'ORDINE", "Z"))


                    CType(Tab_Conduttore1.FindControl("Label1"), Label).Text = "ELENCO EX INTESTATARI"

                    CType(Tab_Conduttore1.FindControl("btnAggiungiComp"), System.Web.UI.WebControls.Image).Visible = False
                    CType(Tab_Conduttore1.FindControl("imgDiventaINT"), System.Web.UI.WebControls.Image).Visible = False
                    CType(Tab_Conduttore1.FindControl("img_EliminaComp"), System.Web.UI.WebControls.Image).Visible = False

                    'CType(Tab_Conduttore1.FindControl("img_EliminaOspite"), System.Web.UI.WebControls.Image).Visible = False
                    CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Visible = False
                    CType(Tab_Conduttore1.FindControl("Label4"), Label).Visible = False
                    CType(Tab_Conduttore1.FindControl("Label2"), Label).Visible = False


                    CType(Tab_Conduttore1.FindControl("btnAggiungiCond"), System.Web.UI.WebControls.Image).Visible = False
                    CType(Tab_Conduttore1.FindControl("imgEliminaCond"), System.Web.UI.WebControls.Image).Visible = False
                    CType(Tab_Conduttore1.FindControl("Img_DiventaComp"), System.Web.UI.WebControls.Image).Visible = False


                End If


                If TipoContratto = "10" Or TipoContratto = "1" Or TipoContratto = "2" Or TipoContratto = "12" Then
                    par.RiempiDListConVuoto(Tab_Contratto1, par.OracleConn, "cmbNomeUfficiale", "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE SUBSTR(COD,1,3)='ERP' ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedIndex = -1
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.FindByValue("R").Selected = True
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Enabled = False

                End If
                If TipoContratto = "6" Then
                    par.RiempiDListConVuoto(Tab_Contratto1, par.OracleConn, "cmbNomeUfficiale", "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE SUBSTR(COD,1,6)='L43198' ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")

                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("POSTO AUTO COPERTO,SCOPERTO,BOX,MOTOBOX ETC.", "B"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("NEGOZIO, MAGAZZINO, LABORATORIO, UFFICIO, ETC.", "N"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("RESIDENZIALE", "R"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("392/78 ASSOCIAZIONI", "A"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("CONCESSIONE SPAZI P.", "X"))
                    'CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("CONCESSIONE IMPRESE", "2"))
                    'CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("CONCESSIONE ASSOCIAZIONI", "3"))
                    'MAX 23/04/2015
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("COMODATO D'USO GRATUITO", "Y"))

                    If par.IfNull(myReader("dest_uso"), "0") = "C" Then

                        CType(Tab_Conduttore1.FindControl("Label1"), Label).Text = "ELENCO EX INTESTATARI"

                        CType(Tab_Conduttore1.FindControl("btnAggiungiComp"), System.Web.UI.WebControls.Image).Visible = False
                        CType(Tab_Conduttore1.FindControl("imgDiventaINT"), System.Web.UI.WebControls.Image).Visible = False
                        CType(Tab_Conduttore1.FindControl("img_EliminaComp"), System.Web.UI.WebControls.Image).Visible = False

                        CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Visible = False
                        CType(Tab_Conduttore1.FindControl("Label4"), Label).Visible = False
                        CType(Tab_Conduttore1.FindControl("Label2"), Label).Visible = False


                        CType(Tab_Conduttore1.FindControl("btnAggiungiCond"), System.Web.UI.WebControls.Image).Visible = False
                        CType(Tab_Conduttore1.FindControl("imgEliminaCond"), System.Web.UI.WebControls.Image).Visible = False
                        CType(Tab_Conduttore1.FindControl("Img_DiventaComp"), System.Web.UI.WebControls.Image).Visible = False
                    End If

                End If

                If TipoContratto = "5" Then
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("POSTO AUTO COPERTO,SCOPERTO,BOX,MOTOBOX ETC.", "B"))
                    'CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("NEGOZIO, MAGAZZINO, LABORATORIO, UFFICIO, ETC.", "N"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("RESIDENZIALE", "R"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("COOPERATIVE", "C"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431 P.O.R.", "P"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 Art.15 R.R.1/2004", "D"))
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("431/98 Art.15 C.2 R.R.1/2004", "V"))
                    'MAX 23/04/2015
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.Remove(New ListItem("COMODATO D'USO GRATUITO", "Y"))

                    par.RiempiDListConVuoto(Tab_Contratto1, par.OracleConn, "cmbNomeUfficiale", "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE SUBSTR(COD,1,6)='EQC392' ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")


                    If par.IfNull(myReader("dest_uso"), "0") = "A" Then

                        CType(Tab_Conduttore1.FindControl("Label1"), Label).Text = "ELENCO EX INTESTATARI"

                        CType(Tab_Conduttore1.FindControl("btnAggiungiComp"), System.Web.UI.WebControls.Image).Visible = False
                        CType(Tab_Conduttore1.FindControl("imgDiventaINT"), System.Web.UI.WebControls.Image).Visible = False
                        CType(Tab_Conduttore1.FindControl("img_EliminaComp"), System.Web.UI.WebControls.Image).Visible = False

                        'CType(Tab_Conduttore1.FindControl("img_EliminaOspite"), System.Web.UI.WebControls.Image).Visible = False
                        CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Visible = False
                        CType(Tab_Conduttore1.FindControl("Label4"), Label).Visible = False
                        CType(Tab_Conduttore1.FindControl("Label2"), Label).Visible = False


                        CType(Tab_Conduttore1.FindControl("btnAggiungiCond"), System.Web.UI.WebControls.Image).Visible = False
                        CType(Tab_Conduttore1.FindControl("imgEliminaCond"), System.Web.UI.WebControls.Image).Visible = False
                        CType(Tab_Conduttore1.FindControl("Img_DiventaComp"), System.Web.UI.WebControls.Image).Visible = False
                    End If

                End If

                If TipoContratto = "7" Then
                    par.RiempiDListConVuoto(Tab_Contratto1, par.OracleConn, "cmbNomeUfficiale", "SELECT * FROM SISCOM_MI.TIPOLOGIA_CONTRATTO_LOCAZIONE WHERE SUBSTR(COD,1,4)='NONE' ORDER BY DESCRIZIONE ASC", "DESCRIZIONE", "COD")
                    LBLABUSIVO.Visible = True

                    CType(Tab_Contratto1.FindControl("Label26"), Label).Visible = True
                    CType(Tab_Contratto1.FindControl("Image1"), System.Web.UI.WebControls.Image).Visible = True

                End If

                lIdDichiarazione = par.IfNull(myReader("ID_ISEE"), -1)
                lIdDomandaERP = par.IfNull(myReader("ID_DOMANDA"), -1)
                lIdAU = par.IfNull(myReader("ID_AU"), -1)

                CType(Tab_SchemaBollette1.FindControl("lblProssimaEmissione"), Label).Text = "Prossima Emissione: " & Mid(par.IfNull(myReader("PROSSIMA_BOLLETTA"), "XXXXXX"), 1, 4) & "/" & MESE(Mid(par.IfNull(myReader("PROSSIMA_BOLLETTA"), "XXXXXX"), 5, 2))
                If Session("MOD_SBLOCCO_BOLL") = "1" Then
                    CType(Tab_SchemaBollette1.FindControl("imgModificaPS"), ImageButton).Visible = True
                End If

                Generale1.IndiceAnagrafe = CStr(par.IfNull(myReader("ID_AU"), "-1"))

                If par.IfNull(myReader("PROVENIENZA_ASS"), "1") = "1" Then
                    Generale1.Provenienza = "1"
                    par.cmd.CommandText = "SELECT ID FROM DOMANDE_BANDO WHERE ID=" & par.IfNull(myReader("ID_DOMANDA"), "-1")
                End If
                If par.IfNull(myReader("PROVENIENZA_ASS"), "1") = "2" Then
                    Generale1.Provenienza = "2"
                    par.cmd.CommandText = "SELECT ID FROM DOMANDE_BANDO_CAMBI WHERE ID=" & par.IfNull(myReader("ID_DOMANDA"), "-1")
                End If

                Dim myReaderESISTE As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderESISTE.Read Then
                    Generale1.IndiceDomanda = CStr(par.IfNull(myReader("ID_DOMANDA"), "-1"))
                Else
                    Generale1.IndiceDomanda = "-1"
                End If
                myReaderESISTE.Close()



                If par.IfNull(myReader("PROVENIENZA_ASS"), "1") = "1" Then
                    Generale1.Provenienza = "1"
                    par.cmd.CommandText = "SELECT ID FROM DICHIARAZIONI WHERE ID=" & par.IfNull(myReader("ID_ISEE"), "-1")
                End If
                If par.IfNull(myReader("PROVENIENZA_ASS"), "1") = "2" Then
                    Generale1.Provenienza = "2"
                    par.cmd.CommandText = "SELECT ID FROM DICHIARAZIONI_CAMBI WHERE ID=" & par.IfNull(myReader("ID_ISEE"), "-1")
                End If

                'If par.IfNull(myReader("PROVENIENZA_ASS"), "1") = "8" Then
                'Generale1.Provenienza = "8"
                'par.cmd.CommandText = "SELECT ID FROM DICHIARAZIONI_VSA WHERE ID=" & par.IfNull(myReader("ID_ISEE"), "-1")
                'End If

                If par.IfNull(myReader("PROVENIENZA_ASS"), "1") = "10" Then
                    Generale1.Provenienza = "10"
                    par.cmd.CommandText = "SELECT ID FROM DICHIARAZIONI_VSA WHERE ID=" & par.IfNull(myReader("ID_ISEE"), "-1")
                End If


                myReaderESISTE = par.cmd.ExecuteReader()
                If myReaderESISTE.Read Then
                    Generale1.IndiceDichiarazione = CStr(par.IfNull(myReader("ID_ISEE"), "-1"))
                Else
                    Generale1.IndiceDichiarazione = "-1"
                End If
                myReaderESISTE.Close()



                'img_Eventi.Attributes.Add("onclick", "javascript:window.open('Eventi_1.aspx?COD=" & par.IfNull(myReader("cod_contratto"), "") & "&ID=" & lIdContratto & "','" & par.IfNull(myReader("cod_contratto"), "") & "','');")
                CodContratto = par.IfNull(myReader("cod_contratto"), "")
                CodContratto1 = par.IfNull(myReader("cod_contratto"), "")

                If Mid(CodContratto, 1, 6) = "000000" Then
                    LBLVIRTUALE.Visible = True
                    VIRTUALE.Value = "1"

                    If par.IfNull(myReader("DURATA_MESI"), 0) <> 0 Then
                        LBLVIRTUALE.BackColor = System.Drawing.Color.LightCyan
                        LBLVIRTUALE.Text = "VIRTUALE MANUALE"
                    End If
                End If


                txtIdContratto.Value = par.IfNull(myReader("id"), "")

                If par.IfNull(myReader("DURATA_MESI"), 0) = 18 Then
                    durataMesi.Value = "18"
                End If



                CanoneCorrente = par.IfNull(myReader("imp_canone_iniziale"), "0")
                'Nlla tabella SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE ci sono tutti gli adeguamenti fatti al canone iniziale, compresi aggiornamenti ISTAT

                par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE ID_CONTRATTO=" & lIdContratto
                Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderX1.Read Then
                    CanoneCorrente = CanoneCorrente + par.IfNull(myReaderX1(0), 0)
                End If
                myReaderX1.Close()


                CType(Generale1.FindControl("lblDecorrenza"), Label).Text = par.FormattaData(par.IfNull(myReader("data_decorrenza"), ""))
                CType(Generale1.FindControl("lblScadenza"), Label).Text = par.FormattaData(par.IfNull(myReader("data_scadenza"), ""))
                CType(Generale1.FindControl("lblDisdetta"), Label).Text = par.FormattaData(par.IfNull(myReader("data_Disdetta_Locatario"), ""))

                CType(Generale1.FindControl("lblStato"), Label).Text = par.IfNull(myReader("STATO"), "")
                CType(Generale1.FindControl("lblCodiceGimi"), Label).Text = par.IfNull(myReader("cod_contratto_gimi"), "")




                'btnMavAttivazione.Visible = True
                ImgBolAttivazione.Visible = True
                DataDisponibilitaAlloggio = ""
                Select Case CType(Generale1.FindControl("lblStato"), Label).Text
                    Case "BOZZA"
                        If par.IfNull(myReader("fl_stampato"), "0") = "1" Then
                            Tab_Contratto1.Disabilita()
                            CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).ReadOnly = True
                            'max 18/07/2019
                            'CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).ReadOnly = True
                            '----------
                            CType(Tab_Contratto1.FindControl("txtEntroCuiDisdettare"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).ReadOnly = True

                            Tab_Registrazione1.Disabilita()
                            Tab_Canone1.disattiva()
                            If TipoContratto = "7" And SolaLettura = "0" Then
                                Tab_Conduttore1.Disabilita_Tutto_Tranne_Comp()
                            Else
                                Tab_Conduttore1.Disabilita_Tutto()
                            End If
                            speseunita.Value = "0"
                        Else

                            CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).ReadOnly = False
                            CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).ReadOnly = False

                            If (TipoContratto = "3" Or TipoContratto = "6") And LBLSTATOC.Text = "Stato: BOZZA" Then
                                CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).Enabled = True
                            End If

                        End If
                        btnAttivaContratto.Visible = True
                        'btnMavAttivazione.Visible = True
                        ImgBolAttivazione.Visible = True
                        If TipoContratto <> "7" Then
                            btnStampaContratto.Visible = True
                        End If
                        speseunita.Value = "1"
                        LBLNOMEFILECANONE.Value = Server.MapPath("..\ALLEGATI\CONTRATTI\StampeCanoni27\") & CodContratto & ".txt"

                        If VIRTUALE.Value <> "1" Then
                            If SolaLettura <> "1" Then
                                If TipoContratto = "1" Or TipoContratto = "2" Then
                                    CType(Tab_Canone1.FindControl("ImgRicalcolaC"), ImageButton).Visible = True
                                End If
                            End If
                        End If


                    Case "CHIUSO"
                        Tab_Contratto1.DisabilitaTutto()
                        Tab_Registrazione1.DisabilitaTutto()
                        Tab_Canone1.disattivaTutto()
                        'Tab_Comunicazioni1.Disabilita_tutto()
                        Tab_Conduttore1.Disabilita_Tutto()
                        btnAttivaContratto.Visible = False
                        btnStampaContratto.Visible = False
                        CType(Tab_Registrazione1.FindControl("txtNotereg"), TextBox).ReadOnly = True
                        'imgSalva.Visible = False
                        ImgBolAttivazione.Visible = False
                        Tab_SchemaBollette1.DisattivaTutto()
                        'imgSpeseUnita.Visible = False
                        speseunita.Value = "0"

                        If SolaLettura <> "1" Then
                            'CType(Tab_Contratto1.FindControl("txtNote"), TextBox).ReadOnly = False
                            'CType(Tab_Contratto1.FindControl("txtNote"), TextBox).Enabled = True
                            imgSalva.Visible = True
                            CType(Tab_Bollette1.FindControl("btnAnnullaBolletta"), ImageButton).Visible = True

                        End If


                        'If VIRTUALE.Value <> "1" Then
                        '    If SolaLettura <> "1" Then
                        '        If TipoContratto = "1" Or TipoContratto = "2" Then
                        '            CType(Tab_Canone1.FindControl("ImgRicalcolaC"), ImageButton).Visible = True
                        '        End If
                        '    End If
                        'End If

                        'btnVisStampe.Visible = True
                        'btnVisStampe.Attributes.Add("onclick", "javascript:document.getElementById('USCITA').value='1';window.open('ElencoStampeContratti.aspx?COD=" & CodContratto & "','" & CodContratto & "','');")
                    Case Else
                        Tab_Contratto1.Disabilita()
                        CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).ReadOnly = True
                        CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).ReadOnly = True
                        CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).ReadOnly = True
                        CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).ReadOnly = True
                        CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).ReadOnly = True
                        CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).ReadOnly = True
                        CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).ReadOnly = True
                        'max 18/07/2019
                        'CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).ReadOnly = True
                        '----------
                        CType(Tab_Contratto1.FindControl("txtEntroCuiDisdettare"), TextBox).ReadOnly = True
                        CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).ReadOnly = True
                        CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).ReadOnly = True
                        CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).ReadOnly = True
                        CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).ReadOnly = False
                        CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).ReadOnly = False
                        CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).ReadOnly = False
                        CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).ReadOnly = False
                        CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).ReadOnly = False

                        Tab_Registrazione1.Disabilita()
                        Tab_Canone1.disattiva()

                        Tab_Conduttore1.Disabilita_Tutto()
                        btnAttivaContratto.Visible = False
                        'btnMavAttivazione.Visible = False
                        ImgBolAttivazione.Visible = False
                        speseunita.Value = "0"
                        imgChiudiContratto.Visible = True

                        'max 13/06/2016
                        If Session.Item("MOD_RU_DATI_AE") = "1" Then
                            CType(Tab_Registrazione1.FindControl("txtSerie"), TextBox).ReadOnly = False
                            CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).ReadOnly = False
                            CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).ReadOnly = False
                            CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).ReadOnly = False
                            CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).ReadOnly = False
                            CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).ReadOnly = False
                            CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).ReadOnly = False
                        End If

                        If SolaLettura = "0" Then
                            If par.IfNull(myReader("DATA_DECORRENZA"), "") = par.IfNull(myReader("DATA_DECORRENZA_AE"), "") Then
                                btnStampaContratto.Visible = False
                            Else
                                btnStampaContratto.Visible = True

                                '*************** 08/01/2018 - Segnalazione n.2180/20147 ***************
                                CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).ReadOnly = False
                                CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).ReadOnly = False
                                TipoPosizione = 5
                                ModalitaPagamento = 0
                            End If
                        End If
                End Select






                LBLSTATOC.Visible = True
                LBLSTATOC.Text = "Stato: " & UCase(par.IfNull(myReader("STATO"), ""))

                If TipoContratto = "12" Or TipoContratto = "10" Or TipoContratto = "1" Or TipoContratto = "2" Or TipoContratto = "3" Or TipoContratto = "5" Or TipoContratto = "6" Or TipoContratto = "7" Then

                    CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).ReadOnly = True
                    CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).ReadOnly = True
                    Tab_Contratto1.DisabilitaMeta()

                    'If (TipoContratto = "3" Or TipoContratto = "6") And LBLSTATOC.Text = "Stato: BOZZA" Then
                    '    CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).Enabled = True
                    'End If

                End If

                'TAB CONTRATTO

                CType(Tab_Contratto1.FindControl("txtCodContratto"), TextBox).Text = par.IfNull(myReader("COD_CONTRATTO"), "")
                CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_decorrenza"), ""))
                CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_decorrenza_AE"), ""))
                CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_stipula"), ""))
                CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_scadenza"), ""))
                CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_riconsegna"), ""))
                CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_delibera"), ""))
                'max 18/07/2019
                CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_trasm_delibera"), ""))
                '----------
                CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Text = par.IfNull(myReader("delibera"), "")
                CType(Tab_Contratto1.FindControl("txtDataConsegna"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_consegna"), ""))
                CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_disdetta_locatario"), ""))
                CType(Tab_Contratto1.FindControl("txtNotificaDisdetta"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_notifica_disdetta"), ""))

                CType(Tab_Contratto1.FindControl("txtDataDisdetta0"), TextBox).Text = par.FormattaData(par.IfNull(myReader("DATA_INVIO_RIC_DISDETTA"), ""))
                CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_scadenza_rinnovo"), ""))

                'CType(Tab_Contratto1.FindControl("txtNote"), TextBox).Text = par.IfNull(myReader("note"), "")
                CType(Tab_Contratto1.FindControl("txtEntroCuiDisdettare"), TextBox).Text = par.IfNull(myReader("mesi_disdetta"), "")
                CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).Text = par.IfNull(myReader("durata_anni"), "")
                CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).Text = par.IfNull(myReader("durata_rinnovo"), "")


                ' If LetteraProvenienza = "V" Then
                'CType(Tab_Contratto1.FindControl("txtRifLegislativo"), TextBox).Text = "art. 1571 c.c. e ss."
                'Else
                CType(Tab_Contratto1.FindControl("txtRifLegislativo"), TextBox).Text = par.IfNull(myReader("RIF_LEGISLATIVO"), "")
                'End If


                CType(Tab_Contratto1.FindControl("txtDescrcontratto"), TextBox).Text = par.IfNull(myReader("TIPO_C"), "")



                CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedIndex = -1
                CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).Items.FindByValue(par.IfNull(myReader("COD_TIPOLOGIA_CONTR_LOC"), "")).Selected = True


                CType(Tab_Contratto1.FindControl("cmbForzoso"), DropDownList).SelectedIndex = -1
                CType(Tab_Contratto1.FindControl("cmbForzoso"), DropDownList).Items.FindByValue(par.IfNull(myReader("motivo_rec_forzoso"), "4")).Selected = True

                CType(Tab_Contratto1.FindControl("cmbMittenteDisdetta"), DropDownList).SelectedIndex = -1
                CType(Tab_Contratto1.FindControl("cmbMittenteDisdetta"), DropDownList).Items.FindByValue(par.IfNull(myReader("mittente_disdetta"), "-1")).Selected = True


                CType(Generale1.FindControl("lblTipologia"), Label).Text = CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedItem.Text


                CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedIndex = -1
                Select Case TipoContratto
                    Case "3"
                        CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.FindByValue(par.IfNull(myReader("dest_uso"), "B")).Selected = True
                    Case "6"
                        CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.FindByValue(par.IfNull(myReader("dest_uso"), "0")).Selected = True
                    Case Else
                        CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Items.FindByValue(par.IfNull(myReader("dest_uso"), "0")).Selected = True
                End Select

                If LetteraProvenienza = "V" Then
                    CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).Enabled = False
                End If

                CType(Tab_Contratto1.FindControl("txtDescrDestinazione"), TextBox).Text = par.IfNull(myReader("DESCR_DEST_USO"), "")

                If par.IfNull(myReader("FL_BOLLO_ASSOLTO"), "0") = "0" Then
                    CType(Tab_Contratto1.FindControl("ChBolloEsente"), CheckBox).Checked = False
                Else
                    CType(Tab_Contratto1.FindControl("ChBolloEsente"), CheckBox).Checked = True
                End If

                If par.IfNull(myReader("FL_ASSEGN_TEMP"), "0") = "0" Then
                    CType(Tab_Contratto1.FindControl("chkTemporanea"), CheckBox).Checked = False
                Else
                    CType(Tab_Contratto1.FindControl("chkTemporanea"), CheckBox).Checked = True
                End If

                ' modifiche nuove
                '::::::::::::::::::::::::::::::::::::::::::::

                par.cmd.CommandText = "Select DATA_APP_PRE_SLOGGIO, DATA_APP_RAPPORTO_SLOGGIO FROM SISCOM_MI.SL_SLOGGIO WHERE ID_CONTRATTO = " & lIdContratto

                Dim lettore As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()

                If lettore.Read Then


                    If par.IfNull(lettore("DATA_APP_PRE_SLOGGIO"), "").length >= 8 Then
                        CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Text = par.FormattaData(Mid(par.IfNull(lettore("DATA_APP_PRE_SLOGGIO"), "                 "), 1, 8))
                        CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).Text = Mid(par.IfNull(lettore("DATA_APP_PRE_SLOGGIO"), "          "), 9, 2) & ":" & Mid(par.IfNull(lettore("DATA_APP_PRE_SLOGGIO"), "          "), 11, 2)

                    Else
                        CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Text = ""
                        CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).Text = ""


                    End If



                    If par.IfNull(lettore("DATA_APP_RAPPORTO_SLOGGIO"), "").length >= 8 Then
                        CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Text = par.FormattaData(Mid(par.IfNull(lettore("DATA_APP_RAPPORTO_SLOGGIO"), "                 "), 1, 8))
                        CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).Text = Mid(par.IfNull(lettore("DATA_APP_RAPPORTO_SLOGGIO"), "          "), 9, 2) & ":" & Mid(par.IfNull(lettore("DATA_APP_RAPPORTO_SLOGGIO"), "          "), 11, 2)

                    Else
                        CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Text = ""
                        CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).Text = ""



                    End If



                End If


                lettore.Close()

                '::::::::::::::::::::::::::::::::::::::::::::

                par.cmd.CommandText = "SELECT anagrafica.id,CASE WHEN anagrafica.ragione_sociale is not null THEN ragione_sociale  ELSE RTRIM(LTRIM(COGNOME ||' ' ||NOME)) END AS ""INTESTATARIO"",SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE FROM SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE SOGGETTI_CONTRATTUALI.ID_CONTRATTO=" & lIdContratto & " AND (SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='INTE' or SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='COINT') AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA ORDER BY SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE DESC"
                Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                Do While myReader1.Read
                    If par.IfNull(myReader1("COD_TIPOLOGIA_OCCUPANTE"), "-1") = "INTE" Then
                        Conduttore1 = Conduttore1 & "<a href='#' onclick=" & Chr(34) & "document.getElementById('Generale1_hAnagrafica').value='" & par.IfNull(myReader1("id"), "-1") & "';myOpacity10.toggle();" & Chr(34) & ">" & par.IfNull(myReader1("INTESTATARIO"), "") & " *</a>, "
                        txtCodAffittuario.Value = par.IfNull(myReader1("id"), "-1")
                    Else
                        Conduttore1 = Conduttore1 & "<a href='#' onclick=" & Chr(34) & "document.getElementById('Generale1_hAnagrafica').value='" & par.IfNull(myReader1("id"), "-1") & "';myOpacity10.toggle();" & Chr(34) & ">" & par.IfNull(myReader1("INTESTATARIO"), "") & "</a>, "
                    End If



                    Conduttore = Conduttore & par.IfNull(myReader1("INTESTATARIO"), "") & ", "

                Loop
                myReader1.Close()

                '09/05/2012 CERCO L'INTESTATARIO PRECEDENTE
                par.cmd.CommandText = "SELECT anagrafica.id,CASE WHEN anagrafica.ragione_sociale is not null THEN ragione_sociale  ELSE RTRIM(LTRIM(COGNOME ||' ' ||NOME)) END AS ""INTESTATARIO"",SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE FROM SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE SOGGETTI_CONTRATTUALI.ID_CONTRATTO=" & lIdContratto & " AND SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='EXINTE' AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA ORDER BY SOGGETTI_CONTRATTUALI.DATA_INIZIO DESC"
                myReader1 = par.cmd.ExecuteReader
                If myReader1.Read Then
                    ExConduttore = par.IfNull(myReader1("INTESTATARIO"), "")
                    par.cmd.CommandText = "select count(*) from siscom_mi.rapporti_utenza where id=" & lIdContratto & " and  cod_tipologia_contr_loc='USD' AND dest_uso='N'"
                    Dim ris As Integer = par.IfNull(par.cmd.ExecuteScalar, 0)
                    If ris = 0 Then
                        CType(Tab_Canone1.FindControl("HLink_SchedaDep"), HyperLink).Attributes.Add("onClick", "javascript:document.getElementById('USCITA').value='1';window.open('DepositoCauzionale.aspx?IDC=" & lIdContratto & "&IDI=" & txtCodAffittuario.Value & "', 'DepCauzInte','height=600,width=800,top=0,left=0');")
                    Else
                        CType(Tab_Canone1.FindControl("HLink_SchedaDep"), HyperLink).Attributes.Add("onClick", "javascript:document.getElementById('USCITA').value='1';window.open('DepositoCauzionaleInte.aspx?IDC=" & lIdContratto & "', 'DepCauz','height=600,width=800,top=0,left=0');")
                    End If
                Else
                    ExConduttore = "---"
                    par.cmd.CommandText = "select count(*) from siscom_mi.rapporti_utenza where id=" & lIdContratto & " and  cod_tipologia_contr_loc='USD' AND dest_uso='N'"
                    Dim ris As Integer = par.IfNull(par.cmd.ExecuteScalar, 0)
                    If ris = 0 Then
                        CType(Tab_Canone1.FindControl("HLink_SchedaDep"), HyperLink).Attributes.Add("onClick", "javascript:document.getElementById('USCITA').value='1';window.open('DepositoCauzionale.aspx?IDC=" & lIdContratto & "&IDI=" & txtCodAffittuario.Value & "', 'DepCauzInte','height=600,width=800,top=0,left=0');")
                    Else
                        CType(Tab_Canone1.FindControl("HLink_SchedaDep"), HyperLink).Attributes.Add("onClick", "javascript:document.getElementById('USCITA').value='1';window.open('DepositoCauzionaleUSD.aspx?IDC=" & lIdContratto & "&IDI=" & txtCodAffittuario.Value & "', 'DepCauzInte','height=600,width=800,top=0,left=0');")
                    End If
                    'scriptblock = "<script language='javascript' type='text/javascript'>" _
                    '& "document.getElementById('Generale1_imgCrono').style.visibility = 'hidden';" _
                    '& "</script>"
                    'If (Not Page.ClientScript.IsClientScriptBlockRegistered("clientScript4")) Then
                    '    Page.ClientScript.RegisterClientScriptBlock(Me.GetType(), "clientScript4", scriptblock)
                    'End If
                End If
                myReader1.Close()

                If Len(ExConduttore) >= 30 Then
                    CType(Generale1.FindControl("lblExcondutt"), Label).Font.Size = 7
                End If
                CType(Generale1.FindControl("lblExcondutt"), Label).Text = ExConduttore
                '09/05/2012 fine CERCO L'INTESTATARIO PRECEDENTE

                If Len(Conduttore) > 40 Then
                    CType(Generale1.FindControl("lblConduttore"), Label).Font.Size = 8
                End If

                CType(Generale1.FindControl("lblConduttore"), Label).Text = Conduttore1
                txtconduttore.Value = Replace(Conduttore, "<br />", ", ")


                'CType(Generale1.FindControl("Label20"), Label).Text = "Saldo al " & Format(Now, "dd/MM/yyyy")
                'CType(Generale1.FindControl("lblSaldoAttuale"), Label).Text = "<a href='#' onclick=" & Chr(34) & "javascript:window.open('../Contabilita/DatiUtenza.aspx?C=RisUtenza&IDANA=" & txtCodAffittuario.Value & "&IDCONT=" & lIdContratto & "','EstrattoConto','');" & Chr(34) & " alt='Visualizza Dettagli'>" & Format(par.CalcolaSaldoAttuale(lIdContratto), "##,##0.00") & " Euro</a>"



                par.cmd.CommandText = "select COMUNI_NAZIONI.SIGLA,COMUNI_NAZIONI.NOME AS ""COMUNE_DI"",unita_contrattuale.*,tipologia_unita_immobiliari.descrizione as ""tipo"" from SEPA.COMUNI_NAZIONI,siscom_mi.tipologia_unita_immobiliari,siscom_mi.unita_contrattuale where COMUNI_NAZIONI.COD=UNITA_CONTRATTUALE.COD_COMUNE AND tipologia_unita_immobiliari.cod=unita_contrattuale.tipologia and id_contratto=" & lIdContratto & "  and id_unita_principale is null order by tipologia asc"
                myReader1 = par.cmd.ExecuteReader()
                If myReader1.Read Then
                    CType(Generale1.FindControl("lblCodUnita"), Label).Text = par.IfNull(myReader1("cod_unita_immobiliare"), "")
                    CType(Generale1.FindControl("lblIndirizzo"), Label).Text = par.IfNull(myReader1("COMUNE_DI"), "") & " (" & par.IfNull(myReader1("SIGLA"), "") & ") " & "CAP " & par.IfNull(myReader1("cap"), "") & " " & par.IfNull(myReader1("indirizzo"), "") & ", " & par.IfNull(myReader1("civico"), "") '
                    CType(Generale1.FindControl("lblTipoImmobile"), Label).Text = par.IfNull(myReader1("Tipo"), "")
                    'CType(Generale1.FindControl("lblConvenzionale"), Label).Text = par.IfNull(myReader1("sup_convenzionale"), "")
                    CType(Generale1.FindControl("lblComplessoEdificio"), Label).Attributes.Add("onclick", "javascript:window.open('DatiComplessoEdificio.aspx?COD=" & par.IfNull(myReader1("cod_unita_immobiliare"), "") & "','Dati','');")


                    VAL_LOCATIVO_UNITA = par.IfNull(myReader1("VAL_LOCATIVO_UNITA"), "0,00")
                End If
                myReader1.Close()


                If Mid(CType(Generale1.FindControl("lblCodUnita"), Label).Text, 1, 6) = "000000" Then
                    LBLVIRTUALE.Visible = True
                    VIRTUALE.Value = "1"
                End If


                'CARICO UNITA PRINCIPALI IN TABELLA

                testoTabella = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                & "<tr>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>COD.UNITA</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>FOGLIO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>MAPPALE</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>SUB</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>TIPO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>INDIRIZZO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>PIANO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>SCALA</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>INTERNO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "</td>" _
                & "<td style='height: 19px'>" _
                & "</td>" _
                & "</tr>"


                par.cmd.CommandText = "select TIPO_LIVELLO_PIANO.DESCRIZIONE AS ""PIANO"",unita_contrattuale.*,tipologia_unita_immobiliari.descrizione as ""tipo"" from SISCOM_MI.TIPO_LIVELLO_PIANO,siscom_mi.tipologia_unita_immobiliari,siscom_mi.unita_contrattuale where TIPO_LIVELLO_PIANO.COD (+)=UNITA_CONTRATTUALE.COD_TIPO_LIVELLO_PIANO  AND tipologia_unita_immobiliari.cod=unita_contrattuale.tipologia and id_contratto=" & lIdContratto & " AND (ID_UNITA_PRINCIPALE IS NULL) order by tipologia asc"
                myReader1 = par.cmd.ExecuteReader()
                Do While myReader1.Read
                    testoTabella = testoTabella _
                            & "<tr>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'><a href='#' onclick=" & Chr(34) & "if (document.getElementById('txtModificato').value == '1') {alert('Attenzione...Sono state apportate delle modifiche. Salvare prima di proseguire!');}else {document.getElementById('USCITA').value='1';window.open('../CENSIMENTO/InserimentoUniImmob.aspx?F=" & lIdConnessione & "&X=1&LE=1&ID=" & par.IfNull(myReader1("ID_UNITA"), "") & "','Dettagli','height=580,top=0,left=0,width=780');}" & Chr(34) & ">" & par.IfNull(myReader1("cod_unita_immobiliare"), "") & "</a></span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("FOGLIO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("NUMERO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SUB"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("TIPO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INDIRIZZO"), "") & "," & par.IfNull(myReader1("CIVICO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("PIANO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SCALA"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INTERNO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "</td>" _
                            & "<td style='height: 19px'>" _
                            & "</td>" _
                            & "</tr>"

                    sPiano = par.IfNull(myReader1("PIANO"), "")
                    sInterno = par.IfNull(myReader1("INTERNO"), "")
                    sSCALA = par.IfNull(myReader1("SCALA"), "")
                    sFoglio = par.IfNull(myReader1("FOGLIO"), "")
                    sParticella = par.IfNull(myReader1("NUMERO"), "")
                    sSub = par.IfNull(myReader1("sub"), "")
                    UnitaContratto = par.IfNull(myReader1("ID_UNITA"), "")
                    txtIdUnita.Value = CStr(UnitaContratto)
                    sCatastale = par.IfNull(myReader1("cod_categoria_catastale"), "")
                    sRendita = par.IfNull(myReader1("rendita"), "")
                    sClasse = par.IfNull(myReader1("cod_classe_catastale"), "")
                    sIdEdificio = par.IfNull(myReader1("id_edificio"), "")
                    CType(Tab_SchemaBollette1.FindControl("txtIdUnita"), HiddenField).Value = CStr(UnitaContratto)

                    'Generale1.IndiceAnagrafe = "-1"
                    'par.cmd.CommandText = "select id FROM UTENZA_DICHIARAZIONI WHERE COD_ALLOGGIO='" & par.IfNull(myReader1("cod_unita_immobiliare"), "-1") & "' AND POSIZIONE='" & CType(Tab_Contratto1.FindControl("txtCodContratto"), TextBox).Text & "'"
                    'Dim myReaderS1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    'If myReaderS1.Read Then
                    '    Generale1.IndiceAnagrafe = myReaderS1(0)
                    'End If
                    'myReaderS1.Close()


                Loop
                myReader1.Close()
                CType(Tab_UnitaImmLocate1.FindControl("TBL_UNITA_ALLOCATE"), Label).Text = testoTabella & "</table>"

                'LetteraERP = "A"
                'If TipoContratto = "1" Then
                '    LetteraERP = "A"
                '    par.cmd.CommandText = "SELECT canoni_ui.canone FROM siscom_mi.canoni_ui,SISCOM_MI.unita_immobiliari where unita_immobiliari.id=canoni_ui.id and  unita_immobiliari.id_destinazione_uso=2 and unita_immobiliari.id=" & UnitaContratto & " order by canoni_ui.data desc"
                '    Dim myReaderAA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                '    If myReaderAA.Read Then
                '        LetteraERP = "B"
                '        LBLErpModerato.Visible = True
                '    End If
                '    myReaderAA.Close()
                'End If
                LetteraERP = "A"
                If TipoContratto = "1" Then
                    LetteraERP = "A"
                    par.cmd.CommandText = "SELECT ID_DESTINAZIONE_USO FROM SISCOM_MI.unita_immobiliari where unita_immobiliari.id=" & UnitaContratto
                    Dim myReaderAA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderAA.Read Then
                        If par.IfNull(myReaderAA("ID_DESTINAZIONE_USO"), "") = "2" Then
                            LetteraERP = "B"
                            LBLErpModerato.Visible = True
                        End If
                    End If
                    myReaderAA.Close()
                End If


                'CARICO PERTINENZE

                testoTabella = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                & "<tr>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>COD.UNITA</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>FOGLIO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>MAPPALE</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>SUB</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>TIPO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>INDIRIZZO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>PIANO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>SCALA</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>INTERNO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "</td>" _
                & "<td style='height: 19px'>" _
                & "</td>" _
                & "</tr>"


                par.cmd.CommandText = "select TIPO_LIVELLO_PIANO.DESCRIZIONE AS ""PIANO"",unita_contrattuale.*,tipologia_unita_immobiliari.descrizione as ""tipo"" from SISCOM_MI.TIPO_LIVELLO_PIANO,siscom_mi.tipologia_unita_immobiliari,siscom_mi.unita_contrattuale where TIPO_LIVELLO_PIANO.COD=UNITA_CONTRATTUALE.COD_TIPO_LIVELLO_PIANO AND tipologia_unita_immobiliari.cod=unita_contrattuale.tipologia and id_contratto=" & lIdContratto & " AND (ID_UNITA_PRINCIPALE IS NOT NULL) order by tipologia asc"
                myReader1 = par.cmd.ExecuteReader()
                Do While myReader1.Read
                    testoTabella = testoTabella _
                            & "<tr>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'><a href='#' onclick=" & Chr(34) & "if (document.getElementById('txtModificato').value == '1') {alert('Attenzione...Sono state apportate delle modifiche. Salvare prima di proseguire!');}else {document.getElementById('USCITA').value='1';window.open('../CENSIMENTO/InserimentoUniImmob.aspx?F=" & lIdConnessione & "&X=1&LE=1&ID=" & par.IfNull(myReader1("ID_UNITA"), "") & "','Dettagli','height=580,top=0,left=0,width=780');}" & Chr(34) & ">" & par.IfNull(myReader1("cod_unita_immobiliare"), "") & "</a></span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("FOGLIO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("NUMERO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SUB"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("TIPO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INDIRIZZO"), "") & "," & par.IfNull(myReader1("CIVICO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("PIANO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SCALA"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INTERNO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "</td>" _
                            & "<td style='height: 19px'>" _
                            & "</td>" _
                            & "</tr>"
                Loop
                myReader1.Close()
                CType(Tab_UnitaImmLocate1.FindControl("TBL_PERTINENZE_ALLOCATE"), Label).Text = testoTabella & "</table>"

                par.cmd.CommandText = "select VALORE from SISCOM_MI.DIMENSIONI_unita_contrattuale where ID_CONTRATTO=" & lIdContratto & " AND ID_UNITA=" & UnitaContratto & " AND COD_TIPOLOGIA='SUP_CONV'"
                myReader1 = par.cmd.ExecuteReader()
                If myReader1.Read Then
                    CType(Generale1.FindControl("lblConvenzionale"), Label).Text = par.IfNull(myReader1("VALORE"), "")
                End If
                myReader1.Close()

                DataDisponibilitaAlloggio = ""
                Select Case CType(Generale1.FindControl("lblStato"), Label).Text
                    Case "BOZZA"
                        If TipoContratto <> "10" Then
                            'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where generato_contratto='1' and id_domanda=" & lIdDomandaERP & " and id_unita=" & UnitaContratto & " order by data_assegnazione desc"
                            'Dim myReaderAA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            'If myReaderAA.Read Then
                            '    DataDisponibilitaAlloggio = par.IfNull(myReaderAA("data_disponibilita"), "")
                            'End If
                            'myReaderAA.Close()

                            par.cmd.CommandText = "SELECT * FROM alloggi where cod_alloggio='" & Mid(CodContratto1, 1, 17) & "'"
                            Dim myReaderAA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            If myReaderAA.Read Then
                                DataDisponibilitaAlloggio = par.IfNull(myReaderAA("data_disponibilita"), "")
                            End If
                            myReaderAA.Close()

                            If DataDisponibilitaAlloggio = "" Then
                                par.cmd.CommandText = "SELECT * FROM siscom_mi.ui_usi_diversi where cod_alloggio='" & Mid(CodContratto1, 1, 17) & "'"
                                myReaderAA = par.cmd.ExecuteReader()
                                If myReaderAA.Read Then
                                    DataDisponibilitaAlloggio = par.IfNull(myReaderAA("data_disponibilita"), "")
                                End If
                                myReaderAA.Close()
                            End If


                        Else
                            DataDisponibilitaAlloggio = ""
                        End If
                        If CaricaSpese(True) = True Then
                            speseunita.Value = "0"
                        Else
                            speseunita.Value = "1"
                        End If
                        CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Enabled = True
                    Case Else
                        CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Enabled = False
                End Select


            End If

            CaricaCompContratto(lIdContratto)
            ''CARICAMENTO INTESTATARI
            'par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.data_inizio,SOGGETTI_CONTRATTUALI.data_fine,TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",ANAGRAFICA.* FROM SISCOM_MI.TIPOLOGIA_PARENTELA,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE TIPOLOGIA_PARENTELA.COD=SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_PARENTELA AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND  COD_TIPOLOGIA_OCCUPANTE='INTE' AND ID_CONTRATTO=" & lIdContratto
            'Dim myReader2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            'Do While myReader2.Read
            '    If par.IfNull(myReader2("RAGIONE_SOCIALE"), "") <> "" Then
            '        CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("RAGIONE_SOCIALE"), ""), 37) & " " & par.MiaFormat(par.IfNull(myReader2("PARTITA_IVA"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
            '    Else
            '        CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReader2("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReader2("COD_FISCALE"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
            '    End If
            'Loop
            'myReader2.Close()


            ''CARICAMENTO COINTESTATARI
            'par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.data_inizio,SOGGETTI_CONTRATTUALI.data_fine,TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",ANAGRAFICA.* FROM SISCOM_MI.TIPOLOGIA_PARENTELA,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE TIPOLOGIA_PARENTELA.COD=SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_PARENTELA AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND  COD_TIPOLOGIA_OCCUPANTE='COINT' AND ID_CONTRATTO=" & lIdContratto
            'myReader2 = par.cmd.ExecuteReader()
            'Do While myReader2.Read
            '    If par.IfNull(myReader2("RAGIONE_SOCIALE"), "") <> "" Then
            '        CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("RAGIONE_SOCIALE"), ""), 37) & " " & par.MiaFormat(par.IfNull(myReader2("PARTITA_IVA"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
            '    Else
            '        CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReader2("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReader2("COD_FISCALE"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
            '    End If
            'Loop
            'myReader2.Close()

            ''CARICAMENTO OCCUPANTI
            'par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.data_inizio,SOGGETTI_CONTRATTUALI.data_fine,SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE,TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",ANAGRAFICA.* FROM SISCOM_MI.TIPOLOGIA_PARENTELA,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE TIPOLOGIA_PARENTELA.COD=SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_PARENTELA AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND  COD_TIPOLOGIA_OCCUPANTE<>'INTE' AND COD_TIPOLOGIA_OCCUPANTE<>'COINT' AND ID_CONTRATTO=" & lIdContratto & " order by anagrafica.cognome asc,anagrafica.nome asc,SOGGETTI_CONTRATTUALI.data_inizio"
            'myReader2 = par.cmd.ExecuteReader()
            'Do While myReader2.Read
            '    'If par.IfNull(myReader2("COGNOME"), "") = "" And par.IfNull(myReader2("NOME"), "") = "" And par.IfNull(myReader2("RAGIONE_SOCIALE"), "") <> "" Then
            '    '    CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("RAGIONE_SOCIALE"), ""), 37) & " " & par.MiaFormat(par.IfNull(myReader2("PARTITA_IVA"), ""), 16) & " " & UCase(par.IfNull(myReader2("PARENTE"), "")), myReader2("ID")))
            '    'Else
            '    '    CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReader2("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReader2("COD_FISCALE"), ""), 16) & " " & UCase(par.IfNull(myReader2("PARENTE"), "")), myReader2("ID")))
            '    'End If
            '    If par.IfNull(myReader2("RAGIONE_SOCIALE"), "") <> "" Then
            '        If par.IfNull(myReader2("COD_TIPOLOGIA_OCCUPANTE"), "") = "EXINTE" Then
            '            '<span style="color:#CC3300">
            '            CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("RAGIONE_SOCIALE"), ""), 37) & " " & par.MiaFormat(par.IfNull(myReader2("PARTITA_IVA"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))

            '        Else
            '            CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("RAGIONE_SOCIALE"), ""), 37) & " " & par.MiaFormat(par.IfNull(myReader2("PARTITA_IVA"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))

            '        End If
            '    Else
            '        If par.IfNull(myReader2("COD_TIPOLOGIA_OCCUPANTE"), "") = "EXINTE" Then
            '            CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReader2("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReader2("COD_FISCALE"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
            '        Else
            '            CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReader2("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReader2("COD_FISCALE"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))

            '        End If
            '    End If

            'Loop
            'myReader2.Close()


            'caricamento altre domande in corso...
            'CaricaDomandeInCorso()



            ''CARICAMENTO OSPITI
            'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.OSPITI WHERE ID_CONTRATTO=" & lIdContratto & " ORDER BY DATA_AGG DESC"
            'myReader2 = par.cmd.ExecuteReader()
            'Do While myReader2.Read
            '    'CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Add(New ListItem(par.MiaFormat(Format(myReader2("NRO_OSPITI"), "00"), 2) & " " & par.MiaFormat(par.FormattaData(myReader2("DATA_INIZIO_OSPITE")), 15) & " " & par.FormattaData(myReader2("DATA_FINE_OSPITE")), myReader2("ID")))
            '    CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("nominativo"), ""), 30) & " " & par.MiaFormat(par.IfNull(myReader2("cod_fiscale"), ""), 16) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio_ospite"), "")), 15) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_fine_ospite"), "")), 15), myReader2("ID")))
            'Loop
            'myReader2.Close()
            'CARICAMENTO TAB REGISTRAZIONE
            CType(Tab_Registrazione1.FindControl("cmbUfficioRegistro"), DropDownList).SelectedIndex = -1
            CType(Tab_Registrazione1.FindControl("cmbUfficioRegistro"), DropDownList).Items.FindByValue(par.IfNull(myReader("cod_ufficio_reg"), -1)).Selected = True

            CType(Tab_Registrazione1.FindControl("txtSerie"), TextBox).Text = par.IfNull(myReader("serie_registrazione"), "")
            CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Text = par.IfNull(myReader("num_registrazione"), "")
            CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_reg"), ""))
            CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).Text = par.IfNull(myReader("nro_repertorio"), "")
            CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_repertorio"), ""))
            CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Text = par.IfNull(myReader("nro_assegnazione_pg"), "")
            CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_assegnazione_pg"), ""))

            'MAX 17/07/2015
            'CType(Tab_Registrazione1.FindControl("txtNotereg"), TextBox).Text = par.IfNull(myReader("note_registrazione"), "")
            par.CaricaStoricoNote(lIdContratto, CType(Tab_Contratto1.FindControl("DataGridNote"), DataGrid), "1")

            If TipoContratto <> "7" Then
                CType(Tab_Registrazione1.FindControl("txtPercTotSu"), Label).Text = par.IfNull(myReader("perc_tr_canone"), "")
                CType(Tab_Registrazione1.FindControl("txtPercConduttore"), Label).Text = par.IfNull(myReader("perc_conduttore"), "")
                CType(Tab_Registrazione1.FindControl("txtPercLocatore"), Label).Text = 100 - par.IfNull(myReader("perc_conduttore"), "0")
            Else
                CType(Tab_Registrazione1.FindControl("txtPercTotSu"), Label).Text = "0"
                CType(Tab_Registrazione1.FindControl("txtPercConduttore"), Label).Text = "0"
                CType(Tab_Registrazione1.FindControl("txtPercLocatore"), Label).Text = "0"

            End If
            CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).SelectedIndex = -1
            CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Items.FindByValue(par.IfNull(myReader("VERSAMENTO_TR"), "A")).Selected = True




            'CanoneCorrente = par.IfNull(myReader("imp_canone_iniziale"), 0)

            'par.cmd.CommandText = "SELECT SUM(IMPORTO_TR_AGG) FROM SISCOM_MI.ADEGUAMENTO_ISTAT WHERE ID_CONTRATTO=" & lIdContratto
            'Dim myReaderX As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            'If myReaderX.Read Then
            '    CanoneCorrente = CanoneCorrente + par.IfNull(myReaderX(0), 0)
            'End If
            'myReaderX.Close()

            'Select Case CType(Generale1.FindControl("lblStato"), Label).Text
            '    Case "BOZZA"
            '        If TASSA_REGISTRAZIONE = LimiteTassaRegistrazione Then
            '            If par.SoluzioneUnica(CDbl(CanoneCorrente), CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).Text) <= LimiteTassaRegistrazione Then
            '                CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Items.FindByValue("U").Selected = True
            '                CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Enabled = False
            '            Else
            '                CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Items.FindByValue("A").Selected = True
            '            End If
            '        Else
            '            CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Items.FindByValue("A").Selected = True
            '        End If
            'End Select

            VerificaRibaltamSpese(lIdContratto)

            Dim TASSA_REGISTRAZIONE As Double = 0
            If TipoContratto <> "7" Then
                If CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Text <> "" Then

                    If DateDiff(DateInterval.Month, CDate(CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Text), CDate(Format(Now, "dd/MM/yyyy"))) <= 12 Or CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).SelectedItem.Value = "A" Then

                        TASSA_REGISTRAZIONE = Format((CType(Tab_Registrazione1.FindControl("txtPercTotSu"), Label).Text * CanoneCorrente) / 100, "0")

                        If TipoContratto = "6" And (CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Text = "STANDARD" Or CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Text = "431 P.O.R.") Then
                            TASSA_REGISTRAZIONE = Format((CType(Tab_Registrazione1.FindControl("txtPercTotSu"), Label).Text * (CanoneCorrente - ((30 / 100) * CanoneCorrente))) / 100, "0")
                            CType(Tab_Registrazione1.FindControl("Label18"), Label).Text = "RIPARTIZIONE IMPOSTA DI REGISTRAZIONE (contratto agevolato ai sensi dell'art. 2, comma 3)"
                        End If

                        If TASSA_REGISTRAZIONE > LimiteTassaRegistrazione Then
                            CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text = Format(TASSA_REGISTRAZIONE, "0.00")
                            CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercConduttore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                            CType(Tab_Registrazione1.FindControl("lblRegLoc"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercLocatore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                        Else
                            TASSA_REGISTRAZIONE = LimiteTassaRegistrazione
                            CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text = Format(TASSA_REGISTRAZIONE, "0.00")
                            CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercConduttore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                            CType(Tab_Registrazione1.FindControl("lblRegLoc"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercLocatore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                        End If
                    Else
                        TASSA_REGISTRAZIONE = Format((CType(Tab_Registrazione1.FindControl("txtPercTotSu"), Label).Text * CanoneCorrente) / 100, "0")

                        If TipoContratto = "6" And (CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Text = "STANDARD" Or CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Text = "431 P.O.R.") Then
                            TASSA_REGISTRAZIONE = Format((CType(Tab_Registrazione1.FindControl("txtPercTotSu"), Label).Text * (CanoneCorrente - ((30 / 100) * CanoneCorrente))) / 100, "0")
                            CType(Tab_Registrazione1.FindControl("Label18"), Label).Text = "RIPARTIZIONE IMPOSTA DI REGISTRAZIONE (contratto agevolato ai sensi dell'art. 2, comma 3)"
                        End If

                        If TASSA_REGISTRAZIONE > LimiteTassaRegistrazione Then
                            CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text = Format(TASSA_REGISTRAZIONE, "0.00")
                            CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercConduttore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                            CType(Tab_Registrazione1.FindControl("lblRegLoc"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercLocatore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                        Else
                            TASSA_REGISTRAZIONE = LimiteTassaRegistrazione
                            CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text = Format(TASSA_REGISTRAZIONE, "0.00")
                            CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercConduttore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                            CType(Tab_Registrazione1.FindControl("lblRegLoc"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercLocatore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                        End If

                    End If
                Else
                    TASSA_REGISTRAZIONE = LimiteTassaRegistrazione
                    CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text = Format(TASSA_REGISTRAZIONE, "0.00")
                    CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercConduttore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")
                    CType(Tab_Registrazione1.FindControl("lblRegLoc"), Label).Text = Format((CType(Tab_Registrazione1.FindControl("txtPercLocatore"), Label).Text * TASSA_REGISTRAZIONE) / 100, "0.00")

                End If
            Else
                TASSA_REGISTRAZIONE = 0
                CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text = Format(TASSA_REGISTRAZIONE, "0.00")
                CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text = "0,00"
                CType(Tab_Registrazione1.FindControl("lblRegLoc"), Label).Text = "0,00"

            End If


            '31/03/2015 Controllo il flag del rimborso cauzionale SE è STATO fatto un cambio tipologia contrattuale
            par.cmd.CommandText = "SELECT * from siscom_mi.GESTIONE_CAMBIO_TIPO_CONTR where id_contratto_origine=" & lIdContratto
            Dim myReaderDP As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderDP.Read Then
                If par.IfNull(myReaderDP("FL_CAUZ_DA_RESTITUIRE"), 0) = "1" And par.IfNull(myReaderDP("FL_CAUZ_RESTITUITA"), 0) = "0" Then
                    CType(Generale1.FindControl("lblAlertCauz"), Label).Visible = True
                Else
                    CType(Generale1.FindControl("lblAlertCauz"), Label).Visible = False
                End If
            End If
            myReaderDP.Close()
            'Fine 31/03/2015

            '31/03/2015 Controllo il flag dei dati di registrazione fiscale
            par.cmd.CommandText = "SELECT * from siscom_mi.GESTIONE_CAMBIO_TIPO_CONTR where id_contratto_nuovo=" & lIdContratto
            myReaderDP = par.cmd.ExecuteReader()
            If myReaderDP.Read Then
                If par.IfNull(myReaderDP("FL_IMPORT_DATI_REGISTR"), 0) = "1" Then
                    CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text = "0,00"
                    CType(Tab_Registrazione1.FindControl("lblRegLoc"), Label).Text = "0,00"
                End If
            End If
            myReaderDP.Close()
            'Fine 31/03/2015
            'CARICAMENTO TAB CANONE

            CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text = Format(par.IfNull(myReader("imp_canone_iniziale"), 0), "0.00")

            CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Text = Format(par.IfNull(CanoneCorrente, 0), "0.00")
            'CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Text = Format(par.IfNull(myReader("imp_canone_iniziale"), 0), "0.00")

            CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text = Format(par.IfNull(myReader("imp_DEPOSITO_CAUZ"), 0), "0.00")
            CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text = Format(par.IfNull(myReader("IMPORTO_ANTICIPO"), 0), "0.00")
            CType(Tab_Canone1.FindControl("txtLibrettoDeposito"), TextBox).Text = par.IfNull(myReader("LIBRETTO_DEPOSITO"), "")

            CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedIndex = -1
            CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).Items.FindByValue(par.IfNull(myReader("NRO_RATE"), "4")).Selected = True

            CType(Tab_Canone1.FindControl("cmbDestRate"), DropDownList).SelectedIndex = -1
            CType(Tab_Canone1.FindControl("cmbDestRate"), DropDownList).Items.FindByValue(par.IfNull(myReader("id_dest_rate"), "1")).Selected = True


            CType(Tab_Canone1.FindControl("lblistat2"), DropDownList).SelectedIndex = -1
            CType(Tab_Canone1.FindControl("lblistat2"), DropDownList).Items.FindByValue(par.IfNull(myReader("freq_var_istat"), "A")).Selected = True

            CType(Tab_Canone1.FindControl("lblistat4"), DropDownList).SelectedIndex = -1
            CType(Tab_Canone1.FindControl("lblistat4"), DropDownList).Items.FindByValue(par.IfNull(myReader("perc_istat"), "0")).Selected = True


            If par.IfNull(myReader("interessi_rit_pag"), "0") = "0" Then
                CType(Tab_Canone1.FindControl("chRitardoPagamenti"), CheckBox).Checked = False
            Else
                CType(Tab_Canone1.FindControl("chRitardoPagamenti"), CheckBox).Checked = True
            End If

            If par.IfNull(myReader("interessi_cauzione"), "0") = "0" Then
                CType(Tab_Canone1.FindControl("checkInteressiCauzione"), CheckBox).Checked = False
            Else
                CType(Tab_Canone1.FindControl("checkInteressiCauzione"), CheckBox).Checked = True
            End If

            If par.IfNull(myReader("fl_conguaglio"), "0") = "0" Then
                CType(Tab_Canone1.FindControl("checkConguaglioBoll"), CheckBox).Checked = False
            Else
                CType(Tab_Canone1.FindControl("checkConguaglioBoll"), CheckBox).Checked = True
            End If

            If par.IfNull(myReader("invio_bolletta"), "0") = "0" Then
                CType(Tab_Canone1.FindControl("checkInvioBoll"), CheckBox).Checked = False
            Else
                CType(Tab_Canone1.FindControl("checkInvioBoll"), CheckBox).Checked = True
            End If




            If TipoContratto <> "12" And TipoContratto <> "3" And TipoContratto <> "6" And TipoContratto <> "7" And LetteraERP <> "B" And TipoContratto <> "10" Then
                If CType(Generale1.FindControl("lblStato"), Label).Text <> "BOZZA" Then
                    'SE NON è BOZZA CARICO DAL DB



                    CaricaDettCanoni(lIdContratto)

                Else

                    testoTabella = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                                    & "<tr>" _
                                    & "<td style='height: 15px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><strong>DATA CALCOLO</strong></span></td>" _
                                    & "<td style='height: 15px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><strong>AREA ECONOMICA</strong></span></td>" _
                                    & "<td style='height: 15px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><strong>CLASSE</strong></span></td>" _
                                    & "<td style='height: 15px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><strong>DATA VALIDITA'</strong></span></td>" _
                                    & "<td style='height: 15px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><strong>CANONE</strong></span></td>" _
                                    & "<td style='height: 15px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><strong>ORIGINE</strong></span></td>" _
                                    & "<td style='height: 15px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><strong></strong></span></td>" _
                                    & "</tr>"


                    testoTabella = testoTabella _
                            & "<tr>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & Format(Now, "dd/MM/yyyy") & "</span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'></span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'></span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'></span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'></span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'></span></td>" _
                            & "<td style='height: 15px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'></span></td>" _
                            & "</tr>"


                    CType(Tab_Canone1.FindControl("lblDettaglioCanoni"), Label).Text = testoTabella & "</table>"

                End If
            Else
                If TipoContratto = "10" Then
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.unita_assegnate where PROVENIENZA='Z' and id_DICHIARAZIONE=" & lIdDichiarazione
                    Dim myReaderAA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderAA.Read Then

                        TIPO_CANONE_APPLICATO = par.IfNull(myReaderAA("TIPO_APPLICATO"), "")
                        CANONE_ALTERNATIVO = par.IfNull(myReaderAA("CANONE_ALT"), "0")

                        CType(Tab_Canone1.FindControl("label4"), Label).Text = "E' STATO APPLICATO IL CANONE " & TIPO_CANONE_APPLICATO & ", IL CANONE ALTERNATIVO SAREBBE STATO PARI A EURO " & CANONE_ALTERNATIVO
                        CType(Tab_Canone1.FindControl("ImgRicalcolaC"), ImageButton).Visible = False

                    End If
                    myReaderAA.Close()

                    CaricaDettCanoni(lIdContratto)
                End If

                If TipoContratto = "6" And (par.IfNull(myReader("dest_uso"), "0") = "D" Or par.IfNull(myReader("dest_uso"), "0") = "V") Then
                    CaricaDettCanoni(lIdContratto)
                End If

            End If
            If TipoContratto = "1" Or TipoContratto = "12" Or TipoContratto = "10" Or TipoContratto = "5" Then
                CType(Tab_Conduttore1.FindControl("lblElencoComponenti"), Label).Text = DettaglioComponenti()
            Else
                CType(Tab_Conduttore1.FindControl("lblElencoComponenti"), Label).Text = ""
            End If

            'CARICO TAB COMUNICAZIONI
            CType(Tab_Comunicazioni1.FindControl("cmbTipoViaCor"), DropDownList).SelectedIndex = -1
            CType(Tab_Comunicazioni1.FindControl("cmbTipoViaCor"), DropDownList).Items.FindByText(Trim(par.IfNull(myReader("TIPO_COR"), "VIA"))).Selected = True

            CType(Tab_Comunicazioni1.FindControl("cmbCommissariato"), DropDownList).SelectedIndex = -1
            CType(Tab_Comunicazioni1.FindControl("cmbCommissariato"), DropDownList).Items.FindByValue(par.IfNull(myReader("ID_COMMISSARIATO"), "NULL")).Selected = True


            CType(Tab_Comunicazioni1.FindControl("txtPresso"), TextBox).Text = par.IfNull(myReader("PRESSO_COR"), "")
            CType(Tab_Comunicazioni1.FindControl("txtViaCor"), TextBox).Text = par.IfNull(myReader("VIA_COR"), "")
            CType(Tab_Comunicazioni1.FindControl("txtCivicoCor"), TextBox).Text = par.IfNull(myReader("CIVICO_COR"), "")
            CType(Tab_Comunicazioni1.FindControl("txtCAPCOR"), TextBox).Text = par.IfNull(myReader("CAP_COR"), "")
            CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text = par.IfNull(myReader("LUOGO_COR"), "")
            CType(Tab_Comunicazioni1.FindControl("txtSiglaCor"), TextBox).Text = par.IfNull(myReader("SIGLA_COR"), "")
            'max 23/01/2018
            CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Text = par.IfNull(myReader("MAIL_COR"), "")
            CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Text = par.IfNull(myReader("MAIL_PEC_COR"), "")

            '15/11/2016 Scala-Piano-Interno SD 1619/2016
            CType(Tab_Comunicazioni1.FindControl("txtScalaCor"), TextBox).Text = par.IfNull(myReader("SCALA_COR"), "")
            CType(Tab_Comunicazioni1.FindControl("txtPianoCor"), TextBox).Text = par.IfNull(myReader("PIANO_COR"), "")
            CType(Tab_Comunicazioni1.FindControl("txtInternoCor"), TextBox).Text = par.IfNull(myReader("INTERNO_COR"), "")

            If par.IfNull(myReader("FL_IRREPERIBILE"), 0) = 1 Then
                CType(Tab_Comunicazioni1.FindControl("chkIrreperibile"), CheckBox).Checked = True
            End If


            'CaricaSchemaBolletta(lIdContratto)
            CaricaSchemaBoll()
            'Dim I As Integer = 0
            ''CARICAMENTO schema bollette
            'CType(Tab_SchemaBollette1.FindControl("Label4"), Label).Text = "SCHEMA VOCI BOLLETTA" & " " & sAnnoSchema & "  -  <a href='SchemaAltriAnni.aspx?CN=" & lIdConnessione & "&ID=" & lIdContratto & "&A=" & sAnnoSchema & "' target='_blank'>Clicca qui per visualizzare lo schema di altri anni</a>"
            'par.cmd.CommandText = "select bol_schema.*,t_voci_bolletta.descrizione from siscom_mi.t_voci_bolletta, siscom_mi.bol_schema where t_voci_bolletta.id=bol_schema.id_voce and bol_schema.id_contratto=" & lIdContratto & " and anno=" & sAnnoSchema & " order by t_voci_bolletta.descrizione asc"
            'myReader2 = par.cmd.ExecuteReader()
            'Do While myReader2.Read
            '    CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("descrizione"), ""), 50) & " " & par.MiaFormat(Format(par.IfNull(myReader2("importo_singola_rata"), "0"), "0.00"), 15) & " " & par.MiaFormat(par.IfNull(myReader2("da_rata"), ""), 10) & " " & par.MiaFormat(par.IfNull(myReader2("per_rate"), ""), 10), myReader2("ID")))
            '    If I Mod 2 <> 0 Then
            '        CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "#dcdada")
            '    Else
            '        CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "white")
            '    End If
            'Loop
            'myReader2.Close()

            'CARICAMENTO bollette

            'Dim num_bolletta As String = ""
            'Dim importobolletta As Double = 0
            'Dim importopagato As Double = 0
            'Dim ImportoTotBolletta As String = "0,00"
            'I = 0

            'par.cmd.CommandText = "select TIPO_BOLLETTE.ACRONIMO,bol_bollette.* from SISCOM_MI.TIPO_BOLLETTE,siscom_mi.bol_bollette where BOL_BOLLETTE.ID_TIPO=TIPO_BOLLETTE.ID (+) AND bol_bollette.id_unita=" & UnitaContratto & " and bol_bollette.id_contratto=" & lIdContratto & " order by bol_bollette.data_emissione desc,BOL_BOLLETTE.ANNO DESC,BOL_BOLLETTE.N_RATA DESC,bol_bollette.id desc"
            'myReader2 = par.cmd.ExecuteReader()
            'Do While myReader2.Read
            '    Select Case par.IfNull(myReader2("n_rata"), "")
            '        Case "99" 'bolletta manuale
            '            num_bolletta = "MA"
            '        Case "999" 'bolletta automatica
            '            num_bolletta = "AU"
            '        Case "99999" 'bolletta di conguaglio
            '            num_bolletta = "CO"
            '        Case Else
            '            num_bolletta = Format(par.IfNull(myReader2("n_rata"), "??"), "00")
            '    End Select

            '    importobolletta = par.IfNull(myReader2("IMPORTO_TOTALE"), "0,00")
            '    importopagato = par.IfNull(myReader2("IMPORTO_PAGATO"), "0,00")

            '    Dim STATO As String = ""
            '    If par.IfNull(myReader2("FL_ANNULLATA"), "0") <> "0" Then
            '        STATO = "ANNUL."
            '    Else
            '        STATO = "VALIDA"
            '    End If

            '    If par.IfNull(myReader2("id_bolletta_ric"), "0") <> "0" Or par.IfNull(myReader2("ID_RATEIZZAZIONE"), "0") <> "0" Then
            '        STATO = "RICLA."
            '    End If

            '    CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items.Add(New ListItem(par.MiaFormat(num_bolletta, 2) & " " & par.MiaFormat(STATO, 7) & " " & par.IfNull(myReader2("ACRONIMO"), "---") & "   " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("riferimento_da"), "")), 12) & "   " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("riferimento_a"), "")), 12) & " " & par.MiaFormat(Format(importobolletta, "##,##0.00"), 10) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_emissione"), "")), 12) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_scadenza"), "")), 12) & " " & par.MiaFormat(Format(importopagato, "##,##0.00"), 10) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_pagamento"), "")), 12) & " " & par.MiaFormat(par.IfNull(myReader2("note"), ""), 35) & " ", myReader2("ID")))

            '    If I Mod 2 <> 0 Then
            '        CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "#dcdada")
            '    Else
            '        CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "white")
            '    End If

            '    Select Case par.IfNull(myReader2("ID_TIPO"), "0")
            '        Case "3"
            '            CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "yellow")
            '        Case "4"
            '            CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "yellow")
            '    End Select




            '    I = I + 1
            'Loop
            'myReader2.Close()

            'CaricaBollette(lIdContratto)

            myReader.Close()
            myReaderVer.Close()


            If TipoContratto = "1" Or TipoContratto = "2" Or TipoContratto = "10" Then
                CType(Tab_Conduttore1.FindControl("imgEliminaCond"), ImageButton).Enabled = False
                CType(Tab_Conduttore1.FindControl("imgEliminaCond"), ImageButton).ToolTip = "Non disponibile per questo tipo di contratto!"

                CType(Tab_Conduttore1.FindControl("btnAggiungiCond"), ImageButton).Enabled = False
                CType(Tab_Conduttore1.FindControl("btnAggiungiCond"), ImageButton).ToolTip = "Non disponibile per questo tipo di contratto!"

                CType(Tab_Conduttore1.FindControl("btnAggiungiComp"), ImageButton).Enabled = False
                CType(Tab_Conduttore1.FindControl("btnAggiungiComp"), ImageButton).ToolTip = "Non disponibile per questo tipo di contratto!"

                CType(Tab_Conduttore1.FindControl("img_EliminaComp"), ImageButton).Enabled = False
                CType(Tab_Conduttore1.FindControl("img_EliminaComp"), ImageButton).ToolTip = "Non disponibile per questo tipo di contratto!"

                CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).ReadOnly = True
                CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).ReadOnly = True

            End If

            If TipoContratto = "3" Then

                CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).ReadOnly = True
                CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).ReadOnly = True


                CType(Tab_Canone1.FindControl("lblistat"), Label).Visible = True
                CType(Tab_Canone1.FindControl("lblistat1"), Label).Visible = True
                CType(Tab_Canone1.FindControl("lblistat3"), Label).Visible = True

                CType(Tab_Canone1.FindControl("ImgIstat"), WebControls.Image).Visible = True
                HttpContext.Current.Session.Add("BB", "SELECT to_char(to_date(ADEGUAMENTO_ISTAT.DATA_AGG_INIZIO,'yyyymmdd'),'dd/mm/yyyy') as ""INIZIO"",to_char(to_date(ADEGUAMENTO_ISTAT.DATA_AGG_FINE,'yyyymmdd'),'dd/mm/yyyy') as ""FINE"", RAPPORTI_UTENZA.ID,COD_CONTRATTO,to_char(to_date(data_DECORRENZA,'yyyymmdd'),'dd/mm/yyyy') as ""DECORRENZA"",PERC_ISTAT,ADEGUAMENTO_ISTAT.IMPORTO_CANONE_INIZIALE AS ""IMP_CANONE_INIZIALE"" ,IMPORTO_TR_AGG,IMPORTO_CANONE_AGG  FROM SISCOM_MI.ADEGUAMENTO_ISTAT,SISCOM_MI.RAPPORTI_UTENZA WHERE ADEGUAMENTO_ISTAT.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND RAPPORTI_UTENZA.ID=" & lIdContratto & " ORDER BY ID DESC")

                CType(Tab_Canone1.FindControl("ImgIstat"), WebControls.Image).Attributes.Add("onclick", "javascript:var fin;fin=window.open('SceltaIstat2.aspx');fin.focus();")
                CType(Tab_Canone1.FindControl("lblistat2"), DropDownList).Visible = True
                CType(Tab_Canone1.FindControl("lblistat4"), DropDownList).Visible = True

                ImgCambioIntestazione.Visible = True
                'ImgCambioIntestazione.Attributes.Add("onclick", "javascript:ConfermaSalvataggio();if (document.getElementById('txtModificato').value!='111') {window.open('CambioIntUSD.aspx?IDT=" & lIdConnessione & "&IDC=" & lIdContratto & "','Cambio','height=598,top=0,left=0,width=800,scrollbars=no');}")
                ImgCambioIntestazione.Attributes.Add("onclick", "javascript:ConfermaSalvataggio();ApriCambioUSD();")


            End If

            If TipoContratto = "7" Then

                CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).ReadOnly = True
                CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).ReadOnly = True




            End If

            If TipoContratto = "6" Then

                CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).ReadOnly = True
                CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).ReadOnly = True


                CType(Tab_Canone1.FindControl("lblistat"), Label).Visible = True
                CType(Tab_Canone1.FindControl("lblistat1"), Label).Visible = True
                CType(Tab_Canone1.FindControl("lblistat3"), Label).Visible = True

                CType(Tab_Canone1.FindControl("ImgIstat"), WebControls.Image).Visible = True
                HttpContext.Current.Session.Add("BB", "SELECT to_char(to_date(ADEGUAMENTO_ISTAT.DATA_AGG_INIZIO,'yyyymmdd'),'dd/mm/yyyy') as ""INIZIO"",to_char(to_date(ADEGUAMENTO_ISTAT.DATA_AGG_FINE,'yyyymmdd'),'dd/mm/yyyy') as ""FINE"", RAPPORTI_UTENZA.ID,COD_CONTRATTO,to_char(to_date(data_DECORRENZA,'yyyymmdd'),'dd/mm/yyyy') as ""DECORRENZA"",PERC_ISTAT,ADEGUAMENTO_ISTAT.IMPORTO_CANONE_INIZIALE AS ""IMP_CANONE_INIZIALE"" ,IMPORTO_TR_AGG,IMPORTO_CANONE_AGG  FROM SISCOM_MI.ADEGUAMENTO_ISTAT,SISCOM_MI.RAPPORTI_UTENZA WHERE ADEGUAMENTO_ISTAT.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND RAPPORTI_UTENZA.ID=" & lIdContratto & " ORDER BY ID DESC")

                CType(Tab_Canone1.FindControl("ImgIstat"), WebControls.Image).Attributes.Add("onclick", "javascript:var fin;fin=window.open('SceltaIstat2.aspx');fin.focus();")
                CType(Tab_Canone1.FindControl("lblistat2"), DropDownList).Visible = True
                CType(Tab_Canone1.FindControl("lblistat4"), DropDownList).Visible = True

            End If

            'If InStr(CType(Generale1.FindControl("lblStato"), Label).Text, "IN CORSO") > 0 Then
            '    par.cmd.CommandText = "select * FROM SISCOM_MI.EVENTI_CONTRATTI WHERE ID_CONTRATTO=" & lIdContratto & " AND COD_EVENTO='F18'"
            '    Dim myReaderSA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            '    If myReaderSA.HasRows = True Then
            '        imgChiudiContratto.Visible = False
            '        Tab_Contratto1.DisabilitaTutto()
            '    End If
            '    myReaderSA.Close()
            'End If


            Dim FATTA_FINE_CONTRATTO As Boolean = False

            If InStr(CType(Generale1.FindControl("lblStato"), Label).Text, "CHIUSO") > 0 Then
                par.cmd.CommandText = "select * FROM SISCOM_MI.EVENTI_CONTRATTI WHERE ID_CONTRATTO=" & lIdContratto & " AND COD_EVENTO='F18'"
                Dim myReaderSA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderSA.HasRows = True Then
                    imgChiudiContratto.Visible = False
                    Tab_Contratto1.DisabilitaTutto()
                    FATTA_FINE_CONTRATTO = True
                Else
                    imgChiudiContratto.Visible = True
                    If TipoContratto = "7" Then
                        CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).ReadOnly = False
                        CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).ReadOnly = False
                        CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).ReadOnly = False
                        CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).ReadOnly = False
                        CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).ReadOnly = False
                        imgSalva.Visible = True
                    End If
                End If
                myReaderSA.Close()
            End If

            If SolaLettura = "1" Then
                CType(Tab_Bollette1.FindControl("MenuStampeG"), Menu).Visible = False
                CType(Tab_Bollette1.FindControl("MenuStampeC"), Menu).Visible = False
                Tab_Contratto1.DisabilitaTutto()
                Tab_Registrazione1.DisabilitaTutto()
                Tab_Canone1.disattivaTutto()
                Tab_Conduttore1.Disabilita_Tutto()
                Tab_Comunicazioni1.Disabilita_tutto()
                Tab_SchemaBollette1.DisattivaTutto()
                Tab_Bollette1.DisattivaTutto()

                CType(Tab_Contratto1.FindControl("ChBolloEsente"), CheckBox).Visible = False

                btnAttivaContratto.Visible = False
                btnStampaContratto.Visible = False
                'btnMavAttivazione.Visible = False
                imgSalva.Visible = False
                imgChiudiContratto.Visible = False

                speseunita.Value = "0"

                ImgCambioIntestazione.Visible = False

                CType(Tab_Bollette1.FindControl("btnModificaBolletta"), ImageButton).Visible = False
                CType(Tab_Bollette1.FindControl("btnAnnullaBolletta"), ImageButton).Visible = False
                CType(Tab_Bollette1.FindControl("imgModulo"), System.Web.UI.WebControls.Image).Visible = False


            End If
            Dim impCauzione As Decimal = 0
            '31-03-2015 Recupero importo cauzione vecchio contratto
            par.cmd.CommandText = "SELECT * FROM siscom_mi.GESTIONE_CAMBIO_TIPO_CONTR WHERE ID_CONTRATTO_NUOVO=" & lIdContratto & ""
            Dim myReaderUA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderUA.Read Then
                impCauzione = CDbl(par.PuntiInVirgole(par.IfNull(myReaderUA("IMPORTO_CAUZIONE"), 0)))
            End If
            myReaderUA.Close()
            '31-03-2015 Fine

            VisualizzaPreventivo()

            Dim StringaTabella As String = ""
            Dim adISTAT As Double = 0
            Dim BOLLO_BOLLETTA As Double = 0
            Dim SPESEPOSTALI As Double = 0
            Dim AI As Double = 0
            Dim SPMAV As Double = 0
            Dim AltriAD As Double = 0

            Dim Dett1 As String = "0,00"
            Dim Dett2 As String = "0,00"
            Dim Dett3 As String = "0,00"
            Dim Dett4 As Double = 0
            Dim dettagli As String = "<table cellpadding='0' cellspacing='0' style='width:100%;font-family: arial; font-size: 8pt;'>"


            AI = (CDbl(par.PuntiInVirgole(CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text)) / CDbl(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedItem.Value))

            Dett3 = "<tr><td>CANONE/INDENNITA</td><td align='right'>" & CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text & "</td></tr>"

            Dett4 = Dett4 + CDbl(par.PuntiInVirgole(CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text))
            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo=2 and ID_CONTRATTO=" & lIdContratto
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                adISTAT = (CDbl(par.PuntiInVirgole(par.IfNull(myReaderA(0), 0))) / CDbl(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedItem.Value))
                Dett4 = Dett4 + CDbl(par.PuntiInVirgole(par.IfNull(myReaderA(0), 0)))
                Dett1 = "<tr><td>MONTANTE/ADEG. ISTAT</td><td align='right'>" & Format(par.IfNull(myReaderA(0), 0), "0.00") & "</td></tr>"
            End If
            myReaderA.Close()

            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo<>2 and ID_CONTRATTO=" & lIdContratto
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                AltriAD = (CDbl(par.PuntiInVirgole(par.IfNull(myReaderA(0), 0))) / CDbl(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedItem.Value))
                Dett4 = Dett4 + CDbl(par.PuntiInVirgole(par.IfNull(myReaderA(0), 0)))
                Dett2 = "<tr><td>ADEGUAMENTO CANONE/IND.</td><td align='right'>" & Format(par.IfNull(myReaderA(0), 0), "0.00") & "</td></tr>"

            End If
            myReaderA.Close()

            StringaTabella = "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">CANONE/INDENNITA</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(AI, "0.00") & "</td></tr>"

            If adISTAT <> 0 Then
                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">MONTANTE/ADEG. ISTAT</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(adISTAT, "0.00") & "</td></tr>"
            End If

            If AltriAD <> 0 Then
                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">ADEG. CANONE/IND.</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(AltriAD, "0.00") & "</td></tr>"
            End If

            CType(Tab_Canone1.FindControl("Label9"), Label).Text = dettagli & Dett3 & Dett1 & Dett2 & "<tr><td>TOTALE</td><td align='right'>" & Format(Dett4, "0.00") & "</td></tr></table>"
            CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Attributes.Add("onmouseover", "javascript:VisualizzaDettagliCanone();")
            CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Attributes.Add("onmouseout", "javascript:NascondiDettagliCanone();")


            par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=0"
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                BOLLO_BOLLETTA = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
            End If
            myReaderA.Close()

            par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=17"
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                SPESEPOSTALI = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
            End If
            myReaderA.Close()

            If BOLLO_BOLLETTA > 0 Then
                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">BOLLO</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(BOLLO_BOLLETTA, "0.00") & "</td></tr>"
            End If

            If SPESEPOSTALI > 0 Then
                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">SPESE POSTALI</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESEPOSTALI, "0.00") & "</td></tr>"
            End If

            par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=26"
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                SPMAV = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">SPESE MAV</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPMAV, "0.00") & "</td></tr>"
            End If
            myReaderA.Close()

            CType(Tab_SchemaBollette1.FindControl("lblVociAutomatiche"), Label).Text = "<table><tr><td style=" & Chr(34) & "font-family: Arial; font-size: 9px; font-weight: bold" & Chr(34) & ">OLTRE LE VOCI SOPRA INDICATE, SARANNO AUTOMATICAMENTE INSERITE IN BOLLETTA</td><td></td></tr>" & StringaTabella & "</table>"

            Dim SSS As String = ""
            Dim anagra As Long = 0
            Dim CONTA As Integer = 0


            par.cmd.CommandText = "select soggetti_contrattuali.id_anagrafica from siscom_mi.soggetti_contrattuali where (cod_tipologia_occupante='INTE' OR COD_TIPOLOGIA_OCCUPANTE='EXINTE') and id_contratto=" & lIdContratto
            'par.cmd.CommandText = "select soggetti_contrattuali.id_anagrafica from siscom_mi.soggetti_contrattuali where (cod_tipologia_occupante='INTE' OR COD_TIPOLOGIA_OCCUPANTE='EXINTE') and id_contratto=" & lIdContratto

            myReaderA = par.cmd.ExecuteReader()
            Do While myReaderA.Read
                anagra = par.IfNull(myReaderA("id_anagrafica"), -1)

                par.cmd.CommandText = "select COD_FISCALE FROM SISCOM_MI.ANAGRAFICA where id=" & anagra
                Dim myReaderAX As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderAX.Read Then
                    'par.cmd.CommandText = "select rapporti_utenza.id,rapporti_utenza.cod_contratto,rapporti_utenza.COD_TIPOLOGIA_CONTR_LOC,rapporti_utenza.DATA_DECORRENZA,rapporti_utenza.DATA_SCADENZA,SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID) AS ""STATO"" from siscom_mi.rapporti_utenza,siscom_mi.soggetti_contrattuali,SISCOM_MI.ANAGRAFICA where rapporti_utenza.cod_contratto is not null and rapporti_utenza.id=soggetti_contrattuali.id_contratto and Soggetti_contrattuali.cod_tipologia_occupante='INTE' AND SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID)<>'CHIUSO' AND ANAGRAFICA.COD_FISCALE='" & par.IfNull(myReaderAX("COD_FISCALE"), "") & "' AND SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA=ANAGRAFICA.ID AND SOGGETTI_CONTRATTUALI.ID_CONTRATTO<>" & lIdContratto
                    par.cmd.CommandText = "select rapporti_utenza.id,rapporti_utenza.cod_contratto,rapporti_utenza.COD_TIPOLOGIA_CONTR_LOC,rapporti_utenza.DATA_DECORRENZA,rapporti_utenza.DATA_SCADENZA,SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID) AS ""STATO"" from siscom_mi.rapporti_utenza,siscom_mi.soggetti_contrattuali,SISCOM_MI.ANAGRAFICA where rapporti_utenza.id=soggetti_contrattuali.id_contratto and Soggetti_contrattuali.cod_tipologia_occupante='INTE' AND ANAGRAFICA.COD_FISCALE='" & par.IfNull(myReaderAX("COD_FISCALE"), "") & "' AND SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA=ANAGRAFICA.ID AND SOGGETTI_CONTRATTUALI.ID_CONTRATTO<>" & lIdContratto
                    Dim myReaderAX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderAX1.HasRows = True Then
                        Do While myReaderAX1.Read
                            CONTA = CONTA + 1
                            If CONTA < 8 Then
                                SSS = SSS & "<a href='#' onclick=" & Chr(34) & "ApriContratto('" & par.IfNull(myReaderAX1("id"), "") & "','" & par.IfNull(myReaderAX1("COD_CONTRATTO"), "SENZA CODICE") & "');" & Chr(34) & ">" & par.IfNull(myReaderAX1("COD_CONTRATTO"), "SENZA CODICE") & "-" & par.IfNull(myReaderAX1("COD_TIPOLOGIA_CONTR_LOC"), "") & "-" & par.IfNull(myReaderAX1("STATO"), "") & "</a></br>"
                            End If

                            '24/11/2016 Cerco contratti 392
                            par.cmd.CommandText = "select rapporti_utenza.id,rapporti_utenza.cod_contratto,rapporti_utenza.COD_TIPOLOGIA_CONTR_LOC,rapporti_utenza.DATA_DECORRENZA,rapporti_utenza.DATA_SCADENZA," _
                                & " SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID) AS ""STATO""" _
                                & " from siscom_mi.rapporti_utenza where rapporti_utenza.id<>" & lIdContratto & " and rapporti_utenza.id not in " & par.IfNull(myReaderAX1("id"), "") & " and cod_contratto in (" _
                                & " select rapporto from utenza_dichiarazioni,utenza_comp_nucleo where fl_392=1 and id_stato=1 and utenza_dichiarazioni.id=utenza_comp_nucleo.id_dichiarazione " _
                                & " and cod_fiscale = (select distinct cod_fiscale FROM SISCOM_MI.ANAGRAFICA where id=" & anagra & "))"
                            Dim myReader392a As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            Do While myReader392a.Read
                                CONTA = CONTA + 1
                                If CONTA < 8 Then
                                    SSS = SSS & "<a href='#' onclick=" & Chr(34) & "ApriContratto('" & par.IfNull(myReader392a("id"), "") & "','" & par.IfNull(myReader392a("COD_CONTRATTO"), "SENZA CODICE") & "');" & Chr(34) & ">" & par.IfNull(myReader392a("COD_CONTRATTO"), "SENZA CODICE") & "-" & par.IfNull(myReader392a("COD_TIPOLOGIA_CONTR_LOC"), "") & "-" & par.IfNull(myReader392a("STATO"), "") & "</a></br>"
                                End If
                            Loop
                            myReader392a.Close()
                            '24/11/2016 FINE Cerco contratti 392
                        Loop
                    Else
                        '24/11/2016 Cerco contratti 392
                        par.cmd.CommandText = "select rapporti_utenza.id,rapporti_utenza.cod_contratto,rapporti_utenza.COD_TIPOLOGIA_CONTR_LOC,rapporti_utenza.DATA_DECORRENZA,rapporti_utenza.DATA_SCADENZA," _
                            & " SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID) AS ""STATO""" _
                            & " from siscom_mi.rapporti_utenza where rapporti_utenza.id<>" & lIdContratto & " and cod_contratto in (" _
                            & " select rapporto from utenza_dichiarazioni,utenza_comp_nucleo where fl_392=1 and id_stato=1 and utenza_dichiarazioni.id=utenza_comp_nucleo.id_dichiarazione " _
                            & " and cod_fiscale = (select distinct cod_fiscale FROM SISCOM_MI.ANAGRAFICA where id=" & anagra & "))"
                        Dim myReader392 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        Do While myReader392.Read
                            CONTA = CONTA + 1
                            If CONTA < 8 Then
                                SSS = SSS & "<a href='#' onclick=" & Chr(34) & "ApriContratto('" & par.IfNull(myReader392("id"), "") & "','" & par.IfNull(myReader392("COD_CONTRATTO"), "SENZA CODICE") & "');" & Chr(34) & ">" & par.IfNull(myReader392("COD_CONTRATTO"), "SENZA CODICE") & "-" & par.IfNull(myReader392("COD_TIPOLOGIA_CONTR_LOC"), "") & "-" & par.IfNull(myReader392("STATO"), "") & "</a></br>"
                            End If
                        Loop
                        myReader392.Close()


                        par.cmd.CommandText = "select id_dichiarazione from UTENZA_DICH_CANONI_EC where id_Contratto=" & lIdContratto & " order by id desc"
                        Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReader1.Read Then
                            par.cmd.CommandText = "select rapporti_utenza.id,rapporti_utenza.cod_contratto,rapporti_utenza.COD_TIPOLOGIA_CONTR_LOC,rapporti_utenza.DATA_DECORRENZA,rapporti_utenza.DATA_SCADENZA,SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID) AS ""STATO"" from " _
                                & " siscom_mi.rapporti_utenza,siscom_mi.soggetti_contrattuali,SISCOM_MI.ANAGRAFICA where rapporti_utenza.id=soggetti_contrattuali.id_contratto and cod_contratto>'" & CodContratto1 & "' and cod_contratto<'" & Left(CodContratto1, 17) & "99'" _
                                & " and Soggetti_contrattuali.cod_tipologia_occupante='INTE' AND SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA=ANAGRAFICA.ID AND SOGGETTI_CONTRATTUALI.ID_CONTRATTO<>" & lIdContratto
                            Dim myReaderA2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            Do While myReaderA2.Read
                                CONTA = CONTA + 1
                                If CONTA < 8 Then
                                    SSS = SSS & "<a href='#' onclick=" & Chr(34) & "ApriContratto('" & par.IfNull(myReaderA2("id"), "") & "','" & par.IfNull(myReaderA2("COD_CONTRATTO"), "SENZA CODICE") & "');" & Chr(34) & ">" & par.IfNull(myReaderA2("COD_CONTRATTO"), "SENZA CODICE") & "-" & par.IfNull(myReaderA2("COD_TIPOLOGIA_CONTR_LOC"), "") & "-" & par.IfNull(myReaderA2("STATO"), "") & "</a></br>"
                                End If
                            Loop
                        End If
                        myReader1.Close()

                        '24/11/2016 FINE Cerco contratti 392
                    End If
                    myReaderAX1.Close()
                End If
                myReaderAX.Close()

            Loop
            myReaderA.Close()




            If SSS <> "" Then
                If CONTA < 8 Then
                    CType(Generale1.FindControl("lblAltriAttivi"), Label).Text = SSS
                Else
                    SSS = SSS & "Altri contratti..."
                    CType(Generale1.FindControl("lblAltriAttivi"), Label).Text = SSS
                End If
            End If

            'CType(Tab_Contratto1.FindControl("DRA"), System.Web.UI.WebControls.Image).Attributes.Add("onclick", "javascript:window.open('DisdRinnAzLegali.aspx?ID_CONTRATTO=" & lIdContratto & "','AAA','height=550,width=800');")
            Tab_Contratto1.indicecontratto = lIdContratto
            Tab_Contratto1.indiceconnessione = lIdConnessione

            Tab_Azioni_Legali1.indicecontratto = lIdContratto
            Tab_Azioni_Legali1.indiceconnessione = lIdConnessione


            Select Case TipoContratto
                Case "1", "2", "7", "10", "12"
                    CType(Tab_Contratto1.FindControl("ChBolloEsente"), CheckBox).Visible = False
                Case Else
                    CType(Tab_Contratto1.FindControl("ChBolloEsente"), CheckBox).Visible = True
            End Select

            If LBLVIRTUALE.Visible = True Then
                Tab_Contratto1.DisabilitaTutto()
                Tab_Registrazione1.DisabilitaTutto()
                Tab_Canone1.disattivaTutto()
                CType(Tab_Canone1.FindControl("checkInvioBoll"), CheckBox).Enabled = True
                'Tab_Comunicazioni1.Disabilita_tutto()
                Tab_Conduttore1.Disabilita_Tutto()
                btnAttivaContratto.Visible = False
                btnStampaContratto.Visible = False
                'btnMavAttivazione.Visible = False
                imgSalva.Visible = True
                If CType(Generale1.FindControl("lblStato"), Label).Text = "CHIUSO" Then
                    Tab_Bollette1.DisattivaTuttoVirtuale()
                End If
                imgChiudiContratto.Visible = True
                speseunita.Value = "0"
                CType(Tab_Contratto1.FindControl("ChBolloEsente"), CheckBox).Visible = False

                If SolaLettura <> "1" Then
                    CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Enabled = True
                    CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).ReadOnly = False

                    CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Enabled = True
                    CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).ReadOnly = False

                    CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).Enabled = True
                    CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).ReadOnly = False

                    CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Enabled = True
                    CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).ReadOnly = False

                    CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).Enabled = True
                    CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).ReadOnly = False
                    CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Enabled = True
                    CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).ReadOnly = False

                    'CType(Tab_Contratto1.FindControl("txtNote"), TextBox).ReadOnly = False
                    'CType(Tab_Contratto1.FindControl("txtNote"), TextBox).Enabled = True
                    CType(Tab_Bollette1.FindControl("btnAnnullaBolletta"), ImageButton).Visible = True

                    'CType(Tab_Bollette1.FindControl("ImgMavOnLine"), System.Drawing.Image).Visible = True

                    If FATTA_FINE_CONTRATTO = True Then
                        'imgSalva.Visible = False
                        imgChiudiContratto.Visible = False
                        CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Enabled = False
                        CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).ReadOnly = True
                        CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Enabled = False
                        CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).ReadOnly = True

                        CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).Enabled = False
                        CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).ReadOnly = True

                        CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Enabled = False
                        CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).ReadOnly = True

                        CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).Enabled = False
                        CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).ReadOnly = True
                        CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Enabled = False
                        CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).ReadOnly = True
                        'CType(Tab_Bollette1.FindControl("btnAnnullaBolletta"), ImageButton).Visible = False

                    Else
                        CType(Tab_Comunicazioni1.FindControl("Button1"), Button).Visible = True
                        Tab_Comunicazioni1.IDUNITAIMMOBILIARE = txtIdUnita.Value
                        Tab_Comunicazioni1.indicecontratto = lIdContratto

                        'CType(Tab_Contratto1.FindControl("txtNote"), TextBox).ReadOnly = False
                        'CType(Tab_Contratto1.FindControl("txtNote"), TextBox).Enabled = True

                    End If
                Else
                    'CType(Tab_Contratto1.FindControl("txtNote"), TextBox).ReadOnly = True
                    'CType(Tab_Contratto1.FindControl("txtNote"), TextBox).Enabled = False
                    imgChiudiContratto.Visible = False
                    imgSalva.Visible = False
                    Tab_Bollette1.DisattivaTuttoVirtuale()
                End If
            Else
                CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Enabled = False
                'CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).ReadOnly = False

            End If

            par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=39"
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                If par.IfNull(myReaderA("VALORE"), "0") = "0" Then
                    CType(Tab_Bollette1.FindControl("imgModulo"), System.Web.UI.WebControls.Image).Visible = False
                    CType(Tab_Bollette1.FindControl("ImgMavOnLine"), System.Web.UI.WebControls.Image).Visible = False
                End If
            End If
            myReaderA.Close()


            par.cmd.CommandText = "select id from siscom_mi.bol_rateizzazioni where id_contratto = " & lIdContratto
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.HasRows Then
                RateizInCorso.Value = 1
            Else
                RateizInCorso.Value = 0
            End If
            myReaderA.Close()


            CaricaTabBollette()
            CaricaTabOA()
            CaricaGestionale()

            'MenuFunzioni()
            DataScadCont.Value = CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text
            DataScadRinn.Value = CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Text

            'max'15/12/2014 visualizzazione dati reg
            If ModalitaPagamento <> "" Or TipoPosizione <> "" Then
                CType(Tab_Registrazione1.FindControl("cmbTipoPosizione"), DropDownList).SelectedIndex = -1
                CType(Tab_Registrazione1.FindControl("cmbModoPagamento"), DropDownList).SelectedIndex = -1

                par.cmd.CommandText = "select * from SISCOM_MI.TIPOLOGIA_POSIZIONE where id=" & par.IfEmpty(TipoPosizione, "-1")
                myReaderA = par.cmd.ExecuteReader()
                If myReaderA.Read Then
                    'CType(Tab_Registrazione1.FindControl("lblTipoPosizione"), Label).Text = par.IfNull(myReaderA("descrizione"), "")
                    CType(Tab_Registrazione1.FindControl("cmbTipoPosizione"), DropDownList).Items.FindByValue(par.IfNull(myReaderA("ID"), "-1")).Selected = True
                End If
                myReaderA.Close()
                par.cmd.CommandText = "select * from SISCOM_MI.TIPOLOGIA_PAGAMENTO where id=" & par.IfEmpty(ModalitaPagamento, "-1")
                myReaderA = par.cmd.ExecuteReader()
                If myReaderA.Read Then
                    'CType(Tab_Registrazione1.FindControl("lblModoPagamento"), Label).Text = par.IfNull(myReaderA("descrizione"), "")
                    CType(Tab_Registrazione1.FindControl("cmbModoPagamento"), DropDownList).Items.FindByValue(par.IfNull(myReaderA("ID"), "-1")).Selected = True
                End If
                myReaderA.Close()
            End If
            '---------------------
            '---------------------

            'MAX 19/05/2016 AVVISI LIQUIDAZIONE
            par.CaricaAvvisiLiquidazione(lIdContratto, CType(Tab_Registrazione1.FindControl("DataGridLiquidazione"), DataGrid))

            par.myTrans = par.OracleConn.BeginTransaction()
            '‘par.cmd.Transaction = par.myTrans
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)

        Catch EX1 As Oracle.DataAccess.Client.OracleException
            If EX1.Number = 54 Then
                par.OracleConn.Close()
                SolaLettura = "1"
                lettura.Value = "1"
                'Session.Item("LAVORAZIONE") = "0"
                scriptblock = "<script language='javascript' type='text/javascript'>" _
                & "alert('Il rapporto aperto da altro operatore, sarà visualizzato in sola lettura!');" _
                & "</script>"
                If (Not Page.ClientScript.IsClientScriptBlockRegistered("clientScript4")) Then
                    Page.ClientScript.RegisterClientScriptBlock(Me.GetType(), "clientScript4", scriptblock)
                End If
                bloccato.Value = "1"
                GoTo InSolaLettura
            Else
                'par.myTrans.Rollback()
                par.OracleConn.Close()

                Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & EX1.Message)
                Response.Write("<script>top.location.href='../Errore.aspx';</script>")
            End If
        Catch ex As Exception
            'par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Item("LAVORAZIONE") = "0"
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try

    End Function

    Private Sub VerificaRibaltamSpese(ByVal idContratto As Long)
        Dim dataReg As String = ""
        Dim impBollo As Decimal = 0
        Dim impRegistro As Decimal = 0

        par.cmd.CommandText = "select data_registrazione from siscom_mi.rapporti_utenza_ricevute where id_contratto=" & idContratto & " order by anno desc"
        Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
        If myReader.Read Then
            dataReg = par.IfNull(myReader("data_registrazione"), "")
        End If
        myReader.Close()

        Dim strBollo As String = ""
        Dim strReg As String = ""
        par.cmd.CommandText = "select bol_bollette_gest.*,(select RAPPORTI_UTENZA_PROSSIMA_BOL.PROSSIMA_BOLLETTA from siscom_mi.RAPPORTI_UTENZA_PROSSIMA_BOL where id_Contratto=rapporti_utenza.id) as PROX_BOLL " _
            & " from siscom_mi.bol_bollette_gest,siscom_mi.rapporti_utenza where " _
            & " bol_bollette_gest.id_contratto=rapporti_utenza.id And id_tipo in (118,117) And data_emissione='" & dataReg & "' And id_contratto=" & idContratto
        Dim da1 As New Oracle.DataAccess.Client.OracleDataAdapter(par.cmd)
        Dim dt1 As New Data.DataTable
        da1.Fill(dt1)
        da1.Dispose()
        If dt1.Rows.Count > 0 Then
            For Each rowDT In dt1.Rows
                If rowDT.item("tipo_applicazione") = "N" Then
                    If rowDT.item("id_tipo") = "117" Then
                        impRegistro = rowDT.item("importo_totale")
                        strReg = "Imposta di registro pari a " & Format(impRegistro, "##,##0.00") & "€"
                    End If
                    If rowDT.item("id_tipo") = "118" Then
                        impBollo = rowDT.item("importo_totale")
                        strBollo = "Imposta di bollo pari a " & Format(impBollo, "##,##0.00") & "€ e "
                    End If
                End If
            Next
            If impRegistro > 0 Then
                CType(Tab_Registrazione1.FindControl("lblRibaltamentoBoll"), Label).Text = strBollo & strReg & " da inserire " _
                & " nelle voci di bollettazione per il periodo " & Mid(par.IfNull(dt1.Rows(0).Item("PROX_BOLL"), "XXXXXX"), 1, 4) & "/" & MESE(Mid(par.IfNull(dt1.Rows(0).Item("PROX_BOLL"), "XXXXXX"), 5, 2))
            End If
        End If

    End Sub

    Function CaricaDettCanoni(ByVal idContratto As Long)
        Dim testoTabella1 As String = ""
        Dim IValidita As String = ""
        Dim FValidita As String = ""

        testoTabella1 = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                        & "<tr>" _
                        & "<td style='height: 15px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>DATA CALCOLO</strong></span></td>" _
                        & "<td style='height: 15px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>AREA ECONOMICA</strong></span></td>" _
                        & "<td style='height: 15px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>CLASSE</strong></span></td>" _
                        & "<td style='height: 15px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>DATA VALIDITA'</strong></span></td>" _
                        & "<td style='height: 15px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>CANONE</strong></span></td>" _
                        & "<td style='height: 15px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>ORIGINE</strong></span></td>" _
                        & "<td style='height: 15px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong></strong></span></td>" _
                        & "</tr>"
        par.cmd.CommandText = "SELECT CANONI_EC.*,T_TIPO_PROVENIENZA.DESCRIZIONE AS PROVENIENZA FROM SISCOM_MI.CANONI_EC,T_TIPO_PROVENIENZA WHERE CANONI_EC.TIPO_PROVENIENZA=T_TIPO_PROVENIENZA.ID (+) AND ID_CONTRATTO=" & lIdContratto & " ORDER BY nvl(fine_validita_can,'19000101') desc,data_calcolo desc"
        Dim myReader22 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
        Do While myReader22.Read
            If Len(par.IfNull(myReader22("INIZIO_VALIDITA_CAN"), "")) <> 4 Then
                IValidita = par.FormattaData(par.IfNull(myReader22("INIZIO_VALIDITA_CAN"), ""))
                FValidita = par.FormattaData(par.IfNull(myReader22("FINE_VALIDITA_CAN"), ""))
            Else
                IValidita = par.IfNull(myReader22("INIZIO_VALIDITA_CAN"), "")
                FValidita = par.IfNull(myReader22("FINE_VALIDITA_CAN"), "")
            End If
            testoTabella1 = testoTabella1 _
                & "<tr>" _
                & "<td style='height: 15px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'>" & par.FormattaData(Mid(myReader22("DATA_CALCOLO"), 1, 8)) & " " & Mid(myReader22("DATA_CALCOLO"), 9, 2) & ":" & Mid(myReader22("DATA_CALCOLO"), 11, 2) & "</span></td>" _
                & "<td style='height: 15px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'>" & par.RicavaAreaEconomica(par.IfNull(myReader22("ID_AREA_ECONOMICA"), "0")) & "</span></td>" _
                & "<td style='height: 15px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader22("SOTTO_AREA"), "") & "</span></td>" _
                & "<td style='height: 15px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'>" & IValidita & "-" & FValidita & "</span></td>" _
                & "<td style='height: 15px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader22("CANONE"), "") & "</span></td>" _
                & "<td style='height: 15px'>"
            Select Case par.IfNull(myReader22("PROVENIENZA"), "IMPORTATO")
                Case "GESTIONE LOCATARI"
                    par.cmd.CommandText = "SELECT replace(replace('<a href=£javascript:void(0)£ onclick=£window.open(''../VSA/NuovaDichiarazioneVSA/DichAUnuova.aspx?CH=2$ID='||DICHIARAZIONI_VSA.ID||''',''Dichiarazione'',''top=200,left=350,toolbar=no, location=no,status=no,menubar=no,scrollbars=yes,resizable=yes'');£>'||DICHIARAZIONI_VSA.PG||'</a>','$','&'),'£','" & Chr(34) & "') as PG,T_MOTIVO_DOMANDA_VSA.DESCRIZIONE FROM domande_bando_vsa, T_MOTIVO_DOMANDA_VSA,dichiarazioni_vsa WHERE dichiarazioni_vsa.id=domande_bando_vsa.id_dichiarazione and T_MOTIVO_DOMANDA_VSA.ID = DOMANDE_BANDO_VSA.ID_MOTIVO_DOMANDA AND DOMANDE_BANDO_VSA.ID_DICHIARAZIONE=" & par.IfNull(myReader22("ID_DICHIARAZIONE"), -1)
                    Dim myReader23 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader23.Read Then
                        testoTabella1 = testoTabella1 & "<span style='font-size: 8pt; font-family: Arial'>Gest.Loc " & par.IfNull(myReader23("DESCRIZIONE"), "IMPORTATO") & "-" & par.IfNull(myReader23("pg"), "") & "</span></td>"
                    End If
                    myReader23.Close()
                Case Else
                    testoTabella1 = testoTabella1 & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader22("provenienza"), "IMPORTATO") & "</span></td>"
            End Select

            testoTabella1 = testoTabella1 & "<td style='height: 15px'>"

            If par.IfNull(myReader22("DATA_CALCOLO"), "200901010000") <> "200901010000" Then
                testoTabella1 = testoTabella1 & "<span style='font-size: 8pt; font-family: Arial'>" & "<a href='DettagliCalcolo.aspx?COD=" & CodContratto1 & "&DATA=" & myReader22("DATA_CALCOLO") & "&IDC=" & lIdContratto & "' target='_blank'>Visualizza Dettagli</span></td></tr>"
            Else
                testoTabella1 = testoTabella1 & "<span style='font-size: 8pt; font-family: Arial'></span></td></tr>"
            End If
        Loop
        myReader22.Close()
        If TipoContratto = "1" Or TipoContratto = "2" Or TipoContratto = "7" Or TipoContratto = "10" Then
            CType(Tab_Canone1.FindControl("lblDettaglioCanoni"), Label).Text = testoTabella1 & "</table>"
        Else
            CType(Tab_Canone1.FindControl("ImgRicalcolaC"), ImageButton).Visible = False
            CType(Tab_Canone1.FindControl("lblDettaglioCanoni"), Label).Text = ""
            CType(Tab_Canone1.FindControl("label4"), Label).Text = ""
        End If


    End Function



    Function CaricaCompContratto(ByRef IdContratto As Long)

        CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Clear()
        CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Clear()
        'CARICO INTESTATARI
        par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.data_inizio,SOGGETTI_CONTRATTUALI.data_fine,TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",ANAGRAFICA.* FROM SISCOM_MI.TIPOLOGIA_PARENTELA,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE TIPOLOGIA_PARENTELA.COD=SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_PARENTELA AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND  COD_TIPOLOGIA_OCCUPANTE='INTE' AND ID_CONTRATTO=" & IdContratto
        Dim myReader22 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
        Do While myReader22.Read
            If par.IfNull(myReader22("RAGIONE_SOCIALE"), "") <> "" And par.IfNull(myReader22("PARTITA_IVA"), "") <> "" Then
                CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader22("RAGIONE_SOCIALE"), ""), 37) & " " & par.MiaFormat(par.IfNull(myReader22("PARTITA_IVA"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader22("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader22("data_inizio"), "")), 10), myReader22("ID")))
            Else
                CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader22("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReader22("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReader22("COD_FISCALE"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader22("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader22("data_inizio"), "")), 10), myReader22("ID")))
            End If
        Loop
        myReader22.Close()


        'CARICO COINTESTATARI
        par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.data_inizio,SOGGETTI_CONTRATTUALI.data_fine,TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",ANAGRAFICA.* FROM SISCOM_MI.TIPOLOGIA_PARENTELA,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE TIPOLOGIA_PARENTELA.COD=SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_PARENTELA AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND  COD_TIPOLOGIA_OCCUPANTE='COINT' AND ID_CONTRATTO=" & IdContratto
        myReader22 = par.cmd.ExecuteReader()
        Do While myReader22.Read
            If par.IfNull(myReader22("RAGIONE_SOCIALE"), "") <> "" Then
                CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader22("RAGIONE_SOCIALE"), ""), 37) & " " & par.MiaFormat(par.IfNull(myReader22("PARTITA_IVA"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader22("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader22("data_inizio"), "")), 10), myReader22("ID")))
            Else
                CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader22("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReader22("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReader22("COD_FISCALE"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader22("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader22("data_inizio"), "")), 10), myReader22("ID")))
            End If
        Loop
        myReader22.Close()


        'CARICAMENTO OCCUPANTI
        par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.data_inizio,SOGGETTI_CONTRATTUALI.data_fine,TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",ANAGRAFICA.* FROM SISCOM_MI.TIPOLOGIA_PARENTELA,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE TIPOLOGIA_PARENTELA.COD=SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_PARENTELA AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND  COD_TIPOLOGIA_OCCUPANTE<>'INTE' AND COD_TIPOLOGIA_OCCUPANTE<>'COINT' AND ID_CONTRATTO=" & IdContratto & " and NVL(data_fine,'29991231') >= '" & Format(Now(), "yyyyMMdd") & "' order by anagrafica.cognome asc,anagrafica.nome asc,SOGGETTI_CONTRATTUALI.data_inizio"
        myReader22 = par.cmd.ExecuteReader()
        Do While myReader22.Read
            If par.IfNull(myReader22("RAGIONE_SOCIALE"), "") <> "" Then
                CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader22("RAGIONE_SOCIALE"), ""), 37) & " " & par.MiaFormat(par.IfNull(myReader22("PARTITA_IVA"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader22("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader22("data_inizio"), "")), 10), myReader22("ID")))
            Else
                CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader22("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReader22("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReader22("COD_FISCALE"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader22("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader22("data_inizio"), "")), 10), myReader22("ID")))
            End If
        Loop
        myReader22.Close()

        'CARICAMENTO OSPITI
        CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Clear()

        par.cmd.CommandText = "SELECT OSPITI.*,(select descrizione from t_tipo_ruolo where t_tipo_ruolo.id=id_tipo_ruolo) as ruolo FROM SISCOM_MI.OSPITI " _
            & " WHERE ID_CONTRATTO=" & IdContratto & " ORDER BY DATA_AGG DESC"
        myReader22 = par.cmd.ExecuteReader()
        Do While myReader22.Read
            CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader22("nominativo"), ""), 30) & " " _
            & par.MiaFormat(par.IfNull(myReader22("cod_fiscale"), ""), 16) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader22("data_inizio_ospite"), "")), 15) & " " _
            & par.MiaFormat(par.FormattaData(par.IfNull(myReader22("data_fine_ospite"), "")), 15) & " " & par.MiaFormat(par.IfNull(myReader22("ruolo"), ""), 20), myReader22("ID")))
        Loop
        myReader22.Close()
    End Function


    Private Sub CaricaBollette(ByVal IdContratto As Long)
        Dim num_bolletta As String = ""
        Dim importobolletta As Double = 0
        Dim importopagato As Double = 0
        Dim ImportoTotBolletta As String = "0,00"

        Dim I As Integer = 0

        CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items.Clear()
        par.cmd.CommandText = "select TIPO_BOLLETTE.ACRONIMO,bol_bollette.* from SISCOM_MI.TIPO_BOLLETTE,siscom_mi.bol_bollette where BOL_BOLLETTE.ID_TIPO=TIPO_BOLLETTE.ID (+) AND bol_bollette.id_contratto=" & IdContratto & " order by bol_bollette.data_emissione desc,BOL_BOLLETTE.ANNO DESC,BOL_BOLLETTE.N_RATA DESC,bol_bollette.id desc"
        Dim myReader2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
        Do While myReader2.Read
            Select Case par.IfNull(myReader2("n_rata"), "")
                Case "99" 'bolletta manuale
                    num_bolletta = "MA"
                Case "999" 'bolletta automatica
                    num_bolletta = "AU"
                Case "99999" 'bolletta di conguaglio
                    num_bolletta = "CO"
                Case Else
                    num_bolletta = Format(par.IfNull(myReader2("n_rata"), "??"), "00")
            End Select

            importobolletta = par.IfNull(myReader2("IMPORTO_TOTALE"), "0,00")
            importopagato = par.IfNull(myReader2("IMPORTO_PAGATO"), "0,00")

            Dim STATO As String = ""
            If par.IfNull(myReader2("FL_ANNULLATA"), "0") <> "0" Then
                STATO = "ANNUL."
            Else
                STATO = "VALIDA"
            End If

            If par.IfNull(myReader2("id_bolletta_ric"), "0") <> "0" Or par.IfNull(myReader2("ID_RATEIZZAZIONE"), "0") <> "0" Then
                STATO = "RICLA."
            End If

            CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items.Add(New ListItem(par.MiaFormat(num_bolletta, 2) & " " & par.MiaFormat(STATO, 7) & " " & par.IfNull(myReader2("ACRONIMO"), "---") & "   " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("riferimento_da"), "")), 12) & "   " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("riferimento_a"), "")), 12) & " " & par.MiaFormat(Format(importobolletta, "##,##0.00"), 10) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_emissione"), "")), 12) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_scadenza"), "")), 12) & " " & par.MiaFormat(Format(importopagato, "##,##0.00"), 10) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_pagamento"), "")), 12) & " " & par.MiaFormat(par.IfNull(myReader2("note"), ""), 35) & " ", myReader2("ID")))

            If I Mod 2 <> 0 Then
                CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "#dcdada")
            Else
                CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "white")
            End If

            Select Case par.IfNull(myReader2("ID_TIPO"), "0")
                Case "3"
                    CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "yellow")
                Case "4"
                    CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "yellow")
            End Select
            I = I + 1
        Loop
        myReader2.Close()
    End Sub




    Function CaricaDomandeInCorso() As String
        Dim trovati As String = ""

        CType(Generale1.FindControl("lblDomandeInCorso"), Label).Text = "---"

        par.cmd.CommandText = "SELECT ANAGRAFICA.* FROM SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND  COD_TIPOLOGIA_OCCUPANTE='INTE' AND ID_CONTRATTO=" & lIdContratto
        Dim myReader2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
        Do While myReader2.Read
            If par.IfNull(myReader2("RAGIONE_SOCIALE"), "") = "" Then
                par.cmd.CommandText = "select domande_bando_fsa.pg from domande_bando_fsa,comp_nucleo_fsa where comp_nucleo_fsa.cod_fiscale='" & par.IfNull(myReader2("cod_fiscale"), "") & "' and domande_bando_fsa.id_dichiarazione=comp_nucleo_fsa.id_dichiarazione"
                Dim myReader257 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader257.Read Then
                    trovati = trovati & par.IfNull(myReader257("pg"), "") & " -FSA</br>"
                End If
                myReader257.Close()

                par.cmd.CommandText = "select domande_bando_cambi.pg from domande_bando_cambi,comp_nucleo_cambi where comp_nucleo_cambi.cod_fiscale='" & par.IfNull(myReader2("cod_fiscale"), "") & "' and domande_bando_cambi.id_dichiarazione=comp_nucleo_cambi.id_dichiarazione"
                myReader257 = par.cmd.ExecuteReader()
                If myReader257.Read Then
                    trovati = trovati & par.IfNull(myReader257("pg"), "") & " -CAMBI</br>"
                End If
                myReader257.Close()

                par.cmd.CommandText = "select domande_bando_VSA.pg from domande_bando_VSA,comp_nucleo_VSA where DOMANDE_BANDO_VSA.ID_MOTIVO_DOMANDA=0 AND comp_nucleo_VSA.cod_fiscale='" & par.IfNull(myReader2("cod_fiscale"), "") & "' and domande_bando_VSA.id_dichiarazione=comp_nucleo_VSA.id_dichiarazione"
                myReader257 = par.cmd.ExecuteReader()
                If myReader257.Read Then
                    trovati = trovati & par.IfNull(myReader257("pg"), "") & " -VOLTURE</br>"
                End If
                myReader257.Close()

                par.cmd.CommandText = "select domande_bando_VSA.pg from domande_bando_VSA,comp_nucleo_VSA where DOMANDE_BANDO_VSA.ID_MOTIVO_DOMANDA=1 AND comp_nucleo_VSA.cod_fiscale='" & par.IfNull(myReader2("cod_fiscale"), "") & "' and domande_bando_VSA.id_dichiarazione=comp_nucleo_VSA.id_dichiarazione"
                myReader257 = par.cmd.ExecuteReader()
                If myReader257.Read Then
                    trovati = trovati & par.IfNull(myReader257("pg"), "") & " -SUBENTRO</br>"
                End If
                myReader257.Close()

                par.cmd.CommandText = "select domande_bando_VSA.pg from domande_bando_VSA,comp_nucleo_VSA where DOMANDE_BANDO_VSA.ID_MOTIVO_DOMANDA=2 AND comp_nucleo_VSA.cod_fiscale='" & par.IfNull(myReader2("cod_fiscale"), "") & "' and domande_bando_VSA.id_dichiarazione=comp_nucleo_VSA.id_dichiarazione"
                myReader257 = par.cmd.ExecuteReader()
                If myReader257.Read Then
                    trovati = trovati & par.IfNull(myReader257("pg"), "") & " -AMPLIAM.</br>"
                End If
                myReader257.Close()

                par.cmd.CommandText = "select domande_bando_VSA.pg from domande_bando_VSA,comp_nucleo_VSA where DOMANDE_BANDO_VSA.ID_MOTIVO_DOMANDA=3 AND comp_nucleo_VSA.cod_fiscale='" & par.IfNull(myReader2("cod_fiscale"), "") & "' and domande_bando_VSA.id_dichiarazione=comp_nucleo_VSA.id_dichiarazione"
                myReader257 = par.cmd.ExecuteReader()
                If myReader257.Read Then
                    trovati = trovati & par.IfNull(myReader257("pg"), "") & " -RID.CANONE</br>"
                End If
                myReader257.Close()

                par.cmd.CommandText = "select domande_bando_VSA.pg from domande_bando_VSA,comp_nucleo_VSA where DOMANDE_BANDO_VSA.ID_MOTIVO_DOMANDA=4 AND comp_nucleo_VSA.cod_fiscale='" & par.IfNull(myReader2("cod_fiscale"), "") & "' and domande_bando_VSA.id_dichiarazione=comp_nucleo_VSA.id_dichiarazione"
                myReader257 = par.cmd.ExecuteReader()
                If myReader257.Read Then
                    trovati = trovati & par.IfNull(myReader257("pg"), "") & " -ART.22C.10</br>"
                End If
                myReader257.Close()

                If trovati <> "" Then
                    CType(Generale1.FindControl("lblDomandeInCorso"), Label).Text = trovati
                End If

            Else
            End If

        Loop
        myReader2.Close()

        'CARICAMENTO OCCUPANTI
        par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.data_inizio,SOGGETTI_CONTRATTUALI.data_fine,SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE,TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",ANAGRAFICA.* FROM SISCOM_MI.TIPOLOGIA_PARENTELA,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE TIPOLOGIA_PARENTELA.COD=SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_PARENTELA AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND  COD_TIPOLOGIA_OCCUPANTE<>'INTE' AND ID_CONTRATTO=" & lIdContratto & " and NVL(data_fine,'29991231') >= '" & Format(Now(), "yyyyMMdd") & "'"
        myReader2 = par.cmd.ExecuteReader()
        Do While myReader2.Read
            If par.IfNull(myReader2("RAGIONE_SOCIALE"), "") = "" Then
                par.cmd.CommandText = "select domande_bando_fsa.pg from domande_bando_fsa,comp_nucleo_fsa where comp_nucleo_fsa.cod_fiscale='" & par.IfNull(myReader2("cod_fiscale"), "") & "' and domande_bando_fsa.id_dichiarazione=comp_nucleo_fsa.id_dichiarazione"
                Dim myReader257 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader257.Read Then
                    trovati = trovati & par.IfNull(myReader257("pg"), "") & " -FSA</br>"
                End If
                myReader257.Close()

                par.cmd.CommandText = "select domande_bando_cambi.pg from domande_bando_cambi,comp_nucleo_cambi where comp_nucleo_cambi.cod_fiscale='" & par.IfNull(myReader2("cod_fiscale"), "") & "' and domande_bando_cambi.id_dichiarazione=comp_nucleo_cambi.id_dichiarazione"
                myReader257 = par.cmd.ExecuteReader()
                If myReader257.Read Then
                    trovati = trovati & par.IfNull(myReader257("pg"), "") & " -CAMBI</br>"
                End If
                myReader257.Close()

                par.cmd.CommandText = "select domande_bando_VSA.pg from domande_bando_VSA,comp_nucleo_VSA where (DOMANDE_BANDO_VSA.ID_CAUSALE_DOMANDA=0 OR DOMANDE_BANDO_VSA.ID_CAUSALE_DOMANDA=2) AND comp_nucleo_VSA.cod_fiscale='" & par.IfNull(myReader2("cod_fiscale"), "") & "' and domande_bando_VSA.id_dichiarazione=comp_nucleo_VSA.id_dichiarazione"
                myReader257 = par.cmd.ExecuteReader()
                If myReader257.Read Then
                    trovati = trovati & par.IfNull(myReader257("pg"), "") & " -VOLTURE</br>"
                End If
                myReader257.Close()

                If trovati <> "" Then
                    CType(Generale1.FindControl("lblDomandeInCorso"), Label).Text = trovati
                End If
            Else
            End If

        Loop
        myReader2.Close()
        CaricaDomandeInCorso = ""
    End Function



    Private Function MESE(ByVal TESTO As String) As String
        Select Case TESTO
            Case "01"
                MESE = "Gennaio"
            Case "02"
                MESE = "Febbraio"
            Case "03"
                MESE = "Marzo"
            Case "04"
                MESE = "Aprile"
            Case "05"
                MESE = "Maggio"
            Case "06"
                MESE = "Giugno"
            Case "07"
                MESE = "Luglio"
            Case "08"
                MESE = "Agosto"
            Case "09"
                MESE = "Settembre"
            Case "10"
                MESE = "Ottobre"
            Case "11"
                MESE = "Novembre"
            Case "12"
                MESE = "Dicembre"
        End Select
    End Function


    Public Property LetteraERP() As String
        Get
            If Not (ViewState("par_LetteraERP") Is Nothing) Then
                Return CStr(ViewState("par_LetteraERP"))
            Else
                Return "A"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_LetteraERP") = value
        End Set

    End Property

    Public Property CodContratto1() As String
        Get
            If Not (ViewState("par_CodContratto") Is Nothing) Then
                Return CStr(ViewState("par_CodContratto"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_CodContratto") = value
        End Set

    End Property

    Public Property FL_NuovoContratto() As String
        Get
            If Not (ViewState("par_FL_NuovoContratto") Is Nothing) Then
                Return CStr(ViewState("par_FL_NuovoContratto"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_FL_NuovoContratto") = value
        End Set

    End Property

    Public Property origineContratto() As Integer
        Get
            If Not (ViewState("par_origineContratto") Is Nothing) Then
                Return CInt(ViewState("par_origineContratto"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Integer)
            ViewState("par_origineContratto") = value
        End Set

    End Property


    Public Property lIdConnessione() As String
        Get
            If Not (ViewState("par_lIdConnessione") Is Nothing) Then
                Return CStr(ViewState("par_lIdConnessione"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_lIdConnessione") = value
        End Set

    End Property

    Public Property sSCALA() As String
        Get
            If Not (ViewState("par_sSCALA") Is Nothing) Then
                Return CStr(ViewState("par_sSCALA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sSCALA") = value
        End Set

    End Property

    Public Property sPiano() As String
        Get
            If Not (ViewState("par_sPiano") Is Nothing) Then
                Return CStr(ViewState("par_sPiano"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sPiano") = value
        End Set

    End Property

    Public Property sInterno() As String
        Get
            If Not (ViewState("par_sInterno") Is Nothing) Then
                Return CStr(ViewState("par_sInterno"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sInterno") = value
        End Set

    End Property

    Public Property sSub() As String
        Get
            If Not (ViewState("par_sSub") Is Nothing) Then
                Return CStr(ViewState("par_sSub"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sSub") = value
        End Set

    End Property

    Public Property sFoglio() As String
        Get
            If Not (ViewState("par_sFoglio") Is Nothing) Then
                Return CStr(ViewState("par_sFoglio"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sFoglio") = value
        End Set

    End Property

    Public Property sCatastale() As String
        Get
            If Not (ViewState("par_sCatastale") Is Nothing) Then
                Return CStr(ViewState("par_sCatastale"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCatastale") = value
        End Set

    End Property

    Public Property sClasse() As String
        Get
            If Not (ViewState("par_sClasse") Is Nothing) Then
                Return CStr(ViewState("par_sClasse"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sClasse") = value
        End Set

    End Property

    Public Property sIdEdificio() As Long
        Get
            If Not (ViewState("par_sIdEdificio") Is Nothing) Then
                Return CLng(ViewState("par_sIdEdificio"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_sIdEdificio") = value
        End Set
    End Property

    Public Property sIdComplesso() As Long
        Get
            If Not (ViewState("par_sIdComplesso") Is Nothing) Then
                Return CLng(ViewState("par_sIdComplesso"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_sIdComplesso") = value
        End Set
    End Property

    Public Property sRendita() As String
        Get
            If Not (ViewState("par_sRendita") Is Nothing) Then
                Return CStr(ViewState("par_sRendita"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sRendita") = value
        End Set

    End Property


    Public Property DataDisponibilitaAlloggio() As String
        Get
            If Not (ViewState("par_DataDisponibilita") Is Nothing) Then
                Return CStr(ViewState("par_DataDisponibilita"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_DataDisponibilita") = value
        End Set

    End Property


    '

    Public Property VAL_LOCATIVO_UNITA() As String
        Get
            If Not (ViewState("par_VAL_LOCATIVO_UNITA") Is Nothing) Then
                Return CStr(ViewState("par_VAL_LOCATIVO_UNITA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_VAL_LOCATIVO_UNITA") = value
        End Set

    End Property

    Public Property TIPO_CANONE_APPLICATO() As String
        Get
            If Not (ViewState("par_TIPO_CANONE_APPLICATO") Is Nothing) Then
                Return CStr(ViewState("par_TIPO_CANONE_APPLICATO"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_TIPO_CANONE_APPLICATO") = value
        End Set

    End Property

    Public Property CANONE_ALTERNATIVO() As String
        Get
            If Not (ViewState("par_CANONE_ALTERNATIVO") Is Nothing) Then
                Return CStr(ViewState("par_CANONE_ALTERNATIVO"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_CANONE_ALTERNATIVO") = value
        End Set

    End Property


    Public Property NUMERO_OFFERTA() As String
        Get
            If Not (ViewState("par_NUMERO_OFFERTA") Is Nothing) Then
                Return CStr(ViewState("par_NUMERO_OFFERTA"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_NUMERO_OFFERTA") = value
        End Set

    End Property

    Public Property sParticella() As String
        Get
            If Not (ViewState("par_sParticella") Is Nothing) Then
                Return CStr(ViewState("par_sParticella"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sParticella") = value
        End Set

    End Property

    Public Property SolaLettura() As String
        Get
            If Not (ViewState("par_SolaLettura") Is Nothing) Then
                Return CStr(ViewState("par_SolaLettura"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_SolaLettura") = value
        End Set
    End Property





    Public Property UnitaContratto() As Long
        Get
            If Not (ViewState("par_UnitaContratto") Is Nothing) Then
                Return CLng(ViewState("par_UnitaContratto"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_UnitaContratto") = value
        End Set

    End Property

    Public Property CanoneCorrente() As Double
        Get
            If Not (ViewState("par_CanoneCorrente") Is Nothing) Then
                Return CDbl(ViewState("par_CanoneCorrente"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Double)
            ViewState("par_CanoneCorrente") = value
        End Set

    End Property


    Public Property sAnnoSchema() As String
        Get
            If Not (ViewState("par_sAnnoSchema") Is Nothing) Then
                Return CStr(ViewState("par_sAnnoSchema"))
            Else
                Return "2010"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sAnnoSchema") = value
        End Set

    End Property

    'Public Property sCanone() As String
    '    Get
    '        If Not (ViewState("par_sPERC_INC_MAX_ISE_ERP") Is Nothing) Then
    '            Return CStr(ViewState("par_sPERC_INC_MAX_ISE_ERP"))
    '        Else
    '            Return ""
    '        End If
    '    End Get

    '    Set(ByVal value As String)
    '        ViewState("par_sPERC_INC_MAX_ISE_ERP") = value
    '    End Set
    'End Property

    Public Property sISEE() As String
        Get
            If Not (ViewState("par_sISEE") Is Nothing) Then
                Return CStr(ViewState("par_sISEE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sISEE") = value
        End Set
    End Property

    Public Property sISE() As String
        Get
            If Not (ViewState("par_sISE") Is Nothing) Then
                Return CStr(ViewState("par_sISE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sISE") = value
        End Set
    End Property

    Public Property sVSE() As String
        Get
            If Not (ViewState("par_sVSE") Is Nothing) Then
                Return CStr(ViewState("par_sVSE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sVSE") = value
        End Set
    End Property


    Public Property sPSE() As String
        Get
            If Not (ViewState("par_sPSE") Is Nothing) Then
                Return CStr(ViewState("par_sPSE"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sPSE") = value
        End Set
    End Property

    Public Property sISP() As String
        Get
            If Not (ViewState("par_sISP") Is Nothing) Then
                Return CStr(ViewState("par_sISP"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sISP") = value
        End Set
    End Property


    Public Property sISR() As String
        Get
            If Not (ViewState("par_sISR") Is Nothing) Then
                Return CStr(ViewState("par_sISR"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sISR") = value
        End Set
    End Property

    Public Property sREDD_DIP() As String
        Get
            If Not (ViewState("par_sREDD_DIP") Is Nothing) Then
                Return CStr(ViewState("par_sREDD_DIP"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sREDD_DIP") = value
        End Set
    End Property

    Public Property sREDD_ALT() As String
        Get
            If Not (ViewState("par_sREDD_ALT") Is Nothing) Then
                Return CStr(ViewState("par_sREDD_ALT"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sREDD_ALT") = value
        End Set
    End Property

    Public Property sLimitePensione() As String
        Get
            If Not (ViewState("par_sLimitePensione") Is Nothing) Then
                Return CStr(ViewState("par_sLimitePensione"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sLimitePensione") = value
        End Set
    End Property

    Public Property sPER_VAL_LOC() As String
        Get
            If Not (ViewState("par_sPER_VAL_LOC") Is Nothing) Then
                Return CStr(ViewState("par_sPER_VAL_LOC"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sPER_VAL_LOC") = value
        End Set
    End Property


    Public Property sCanone() As String
        Get
            If Not (ViewState("par_sCanone") Is Nothing) Then
                Return CStr(ViewState("par_sCanone"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCanone") = value
        End Set
    End Property

    Public Property sPERC_INC_MAX_ISE_ERP() As String
        Get
            If Not (ViewState("par_sPERC_INC_MAX_ISE_ERP") Is Nothing) Then
                Return CStr(ViewState("par_sPERC_INC_MAX_ISE_ERP"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sPERC_INC_MAX_ISE_ERP") = value
        End Set
    End Property

    Public Property sCANONE_MIN() As String
        Get
            If Not (ViewState("par_sCANONE_MIN") Is Nothing) Then
                Return CStr(ViewState("par_sCANONE_MIN"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sCANONE_MIN") = value
        End Set
    End Property

    Public Property sISE_MIN() As String
        Get
            If Not (ViewState("par_sISE_MIN") Is Nothing) Then
                Return CStr(ViewState("par_sISE_MIN"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sISE_MIN") = value
        End Set
    End Property





    Public Property LetteraProvenienza() As String
        Get
            If Not (ViewState("par_LetteraProvenienza") Is Nothing) Then
                Return CStr(ViewState("par_LetteraProvenienza"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_LetteraProvenienza") = value
        End Set

    End Property


    Public Property AreaEconomica() As Integer
        Get
            If Not (ViewState("par_AreaEconomica") Is Nothing) Then
                Return CInt(ViewState("par_AreaEconomica"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Integer)
            ViewState("par_AreaEconomica") = value
        End Set

    End Property


    Public Property TipoContratto() As Long
        Get
            If Not (ViewState("par_TipoContratto") Is Nothing) Then
                Return CLng(ViewState("par_TipoContratto"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_TipoContratto") = value
        End Set

    End Property

    Public Property lIdDomandaERP() As Long
        Get
            If Not (ViewState("par_lIdDomandaERP") Is Nothing) Then
                Return CLng(ViewState("par_lIdDomandaERP"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_lIdDomandaERP") = value
        End Set

    End Property

    Public Property lIdAU() As Long
        Get
            If Not (ViewState("par_lIdAU") Is Nothing) Then
                Return CLng(ViewState("par_lIdAU"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_lIdAU") = value
        End Set

    End Property

    Public Property lIdDichiarazione() As Long
        Get
            If Not (ViewState("par_lIdDichiarazione") Is Nothing) Then
                Return CLng(ViewState("par_lIdDichiarazione"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_lIdDichiarazione") = value
        End Set

    End Property

    Public Property lIdContratto() As Long
        Get
            If Not (ViewState("par_lIdContratto") Is Nothing) Then
                Return CLng(ViewState("par_lIdContratto"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_lIdContratto") = value
        End Set

    End Property

    Protected Sub Page_LoadComplete(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.LoadComplete
        Tab1 = ""
        Tab2 = ""
        Tab3 = ""
        Tab4 = ""
        Tab5 = ""
        Tab6 = ""
        Tab7 = ""
        Tab8 = ""
        Tab9 = ""
        Tab10 = ""
        Tab11 = ""
        Tab12 = ""
        Select Case txttab.Value
            Case "1"
                Tab1 = "tabbertabdefault"
            Case "2"
                Tab2 = "tabbertabdefault"
            Case "3"
                Tab3 = "tabbertabdefault"
            Case "4"
                Tab4 = "tabbertabdefault"
            Case "5"
                Tab5 = "tabbertabdefault"
            Case "6"
                Tab6 = "tabbertabdefault"
            Case "7"
                Tab7 = "tabbertabdefault"
            Case "8"
                Tab8 = "tabbertabdefault"
            Case "9"
                Tab9 = "tabbertabdefault"
            Case "10"
                Tab10 = "tabbertabdefault"
            Case "11"
                Tab11 = "tabbertabdefault"
            Case "12"
                Tab12 = "tabbertabdefault"
        End Select
        If CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedValue <> "NONE" Then
            VisibileOA = "style=" & Chr(34) & "visibility:hidden" & Chr(34)
        Else
            If Session.Item("RU_GESTIONE_OA") = "0" Then
                VisibileOA = "style=" & Chr(34) & "visibility:hidden" & Chr(34)
            End If
        End If
        ScriptManager.RegisterStartupScript(Page, GetType(Page), "MyScriptKey111", "document.getElementById('Attesa').style.visibility = 'hidden';", True)
    End Sub

    Protected Sub imgEsci_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs) Handles imgEsci.Click
        If txtModificato.Value <> "111" And txtModificato.Value <> "222" Then

            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.OracleConn.Close()

            Session.Item("LAVORAZIONE") = "0"
            Session.Remove("IDBollCOP")
            'Session.Remove("CONT_LETTURA")
            HttpContext.Current.Session.Remove(lIdConnessione)
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()


            Response.Write("<script>window.close();</script>")
        Else
            txtModificato.Value = "1"
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
        End If
    End Sub


    Public Function SalvaDati()
        Dim I As Integer
        Dim FREQ_VAR_ISTAT As String = ""
        Dim PERC_ISTAT As Double = 0
        Dim StatoRapporto As String = "LEGIT" 'legittimo o illegittimo
        Dim dataRiconsegna As String = ""
        Dim TIPORAPP As String = ""

        Try

            CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text = DataScadCont.Value
            CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Text = DataScadRinn.Value

            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans

            Tab_Azioni_Legali1.ImgButSave()

            If nuovocanone.Value <> "0" Then
                CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text = nuovocanone.Value
                nuovocanone.Value = 0
            End If

            If pressoCOR.Value <> "" Then
                CType(Tab_Comunicazioni1.FindControl("txtPresso"), TextBox).Text = pressoCOR.Value
                pressoCOR.Value = ""
            End If

            If dataScad1.Value <> "0" Then
                CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text = dataScad1.Value
                dataScad1.Value = "0"
            End If
            If dataScad2.Value <> "0" Then
                CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Text = dataScad2.Value
                dataScad2.Value = "0"
            End If

            If Session.Item("dataRic") <> "" Then
                CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text = Session.Item("dataRic")
                Session.Item("dataRic") = ""
                MostrMsgSalva.Value = "0"
            End If

            par.cmd.CommandText = "SELECT DATA_RICONSEGNA FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID =" & lIdContratto & " AND DATA_RICONSEGNA IS NOT NULL"
            Dim myReaderRU As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderRU.Read Then
                dataChisura392.Value = par.FormattaData(par.IfNull(myReaderRU("DATA_RICONSEGNA"), Format(Now, "yyyyMMdd")))
            End If
            myReaderRU.Close()


            '21/05/2016 MT: Setto hiddenfield per chiusura contratto 392
            If contrattoST.Value = "1" Then
                If CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text = "" Then
                    CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text = dataChisura392.Value
                End If
                contrattoST.Value = "0"
            Else
                If dataChisura392.Value <> "0" Then
                    If CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text = "" Then
                        CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text = dataChisura392.Value
                    End If
                    CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text = dataChisura392.Value
                    dataChisura392.Value = "0"
                    imgChiudiContratto.Visible = False
                End If
            End If
            '21/05/2016 fine MT: Setto hiddenfield per chiusura contratto 392

            'If (par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text) < Format(Now, "yyyyMMdd")) And (par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) > par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Text)) Then
            'If CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text = "" Then
            '    Response.Write("<script>alert('Attenzione...La data decorrenza del contratto deve essere inserita prima di salvare!\nOperazione non effettuata!');</script>")
            '    Exit Function
            'End If

            If DataDisponibilitaAlloggio <> "" And CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text <> "" Then
                If par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) < DataDisponibilitaAlloggio Then
                    Response.Write("<script>alert('Attenzione...La data decorrenza del contratto deve essere uguale o successiva alla data di disponibilità dell\'alloggio  " & par.FormattaData(DataDisponibilitaAlloggio) & " !\nOperazione non effettuata!');</script>")
                    Exit Function
                End If

                If par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataConsegna"), TextBox).Text) < DataDisponibilitaAlloggio And CType(Tab_Contratto1.FindControl("txtDataConsegna"), TextBox).Text <> "" Then
                    Response.Write("<script>alert('Attenzione...La data di Consegna deve essere uguale o successiva alla data di disponibilità dell\'alloggio " & par.FormattaData(DataDisponibilitaAlloggio) & " !\nOperazione non effettuata!');</script>")
                    Exit Function
                End If
            End If


            If par.IfEmpty(CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Comunicazioni1.FindControl("txtViaCor"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Comunicazioni1.FindControl("txtCivicoCor"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Comunicazioni1.FindControl("txtSiglaCor"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Comunicazioni1.FindControl("txtCAPCOR"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Comunicazioni1.FindControl("txtPresso"), TextBox).Text, "") = "" Then
                Response.Write("<script>alert('I dati del recapito non sono completi!\nOperazione non effettuata!');</script>")
                Exit Function
            End If

            'MAX 23/01/2018
            If par.IfEmpty(CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Text, "") <> "" Then
                If InStr(CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Text, "@") = 0 Then
                    Response.Write("<script>alert('Indirizzo e-mail nel Tab Comunicazioni non valido!\nOperazione non effettuata!');</script>")
                    Exit Function
                End If
            End If
            If par.IfEmpty(CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Text, "") <> "" Then
                If InStr(CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Text, "@") = 0 Then
                    Response.Write("<script>alert('Indirizzo e-mail PEC nel Tab Comunicazioni non valido!\nOperazione non effettuata!');</script>")
                    Exit Function
                End If
            End If

            If CType(Generale1.FindControl("lblStato"), Label).Text = "BOZZA" Then
                If par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).Text, "") = "" Then
                    Response.Write("<script>alert('La delibera, la data della delibera o la data di trasmissione della delibera non sono validi!\nOperazione non effettuata!');</script>")
                    Exit Function
                End If
            Else
                If par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text, "") = "" Then
                    Response.Write("<script>alert('La delibera, la data della delibera o la data di trasmissione della delibera non sono validi!\nOperazione non effettuata!');</script>")
                    Exit Function
                End If
            End If



            If CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).SelectedItem.Value = "U" And Val(par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).Text, "0")) <= 1 Then
                Response.Write("<script>alert('Attenzione...Non è possibile impostare SOLUZIONE UNICA come tipologia di pagamento imposte se la durata è minore o uguale a 1 anno! Operazione non effettuata!');</script>")
                Exit Function
            End If
            If CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedValue = "NONE" Then
                If Session.Item("RU_GESTIONE_OA") = "1" Then
                If ControlloOAObb() = False Then
                    ScriptManager.RegisterStartupScript(Me, Me.GetType(), "alert", "alert('Valorizzare i campi obbligatori presenti all\'interno del tab O.A!');", True)
                    Exit Function
                End If
            End If
            End If


            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID =" & lIdContratto
            Dim myReaderDEC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderDEC.Read Then
                'SE VI E' UNA PROPOSTA DI DECADENZA VISUALIZZO L'ALERT NELLA VIDEATA PRINCIPALE DEL CONTRATTO
                If par.IfNull(myReaderDEC("FL_PROP_DECADENZA"), 0) = 1 Then
                    CType(Generale1.FindControl("img_ALERT"), System.Web.UI.WebControls.Image).Visible = True
                    CType(Generale1.FindControl("LBLDECADENZA"), Label).Visible = True
                Else
                    CType(Generale1.FindControl("img_ALERT"), System.Web.UI.WebControls.Image).Visible = False
                    CType(Generale1.FindControl("LBLDECADENZA"), Label).Visible = False
                End If
                TipoContratto = par.IfNull(myReaderDEC("PROVENIENZA_ASS"), "")
            End If
            myReaderDEC.Close()

            If ((par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Text) <> "" Or par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Text) <> "") And par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text) = "") Then

                Response.Write("<script>alert('E\' necessario immettere la data di disdetta prima di procedere alle operazioni di pre-sloggio e sloggio!\nOperazione non effettuata!');</script>")
                Exit Function

            End If





            If par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Text) <> "" And CType(Tab_Contratto1.FindControl("txtOraAppPreSloggio"), TextBox).Text = "" Then

                Response.Write("<script>alert('Inserire l\'ora di appuntamento Pre-sloggio!\nOperazione non effettuata!');</script>")
                Exit Function

            End If


            If par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Text) = "" And CType(Tab_Contratto1.FindControl("txtOraAppPreSloggio"), TextBox).Text <> "" Then

                Response.Write("<script>alert('Inserire la data di appuntamento Pre-sloggio!\nOperazione non effettuata!');</script>")
                Exit Function

            End If





            If par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Text) <> "" And CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).Text = "" Then

                Response.Write("<script>alert('Inserire l\'ora di appuntamento Sloggio!\nOperazione non effettuata!');</script>")
                Exit Function

            End If


            If par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Text) = "" And CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).Text <> "" Then

                Response.Write("<script>alert('Inserire la data di appuntamento Sloggio!\nOperazione non effettuata!');</script>")
                Exit Function

            End If



            If par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Text) <> "" And par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text) <> "" Then
                If par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Text) < par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text) Then
                    Response.Write("<script>alert('La data di appuntamento Sloggio deve essere successiva alla data di disdetta!\nOperazione non effettuata!');</script>")
                    Exit Function
                End If
            End If



            'If par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Text) <> "" And par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text) <> "" Then
            '    If par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Text) > par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text) Then
            '        Response.Write("<script>alert('La data di appuntamento Pre-sloggio deve essere antecedente alla data di disdetta!\nOperazione non effettuata!');</script>")
            '        Exit Function
            '    End If
            'End If


            If par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Text) <> "" And par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Text) <> "" Then
                If par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Text) > par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Text) Then
                    Response.Write("<script>alert('La data di appuntamento Pre-sloggio deve essere antecedente alla data di appuntamento Sloggio!\nOperazione non effettuata!');</script>")
                    Exit Function
                End If
            End If

            If par.IfEmpty(CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Comunicazioni1.FindControl("txtViaCor"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Comunicazioni1.FindControl("txtCivicoCor"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Comunicazioni1.FindControl("txtSiglaCor"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Comunicazioni1.FindControl("txtCAPCOR"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Comunicazioni1.FindControl("txtPresso"), TextBox).Text, "") = "" Then
                Response.Write("<script>alert('I dati del recapito non sono completi!\nOperazione non effettuata!');</script>")
                Exit Function
            End If

            If CType(Generale1.FindControl("lblStato"), Label).Text = "BOZZA" Then
                If par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).Text, "") = "" Then
                    Response.Write("<script>alert('La delibera o la data della delibera o la data di trasmissione della delibera non sono validi!\nOperazione non effettuata!');</script>")
                    Exit Function
                End If
            Else
                If par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Text, "") = "" Or par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text, "") = "" Then
                    Response.Write("<script>alert('La delibera o la data della delibera o la data di trasmissione della delibera non sono validi!\nOperazione non effettuata!');</script>")
                    Exit Function
                End If
            End If
           

            Dim SINDACATO As String = "NULL"

            If CType(Tab_SchemaBollette1.FindControl("lstSindacati"), DropDownList).SelectedItem.Value <> "-1" Then
                SINDACATO = CType(Tab_SchemaBollette1.FindControl("lstSindacati"), DropDownList).SelectedItem.Value
            End If

            If FL_NuovoContratto = "1" Then

                '11/01/2018 Setto le corrette validtità del canone

                If CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text <> "" Then
                    sANNOINIZIOVAL = par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text)
                End If

                par.cmd.CommandText = "SELECT * FROM utenza_bandi where fine_Canone>'" & sANNOINIZIOVAL & "' order by data_fine desc"
                Dim myReaderUB As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderUB.Read Then
                    sANNOFINEVAL = par.IfNull(myReaderUB("fine_Canone"), "")
                End If
                myReaderUB.Close()


                '***** VERIFICO SE DICHIARAZIONE DI AGG. REDDITI
                Dim aggRedd As Integer = 0
                par.cmd.CommandText = "SELECT * FROM DOMANDE_BANDO_VSA WHERE ID_MOTIVO_DOMANDA = 11 AND ID=" & lIdDomandaERP
                Dim myReaderE1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderE1.Read Then
                    aggRedd = 1
                End If
                myReaderE1.Close()



                If TipoContratto <> "3" And TipoContratto <> "5" And TipoContratto <> "6" And TipoContratto <> "7" And TipoContratto <> "10" And TipoContratto <> "12" Then
                    par.cmd.CommandText = "update SISCOM_MI.unita_assegnate set generato_contratto=1 where id_domanda=" & Request.QueryString("IdDomanda") & " and id_unita=" & Request.QueryString("IdUnita")
                    par.cmd.ExecuteNonQuery()
                Else
                    If TipoContratto = "12" Then
                        par.cmd.CommandText = "update SISCOM_MI.unita_assegnate set generato_contratto=1 where PROVENIENZA='A' and id_unita=" & Request.QueryString("IdUnita") & " AND ID_DICHIARAZIONE=" & lIdDichiarazione
                    End If
                    If TipoContratto = "10" Then
                        par.cmd.CommandText = "update SISCOM_MI.unita_assegnate set generato_contratto=1 where PROVENIENZA='Z' and id_unita=" & Request.QueryString("IdUnita") & " AND ID_DICHIARAZIONE=" & lIdDichiarazione
                    End If
                    If par.IfEmpty(CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedValue, "-1") = 1 Then
                        par.cmd.CommandText = "update SISCOM_MI.unita_assegnate set generato_contratto=1 where id_domanda=" & Request.QueryString("IdDomanda") & " AND PROVENIENZA='Y' and id_unita=" & Request.QueryString("IdUnita")
                    End If
                    If TipoContratto = "3" Then
                        par.cmd.CommandText = "update SISCOM_MI.unita_assegnate set generato_contratto=1 where (PROVENIENZA='U' OR PROVENIENZA='H') and id_unita=" & Request.QueryString("IdUnita")
                    End If
                    If TipoContratto = "5" Then
                        par.cmd.CommandText = "update SISCOM_MI.unita_assegnate set generato_contratto=1 where PROVENIENZA='Q' and id_unita=" & Request.QueryString("IdUnita")
                    End If
                    If TipoContratto = "6" Then
                        par.cmd.CommandText = "update SISCOM_MI.unita_assegnate set generato_contratto=1 where (PROVENIENZA='W' or provenienza='D' or provenienza='V') and id_unita=" & Request.QueryString("IdUnita")
                    End If
                    If TipoContratto = "7" Then
                        par.cmd.CommandText = "update SISCOM_MI.unita_assegnate set generato_contratto=1 where PROVENIENZA='X' and id_unita=" & Request.QueryString("IdUnita")
                        StatoRapporto = "ILLEG"
                    End If
                    par.cmd.ExecuteNonQuery()
                    FREQ_VAR_ISTAT = CType(Tab_Canone1.FindControl("lblistat2"), DropDownList).SelectedItem.Value
                    PERC_ISTAT = CType(Tab_Canone1.FindControl("lblistat4"), DropDownList).SelectedItem.Value
                End If

                'If TipoContratto = "11" Then TipoContratto = "1"

                Dim tipocon As String = TipoContratto

                If TipoContratto = "11" Then tipocon = "1"
                'If TipoContratto = "12" Then tipocon = "1"


                Visibile = "style=" & Chr(34) & "visibility:visible" & Chr(34)

                'btnMavAttivazione.Visible = True
                ImgBolAttivazione.Visible = True

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.RAPPORTI_UTENZA (ID,COD_CONTRATTO,COD_TIPOLOGIA_RAPP_CONTR," _
                                    & "COD_TIPOLOGIA_CONTR_LOC,DURATA_ANNI,DURATA_RINNOVO,DATA_DECORRENZA,DATA_SCADENZA,DATA_DISDETTA_LOCATARIO" _
                                    & ",NUM_REGISTRAZIONE,SERIE_REGISTRAZIONE,IMP_CANONE_INIZIALE,IMP_DEPOSITO_CAUZ" _
                                    & ",DATA_REG,COD_UFFICIO_REG,DATA_STIPULA,DATA_CONSEGNA,DATA_SCADENZA_RINNOVO" _
                                    & ",MESI_DISDETTA,DATA_RICONSEGNA,DELIBERA,DATA_DELIBERA,data_trasm_delibera,NRO_RATE,PER_BANDO" _
                                    & ",TIPO_COR,LUOGO_COR,VIA_COR,NOTE_COR,CIVICO_COR,SIGLA_COR,CAP_COR,PRESSO_COR,MAIL_COR,MAIL_PEC_COR" _
                                    & ",BOZZA,NRO_REPERTORIO,DATA_REPERTORIO,NRO_ASSEGNAZIONE_PG,DATA_ASSEGNAZIONE_PG" _
                                    & ",LIBRETTO_DEPOSITO,ID_DEST_RATE,INVIO_BOLLETTA,FL_CONGUAGLIO,IMP_CANONE_ATTUALE, " _
                                    & "INTERESSI_CAUZIONE,NOTE,PROVENIENZA_ASS,INTERESSI_RIT_PAG,IMPORTO_ANTICIPO,ID_ISEE,ID_DOMANDA,ID_AU,FREQ_VAR_ISTAT," _
                                    & "PERC_ISTAT,ID_COMMISSARIATO,VERSAMENTO_TR,DEST_USO,DESCR_DEST_USO,DATA_INVIO_RIC_DISDETTA,N_OFFERTA," _
                                    & "data_notifica_disdetta,mittente_disdetta,FL_BOLLO_ASSOLTO,FL_ASSEGN_TEMP,FL_TUTORE_STR,SINDACATO,NOTE_REGISTRAZIONE,SCALA_COR," _
                                    & "PIANO_COR,INTERNO_COR,ID_ORIGINE_CONTRATTO,DATA_DECORRENZA_AE,FL_IRREPERIBILE) VALUES (" _
                                    & lIdContratto _
                                    & ",'" & CodContratto1 _
                                    & "','" & StatoRapporto _
                                    & "','" & CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedItem.Value _
                                    & "'," & par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).Text, 0) _
                                    & "," & par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).Text, 0) _
                                    & ",'" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) _
                                    & "','" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text) _
                                    & "','" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text) _
                                    & "','" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Text) _
                                    & "','" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtSerie"), TextBox).Text) _
                                    & "'," & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text, "NULL")) _
                                    & "," & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, "NULL")) _
                                    & ",'" & par.AggiustaData(CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Text) _
                                    & "','" & CType(Tab_Registrazione1.FindControl("cmbUfficioRegistro"), DropDownList).SelectedValue _
                                    & "','" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Text) _
                                    & "','" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataConsegna"), TextBox).Text) _
                                    & "','" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Text) _
                                    & "'," & par.IfEmpty(CType(Tab_Contratto1.FindControl("txtEntroCuiDisdettare"), TextBox).Text, "NULL") _
                                    & ",'" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text) _
                                    & "','" & par.PulisciStrSql(CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Text) _
                                    & "','" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text) _
                                    & "','" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).Text) _
                                    & "'," & CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedValue _
                                    & ",1" _
                                    & ",'" & Trim(par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("cmbTipoViaCor"), DropDownList).SelectedItem.Text)) _
                                    & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text) _
                                    & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtViaCor"), TextBox).Text) _
                                    & "','" _
                                    & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtCivicoCor"), TextBox).Text) _
                                    & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtSiglaCor"), TextBox).Text) _
                                    & "','" & CType(Tab_Comunicazioni1.FindControl("txtCAPCOR"), TextBox).Text _
                                    & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtPresso"), TextBox).Text) _
                                    & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Text) _
                                    & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Text) _
                                    & "',1" _
                                    & ",'" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).Text) _
                                    & "','" & par.AggiustaData(CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Text) _
                                    & "','" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Text) _
                                    & "','" & par.AggiustaData(CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Text) _
                                    & "','" & par.PulisciStrSql(CType(Tab_Canone1.FindControl("txtLibrettoDeposito"), TextBox).Text) _
                                    & "'," & CType(Tab_Canone1.FindControl("cmbDestRate"), DropDownList).SelectedValue _
                                    & ",'" & Valore01(CType(Tab_Canone1.FindControl("checkInvioBoll"), CheckBox).Checked) _
                                    & "','" & Valore01(CType(Tab_Canone1.FindControl("checkConguaglioBoll"), CheckBox).Checked) _
                                    & "'," & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Text, "NULL")) _
                                    & ",'" & Valore01(CType(Tab_Canone1.FindControl("checkInteressiCauzione"), CheckBox).Checked) _
                                    & "',''," & tipocon _
                                    & ",'" & Valore01(CType(Tab_Canone1.FindControl("chRitardoPagamenti"), CheckBox).Checked) _
                                    & "'," & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text, 0)) _
                                    & "," & lIdDichiarazione & "," & lIdDomandaERP & ",NULL,'" & FREQ_VAR_ISTAT & "'," & PERC_ISTAT _
                                    & "," & CType(Tab_Comunicazioni1.FindControl("cmbCommissariato"), DropDownList).SelectedItem.Value _
                                    & ",'" & CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).SelectedItem.Value _
                                    & "','" & CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Value _
                                    & "','" & par.PulisciStrSql(CType(Tab_Contratto1.FindControl("txtDescrDestinazione"), TextBox).Text) _
                                    & "','" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDisdetta0"), TextBox).Text) & "','" & NUMERO_OFFERTA _
                                    & "','" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtNotificaDisdetta"), TextBox).Text) _
                                    & "'," & CType(Tab_Contratto1.FindControl("cmbMittenteDisdetta"), DropDownList).SelectedValue _
                                    & ",'" & Valore01(CType(Tab_Contratto1.FindControl("ChBolloEsente"), CheckBox).Checked) _
                                    & "','" & Valore01(CType(Tab_Contratto1.FindControl("chkTemporanea"), CheckBox).Checked) _
                                    & "'," & Valore01(CType(Tab_Contratto1.FindControl("ChTutore"), CheckBox).Checked) _
                                    & ",'" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtNotereg"), TextBox).Text) _
                                    & "'," & SINDACATO & "" _
                                    & ",'" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtScalaCor"), TextBox).Text) _
                                    & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtPianoCor"), TextBox).Text) _
                                    & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtInternoCor"), TextBox).Text) & "'" _
                                    & "," & par.insDbValue(CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedValue, False, False, True) & "" _
                                    & ",'" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Text) & "'" _
                                    & "," & Valore01(CType(Tab_Comunicazioni1.FindControl("chkIrreperibile"), CheckBox).Checked) & ")"


                par.cmd.ExecuteNonQuery()

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                    & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                    & "'F01','')"
                par.cmd.ExecuteNonQuery()

                If TipoContratto = "7" Then
                    par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET FL_STAMPATO='1' WHERE ID=" & lIdContratto
                    par.cmd.ExecuteNonQuery()
                End If

                If LetteraProvenienza = "D" Then
                    par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET ART_15=2 WHERE ID=" & lIdContratto
                    par.cmd.ExecuteNonQuery()
                End If
                If LetteraProvenienza = "V" Then
                    par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET ART_15=3 WHERE ID=" & lIdContratto
                    par.cmd.ExecuteNonQuery()
                End If
                If CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedValue = "NONE" Then
                    If Session.Item("RU_GESTIONE_OA") = "1" Then
                    SalvaOccupanteAbusivo()
                End If
                End If

                Select Case TipoContratto
                    Case "1", "2"
                        Generale1.IndiceAnagrafe = "-1"
                        Generale1.IndiceDomanda = CStr(lIdDomandaERP)
                        Generale1.IndiceDichiarazione = CStr(lIdDichiarazione)
                    Case "10"
                        Generale1.IndiceAnagrafe = "-1"
                        Generale1.IndiceDomanda = "-1"
                        Generale1.IndiceDichiarazione = CStr(lIdDichiarazione)
                    Case "3", "5", "6", "7", "11", "12"
                        Generale1.IndiceAnagrafe = "-1"
                        Generale1.IndiceDomanda = "-1"
                        Generale1.IndiceDichiarazione = "-1"
                End Select

                ''RIPORTO I COMPONENTI DEL NUCLEO DI SEPA NELLA TABELLA ANAGRAFICA
                Dim NAZIONALITA As String = ""
                Dim INTESTATARIO As String = ""
                Dim DOC_SOGGIORNO As String = ""

                If TipoContratto = "1" Or LetteraProvenienza = "D" Or LetteraProvenienza = "V" Then

                    If LetteraProvenienza <> "D" And LetteraProvenienza <> "V" Then
                        Generale1.Provenienza = "1"
                    End If
                    DOC_SOGGIORNO = ""

                    par.cmd.CommandText = "SELECT DOMANDE_BANDO.PERMESSO_SOGG_N,DOMANDE_BANDO.PERMESSO_SOGG_DATA,DOMANDE_BANDO.PERMESSO_SOGG_SCADE,DOMANDE_BANDO.CARTA_SOGG_N,DOMANDE_BANDO.CARTA_SOGG_DATA,DOMANDE_BANDO.TELEFONO_REC_DNTE,DOMANDE_BANDO.CARTA_I,DOMANDE_BANDO.CARTA_I_DATA,DOMANDE_BANDO.CARTA_I_RILASCIATA,TIPOLOGIA_PARENTELA.COD AS ""PARENTE"",COMP_NUCLEO.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO,DOMANDE_BANDO WHERE TIPOLOGIA_PARENTELA.ID_SEPA=COMP_NUCLEO.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND DOMANDE_BANDO.ID=" & lIdDomandaERP & " AND COMP_NUCLEO.ID_DICHIARAZIONE=DOMANDE_BANDO.ID_DICHIARAZIONE ORDER BY COMP_NUCLEO.PROGR ASC"
                    Dim myReaderB As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    Do While myReaderB.Read
                        If par.IfNull(myReaderB("NAZ"), "") = "" Then
                            Response.Write("<script>alert('ATTENZIONE...il codice fiscale " & myReaderB("COD_FISCALE") & "  non è corretto!\nTramite il menu ANAGRAFICA inserire il codice fiscale corretto.');</script>")
                        End If

                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.ANAGRAFICA WHERE COD_FISCALE='" & myReaderB("COD_FISCALE") & "'"
                        Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderC.HasRows = False Then
                            If par.IfNull(myReaderB("SIGLA"), "") = "C" Or par.IfNull(myReaderB("SIGLA"), "") = "E" Then
                                NAZIONALITA = myReaderB("NAZ")
                            Else
                                NAZIONALITA = "ITALIA"
                            End If

                            If par.IfNull(myReaderB("PROGR"), "") = "0" Then
                                If par.IfNull(myReaderB("CARTA_SOGG_N"), "") <> "" Then
                                    DOC_SOGGIORNO = "CARTA SOGG. N. " & par.IfNull(myReaderB("CARTA_SOGG_N"), "") & " DEL " & par.FormattaData(par.IfNull(myReaderB("CARTA_SOGG_DATA"), ""))
                                Else
                                    If par.IfNull(myReaderB("PERMESSO_SOGG_N"), "") <> "" Then
                                        DOC_SOGGIORNO = "PERMESSO SOGG. N. " & par.IfNull(myReaderB("PERMESSO_SOGG_N"), "") & " DEL " & par.FormattaData(par.IfNull(myReaderB("PERMESSO_SOGG_DATA"), "")) & " SCADE IL " & par.FormattaData(par.IfNull(myReaderB("PERMESSO_SOGG_SCADE"), ""))
                                    Else
                                        DOC_SOGGIORNO = ""
                                    End If
                                End If
                            Else
                                DOC_SOGGIORNO = ""
                            End If

                            par.cmd.CommandText = "Insert into SISCOM_MI.ANAGRAFICA (ID, COGNOME, NOME, RAGIONE_SOCIALE, COD_FISCALE, PARTITA_IVA, CITTADINANZA, RESIDENZA, DATA_NASCITA, COD_COMUNE_NASCITA, SESSO, TELEFONO, ID_INDIRIZZO_RECAPITO, TIPO_DOC,NUM_DOC,DATA_DOC,RILASCIO_DOC,COMUNE_RESIDENZA,PROVINCIA_RESIDENZA,INDIRIZZO_RESIDENZA,CIVICO_RESIDENZA,CAP_RESIDENZA,DOC_SOGGIORNO) " _
                                                & " Values " _
                                                & "(SISCOM_MI.SEQ_ANAGRAFICA.NEXTVAL, '" & par.PulisciStrSql(LTrim(RTrim(myReaderB("COGNOME")))) & "', '" & par.PulisciStrSql(LTrim(RTrim(myReaderB("NOME")))) & "','', '" & par.PulisciStrSql(par.IfNull(myReaderB("COD_FISCALE"), "")) & "', " _
                                                & "'', '" & par.PulisciStrSql(NAZIONALITA) & "', '" & par.PulisciStrSql(CType(Generale1.FindControl("lblIndirizzo"), Label).Text) & " ', '" & par.PulisciStrSql(myReaderB("DATA_NASCITA")) & "', '" & Mid(par.IfNull(myReaderB("COD_FISCALE"), "XXXXXXXXXXXXXXXX"), 12, 4) & "', " _
                                                & "'" & par.PulisciStrSql(myReaderB("SESSO")) & "', '" & par.PulisciStrSql(par.IfNull(myReaderB("TELEFONO_REC_DNTE"), "")) & "', NULL, " _
                                                & "0,'" & par.PulisciStrSql(par.IfNull(myReaderB("CARTA_I"), "")) & "','" & par.IfNull(myReaderB("CARTA_I_DATA"), "") & "','" & par.PulisciStrSql(par.IfNull(myReaderB("CARTA_I_RILASCIATA"), "")) & "','" & par.PulisciStrSql(LTrim(RTrim(CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text))) & "','" _
                                                & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtSiglaCor"), TextBox).Text) & "','" & Trim(CType(Tab_Comunicazioni1.FindControl("cmbTipoViaCor"), DropDownList).SelectedItem.Text) & " " & par.PulisciStrSql(LTrim(RTrim(CType(Tab_Comunicazioni1.FindControl("txtViaCor"), TextBox).Text))) & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtCivicoCor"), TextBox).Text) _
                                                & "','" & CType(Tab_Comunicazioni1.FindControl("txtCAPCOR"), TextBox).Text & "','" & par.PulisciStrSql(DOC_SOGGIORNO) & "')"

                            par.cmd.ExecuteNonQuery()


                        Else
                            If myReaderC.Read Then
                                If par.IfNull(myReaderB("SIGLA"), "") = "C" Or par.IfNull(myReaderB("SIGLA"), "") = "E" Then
                                    NAZIONALITA = myReaderB("NAZ")
                                Else
                                    NAZIONALITA = "ITALIA"
                                End If

                                If par.IfNull(myReaderB("PROGR"), "") = "0" Then
                                    If par.IfNull(myReaderB("CARTA_SOGG_N"), "") <> "" Then
                                        DOC_SOGGIORNO = "CARTA SOGG. N. " & par.IfNull(myReaderB("CARTA_SOGG_N"), "") & " DEL " & par.FormattaData(par.IfNull(myReaderB("CARTA_SOGG_DATA"), ""))
                                    Else
                                        If par.IfNull(myReaderB("PERMESSO_SOGG_N"), "") <> "" Then
                                            DOC_SOGGIORNO = "PERMESSO SOGG. N. " & par.IfNull(myReaderB("PERMESSO_SOGG_N"), "") & " DEL " & par.FormattaData(par.IfNull(myReaderB("PERMESSO_SOGG_DATA"), "")) & " SCADE IL " & par.FormattaData(par.IfNull(myReaderB("PERMESSO_SOGG_SCADE"), ""))
                                        Else
                                            DOC_SOGGIORNO = ""
                                        End If
                                    End If
                                Else
                                    DOC_SOGGIORNO = ""
                                End If

                                par.cmd.CommandText = "update SISCOM_MI.ANAGRAFICA set COD_COMUNE_NASCITA='" & Mid(myReaderB("COD_FISCALE"), 12, 4) & "', SESSO='" & par.PulisciStrSql(myReaderB("SESSO")) _
                                                    & "', TELEFONO='" & par.PulisciStrSql(par.IfNull(myReaderB("TELEFONO_REC_DNTE"), "")) _
                                                    & "', TIPO_DOC=0,NUM_DOC='" & par.PulisciStrSql(par.IfNull(myReaderB("CARTA_I"), "")) _
                                                    & "',DATA_DOC='" & par.IfNull(myReaderB("CARTA_I_DATA"), "") _
                                                    & "',RILASCIO_DOC='" & par.PulisciStrSql(LTrim(RTrim(par.IfNull(myReaderB("CARTA_I_RILASCIATA"), "")))) _
                                                    & "',COMUNE_RESIDENZA='" & par.PulisciStrSql(LTrim(RTrim(CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text))) _
                                                    & "',PROVINCIA_RESIDENZA='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtSiglaCor"), TextBox).Text) _
                                                    & "',INDIRIZZO_RESIDENZA='" & Trim(CType(Tab_Comunicazioni1.FindControl("cmbTipoViaCor"), DropDownList).SelectedItem.Text) & " " & par.PulisciStrSql(LTrim(RTrim(CType(Tab_Comunicazioni1.FindControl("txtViaCor"), TextBox).Text))) _
                                                    & "',CIVICO_RESIDENZA='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtCivicoCor"), TextBox).Text) _
                                                    & "',CAP_RESIDENZA='" & CType(Tab_Comunicazioni1.FindControl("txtCAPCOR"), TextBox).Text _
                                                    & "',DOC_SOGGIORNO='" & par.PulisciStrSql(DOC_SOGGIORNO) _
                                                    & "' where id=" & myReaderC("id")

                                par.cmd.ExecuteNonQuery()
                            End If
                        End If
                        myReaderC.Close()
                    Loop
                    myReaderB.Close()
                End If

                If par.IfEmpty(CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedValue, "-1") = 1 Or TipoContratto = "11" Or aggRedd = 1 Then


                    'Generale1.Provenienza = "8"

                    par.cmd.CommandText = "SELECT DOMANDE_BANDO_VSA.PERMESSO_SOGG_N,DOMANDE_BANDO_VSA.PERMESSO_SOGG_DATA,DOMANDE_BANDO_VSA.PERMESSO_SOGG_SCADE,DOMANDE_BANDO_VSA.CARTA_SOGG_N,DOMANDE_BANDO_VSA.CARTA_SOGG_DATA,DOMANDE_BANDO_VSA.TELEFONO_REC_DNTE,DOMANDE_BANDO_VSA.CARTA_I,DOMANDE_BANDO_VSA.CARTA_I_DATA,DOMANDE_BANDO_VSA.CARTA_I_RILASCIATA,TIPOLOGIA_PARENTELA.COD AS ""PARENTE"",COMP_NUCLEO_VSA.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO_VSA,DOMANDE_BANDO_VSA WHERE TIPOLOGIA_PARENTELA.ID_SEPA=COMP_NUCLEO_VSA.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND DOMANDE_BANDO_VSA.ID=" & lIdDomandaERP & " AND COMP_NUCLEO_VSA.ID_DICHIARAZIONE=DOMANDE_BANDO_VSA.ID_DICHIARAZIONE ORDER BY COMP_NUCLEO_VSA.PROGR ASC"
                    Dim myReaderB As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    Do While myReaderB.Read
                        DOC_SOGGIORNO = ""
                        If par.IfNull(myReaderB("NAZ"), "") = "" Then
                            Response.Write("<script>alert('ATTENZIONE...il codice fiscale " & myReaderB("COD_FISCALE") & "  non è corretto!\nTramite il menu ANAGRAFICA inserire il codice fiscale corretto.');</script>")
                        End If
                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.ANAGRAFICA WHERE COD_FISCALE='" & myReaderB("COD_FISCALE") & "'"
                        Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderC.HasRows = False Then
                            If par.IfNull(myReaderB("SIGLA"), "") = "C" Or par.IfNull(myReaderB("SIGLA"), "") = "E" Then
                                NAZIONALITA = myReaderB("NAZ")
                            Else
                                NAZIONALITA = "ITALIA"
                            End If

                            If par.IfNull(myReaderB("PROGR"), "") = "0" Then
                                If par.IfNull(myReaderB("CARTA_SOGG_N"), "") <> "" Then
                                    DOC_SOGGIORNO = "CARTA SOGG. N. " & par.IfNull(myReaderB("CARTA_SOGG_N"), "") & " DEL " & par.FormattaData(par.IfNull(myReaderB("CARTA_SOGG_DATA"), ""))
                                Else
                                    If par.IfNull(myReaderB("PERMESSO_SOGG_N"), "") <> "" Then
                                        DOC_SOGGIORNO = "PERMESSO SOGG. N. " & par.IfNull(myReaderB("PERMESSO_SOGG_N"), "") & " DEL " & par.FormattaData(par.IfNull(myReaderB("PERMESSO_SOGG_DATA"), "")) & " SCADE IL " & par.FormattaData(par.IfNull(myReaderB("PERMESSO_SOGG_SCADE"), ""))
                                    Else
                                        DOC_SOGGIORNO = ""
                                    End If
                                End If
                            Else
                                DOC_SOGGIORNO = ""
                            End If

                            par.cmd.CommandText = "Insert into SISCOM_MI.ANAGRAFICA (ID, COGNOME, NOME, RAGIONE_SOCIALE, COD_FISCALE, PARTITA_IVA, CITTADINANZA, RESIDENZA, DATA_NASCITA, COD_COMUNE_NASCITA, SESSO, TELEFONO, ID_INDIRIZZO_RECAPITO, TIPO_DOC,NUM_DOC,DATA_DOC,RILASCIO_DOC,COMUNE_RESIDENZA,PROVINCIA_RESIDENZA,INDIRIZZO_RESIDENZA,CIVICO_RESIDENZA,CAP_RESIDENZA,DOC_SOGGIORNO) " _
                                                & " Values " _
                                                & "(SISCOM_MI.SEQ_ANAGRAFICA.NEXTVAL, '" & par.PulisciStrSql(LTrim(RTrim(myReaderB("COGNOME")))) & "', '" & par.PulisciStrSql(LTrim(RTrim(myReaderB("NOME")))) & "','', '" & par.PulisciStrSql(myReaderB("COD_FISCALE")) & "', " _
                                                & "'', '" & par.PulisciStrSql(NAZIONALITA) & "', '" & par.PulisciStrSql(CType(Generale1.FindControl("lblIndirizzo"), Label).Text) & " ', '" & par.PulisciStrSql(myReaderB("DATA_NASCITA")) & "', '" & Mid(myReaderB("COD_FISCALE"), 12, 4) & "', " _
                                                & "'" & par.PulisciStrSql(myReaderB("SESSO")) & "', '" & par.PulisciStrSql(par.IfNull(myReaderB("TELEFONO_REC_DNTE"), "")) & "', NULL, " _
                                                & "0,'" & par.PulisciStrSql(par.IfNull(myReaderB("CARTA_I"), "")) & "','" & par.IfNull(myReaderB("CARTA_I_DATA"), "") & "','" & par.PulisciStrSql(par.IfNull(myReaderB("CARTA_I_RILASCIATA"), "")) & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text) & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtSiglaCor"), TextBox).Text) & "','" & Trim(CType(Tab_Comunicazioni1.FindControl("cmbTipoViaCor"), DropDownList).SelectedItem.Text) & " " & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtViaCor"), TextBox).Text) & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtCivicoCor"), TextBox).Text) & "','" & CType(Tab_Comunicazioni1.FindControl("txtCAPCOR"), TextBox).Text & "','" & DOC_SOGGIORNO & "')"

                            par.cmd.ExecuteNonQuery()
                            myReaderC.Close()
                        End If
                        myReaderC.Close()
                    Loop
                    myReaderB.Close()
                End If


                If TipoContratto = "10" Or LetteraProvenienza = "FM" Then
                    Generale1.Provenienza = "10"
                    par.cmd.CommandText = "SELECT DICHIARAZIONI_VSA.*,TIPOLOGIA_PARENTELA.COD AS ""PARENTE"",COMP_NUCLEO_VSA.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO_VSA,DICHIARAZIONI_VSA WHERE TIPOLOGIA_PARENTELA.ID_SEPA=COMP_NUCLEO_VSA.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND DICHIARAZIONI_VSA.ID=" & lIdDichiarazione & " AND COMP_NUCLEO_VSA.ID_DICHIARAZIONE=DICHIARAZIONI_VSA.ID ORDER BY COMP_NUCLEO_VSA.PROGR ASC"
                    Dim myReaderB As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    Do While myReaderB.Read
                        DOC_SOGGIORNO = ""
                        If par.IfNull(myReaderB("NAZ"), "") = "" Then
                            Response.Write("<script>alert('ATTENZIONE...il codice fiscale " & myReaderB("COD_FISCALE") & "  non è corretto!\nTramite il menu ANAGRAFICA inserire il codice fiscale corretto.');</script>")
                        End If
                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.ANAGRAFICA WHERE COD_FISCALE='" & myReaderB("COD_FISCALE") & "'"
                        Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderC.HasRows = False Then
                            If par.IfNull(myReaderB("SIGLA"), "") = "C" Or par.IfNull(myReaderB("SIGLA"), "") = "E" Then
                                NAZIONALITA = myReaderB("NAZ")
                            Else
                                NAZIONALITA = "ITALIA"
                            End If

                            DOC_SOGGIORNO = ""


                            par.cmd.CommandText = "Insert into SISCOM_MI.ANAGRAFICA (ID, COGNOME, NOME, RAGIONE_SOCIALE, COD_FISCALE, PARTITA_IVA, CITTADINANZA, RESIDENZA, DATA_NASCITA, COD_COMUNE_NASCITA, SESSO, TELEFONO, ID_INDIRIZZO_RECAPITO, TIPO_DOC,NUM_DOC,DATA_DOC,RILASCIO_DOC,COMUNE_RESIDENZA,PROVINCIA_RESIDENZA,INDIRIZZO_RESIDENZA,CIVICO_RESIDENZA,CAP_RESIDENZA,DOC_SOGGIORNO) " _
                                                & " Values " _
                                                & "(SISCOM_MI.SEQ_ANAGRAFICA.NEXTVAL, '" & par.PulisciStrSql(myReaderB("COGNOME")) & "', '" & par.PulisciStrSql(myReaderB("NOME")) & "','', '" & par.PulisciStrSql(myReaderB("COD_FISCALE")) & "', " _
                                                & "'', '" & par.PulisciStrSql(NAZIONALITA) & "', '" & par.PulisciStrSql(CType(Generale1.FindControl("lblIndirizzo"), Label).Text) & " ', '" & par.PulisciStrSql(myReaderB("DATA_NASCITA")) & "', '" & Mid(myReaderB("COD_FISCALE"), 12, 4) & "', " _
                                                & "'" & par.PulisciStrSql(myReaderB("SESSO")) & "', '" & par.PulisciStrSql(par.IfNull(myReaderB("TELEFONO_DNTE"), "")) & "', NULL, " _
                                                & "0,'" & "" & "','" & "" & "','" & "" & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text) & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtSiglaCor"), TextBox).Text) & "','" & Trim(CType(Tab_Comunicazioni1.FindControl("cmbTipoViaCor"), DropDownList).SelectedItem.Text) & " " & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtViaCor"), TextBox).Text) & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtCivicoCor"), TextBox).Text) & "','" & CType(Tab_Comunicazioni1.FindControl("txtCAPCOR"), TextBox).Text & "','" & DOC_SOGGIORNO & "')"

                            par.cmd.ExecuteNonQuery()
                            myReaderC.Close()
                        End If
                        myReaderC.Close()
                    Loop
                    myReaderB.Close()
                End If

                If TipoContratto = "2" Then
                    Generale1.Provenienza = "2"

                    par.cmd.CommandText = "SELECT DOMANDE_BANDO_CAMBI.PERMESSO_SOGG_N,DOMANDE_BANDO_CAMBI.PERMESSO_SOGG_DATA,DOMANDE_BANDO_CAMBI.PERMESSO_SOGG_SCADE,DOMANDE_BANDO_CAMBI.CARTA_SOGG_N,DOMANDE_BANDO_CAMBI.CARTA_SOGG_DATA,DOMANDE_BANDO_CAMBI.TELEFONO_REC_DNTE,DOMANDE_BANDO_CAMBI.CARTA_I,DOMANDE_BANDO_CAMBI.CARTA_I_DATA,DOMANDE_BANDO_CAMBI.CARTA_I_RILASCIATA,TIPOLOGIA_PARENTELA.COD AS ""PARENTE"",COMP_NUCLEO_CAMBI.*,COMUNI_NAZIONI.NOME AS ""NAZ"",COMUNI_NAZIONI.SIGLA  FROM SISCOM_MI.TIPOLOGIA_PARENTELA,COMUNI_NAZIONI,COMP_NUCLEO_CAMBI,DOMANDE_BANDO_CAMBI WHERE TIPOLOGIA_PARENTELA.ID_SEPA=COMP_NUCLEO_CAMBI.GRADO_PARENTELA AND COMUNI_NAZIONI.COD (+)=SUBSTR(COD_FISCALE,12,4) AND DOMANDE_BANDO_CAMBI.ID=" & lIdDomandaERP & " AND COMP_NUCLEO_CAMBI.ID_DICHIARAZIONE=DOMANDE_BANDO_CAMBI.ID_DICHIARAZIONE ORDER BY COMP_NUCLEO_CAMBI.PROGR ASC"
                    Dim myReaderB As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    Do While myReaderB.Read
                        DOC_SOGGIORNO = ""
                        If par.IfNull(myReaderB("NAZ"), "") = "" Then
                            Response.Write("<script>alert('ATTENZIONE...il codice fiscale " & myReaderB("COD_FISCALE") & "  non è corretto!\nTramite il menu ANAGRAFICA inserire il codice fiscale corretto.');</script>")
                        End If
                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.ANAGRAFICA WHERE COD_FISCALE='" & myReaderB("COD_FISCALE") & "'"
                        Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderC.HasRows = False Then
                            If par.IfNull(myReaderB("SIGLA"), "") = "C" Or par.IfNull(myReaderB("SIGLA"), "") = "E" Then
                                NAZIONALITA = myReaderB("NAZ")
                            Else
                                NAZIONALITA = "ITALIA"
                            End If
                            If par.IfNull(myReaderB("PROGR"), "") = "0" Then
                                If par.IfNull(myReaderB("CARTA_SOGG_N"), "") <> "" Then
                                    DOC_SOGGIORNO = "CARTA SOGG. N. " & par.IfNull(myReaderB("CARTA_SOGG_N"), "") & " DEL " & par.FormattaData(par.IfNull(myReaderB("CARTA_SOGG_DATA"), ""))
                                Else
                                    If par.IfNull(myReaderB("PERMESSO_SOGG_N"), "") <> "" Then
                                        DOC_SOGGIORNO = "PERMESSO SOGG. N. " & par.IfNull(myReaderB("PERMESSO_SOGG_N"), "") & " DEL " & par.FormattaData(par.IfNull(myReaderB("PERMESSO_SOGG_DATA"), "")) & " SCADE IL " & par.FormattaData(par.IfNull(myReaderB("PERMESSO_SOGG_SCADE"), ""))
                                    Else
                                        DOC_SOGGIORNO = ""
                                    End If
                                End If
                            Else
                                DOC_SOGGIORNO = ""
                            End If

                            par.cmd.CommandText = "Insert into SISCOM_MI.ANAGRAFICA (ID, COGNOME, NOME, RAGIONE_SOCIALE, COD_FISCALE, PARTITA_IVA, CITTADINANZA, RESIDENZA, DATA_NASCITA, COD_COMUNE_NASCITA, SESSO, TELEFONO, ID_INDIRIZZO_RECAPITO, TIPO_DOC,NUM_DOC,DATA_DOC,RILASCIO_DOC,COMUNE_RESIDENZA,PROVINCIA_RESIDENZA,INDIRIZZO_RESIDENZA,CIVICO_RESIDENZA,CAP_RESIDENZA,DOC_SOGGIORNO) " _
                                                & " Values " _
                                                & "(SISCOM_MI.SEQ_ANAGRAFICA.NEXTVAL, '" & par.PulisciStrSql(myReaderB("COGNOME")) & "', '" & par.PulisciStrSql(myReaderB("NOME")) & "','', '" & par.PulisciStrSql(myReaderB("COD_FISCALE")) & "', " _
                                                            & "'', '" & par.PulisciStrSql(NAZIONALITA) & "', '" & par.PulisciStrSql(CType(Generale1.FindControl("lblIndirizzo"), Label).Text) & " ', '" & par.PulisciStrSql(myReaderB("DATA_NASCITA")) & "', '" & Mid(myReaderB("COD_FISCALE"), 12, 4) & "', " _
                                                            & "'" & par.PulisciStrSql(myReaderB("SESSO")) & "', '" & par.PulisciStrSql(par.IfNull(myReaderB("TELEFONO_REC_DNTE"), "")) & "', NULL, " _
                                                            & "0,'" & par.PulisciStrSql(par.IfNull(myReaderB("CARTA_I"), "")) & "','" & par.IfNull(myReaderB("CARTA_I_DATA"), "") & "','" & par.PulisciStrSql(par.IfNull(myReaderB("CARTA_I_RILASCIATA"), "")) & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text) & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtSiglaCor"), TextBox).Text) & "','" & Trim(CType(Tab_Comunicazioni1.FindControl("cmbTipoViaCor"), DropDownList).SelectedItem.Text) & " " & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtViaCor"), TextBox).Text) & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtCivicoCor"), TextBox).Text) & "','" & CType(Tab_Comunicazioni1.FindControl("txtCAPCOR"), TextBox).Text & "','" & DOC_SOGGIORNO & "')"
                            par.cmd.ExecuteNonQuery()
                            myReaderC.Close()
                        End If
                        myReaderC.Close()
                    Loop
                    myReaderB.Close()
                End If

                Dim TIPOINT As String = ""
                Dim STATOINT As String = ""

                If TipoContratto = "7" Then
                    STATOINT = "NOTIT"
                Else
                    STATOINT = "LEGIT"
                End If
                'INSERISCO GLI INTESTATARI NEI SOGGETTI CONTRATTUALI
                For I = 0 To CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Count - 1
                    par.cmd.CommandText = "SELECT ANAGRAFICA.* FROM SISCOM_MI.ANAGRAFICA WHERE COD_FISCALE='" & par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items(I).Text, 39, 16) & "' OR PARTITA_IVA='" & par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items(I).Text, 39, 16) & "'"

                    If I = 0 Then
                        TIPOINT = "INTE"
                    Else
                        TIPOINT = "COINT"
                    End If
                    Dim myReaderB As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderB.Read Then
                        par.cmd.CommandText = "SELECT COD FROM SISCOM_MI.TIPOLOGIA_PARENTELA WHERE UPPER(DESCRIZIONE)='" & par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items(I).Text, 56, 20) & "'"
                        Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderC.Read Then
                            par.cmd.CommandText = "Insert into SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA, ID_CONTRATTO, COD_TIPOLOGIA_PARENTELA, " _
                                               & "COD_TIPOLOGIA_OCCUPANTE, COD_TIPOLOGIA_TITOLO, DATA_INIZIO, DATA_FINE) " _
                                               & "Values " _
                                               & "(" & myReaderB("ID") & ", " & lIdContratto & " , '" & myReaderC("COD") & "', '" & TIPOINT & "', '" & STATOINT & "', '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) & "', NULL)"
                            par.cmd.ExecuteNonQuery()
                        End If
                        myReaderC.Close()
                    End If
                    myReaderB.Close()
                Next I

                'INSERISCO I COMPONENTI NEI SOGGETTI CONTRATTUALI
                For I = 0 To CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Count - 1
                    par.cmd.CommandText = "SELECT ANAGRAFICA.* FROM SISCOM_MI.ANAGRAFICA WHERE COD_FISCALE='" & par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items(I).Text, 39, 16) & "'"
                    Dim myReaderB As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderB.Read Then
                        par.cmd.CommandText = "SELECT COD FROM SISCOM_MI.TIPOLOGIA_PARENTELA WHERE UPPER(DESCRIZIONE)='" & par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items(I).Text, 56, 20) & "'"
                        Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderC.Read Then
                            par.cmd.CommandText = "Insert into SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA, ID_CONTRATTO, COD_TIPOLOGIA_PARENTELA, " _
                                               & "COD_TIPOLOGIA_OCCUPANTE, COD_TIPOLOGIA_TITOLO, DATA_INIZIO, DATA_FINE) " _
                                               & "Values " _
                                               & "(" & myReaderB("ID") & ", " & lIdContratto & " , '" & myReaderC("COD") & "', 'ALTR', '" & STATOINT & "', '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) & "', NULL)"
                            par.cmd.ExecuteNonQuery()
                        End If
                        myReaderC.Close()
                    End If
                    myReaderB.Close()
                Next I

                'CREO L'UNITA CONTRATTUALE PER IL NUOVO CONTRATTO
                par.cmd.CommandText = "SELECT SCALE_EDIFICI.DESCRIZIONE AS ""SCALAUNITA"",UNITA_IMMOBILIARI.*,IDENTIFICATIVI_CATASTALI.FOGLIO,IDENTIFICATIVI_CATASTALI.SEZIONE," _
                                    & "IDENTIFICATIVI_CATASTALI.NUMERO,IDENTIFICATIVI_CATASTALI.SUB,IDENTIFICATIVI_CATASTALI.COD_TIPOLOGIA_CATASTO," _
                                    & "IDENTIFICATIVI_CATASTALI.RENDITA,IDENTIFICATIVI_CATASTALI.COD_CATEGORIA_CATASTALE " _
                                    & ",IDENTIFICATIVI_CATASTALI.COD_CLASSE_CATASTALE,IDENTIFICATIVI_CATASTALI.COD_QUALITA_CATASTALE, " _
                                    & "IDENTIFICATIVI_CATASTALI.SUPERFICIE_MQ,IDENTIFICATIVI_CATASTALI.CUBATURA,IDENTIFICATIVI_CATASTALI.NUM_VANI" _
                                    & ",IDENTIFICATIVI_CATASTALI.SUPERFICIE_CATASTALE,IDENTIFICATIVI_CATASTALI.RENDITA_STORICA," _
                                    & "IDENTIFICATIVI_CATASTALI.IMMOBILE_STORICO,IDENTIFICATIVI_CATASTALI.VALORE_IMPONIBILE" _
                                    & ",IDENTIFICATIVI_CATASTALI.DATA_ACQUISIZIONE,IDENTIFICATIVI_CATASTALI.DATA_FINE_VALIDITA" _
                                    & ",IDENTIFICATIVI_CATASTALI.DITTA,IDENTIFICATIVI_CATASTALI.NUM_PARTITA" _
                                    & ",IDENTIFICATIVI_CATASTALI.ESENTE_ICI,IDENTIFICATIVI_CATASTALI.PERC_POSSESSO" _
                                    & ",IDENTIFICATIVI_CATASTALI.INAGIBILE,IDENTIFICATIVI_CATASTALI.MICROZONA_CENSUARIA" _
                                    & ",IDENTIFICATIVI_CATASTALI.ZONA_CENSUARIA,IDENTIFICATIVI_CATASTALI.COD_STATO_CATASTALE" _
                                    & ",INDIRIZZI.DESCRIZIONE AS ""IND"",INDIRIZZI.CIVICO,INDIRIZZI.CAP,INDIRIZZI.LOCALITA,INDIRIZZI.COD_COMUNE" _
                                    & " FROM SISCOM_MI.SCALE_EDIFICI,SISCOM_MI.INDIRIZZI,SISCOM_MI.UNITA_IMMOBILIARI,SISCOM_MI.IDENTIFICATIVI_CATASTALI " _
                                    & "WHERE UNITA_IMMOBILIARI.ID_SCALA=SCALE_EDIFICI.ID (+) AND INDIRIZZI.ID=unita_immobiliari.id_indirizzo AND UNITA_IMMOBILIARI.ID_CATASTALE=IDENTIFICATIVI_CATASTALI.ID (+) AND UNITA_IMMOBILIARI.ID=" & UnitaContratto
                Dim myReaderD As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderD.Read Then
                    par.cmd.CommandText = "Insert into SISCOM_MI.UNITA_CONTRATTUALE (ID_CONTRATTO, ID_UNITA, COD_UNITA_IMMOBILIARE, TIPOLOGIA, ID_EDIFICIO, " _
                                        & "SCALA, COD_TIPO_LIVELLO_PIANO, INTERNO, ID_UNITA_PRINCIPALE, SEZIONE, FOGLIO, NUMERO, SUB, COD_TIPOLOGIA_CATASTO, RENDITA, " _
                                        & "COD_CATEGORIA_CATASTALE, COD_CLASSE_CATASTALE, COD_QUALITA_CATASTALE, SUPERFICIE_MQ, CUBATURA, " _
                                        & "NUM_VANI, SUPERFICIE_CATASTALE, RENDITA_STORICA, IMMOBILE_STORICO, REDDITO_DOMINICALE, " _
                                        & "VALORE_IMPONIBILE, REDDITO_AGRARIO, VALORE_BILANCIO, DATA_ACQUISIZIONE, DATA_FINE_VALIDITA,  " _
                                        & "DITTA, NUM_PARTITA, ESENTE_ICI, PERC_POSSESSO, INAGIBILE, " _
                                        & "MICROZONA_CENSUARIA, ZONA_CENSUARIA, COD_STATO_CATASTALE, INDIRIZZO, CIVICO, " _
                                        & "CAP, LOCALITA, COD_COMUNE, SUP_CONVENZIONALE,VAL_LOCATIVO_UNITA) " _
                                        & "Values " _
                                        & "(" & lIdContratto & " , " & UnitaContratto & " , '" _
                                        & myReaderD("COD_UNITA_IMMOBILIARE") & "', '" _
                                        & myReaderD("COD_TIPOLOGIA") & "', " & myReaderD("ID_EDIFICIO") & ", " _
                                        & "'" & par.IfNull(myReaderD("SCALAUNITA"), "") & "', '" _
                                        & par.IfNull(myReaderD("COD_TIPO_LIVELLO_PIANO"), "01") & "', '" _
                                        & par.IfNull(myReaderD("INTERNO"), "") & "', NULL, '" & par.IfNull(myReaderD("SEZIONE"), "") & "', " _
                                        & "'" & par.IfNull(myReaderD("FOGLIO"), "") & "', '" & par.IfNull(myReaderD("NUMERO"), "") & "', '" & par.IfNull(myReaderD("SUB"), "") & "', '" & par.IfNull(myReaderD("COD_TIPOLOGIA_CATASTO"), "") & "', " & par.VirgoleInPunti(par.IfNull(myReaderD("RENDITA"), "NULL")) & " , " _
                                        & "'" & par.IfNull(myReaderD("COD_CATEGORIA_CATASTALE"), "") & "', '" _
                                        & par.IfNull(myReaderD("COD_CLASSE_CATASTALE"), "") & "', '" & par.IfNull(myReaderD("COD_QUALITA_CATASTALE"), "") _
                                        & "', " & par.VirgoleInPunti(par.IfNull(myReaderD("SUPERFICIE_MQ"), "NULL")) _
                                        & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("CUBATURA"), "NULL")) & ", " _
                                        & par.VirgoleInPunti(par.IfNull(myReaderD("NUM_VANI"), "NULL")) _
                                        & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("SUPERFICIE_CATASTALE"), "NULL")) _
                                        & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("RENDITA_STORICA"), "NULL")) _
                                        & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("IMMOBILE_STORICO"), "NULL")) & ", NULL, " _
                                        & par.VirgoleInPunti(par.IfNull(myReaderD("VALORE_IMPONIBILE"), "NULL")) _
                                        & ", NULL, " & par.VirgoleInPunti(par.IfNull(myReaderD("VALORE_IMPONIBILE"), "NULL")) _
                                        & ", '" & par.IfNull(myReaderD("DATA_ACQUISIZIONE"), "") _
                                        & "', '" & par.IfNull(myReaderD("DATA_FINE_VALIDITA"), "") & "', '" _
                                        & par.IfNull(myReaderD("DITTA"), "") _
                                        & "', '" & par.IfNull(myReaderD("NUM_PARTITA"), "") _
                                        & "', " & par.IfNull(myReaderD("ESENTE_ICI"), "NULL") _
                                        & "," & par.VirgoleInPunti(par.IfNull(myReaderD("PERC_POSSESSO"), "NULL")) _
                                        & "," & par.IfNull(myReaderD("INAGIBILE"), "NULL") & ", '" _
                                        & par.IfNull(myReaderD("MICROZONA_CENSUARIA"), "") _
                                        & "', '" & par.IfNull(myReaderD("ZONA_CENSUARIA"), "") _
                                        & "', '" & par.IfNull(myReaderD("COD_STATO_CATASTALE"), "") _
                                        & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("IND"), "")) _
                                        & "', '" & par.IfNull(myReaderD("CIVICO"), "") & "', " _
                                        & "'" & par.IfNull(myReaderD("CAP"), "") _
                                        & "', NULL, '" & par.IfNull(myReaderD("COD_COMUNE"), "") _
                                        & "', 0,'" & VAL_LOCATIVO_UNITA & "')"
                    par.cmd.ExecuteNonQuery()

                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.DIMENSIONI WHERE ID_UNITA_IMMOBILIARE=" & UnitaContratto
                    Dim myReaderF As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    Do While myReaderF.Read
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE (ID_CONTRATTO, ID_UNITA, COD_TIPOLOGIA, VALORE) VALUES (" _
                                            & lIdContratto & "," & UnitaContratto & ",'" _
                                            & par.IfNull(myReaderF("COD_TIPOLOGIA"), "") _
                                            & "'," & par.VirgoleInPunti(par.IfNull(myReaderF("VALORE"), "NULL")) & ")"
                        par.cmd.ExecuteNonQuery()
                    Loop
                    myReaderF.Close()

                    Dim VAL_MILLESIMO As Double
                    Dim TOT_VERDE As Double = 0
                    Dim IDCOMPLESSO As Long = 0

                    par.cmd.CommandText = "SELECT VALORI_MILLESIMALI.VALORE_MILLESIMO FROM SISCOM_MI.TABELLE_MILLESIMALI,SISCOM_MI.VALORI_MILLESIMALI WHERE VALORI_MILLESIMALI.ID_UNITA_IMMOBILIARE=" & UnitaContratto & " AND TABELLE_MILLESIMALI.ID=VALORI_MILLESIMALI.ID_TABELLA AND TABELLE_MILLESIMALI.COD_TIPOLOGIA='VE'"
                    Dim myReaderH As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    Do While myReaderH.Read
                        VAL_MILLESIMO = VAL_MILLESIMO + CDbl(par.IfNull(myReaderH("VALORE_MILLESIMO"), 0))
                    Loop
                    myReaderH.Close()
                    If VAL_MILLESIMO > 0 Then
                        par.cmd.CommandText = "SELECT DIMENSIONI.VALORE FROM SISCOM_MI.DIMENSIONI,SISCOM_MI.UNITA_COMUNI WHERE dimensioni.cod_tipologia='SUVEC' AND UNITA_COMUNI.ID_EDIFICIO=" & myReaderD("ID_EDIFICIO") & " AND DIMENSIONI.ID_UNITA_COMUNE=UNITA_COMUNI.ID"
                        Dim myReaderG As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        Do While myReaderG.Read
                            TOT_VERDE = TOT_VERDE + CDbl(par.IfNull(myReaderG("VALORE"), 0))
                        Loop
                        myReaderG.Close()

                        par.cmd.CommandText = "SELECT ID_COMPLESSO FROM SISCOM_MI.EDIFICI WHERE ID=" & myReaderD("ID_EDIFICIO")
                        myReaderG = par.cmd.ExecuteReader()
                        If myReaderG.Read Then
                            IDCOMPLESSO = par.IfNull(myReaderG("ID_COMPLESSO"), 0)
                        End If
                        myReaderG.Close()
                        If IDCOMPLESSO <> 0 Then
                            par.cmd.CommandText = "SELECT DIMENSIONI.VALORE FROM SISCOM_MI.DIMENSIONI,SISCOM_MI.UNITA_COMUNI WHERE dimensioni.cod_tipologia='SUVEC' AND UNITA_COMUNI.ID_COMPLESSO=" & IDCOMPLESSO & " AND DIMENSIONI.ID_UNITA_COMUNE=UNITA_COMUNI.ID"
                            myReaderG = par.cmd.ExecuteReader()
                            Do While myReaderG.Read
                                TOT_VERDE = TOT_VERDE + CDbl(par.IfNull(myReaderG("VALORE"), 0))
                            Loop
                            myReaderG.Close()
                        End If

                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE (ID_CONTRATTO, ID_UNITA, COD_TIPOLOGIA, VALORE) VALUES (" _
                                            & lIdContratto & "," & UnitaContratto & ",'SUVEC" _
                                            & "'," & par.VirgoleInPunti((TOT_VERDE / 1000) * VAL_MILLESIMO) & ")"
                        par.cmd.ExecuteNonQuery()
                    End If

                End If
                myReaderD.Close()

                If TipoContratto = "11" Then TipoContratto = "1"
                'If TipoContratto = "12" Then TipoContratto = "1"

                'CREO L'UNITA CONTRATTUALE PERTINENZE PER IL NUOVO CONTRATTO
                par.cmd.CommandText = "SELECT ID FROM SISCOM_MI.UNITA_IMMOBILIARI WHERE ID_UNITA_PRINCIPALE=" & UnitaContratto
                Dim myReaderE As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                Do While myReaderE.Read
                    par.cmd.CommandText = "SELECT SCALE_EDIFICI.DESCRIZIONE AS ""SCALAUNITA"",UNITA_IMMOBILIARI.*,IDENTIFICATIVI_CATASTALI.FOGLIO,IDENTIFICATIVI_CATASTALI.SEZIONE," _
                                        & "IDENTIFICATIVI_CATASTALI.NUMERO,IDENTIFICATIVI_CATASTALI.SUB,IDENTIFICATIVI_CATASTALI.COD_TIPOLOGIA_CATASTO," _
                                        & "IDENTIFICATIVI_CATASTALI.RENDITA,IDENTIFICATIVI_CATASTALI.COD_CATEGORIA_CATASTALE " _
                                        & ",IDENTIFICATIVI_CATASTALI.COD_CLASSE_CATASTALE,IDENTIFICATIVI_CATASTALI.COD_QUALITA_CATASTALE, " _
                                        & "IDENTIFICATIVI_CATASTALI.SUPERFICIE_MQ,IDENTIFICATIVI_CATASTALI.CUBATURA,IDENTIFICATIVI_CATASTALI.NUM_VANI" _
                                        & ",IDENTIFICATIVI_CATASTALI.SUPERFICIE_CATASTALE,IDENTIFICATIVI_CATASTALI.RENDITA_STORICA," _
                                        & "IDENTIFICATIVI_CATASTALI.IMMOBILE_STORICO,IDENTIFICATIVI_CATASTALI.VALORE_IMPONIBILE" _
                                        & ",IDENTIFICATIVI_CATASTALI.DATA_ACQUISIZIONE,IDENTIFICATIVI_CATASTALI.DATA_FINE_VALIDITA" _
                                        & ",IDENTIFICATIVI_CATASTALI.DITTA,IDENTIFICATIVI_CATASTALI.NUM_PARTITA" _
                                        & ",IDENTIFICATIVI_CATASTALI.ESENTE_ICI,IDENTIFICATIVI_CATASTALI.PERC_POSSESSO" _
                                        & ",IDENTIFICATIVI_CATASTALI.INAGIBILE,IDENTIFICATIVI_CATASTALI.MICROZONA_CENSUARIA" _
                                        & ",IDENTIFICATIVI_CATASTALI.ZONA_CENSUARIA,IDENTIFICATIVI_CATASTALI.COD_STATO_CATASTALE" _
                                        & ",INDIRIZZI.DESCRIZIONE AS ""IND"",INDIRIZZI.CIVICO,INDIRIZZI.CAP,INDIRIZZI.LOCALITA,INDIRIZZI.COD_COMUNE" _
                                        & " FROM SISCOM_MI.SCALE_EDIFICI,SISCOM_MI.INDIRIZZI,SISCOM_MI.UNITA_IMMOBILIARI,SISCOM_MI.IDENTIFICATIVI_CATASTALI " _
                                        & "WHERE UNITA_IMMOBILIARI.ID_SCALA=SCALE_EDIFICI.ID (+) AND INDIRIZZI.ID=unita_immobiliari.id_indirizzo AND UNITA_IMMOBILIARI.ID_CATASTALE=IDENTIFICATIVI_CATASTALI.ID (+) AND UNITA_IMMOBILIARI.ID=" & myReaderE("ID")
                    myReaderD = par.cmd.ExecuteReader()
                    If myReaderD.Read Then
                        par.cmd.CommandText = "Insert into SISCOM_MI.UNITA_CONTRATTUALE (ID_CONTRATTO, ID_UNITA, COD_UNITA_IMMOBILIARE, TIPOLOGIA, ID_EDIFICIO, " _
                                            & "SCALA, COD_TIPO_LIVELLO_PIANO, INTERNO, ID_UNITA_PRINCIPALE, SEZIONE, FOGLIO, NUMERO, SUB, COD_TIPOLOGIA_CATASTO, RENDITA, " _
                                            & "COD_CATEGORIA_CATASTALE, COD_CLASSE_CATASTALE, COD_QUALITA_CATASTALE, SUPERFICIE_MQ, CUBATURA, " _
                                            & "NUM_VANI, SUPERFICIE_CATASTALE, RENDITA_STORICA, IMMOBILE_STORICO, REDDITO_DOMINICALE, " _
                                            & "VALORE_IMPONIBILE, REDDITO_AGRARIO, VALORE_BILANCIO, DATA_ACQUISIZIONE, DATA_FINE_VALIDITA,  " _
                                            & "DITTA, NUM_PARTITA, ESENTE_ICI, PERC_POSSESSO, INAGIBILE, " _
                                            & "MICROZONA_CENSUARIA, ZONA_CENSUARIA, COD_STATO_CATASTALE, INDIRIZZO, CIVICO, " _
                                            & "CAP, LOCALITA, COD_COMUNE, SUP_CONVENZIONALE) " _
                                            & "Values " _
                                            & "(" & lIdContratto & " , " & myReaderE("ID") & " , '" _
                                            & myReaderD("COD_UNITA_IMMOBILIARE") & "', '" _
                                            & myReaderD("COD_TIPOLOGIA") & "', " & myReaderD("ID_EDIFICIO") & ", " _
                                            & "'" & par.IfNull(myReaderD("SCALAUNITA"), "") & "', '" _
                                            & par.IfNull(myReaderD("COD_TIPO_LIVELLO_PIANO"), "01") & "', '" _
                                            & par.IfNull(myReaderD("INTERNO"), "") & "', " & UnitaContratto & ", '" & par.IfNull(myReaderD("SEZIONE"), "") & "', " _
                                            & "'" & par.IfNull(myReaderD("FOGLIO"), "") & "', '" & par.IfNull(myReaderD("NUMERO"), "") & "', '" & par.IfNull(myReaderD("SUB"), "") & "', '" & par.IfNull(myReaderD("COD_TIPOLOGIA_CATASTO"), "") & "', " & par.VirgoleInPunti(par.IfNull(myReaderD("RENDITA"), "NULL")) & " , " _
                                            & "'" & par.IfNull(myReaderD("COD_CATEGORIA_CATASTALE"), "") & "', '" _
                                            & par.IfNull(myReaderD("COD_CLASSE_CATASTALE"), "") & "', '" & par.IfNull(myReaderD("COD_QUALITA_CATASTALE"), "") _
                                            & "', " & par.VirgoleInPunti(par.IfNull(myReaderD("SUPERFICIE_MQ"), "NULL")) _
                                            & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("CUBATURA"), "NULL")) & ", " _
                                            & par.VirgoleInPunti(par.IfNull(myReaderD("NUM_VANI"), "NULL")) _
                                            & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("SUPERFICIE_CATASTALE"), "NULL")) _
                                            & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("RENDITA_STORICA"), "NULL")) _
                                            & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("IMMOBILE_STORICO"), "NULL")) & ", NULL, " _
                                            & par.VirgoleInPunti(par.IfNull(myReaderD("VALORE_IMPONIBILE"), "NULL")) _
                                            & ", NULL, " & par.VirgoleInPunti(par.IfNull(myReaderD("VALORE_IMPONIBILE"), "NULL")) _
                                            & ", '" & par.IfNull(myReaderD("DATA_ACQUISIZIONE"), "") _
                                            & "', '" & par.IfNull(myReaderD("DATA_FINE_VALIDITA"), "") & "', '" _
                                            & par.IfNull(myReaderD("DITTA"), "") _
                                            & "', '" & par.IfNull(myReaderD("NUM_PARTITA"), "") _
                                            & "', " & par.IfNull(myReaderD("ESENTE_ICI"), "NULL") _
                                            & "," & par.VirgoleInPunti(par.IfNull(myReaderD("PERC_POSSESSO"), "NULL")) _
                                            & "," & par.IfNull(myReaderD("INAGIBILE"), "NULL") & ", '" _
                                            & par.IfNull(myReaderD("MICROZONA_CENSUARIA"), "") _
                                            & "', '" & par.IfNull(myReaderD("ZONA_CENSUARIA"), "") _
                                            & "', '" & par.IfNull(myReaderD("COD_STATO_CATASTALE"), "") _
                                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("IND"), "")) _
                                            & "', '" & par.IfNull(myReaderD("CIVICO"), "") & "', " _
                                            & "'" & par.IfNull(myReaderD("CAP"), "") _
                                            & "', NULL, '" & par.IfNull(myReaderD("COD_COMUNE"), "") _
                                            & "', 0)"
                        par.cmd.ExecuteNonQuery()


                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.DIMENSIONI WHERE ID_UNITA_IMMOBILIARE=" & myReaderE("ID")
                        Dim myReaderF As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        Do While myReaderF.Read
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE (ID_CONTRATTO, ID_UNITA, COD_TIPOLOGIA, VALORE) VALUES (" _
                                                & lIdContratto & "," & myReaderE("ID") & ",'" _
                                                & par.IfNull(myReaderF("COD_TIPOLOGIA"), "") _
                                                & "'," & par.VirgoleInPunti(par.IfNull(myReaderF("VALORE"), "NULL")) & ")"
                            par.cmd.ExecuteNonQuery()
                        Loop
                        myReaderF.Close()


                    End If
                    myReaderD.Close()
                Loop
                myReaderE.Close()




                ' ''CARICAMENTO OSPITI
                'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.OSPITI WHERE ID_CONTRATTO=" & lIdContratto & " ORDER BY DATA_AGG DESC"
                'myReaderE = par.cmd.ExecuteReader()
                'Do While myReaderE.Read
                '    'CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Add(New ListItem(par.MiaFormat(Format(myReader2("NRO_OSPITI"), "00"), 2) & " " & par.MiaFormat(par.FormattaData(myReader2("DATA_INIZIO_OSPITE")), 15) & " " & par.FormattaData(myReader2("DATA_FINE_OSPITE")), myReader2("ID")))
                '    CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReaderE("nominativo"), ""), 30) & " " & par.MiaFormat(par.IfNull(myReaderE("cod_fiscale"), ""), 16) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReaderE("data_inizio_ospite"), "")), 15) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReaderE("data_fine_ospite"), "")), 15), myReaderE("ID")))

                'Loop
                'myReaderE.Close()


                Dim testoTabella As String = ""
                'CARICO NUOVAMENTE LE UNITA DEL CONTRATTO
                testoTabella = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                & "<tr>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>COD.UNITA</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>FOGLIO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>MAPPALE</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>SUB</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>TIPO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>INDIRIZZO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>PIANO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>SCALA</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>INTERNO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "</td>" _
                & "<td style='height: 19px'>" _
                & "</td>" _
                & "</tr>"


                par.cmd.CommandText = "select TIPO_LIVELLO_PIANO.DESCRIZIONE AS ""PIANO"",unita_contrattuale.*,tipologia_unita_immobiliari.descrizione as ""tipo"" from SISCOM_MI.TIPO_LIVELLO_PIANO,siscom_mi.tipologia_unita_immobiliari,siscom_mi.unita_contrattuale where TIPO_LIVELLO_PIANO.COD=UNITA_CONTRATTUALE.COD_TIPO_LIVELLO_PIANO  AND tipologia_unita_immobiliari.cod=unita_contrattuale.tipologia and id_contratto=" & lIdContratto & " AND (ID_UNITA_PRINCIPALE IS NULL) order by tipologia asc"
                Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                Do While myReader1.Read
                    testoTabella = testoTabella _
                            & "<tr>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'><a href='#' onclick=" & Chr(34) & "if (document.getElementById('txtModificato').value == '1') {alert('Attenzione...Sono state apportate delle modifiche. Salvare prima di proseguire!');}else {document.getElementById('USCITA').value='1';window.open('../CENSIMENTO/InserimentoUniImmob.aspx?F=" & lIdConnessione & "&X=1&LE=1&ID=" & par.IfNull(myReader1("ID_UNITA"), "") & "','Dettagli','height=580,top=0,left=0,width=780');}" & Chr(34) & ">" & par.IfNull(myReader1("cod_unita_immobiliare"), "") & "</a></span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("FOGLIO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("NUMERO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SUB"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("TIPO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INDIRIZZO"), "") & "," & par.IfNull(myReader1("CIVICO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("PIANO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SCALA"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INTERNO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "</td>" _
                            & "<td style='height: 19px'>" _
                            & "</td>" _
                            & "</tr>"


                    sPiano = par.IfNull(myReader1("PIANO"), "")
                    sInterno = par.IfNull(myReader1("INTERNO"), "")
                    sSCALA = par.IfNull(myReader1("SCALA"), "")
                    sFoglio = par.IfNull(myReader1("FOGLIO"), "")
                    sParticella = par.IfNull(myReader1("NUMERO"), "")
                    sSub = par.IfNull(myReader1("sub"), "")
                    UnitaContratto = par.IfNull(myReader1("ID_UNITA"), "")

                    txtIdUnita.Value = CStr(UnitaContratto)
                    sCatastale = par.IfNull(myReader1("cod_categoria_catastale"), "")
                    sRendita = par.IfNull(myReader1("rendita"), "")
                    sClasse = par.IfNull(myReader1("cod_classe_catastale"), "")
                    sIdEdificio = par.IfNull(myReader1("id_edificio"), "")
                    'CType(Tab_SchemaBollette1.Controls("txtIdUnita"), TextBox).Text = txtIdUnita.Text

                Loop
                myReader1.Close()
                CType(Tab_UnitaImmLocate1.FindControl("TBL_UNITA_ALLOCATE"), Label).Text = testoTabella & "</table>"

                'CARICO PERTINENZE

                testoTabella = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                & "<tr>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>COD.UNITA</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>FOGLIO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>MAPPALE</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>SUB</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>TIPO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>INDIRIZZO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>PIANO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>SCALA</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "<span style='font-size: 8pt; font-family: Arial'><strong>INTERNO</strong></span></td>" _
                & "<td style='height: 19px'>" _
                & "</td>" _
                & "<td style='height: 19px'>" _
                & "</td>" _
                & "</tr>"


                par.cmd.CommandText = "select TIPO_LIVELLO_PIANO.DESCRIZIONE AS ""PIANO"",unita_contrattuale.*,tipologia_unita_immobiliari.descrizione as ""tipo"" from SISCOM_MI.TIPO_LIVELLO_PIANO,siscom_mi.tipologia_unita_immobiliari,siscom_mi.unita_contrattuale where TIPO_LIVELLO_PIANO.COD=UNITA_CONTRATTUALE.COD_TIPO_LIVELLO_PIANO AND tipologia_unita_immobiliari.cod=unita_contrattuale.tipologia and id_contratto=" & lIdContratto & " AND (ID_UNITA_PRINCIPALE IS NOT NULL) order by tipologia asc"
                myReader1 = par.cmd.ExecuteReader()
                Do While myReader1.Read
                    testoTabella = testoTabella _
                            & "<tr>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'><a href='#' onclick=" & Chr(34) & "window.open('../CENSIMENTO/InserimentoUniImmob.aspx?F=" & lIdConnessione & "&X=1&LE=1&ID=" & par.IfNull(myReader1("ID_UNITA"), "") & "','Dettagli','height=580,top=0,left=0,width=780');" & Chr(34) & ">" & par.IfNull(myReader1("cod_unita_immobiliare"), "") & "</a></span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("FOGLIO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("NUMERO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SUB"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("TIPO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INDIRIZZO"), "") & "," & par.IfNull(myReader1("CIVICO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("PIANO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SCALA"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INTERNO"), "") & "</span></td>" _
                            & "<td style='height: 19px'>" _
                            & "</td>" _
                            & "<td style='height: 19px'>" _
                            & "</td>" _
                            & "</tr>"
                Loop
                myReader1.Close()
                CType(Tab_UnitaImmLocate1.FindControl("TBL_PERTINENZE_ALLOCATE"), Label).Text = testoTabella & "</table>"


                ''CARICO SCHEMA
                'Dim LL As Integer = 0
                ''CARICAMENTO schema bollette
                'CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items.Clear()

                'CType(Tab_SchemaBollette1.FindControl("Label4"), Label).Text = "SCHEMA VOCI BOLLETTA" & " " & sAnnoSchema & "  -  <a href='SchemaAltriAnni.aspx?CN=" & lIdConnessione & "&A=" & sAnnoSchema & "' target='_blank'>Clicca qui per visualizzare lo schema di altri anni</a>"
                'par.cmd.CommandText = "select bol_schema.*,t_voci_bolletta.descrizione from siscom_mi.t_voci_bolletta, siscom_mi.bol_schema where t_voci_bolletta.id=bol_schema.id_voce and bol_schema.id_contratto=" & lIdContratto & " and anno=" & sAnnoSchema & " order by t_voci_bolletta.descrizione asc"
                'myReader2 = par.cmd.ExecuteReader()
                'Do While myReader2.Read
                '    CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("descrizione"), ""), 50) & " " & par.MiaFormat(par.IfNull(myReader2("importo_singola_rata"), ""), 15) & " " & par.MiaFormat(par.IfNull(myReader2("da_rata"), ""), 10) & " " & par.MiaFormat(par.IfNull(myReader2("per_rate"), ""), 10), myReader2("ID")))
                '    If LL Mod 2 <> 0 Then
                '        CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items(LL).Attributes.CssStyle.Add("background-color", "#dcdada")
                '    Else
                '        CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items(LL).Attributes.CssStyle.Add("background-color", "white")
                '    End If
                '    LL = LL + 1
                'Loop
                'myReader2.Close()

                'RICARICO IL CONDUTTORE NEL TAB GENERALE PERCHè POTREBBE ESSERE CAMBIATO
                Dim Conduttore As String = ""
                par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE,anagrafica.id,CASE WHEN anagrafica.ragione_sociale is not null THEN ragione_sociale  ELSE RTRIM(LTRIM(COGNOME ||' ' ||NOME)) END AS ""INTESTATARIO"" FROM SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE SOGGETTI_CONTRATTUALI.ID_CONTRATTO=" & lIdContratto & " AND (SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='INTE' OR SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='COINT') AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA ORDER BY SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE DESC"
                myReader1 = par.cmd.ExecuteReader()
                Dim conduttore1 As String = ""

                Do While myReader1.Read

                    Conduttore = Conduttore & par.IfNull(myReader1("INTESTATARIO"), "") & ", "
                    'Conduttore1 = Conduttore1 & "<a href=" & Chr(34) & "anagrafica/Inserimento.aspx?ID=" & par.IfNull(myReader1("id"), "-1") & Chr(34) & " target=" & Chr(34) & "_blank" & Chr(34) & ">" & par.IfNull(myReader1("INTESTATARIO"), "") & "</a>, "
                    'conduttore1 = conduttore1 & "<a href='#' onclick=" & Chr(34) & "window.open('anagrafica/Inserimento.aspx?DAC=1&ID=" & par.IfNull(myReader1("id"), "-1") & "','Anagrafe','height=450,top=0,left=0,width=500,scroll=no,status=no');" & Chr(34) & ">" & par.IfNull(myReader1("INTESTATARIO"), "") & "</a>, "
                    conduttore1 = conduttore1 & "<a href='#' onclick=" & Chr(34) & "document.getElementById('Generale1_hAnagrafica').value='" & par.IfNull(myReader1("id"), "-1") & "';myOpacity10.toggle();" & Chr(34) & ">" & par.IfNull(myReader1("INTESTATARIO"), "") & "</a>, "
                    If par.IfNull(myReader1("COD_TIPOLOGIA_OCCUPANTE"), "") = "INTE" Then
                        txtCodAffittuario.Value = par.IfNull(myReader1("id"), "-1")
                    End If

                Loop
                myReader1.Close()

                'CType(Generale1.FindControl("Label20"), Label).Text = "Saldo al " & Format(Now, "dd/MM/yyyy")
                'CType(Generale1.FindControl("lblSaldoAttuale"), Label).Text = "<a href='#' onclick=" & Chr(34) & "javascript:window.open('../Contabilita/DatiUtenza.aspx?C=RisUtenza&IDANA=" & txtCodAffittuario.Value & "&IDCONT=" & lIdContratto & "','EstrattoConto','');" & Chr(34) & " alt='Visualizza Dettagli'>" & Format(par.CalcolaSaldoAttuale(lIdContratto), "##,##0.00") & "</a>"


                '09/05/2012 IN SEGUITO A VAIN RICARICO PER VISUALIZZARE L'INTESTATARIO PRECEDENTE
                Dim ExConduttore As String = ""
                par.cmd.CommandText = "SELECT anagrafica.id,CASE WHEN anagrafica.ragione_sociale is not null THEN ragione_sociale  ELSE RTRIM(LTRIM(COGNOME ||' ' ||NOME)) END AS ""INTESTATARIO"",SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE FROM SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE SOGGETTI_CONTRATTUALI.ID_CONTRATTO=" & lIdContratto & " AND SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='EXINTE' AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA ORDER BY SOGGETTI_CONTRATTUALI.DATA_INIZIO DESC"
                myReader1 = par.cmd.ExecuteReader
                If myReader1.Read Then
                    ExConduttore = par.IfNull(myReader1("INTESTATARIO"), "")
                    par.cmd.CommandText = "select count(*) from siscom_mi.rapporti_utenza where id=" & lIdContratto & " and  cod_tipologia_contr_loc='USD' AND dest_uso='N'"
                    Dim ris As Integer = par.IfNull(par.cmd.ExecuteScalar, 0)
                    If ris = 0 Then
                        CType(Tab_Canone1.FindControl("HLink_SchedaDep"), HyperLink).Attributes.Add("onClick", "javascript:document.getElementById('USCITA').value='1';window.open('DepositoCauzionale.aspx?IDC=" & lIdContratto & "', 'DepCauz','height=600,width=800,top=0,left=0');")
                    Else
                        CType(Tab_Canone1.FindControl("HLink_SchedaDep"), HyperLink).Attributes.Add("onClick", "javascript:document.getElementById('USCITA').value='1';window.open('DepositoCauzionaleInte.aspx?IDC=" & lIdContratto & "', 'DepCauz','height=600,width=800,top=0,left=0');")
                    End If
                Else
                    ExConduttore = "---"
                    par.cmd.CommandText = "select count(*) from siscom_mi.rapporti_utenza where id=" & lIdContratto & " and  cod_tipologia_contr_loc='USD' AND dest_uso='N'"
                    Dim ris As Integer = par.IfNull(par.cmd.ExecuteScalar, 0)
                    If ris = 0 Then
                        CType(Tab_Canone1.FindControl("HLink_SchedaDep"), HyperLink).Attributes.Add("onClick", "javascript:document.getElementById('USCITA').value='1';window.open('DepositoCauzionale.aspx?IDC=" & lIdContratto & "&IDI=" & txtCodAffittuario.Value & "', 'DepCauzInte','height=600,width=800,top=0,left=0');")
                    Else
                        CType(Tab_Canone1.FindControl("HLink_SchedaDep"), HyperLink).Attributes.Add("onClick", "javascript:document.getElementById('USCITA').value='1';window.open('DepositoCauzionaleUSD.aspx?IDC=" & lIdContratto & "&IDI=" & txtCodAffittuario.Value & "', 'DepCauzInte','height=600,width=800,top=0,left=0');")
                    End If
                End If
                myReader1.Close()

                If Len(ExConduttore) >= 30 Then
                    CType(Generale1.FindControl("lblExcondutt"), Label).Font.Size = 7
                End If
                CType(Generale1.FindControl("lblExcondutt"), Label).Text = ExConduttore
                '09/05/2012 fine IN SEGUITO A VAIN RICARICO PER VISUALIZZARE L'INTESTATARIO PRECEDENTE


                If Len(Conduttore) > 40 Then
                    CType(Generale1.FindControl("lblConduttore"), Label).Font.Size = 8
                End If
                CType(Generale1.FindControl("lblConduttore"), Label).Text = conduttore1
                txtconduttore.Value = Replace(Conduttore, "<br />", ", ")



                'salvo i risultati del calcolo del canone

                par.cmd.CommandText = "delete from siscom_mi.canoni_ec where id_contratto=" & lIdContratto
                par.cmd.ExecuteNonQuery()

                If LBLNOMEFILECANONE.Value <> "" Then
                    If System.IO.File.Exists(LBLNOMEFILECANONE.Value) = True Then


                        Dim sr1 As StreamReader = New StreamReader(LBLNOMEFILECANONE.Value, System.Text.Encoding.GetEncoding("iso-8859-1"))
                        Dim contenuto As String = sr1.ReadToEnd()
                        sr1.Close()

                        'par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,ISE, ISR, ISP, PSE, VSE, REDDITI_DIP, REDDITI_ATRI, LIMITE_PENSIONI, ISEE_27, PERC_VAL_LOC, INC_MAX, CANONE,TESTO) " _
                        '                    & "VALUES (" & lIdContratto & ",'" & Format(My.Computer.FileSystem.GetFileInfo(LBLNOMEFILECANONE.Value).CreationTime, "yyyyMMddHHmmss") _
                        '                    & "'," & AreaEconomica & ",'" & sISEE & "','" & sISE & "','" & sISR & "','" & sISP & "','" & sPSE & "','" & sVSE & "','" & sREDD_DIP & "','" & sREDD_ALT & "','" & sLimitePensione & "','" & sISE_MIN & "','" & sPER_VAL_LOC & "','" & sPERC_INC_MAX_ISE_ERP & "','" & sCanone & "',:TESTO) "

                        If sNOTE = "" Then
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (CANONE_CLASSE,CANONE_SOPPORTABILE,DECADENZA_ALL_ADEGUATO,DECADENZA_VAL_ICI,CANONE_MINIMO_AREA,VALORE_LOCATIVO,SUP_ACCESSORI,MINORI_15,MAGGIORI_65,DATA_STIPULA,COD_CONTRATTO,ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,ISE, ISR, ISP, PSE, VSE, REDDITI_DIP, REDDITI_ATRI, LIMITE_PENSIONI, " _
                                                & "ISEE_27, PERC_VAL_LOC, INC_MAX, CANONE,TESTO,NOTE,ID_BANDO_AU,DEM, SUPCONVENZIONALE, COSTOBASE, ZONA, PIANO, CONSERVAZIONE, VETUSTA,INCIDENZA_ISE," _
                                                & "COEFF_NUCLEO_FAM,SOTTO_AREA,ANNOTAZIONI,PATRIMONIO_SUP,NON_RISPONDENTE,LIMITE_ISEE,ID_DICHIARAZIONE,CANONE_ATTUALE,ADEGUAMENTO,ISTAT," _
                                                & "NUM_COMP,NUM_COMP_66,NUM_COMP_100,NUM_COMP_100_CON,REDD_PREV_DIP,DETRAZIONI,REDD_MOBILIARI,REDD_IMMOBILIARI,REDD_COMPLESSIVO,DETRAZIONI_FRAGILITA,ANNO_COSTRUZIONE," _
                                                & "LOCALITA,PRESENTE_ASCENSORE,NUMERO_PIANO,SUP_NETTA,ALTRE_SUP,PERC_ISTAT_APPLICATA,CANONE_CLASSE_ISTAT,CANONE_91,INIZIO_VALIDITA_CAN,FINE_VALIDITA_CAN,TIPO_PROVENIENZA) " _
                                                & "VALUES ('" & sCANONECLASSE & "','" & sCANONESOPP & "','" & sALLOGGIOIDONEO & "','" & sVALOCIICI & "','" & sCANONE_MIN & "','" & sVALORELOCATIVO & "','" & par.PulisciStrSql(sSUPACCESSORI) & "'," & sMINORI15 & "," & sMAGGIORI65 & ",'" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Text) & "','" & CType(Tab_Contratto1.FindControl("txtCodContratto"), TextBox).Text & "'," & txtIdContratto.Value & ",'" & Format(Now, "yyyyMMddHHmmss") _
                                                & "'," & AreaEconomica & ",'" & sISEE & "','" & sISE & "','" & sISR & "','" & sISP & "','" & sPSE & "','" & sVSE & "','" & sREDD_DIP & "','" _
                                                & sREDD_ALT & "','" & sLimitePensione & "','" & sISE_MIN & "','" & sPER_VAL_LOC & "','" & sPERC_INC_MAX_ISE_ERP & "','" & sCanone & "',:TESTO,'" _
                                                & par.PulisciStrSql(sNOTE) & "',NULL,'" & sDEM & "','" & sSUPCONVENZIONALE & "','" & sCOSTOBASE & "','" & sZONA & "','" & sPiano & "','" _
                                                & sCONSERVAZIONE & "','" & sVETUSTA & "','" & sINCIDENZAISE & "','" & sCOEFFFAM & "','" & sSOTTOAREA & "','" & sMOTIVODECADENZA & "'," _
                                                & "0" & ",0," & "0" & "," & "null" _
                                                & ",'" & "0" & "','" & "0" & "','" _
                                                & "0" & "'," & sNUMCOMP & "," & sNUMCOMP66 & "," & sNUMCOMP100 & "," & sNUMCOMP100C & "," & sPREVDIP _
                                                & ",'" & sDETRAZIONI & "','" & sMOBILIARI & "','" & sIMMOBILIARI & "','" & sCOMPLESSIVO & "','" & sDETRAZIONEF & "','" & sANNOCOSTRUZIONE & "','" & par.PulisciStrSql(sLOCALITA) _
                                                & "','" & sASCENSORE & "','" & par.PulisciStrSql(sDESCRIZIONEPIANO) & "','" & sSUPNETTA & "','" & par.PulisciStrSql(sALTRESUP) & "','" & sISTAT & "','" & sCANONECLASSEISTAT & "','0','" & sANNOINIZIOVAL & "','" & sANNOFINEVAL & "',4) "
                        Else
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.CANONI_EC (CANONE_CLASSE,CANONE_SOPPORTABILE,DECADENZA_ALL_ADEGUATO,DECADENZA_VAL_ICI,CANONE_MINIMO_AREA,VALORE_LOCATIVO,SUP_ACCESSORI,MINORI_15,MAGGIORI_65,DATA_STIPULA,COD_CONTRATTO,ID_CONTRATTO,DATA_CALCOLO,ID_AREA_ECONOMICA,ISEE,ISE, ISR, ISP, PSE, VSE, REDDITI_DIP, REDDITI_ATRI," _
                                                & "LIMITE_PENSIONI, ISEE_27, PERC_VAL_LOC, INC_MAX, CANONE,TESTO,NOTE,ID_BANDO_AU,ANNOTAZIONI,PATRIMONIO_SUP,NON_RISPONDENTE,LIMITE_ISEE,ID_DICHIARAZIONE," _
                                                & "CANONE_ATTUALE,ADEGUAMENTO,ISTAT,NUM_COMP,NUM_COMP_66,NUM_COMP_100,NUM_COMP_100_CON,REDD_PREV_DIP,DETRAZIONI,REDD_MOBILIARI,REDD_IMMOBILIARI," _
                                                & "REDD_COMPLESSIVO,DETRAZIONI_FRAGILITA,ANNO_COSTRUZIONE,LOCALITA,PRESENTE_ASCENSORE,NUMERO_PIANO,SUP_NETTA,ALTRE_SUP,PERC_ISTAT_APPLICATA,CANONE_CLASSE_ISTAT,CANONE_91,INIZIO_VALIDITA_CAN,FINE_VALIDITA_CAN,TIPO_PROVENIENZA) " _
                                                & "VALUES ('" & sCANONECLASSE & "','" & sCANONESOPP & "','" & sALLOGGIOIDONEO & "','" & sVALOCIICI & "','" & sCANONE_MIN & "','" & sVALORELOCATIVO & "','" & par.PulisciStrSql(sSUPACCESSORI) & "'," & sMINORI15 & "," & sMAGGIORI65 & ",'" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Text) & "','" & CType(Tab_Contratto1.FindControl("txtCodContratto"), TextBox).Text & "'," & txtIdContratto.Value & ",'" & Format(Now, "yyyyMMddHHmmss") & "',NULL,'','','','','','','','','','','','','',:TESTO,'" &
                                                par.PulisciStrSql(sNOTE) & "',NULL,'" & sMOTIVODECADENZA & "',0,0,0," _
                                                & "null" & ",'0','0" _
                                                & "','0'," & sNUMCOMP & "," & sNUMCOMP66 & "," & sNUMCOMP100 & "," & sNUMCOMP100C & "," & sPREVDIP _
                                                & ",'" & sDETRAZIONI & "','" & sMOBILIARI & "','" & sIMMOBILIARI & "','" & sCOMPLESSIVO & "','" & sDETRAZIONEF & "','" & sANNOCOSTRUZIONE & "','" _
                                                & par.PulisciStrSql(sLOCALITA) & "','" & sASCENSORE & "','" & par.PulisciStrSql(sDESCRIZIONEPIANO) & "','" & sSUPNETTA & "','" & par.PulisciStrSql(sALTRESUP) & "','" & sISTAT & "','" & sCANONECLASSEISTAT & "','0','" & sANNOINIZIOVAL & "','" & sANNOFINEVAL & "',4) "

                        End If

                        Dim objStream As Stream = File.Open(LBLNOMEFILECANONE.Value, FileMode.Open)
                        Dim buffer(objStream.Length) As Byte
                        objStream.Read(buffer, 0, objStream.Length)
                        objStream.Close()

                        Dim parmData As New Oracle.DataAccess.Client.OracleParameter
                        With parmData
                            .Direction = Data.ParameterDirection.Input
                            .OracleDbType = Oracle.DataAccess.Client.OracleDbType.Blob
                            .ParameterName = "TESTO"
                            .Value = buffer
                        End With

                        par.cmd.Parameters.Add(parmData)
                        par.cmd.ExecuteNonQuery()
                        System.IO.File.Delete(LBLNOMEFILECANONE.Value)
                        par.cmd.Parameters.Remove(parmData)

                        buffer = Nothing
                        objStream = Nothing



                    End If
                End If

                btnAttivaContratto.Visible = True
                'btnMavAttivazione.Visible = True
                ImgBolAttivazione.Visible = True
                btnStampaContratto.Visible = True

                If CaricaSpese(True) = True Then
                    speseunita.Value = "0"
                Else
                    speseunita.Value = "1"
                End If
                'speseunita.Value = "1"
            Else
                If CType(Generale1.FindControl("lblStato"), Label).Text = "BOZZA" Then
                    'SE IL CONTRATTO è ANCORA IN BOZZA POSSO AGGIORNARE TUTTO
                    If TipoContratto = "12" Or TipoContratto = "11" Or TipoContratto = "10" Or TipoContratto = "1" Or TipoContratto = "2" Or TipoContratto = "3" Or TipoContratto = "5" Or TipoContratto = "6" Or TipoContratto = "7" Then
                        If TipoContratto = "1" Or TipoContratto = "2" Then
                            CType(Tab_Canone1.FindControl("ImgRicalcolaC"), ImageButton).Visible = True
                        Else
                            CType(Tab_Canone1.FindControl("ImgRicalcolaC"), ImageButton).Visible = False
                            CType(Tab_Canone1.FindControl("lblDettaglioCanoni"), Label).Text = ""
                            CType(Tab_Canone1.FindControl("label4"), Label).Text = ""
                        End If

                        If TipoContratto = "7" Then
                            TIPORAPP = "ILLEG"
                        Else
                            TIPORAPP = "LEGIT"
                        End If

                        'DATI CONTRATTO
                        par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET COD_CONTRATTO='" & CodContratto1 _
                                            & "',COD_TIPOLOGIA_RAPP_CONTR='" & TIPORAPP & "'," _
                                            & "COD_TIPOLOGIA_CONTR_LOC='" & CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedItem.Value _
                                            & "',DURATA_ANNI=" & CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).Text _
                                            & ",DURATA_RINNOVO=" & CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).Text _
                                            & ",DATA_DECORRENZA='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) _
                                            & "',DATA_DECORRENZA_AE='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Text) _
                                            & "',DATA_SCADENZA='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text) _
                                            & "',DATA_DISDETTA_LOCATARIO='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text) _
                                            & "',DATA_notifica_disdetta='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtNotificaDisdetta"), TextBox).Text) _
                                            & "',mittente_disdetta='" & CType(Tab_Contratto1.FindControl("cmbMittenteDisdetta"), DropDownList).SelectedValue _
                                            & "',DATA_INVIO_RIC_DISDETTA='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDisdetta0"), TextBox).Text) _
                                            & "',NUM_REGISTRAZIONE='" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Text) _
                                            & "',SERIE_REGISTRAZIONE='" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtSerie"), TextBox).Text) _
                                            & "',IMP_CANONE_INIZIALE=" & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text, "NULL")) _
                                            & ",IMP_DEPOSITO_CAUZ=" & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, "NULL")) _
                                            & ",DATA_REG='" & par.AggiustaData(CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Text) _
                                            & "',COD_UFFICIO_REG='" & CType(Tab_Registrazione1.FindControl("cmbUfficioRegistro"), DropDownList).SelectedValue _
                                            & "',DATA_STIPULA='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Text) _
                                            & "',DATA_CONSEGNA='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataConsegna"), TextBox).Text) _
                                            & "',DATA_SCADENZA_RINNOVO='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Text) _
                                            & "',MESI_DISDETTA=" & par.IfEmpty(CType(Tab_Contratto1.FindControl("txtEntroCuiDisdettare"), TextBox).Text, "NULL") _
                                            & ",DATA_RICONSEGNA='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text) _
                                            & "',DELIBERA='" & par.PulisciStrSql(CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Text) _
                                            & "',DATA_DELIBERA='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text) _
                                            & "',data_trasm_delibera='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).Text) _
                                            & "',NRO_RATE=" & CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedValue _
                                            & ",PER_BANDO=1" _
                                            & ",TIPO_COR='" & Trim(par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("cmbTipoViaCor"), DropDownList).SelectedItem.Text)) _
                                            & "',LUOGO_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text) _
                                            & "',VIA_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtViaCor"), TextBox).Text) _
                                            & "',NOTE_COR=''" _
                                            & ",CIVICO_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtCivicoCor"), TextBox).Text) _
                                            & "',SIGLA_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtSiglaCor"), TextBox).Text) _
                                            & "',CAP_COR='" & CType(Tab_Comunicazioni1.FindControl("txtCAPCOR"), TextBox).Text _
                                            & "',PRESSO_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtPresso"), TextBox).Text) _
                                            & "',MAIL_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Text) _
                                            & "',MAIL_PEC_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Text) _
                                            & "',NRO_REPERTORIO='" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).Text) _
                                            & "',DATA_REPERTORIO='" & par.AggiustaData(CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Text) _
                                            & "',NRO_ASSEGNAZIONE_PG='" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Text) _
                                            & "',DATA_ASSEGNAZIONE_PG='" & par.AggiustaData(CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Text) _
                                            & "',LIBRETTO_DEPOSITO='" & par.PulisciStrSql(CType(Tab_Canone1.FindControl("txtLibrettoDeposito"), TextBox).Text) _
                                            & "',ID_DEST_RATE=" & CType(Tab_Canone1.FindControl("cmbDestRate"), DropDownList).SelectedValue _
                                            & ",INVIO_BOLLETTA='" & Valore01(CType(Tab_Canone1.FindControl("checkInvioBoll"), CheckBox).Checked) _
                                            & "',FL_CONGUAGLIO='" & Valore01(CType(Tab_Canone1.FindControl("checkConguaglioBoll"), CheckBox).Checked) _
                                            & "',IMP_CANONE_ATTUALE=" & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text, "NULL")) _
                                            & ",INTERESSI_CAUZIONE='" & Valore01(CType(Tab_Canone1.FindControl("checkInteressiCauzione"), CheckBox).Checked) _
                                            & "',INTERESSI_RIT_PAG='" & Valore01(CType(Tab_Canone1.FindControl("checkInteressiCauzione"), CheckBox).Checked) _
                                            & "',NOTE='" _
                                            & "',IMPORTO_ANTICIPO=" & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text, 0)) _
                                            & ",FREQ_VAR_ISTAT ='" & CType(Tab_Canone1.FindControl("lblistat2"), DropDownList).SelectedItem.Value _
                                            & "',PERC_ISTAT = " & CType(Tab_Canone1.FindControl("lblistat4"), DropDownList).SelectedItem.Value _
                                            & ",ID_COMMISSARIATO=" & CType(Tab_Comunicazioni1.FindControl("cmbCommissariato"), DropDownList).SelectedItem.Value _
                                            & ",VERSAMENTO_TR='" & CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).SelectedItem.Value _
                                            & "',DEST_USO='" & CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Value _
                                            & "',DESCR_DEST_USO='" & par.PulisciStrSql(CType(Tab_Contratto1.FindControl("txtDescrDestinazione"), TextBox).Text) _
                                            & "',FL_BOLLO_ASSOLTO='" & Valore01(CType(Tab_Contratto1.FindControl("ChBolloEsente"), CheckBox).Checked) _
                                            & "',FL_ASSEGN_TEMP='" & Valore01(CType(Tab_Contratto1.FindControl("chkTemporanea"), CheckBox).Checked) _
                                            & "',FL_TUTORE_STR=" & Valore01(CType(Tab_Contratto1.FindControl("ChTutore"), CheckBox).Checked) _
                                            & ",SINDACATO=" & SINDACATO _
                                            & ",NOTE_REGISTRAZIONE='" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtNotereg"), TextBox).Text) _
                                            & "',SCALA_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtScalaCor"), TextBox).Text) _
                                            & "',PIANO_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtPianoCor"), TextBox).Text) _
                                            & "',INTERNO_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtInternoCor"), TextBox).Text) & "'" _
                                            & ",ID_ORIGINE_CONTRATTO=" & par.insDbValue(CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedValue, False, False, True) _
                                            & ",FL_IRREPERIBILE=" & Valore01(CType(Tab_Comunicazioni1.FindControl("chkIrreperibile"), CheckBox).Checked) _
                                            & " WHERE ID=" & lIdContratto
                        par.cmd.ExecuteNonQuery()

                        If CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedValue = "NONE" Then
                            If Session.Item("RU_GESTIONE_OA") = "1" Then
                            SalvaOccupanteAbusivo()
                        End If
                        End If

                        'CANCELLO I SOGGETTI CONTRATTUALI DEL CONTRATTO PER POI INSERIRLI NUOVAMENTE
                        par.cmd.CommandText = "DELETE FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & lIdContratto
                        par.cmd.ExecuteNonQuery()


                        Dim TIPOINT As String = ""
                        Dim TIPOOCCU As String = ""

                        'INSERISCO GLI INTESTATARI NEI SOGGETTI CONTRATTUALI
                        For I = 0 To CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Count - 1
                            If I = 0 Then
                                TIPOINT = "INTE"
                            Else
                                TIPOINT = "COINT"
                            End If
                            par.cmd.CommandText = "SELECT ANAGRAFICA.* FROM SISCOM_MI.ANAGRAFICA WHERE COD_FISCALE='" & par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items(I).Text, 39, 16) & "' OR PARTITA_IVA='" & par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items(I).Text, 39, 16) & "'"
                            Dim myReaderB As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            If myReaderB.Read Then
                                par.cmd.CommandText = "SELECT COD FROM SISCOM_MI.TIPOLOGIA_PARENTELA WHERE UPPER(DESCRIZIONE)='" & par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items(I).Text, 56, 20) & "'"
                                Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                If myReaderC.Read Then
                                    If TIPORAPP = "ILLEG" Then
                                        TIPOOCCU = "NOTIT"
                                    Else
                                        TIPOOCCU = "LEGIT"
                                    End If
                                    par.cmd.CommandText = "Insert into SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA, ID_CONTRATTO, COD_TIPOLOGIA_PARENTELA, " _
                                                       & "COD_TIPOLOGIA_OCCUPANTE, COD_TIPOLOGIA_TITOLO, DATA_INIZIO, DATA_FINE) " _
                                                       & "Values " _
                                                       & "(" & myReaderB("ID") & ", " & lIdContratto & " , '" & myReaderC("COD") & "', '" & TIPOINT & "', '" & TIPOOCCU & "', '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) & "', NULL)"
                                    par.cmd.ExecuteNonQuery()
                                End If
                                myReaderC.Close()
                            End If
                            myReaderB.Close()
                        Next I

                        'INSERISCO I COMPONENTI NEI SOGGETTI CONTRATTUALI
                        For I = 0 To CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Count - 1
                            par.cmd.CommandText = "SELECT ANAGRAFICA.* FROM SISCOM_MI.ANAGRAFICA WHERE COD_FISCALE='" & par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items(I).Text, 39, 16) & "' OR PARTITA_IVA='" & par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items(I).Text, 39, 16) & "'"
                            Dim myReaderB As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            If myReaderB.Read Then
                                par.cmd.CommandText = "SELECT COD FROM SISCOM_MI.TIPOLOGIA_PARENTELA WHERE UPPER(DESCRIZIONE)='" & par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items(I).Text, 56, 20) & "'"
                                Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                If myReaderC.Read Then
                                    If TIPORAPP = "ILLEG" Then
                                        TIPOOCCU = "NOTIT"
                                    Else
                                        TIPOOCCU = "LEGIT"
                                    End If
                                    par.cmd.CommandText = "Insert into SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA, ID_CONTRATTO, COD_TIPOLOGIA_PARENTELA, " _
                                                       & "COD_TIPOLOGIA_OCCUPANTE, COD_TIPOLOGIA_TITOLO, DATA_INIZIO, DATA_FINE) " _
                                                       & "Values " _
                                                       & "(" & myReaderB("ID") & ", " & lIdContratto & " , '" & myReaderC("COD") & "', 'ALTR', '" & TIPOOCCU & "', '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) & "', NULL)"
                                    par.cmd.ExecuteNonQuery()
                                End If
                                myReaderC.Close()
                            End If
                            myReaderB.Close()
                        Next I

                        'CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Clear()
                        'CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Clear()

                        ''CARICO INTESTATARI
                        'par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.data_inizio,SOGGETTI_CONTRATTUALI.data_fine,TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",ANAGRAFICA.* FROM SISCOM_MI.TIPOLOGIA_PARENTELA,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE TIPOLOGIA_PARENTELA.COD=SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_PARENTELA AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND  COD_TIPOLOGIA_OCCUPANTE='INTE' AND ID_CONTRATTO=" & lIdContratto
                        'Dim myReader2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        'Do While myReader2.Read
                        '    If par.IfNull(myReader2("RAGIONE_SOCIALE"), "") <> "" Then
                        '        CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("RAGIONE_SOCIALE"), ""), 37) & " " & par.MiaFormat(par.IfNull(myReader2("PARTITA_IVA"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
                        '    Else
                        '        CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReader2("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReader2("COD_FISCALE"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
                        '    End If
                        'Loop
                        'myReader2.Close()


                        ''CARICO COINTESTATARI
                        'par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.data_inizio,SOGGETTI_CONTRATTUALI.data_fine,TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",ANAGRAFICA.* FROM SISCOM_MI.TIPOLOGIA_PARENTELA,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE TIPOLOGIA_PARENTELA.COD=SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_PARENTELA AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND  COD_TIPOLOGIA_OCCUPANTE='COINT' AND ID_CONTRATTO=" & lIdContratto
                        'myReader2 = par.cmd.ExecuteReader()
                        'Do While myReader2.Read
                        '    If par.IfNull(myReader2("RAGIONE_SOCIALE"), "") <> "" Then
                        '        CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("RAGIONE_SOCIALE"), ""), 37) & " " & par.MiaFormat(par.IfNull(myReader2("PARTITA_IVA"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
                        '    Else
                        '        CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReader2("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReader2("COD_FISCALE"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
                        '    End If
                        'Loop
                        'myReader2.Close()


                        ''CARICAMENTO OCCUPANTI
                        'par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.data_inizio,SOGGETTI_CONTRATTUALI.data_fine,TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",ANAGRAFICA.* FROM SISCOM_MI.TIPOLOGIA_PARENTELA,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE TIPOLOGIA_PARENTELA.COD=SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_PARENTELA AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND  COD_TIPOLOGIA_OCCUPANTE<>'INTE' AND COD_TIPOLOGIA_OCCUPANTE<>'COINT' AND ID_CONTRATTO=" & lIdContratto & " order by anagrafica.cognome asc,anagrafica.nome asc,SOGGETTI_CONTRATTUALI.data_inizio"
                        'myReader2 = par.cmd.ExecuteReader()
                        'Do While myReader2.Read
                        '    If par.IfNull(myReader2("RAGIONE_SOCIALE"), "") <> "" Then
                        '        CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("RAGIONE_SOCIALE"), ""), 37) & " " & par.MiaFormat(par.IfNull(myReader2("PARTITA_IVA"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
                        '    Else
                        '        CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReader2("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReader2("COD_FISCALE"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
                        '    End If

                        'Loop
                        'myReader2.Close()


                        'GESTIONE OSPITI

                        'par.cmd.CommandText = "DELETE FROM SISCOM_MI.OSPITI WHERE ID_CONTRATTO=" & lIdContratto
                        'par.cmd.ExecuteNonQuery()

                        '                        For I = 0 To CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Count - 1
                        '
                        '                            par.cmd.CommandText = "Insert into SISCOM_MI.ospiti (ID, ID_CONTRATTO, DATA_AGG, " _
                        '                                               & "DATA_INIZIO_OSPITE, DATA_FINE_OSPITE, NOMINATIVO, COD_FISCALE) " _
                        '                                               & "Values " _
                        '                                               & "(SISCOM_MI.SEQ_OSPITI.NEXTVAL," & lIdContratto & " , '" & Format(Now, "yyyyMMdd") _
                        '                                               & "', '" & par.AggiustaData(par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items(I).Text, 49, 15)) _
                        '                                               & "', '" & par.AggiustaData(par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items(I).Text, 65, 15)) _
                        '                                               & "','" & par.PulisciStrSql(par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items(I).Text, 1, 30)) _
                        '                                               & "','" & par.PulisciStrSql(par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items(I).Text, 32, 16)) _
                        '                                               & "')"
                        '                            par.cmd.ExecuteNonQuery()

                        '                        Next I

                        ''CARICAMENTO OSPITI
                        'CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Clear()

                        'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.OSPITI WHERE ID_CONTRATTO=" & lIdContratto & " ORDER BY DATA_AGG DESC"
                        'myReader2 = par.cmd.ExecuteReader()
                        'Do While myReader2.Read
                        '    CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("nominativo"), ""), 30) & " " & par.MiaFormat(par.IfNull(myReader2("cod_fiscale"), ""), 16) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio_ospite"), "")), 15) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_fine_ospite"), "")), 15), myReader2("ID")))
                        'Loop
                        'myReader2.Close()


                        'CANCELLO LE UNITA CONTRATTUALI PER POI RICREARLE
                        par.cmd.CommandText = "DELETE FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & lIdContratto
                        par.cmd.ExecuteNonQuery()
                        par.cmd.CommandText = "DELETE FROM SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & lIdContratto
                        par.cmd.ExecuteNonQuery()

                        'AGGIORNO L'UNITA CONTRATTUALE PER IL NUOVO CONTRATTO
                        par.cmd.CommandText = "SELECT SCALE_EDIFICI.DESCRIZIONE AS ""SCALAUNITA"",UNITA_IMMOBILIARI.*,IDENTIFICATIVI_CATASTALI.FOGLIO,IDENTIFICATIVI_CATASTALI.SEZIONE," _
                                            & "IDENTIFICATIVI_CATASTALI.NUMERO,IDENTIFICATIVI_CATASTALI.SUB,IDENTIFICATIVI_CATASTALI.COD_TIPOLOGIA_CATASTO," _
                                            & "IDENTIFICATIVI_CATASTALI.RENDITA,IDENTIFICATIVI_CATASTALI.COD_CATEGORIA_CATASTALE " _
                                            & ",IDENTIFICATIVI_CATASTALI.COD_CLASSE_CATASTALE,IDENTIFICATIVI_CATASTALI.COD_QUALITA_CATASTALE, " _
                                            & "IDENTIFICATIVI_CATASTALI.SUPERFICIE_MQ,IDENTIFICATIVI_CATASTALI.CUBATURA,IDENTIFICATIVI_CATASTALI.NUM_VANI" _
                                            & ",IDENTIFICATIVI_CATASTALI.SUPERFICIE_CATASTALE,IDENTIFICATIVI_CATASTALI.RENDITA_STORICA," _
                                            & "IDENTIFICATIVI_CATASTALI.IMMOBILE_STORICO,IDENTIFICATIVI_CATASTALI.VALORE_IMPONIBILE" _
                                            & ",IDENTIFICATIVI_CATASTALI.DATA_ACQUISIZIONE,IDENTIFICATIVI_CATASTALI.DATA_FINE_VALIDITA" _
                                            & ",IDENTIFICATIVI_CATASTALI.DITTA,IDENTIFICATIVI_CATASTALI.NUM_PARTITA" _
                                            & ",IDENTIFICATIVI_CATASTALI.ESENTE_ICI,IDENTIFICATIVI_CATASTALI.PERC_POSSESSO" _
                                            & ",IDENTIFICATIVI_CATASTALI.INAGIBILE,IDENTIFICATIVI_CATASTALI.MICROZONA_CENSUARIA" _
                                            & ",IDENTIFICATIVI_CATASTALI.ZONA_CENSUARIA,IDENTIFICATIVI_CATASTALI.COD_STATO_CATASTALE" _
                                            & ",INDIRIZZI.DESCRIZIONE AS ""IND"",INDIRIZZI.CIVICO,INDIRIZZI.CAP,INDIRIZZI.LOCALITA,INDIRIZZI.COD_COMUNE" _
                                            & " FROM SISCOM_MI.SCALE_EDIFICI,SISCOM_MI.INDIRIZZI,SISCOM_MI.UNITA_IMMOBILIARI,SISCOM_MI.IDENTIFICATIVI_CATASTALI " _
                                            & "WHERE UNITA_IMMOBILIARI.ID_SCALA=SCALE_EDIFICI.ID (+) AND INDIRIZZI.ID=unita_immobiliari.id_indirizzo (+) AND UNITA_IMMOBILIARI.ID_CATASTALE=IDENTIFICATIVI_CATASTALI.ID (+) AND UNITA_IMMOBILIARI.ID=" & UnitaContratto
                        Dim myReaderD As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderD.Read Then
                            par.cmd.CommandText = "Insert into SISCOM_MI.UNITA_CONTRATTUALE (ID_CONTRATTO, ID_UNITA, COD_UNITA_IMMOBILIARE, TIPOLOGIA, ID_EDIFICIO, " _
                                                & "SCALA, COD_TIPO_LIVELLO_PIANO, INTERNO, ID_UNITA_PRINCIPALE, SEZIONE, FOGLIO, NUMERO, SUB, COD_TIPOLOGIA_CATASTO, RENDITA, " _
                                                & "COD_CATEGORIA_CATASTALE, COD_CLASSE_CATASTALE, COD_QUALITA_CATASTALE, SUPERFICIE_MQ, CUBATURA, " _
                                                & "NUM_VANI, SUPERFICIE_CATASTALE, RENDITA_STORICA, IMMOBILE_STORICO, REDDITO_DOMINICALE, " _
                                                & "VALORE_IMPONIBILE, REDDITO_AGRARIO, VALORE_BILANCIO, DATA_ACQUISIZIONE, DATA_FINE_VALIDITA,  " _
                                                & "DITTA, NUM_PARTITA, ESENTE_ICI, PERC_POSSESSO, INAGIBILE, " _
                                                & "MICROZONA_CENSUARIA, ZONA_CENSUARIA, COD_STATO_CATASTALE, INDIRIZZO, CIVICO, " _
                                                & "CAP, LOCALITA, COD_COMUNE, SUP_CONVENZIONALE,VAL_LOCATIVO_UNITA) " _
                                                & "Values " _
                                                & "(" & lIdContratto & " , " & UnitaContratto & " , '" _
                                                & myReaderD("COD_UNITA_IMMOBILIARE") & "', '" _
                                                & myReaderD("COD_TIPOLOGIA") & "', " & myReaderD("ID_EDIFICIO") & ", " _
                                                & "'" & par.IfNull(myReaderD("SCALAUNITA"), "") & "', '" _
                                                & par.IfNull(myReaderD("COD_TIPO_LIVELLO_PIANO"), "01") & "', '" _
                                                & par.IfNull(myReaderD("INTERNO"), "") & "', NULL, '" & par.IfNull(myReaderD("SEZIONE"), "") & "', " _
                                                & "'" & par.IfNull(myReaderD("FOGLIO"), "") & "', '" & par.IfNull(myReaderD("NUMERO"), "") & "', '" & par.IfNull(myReaderD("SUB"), "") & "', '" & par.IfNull(myReaderD("COD_TIPOLOGIA_CATASTO"), "") & "', " & par.VirgoleInPunti(par.IfNull(myReaderD("RENDITA"), "NULL")) & " , " _
                                                & "'" & par.IfNull(myReaderD("COD_CATEGORIA_CATASTALE"), "") & "', '" _
                                                & par.IfNull(myReaderD("COD_CLASSE_CATASTALE"), "") & "', '" & par.IfNull(myReaderD("COD_QUALITA_CATASTALE"), "") _
                                                & "', " & par.VirgoleInPunti(par.IfNull(myReaderD("SUPERFICIE_MQ"), "NULL")) _
                                                & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("CUBATURA"), "NULL")) & ", " _
                                                & par.VirgoleInPunti(par.IfNull(myReaderD("NUM_VANI"), "NULL")) _
                                                & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("SUPERFICIE_CATASTALE"), "NULL")) _
                                                & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("RENDITA_STORICA"), "NULL")) _
                                                & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("IMMOBILE_STORICO"), "NULL")) & ", NULL, " _
                                                & par.VirgoleInPunti(par.IfNull(myReaderD("VALORE_IMPONIBILE"), "NULL")) _
                                                & ", NULL, " & par.VirgoleInPunti(par.IfNull(myReaderD("VALORE_IMPONIBILE"), "NULL")) _
                                                & ", '" & par.IfNull(myReaderD("DATA_ACQUISIZIONE"), "") _
                                                & "', '" & par.IfNull(myReaderD("DATA_FINE_VALIDITA"), "") & "', '" _
                                                & par.IfNull(myReaderD("DITTA"), "") _
                                                & "', '" & par.IfNull(myReaderD("NUM_PARTITA"), "") _
                                                & "', " & par.IfNull(myReaderD("ESENTE_ICI"), "NULL") _
                                                & "," & par.VirgoleInPunti(par.IfNull(myReaderD("PERC_POSSESSO"), "NULL")) _
                                                & "," & par.IfNull(myReaderD("INAGIBILE"), "NULL") & ", '" _
                                                & par.IfNull(myReaderD("MICROZONA_CENSUARIA"), "") _
                                                & "', '" & par.IfNull(myReaderD("ZONA_CENSUARIA"), "") _
                                                & "', '" & par.IfNull(myReaderD("COD_STATO_CATASTALE"), "") _
                                                & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("IND"), "")) _
                                                & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("CIVICO"), "")) & "', " _
                                                & "'" & par.IfNull(myReaderD("CAP"), "") _
                                                & "', NULL, '" & par.IfNull(myReaderD("COD_COMUNE"), "") _
                                                & "', 0,'" & VAL_LOCATIVO_UNITA & "')"
                            par.cmd.ExecuteNonQuery()

                            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.DIMENSIONI WHERE ID_UNITA_IMMOBILIARE=" & UnitaContratto
                            Dim myReaderF As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            Do While myReaderF.Read
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE (ID_CONTRATTO, ID_UNITA, COD_TIPOLOGIA, VALORE) VALUES (" _
                                                    & lIdContratto & "," & UnitaContratto & ",'" _
                                                    & par.IfNull(myReaderF("COD_TIPOLOGIA"), "") _
                                                    & "'," & par.VirgoleInPunti(par.IfNull(myReaderF("VALORE"), "NULL")) & ")"
                                par.cmd.ExecuteNonQuery()
                            Loop
                            myReaderF.Close()

                            Dim VAL_MILLESIMO As Double
                            Dim TOT_VERDE As Double = 0
                            Dim IDCOMPLESSO As Long = 0

                            par.cmd.CommandText = "SELECT VALORI_MILLESIMALI.VALORE_MILLESIMO FROM SISCOM_MI.TABELLE_MILLESIMALI,SISCOM_MI.VALORI_MILLESIMALI WHERE VALORI_MILLESIMALI.ID_UNITA_IMMOBILIARE=" & UnitaContratto & " AND TABELLE_MILLESIMALI.ID=VALORI_MILLESIMALI.ID_TABELLA AND TABELLE_MILLESIMALI.COD_TIPOLOGIA='VE'"
                            Dim myReaderH As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            Do While myReaderH.Read
                                VAL_MILLESIMO = VAL_MILLESIMO + CDbl(par.IfNull(myReaderH("VALORE_MILLESIMO"), 0))
                            Loop
                            myReaderH.Close()
                            If VAL_MILLESIMO > 0 Then
                                par.cmd.CommandText = "SELECT DIMENSIONI.VALORE FROM SISCOM_MI.DIMENSIONI,SISCOM_MI.UNITA_COMUNI WHERE dimensioni.cod_tipologia='SUVEC' AND UNITA_COMUNI.ID_EDIFICIO=" & myReaderD("ID_EDIFICIO") & " AND DIMENSIONI.ID_UNITA_COMUNE=UNITA_COMUNI.ID"
                                Dim myReaderG As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                Do While myReaderG.Read
                                    TOT_VERDE = TOT_VERDE + CDbl(par.IfNull(myReaderG("VALORE"), 0))
                                Loop
                                myReaderG.Close()

                                par.cmd.CommandText = "SELECT ID_COMPLESSO FROM SISCOM_MI.EDIFICI WHERE ID=" & myReaderD("ID_EDIFICIO")
                                myReaderG = par.cmd.ExecuteReader()
                                If myReaderG.Read Then
                                    IDCOMPLESSO = par.IfNull(myReaderG("ID_COMPLESSO"), 0)
                                End If
                                myReaderG.Close()
                                If IDCOMPLESSO <> 0 Then
                                    par.cmd.CommandText = "SELECT DIMENSIONI.VALORE FROM SISCOM_MI.DIMENSIONI,SISCOM_MI.UNITA_COMUNI WHERE dimensioni.cod_tipologia='SUVEC' AND UNITA_COMUNI.ID_COMPLESSO=" & IDCOMPLESSO & " AND DIMENSIONI.ID_UNITA_COMUNE=UNITA_COMUNI.ID"
                                    myReaderG = par.cmd.ExecuteReader()
                                    Do While myReaderG.Read
                                        TOT_VERDE = TOT_VERDE + CDbl(par.IfNull(myReaderG("VALORE"), 0))
                                    Loop
                                    myReaderG.Close()
                                End If

                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE (ID_CONTRATTO, ID_UNITA, COD_TIPOLOGIA, VALORE) VALUES (" _
                                                    & lIdContratto & "," & UnitaContratto & ",'SUVEC" _
                                                    & "'," & par.VirgoleInPunti((TOT_VERDE / 1000) * VAL_MILLESIMO) & ")"
                                par.cmd.ExecuteNonQuery()
                            End If

                        End If
                        myReaderD.Close()

                        'CREO L'UNITA CONTRATTUALE PERTINENZE PER IL NUOVO CONTRATTO
                        par.cmd.CommandText = "SELECT ID FROM SISCOM_MI.UNITA_IMMOBILIARI WHERE ID_UNITA_PRINCIPALE=" & UnitaContratto
                        Dim myReaderE As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        Do While myReaderE.Read
                            par.cmd.CommandText = "SELECT SCALE_EDIFICI.DESCRIZIONE AS ""SCALAUNITA"",UNITA_IMMOBILIARI.*,IDENTIFICATIVI_CATASTALI.FOGLIO,IDENTIFICATIVI_CATASTALI.SEZIONE," _
                                                & "IDENTIFICATIVI_CATASTALI.NUMERO,IDENTIFICATIVI_CATASTALI.SUB,IDENTIFICATIVI_CATASTALI.COD_TIPOLOGIA_CATASTO," _
                                                & "IDENTIFICATIVI_CATASTALI.RENDITA,IDENTIFICATIVI_CATASTALI.COD_CATEGORIA_CATASTALE " _
                                                & ",IDENTIFICATIVI_CATASTALI.COD_CLASSE_CATASTALE,IDENTIFICATIVI_CATASTALI.COD_QUALITA_CATASTALE, " _
                                                & "IDENTIFICATIVI_CATASTALI.SUPERFICIE_MQ,IDENTIFICATIVI_CATASTALI.CUBATURA,IDENTIFICATIVI_CATASTALI.NUM_VANI" _
                                                & ",IDENTIFICATIVI_CATASTALI.SUPERFICIE_CATASTALE,IDENTIFICATIVI_CATASTALI.RENDITA_STORICA," _
                                                & "IDENTIFICATIVI_CATASTALI.IMMOBILE_STORICO,IDENTIFICATIVI_CATASTALI.VALORE_IMPONIBILE" _
                                                & ",IDENTIFICATIVI_CATASTALI.DATA_ACQUISIZIONE,IDENTIFICATIVI_CATASTALI.DATA_FINE_VALIDITA" _
                                                & ",IDENTIFICATIVI_CATASTALI.DITTA,IDENTIFICATIVI_CATASTALI.NUM_PARTITA" _
                                                & ",IDENTIFICATIVI_CATASTALI.ESENTE_ICI,IDENTIFICATIVI_CATASTALI.PERC_POSSESSO" _
                                                & ",IDENTIFICATIVI_CATASTALI.INAGIBILE,IDENTIFICATIVI_CATASTALI.MICROZONA_CENSUARIA" _
                                                & ",IDENTIFICATIVI_CATASTALI.ZONA_CENSUARIA,IDENTIFICATIVI_CATASTALI.COD_STATO_CATASTALE" _
                                                & ",INDIRIZZI.DESCRIZIONE AS ""IND"",INDIRIZZI.CIVICO,INDIRIZZI.CAP,INDIRIZZI.LOCALITA,INDIRIZZI.COD_COMUNE" _
                                                & " FROM SISCOM_MI.SCALE_EDIFICI,SISCOM_MI.INDIRIZZI,SISCOM_MI.UNITA_IMMOBILIARI,SISCOM_MI.IDENTIFICATIVI_CATASTALI " _
                                                & "WHERE UNITA_IMMOBILIARI.ID_SCALA=SCALE_EDIFICI.ID (+) AND INDIRIZZI.ID=unita_immobiliari.id_indirizzo AND UNITA_IMMOBILIARI.ID_CATASTALE=IDENTIFICATIVI_CATASTALI.ID (+) AND UNITA_IMMOBILIARI.ID=" & myReaderE("ID")
                            myReaderD = par.cmd.ExecuteReader()
                            If myReaderD.Read Then
                                par.cmd.CommandText = "Insert into SISCOM_MI.UNITA_CONTRATTUALE (ID_CONTRATTO, ID_UNITA, COD_UNITA_IMMOBILIARE, TIPOLOGIA, ID_EDIFICIO, " _
                                                    & "SCALA, COD_TIPO_LIVELLO_PIANO, INTERNO, ID_UNITA_PRINCIPALE, SEZIONE, FOGLIO, NUMERO, SUB, COD_TIPOLOGIA_CATASTO, RENDITA, " _
                                                    & "COD_CATEGORIA_CATASTALE, COD_CLASSE_CATASTALE, COD_QUALITA_CATASTALE, SUPERFICIE_MQ, CUBATURA, " _
                                                    & "NUM_VANI, SUPERFICIE_CATASTALE, RENDITA_STORICA, IMMOBILE_STORICO, REDDITO_DOMINICALE, " _
                                                    & "VALORE_IMPONIBILE, REDDITO_AGRARIO, VALORE_BILANCIO, DATA_ACQUISIZIONE, DATA_FINE_VALIDITA,  " _
                                                    & "DITTA, NUM_PARTITA, ESENTE_ICI, PERC_POSSESSO, INAGIBILE, " _
                                                    & "MICROZONA_CENSUARIA, ZONA_CENSUARIA, COD_STATO_CATASTALE, INDIRIZZO, CIVICO, " _
                                                    & "CAP, LOCALITA, COD_COMUNE, SUP_CONVENZIONALE) " _
                                                    & "Values " _
                                                    & "(" & lIdContratto & " , " & myReaderE("ID") & " , '" _
                                                    & myReaderD("COD_UNITA_IMMOBILIARE") & "', '" _
                                                    & myReaderD("COD_TIPOLOGIA") & "', " & myReaderD("ID_EDIFICIO") & ", " _
                                                    & "'" & par.IfNull(myReaderD("SCALAUNITA"), "") & "', '" _
                                                    & par.IfNull(myReaderD("COD_TIPO_LIVELLO_PIANO"), "01") & "', '" _
                                                    & par.IfNull(myReaderD("INTERNO"), "") & "', " & UnitaContratto & ", '" & par.IfNull(myReaderD("SEZIONE"), "") & "', " _
                                                    & "'" & par.IfNull(myReaderD("FOGLIO"), "") & "', '" & par.IfNull(myReaderD("NUMERO"), "") & "', '" & par.IfNull(myReaderD("SUB"), "") & "', '" & par.IfNull(myReaderD("COD_TIPOLOGIA_CATASTO"), "") & "', " & par.VirgoleInPunti(par.IfNull(myReaderD("RENDITA"), "NULL")) & " , " _
                                                    & "'" & par.IfNull(myReaderD("COD_CATEGORIA_CATASTALE"), "") & "', '" _
                                                    & par.IfNull(myReaderD("COD_CLASSE_CATASTALE"), "") & "', '" & par.IfNull(myReaderD("COD_QUALITA_CATASTALE"), "") _
                                                    & "', " & par.VirgoleInPunti(par.IfNull(myReaderD("SUPERFICIE_MQ"), "NULL")) _
                                                    & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("CUBATURA"), "NULL")) & ", " _
                                                    & par.VirgoleInPunti(par.IfNull(myReaderD("NUM_VANI"), "NULL")) _
                                                    & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("SUPERFICIE_CATASTALE"), "NULL")) _
                                                    & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("RENDITA_STORICA"), "NULL")) _
                                                    & ", " & par.VirgoleInPunti(par.IfNull(myReaderD("IMMOBILE_STORICO"), "NULL")) & ", NULL, " _
                                                    & par.VirgoleInPunti(par.IfNull(myReaderD("VALORE_IMPONIBILE"), "NULL")) _
                                                    & ", NULL, " & par.VirgoleInPunti(par.IfNull(myReaderD("VALORE_IMPONIBILE"), "NULL")) _
                                                    & ", '" & par.IfNull(myReaderD("DATA_ACQUISIZIONE"), "") _
                                                    & "', '" & par.IfNull(myReaderD("DATA_FINE_VALIDITA"), "") & "', '" _
                                                    & par.IfNull(myReaderD("DITTA"), "") _
                                                    & "', '" & par.IfNull(myReaderD("NUM_PARTITA"), "") _
                                                    & "', " & par.IfNull(myReaderD("ESENTE_ICI"), "NULL") _
                                                    & "," & par.VirgoleInPunti(par.IfNull(myReaderD("PERC_POSSESSO"), "NULL")) _
                                                    & "," & par.IfNull(myReaderD("INAGIBILE"), "NULL") & ", '" _
                                                    & par.IfNull(myReaderD("MICROZONA_CENSUARIA"), "") _
                                                    & "', '" & par.IfNull(myReaderD("ZONA_CENSUARIA"), "") _
                                                    & "', '" & par.IfNull(myReaderD("COD_STATO_CATASTALE"), "") _
                                                    & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("IND"), "")) _
                                                    & "', '" & par.IfNull(myReaderD("CIVICO"), "") & "', " _
                                                    & "'" & par.IfNull(myReaderD("CAP"), "") _
                                                    & "', NULL, '" & par.IfNull(myReaderD("COD_COMUNE"), "") _
                                                    & "', 0)"
                                par.cmd.ExecuteNonQuery()


                                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.DIMENSIONI WHERE ID_UNITA_IMMOBILIARE=" & myReaderE("ID")
                                Dim myReaderF As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                Do While myReaderF.Read
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE (ID_CONTRATTO, ID_UNITA, COD_TIPOLOGIA, VALORE) VALUES (" _
                                                        & lIdContratto & "," & myReaderE("ID") & ",'" _
                                                        & par.IfNull(myReaderF("COD_TIPOLOGIA"), "") _
                                                        & "'," & par.VirgoleInPunti(par.IfNull(myReaderF("VALORE"), "NULL")) & ")"
                                    par.cmd.ExecuteNonQuery()
                                Loop
                                myReaderF.Close()
                            End If
                            myReaderD.Close()
                        Loop
                        myReaderE.Close()

                        Dim testoTabella As String = ""
                        'CARICO NUOVAMENTE LE UNITA DEL CONTRATTO
                        testoTabella = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                        & "<tr>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>COD.UNITA</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>FOGLIO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>MAPPALE</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>SUB</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>TIPO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>INDIRIZZO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>PIANO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>SCALA</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>INTERNO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "</td>" _
                        & "<td style='height: 19px'>" _
                        & "</td>" _
                        & "</tr>"


                        par.cmd.CommandText = "select TIPO_LIVELLO_PIANO.DESCRIZIONE AS ""PIANO"",unita_contrattuale.*,tipologia_unita_immobiliari.descrizione as ""tipo"" from SISCOM_MI.TIPO_LIVELLO_PIANO,siscom_mi.tipologia_unita_immobiliari,siscom_mi.unita_contrattuale where TIPO_LIVELLO_PIANO.COD=UNITA_CONTRATTUALE.COD_TIPO_LIVELLO_PIANO  AND tipologia_unita_immobiliari.cod=unita_contrattuale.tipologia and id_contratto=" & lIdContratto & " AND (ID_UNITA_PRINCIPALE IS NULL) order by tipologia asc"
                        Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        Do While myReader1.Read
                            testoTabella = testoTabella _
                                    & "<tr>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><a href='#' onclick=" & Chr(34) & "window.open('../CENSIMENTO/InserimentoUniImmob.aspx?F=" & lIdConnessione & "&X=1&LE=1&ID=" & par.IfNull(myReader1("ID_UNITA"), "") & "','Dettagli','height=580,top=0,left=0,width=780');" & Chr(34) & ">" & par.IfNull(myReader1("cod_unita_immobiliare"), "") & "</a></span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("FOGLIO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("NUMERO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SUB"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("TIPO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INDIRIZZO"), "") & "," & par.IfNull(myReader1("CIVICO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("PIANO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SCALA"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INTERNO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "</td>" _
                                    & "<td style='height: 19px'>" _
                                    & "</td>" _
                                    & "</tr>"

                        Loop
                        myReader1.Close()
                        CType(Tab_UnitaImmLocate1.FindControl("TBL_UNITA_ALLOCATE"), Label).Text = testoTabella & "</table>"

                        'CARICO PERTINENZE

                        testoTabella = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                        & "<tr>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>COD.UNITA</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>FOGLIO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>MAPPALE</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>SUB</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>TIPO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>INDIRIZZO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>PIANO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>SCALA</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>INTERNO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "</td>" _
                        & "<td style='height: 19px'>" _
                        & "</td>" _
                        & "</tr>"


                        par.cmd.CommandText = "select TIPO_LIVELLO_PIANO.DESCRIZIONE AS ""PIANO"",unita_contrattuale.*,tipologia_unita_immobiliari.descrizione as ""tipo"" from SISCOM_MI.TIPO_LIVELLO_PIANO,siscom_mi.tipologia_unita_immobiliari,siscom_mi.unita_contrattuale where TIPO_LIVELLO_PIANO.COD=UNITA_CONTRATTUALE.COD_TIPO_LIVELLO_PIANO AND tipologia_unita_immobiliari.cod=unita_contrattuale.tipologia and id_contratto=" & lIdContratto & " AND (ID_UNITA_PRINCIPALE IS NOT NULL) order by tipologia asc"
                        myReader1 = par.cmd.ExecuteReader()
                        Do While myReader1.Read
                            testoTabella = testoTabella _
                                    & "<tr>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><a href='#' onclick=" & Chr(34) & "if (document.getElementById('txtModificato').value == '1') {alert('Attenzione...Sono state apportate delle modifiche. Salvare prima di proseguire!');}else {document.getElementById('USCITA').value='1';window.open('../CENSIMENTO/InserimentoUniImmob.aspx?F=" & lIdConnessione & "&X=1&LE=1&ID=" & par.IfNull(myReader1("ID_UNITA"), "") & "','Dettagli','height=580,top=0,left=0,width=780');}" & Chr(34) & ">" & par.IfNull(myReader1("cod_unita_immobiliare"), "") & "</a></span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("FOGLIO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("NUMERO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SUB"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("TIPO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INDIRIZZO"), "") & "," & par.IfNull(myReader1("CIVICO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("PIANO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SCALA"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INTERNO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "</td>" _
                                    & "<td style='height: 19px'>" _
                                    & "</td>" _
                                    & "</tr>"
                        Loop
                        myReader1.Close()
                        CType(Tab_UnitaImmLocate1.FindControl("TBL_PERTINENZE_ALLOCATE"), Label).Text = testoTabella & "</table>"

                        'RICARICO IL CONDUTTORE NEL TAB GENERALE PERCHè POTREBBE ESSERE CAMBIATO
                        Dim Conduttore As String = ""
                        Dim Conduttore1 As String = ""

                        par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE,anagrafica.id,CASE WHEN anagrafica.ragione_sociale is not null THEN ragione_sociale  ELSE RTRIM(LTRIM(COGNOME ||' ' ||NOME)) END AS ""INTESTATARIO"" FROM SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE SOGGETTI_CONTRATTUALI.ID_CONTRATTO=" & lIdContratto & " AND (SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='INTE' OR SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='COINT') AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA ORDER BY SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE DESC"
                        myReader1 = par.cmd.ExecuteReader()
                        Do While myReader1.Read
                            'Conduttore = Conduttore & par.IfNull(myReader1("INTESTATARIO"), "") & "<br />"
                            Conduttore = Conduttore & par.IfNull(myReader1("INTESTATARIO"), "") & ", "
                            'Conduttore1 = Conduttore1 & "<a href=" & Chr(34) & "anagrafica/Inserimento.aspx?ID=" & par.IfNull(myReader1("id"), "-1") & Chr(34) & " target=" & Chr(34) & "_blank" & Chr(34) & ">" & par.IfNull(myReader1("INTESTATARIO"), "") & "</a>, "
                            'Conduttore1 = Conduttore1 & "<a href='#' onclick=" & Chr(34) & "window.open('anagrafica/Inserimento.aspx?DAC=1&ID=" & par.IfNull(myReader1("id"), "-1") & "','Anagrafe','height=500,top=0,left=0,width=500,scroll=no,status=no');" & Chr(34) & ">" & par.IfNull(myReader1("INTESTATARIO"), "") & "</a>, "

                            Conduttore1 = Conduttore1 & "<a href='#' onclick=" & Chr(34) & "document.getElementById('Generale1_hAnagrafica').value='" & par.IfNull(myReader1("id"), "-1") & "';myOpacity10.toggle();" & Chr(34) & ">" & par.IfNull(myReader1("INTESTATARIO"), "") & "</a>, "

                            If par.IfNull(myReader1("COD_TIPOLOGIA_OCCUPANTE"), "") = "INTE" Then
                                txtCodAffittuario.Value = par.IfNull(myReader1("id"), "-1")
                            End If
                        Loop
                        myReader1.Close()

                        If Len(Conduttore) > 40 Then
                            CType(Generale1.FindControl("lblConduttore"), Label).Font.Size = 8
                        End If
                        CType(Generale1.FindControl("lblConduttore"), Label).Text = Conduttore1
                        txtconduttore.Value = Replace(Conduttore, "<br />", ", ")

                        'Dim LL As Integer = 0
                        ''CARICAMENTO schema bollette
                        'CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items.Clear()

                        'CType(Tab_SchemaBollette1.FindControl("Label4"), Label).Text = "SCHEMA VOCI BOLLETTA" & " " & sAnnoSchema & "  -  <a href='SchemaAltriAnni.aspx?CN=" & lIdConnessione & "&A=" & sAnnoSchema & "' target='_blank'>Clicca qui per visualizzare lo schema di altri anni</a>"
                        'par.cmd.CommandText = "select bol_schema.*,t_voci_bolletta.descrizione from siscom_mi.t_voci_bolletta, siscom_mi.bol_schema where t_voci_bolletta.id=bol_schema.id_voce and bol_schema.id_contratto=" & lIdContratto & " and anno=" & sAnnoSchema & " order by t_voci_bolletta.descrizione asc"
                        'myReader2 = par.cmd.ExecuteReader()
                        'Do While myReader2.Read
                        '    CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("descrizione"), ""), 50) & " " & par.MiaFormat(par.IfNull(myReader2("importo_singola_rata"), ""), 15) & " " & par.MiaFormat(par.IfNull(myReader2("da_rata"), ""), 10) & " " & par.MiaFormat(par.IfNull(myReader2("per_rate"), ""), 10), myReader2("ID")))
                        '    If LL Mod 2 <> 0 Then
                        '        CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items(LL).Attributes.CssStyle.Add("background-color", "#dcdada")
                        '    Else
                        '        CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items(LL).Attributes.CssStyle.Add("background-color", "white")
                        '    End If
                        '    LL = LL + 1
                        'Loop
                        'myReader2.Close()




                    End If

                    par.cmd.CommandText = "select fl_stampato from siscom_mi.rapporti_utenza where id=" & lIdContratto
                    Dim myReader210 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader210.Read Then
                        If par.IfNull(myReader210("fl_stampato"), "0") = "0" Then
                            Tab_Contratto1.Abilita()
                            CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).ReadOnly = False
                            CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).ReadOnly = False
                            CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).ReadOnly = False
                            'max 18/07/2019
                            CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).ReadOnly = False
                            '---
                            CType(Tab_Contratto1.FindControl("txtEntroCuiDisdettare"), TextBox).ReadOnly = False
                            CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).ReadOnly = False
                            CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).ReadOnly = False
                            CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).ReadOnly = False
                            CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).ReadOnly = False


                            Tab_Canone1.Attiva()
                            'Tab_Conduttore1.Disabilita_Tutto()
                        Else
                            Tab_Contratto1.Disabilita()
                            CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).ReadOnly = True
                            ''max 18/07/2019
                            'CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).ReadOnly = True
                            ''---
                            CType(Tab_Contratto1.FindControl("txtEntroCuiDisdettare"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).ReadOnly = True
                            CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).ReadOnly = False
                            Tab_Registrazione1.Disabilita()
                            Tab_Canone1.disattiva()
                            If SolaLettura = "0" And TipoContratto = "7" And CType(Generale1.FindControl("lblStato"), Label).Text = "BOZZA" Then
                                Tab_Conduttore1.Disabilita_Tutto_Tranne_Comp()
                            Else
                                Tab_Conduttore1.Disabilita_Tutto()
                            End If

                        End If
                    End If
                    myReader210.Close()






                    If txtModificato.Value = "1" Then
                        If eventomodificadati.Value = "0" Then
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                                            & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                                            & "'F02','')"
                            par.cmd.ExecuteNonQuery()
                        End If
                        eventomodificadati.Value = "0"
                    End If




                    If CaricaSpese(True) = True Then
                        speseunita.Value = "0"
                    Else
                        speseunita.Value = "1"
                    End If

                End If


                If CType(Generale1.FindControl("lblStato"), Label).Text = "CHIUSO" Or CType(Generale1.FindControl("lblStato"), Label).Text = "IN CORSO" Or CType(Generale1.FindControl("lblStato"), Label).Text = "IN ATTESA" Or CType(Generale1.FindControl("lblStato"), Label).Text = "IN CORSO (S.T.)" Then

                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & lIdContratto
                    Dim myReaderax As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderax.Read Then
                        CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text = Format(par.IfNull(myReaderax("imp_canone_iniziale"), 0), "0.00")

                    End If
                    myReaderax.Close()



                    If TipoContratto = "12" Or TipoContratto = "11" Or TipoContratto = "10" Or TipoContratto = "1" Or TipoContratto = "2" Or TipoContratto = "3" Or TipoContratto = "5" Or TipoContratto = "6" Or TipoContratto = "7" Then
                        'If Session.Item("dataRicons") <> "" Then
                        '    dataRiconsegna = Session.Item("dataRicons")
                        'Else
                        dataRiconsegna = par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text)

                        'DATI CONTRATTO
                        par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET " _
                                            & "" _
                                            & "" _
                                            & "DATA_DECORRENZA_AE='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Text) _
                                            & "',motivo_rec_forzoso=" & CType(Tab_Contratto1.FindControl("cmbForzoso"), DropDownList).SelectedItem.Value _
                                            & ",MITTENTE_disdetta=" & CType(Tab_Contratto1.FindControl("cmbMittenteDisdetta"), DropDownList).SelectedItem.Value _
                                            & ", DATA_SCADENZA='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text) _
                                            & "',DATA_DISDETTA_LOCATARIO='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text) _
                                            & "',DATA_notifica_disdetta='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtNotificaDisdetta"), TextBox).Text) _
                                            & "',DATA_INVIO_RIC_DISDETTA='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDisdetta0"), TextBox).Text) _
                                            & "',NUM_REGISTRAZIONE='" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtNumRegistrazione"), TextBox).Text) _
                                            & "',SERIE_REGISTRAZIONE='" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtSerie"), TextBox).Text) _
                                            & "'" _
                                            & "" _
                                            & ",DATA_REG='" & par.AggiustaData(CType(Tab_Registrazione1.FindControl("txtDataRegistrazione"), TextBox).Text) _
                                            & "',COD_UFFICIO_REG='" & CType(Tab_Registrazione1.FindControl("cmbUfficioRegistro"), DropDownList).SelectedValue _
                                            & "'" _
                                            & "" _
                                            & ",DATA_SCADENZA_RINNOVO='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Text) _
                                            & "',MESI_DISDETTA=" & par.IfEmpty(CType(Tab_Contratto1.FindControl("txtEntroCuiDisdettare"), TextBox).Text, "NULL") _
                                            & ",DATA_RICONSEGNA='" & dataRiconsegna _
                                            & "',DELIBERA='" & par.PulisciStrSql(CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Text) _
                                            & "',DATA_DELIBERA='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text) _
                                            & "',data_trasm_delibera='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).Text) _
                                            & "'" _
                                            & "" _
                                            & ",TIPO_COR='" & Trim(par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("cmbTipoViaCor"), DropDownList).SelectedItem.Text)) _
                                            & "',LUOGO_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text) _
                                            & "',VIA_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtViaCor"), TextBox).Text) _
                                            & "',NOTE_COR=''" _
                                            & ",CIVICO_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtCivicoCor"), TextBox).Text) _
                                            & "',SIGLA_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtSiglaCor"), TextBox).Text) _
                                            & "',CAP_COR='" & CType(Tab_Comunicazioni1.FindControl("txtCAPCOR"), TextBox).Text _
                                            & "',PRESSO_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtPresso"), TextBox).Text) _
                                            & "',MAIL_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtMailCor"), TextBox).Text) _
                                            & "',MAIL_PEC_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtPECCor"), TextBox).Text) _
                                            & "',NRO_REPERTORIO='" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtNumRepertorio"), TextBox).Text) _
                                            & "',DATA_REPERTORIO='" & par.AggiustaData(CType(Tab_Registrazione1.FindControl("txtDataRepertorio"), TextBox).Text) _
                                            & "',NRO_ASSEGNAZIONE_PG='" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Text) _
                                            & "',DATA_ASSEGNAZIONE_PG='" & par.AggiustaData(CType(Tab_Registrazione1.FindControl("txtDataAssegnPG"), TextBox).Text) _
                                            & "',LIBRETTO_DEPOSITO='" & par.PulisciStrSql(CType(Tab_Canone1.FindControl("txtLibrettoDeposito"), TextBox).Text) _
                                            & "',ID_DEST_RATE=" & CType(Tab_Canone1.FindControl("cmbDestRate"), DropDownList).SelectedValue _
                                            & ",INVIO_BOLLETTA='" & Valore01(CType(Tab_Canone1.FindControl("checkInvioBoll"), CheckBox).Checked) _
                                            & "',FL_CONGUAGLIO='" & Valore01(CType(Tab_Canone1.FindControl("checkConguaglioBoll"), CheckBox).Checked) _
                                            & "'" _
                                            & ",INTERESSI_CAUZIONE='" & Valore01(CType(Tab_Canone1.FindControl("checkInteressiCauzione"), CheckBox).Checked) _
                                            & "',INTERESSI_RIT_PAG='" & Valore01(CType(Tab_Canone1.FindControl("checkInteressiCauzione"), CheckBox).Checked) _
                                            & "',NOTE='" _
                                            & "',FREQ_VAR_ISTAT ='" & CType(Tab_Canone1.FindControl("lblistat2"), DropDownList).SelectedItem.Value _
                                            & "',PERC_ISTAT =" & CType(Tab_Canone1.FindControl("lblistat4"), DropDownList).SelectedItem.Value _
                                            & ",ID_COMMISSARIATO=" & CType(Tab_Comunicazioni1.FindControl("cmbCommissariato"), DropDownList).SelectedItem.Value _
                                            & ",FL_ASSEGN_TEMP='" & Valore01(CType(Tab_Contratto1.FindControl("chkTemporanea"), CheckBox).Checked) _
                                            & "',FL_TUTORE_STR=" & Valore01(CType(Tab_Contratto1.FindControl("ChTutore"), CheckBox).Checked) _
                                            & ",SINDACATO=" & SINDACATO _
                                            & ",NOTE_REGISTRAZIONE='" & par.PulisciStrSql(CType(Tab_Registrazione1.FindControl("txtNotereg"), TextBox).Text) _
                                            & "',SCALA_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtScalaCor"), TextBox).Text) _
                                            & "',PIANO_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtPianoCor"), TextBox).Text) _
                                            & "',INTERNO_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtInternoCor"), TextBox).Text) & "'" _
                                            & ",ID_ORIGINE_CONTRATTO=" & par.insDbValue(CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedValue, False, False, True) _
                                            & ",FL_IRREPERIBILE=" & Valore01(CType(Tab_Comunicazioni1.FindControl("chkIrreperibile"), CheckBox).Checked) _
                                            & " WHERE ID=" & lIdContratto
                        par.cmd.ExecuteNonQuery()

                        If txtModificato.Value = "1" Then
                            If eventomodificadati.Value = "0" Then
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                                                                           & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                                                                           & "'F02','')"
                                par.cmd.ExecuteNonQuery()
                            End If
                            eventomodificadati.Value = "0"
                        End If

                        If CType(Tab_Contratto1.FindControl("cmbNomeUfficiale"), DropDownList).SelectedValue = "NONE" Then
                            If Session.Item("RU_GESTIONE_OA") = "1" Then
                            SalvaOccupanteAbusivo()
                        End If
                        End If



                        'GESTIONE OSPITI

                        'par.cmd.CommandText = "DELETE FROM SISCOM_MI.OSPITI WHERE ID_CONTRATTO=" & lIdContratto
                        'par.cmd.ExecuteNonQuery()

                        '                        For I = 0 To CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Count - 1

                        '                            par.cmd.CommandText = "Insert into SISCOM_MI.ospiti (ID, ID_CONTRATTO, DATA_AGG, " _
                        '                                               & "DATA_INIZIO_OSPITE, DATA_FINE_OSPITE, NOMINATIVO, COD_FISCALE) " _
                        '                                               & "Values " _
                        '                                               & "(SISCOM_MI.SEQ_OSPITI.NEXTVAL," & lIdContratto & " , '" & Format(Now, "yyyyMMdd") _
                        '                                               & "', '" & par.AggiustaData(par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items(I).Text, 49, 15)) _
                        '                                               & "', '" & par.AggiustaData(par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items(I).Text, 65, 15)) _
                        '                                               & "','" & par.PulisciStrSql(par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items(I).Text, 1, 30)) _
                        '                                               & "','" & par.PulisciStrSql(par.RicavaTesto(CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items(I).Text, 32, 16)) _
                        '                                               & "')"
                        '                            par.cmd.ExecuteNonQuery()

                        '                        Next I

                        If disdettato.Value = "1" Then
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                            & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                            & "'F179','" & CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text & "')"
                            par.cmd.ExecuteNonQuery()

                            ''INSERIMENTO AVVISO PER CONDOMINI
                            ''par.cmd.CommandText = "SELECT cond_edifici.* FROM SISCOM_MI.COND_EDIFICI,SISCOM_MI.EDIFICI,SISCOM_MI.UNITA_IMMOBILIARI WHERE UNITA_IMMOBILIARI.ID=" & UnitaContratto & " AND EDIFICI.ID=UNITA_IMMOBILIARI.ID_EDIFICIO AND COND_EDIFICI.ID_EDIFICIO=EDIFICI.ID"
                            ''Dim myReader234 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            ''If myReader234.Read Then
                            'par.cmd.CommandText = "INSERT INTO SISCOM_MI.COND_AVVISI (ID_UI,EVENTO,DATA,VISTO) VALUES (" & UnitaContratto & ",'INSERIMENTO DISDETTA RAPPORTO (" & CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text & ")','" & Format(Now, "yyyyMMdd") & "',0)"
                            'par.cmd.ExecuteNonQuery()
                            ''End If
                            ''myReader234.Close()
                            disdettato.Value = "0"
                        End If


                        '************ SE CAMBIA IL CONDUTTORE (SUBENTRO) DEVO AGGIORNARE IL TAB GENERALE (M.Teresa)**********
                        Dim Conduttore As String = ""
                        par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE,anagrafica.id,CASE WHEN anagrafica.ragione_sociale is not null THEN ragione_sociale  ELSE RTRIM(LTRIM(COGNOME ||' ' ||NOME)) END AS ""INTESTATARIO"" FROM SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE SOGGETTI_CONTRATTUALI.ID_CONTRATTO=" & lIdContratto & " AND (SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='INTE' OR SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='COINT') AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA ORDER BY SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE DESC"
                        Dim myReaderCond As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        Dim conduttore1 As String = ""

                        Do While myReaderCond.Read

                            Conduttore = Conduttore & par.IfNull(myReaderCond("INTESTATARIO"), "") & ", "
                            'Conduttore1 = Conduttore1 & "<a href=" & Chr(34) & "anagrafica/Inserimento.aspx?ID=" & par.IfNull(myReader1("id"), "-1") & Chr(34) & " target=" & Chr(34) & "_blank" & Chr(34) & ">" & par.IfNull(myReader1("INTESTATARIO"), "") & "</a>, "
                            'conduttore1 = conduttore1 & "<a href='#' onclick=" & Chr(34) & "window.open('anagrafica/Inserimento.aspx?DAC=1&ID=" & par.IfNull(myReader1("id"), "-1") & "','Anagrafe','height=450,top=0,left=0,width=500,scroll=no,status=no');" & Chr(34) & ">" & par.IfNull(myReader1("INTESTATARIO"), "") & "</a>, "
                            conduttore1 = conduttore1 & "<a href='#' onclick=" & Chr(34) & "document.getElementById('Generale1_hAnagrafica').value='" & par.IfNull(myReaderCond("id"), "-1") & "';myOpacity10.toggle();" & Chr(34) & ">" & par.IfNull(myReaderCond("INTESTATARIO"), "") & "</a>, "
                            If par.IfNull(myReaderCond("COD_TIPOLOGIA_OCCUPANTE"), "") = "INTE" Then
                                txtCodAffittuario.Value = par.IfNull(myReaderCond("id"), "-1")
                            End If
                        Loop
                        myReaderCond.Close()

                        '09/05/2012 IN SEGUITO A VAIN RICARICO PER VISUALIZZARE L'INTESTATARIO PRECEDENTE
                        Dim ExConduttore As String = ""
                        par.cmd.CommandText = "SELECT anagrafica.id,CASE WHEN anagrafica.ragione_sociale is not null THEN ragione_sociale  ELSE RTRIM(LTRIM(COGNOME ||' ' ||NOME)) END AS ""INTESTATARIO"",SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE FROM SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE SOGGETTI_CONTRATTUALI.ID_CONTRATTO=" & lIdContratto & " AND SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='EXINTE' AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA ORDER BY SOGGETTI_CONTRATTUALI.DATA_INIZIO DESC"
                        myReaderCond = par.cmd.ExecuteReader
                        If myReaderCond.Read Then
                            ExConduttore = par.IfNull(myReaderCond("INTESTATARIO"), "")
                            par.cmd.CommandText = "select count(*) from siscom_mi.rapporti_utenza where id=" & lIdContratto & " and  cod_tipologia_contr_loc='USD' AND dest_uso='N'"
                            Dim ris As Integer = par.IfNull(par.cmd.ExecuteScalar, 0)
                            If ris = 0 Then
                                CType(Tab_Canone1.FindControl("HLink_SchedaDep"), HyperLink).Attributes.Add("onClick", "javascript:document.getElementById('USCITA').value='1';window.open('DepositoCauzionale.aspx?IDC=" & lIdContratto & "', 'DepCauz','height=600,width=800,top=0,left=0');")
                            Else
                                CType(Tab_Canone1.FindControl("HLink_SchedaDep"), HyperLink).Attributes.Add("onClick", "javascript:document.getElementById('USCITA').value='1';window.open('DepositoCauzionaleInte.aspx?IDC=" & lIdContratto & "', 'DepCauz','height=600,width=800,top=0,left=0');")
                            End If
                        Else
                            ExConduttore = "---"
                            par.cmd.CommandText = "select count(*) from siscom_mi.rapporti_utenza where id=" & lIdContratto & " and  cod_tipologia_contr_loc='USD' AND dest_uso='N'"
                            Dim ris As Integer = par.IfNull(par.cmd.ExecuteScalar, 0)
                            If ris = 0 Then
                                CType(Tab_Canone1.FindControl("HLink_SchedaDep"), HyperLink).Attributes.Add("onClick", "javascript:document.getElementById('USCITA').value='1';window.open('DepositoCauzionale.aspx?IDC=" & lIdContratto & "&IDI=" & txtCodAffittuario.Value & "', 'DepCauzInte','height=600,width=800,top=0,left=0');")
                            Else
                                CType(Tab_Canone1.FindControl("HLink_SchedaDep"), HyperLink).Attributes.Add("onClick", "javascript:document.getElementById('USCITA').value='1';window.open('DepositoCauzionaleUSD.aspx?IDC=" & lIdContratto & "&IDI=" & txtCodAffittuario.Value & "', 'DepCauzInte','height=600,width=800,top=0,left=0');")
                            End If
                        End If
                        myReaderCond.Close()

                        If Len(ExConduttore) >= 30 Then
                            CType(Generale1.FindControl("lblExcondutt"), Label).Font.Size = 7
                        End If
                        CType(Generale1.FindControl("lblExcondutt"), Label).Text = ExConduttore
                        '09/05/2012 fine IN SEGUITO A VAIN RICARICO PER VISUALIZZARE L'INTESTATARIO PRECEDENTE


                        If Len(Conduttore) > 40 Then
                            CType(Generale1.FindControl("lblConduttore"), Label).Font.Size = 8
                        End If
                        CType(Generale1.FindControl("lblConduttore"), Label).Text = conduttore1
                        txtconduttore.Value = Replace(Conduttore, "<br />", ", ")

                        '************ FINE AGGIORNAMENTO DEL TAB GENERALE (M.Teresa) 04/01/2012 **********

                        'CARICAMENTO OSPITI
                        CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Clear()

                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.OSPITI WHERE ID_CONTRATTO=" & lIdContratto & " ORDER BY DATA_AGG DESC"
                        Dim myReader2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        Do While myReader2.Read
                            'CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Add(New ListItem(par.MiaFormat(Format(myReader2("NRO_OSPITI"), "00"), 2) & " " & par.MiaFormat(par.FormattaData(myReader2("DATA_INIZIO_OSPITE")), 15) & " " & par.FormattaData(myReader2("DATA_FINE_OSPITE")), myReader2("ID")))
                            CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("nominativo"), ""), 30) & " " & par.MiaFormat(par.IfNull(myReader2("cod_fiscale"), ""), 16) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio_ospite"), "")), 15) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_fine_ospite"), "")), 15), myReader2("ID")))

                        Loop
                        myReader2.Close()


                        Dim testoTabella As String = ""
                        'CARICO NUOVAMENTE LE UNITA DEL CONTRATTO
                        testoTabella = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                        & "<tr>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>COD.UNITA</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>FOGLIO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>MAPPALE</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>SUB</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>TIPO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>INDIRIZZO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>PIANO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>SCALA</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>INTERNO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "</td>" _
                        & "<td style='height: 19px'>" _
                        & "</td>" _
                        & "</tr>"


                        par.cmd.CommandText = "select TIPO_LIVELLO_PIANO.DESCRIZIONE AS ""PIANO"",unita_contrattuale.*,tipologia_unita_immobiliari.descrizione as ""tipo"" from SISCOM_MI.TIPO_LIVELLO_PIANO,siscom_mi.tipologia_unita_immobiliari,siscom_mi.unita_contrattuale where TIPO_LIVELLO_PIANO.COD=UNITA_CONTRATTUALE.COD_TIPO_LIVELLO_PIANO  AND tipologia_unita_immobiliari.cod=unita_contrattuale.tipologia and id_contratto=" & lIdContratto & " AND (ID_UNITA_PRINCIPALE IS NULL) order by tipologia asc"
                        Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        Do While myReader1.Read
                            testoTabella = testoTabella _
                                    & "<tr>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><a href='#' onclick=" & Chr(34) & "if (document.getElementById('txtModificato').value == '1') {alert('Attenzione...Sono state apportate delle modifiche. Salvare prima di proseguire!');}else {document.getElementById('USCITA').value='1';window.open('../CENSIMENTO/InserimentoUniImmob.aspx?F=" & lIdConnessione & "&X=1&LE=1&ID=" & par.IfNull(myReader1("ID_UNITA"), "") & "','Dettagli','height=580,top=0,left=0,width=780');}" & Chr(34) & ">" & par.IfNull(myReader1("cod_unita_immobiliare"), "") & "</a></span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("FOGLIO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("NUMERO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SUB"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("TIPO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INDIRIZZO"), "") & "," & par.IfNull(myReader1("CIVICO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("PIANO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SCALA"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INTERNO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "</td>" _
                                    & "<td style='height: 19px'>" _
                                    & "</td>" _
                                    & "</tr>"

                        Loop
                        myReader1.Close()
                        CType(Tab_UnitaImmLocate1.FindControl("TBL_UNITA_ALLOCATE"), Label).Text = testoTabella & "</table>"

                        'CARICO PERTINENZE

                        testoTabella = "<table cellpadding='0' cellspacing='0' width='100%'>" & vbCrLf _
                        & "<tr>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>COD.UNITA</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>FOGLIO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>MAPPALE</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>SUB</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>TIPO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>INDIRIZZO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>PIANO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>SCALA</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "<span style='font-size: 8pt; font-family: Arial'><strong>INTERNO</strong></span></td>" _
                        & "<td style='height: 19px'>" _
                        & "</td>" _
                        & "<td style='height: 19px'>" _
                        & "</td>" _
                        & "</tr>"


                        par.cmd.CommandText = "select TIPO_LIVELLO_PIANO.DESCRIZIONE AS ""PIANO"",unita_contrattuale.*,tipologia_unita_immobiliari.descrizione as ""tipo"" from SISCOM_MI.TIPO_LIVELLO_PIANO,siscom_mi.tipologia_unita_immobiliari,siscom_mi.unita_contrattuale where TIPO_LIVELLO_PIANO.COD=UNITA_CONTRATTUALE.COD_TIPO_LIVELLO_PIANO AND tipologia_unita_immobiliari.cod=unita_contrattuale.tipologia and id_contratto=" & lIdContratto & " AND (ID_UNITA_PRINCIPALE IS NOT NULL) order by tipologia asc"
                        myReader1 = par.cmd.ExecuteReader()
                        Do While myReader1.Read
                            testoTabella = testoTabella _
                                    & "<tr>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'><a href='#' onclick=" & Chr(34) & "if (document.getElementById('txtModificato').value == '1') {alert('Attenzione...Sono state apportate delle modifiche. Salvare prima di proseguire!');}else {document.getElementById('USCITA').value='1';window.open('../CENSIMENTO/InserimentoUniImmob.aspx?F=" & lIdConnessione & "&X=1&LE=1&ID=" & par.IfNull(myReader1("ID_UNITA"), "") & "','Dettagli','height=580,top=0,left=0,width=780');}" & Chr(34) & ">" & par.IfNull(myReader1("cod_unita_immobiliare"), "") & "</a></span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("FOGLIO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("NUMERO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SUB"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("TIPO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INDIRIZZO"), "") & "," & par.IfNull(myReader1("CIVICO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("PIANO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("SCALA"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "<span style='font-size: 8pt; font-family: Arial'>" & par.IfNull(myReader1("INTERNO"), "") & "</span></td>" _
                                    & "<td style='height: 19px'>" _
                                    & "</td>" _
                                    & "<td style='height: 19px'>" _
                                    & "</td>" _
                                    & "</tr>"
                        Loop
                        myReader1.Close()
                        CType(Tab_UnitaImmLocate1.FindControl("TBL_PERTINENZE_ALLOCATE"), Label).Text = testoTabella & "</table>"


                        'CaricaSchemaBolletta(lIdContratto)
                        CaricaSchemaBoll()
                        'Dim LL As Integer = 0
                        ''CARICAMENTO schema bollette
                        'CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items.Clear()

                        'CType(Tab_SchemaBollette1.FindControl("Label4"), Label).Text = "SCHEMA VOCI BOLLETTA" & " " & sAnnoSchema & "  -  <a href='SchemaAltriAnni.aspx?CN=" & lIdConnessione & "&A=" & sAnnoSchema & "' target='_blank'>Clicca qui per visualizzare lo schema di altri anni</a>"
                        'par.cmd.CommandText = "select bol_schema.*,t_voci_bolletta.descrizione from siscom_mi.t_voci_bolletta, siscom_mi.bol_schema where t_voci_bolletta.id=bol_schema.id_voce and bol_schema.id_contratto=" & lIdContratto & " and anno=" & sAnnoSchema & " order by t_voci_bolletta.descrizione asc"
                        'myReader2 = par.cmd.ExecuteReader()
                        'Do While myReader2.Read
                        '    CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("descrizione"), ""), 50) & " " & par.MiaFormat(par.IfNull(myReader2("importo_singola_rata"), ""), 15) & " " & par.MiaFormat(par.IfNull(myReader2("da_rata"), ""), 10) & " " & par.MiaFormat(par.IfNull(myReader2("per_rate"), ""), 10), myReader2("ID")))
                        '    If LL Mod 2 <> 0 Then
                        '        CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items(LL).Attributes.CssStyle.Add("background-color", "#dcdada")
                        '    Else
                        '        CType(Tab_SchemaBollette1.FindControl("lstSchemaBollette"), ListBox).Items(LL).Attributes.CssStyle.Add("background-color", "white")
                        '    End If
                        '    LL = LL + 1
                        'Loop
                        'myReader2.Close()
                    End If
                End If
            End If

            CType(Generale1.FindControl("lblDecorrenza"), Label).Text = CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text
            CType(Generale1.FindControl("lblScadenza"), Label).Text = CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text

            FL_NuovoContratto = "0"



            par.cmd.CommandText = "select SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID) AS STATO,rapporti_utenza.* FROM SISCOM_MI.RAPPORTI_UTENZA where id=" & lIdContratto
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                CType(Generale1.FindControl("lblStato"), Label).Text = par.IfNull(myReader("STATO"), "")
                HStatoContratto.Value = par.IfNull(myReader("STATO"), "")
                LBLSTATOC.Visible = True
                LBLSTATOC.Text = "Stato: " & UCase(par.IfNull(myReader("STATO"), ""))
                CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text = Format(par.IfNull(myReader("imp_canone_iniziale"), 0), "0.00")
                CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text = Format(par.IfNull(myReader("imp_DEPOSITO_CAUZ"), 0), "0.00")
                CType(Tab_Contratto1.FindControl("txtDataDecAE"), TextBox).Text = par.FormattaData(par.IfNull(myReader("data_decorrenza_AE"), ""))

                If SolaLettura = "0" And HStatoContratto.Value = "IN CORSO" Then
                    If par.IfNull(myReader("DATA_DECORRENZA"), "") = par.IfNull(myReader("DATA_DECORRENZA_AE"), "") Then
                        btnStampaContratto.Visible = False
                    Else
                        btnStampaContratto.Visible = True

                        '*************** 08/01/2018 - Segnalazione n.2180/20147 ***************
                        CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).ReadOnly = False
                        CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).ReadOnly = False
                        CType(Tab_Registrazione1.FindControl("cmbTipoPosizione"), DropDownList).SelectedValue = 5
                        CType(Tab_Registrazione1.FindControl("cmbModoPagamento"), DropDownList).SelectedValue = 0
                    End If
                End If
            End If
            myReader.Close()

            If txtConguaglio.Value = "1" Then
                If CType(Tab_Canone1.FindControl("checkConguaglioBoll"), CheckBox).Checked = True Then
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                        & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                        & "'F13','IL FLAG ORA è ATTIVATO')"
                Else
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                    & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                    & "'F13','IL FLAG ORA è DISATTIVATO')"
                End If
                par.cmd.ExecuteNonQuery()
                txtConguaglio.Value = "0"
            End If


            If txtInvioBollette.Value = "1" Then
                If CType(Tab_Canone1.FindControl("checkInvioBoll"), CheckBox).Checked = True Then
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                        & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                        & "'F14','IL FLAG ORA è ATTIVATO')"
                Else
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                    & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                    & "'F14','IL FLAG ORA è DISATTIVATO')"
                End If
                par.cmd.ExecuteNonQuery()
                txtInvioBollette.Value = "0"
            End If

            Generale1.Provenienza = TipoContratto
            Generale1.IndiceDichiarazione = lIdDichiarazione
            Generale1.IndiceDomanda = lIdDomandaERP
            Generale1.IndiceAnagrafe = lIdAU
            txtModificato.Value = "0"



            'MAX 17/07/2015
            par.CaricaStoricoNote(lIdContratto, CType(Tab_Contratto1.FindControl("DataGridNote"), DataGrid), "1")


            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"

            VisualizzaPreventivo()

            Dim StringaTabella As String = ""
            Dim adISTAT As Double = 0
            Dim BOLLO_BOLLETTA As Double = 0
            Dim SPESEPOSTALI As Double = 0

            Dim AI As Double = 0
            Dim SPMAV As Double = 0
            Dim AltriAD As Double = 0

            Dim Dett1 As String = "0,00"
            Dim Dett2 As String = "0,00"
            Dim Dett3 As String = "0,00"
            Dim Dett4 As Double = 0
            Dim dettagli As String = "<table cellpadding='0' cellspacing='0' style='width:100%;font-family: arial; font-size: 8pt;'>"

            AI = (CDbl(par.PuntiInVirgole(CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text)) / CDbl(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedItem.Value))

            Dett3 = "<tr><td>CANONE/INDENNITA</td><td align='right'>" & CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text & "</td></tr>"

            Dett4 = Dett4 + CDbl(par.PuntiInVirgole(CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text))

            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo=2 and ID_CONTRATTO=" & lIdContratto
            Dim myReaderA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                adISTAT = (CDbl(par.PuntiInVirgole(par.IfNull(myReaderA(0), 0))) / CDbl(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedItem.Value))
                Dett4 = Dett4 + CDbl(par.PuntiInVirgole(par.IfNull(myReaderA(0), 0)))
                Dett1 = "<tr><td>MONTANTE/ADEG. ISTAT</td><td align='right'>" & Format(par.IfNull(myReaderA(0), 0), "0.00") & "</td></tr>"
            End If
            myReaderA.Close()

            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo<>2 and ID_CONTRATTO=" & lIdContratto
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                AltriAD = (CDbl(par.PuntiInVirgole(par.IfNull(myReaderA(0), 0))) / CDbl(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedItem.Value))
                Dett4 = Dett4 + CDbl(par.PuntiInVirgole(par.IfNull(myReaderA(0), 0)))
                Dett2 = "<tr><td>ADEGUAMENTO CANONE/IND.</td><td align='right'>" & Format(par.IfNull(myReaderA(0), 0), "0.00") & "</td></tr>"

            End If
            myReaderA.Close()

            CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Text = Format(CDbl(par.PuntiInVirgole(CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text)) + adISTAT + AltriAD, "0.00")

            StringaTabella = "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">CANONE/INDENNITA</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(AI, "0.00") & "</td></tr>"
            If adISTAT <> 0 Then
                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">MONTANTE/ADEG. ISTAT</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(adISTAT, "0.00") & "</td></tr>"
            End If

            If AltriAD <> 0 Then
                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">ADEG. CANONE/IND.</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(AltriAD, "0.00") & "</td></tr>"
            End If

            CType(Tab_Canone1.FindControl("Label9"), Label).Text = dettagli & Dett3 & Dett1 & Dett2 & "<tr><td>TOTALE</td><td align='right'>" & Format(Dett4, "0.00") & "</td></tr></table>"
            CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Attributes.Add("onmouseover", "javascript:VisualizzaDettagliCanone();")
            CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Attributes.Add("onmouseout", "javascript:NascondiDettagliCanone();")

            par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=0"
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                BOLLO_BOLLETTA = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
            End If
            myReaderA.Close()

            par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=17"
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                SPESEPOSTALI = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
            End If
            myReaderA.Close()

            If BOLLO_BOLLETTA > 0 Then
                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">BOLLO</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(BOLLO_BOLLETTA, "0.00") & "</td></tr>"

            End If

            If SPESEPOSTALI > 0 Then
                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">SPESE POSTALI</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESEPOSTALI, "0.00") & "</td></tr>"
            End If

            par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=26"
            myReaderA = par.cmd.ExecuteReader()
            If myReaderA.Read Then
                SPMAV = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">SPESE MAV</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPMAV, "0.00") & "</td></tr>"
            End If
            myReaderA.Close()

            VisNuovoContratto.Value = "0"
            CType(Tab_SchemaBollette1.FindControl("img_EliminaOspite"), ImageButton).Visible = True
            CType(Tab_SchemaBollette1.FindControl("lblVociAutomatiche"), Label).Text = "<table><tr><td style=" & Chr(34) & "font-family: Arial; font-size: 9px; font-weight: bold" & Chr(34) & ">OLTRE LE VOCI SOPRA INDICATE, SARANNO AUTOMATICAMENTE INSERITE IN BOLLETTA</td><td></td></tr>" & StringaTabella & "</table>"



            'CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items.Clear()

            'Dim num_bolletta As String = ""
            'Dim importobolletta As Double = 0
            'Dim importopagato As Double = 0
            'I = 0

            'par.cmd.CommandText = "select TIPO_BOLLETTE.ACRONIMO,bol_bollette.* from SISCOM_MI.TIPO_BOLLETTE,siscom_mi.bol_bollette where BOL_BOLLETTE.ID_TIPO=TIPO_BOLLETTE.ID (+) AND bol_bollette.id_unita=" & UnitaContratto & " AND bol_bollette.id_contratto=" & lIdContratto & " order by bol_bollette.data_emissione desc,BOL_BOLLETTE.ANNO DESC,BOL_BOLLETTE.N_RATA DESC,bol_bollette.id desc"
            'Dim myReader22 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            'Do While myReader22.Read
            '    Select Case par.IfNull(myReader22("n_rata"), "")
            '        Case "99" 'bolletta manuale
            '            num_bolletta = "MA"
            '        Case "999" 'bolletta automatica
            '            num_bolletta = "AU"
            '        Case "99999" 'bolletta di conguaglio
            '            num_bolletta = "CO"
            '        Case Else
            '            num_bolletta = Format(par.IfNull(myReader22("n_rata"), "??"), "00")
            '    End Select

            '    importobolletta = par.IfNull(myReader22("IMPORTO_TOTALE"), "0,00")
            '    importopagato = par.IfNull(myReader22("IMPORTO_PAGATO"), "0,00")


            '    Dim STATO As String = ""
            '    If par.IfNull(myReader22("FL_ANNULLATA"), "0") <> "0" Then
            '        STATO = "ANNUL."
            '    Else
            '        STATO = "VALIDA"
            '    End If

            '    If par.IfNull(myReader22("id_bolletta_ric"), "0") <> "0" Or par.IfNull(myReader22("ID_RATEIZZAZIONE"), "0") <> "0" Then
            '        STATO = "RICLA."
            '    End If

            '    CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items.Add(New ListItem(par.MiaFormat(num_bolletta, 2) & " " & par.MiaFormat(STATO, 7) & " " & par.IfNull(myReader22("ACRONIMO"), "---") & "   " & par.MiaFormat(par.FormattaData(par.IfNull(myReader22("riferimento_da"), "")), 12) & "   " & par.MiaFormat(par.FormattaData(par.IfNull(myReader22("riferimento_a"), "")), 12) & " " & par.MiaFormat(Format(importobolletta, "##,##0.00"), 10) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader22("data_emissione"), "")), 12) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader22("data_scadenza"), "")), 12) & " " & par.MiaFormat(Format(importopagato, "##,##0.00"), 10) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader22("data_pagamento"), "")), 12) & " " & par.MiaFormat(par.IfNull(myReader22("note"), ""), 35) & " ", myReader22("ID")))

            '    If I Mod 2 <> 0 Then
            '        CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "#dcdada")
            '    Else
            '        CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "white")
            '    End If

            '    Select Case par.IfNull(myReader22("ID_TIPO"), "0")
            '        Case "3"
            '            CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "yellow")
            '        Case "4"
            '            CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "yellow")
            '    End Select


            '    I = I + 1
            'Loop
            'myReader22.Close()

            'CARICO TAB BOLLETTE
            CaricaTabBollette()
            CaricaGestionale()
            CType(Tab_SchemaBollette1.FindControl("Label4"), Label).Text = "SCHEMA VOCI BOLLETTA" & " " & sAnnoSchema & "  -  <a href='SchemaAltriAnni.aspx?CN=" & lIdConnessione & "&ID=" & lIdContratto & "&A=" & sAnnoSchema & "' target='_blank'>Clicca qui per visualizzare lo schema di altri anni</a>"

            CaricaCompContratto(lIdContratto)

            'CaricaSchemaBolletta(lIdContratto)
            CaricaSchemaBoll()

            CaricaDettCanoni(lIdContratto)

            VerificaRibaltamSpese(lIdContratto)


            If TipoContratto = "1" Or TipoContratto = "12" Or TipoContratto = "10" Or TipoContratto = "5" Then
                CType(Tab_Conduttore1.FindControl("lblElencoComponenti"), Label).Text = DettaglioComponenti()
            Else
                CType(Tab_Conduttore1.FindControl("lblElencoComponenti"), Label).Text = ""
            End If


            CType(Generale1.FindControl("lblDisdetta"), Label).Text = CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text
            'CType(Generale1.FindControl("Label20"), Label).Text = "Saldo al " & Format(Now, "dd/MM/yyyy")
            'CType(Generale1.FindControl("lblSaldoAttuale"), Label).Text = "<a href='#' onclick=" & Chr(34) & "javascript:window.open('../Contabilita/DatiUtenza.aspx?C=RisUtenza&IDANA=" & txtCodAffittuario.Value & "&IDCONT=" & lIdContratto & "','EstrattoConto','');" & Chr(34) & " alt='Visualizza Dettagli'>" & Format(par.CalcolaSaldoAttuale(lIdContratto), "##,##0.00") & " Euro</a>"


            ':::::::::::::::::::::::::::::::::::::::::::modifiche nuove


            par.cmd.CommandText = "SELECT ID FROM siscom_mi.SL_SLOGGIO WHERE ID_CONTRATTO =" & lIdContratto


            Dim lettore3 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If lettore3.Read Then

                idSloggio.Value = par.IfNull(lettore3("ID"), "")
            End If

            lettore3.Close()

            If idSloggio.Value = "" Then


                par.cmd.CommandText = "SELECT DATA_DISDETTA_LOCATARIO FROM siscom_mi.rapporti_utenza WHERE id = " & lIdContratto & " AND DATA_DISDETTA_LOCATARIO IS NOT NULL AND siscom_mi.getstatocontratto (rapporti_utenza.ID) <> 'CHIUSO'"

                lettore3 = par.cmd.ExecuteReader()
                If lettore3.Read Then

                    CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text = par.FormattaData(par.IfNull(lettore3("data_disdetta_locatario"), ""))

                End If
                lettore3.Close()

                If CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text <> "" Then


                    'fai l'insert
                    par.cmd.CommandText = "insert into SISCOM_MI.SL_SLOGGIO " _
                                     & "(ID, ID_UNITA_IMMOBILIARE,ID_CONTRATTO, ID_STATO, DATA_APP_PRE_SLOGGIO, DATA_APP_RAPPORTO_SLOGGIO)" _
                                     & " values (SISCOM_MI.SEQ_SL_SLOGGIO.NEXTVAL, " & txtIdUnita.Value & "," & lIdContratto & ",'0', '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Text) & CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).Text.Replace(":", "").Replace(".", "") & "', '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Text) & CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).Text.Replace(":", "").Replace(".", "") & "')"
                    par.cmd.ExecuteNonQuery()



                End If



            Else


                par.cmd.CommandText = "UPDATE SISCOM_MI.SL_SLOGGIO " _
                                   & " set DATA_APP_PRE_SLOGGIO = '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Text) & CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).Text.Replace(":", "").Replace(".", "") & "', " _
                                   & " DATA_APP_RAPPORTO_SLOGGIO = '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Text) & CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).Text.Replace(":", "").Replace(".", "") & "' " _
                                   & "WHERE ID = " & idSloggio.Value



                'par.cmd.CommandText = "UPDATE SISCOM_MI.SL_SLOGGIO " _
                '                   & " set DATA_APP_PRE_SLOGGIO = '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Text) & CType(Tab_Contratto1.FindControl("txtOraAppPresloggio"), TextBox).Text.Replace(":", "").Replace(".", "") & "', " _
                '                   & " DATA_APP_RAPPORTO_SLOGGIO = '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Text) & CType(Tab_Contratto1.FindControl("txtOraAppSloggio"), TextBox).Text.Replace(":", "").Replace(".", "") & "', " _
                '                   & " DATA_PRE_SLOGGIO = '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppPresloggio"), TextBox).Text) & "', " _
                '                   & " DATA_SLOGGIO = '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataAppSloggio"), TextBox).Text) & "' " _
                '                   & "WHERE ID = " & idSloggio.Value


                par.cmd.ExecuteNonQuery()


            End If

            ':::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


            ControllaProroga()
            ControllaAssDef()


            '*********** 30/08/2012 Nel caso di cambiamento da alloggio di servizio FFOO in alloggio ERP (VAIN) aggiorno la label indicante la natura dello stato
            If CType(Tab_Contratto1.FindControl("chkTemporanea"), CheckBox).Checked = True Then
                LBLErpModerato.Visible = True
                LBLErpModerato.Text = "Assegn. Temporanea"
            Else
                If LetteraERP <> "B" Then
                    Select Case TipoContratto
                        'Case "8"
                        '    LBLErpModerato.Visible = True
                        '    LBLErpModerato.Text = "(ART.22 C.10 RR 1/2004)"
                        Case "10"
                            LBLErpModerato.Visible = True
                            LBLErpModerato.Text = "Forze dell'Ordine"
                        Case "12"
                            LBLErpModerato.Visible = True
                            LBLErpModerato.Text = "Canone Convenzionato"
                        Case "1"
                            LBLErpModerato.Visible = True
                            LBLErpModerato.Text = "E.R.P. Sociale"
                        Case "6"
                            If LetteraProvenienza = "V" Then
                                LBLABUSIVO.Visible = True
                                LBLABUSIVO.Text = "ART.15 C.2 RR 1/2004"
                            End If
                        Case Else
                            LBLErpModerato.Visible = False
                    End Select
                Else
                    LBLErpModerato.Visible = False
                End If
            End If

            MemorizzaAttributi()
            CaricaAttributi()

            par.myTrans.Commit()
            par.myTrans = par.OracleConn.BeginTransaction()
            '‘par.cmd.Transaction = par.myTrans
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)

            par.cmd.CommandText = "SELECT RAPPORTI_UTENZA.* FROM SISCOM_MI.RAPPORTI_UTENZA WHERE RAPPORTI_UTENZA.ID=" & lIdContratto & " FOR UPDATE NOWAIT"
            Dim myReaderVer As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()


            Tab_Contratto1.indicecontratto = lIdContratto
            Tab_Contratto1.indiceconnessione = CStr(lIdConnessione)

            Tab_Azioni_Legali1.indicecontratto = lIdContratto
            Tab_Azioni_Legali1.indiceconnessione = lIdConnessione

            par.CaricaAvvisiLiquidazione(lIdContratto, CType(Tab_Registrazione1.FindControl("DataGridLiquidazione"), DataGrid))

            If MostrMsgSalva.Value = "1" Then
                ScriptManager.RegisterStartupScript(Me, Me.GetType(), "alert", "alert('Operazione Effettuata!');", True)
            Else
                MostrMsgSalva.Value = 1
            End If

        Catch EX1 As Oracle.DataAccess.Client.OracleException
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & EX1.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        Catch ex As Exception
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")

        End Try
    End Function


    Protected Sub imgSalva_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs) Handles imgSalva.Click
        If Page.IsValid Then
            SalvaDati()
            If TipoContratto = "5" Then
                RicavaAU392()
            End If
        Else
            Response.Write("<script>alert('Ci sono errori nella pagina!Verificare i dati!');</script>")
            Response.Flush()
        End If

    End Sub


    Private Function Valore01(ByVal valore As Boolean) As String
        If valore = True Then
            Valore01 = "1"
        Else
            Valore01 = "0"
        End If
    End Function


    'Protected Sub img_Eventi_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs) Handles img_Eventi.Click
    '    USCITA.Text = "0"
    'End Sub

    Private Function RicavaVia1(ByVal indirizzo As String) As String
        Dim pos As Integer
        Dim via As String


        pos = InStr(1, indirizzo, " ")
        If pos > 0 Then
            via = Mid(indirizzo, 1, pos - 1)
            Select Case via
                Case "C.SO", "CORSO"
                    RicavaVia1 = "CORSO"
                Case "PIAZZA", "PZ.", "P.ZZA", "PIAZZETTA"
                    RicavaVia1 = "PIAZZA"
                Case "PIAZZALE", "P.LE"
                    RicavaVia1 = "PIAZZALE"
                Case "P.T"
                    RicavaVia1 = "PORTA"
                Case "S.T.R.", "STRADA"
                    RicavaVia1 = "STRADA"
                Case "V.", "VIA"
                    RicavaVia1 = "VIA"
                Case "VIALE", "V.LE"
                    RicavaVia1 = "VIALE"
                Case "ALZAIA"
                    RicavaVia1 = "ALZAIA"
                Case "VICOLO"
                    RicavaVia1 = "VICOLO"
                Case "LARGO"
                    RicavaVia1 = "LARGO"
                Case Else
                    RicavaVia1 = "VIA"
            End Select

        Else
            RicavaVia1 = ""
        End If

    End Function

    Private Function RicavaInd(ByVal indirizzo As String, ByVal TipoVia As String) As String
        RicavaInd = indirizzo

        RicavaInd = Trim(Replace(indirizzo, TipoVia, ""))

    End Function


    Protected Sub btnAttivaContratto_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs) Handles btnAttivaContratto.Click

        Try

            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans


            If (par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text) <= Format(Now, "yyyyMMdd") Or par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataTrasST"), TextBox).Text) <= Format(Now, "yyyyMMdd")) Then


                If FL_NuovoContratto = "1" Then
                    Response.Write("<script>alert('Salvare i dati prima di attivare il contratto!');</script>")
                    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                    TXTATTIVA.Value = "0"
                    Session.Item("LAVORAZIONE") = "0"
                    par.myTrans.Rollback()
                    par.myTrans = par.OracleConn.BeginTransaction()
                    HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)
                    Exit Sub
                End If



                If TXTATTIVA.Value = "1" Then


                    'par.cmd.CommandText = "select * from SISCOM_MI.BOL_BOLLETTE where ID_contratto=" & lIdContratto & " and (RIF_FILE='MOD' OR RIF_FILE='MAV') AND FL_ANNULLATA='0'"
                    'Dim myReaderJA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    'If myReaderJA.HasRows = False Then
                    '    TXTATTIVA.Value = "0"
                    '    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                    '    Session.Item("LAVORAZIONE") = "0"
                    '    myReaderJA.Close()
                    '    Response.Write("<script>alert('Attenzione...Il contratto non può essere attivato perchè non sono state create le bollette di attivazione contratto!');</script>")
                    '    Exit Sub
                    'Else

                    'End If
                    'myReaderJA.Close()

                    'verifico se il bollettino n.2 è stato emesso
                    par.cmd.CommandText = "select * from SISCOM_MI.BOL_BOLLETTE where note='ATTIVAZIONE CONTRATTO BOLLETTINO N.2' and ID_BOLLETTA_STORNO IS NULL AND ID_TIPO=10 AND ID_contratto=" & lIdContratto
                    Dim myReaderJA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderJA.HasRows = True Then
                        myReaderJA.Close()
                    Else
                        myReaderJA.Close()
                        par.cmd.CommandText = "select * from SISCOM_MI.EVENTI_CONTRATTI where COD_EVENTO='F60' AND ID_contratto=" & lIdContratto
                        myReaderJA = par.cmd.ExecuteReader()
                        If myReaderJA.HasRows = False Then
                            TXTATTIVA.Value = "0"
                            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                            Session.Item("LAVORAZIONE") = "0"
                            myReaderJA.Close()
                            Response.Write("<script>alert('Attenzione...Il contratto non può essere attivato perchè non sono state create le bollette di attivazione contratto. Procedere con la creazione del bollettino N.1 e N.2!');</script>")
                            Exit Sub
                        Else
                            myReaderJA.Close()
                        End If

                    End If

                    If TipoContratto <> "7" Then
                        par.cmd.CommandText = "select FL_STAMPATO from SISCOM_MI.RAPPORTI_UTENZA where id=" & lIdContratto
                        myReaderJA = par.cmd.ExecuteReader()
                        If myReaderJA.Read Then
                            If par.IfNull(myReaderJA("FL_STAMPATO"), "0") = "0" Then
                                Response.Write("<script>alert('Attenzione...Il contratto non può essere attivato perchè non è stato stampato!');</script>")
                                TXTATTIVA.Value = "0"
                                CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                                Session.Item("LAVORAZIONE") = "0"
                                myReaderJA.Close()

                                Exit Sub
                            End If
                        End If
                        myReaderJA.Close()
                    End If

                    btnStampaContratto.Visible = False
                    btnAttivaContratto.Visible = False
                    ImgBolAttivazione.Visible = False



                    par.cmd.CommandText = "select SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID) AS ""STATO"" FROM SISCOM_MI.RAPPORTI_UTENZA where id=" & lIdContratto
                    Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReader.Read Then
                        CType(Generale1.FindControl("lblStato"), Label).Text = par.IfNull(myReader("STATO"), "")
                        LBLSTATOC.Visible = True
                        LBLSTATOC.Text = "Stato: " & UCase(par.IfNull(myReader("STATO"), ""))
                    End If
                    myReader.Close()


                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                        & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                        & "'F04','')"
                    par.cmd.ExecuteNonQuery()




                    If TipoContratto <> "3" And TipoContratto <> "7" Then

                        'creo l'anagrafe utenza


                        Dim SCALA As String = ""
                        Dim PIANO As String = ""
                        Dim COD_UNITA As String = ""
                        Dim ALLOGGIO As String = ""
                        Dim PIANOA As String = ""
                        Dim FOGLIO As String = ""
                        Dim MAPPALE As String = ""
                        Dim SUBALTERNO As String = ""


                        'par.cmd.CommandText = "SELECT ANNO_ISEE,ID,DATA_INIZIO FROM UTENZA_BANDI WHERE STATO=1 order by id desc"
                        'myReader = par.cmd.ExecuteReader()
                        'If myReader.Read() Then
                        '    sAnnoIsee = myReader(0)
                        '    lIndice_Bando = myReader(1)
                        'End If
                        'myReader.Close()


                        'par.cmd.CommandText = "SELECT MAX(ID) FROM UTENZA_NUM_PROTOCOLLI"
                        'myReader = par.cmd.ExecuteReader()
                        'If myReader.Read() Then
                        '    lValoreCorrente = myReader(0) + 1
                        'End If
                        'myReader.Close()
                        'par.cmd.CommandText = "INSERT INTO UTENZA_NUM_PROTOCOLLI VALUES (" & lValoreCorrente & ")"
                        'par.cmd.ExecuteNonQuery()

                        If TipoContratto = "1" Then
                            'par.cmd.CommandText = "SELECT DICHIARAZIONI.*,DOMANDE_BANDO.REDDITO_ISEE,DOMANDE_BANDO.ISE_ERP,DOMANDE_BANDO.ISR_ERP,DOMANDE_BANDO.ISP_ERP,DOMANDE_BANDO.PSE,DOMANDE_BANDO.VSE FROM DOMANDE_BANDO,DICHIARAZIONI WHERE DOMANDE_BANDO.ID_DICHIARAZIONE=DICHIARAZIONI.ID AND DICHIARAZIONI.ID=" & lIdDichiarazione
                            'myReader = par.cmd.ExecuteReader()
                            'If myReader.Read Then

                            '    par.cmd.CommandText = "SELECT scale_edifici.descrizione as SCALA,UNITA_IMMOBILIARI.*,IDENTIFICATIVI_CATASTALI.FOGLIO,IDENTIFICATIVI_CATASTALI.SEZIONE," _
                            '            & "IDENTIFICATIVI_CATASTALI.NUMERO,IDENTIFICATIVI_CATASTALI.SUB,IDENTIFICATIVI_CATASTALI.COD_TIPOLOGIA_CATASTO," _
                            '            & "IDENTIFICATIVI_CATASTALI.RENDITA,IDENTIFICATIVI_CATASTALI.COD_CATEGORIA_CATASTALE " _
                            '            & ",IDENTIFICATIVI_CATASTALI.COD_CLASSE_CATASTALE,IDENTIFICATIVI_CATASTALI.COD_QUALITA_CATASTALE, " _
                            '            & "IDENTIFICATIVI_CATASTALI.SUPERFICIE_MQ,IDENTIFICATIVI_CATASTALI.CUBATURA,IDENTIFICATIVI_CATASTALI.NUM_VANI" _
                            '            & ",IDENTIFICATIVI_CATASTALI.SUPERFICIE_CATASTALE,IDENTIFICATIVI_CATASTALI.RENDITA_STORICA," _
                            '            & "IDENTIFICATIVI_CATASTALI.IMMOBILE_STORICO,IDENTIFICATIVI_CATASTALI.VALORE_IMPONIBILE" _
                            '            & ",IDENTIFICATIVI_CATASTALI.DATA_ACQUISIZIONE,IDENTIFICATIVI_CATASTALI.DATA_FINE_VALIDITA" _
                            '            & ",IDENTIFICATIVI_CATASTALI.DITTA,IDENTIFICATIVI_CATASTALI.NUM_PARTITA" _
                            '            & ",IDENTIFICATIVI_CATASTALI.ESENTE_ICI,IDENTIFICATIVI_CATASTALI.PERC_POSSESSO" _
                            '            & ",IDENTIFICATIVI_CATASTALI.INAGIBILE,IDENTIFICATIVI_CATASTALI.MICROZONA_CENSUARIA" _
                            '            & ",IDENTIFICATIVI_CATASTALI.ZONA_CENSUARIA,IDENTIFICATIVI_CATASTALI.COD_STATO_CATASTALE" _
                            '            & ",INDIRIZZI.DESCRIZIONE AS ""IND"",INDIRIZZI.CIVICO,INDIRIZZI.CAP,INDIRIZZI.LOCALITA,INDIRIZZI.COD_COMUNE" _
                            '            & " FROM SISCOM_MI.SCALE_EDIFICI,SISCOM_MI.INDIRIZZI,SISCOM_MI.UNITA_IMMOBILIARI,SISCOM_MI.IDENTIFICATIVI_CATASTALI " _
                            '            & "WHERE UNITA_IMMOBILIARI.ID_SCALA=SCALE_EDIFICI.ID (+) AND INDIRIZZI.ID=unita_immobiliari.id_indirizzo AND UNITA_IMMOBILIARI.ID_CATASTALE=IDENTIFICATIVI_CATASTALI.ID (+) AND UNITA_IMMOBILIARI.ID=" & UnitaContratto
                            '    Dim myReaderD As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            '    If myReaderD.Read Then
                            '        COD_UNITA = par.IfNull(myReaderD("COD_UNITA_IMMOBILIARE"), "")
                            '        SCALA = par.IfNull(myReaderD("SCALA"), "")
                            '        ALLOGGIO = par.IfNull(myReaderD("INTERNO"), "")
                            '        PIANOA = par.IfNull(myReaderD("COD_TIPO_LIVELLO_PIANO"), "01")
                            '        FOGLIO = par.IfNull(myReaderD("FOGLIO"), "")
                            '        MAPPALE = par.IfNull(myReaderD("NUMERO"), "")
                            '        SUBALTERNO = par.IfNull(myReaderD("SUB"), "")
                            '    End If
                            '    myReaderD.Close()
                            '    'COD_UNITA codice alloggio

                            '    par.cmd.CommandText = "Insert into UTENZA_DICHIARAZIONI (ID, PG, ANNO_PG, DATA_PG, LUOGO, " _
                            '            & "DATA, NOTE, ID_STATO, ID_LUOGO_NAS_DNTE, TELEFONO_DNTE, " _
                            '            & "ID_LUOGO_RES_DNTE, ID_TIPO_IND_RES_DNTE, IND_RES_DNTE, CIVICO_RES_DNTE, N_COMP_NUCLEO, " _
                            '            & "N_INV_100_CON, N_INV_100_SENZA, N_INV_100_66, ID_TIPO_CAT_AB, ANNO_SIT_ECONOMICA, " _
                            '            & "LUOGO_INT_ERP, DATA_INT_ERP, LUOGO_S, DATA_S, PROGR_DNTE, " _
                            '            & "FL_GIA_TITOLARE, CAP_RES_DNTE, MINORI_CARICO, SCALA, PIANO, " _
                            '            & "ALLOGGIO, INT_C, INT_V, INT_A, FOGLIO, " _
                            '            & "MAPPALE, SUB, COD_ALLOGGIO, ID_BANDO, INT_M, " _
                            '            & "ISEE, POSIZIONE, TIPO_ASS, RAPPORTO, CHIAVE_ENTE_ESTERNO, " _
                            '            & "ID_CAF, N_DISTINTA, FL_SCARICO, FL_CONFERMA_SCARICO, ISE_ERP, " _
                            '            & "ISR_ERP, ISP_ERP, PSE, VSE, NOTE_WEB, " _
                            '            & "DATA_CESSAZIONE, PATR_SUPERATO, FL_UBICAZIONE, POSSESSO_UI, FL_APPLICA_36, " _
                            '            & "DATA_DECORRENZA,FL_GENERAZ_AUTO) " _
                            '            & "Values " _
                            '            & "(SEQ_UTENZA_DICHIARAZIONI.NEXTVAL, '" & Format(lValoreCorrente, "0000000000") _
                            '            & "', '" & Year(Now) & "', '" & Format(Now, "yyyyMMdd") _
                            '            & "', 'Milano', '" & Format(Now, "yyyyMMdd") & "','', 1," _
                            '            & par.IfNull(myReader("ID_LUOGO_NAS_DNTE"), "NULL") _
                            '            & ", '" & par.IfNull(myReader("TELEFONO_DNTE"), "") _
                            '            & "', " & par.IfNull(myReader("ID_LUOGO_RES_DNTE"), "NULL") _
                            '            & ", " & par.IfNull(myReader("ID_TIPO_IND_RES_DNTE"), "NULL") _
                            '            & ", '" & par.PulisciStrSql(par.IfNull(myReader("IND_RES_DNTE"), "")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("CIVICO_RES_DNTE"), "")) _
                            '            & "', " & par.IfNull(myReader("N_COMP_NUCLEO"), "1") _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("N_INV_100_CON"), "0")) _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("N_INV_100_SENZA"), "0")) _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("N_INV_100_66"), "0")) _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("ID_TIPO_CAT_AB"), "NULL")) _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("ANNO_SIT_ECONOMICA"), "NULL")) _
                            '            & ", '" & par.PulisciStrSql(par.IfNull(myReader("LUOGO_INT_ERP"), "Milano")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("DATA_INT_ERP"), "")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("LUOGO_S"), "Milano")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("DATA_S"), "")) _
                            '            & "', " & par.PulisciStrSql(par.IfNull(myReader("PROGR_DNTE"), "0")) _
                            '            & ", '" & par.PulisciStrSql(par.IfNull(myReader("FL_GIA_TITOLARE"), "0")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("CAP_RES_DNTE"), "NULL")) _
                            '            & "', '0', '" & SCALA & "', '" & PIANOA & "','" & ALLOGGIO _
                            '            & "', '1', '0', '0', '" & FOGLIO & "', " _
                            '            & "'" & MAPPALE & "','" & SUBALTERNO & "',''," & lIndice_Bando & ", '0', " _
                            '            & "'" & Format(par.IfNull(myReader("REDDITO_ISEE"), "0"), "##,##0.00") & "', '" & COD_UNITA & "', '1', '" & CodContratto1 & "', -1, " _
                            '            & Session.Item("ID_CAF") _
                            '            & ", 0, '0', '0', " & par.VirgoleInPunti(par.IfNull(myReader("ISE_ERP"), 0)) & ", " _
                            '            & par.VirgoleInPunti(par.IfNull(myReader("ISR_ERP"), 0)) _
                            '            & "," & par.VirgoleInPunti(par.IfNull(myReader("ISP_ERP"), 0)) _
                            '            & ", '" & par.IfNull(myReader("PSE"), "1") _
                            '            & "', '" & par.IfNull(myReader("VSE"), "1") & "', 'GENERATA AUTOMATICAMENTE', " _
                            '            & "'" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text) _
                            '            & "', '0', '0', '0', '1', " _
                            '            & "'" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) & "',1)"

                            '    par.cmd.ExecuteNonQuery()


                            '    par.cmd.CommandText = "SELECT SEQ_UTENZA_DICHIARAZIONI.CURRVAL FROM DUAL"
                            '    myReader = par.cmd.ExecuteReader()
                            '    If myReader.Read Then
                            '        lIdDichiarazioneAU = myReader(0)
                            '    End If
                            '    myReader.Close()

                            '    par.cmd.CommandText = "INSERT INTO UTENZA_EVENTI_DICHIARAZIONI (ID_PRATICA,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                            '                & "VALUES (" & lIdDichiarazioneAU & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                            '                & "'F130','','I')"
                            '    par.cmd.ExecuteNonQuery()


                            '    Dim ID_COMPONENTE As Long = 0

                            '    par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " order by progr asc"
                            '    myReaderD = par.cmd.ExecuteReader()
                            '    Do While myReaderD.Read
                            '        par.cmd.CommandText = "Insert into UTENZA_COMP_NUCLEO (ID, ID_DICHIARAZIONE, " _
                            '                            & "PROGR, COD_FISCALE, COGNOME, NOME, SESSO, DATA_NASCITA, " _
                            '                            & "USL, GRADO_PARENTELA, PERC_INVAL, INDENNITA_ACC) " _
                            '                            & "Values " _
                            '                            & "(SEQ_UTENZA_COMP_NUCLEO.NEXTVAL, " & lIdDichiarazioneAU _
                            '                            & "," & myReaderD("PROGR") _
                            '                            & ", '" & par.PulisciStrSql(par.IfNull(myReaderD("COD_FISCALE"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("COGNOME"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("NOME"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("SESSO"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("DATA_NASCITA"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("USL"), "")) _
                            '                            & "', " & par.PulisciStrSql(par.IfNull(myReaderD("GRADO_PARENTELA"), "0")) _
                            '                            & "," & par.VirgoleInPunti(par.IfNull(myReaderD("PERC_INVAL"), "0")) _
                            '                            & ", '" & par.PulisciStrSql(par.IfNull(myReaderD("INDENNITA_ACC"), "0")) & "')"

                            '        par.cmd.ExecuteNonQuery()
                            '        par.cmd.CommandText = "SELECT SEQ_UTENZA_COMP_NUCLEO.CURRVAL FROM DUAL"
                            '        myReader = par.cmd.ExecuteReader()
                            '        If myReader.Read Then
                            '            ID_COMPONENTE = myReader(0)
                            '        End If
                            '        myReader.Close()

                            '        If myReaderD("PROGR") = "0" Then
                            '            par.cmd.CommandText = "update utenza_dichiarazioni set cod_alloggio='" & ID_COMPONENTE & "' where id=" & lIdDichiarazioneAU
                            '            par.cmd.ExecuteNonQuery()
                            '        End If

                            '        par.cmd.CommandText = "SELECT * FROM COMP_ALTRI_REDDITI WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_ALTRI_REDDITI (ID, ID_COMPONENTE, IMPORTO) " _
                            '                                & "Values " _
                            '                                & "(SEQ_UTENZA_COMP_ALTRI_REDDITI.NEXTVAL, " & ID_COMPONENTE _
                            '                                & " , " & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO"), 0)) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()


                            '        par.cmd.CommandText = "SELECT * FROM COMP_DETRAZIONI WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_DETRAZIONI (ID, ID_COMPONENTE, ID_TIPO, IMPORTO) " _
                            '                      & "Values " _
                            '                      & "(SEQ_UTENZA_COMP_DETRAZIONI.NEXTVAL, " & ID_COMPONENTE _
                            '                      & "," & myReader("ID_TIPO") & ", " & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO"), 0)) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()

                            '        par.cmd.CommandText = "SELECT * FROM COMP_ELENCO_SPESE WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_ELENCO_SPESE " _
                            '                             & "(ID, ID_COMPONENTE, DESCRIZIONE, IMPORTO) " _
                            '                            & "Values " _
                            '                            & "(SEQ_UTENZA_COMP_ELENCO_SPESE.NEXTVAL, " & ID_COMPONENTE _
                            '                            & ", '" & par.PulisciStrSql(par.IfNull(myReader("DESCRIZIONE"), "")) _
                            '                            & "', " & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO"), 0)) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()

                            '        par.cmd.CommandText = "SELECT * FROM COMP_PATR_IMMOB WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_PATR_IMMOB" _
                            '                                & "(ID, ID_COMPONENTE, ID_TIPO, PERC_PATR_IMMOBILIARE, VALORE, " _
                            '                                & "MUTUO, F_RESIDENZA) " _
                            '                               & "Values " _
                            '                               & "(SEQ_UTENZA_COMP_PATR_IMMOB.NEXTVAL," & ID_COMPONENTE _
                            '                               & ", " & myReader("ID_TIPO") & ", " & par.VirgoleInPunti(myReader("PERC_PATR_IMMOBILIARE")) _
                            '                               & ", " & par.VirgoleInPunti(par.IfNull(myReader("VALORE"), 0)) _
                            '                               & ", " & par.VirgoleInPunti(par.IfNull(myReader("MUTUO"), 0)) _
                            '                               & ",'" & par.IfNull(myReader("F_RESIDENZA"), "0") & "' )"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()

                            '        par.cmd.CommandText = "SELECT * FROM COMP_PATR_MOB WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_PATR_MOB" _
                            '             & "(ID, ID_COMPONENTE, COD_INTERMEDIARIO, INTERMEDIARIO, IMPORTO, " _
                            '             & "IBAN) Values " _
                            '             & "(SEQ_UTENZA_COMP_PATR_MOB.NEXTVAL," & ID_COMPONENTE _
                            '              & ", '" & par.PulisciStrSql(par.IfNull(myReader("COD_INTERMEDIARIO"), "")) _
                            '              & "', '" & par.PulisciStrSql(par.IfNull(myReader("INTERMEDIARIO"), "")) _
                            '              & "', " & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO"), 0)) _
                            '              & ",'" & par.PulisciStrSql(par.IfNull(myReader("IBAN"), "")) & "')"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()

                            '        par.cmd.CommandText = "SELECT * FROM COMP_REDDITO WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_REDDITO " _
                            '                         & "(ID, ID_COMPONENTE, REDDITO_IRPEF, PROV_AGRARI) " _
                            '                         & "Values " _
                            '                         & "(SEQ_UTENZA_COMP_REDDITO.NEXTVAL, " & ID_COMPONENTE & ", " _
                            '                         & par.VirgoleInPunti(par.IfNull(myReader("REDDITO_IRPEF"), 0)) _
                            '                         & ", " & par.VirgoleInPunti(par.IfNull(myReader("PROV_AGRARI"), 0)) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()
                            '    Loop
                            '    myReaderD.Close()
                            'End If
                            'myReader.Close()
                            Generale1.Provenienza = "1"

                            par.cmd.CommandText = "UPDATE domande_bando SET ID_STATO='10',CONTRATTO_NUM='" & CodContratto1 & "',CONTRATTO_DATA='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Text) & "',CONTRATTO_DATA_DEC='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) & "'  WHERE ID=" & lIdDomandaERP
                            par.cmd.ExecuteNonQuery()
                            par.cmd.CommandText = "INSERT INTO EVENTI_bandi (ID_domanda,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE,stato_pratica) " _
                                        & "VALUES (" & lIdDomandaERP & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                                        & "'F60','','I','10')"
                            par.cmd.ExecuteNonQuery()

                            par.cmd.CommandText = "SELECT * FROM domande_bando WHERE ID=" & lIdDomandaERP
                            myReader = par.cmd.ExecuteReader()
                            If myReader.Read Then
                                par.cmd.CommandText = "INSERT INTO STATISTICHE (DATA_EVENTO,COD_EVENTO,ESITO_EVENTO,PG,DATA_PG,SEZIONE,TIPOLOGIA,GRAD) " _
                                                    & "VALUES ('" & Format(Now, "yyyyMMdd") & "',5,24,'" & myReader("pg") & "','" & myReader("data_pg") & "',10," & myReader("tipo_pratica") & ",10)"
                                par.cmd.ExecuteNonQuery()
                            End If
                            myReader.Close()

                        End If

                        '--------------------------------


                        If par.IfEmpty(CType(Tab_Contratto1.FindControl("cmbOrigineRU"), DropDownList).SelectedValue, "-1") = 1 Or TipoContratto = "10" Then
                            'par.cmd.CommandText = "SELECT DICHIARAZIONI_VSA.*,DOMANDE_BANDO_VSA.REDDITO_ISEE,DOMANDE_BANDO_VSA.ISE_ERP,DOMANDE_BANDO_VSA.ISR_ERP,DOMANDE_BANDO_VSA.ISP_ERP,DOMANDE_BANDO_VSA.PSE,DOMANDE_BANDO_VSA.VSE FROM DOMANDE_BANDO_VSA,DICHIARAZIONI_VSA WHERE DOMANDE_BANDO_VSA.ID_DICHIARAZIONE=DICHIARAZIONI_VSA.ID AND DICHIARAZIONI_VSA.ID=" & lIdDichiarazione
                            'myReader = par.cmd.ExecuteReader()
                            'If myReader.Read Then

                            '    par.cmd.CommandText = "SELECT SCALE_EDIFICI.DESCRIZIONE AS SCALA,UNITA_IMMOBILIARI.*,IDENTIFICATIVI_CATASTALI.FOGLIO,IDENTIFICATIVI_CATASTALI.SEZIONE," _
                            '            & "IDENTIFICATIVI_CATASTALI.NUMERO,IDENTIFICATIVI_CATASTALI.SUB,IDENTIFICATIVI_CATASTALI.COD_TIPOLOGIA_CATASTO," _
                            '            & "IDENTIFICATIVI_CATASTALI.RENDITA,IDENTIFICATIVI_CATASTALI.COD_CATEGORIA_CATASTALE " _
                            '            & ",IDENTIFICATIVI_CATASTALI.COD_CLASSE_CATASTALE,IDENTIFICATIVI_CATASTALI.COD_QUALITA_CATASTALE, " _
                            '            & "IDENTIFICATIVI_CATASTALI.SUPERFICIE_MQ,IDENTIFICATIVI_CATASTALI.CUBATURA,IDENTIFICATIVI_CATASTALI.NUM_VANI" _
                            '            & ",IDENTIFICATIVI_CATASTALI.SUPERFICIE_CATASTALE,IDENTIFICATIVI_CATASTALI.RENDITA_STORICA," _
                            '            & "IDENTIFICATIVI_CATASTALI.IMMOBILE_STORICO,IDENTIFICATIVI_CATASTALI.VALORE_IMPONIBILE" _
                            '            & ",IDENTIFICATIVI_CATASTALI.DATA_ACQUISIZIONE,IDENTIFICATIVI_CATASTALI.DATA_FINE_VALIDITA" _
                            '            & ",IDENTIFICATIVI_CATASTALI.DITTA,IDENTIFICATIVI_CATASTALI.NUM_PARTITA" _
                            '            & ",IDENTIFICATIVI_CATASTALI.ESENTE_ICI,IDENTIFICATIVI_CATASTALI.PERC_POSSESSO" _
                            '            & ",IDENTIFICATIVI_CATASTALI.INAGIBILE,IDENTIFICATIVI_CATASTALI.MICROZONA_CENSUARIA" _
                            '            & ",IDENTIFICATIVI_CATASTALI.ZONA_CENSUARIA,IDENTIFICATIVI_CATASTALI.COD_STATO_CATASTALE" _
                            '            & ",INDIRIZZI.DESCRIZIONE AS ""IND"",INDIRIZZI.CIVICO,INDIRIZZI.CAP,INDIRIZZI.LOCALITA,INDIRIZZI.COD_COMUNE" _
                            '            & " FROM SISCOM_MI.SCALE_EDIFICI,SISCOM_MI.INDIRIZZI,SISCOM_MI.UNITA_IMMOBILIARI,SISCOM_MI.IDENTIFICATIVI_CATASTALI " _
                            '            & "WHERE UNITA_IMMOBILIARI.ID_SCALA=SCALE_EDIFICI.ID (+) AND INDIRIZZI.ID=unita_immobiliari.id_indirizzo AND UNITA_IMMOBILIARI.ID_CATASTALE=IDENTIFICATIVI_CATASTALI.ID (+) AND UNITA_IMMOBILIARI.ID=" & UnitaContratto
                            '    Dim myReaderD As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            '    If myReaderD.Read Then
                            '        COD_UNITA = par.IfNull(myReaderD("COD_UNITA_IMMOBILIARE"), "")
                            '        SCALA = par.IfNull(myReaderD("SCALA"), "")
                            '        ALLOGGIO = par.IfNull(myReaderD("INTERNO"), "")
                            '        PIANOA = par.IfNull(myReaderD("COD_TIPO_LIVELLO_PIANO"), "01")
                            '        FOGLIO = par.IfNull(myReaderD("FOGLIO"), "")
                            '        MAPPALE = par.IfNull(myReaderD("NUMERO"), "")
                            '        SUBALTERNO = par.IfNull(myReaderD("SUB"), "")
                            '    End If
                            '    myReaderD.Close()
                            '    'COD_UNITA codice alloggio

                            '    par.cmd.CommandText = "Insert into UTENZA_DICHIARAZIONI (ID, PG, ANNO_PG, DATA_PG, LUOGO, " _
                            '            & "DATA, NOTE, ID_STATO, ID_LUOGO_NAS_DNTE, TELEFONO_DNTE, " _
                            '            & "ID_LUOGO_RES_DNTE, ID_TIPO_IND_RES_DNTE, IND_RES_DNTE, CIVICO_RES_DNTE, N_COMP_NUCLEO, " _
                            '            & "N_INV_100_CON, N_INV_100_SENZA, N_INV_100_66, ID_TIPO_CAT_AB, ANNO_SIT_ECONOMICA, " _
                            '            & "LUOGO_INT_ERP, DATA_INT_ERP, LUOGO_S, DATA_S, PROGR_DNTE, " _
                            '            & "FL_GIA_TITOLARE, CAP_RES_DNTE, MINORI_CARICO, SCALA, PIANO, " _
                            '            & "ALLOGGIO, INT_C, INT_V, INT_A, FOGLIO, " _
                            '            & "MAPPALE, SUB, COD_ALLOGGIO, ID_BANDO, INT_M, " _
                            '            & "ISEE, POSIZIONE, TIPO_ASS, RAPPORTO, CHIAVE_ENTE_ESTERNO, " _
                            '            & "ID_CAF, N_DISTINTA, FL_SCARICO, FL_CONFERMA_SCARICO, ISE_ERP, " _
                            '            & "ISR_ERP, ISP_ERP, PSE, VSE, NOTE_WEB, " _
                            '            & "DATA_CESSAZIONE, PATR_SUPERATO, FL_UBICAZIONE, POSSESSO_UI, FL_APPLICA_36, " _
                            '            & "DATA_DECORRENZA,FL_GENERAZ_AUTO) " _
                            '            & "Values " _
                            '            & "(SEQ_UTENZA_DICHIARAZIONI.NEXTVAL, '" & Format(lValoreCorrente, "0000000000") _
                            '            & "', '" & Year(Now) & "', '" & Format(Now, "yyyyMMdd") _
                            '            & "', 'Milano', '" & Format(Now, "yyyyMMdd") & "','', 1," _
                            '            & par.IfNull(myReader("ID_LUOGO_NAS_DNTE"), "NULL") _
                            '            & ", '" & par.IfNull(myReader("TELEFONO_DNTE"), "") _
                            '            & "', " & par.IfNull(myReader("ID_LUOGO_RES_DNTE"), "NULL") _
                            '            & ", " & par.IfNull(myReader("ID_TIPO_IND_RES_DNTE"), "NULL") _
                            '            & ", '" & par.PulisciStrSql(par.IfNull(myReader("IND_RES_DNTE"), "")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("CIVICO_RES_DNTE"), "")) _
                            '            & "', " & par.IfNull(myReader("N_COMP_NUCLEO"), "1") _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("N_INV_100_CON"), "0")) _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("N_INV_100_SENZA"), "0")) _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("N_INV_100_66"), "0")) _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("ID_TIPO_CAT_AB"), "NULL")) _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("ANNO_SIT_ECONOMICA"), "NULL")) _
                            '            & ", '" & par.PulisciStrSql(par.IfNull(myReader("LUOGO_INT_ERP"), "Milano")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("DATA_INT_ERP"), "")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("LUOGO_S"), "Milano")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("DATA_S"), "")) _
                            '            & "', " & par.PulisciStrSql(par.IfNull(myReader("PROGR_DNTE"), "0")) _
                            '            & ", '" & par.PulisciStrSql(par.IfNull(myReader("FL_GIA_TITOLARE"), "0")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("CAP_RES_DNTE"), "NULL")) _
                            '            & "', '0', '" & SCALA & "', '" & PIANOA & "','" & ALLOGGIO _
                            '            & "', '1', '0', '0', '" & FOGLIO & "', " _
                            '            & "'" & MAPPALE & "','" & SUBALTERNO & "',''," & lIndice_Bando & ", '0', " _
                            '            & "'" & Format(par.IfNull(myReader("REDDITO_ISEE"), "0"), "##,##0.00") & "', '" & COD_UNITA & "', '1', '" & CodContratto1 & "', -1, " _
                            '            & Session.Item("ID_CAF") _
                            '            & ", 0, '0', '0', " & par.VirgoleInPunti(par.IfNull(myReader("ISE_ERP"), 0)) & ", " _
                            '            & par.VirgoleInPunti(par.IfNull(myReader("ISR_ERP"), 0)) _
                            '            & "," & par.VirgoleInPunti(par.IfNull(myReader("ISP_ERP"), 0)) _
                            '            & ", '" & par.IfNull(myReader("PSE"), "1") _
                            '            & "', '" & par.IfNull(myReader("VSE"), "1") & "', 'GENERATA AUTOMATICAMENTE', " _
                            '            & "'" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text) _
                            '            & "', '0', '0', '0', '1', " _
                            '            & "'" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) & "',1)"

                            '    par.cmd.ExecuteNonQuery()


                            '    par.cmd.CommandText = "SELECT SEQ_UTENZA_DICHIARAZIONI.CURRVAL FROM DUAL"
                            '    myReader = par.cmd.ExecuteReader()
                            '    If myReader.Read Then
                            '        lIdDichiarazioneAU = myReader(0)
                            '    End If
                            '    myReader.Close()

                            '    par.cmd.CommandText = "INSERT INTO UTENZA_EVENTI_DICHIARAZIONI (ID_PRATICA,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                            '                & "VALUES (" & lIdDichiarazioneAU & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                            '                & "'F130','','I')"
                            '    par.cmd.ExecuteNonQuery()


                            '    Dim ID_COMPONENTE As Long = 0

                            '    par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_VSA WHERE ID_DICHIARAZIONE=" & lIdDichiarazione & " order by progr asc"
                            '    myReaderD = par.cmd.ExecuteReader()
                            '    Do While myReaderD.Read
                            '        par.cmd.CommandText = "Insert into UTENZA_COMP_NUCLEO (ID, ID_DICHIARAZIONE, " _
                            '                            & "PROGR, COD_FISCALE, COGNOME, NOME, SESSO, DATA_NASCITA, " _
                            '                            & "USL, GRADO_PARENTELA, PERC_INVAL, INDENNITA_ACC) " _
                            '                            & "Values " _
                            '                            & "(SEQ_UTENZA_COMP_NUCLEO.NEXTVAL, " & lIdDichiarazioneAU _
                            '                            & "," & myReaderD("PROGR") _
                            '                            & ", '" & par.PulisciStrSql(par.IfNull(myReaderD("COD_FISCALE"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("COGNOME"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("NOME"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("SESSO"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("DATA_NASCITA"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("USL"), "")) _
                            '                            & "', " & par.PulisciStrSql(par.IfNull(myReaderD("GRADO_PARENTELA"), "0")) _
                            '                            & "," & par.VirgoleInPunti(par.IfNull(myReaderD("PERC_INVAL"), "0")) _
                            '                            & ", '" & par.PulisciStrSql(par.IfNull(myReaderD("INDENNITA_ACC"), "0")) & "')"

                            '        par.cmd.ExecuteNonQuery()
                            '        par.cmd.CommandText = "SELECT SEQ_UTENZA_COMP_NUCLEO.CURRVAL FROM DUAL"
                            '        myReader = par.cmd.ExecuteReader()
                            '        If myReader.Read Then
                            '            ID_COMPONENTE = myReader(0)
                            '        End If
                            '        myReader.Close()

                            '        If myReaderD("PROGR") = "0" Then
                            '            par.cmd.CommandText = "update utenza_dichiarazioni set cod_alloggio='" & ID_COMPONENTE & "' where id=" & lIdDichiarazioneAU
                            '            par.cmd.ExecuteNonQuery()
                            '        End If

                            '        par.cmd.CommandText = "SELECT * FROM COMP_ALTRI_REDDITI_VSA WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_ALTRI_REDDITI (ID, ID_COMPONENTE, IMPORTO) " _
                            '                                & "Values " _
                            '                                & "(SEQ_UTENZA_COMP_ALTRI_REDDITI.NEXTVAL, " & ID_COMPONENTE _
                            '                                & " , " & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO"), 0)) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()


                            '        par.cmd.CommandText = "SELECT * FROM COMP_DETRAZIONI_VSA WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_DETRAZIONI (ID, ID_COMPONENTE, ID_TIPO, IMPORTO) " _
                            '                      & "Values " _
                            '                      & "(SEQ_UTENZA_COMP_DETRAZIONI.NEXTVAL, " & ID_COMPONENTE _
                            '                      & "," & myReader("ID_TIPO") & ", " & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO"), 0)) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()

                            '        par.cmd.CommandText = "SELECT * FROM COMP_ELENCO_SPESE_VSA WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_ELENCO_SPESE " _
                            '                             & "(ID, ID_COMPONENTE, DESCRIZIONE, IMPORTO) " _
                            '                            & "Values " _
                            '                            & "(SEQ_UTENZA_COMP_ELENCO_SPESE.NEXTVAL, " & ID_COMPONENTE _
                            '                            & ", '" & par.PulisciStrSql(par.IfNull(myReader("DESCRIZIONE"), "")) _
                            '                            & "', " & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO"), 0)) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()

                            '        par.cmd.CommandText = "SELECT * FROM COMP_PATR_IMMOB_VSA WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_PATR_IMMOB" _
                            '                                & "(ID, ID_COMPONENTE, ID_TIPO, PERC_PATR_IMMOBILIARE, VALORE, " _
                            '                                & "MUTUO, F_RESIDENZA) " _
                            '                               & "Values " _
                            '                               & "(SEQ_UTENZA_COMP_PATR_IMMOB.NEXTVAL," & ID_COMPONENTE _
                            '                               & ", " & myReader("ID_TIPO") & ", " & par.VirgoleInPunti(myReader("PERC_PATR_IMMOBILIARE")) _
                            '                               & ", " & par.VirgoleInPunti(par.IfNull(myReader("VALORE"), 0)) _
                            '                               & ", " & par.VirgoleInPunti(par.IfNull(myReader("MUTUO"), 0)) _
                            '                               & ",'" & par.IfNull(myReader("F_RESIDENZA"), "0") & "' )"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()

                            '        par.cmd.CommandText = "SELECT * FROM COMP_PATR_MOB_VSA WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_PATR_MOB" _
                            '             & "(ID, ID_COMPONENTE, COD_INTERMEDIARIO, INTERMEDIARIO, IMPORTO, " _
                            '             & "IBAN) Values " _
                            '             & "(SEQ_UTENZA_COMP_PATR_MOB.NEXTVAL," & ID_COMPONENTE _
                            '              & ", '" & par.PulisciStrSql(par.IfNull(myReader("COD_INTERMEDIARIO"), "")) _
                            '              & "', '" & par.PulisciStrSql(par.IfNull(myReader("INTERMEDIARIO"), "")) _
                            '              & "', " & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO"), 0)) _
                            '              & ",'" & par.PulisciStrSql(par.IfNull(myReader("IBAN"), "")) & "')"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()

                            '        par.cmd.CommandText = "SELECT * FROM COMP_REDDITO_VSA WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_REDDITO " _
                            '                         & "(ID, ID_COMPONENTE, REDDITO_IRPEF, PROV_AGRARI) " _
                            '                         & "Values " _
                            '                         & "(SEQ_UTENZA_COMP_REDDITO.NEXTVAL, " & ID_COMPONENTE & ", " _
                            '                         & par.VirgoleInPunti(par.IfNull(myReader("REDDITO_IRPEF"), 0)) _
                            '                         & ", " & par.VirgoleInPunti(par.IfNull(myReader("PROV_AGRARI"), 0)) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()
                            '    Loop
                            '    myReaderD.Close()
                            'End If
                            'myReader.Close()

                            'Generale1.Provenienza = "8"

                            par.cmd.CommandText = "UPDATE domande_bando_VSA SET ID_STATO='10',CONTRATTO_NUM='" & CodContratto1 & "',CONTRATTO_DATA='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Text) & "',CONTRATTO_DATA_DEC='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) & "'  WHERE ID=" & lIdDomandaERP
                            par.cmd.ExecuteNonQuery()
                            par.cmd.CommandText = "INSERT INTO EVENTI_bandi (ID_domanda,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE,stato_pratica) " _
                                        & "VALUES (" & lIdDomandaERP & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                                        & "'F60','','I','10')"
                            par.cmd.ExecuteNonQuery()

                            par.cmd.CommandText = "SELECT * FROM domande_bando_VSA WHERE ID=" & lIdDomandaERP
                            myReader = par.cmd.ExecuteReader()
                            If myReader.Read Then
                                par.cmd.CommandText = "INSERT INTO STATISTICHE (DATA_EVENTO,COD_EVENTO,ESITO_EVENTO,PG,DATA_PG,SEZIONE,TIPOLOGIA,GRAD) " _
                                                    & "VALUES ('" & Format(Now, "yyyyMMdd") & "',5,24,'" & myReader("pg") & "','" & myReader("data_pg") & "',10," & myReader("tipo_pratica") & ",10)"
                                par.cmd.ExecuteNonQuery()
                            End If
                            myReader.Close()

                        End If

                        '--------------------------------



                        If TipoContratto = "2" Then
                            'par.cmd.CommandText = "SELECT DICHIARAZIONI_cambi.*,DOMANDE_BANDO_cambi.REDDITO_ISEE,DOMANDE_BANDO_cambi.ISE_ERP,DOMANDE_BANDO_cambi.ISR_ERP,DOMANDE_BANDO_cambi.ISP_ERP,DOMANDE_BANDO_cambi.PSE,DOMANDE_BANDO_cambi.VSE FROM DOMANDE_BANDO_cambi,DICHIARAZIONI_cambi WHERE DOMANDE_BANDO_cambi.ID_DICHIARAZIONE=DICHIARAZIONI_cambi.ID AND DICHIARAZIONI_cambi.ID=" & lIdDichiarazione
                            'myReader = par.cmd.ExecuteReader()
                            'If myReader.Read Then

                            '    par.cmd.CommandText = "SELECT SCALE_EDIFICI.DESCRIZIONE AS SCALA,UNITA_IMMOBILIARI.*,IDENTIFICATIVI_CATASTALI.FOGLIO,IDENTIFICATIVI_CATASTALI.SEZIONE," _
                            '            & "IDENTIFICATIVI_CATASTALI.NUMERO,IDENTIFICATIVI_CATASTALI.SUB,IDENTIFICATIVI_CATASTALI.COD_TIPOLOGIA_CATASTO," _
                            '            & "IDENTIFICATIVI_CATASTALI.RENDITA,IDENTIFICATIVI_CATASTALI.COD_CATEGORIA_CATASTALE " _
                            '            & ",IDENTIFICATIVI_CATASTALI.COD_CLASSE_CATASTALE,IDENTIFICATIVI_CATASTALI.COD_QUALITA_CATASTALE, " _
                            '            & "IDENTIFICATIVI_CATASTALI.SUPERFICIE_MQ,IDENTIFICATIVI_CATASTALI.CUBATURA,IDENTIFICATIVI_CATASTALI.NUM_VANI" _
                            '            & ",IDENTIFICATIVI_CATASTALI.SUPERFICIE_CATASTALE,IDENTIFICATIVI_CATASTALI.RENDITA_STORICA," _
                            '            & "IDENTIFICATIVI_CATASTALI.IMMOBILE_STORICO,IDENTIFICATIVI_CATASTALI.VALORE_IMPONIBILE" _
                            '            & ",IDENTIFICATIVI_CATASTALI.DATA_ACQUISIZIONE,IDENTIFICATIVI_CATASTALI.DATA_FINE_VALIDITA" _
                            '            & ",IDENTIFICATIVI_CATASTALI.DITTA,IDENTIFICATIVI_CATASTALI.NUM_PARTITA" _
                            '            & ",IDENTIFICATIVI_CATASTALI.ESENTE_ICI,IDENTIFICATIVI_CATASTALI.PERC_POSSESSO" _
                            '            & ",IDENTIFICATIVI_CATASTALI.INAGIBILE,IDENTIFICATIVI_CATASTALI.MICROZONA_CENSUARIA" _
                            '            & ",IDENTIFICATIVI_CATASTALI.ZONA_CENSUARIA,IDENTIFICATIVI_CATASTALI.COD_STATO_CATASTALE" _
                            '            & ",INDIRIZZI.DESCRIZIONE AS ""IND"",INDIRIZZI.CIVICO,INDIRIZZI.CAP,INDIRIZZI.LOCALITA,INDIRIZZI.COD_COMUNE" _
                            '            & " FROM SISCOM_MI.SCALE_EDIFICI,SISCOM_MI.INDIRIZZI,SISCOM_MI.UNITA_IMMOBILIARI,SISCOM_MI.IDENTIFICATIVI_CATASTALI " _
                            '            & "WHERE UNITA_IMMOBILIARI.ID_SCALA=SCALE_EDIFICI.ID (+) AND INDIRIZZI.ID=unita_immobiliari.id_indirizzo AND UNITA_IMMOBILIARI.ID_CATASTALE=IDENTIFICATIVI_CATASTALI.ID (+) AND UNITA_IMMOBILIARI.ID=" & UnitaContratto
                            '    Dim myReaderD As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            '    If myReaderD.Read Then
                            '        COD_UNITA = par.IfNull(myReaderD("COD_UNITA_IMMOBILIARE"), "")
                            '        SCALA = par.IfNull(myReaderD("SCALA"), "")
                            '        ALLOGGIO = par.IfNull(myReaderD("INTERNO"), "")
                            '        PIANOA = par.IfNull(myReaderD("COD_TIPO_LIVELLO_PIANO"), "01")
                            '        FOGLIO = par.IfNull(myReaderD("FOGLIO"), "")
                            '        MAPPALE = par.IfNull(myReaderD("NUMERO"), "")
                            '        SUBALTERNO = par.IfNull(myReaderD("SUB"), "")
                            '    End If
                            '    myReaderD.Close()

                            '    par.cmd.CommandText = "Insert into UTENZA_DICHIARAZIONI (ID, PG, ANNO_PG, DATA_PG, LUOGO, " _
                            '            & "DATA, NOTE, ID_STATO, ID_LUOGO_NAS_DNTE, TELEFONO_DNTE, " _
                            '            & "ID_LUOGO_RES_DNTE, ID_TIPO_IND_RES_DNTE, IND_RES_DNTE, CIVICO_RES_DNTE, N_COMP_NUCLEO, " _
                            '            & "N_INV_100_CON, N_INV_100_SENZA, N_INV_100_66, ID_TIPO_CAT_AB, ANNO_SIT_ECONOMICA, " _
                            '            & "LUOGO_INT_ERP, DATA_INT_ERP, LUOGO_S, DATA_S, PROGR_DNTE, " _
                            '            & "FL_GIA_TITOLARE, CAP_RES_DNTE, MINORI_CARICO, SCALA, PIANO, " _
                            '            & "ALLOGGIO, INT_C, INT_V, INT_A, FOGLIO, " _
                            '            & "MAPPALE, SUB, COD_ALLOGGIO, ID_BANDO, INT_M, " _
                            '            & "ISEE, POSIZIONE, TIPO_ASS, RAPPORTO, CHIAVE_ENTE_ESTERNO, " _
                            '            & "ID_CAF, N_DISTINTA, FL_SCARICO, FL_CONFERMA_SCARICO, ISE_ERP, " _
                            '            & "ISR_ERP, ISP_ERP, PSE, VSE, NOTE_WEB, " _
                            '            & "DATA_CESSAZIONE, PATR_SUPERATO, FL_UBICAZIONE, POSSESSO_UI, FL_APPLICA_36, " _
                            '            & "DATA_DECORRENZA,FL_GENERAZ_AUTO) " _
                            '            & "Values " _
                            '            & "(SEQ_UTENZA_DICHIARAZIONI.NEXTVAL, '" & Format(lValoreCorrente, "0000000000") _
                            '            & "', '" & Year(Now) & "', '" & Format(Now, "yyyyMMdd") _
                            '            & "', 'Milano', '" & Format(Now, "yyyyMMdd") & "','', 1," _
                            '            & par.IfNull(myReader("ID_LUOGO_NAS_DNTE"), "NULL") _
                            '            & ", '" & par.IfNull(myReader("TELEFONO_DNTE"), "") _
                            '            & "', " & par.IfNull(myReader("ID_LUOGO_RES_DNTE"), "NULL") _
                            '            & ", " & par.IfNull(myReader("ID_TIPO_IND_RES_DNTE"), "NULL") _
                            '            & ", '" & par.PulisciStrSql(par.IfNull(myReader("IND_RES_DNTE"), "")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("CIVICO_RES_DNTE"), "")) _
                            '            & "', " & par.IfNull(myReader("N_COMP_NUCLEO"), "1") _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("N_INV_100_CON"), "0")) _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("N_INV_100_SENZA"), "0")) _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("N_INV_100_66"), "0")) _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("ID_TIPO_CAT_AB"), "NULL")) _
                            '            & ", " & par.PulisciStrSql(par.IfNull(myReader("ANNO_SIT_ECONOMICA"), "NULL")) _
                            '            & ", '" & par.PulisciStrSql(par.IfNull(myReader("LUOGO_INT_ERP"), "Milano")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("DATA_INT_ERP"), "")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("LUOGO_S"), "Milano")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("DATA_S"), "")) _
                            '            & "', " & par.PulisciStrSql(par.IfNull(myReader("PROGR_DNTE"), "0")) _
                            '            & ", '" & par.PulisciStrSql(par.IfNull(myReader("FL_GIA_TITOLARE"), "0")) _
                            '            & "', '" & par.PulisciStrSql(par.IfNull(myReader("CAP_RES_DNTE"), "NULL")) _
                            '            & "', '0', '" & SCALA & "', '" & PIANOA & "','" & ALLOGGIO _
                            '            & "', '1', '0', '0', '" & FOGLIO & "', " _
                            '            & "'" & MAPPALE & "','" & SUBALTERNO & "','" & COD_UNITA & "'," & lIndice_Bando & ", '0', " _
                            '            & "'" & Format(par.IfNull(myReader("REDDITO_ISEE"), "0"), "##,##0.00") & "', '" & CodContratto1 & "', '1', '', -1, " _
                            '            & Session.Item("ID_CAF") _
                            '            & ", 0, '0', '0', " & par.VirgoleInPunti(par.IfNull(myReader("ISE_ERP"), 0)) & ", " _
                            '            & par.VirgoleInPunti(par.IfNull(myReader("ISR_ERP"), 0)) _
                            '            & "," & par.VirgoleInPunti(par.IfNull(myReader("ISP_ERP"), 0)) _
                            '            & ", '" & par.IfNull(myReader("PSE"), "1") _
                            '            & "', '" & par.IfNull(myReader("VSE"), "1") & "', 'GENERATA AUTOMATICAMENTE', " _
                            '            & "'" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text) _
                            '            & "', '0', '0', '0', '1', " _
                            '            & "'" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) & "',1)"

                            '    par.cmd.ExecuteNonQuery()


                            '    par.cmd.CommandText = "SELECT SEQ_UTENZA_DICHIARAZIONI.CURRVAL FROM DUAL"
                            '    myReader = par.cmd.ExecuteReader()
                            '    If myReader.Read Then
                            '        lIdDichiarazioneAU = myReader(0)
                            '    End If
                            '    myReader.Close()

                            '    par.cmd.CommandText = "INSERT INTO UTENZA_EVENTI_DICHIARAZIONI (ID_PRATICA,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE) " _
                            '                & "VALUES (" & lIdDichiarazioneAU & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                            '                & "'F130','','I')"
                            '    par.cmd.ExecuteNonQuery()


                            '    Dim ID_COMPONENTE As Long = 0

                            '    par.cmd.CommandText = "SELECT * FROM COMP_NUCLEO_cambi WHERE ID_DICHIARAZIONE=" & lIdDichiarazione
                            '    myReaderD = par.cmd.ExecuteReader()
                            '    Do While myReaderD.Read
                            '        par.cmd.CommandText = "Insert into UTENZA_COMP_NUCLEO (ID, ID_DICHIARAZIONE, " _
                            '                            & "PROGR, COD_FISCALE, COGNOME, NOME, SESSO, DATA_NASCITA, " _
                            '                            & "USL, GRADO_PARENTELA, PERC_INVAL, INDENNITA_ACC) " _
                            '                            & "Values " _
                            '                            & "(SEQ_UTENZA_COMP_NUCLEO.NEXTVAL, " & lIdDichiarazioneAU _
                            '                            & "," & myReaderD("PROGR") _
                            '                            & ", '" & par.PulisciStrSql(par.IfNull(myReaderD("COD_FISCALE"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("COGNOME"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("NOME"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("SESSO"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("DATA_NASCITA"), "")) _
                            '                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderD("USL"), "")) _
                            '                            & "', " & par.PulisciStrSql(par.IfNull(myReaderD("GRADO_PARENTELA"), "0")) _
                            '                            & "," & par.VirgoleInPunti(par.IfNull(myReaderD("PERC_INVAL"), "0")) _
                            '                            & ", '" & par.PulisciStrSql(par.IfNull(myReaderD("INDENNITA_ACC"), "0")) & "')"

                            '        par.cmd.ExecuteNonQuery()
                            '        par.cmd.CommandText = "SELECT SEQ_UTENZA_COMP_NUCLEO.CURRVAL FROM DUAL"
                            '        myReader = par.cmd.ExecuteReader()
                            '        If myReader.Read Then
                            '            ID_COMPONENTE = myReader(0)
                            '        End If
                            '        myReader.Close()

                            '        par.cmd.CommandText = "SELECT * FROM COMP_ALTRI_REDDITI_cambi WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_ALTRI_REDDITI (ID, ID_COMPONENTE, IMPORTO) " _
                            '                                & "Values " _
                            '                                & "(SEQ_UTENZA_COMP_ALTRI_REDDITI.NEXTVAL, " & ID_COMPONENTE _
                            '                                & " , " & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO"), 0)) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()


                            '        par.cmd.CommandText = "SELECT * FROM COMP_DETRAZIONI_cambi WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_DETRAZIONI (ID, ID_COMPONENTE, ID_TIPO, IMPORTO) " _
                            '                      & "Values " _
                            '                      & "(SEQ_UTENZA_COMP_DETRAZIONI.NEXTVAL, " & ID_COMPONENTE _
                            '                      & "," & myReader("ID_TIPO") & ", " & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO"), 0)) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()

                            '        par.cmd.CommandText = "SELECT * FROM COMP_ELENCO_SPESE_cambi WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_ELENCO_SPESE " _
                            '                             & "(ID, ID_COMPONENTE, DESCRIZIONE, IMPORTO) " _
                            '                            & "Values " _
                            '                            & "(SEQ_UTENZA_COMP_ELENCO_SPESE.NEXTVAL, " & ID_COMPONENTE _
                            '                            & ", '" & par.PulisciStrSql(par.IfNull(myReader("DESCRIZIONE"), "")) _
                            '                            & "', " & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO"), 0)) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()

                            '        par.cmd.CommandText = "SELECT * FROM COMP_PATR_IMMOB_cambi WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_PATR_IMMOB" _
                            '                                & "(ID, ID_COMPONENTE, ID_TIPO, PERC_PATR_IMMOBILIARE, VALORE, " _
                            '                                & "MUTUO, F_RESIDENZA) " _
                            '                               & "Values " _
                            '                               & "(SEQ_UTENZA_COMP_PATR_IMMOB.NEXTVAL," & ID_COMPONENTE _
                            '                               & ", " & myReader("ID_TIPO") & ", " & par.VirgoleInPunti(myReader("PERC_PATR_IMMOBILIARE")) _
                            '                               & ", " & par.VirgoleInPunti(par.IfNull(myReader("VALORE"), 0)) _
                            '                               & ", " & par.VirgoleInPunti(par.IfNull(myReader("MUTUO"), 0)) _
                            '                               & ",'" & par.IfNull(myReader("F_RESIDENZA"), "0") & "' )"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()

                            '        par.cmd.CommandText = "SELECT * FROM COMP_PATR_MOB_cambi WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_PATR_MOB" _
                            '             & "(ID, ID_COMPONENTE, COD_INTERMEDIARIO, INTERMEDIARIO, IMPORTO, " _
                            '             & "IBAN) Values " _
                            '             & "(SEQ_UTENZA_COMP_PATR_MOB.NEXTVAL," & ID_COMPONENTE _
                            '              & ", '" & par.PulisciStrSql(par.IfNull(myReader("COD_INTERMEDIARIO"), "")) _
                            '              & "', '" & par.PulisciStrSql(par.IfNull(myReader("INTERMEDIARIO"), "")) _
                            '              & "', " & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO"), 0)) _
                            '              & ",'" & par.PulisciStrSql(par.IfNull(myReader("IBAN"), "")) & "')"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()

                            '        par.cmd.CommandText = "SELECT * FROM COMP_REDDITO_cambi WHERE ID_COMPONENTE=" & myReaderD("ID")
                            '        myReader = par.cmd.ExecuteReader()
                            '        Do While myReader.Read
                            '            par.cmd.CommandText = "Insert into UTENZA_COMP_REDDITO " _
                            '                         & "(ID, ID_COMPONENTE, REDDITO_IRPEF, PROV_AGRARI) " _
                            '                         & "Values " _
                            '                         & "(SEQ_UTENZA_COMP_REDDITO.NEXTVAL, " & ID_COMPONENTE & ", " _
                            '                         & par.VirgoleInPunti(par.IfNull(myReader("REDDITO_IRPEF"), 0)) _
                            '                         & ", " & par.VirgoleInPunti(par.IfNull(myReader("PROV_AGRARI"), 0)) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        Loop
                            '        myReader.Close()
                            '    Loop
                            '    myReaderD.Close()
                            'End If
                            'myReader.Close()
                            Generale1.Provenienza = "1"

                            par.cmd.CommandText = "UPDATE domande_bando_cambi SET ID_STATO='10',CONTRATTO_NUM='" & CodContratto1 & "',CONTRATTO_DATA='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataStipula"), TextBox).Text) & "',CONTRATTO_DATA_DEC='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) & "'  WHERE ID=" & lIdDomandaERP
                            par.cmd.ExecuteNonQuery()
                            par.cmd.CommandText = "INSERT INTO EVENTI_bandi_cambi (ID_domanda,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE,TIPO_OPERATORE,stato_pratica) " _
                                        & "VALUES (" & lIdDomandaERP & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                                        & "'F60','','I','10')"
                            par.cmd.ExecuteNonQuery()



                        End If



                        Generale1.IndiceDichiarazione = lIdDichiarazione
                        Generale1.IndiceDomanda = lIdDomandaERP
                        lIdAU = -1 ' lIdDichiarazioneAU


                        Generale1.IndiceAnagrafe = "-1" 'CStr(lIdDichiarazioneAU)


                        par.cmd.CommandText = "update siscom_mi.rapporti_utenza set id_au=" & "-1" & ",bozza='0' where id=" & lIdContratto
                        par.cmd.ExecuteNonQuery()




                    Else
                        Generale1.Provenienza = "3"
                        Generale1.IndiceDichiarazione = "-1"
                        Generale1.IndiceDomanda = "-1"
                        Generale1.IndiceAnagrafe = "-1"
                        par.cmd.CommandText = "update siscom_mi.rapporti_utenza set bozza='0' where id=" & lIdContratto
                        par.cmd.ExecuteNonQuery()
                    End If

                    Dim indiceC As String = ""

                    Dim sIdUnita As String = UnitaContratto
                    par.cmd.CommandText = "SELECT ID_UNITA FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & lIdContratto & " order by id_unita_principale asc"
                    myReader = par.cmd.ExecuteReader()
                    Do While myReader.Read
                        If indiceC = "" Then
                            indiceC = par.IfNull(myReader("ID_UNITA"), -1)
                        End If

                        par.cmd.CommandText = "UPDATE SISCOM_MI.UNITA_IMMOBILIARI SET COD_TIPO_DISPONIBILITA='OCCU' WHERE ID=" & par.IfNull(myReader("ID_UNITA"), -1)
                        par.cmd.ExecuteNonQuery()


                    Loop
                    myReader.Close()


                    'INSERIMENTO AVVISO PER CONDOMINI
                    par.cmd.CommandText = "SELECT cond_edifici.* FROM SISCOM_MI.COND_EDIFICI,SISCOM_MI.EDIFICI,SISCOM_MI.UNITA_IMMOBILIARI WHERE UNITA_IMMOBILIARI.ID=" & indiceC & " AND EDIFICI.ID=UNITA_IMMOBILIARI.ID_EDIFICIO AND COND_EDIFICI.ID_EDIFICIO=EDIFICI.ID"
                    myReader = par.cmd.ExecuteReader
                    Do While myReader.Read
                        'par.cmd.CommandText = "INSERT INTO SISCOM_MI.COND_AVVISI (ID_UI,EVENTO,DATA,VISTO,ID_CONDOMINIO) VALUES (" & UnitaContratto & ",'ATTIVAZIONE RAPPORTO','" & Format(Now, "yyyyMMdd") & "',0," & myReader("ID_CONDOMINIO") & ")"
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.COND_AVVISI (ID_TIPO,ID_UI,DATA,VISTO,ID_CONDOMINIO,ID_CONTRATTO) VALUES (4," & UnitaContratto & ",'" & Format(Now, "yyyyMMdd") & "',0," & myReader("ID_CONDOMINIO") & "," & lIdContratto & ")"
                        par.cmd.ExecuteNonQuery()
                    Loop
                    myReader.Close()



                    Tab_Contratto1.Disabilita()
                    Tab_Registrazione1.Disabilita()
                    Tab_Canone1.disattiva()
                    Tab_Conduttore1.Disabilita_Tutto()
                    btnAttivaContratto.Visible = False
                    btnStampaContratto.Visible = True
                    'btnVisStampe.Visible = True
                    ' btnVisStampe.Attributes.Add("onclick", "javascript:document.getElementById('USCITA').value='1';window.open('ElencoStampeContratti.aspx?COD=" & CodContratto & "','" & CodContratto & "','');")

                    par.cmd.CommandText = "SELECT SISCOM_MI.GETSTATOCONTRATTO(RAPPORTI_UTENZA.ID) AS ""STATO"" FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & lIdContratto
                    myReader = par.cmd.ExecuteReader()
                    If myReader.Read Then
                        LBLSTATOC.Visible = True
                        LBLSTATOC.Text = "Stato: " & UCase(par.IfNull(myReader("STATO"), ""))
                        HStatoContratto.Value = par.IfNull(myReader("STATO"), "")
                        CType(Generale1.FindControl("lblStato"), Label).Text = par.IfNull(myReader("STATO"), "")
                    End If
                    myReader.Close()


                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.UNITA_STATO_MANUTENTIVO WHERE ID_UNITA=" & UnitaContratto
                    myReader = par.cmd.ExecuteReader()
                    If myReader.Read Then

                        par.cmd.CommandText = "Insert into siscom_mi.UNITA_STATO_MAN_S" _
                                            & "(ID_UNITA, DATA_S, RILEVAZIONE, RIASSEGNABILE, P_BLINDATA, " _
                                            & "SOL_GP, SOL_GF, SOL_PB, SOL_LA, SOL_AL, " _
                                            & "HANDICAP, DATA_PRE_S, DATA_PRE_SLOGGIO, NOTE, ALLARME, " _
                                            & "MOTIVAZIONI, ZONA, NUM_LOCALI, NUM_SERVIZI, TIPO_ALLOGGIO, " _
                                            & "DATA_CONSEGNA_CHIAVI, CONSEGNATE_A, DATA_RIPRESA_CHIAVI, ID_QUARTIERE, DATA_RILEVAZIONE, " _
                                            & "NOTEGRTP, REC_GRTP, FINE_LAVORI, SOL_PB1, SOL_PB2, " _
                                            & "SOL_PB3, SOL_LA1, TIPO_RIASSEGNABILE, DATA_Q, IMPORTO_DANNI, " _
                                             & "IMPORTO_TRASPORTO, NOTE_DANNI, FL_AUTORIZZATI_IMP, FL_ABUSIVO, NOTE_TIPO_PORTA, " _
                                            & "NOTE_SICUREZZA,ID_CONTRATTO,DATA_MEMO,ST_DEP_CHIAVI,ID_STRUTTURA_COMP,DATA_CONSEGNA_STR,DATA_RIPRESA_STR)" _
                                            & " Values " _
                                            & "(" & UnitaContratto & ", '" & par.IfNull(myReader("DATA_S"), "") & "', " _
                                            & par.IfNull(myReader("RILEVAZIONE"), "0") _
                                            & "," & par.IfNull(myReader("RIASSEGNABILE"), "0") _
                                            & ",'" & par.IfNull(myReader("P_BLINDATA"), "0") _
                                            & "', " & par.IfNull(myReader("SOL_GP"), "0") _
                                            & ", " & par.IfNull(myReader("SOL_GF"), "0") _
                                            & "," & par.IfNull(myReader("SOL_PB"), "0") _
                                            & "," & par.IfNull(myReader("SOL_LA"), "0") _
                                            & "," & par.IfNull(myReader("SOL_AL"), "0") _
                                            & "," & par.IfNull(myReader("HANDICAP"), "0") _
                                            & ",'" & par.IfNull(myReader("DATA_PRE_S"), "") _
                                            & "','" & par.IfNull(myReader("DATA_PRE_SLOGGIO"), "") _
                                            & "','" & par.PulisciStrSql(par.IfNull(myReader("NOTE"), "")) _
                                            & "'," & par.IfNull(myReader("ALLARME"), "") _
                                            & ",'" & par.PulisciStrSql(par.IfNull(myReader("MOTIVAZIONI"), "")) _
                                            & "','" & par.IfNull(myReader("ZONA"), "") _
                                            & "','" & par.IfNull(myReader("NUM_LOCALI"), "") _
                                            & "','" & par.IfNull(myReader("NUM_SERVIZI"), "") _
                                            & "'," & par.IfNull(myReader("TIPO_ALLOGGIO"), "NULL") _
                                            & ",'" & par.IfNull(myReader("DATA_CONSEGNA_CHIAVI"), "") _
                                            & "','" & par.PulisciStrSql(par.IfNull(myReader("CONSEGNATE_A"), "")) _
                                            & "','" & par.IfNull(myReader("DATA_RIPRESA_CHIAVI"), "") _
                                            & "'," & par.IfNull(myReader("ID_QUARTIERE"), "NULL") _
                                            & ",'" & par.IfNull(myReader("DATA_RILEVAZIONE"), "") _
                                            & "','" & par.PulisciStrSql(par.IfNull(myReader("NOTEGRTP"), "")) _
                                            & "'," & par.IfNull(myReader("REC_GRTP"), "0") _
                                            & "," & par.IfNull(myReader("FINE_LAVORI"), "0") _
                                            & "," & par.IfNull(myReader("SOL_PB1"), "0") _
                                            & "," & par.IfNull(myReader("SOL_PB2"), "0") _
                                            & "," & par.IfNull(myReader("SOL_PB3"), "0") _
                                            & "," & par.IfNull(myReader("SOL_LA1"), "") _
                                            & "," & par.IfNull(myReader("TIPO_RIASSEGNABILE"), "0") _
                                            & ",'" & par.IfNull(myReader("DATA_Q"), "") _
                                            & "'," & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO_DANNI"), "0")) _
                                            & "," & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO_TRASPORTo"), "0")) _
                                            & ",'" & par.PulisciStrSql(par.IfNull(myReader("NOTE_DANNI"), "")) _
                                            & "','" & par.IfNull(myReader("FL_AUTORIZZATI_IMP"), "0") _
                                            & "','" & par.IfNull(myReader("FL_ABUSIVO"), "0") _
                                            & "','" & par.PulisciStrSql(par.IfNull(myReader("NOTE_TIPO_PORTA"), "")) _
                                            & "','" & par.PulisciStrSql(par.IfNull(myReader("NOTE_SICUREZZA"), "")) _
                                            & "'," & lIdContratto & ",'" & Format(Now, "yyyyMMdd") & "'," & par.IfNull(myReader("ST_DEP_CHIAVI"), "0") & "," _
                                            & par.IfNull(myReader("ID_STRUTTURA_COMP"), "NULL") & ",'" & par.IfNull(myReader("DATA_CONSEGNA_STR"), "") & "','" _
                                            & par.IfNull(myReader("DATA_RIPRESA_STR"), "") & "')"



                        'par.cmd.CommandText = "Insert into SISCOM_MI.UNITA_STATO_MAN_S (ID_UNITA, DATA_S, RILEVAZIONE, RIASSEGNABILE, " _
                        '             & "P_BLINDATA, SOL_GP, SOL_GF, SOL_PB, SOL_LA, SOL_AL, HANDICAP, DATA_PRE_S, DATA_PRE_SLOGGIO, " _
                        '             & "NOTE, ID_CONTRATTO, DATA_MEMO,ALLARME,MOTIVAZIONI,ZONA,NUM_LOCALI,NUM_SERVIZI,TIPO_ALLOGGIO,DATA_CONSEGNA_CHIAVI,CONSEGNATE_A,DATA_RIPRESA_CHIAVI) Values  (" & UnitaContratto & ", '" & par.IfNull(myReader("DATA_S"), "") _
                        '             & "', " & par.IfNull(myReader("RILEVAZIONE"), 0) & ", " _
                        '             & par.IfNull(myReader("RIASSEGNABILE"), 0) & ", " & par.IfNull(myReader("P_BLINDATA"), 0) _
                        '             & ", " & par.IfNull(myReader("SOL_GP"), 0) & ", " & par.IfNull(myReader("SOL_GF"), 0) _
                        '             & ", " & par.IfNull(myReader("SOL_PB"), 0) & ", " & par.IfNull(myReader("SOL_LA"), 0) _
                        '             & ", " & par.IfNull(myReader("SOL_AL"), 0) & ", " & par.IfNull(myReader("HANDICAP"), 0) _
                        '             & ", '" & par.IfNull(myReader("DATA_PRE_S"), "") _
                        '             & "', '" & par.IfNull(myReader("DATA_PRE_SLOGGIO"), "") _
                        '             & "', '" & par.PulisciStrSql(par.IfNull(myReader("NOTE"), "")) _
                        '             & "', " & lIdContratto & " ,'" & Format(Now, "yyyyMMdd") & "'," & par.IfNull(myReader("ALLARME"), 0) _
                        '             & ",'" & par.PulisciStrSql(par.IfNull(myReader("MOTIVAZIONI"), "")) & "','" & par.PulisciStrSql(par.IfNull(myReader("ZONA"), "")) & "','" & par.PulisciStrSql(par.IfNull(myReader("NUM_LOCALI"), "")) & "','" & par.PulisciStrSql(par.IfNull(myReader("NUM_SERVIZI"), "")) & "'," & par.IfNull(myReader("TIPO_ALLOGGIO"), "NULL") & ",'" & par.PulisciStrSql(par.IfNull(myReader("DATA_CONSEGNA_CHIAVI"), "")) & "','" & par.PulisciStrSql(par.IfNull(myReader("CONSEGNATE_A"), "")) & "','" & par.PulisciStrSql(par.IfNull(myReader("DATA_RIPRESA_CHIAVI"), "")) & "')"
                        par.cmd.ExecuteNonQuery()
                    End If
                    myReader.Close()

                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.UNITA_STATO_MANUTENTIVO_INT WHERE ID_UNITA=" & UnitaContratto
                    myReader = par.cmd.ExecuteReader()
                    Do While myReader.Read
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.UNITA_STATO_MAN_INT_S (ID_UNITA,ID_INTERVENTO,DATA_MEMO) VALUES (" & UnitaContratto & "," & myReader("ID_INTERVENTO") & ",'" & Format(Now, "yyyyMMdd") & "')"
                        par.cmd.ExecuteNonQuery()
                    Loop
                    myReader.Close()


                    par.cmd.CommandText = "delete from siscom_mi.unita_STATO_MANUTENTIVO where id_unita=" & UnitaContratto
                    par.cmd.ExecuteNonQuery()

                    par.cmd.CommandText = "update alloggi set data_disponibilita='' where cod_alloggio='" & Mid(CodContratto1, 1, 17) & "'"
                    par.cmd.ExecuteNonQuery()


                    par.myTrans.Commit()
                    'par.myTrans.Rollback()
                    par.myTrans = par.OracleConn.BeginTransaction()
                    HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)

                    txtModificato.Value = "0"
                    If TipoContratto <> "3" And TipoContratto <> "7" Then
                        Response.Write("<script>alert('Il contratto è stato Attivato regolarmente!\nInoltre, facendo click sul pulsante -Anagrafe Utenza- sarà possibile visualizzare la scheda appena creata.');</script>")
                    Else
                        Response.Write("<script>alert('Il contratto è stato Attivato regolarmente!');</script>")
                    End If
                    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                Else
                    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                    txtModificato.Value = "0"
                End If
            Else
                txtModificato.Value = "0"
                CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                par.myTrans.Commit()
                par.myTrans = par.OracleConn.BeginTransaction()
                HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)
                Response.Write("<script>alert('Non è possibile attivare il contratto.\nSi ricorda che la data del provvedimento e la data di trasmissione del provvedimento devono essere inferiore alla data odierna.');</script>")
            End If

        Catch ex As Exception
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Sub


    Protected Sub btnStampaContratto_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs) Handles btnStampaContratto.Click
        CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"

        If txtModificato.Value <> "111" Then
            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans

            If HStatoContratto.Value = "BOZZA" Then

            par.cmd.CommandText = "select * from SISCOM_MI.unita_stato_manutentivo where id_unita=" & UnitaContratto
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                If par.IfNull(myReader("riassegnabile"), "0") = "0" Or par.IfNull(myReader("tipo_riassegnabile"), "2") = "2" Or par.IfNull(myReader("tipo_riassegnabile"), "2") = "0" Then
                    Response.Write("<script>alert('Attenzione...non è possibile procedere con la stampa perchè l\'unità è INAGIBILE o NON RIASSEGNABILE o CI SONO LAVORI IN CORSO, secondo quanto descritto nell\'ultima verifica dello stato manutentivo!');</script>")
                    TXTATTIVA.Value = "0"
                    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                    myReader.Close()
                    Exit Sub

                End If
            End If
            myReader.Close()

            'verifico se il bollettino n.1 è stato emesso
            par.cmd.CommandText = "select * from SISCOM_MI.BOL_BOLLETTE where ID_BOLLETTA_STORNO IS NULL AND ID_TIPO IN (9,10) AND ID_contratto=" & lIdContratto
            myReader = par.cmd.ExecuteReader()
            If myReader.HasRows = False Then
                Response.Write("<script>alert('Attenzione...non è possibile procedere con la stampa perchè il Bollettino N.1 non è stato emesso!');</script>")
                TXTATTIVA.Value = "0"
                CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                myReader.Close()
                Exit Sub
            End If
            myReader.Close()

            If CDbl(CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text) <> 0 And CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Value = "Y" Then
                Response.Write("<script>alert('Attenzione...Canone di locazione non compatibile con la tipologia di contratto specificata. Il canone deve essere pari a 0 euro!');</script>")
                TXTATTIVA.Value = "0"
                CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                myReader.Close()
                Exit Sub
            End If
            End If


            Select Case TipoContratto
                Case "1", "2" 'erp
                    If LetteraERP = "A" Then
                        Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=" & TipoContratto & "&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                        Generale1.Provenienza = TipoContratto
                        Generale1.IndiceDichiarazione = lIdDichiarazione
                        Generale1.IndiceDomanda = lIdDomandaERP
                        Generale1.IndiceAnagrafe = lIdAU
                    Else
                        Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=ERPB&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                        Generale1.Provenienza = TipoContratto
                        Generale1.IndiceDichiarazione = lIdDichiarazione
                        Generale1.IndiceDomanda = lIdDomandaERP
                        Generale1.IndiceAnagrafe = lIdAU
                    End If
                Case "12"
                    Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=" & TipoContratto & "&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                    Generale1.Provenienza = TipoContratto
                    Generale1.IndiceDichiarazione = -1
                    Generale1.IndiceDomanda = -1
                    Generale1.IndiceAnagrafe = -1
                Case "10" 'forze dell'oredine
                    Dim d As String = ""
                    If Mid(CType(Tab_Canone1.FindControl("label4"), Label).Text, 1, 35) = "E' STATO APPLICATO IL CANONE 431/98" Then
                        d = "1"
                    End If

                    If LetteraERP = "A" Then

                        Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?D=" & d & "&C=" & lblContratto.Text & "&T=" & TipoContratto & "&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                        Generale1.Provenienza = TipoContratto
                        Generale1.IndiceDichiarazione = lIdDichiarazione
                        Generale1.IndiceDomanda = lIdDomandaERP
                        Generale1.IndiceAnagrafe = lIdAU
                    Else
                        Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?D=" & d & "&C=" & lblContratto.Text & "&T=ERPB&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                        Generale1.Provenienza = TipoContratto
                        Generale1.IndiceDichiarazione = lIdDichiarazione
                        Generale1.IndiceDomanda = lIdDomandaERP
                        Generale1.IndiceAnagrafe = lIdAU
                    End If

                Case "6" '431/98
                    'Stampa431()
                    Select Case CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Value
                        Case "C"
                            Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=61&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            Generale1.Provenienza = TipoContratto
                            Generale1.IndiceDichiarazione = -1
                            Generale1.IndiceDomanda = -1
                            Generale1.IndiceAnagrafe = -1
                        Case "P"
                            Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=62&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            Generale1.Provenienza = TipoContratto
                            Generale1.IndiceDichiarazione = -1
                            Generale1.IndiceDomanda = -1
                            Generale1.IndiceAnagrafe = -1
                        Case "S"
                            Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=63&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            Generale1.Provenienza = TipoContratto
                            Generale1.IndiceDichiarazione = -1
                            Generale1.IndiceDomanda = -1
                            Generale1.IndiceAnagrafe = -1
                        Case "D"
                            Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=64&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            Generale1.Provenienza = TipoContratto
                            Generale1.IndiceDichiarazione = -1
                            Generale1.IndiceDomanda = -1
                            Generale1.IndiceAnagrafe = -1
                        Case "V"
                            Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=65&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            Generale1.Provenienza = TipoContratto
                            Generale1.IndiceDichiarazione = -1
                            Generale1.IndiceDomanda = -1
                            Generale1.IndiceAnagrafe = -1
                        Case Else
                            Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=" & TipoContratto & "&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            Generale1.Provenienza = TipoContratto
                            Generale1.IndiceDichiarazione = -1
                            Generale1.IndiceDomanda = -1
                            Generale1.IndiceAnagrafe = -1
                    End Select

                Case "3"
                    Select Case CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Value
                        Case "B"
                            Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=" & "BOX" & "&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            Generale1.IndiceDichiarazione = -1
                            Generale1.IndiceDomanda = -1
                            Generale1.IndiceAnagrafe = -1
                        Case "N"
                            Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=" & "NEGOZI" & "&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            Generale1.IndiceDichiarazione = -1
                            Generale1.IndiceDomanda = -1
                            Generale1.IndiceAnagrafe = -1
                        Case "X" 'CONCESSIONE SPAZI P.
                            Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=" & "CONCESSIONE" & "&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            Generale1.IndiceDichiarazione = -1
                            Generale1.IndiceDomanda = -1
                            Generale1.IndiceAnagrafe = -1
                        Case "Y" 'comodato uso gratuito
                            Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=" & "COMODATO" & "&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            Generale1.IndiceDichiarazione = -1
                            Generale1.IndiceDomanda = -1
                            Generale1.IndiceAnagrafe = -1

                            'Case "2" 'CONCESSIONE IMPRESE
                            '    Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=" & "CONCESSIONE" & "&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            '    Generale1.IndiceDichiarazione = -1
                            '    Generale1.IndiceDomanda = -1
                            '    Generale1.IndiceAnagrafe = -1
                            'Case "3" 'CONCESSIONE ASSOCIAZIONI
                            '    Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=" & "CONCESSIONE" & "&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            '    Generale1.IndiceDichiarazione = -1
                            '    Generale1.IndiceDomanda = -1
                            '    Generale1.IndiceAnagrafe = -1
                        Case Else
                            Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=" & TipoContratto & "&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            Generale1.IndiceDichiarazione = -1
                            Generale1.IndiceDomanda = -1
                            Generale1.IndiceAnagrafe = -1
                    End Select
                Case "5"
                    Select Case CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Value
                        Case "A"
                            Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=" & "392ASS" & "&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            Generale1.IndiceDichiarazione = -1
                            Generale1.IndiceDomanda = -1
                            Generale1.IndiceAnagrafe = -1

                        Case Else
                            'Response.Write("<script>win=window.open('../GestioneModelli/ModificaContratto.aspx?C=" & lblContratto.Text & "&T=" & TipoContratto & "&ID=" & lIdContratto & "&V=" & lIdConnessione & "&U=" & par.Cripta(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text) & "','Modifica','top=300,left=300,resizable=yes,scrollbars=yes');win.focus();</script>")
                            'Generale1.IndiceDichiarazione = -1
                            'Generale1.IndiceDomanda = -1
                            'Generale1.IndiceAnagrafe = -1
                            Response.Write("<script>alert('Stampa non supportata!');</script>")
                    End Select

            End Select
        End If
        'If TipoContratto = "1" Then
        '    'StampaERP()
        '    'Generale1.Provenienza = TipoContratto
        '    'Generale1.IndiceDichiarazione = lIdDichiarazione
        '    'Generale1.IndiceDomanda = lIdDomandaERP
        '    'Generale1.IndiceAnagrafe = lIdAU
        'Else
        '    Select Case CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Value
        '        Case "B"
        '            StampaBox()
        '    End Select
        'End If

    End Sub

    Private Function StampaBox()
        Dim Conduttore As String = ""
        Dim Locatari As String = ""
        Dim protocollo As String = ""
        Dim Delibera As String = ""
        Dim DataDelibera As String = ""
        Dim direttore As String = ""
        Dim sedelocatore As String = ""
        Dim indirizzoalloggio As String = ""


        Dim locatore As String = ""
        Dim cflocatore As String = ""

        Dim NomeFile As String = ""
        Dim Titolo As String = ""

        Dim i As Integer
        Try
            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans



            NomeFile = CType(Tab_Contratto1.FindControl("txtCodContratto"), TextBox).Text & "_" & Format(Now, "yyyyMMddHHmmss")

            'apro e memorizzo il testo base del contratto

            Dim sr1 As StreamReader = New StreamReader(Server.MapPath("..\TestoModelli\BOX.htm"), System.Text.Encoding.GetEncoding("iso-8859-1"))

            Dim contenuto As String = sr1.ReadToEnd()
            sr1.Close()

            'inizio a ricavare tutti i dati per la compilazione del contratto!
            protocollo = CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Text
            DataDelibera = CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text
            Delibera = CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Text


            indirizzoalloggio = CType(Generale1.FindControl("lblIndirizzo"), Label).Text
            'Milano (MI) Piazzale Dateo 5

            par.cmd.CommandText = "SELECT * from siscom_mi.parametri_bolletta where id=8"
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                locatore = par.IfNull(myReader("valore"), "")
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * from siscom_mi.parametri_bolletta where id=10"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                cflocatore = par.IfNull(myReader("valore"), "")
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * from siscom_mi.parametri_bolletta where id=9"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                direttore = par.IfNull(myReader("valore"), "")
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * from siscom_mi.parametri_bolletta where id=11"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                sedelocatore = par.IfNull(myReader("valore"), "")
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * from siscom_mi.parametri_bolletta where id=19"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                sedelocatore = sedelocatore & " (" & par.IfNull(myReader("valore"), "") & ") "
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * from siscom_mi.parametri_bolletta where id=20"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                sedelocatore = sedelocatore & par.IfNull(myReader("valore"), "") & " "
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * from siscom_mi.parametri_bolletta where id=21"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                sedelocatore = sedelocatore & par.IfNull(myReader("valore"), "") & " "
            End If
            myReader.Close()


            par.cmd.CommandText = "SELECT ANAGRAFICA.*,comuni_nazioni.nome as ""comune_nascita"",comuni_nazioni.sigla FROM sepa.comuni_nazioni,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE comuni_nazioni.cod=anagrafica.cod_comune_nascita and  SOGGETTI_CONTRATTUALI.ID_CONTRATTO=" & lIdContratto & " AND SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='INTE' AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA"
            Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            i = 0
            Do While myReader1.Read
                If par.IfNull(myReader1("sesso"), "M") = "M" Then
                    Conduttore = Conduttore & "il Sig. " & par.IfNull(myReader1("cognome"), "") & " " & par.IfNull(myReader1("nome"), " ") & " nato a " & par.IfNull(myReader1("comune_nascita"), "") & " (" & par.IfNull(myReader1("sigla"), "") & ") il " & par.FormattaData(par.IfNull(myReader1("data_nascita"), "")) & " e residente in " & par.IfNull(myReader1("residenza"), "") & " c.f. " & par.IfNull(myReader1("cod_fiscale"), "") & ", "
                    Titolo = "al Sig. "
                Else
                    Conduttore = Conduttore & "la Sig.ra " & par.IfNull(myReader1("cognome"), "") & " " & par.IfNull(myReader1("nome"), " ") & " nata a " & par.IfNull(myReader1("comune_nascita"), "") & " (" & par.IfNull(myReader1("sigla"), "") & ") il " & par.FormattaData(par.IfNull(myReader1("data_nascita"), "")) & " e residente in " & par.IfNull(myReader1("residenza"), "") & " c.f. " & par.IfNull(myReader1("cod_fiscale"), "") & ", "
                    Titolo = "alla Sig./ra "
                End If

                Locatari = Locatari & par.IfNull(myReader1("cognome"), "") & " " & par.IfNull(myReader1("nome"), " ") & ","
                i = i + 1
            Loop
            myReader1.Close()
            If Conduttore = "" Then
                Response.Write("<script>alert('ERRORE, i dati anagrafici del conduttori non sono completi!');</script>")
            End If

            If i > 1 Then
                Titolo = "ai sig./ri "
            End If
            Locatari = Titolo & Mid(Locatari, 1, Len(Locatari) - 1)

            Dim SUP_UTILE_NETTA As Double = 0
            Dim SUP_BALCONI As Double = 0
            Dim SUP_ESCLUSIVA As Double = 0
            Dim VAL_MILLESIMO As Double = 0
            Dim NUM_VANI As Double = 0
            Dim SUP_VERDE As Double = 0
            Dim STRINGA_SUP As String = ""


            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE WHERE COD_TIPOLOGIA='SUP_NETTA' AND ID_CONTRATTO=" & lIdContratto & " AND ID_UNITA=" & UnitaContratto
            myReader1 = par.cmd.ExecuteReader()
            Do While myReader1.Read
                SUP_UTILE_NETTA = SUP_UTILE_NETTA + CDbl(par.IfNull(myReader1("VALORE"), 0))
            Loop
            myReader1.Close()

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE WHERE (COD_TIPOLOGIA='SUSCO' OR COD_TIPOLOGIA='VESCL') AND ID_CONTRATTO=" & lIdContratto & " AND ID_UNITA=" & UnitaContratto
            myReader1 = par.cmd.ExecuteReader()
            Do While myReader1.Read
                SUP_ESCLUSIVA = SUP_ESCLUSIVA + CDbl(par.IfNull(myReader1("VALORE"), 0))
            Loop
            myReader1.Close()

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE WHERE COD_TIPOLOGIA='BALCONI' AND ID_CONTRATTO=" & lIdContratto & " AND ID_UNITA=" & UnitaContratto
            myReader1 = par.cmd.ExecuteReader()
            Do While myReader1.Read
                SUP_BALCONI = SUP_BALCONI + CDbl(par.IfNull(myReader1("VALORE"), 0))
            Loop
            myReader1.Close()

            par.cmd.CommandText = "SELECT DIMENSIONI_UNITA_CONTRATTUALE.* FROM SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE,siscom_mi.unita_contrattuale WHERE DIMENSIONI_UNITA_CONTRATTUALE.COD_TIPOLOGIA='SUP_NETTA' AND UNITA_CONTRATTUALE.ID_CONTRATTO=" & lIdContratto & " AND UNITA_CONTRATTUALE.ID_UNITA_principale=" & UnitaContratto & " and DIMENSIONI_UNITA_CONTRATTUALE.id_contratto=UNITA_CONTRATTUALE.id_contratto and DIMENSIONI_UNITA_CONTRATTUALE.id_unita=UNITA_CONTRATTUALE.id_unita"
            myReader1 = par.cmd.ExecuteReader()
            Do While myReader1.Read
                SUP_BALCONI = SUP_BALCONI + CDbl(par.IfNull(myReader1("VALORE"), 0))
            Loop
            myReader1.Close()

            par.cmd.CommandText = "SELECT NUM_VANI FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & lIdContratto & " AND ID_UNITA=" & UnitaContratto
            myReader1 = par.cmd.ExecuteReader()
            Do While myReader1.Read
                NUM_VANI = NUM_VANI + CDbl(par.IfNull(myReader1("NUM_VANI"), 0))
            Loop
            myReader1.Close()

            par.cmd.CommandText = "SELECT DIMENSIONI_UNITA_CONTRATTUALE.* FROM SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE,siscom_mi.unita_contrattuale WHERE DIMENSIONI_UNITA_CONTRATTUALE.COD_TIPOLOGIA='SUVEC' AND UNITA_CONTRATTUALE.ID_CONTRATTO=" & lIdContratto & " AND UNITA_CONTRATTUALE.ID_UNITA_principale=" & UnitaContratto & " and DIMENSIONI_UNITA_CONTRATTUALE.id_contratto=UNITA_CONTRATTUALE.id_contratto and DIMENSIONI_UNITA_CONTRATTUALE.id_unita=UNITA_CONTRATTUALE.id_unita"
            myReader1 = par.cmd.ExecuteReader()
            Do While myReader1.Read
                SUP_VERDE = SUP_VERDE + CDbl(par.IfNull(myReader1("VALORE"), 0))
            Loop
            myReader1.Close()

            If SUP_UTILE_NETTA > 0 Then
                STRINGA_SUP = SUP_UTILE_NETTA & " (Sup. Utile Netta), "
            End If

            If SUP_BALCONI > 0 Then
                STRINGA_SUP = STRINGA_SUP & "mq " & SUP_BALCONI & " (Balconi,Terrezze,Cantine e Simili), "
            End If

            If SUP_ESCLUSIVA > 0 Then
                STRINGA_SUP = STRINGA_SUP & " mq " & SUP_ESCLUSIVA & " (Sup.scoperta uso escl.), "
            End If

            If SUP_VERDE > 0 Then
                STRINGA_SUP = STRINGA_SUP & " mq " & SUP_VERDE & " (Sup.Condominiale a verde), "
            End If
            If NUM_VANI > 0 Then
                STRINGA_SUP = STRINGA_SUP & "num. vani conv. " & NUM_VANI & " "
            End If

            'sostituisco i segnaposto
            contenuto = Replace(contenuto, "$suputile$", STRINGA_SUP)
            contenuto = Replace(contenuto, "$scadenza$", CType(Generale1.FindControl("lblScadenza"), Label).Text)
            contenuto = Replace(contenuto, "$decorrenza$", CType(Generale1.FindControl("lblDecorrenza"), Label).Text)
            contenuto = Replace(contenuto, "$durata$", CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).Text)
            contenuto = Replace(contenuto, "$durataRinnovo$", CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).Text)
            contenuto = Replace(contenuto, "$giornidisdetta$", par.IfEmpty(CType(Tab_Contratto1.FindControl("txtEntroCuiDisdettare"), TextBox).Text, 0) * 30)

            contenuto = Replace(contenuto, "$canoneiniziale$", Format(CDbl(CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text), "##,##0.00"))
            'contenuto = Replace(contenuto, "$anticipo$", Format(CDbl(CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text), "##,##0.00"))
            contenuto = Replace(contenuto, "$anticipo$", "0,00")


            contenuto = Replace(contenuto, "$classe$", sClasse)
            contenuto = Replace(contenuto, "$rendita$", sRendita)
            contenuto = Replace(contenuto, "$catcatastale$", sCatastale)
            contenuto = Replace(contenuto, "$subalterno$", sSub)
            contenuto = Replace(contenuto, "$foglio$", sFoglio)
            contenuto = Replace(contenuto, "$particella$", sParticella)


            contenuto = Replace(contenuto, "$interno$", sInterno)
            contenuto = Replace(contenuto, "$scala$", sSCALA)
            contenuto = Replace(contenuto, "$piano$", sPiano)
            contenuto = Replace(contenuto, "$indirizzoalloggio$", indirizzoalloggio)
            contenuto = Replace(contenuto, "$sedelocatore$", sedelocatore)
            contenuto = Replace(contenuto, "$direttore$", direttore)
            contenuto = Replace(contenuto, "$locatore$", locatore)
            contenuto = Replace(contenuto, "$cflocatore$", cflocatore)
            contenuto = Replace(contenuto, "$datadelibera$", DataDelibera)
            contenuto = Replace(contenuto, "$delibera$", Delibera)
            contenuto = Replace(contenuto, "$protocollo$", protocollo)
            contenuto = Replace(contenuto, "$DatiIntestatari$", Conduttore)
            contenuto = Replace(contenuto, "$Locatari$", Locatari)

            'scrivo il nuovo contratto compilato
            Dim sr As StreamWriter = New StreamWriter(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeContratti\") & NomeFile & ".htm", False, System.Text.Encoding.Default)
            sr.WriteLine(contenuto)
            sr.Close()

            par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                    & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                    & "'F03','')"
            par.cmd.ExecuteNonQuery()

            par.myTrans.Commit()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)


            Dim url As String = NomeFile
            Dim pdfConverter As PdfConverter = New PdfConverter
            ''pdfConverter.LicenseKey = "P38cBx6AWW7b9c81TjEGxnrazP+J7rOjs+9omJ3TUycauK+cL WdrITM5T59hdW5r"
            pdfConverter.PdfDocumentOptions.PdfPageSize = PdfPageSize.A4
            pdfConverter.PdfDocumentOptions.PdfCompressionLevel = PdfCompressionLevel.NoCompression
            pdfConverter.PdfDocumentOptions.ShowHeader = False
            pdfConverter.PdfDocumentOptions.ShowFooter = False
            pdfConverter.PdfDocumentOptions.LeftMargin = 70
            pdfConverter.PdfDocumentOptions.RightMargin = 70
            pdfConverter.PdfDocumentOptions.TopMargin = 21
            pdfConverter.PdfDocumentOptions.BottomMargin = 21
            pdfConverter.PdfDocumentOptions.GenerateSelectablePdf = True

            pdfConverter.PdfDocumentOptions.ShowHeader = False
            pdfConverter.PdfFooterOptions.FooterText = ("")
            pdfConverter.PdfFooterOptions.FooterTextColor = Color.Blue
            pdfConverter.PdfFooterOptions.DrawFooterLine = False
            pdfConverter.PdfFooterOptions.PageNumberText = ""
            pdfConverter.PdfFooterOptions.ShowPageNumber = False

            pdfConverter.SavePdfFromUrlToFile(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeContratti\") & NomeFile & ".htm", Server.MapPath("..\ALLEGATI\CONTRATTI\StampeContratti\") & NomeFile & ".pdf")
            'pdfConverter.SavePdfFromUrlToFile(Server.MapPath("StampeContratti\posto_auto.xml"), Server.MapPath("StampeContratti\") & NomeFile & ".pdf")

            Response.Write("<script>window.open('../ALLEGATI/CONTRATTI/StampeContratti/" & NomeFile & ".pdf" & "','Contratto','');</script>")

            System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeContratti\") & NomeFile & ".htm")

        Catch ex As Exception
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")

        End Try
    End Function


    Private Function StampaERP()
        Dim Conduttore As String = ""
        Dim Locatari As String = ""
        Dim protocollo As String = ""
        Dim Delibera As String = ""
        Dim DataDelibera As String = ""
        Dim direttore As String = ""
        Dim sedelocatore As String = ""
        Dim indirizzoalloggio As String = ""


        Dim locatore As String = ""
        Dim cflocatore As String = ""

        Dim NomeFile As String = ""
        Dim Titolo As String = ""

        Dim i As Integer
        Try
            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans



            NomeFile = CType(Tab_Contratto1.FindControl("txtCodContratto"), TextBox).Text & "_" & Format(Now, "yyyyMMddHHmmss")

            'apro e memorizzo il testo base del contratto

            Dim sr1 As StreamReader = New StreamReader(Server.MapPath("..\TestoModelli\ERP_LR27.htm"), System.Text.Encoding.GetEncoding("iso-8859-1"))

            Dim contenuto As String = sr1.ReadToEnd()
            sr1.Close()

            'inizio a ricavare tutti i dati per la compilazione del contratto!
            protocollo = CType(Tab_Registrazione1.FindControl("txtNumAssegnPg"), TextBox).Text
            DataDelibera = CType(Tab_Contratto1.FindControl("txtDataDelibera"), TextBox).Text
            Delibera = CType(Tab_Contratto1.FindControl("txtDelibera"), TextBox).Text


            indirizzoalloggio = CType(Generale1.FindControl("lblIndirizzo"), Label).Text
            'Milano (MI) Piazzale Dateo 5

            par.cmd.CommandText = "SELECT * from siscom_mi.parametri_bolletta where id=8"
            Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                locatore = par.IfNull(myReader("valore"), "")
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * from siscom_mi.parametri_bolletta where id=10"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                cflocatore = par.IfNull(myReader("valore"), "")
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * from siscom_mi.parametri_bolletta where id=9"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                direttore = par.IfNull(myReader("valore"), "")
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * from siscom_mi.parametri_bolletta where id=11"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                sedelocatore = par.IfNull(myReader("valore"), "")
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * from siscom_mi.parametri_bolletta where id=19"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                sedelocatore = sedelocatore & " (" & par.IfNull(myReader("valore"), "") & ") "
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * from siscom_mi.parametri_bolletta where id=20"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                sedelocatore = sedelocatore & par.IfNull(myReader("valore"), "") & " "
            End If
            myReader.Close()

            par.cmd.CommandText = "SELECT * from siscom_mi.parametri_bolletta where id=21"
            myReader = par.cmd.ExecuteReader()
            If myReader.Read Then
                sedelocatore = sedelocatore & par.IfNull(myReader("valore"), "") & " "
            End If
            myReader.Close()


            par.cmd.CommandText = "SELECT ANAGRAFICA.*,comuni_nazioni.nome as ""comune_nascita"",comuni_nazioni.sigla FROM sepa.comuni_nazioni,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE comuni_nazioni.cod=anagrafica.cod_comune_nascita and  SOGGETTI_CONTRATTUALI.ID_CONTRATTO=" & lIdContratto & " AND SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='INTE' AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA"
            Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            i = 0
            Do While myReader1.Read
                If par.IfNull(myReader1("sesso"), "M") = "M" Then
                    Conduttore = Conduttore & "il Sig. " & par.IfNull(myReader1("cognome"), "") & " " & par.IfNull(myReader1("nome"), " ") & " nato a " & par.IfNull(myReader1("comune_nascita"), "") & " (" & par.IfNull(myReader1("sigla"), "") & ") il " & par.FormattaData(par.IfNull(myReader1("data_nascita"), "")) & " e residente in " & par.IfNull(myReader1("residenza"), "") & " c.f. " & par.IfNull(myReader1("cod_fiscale"), "") & ", "
                    Titolo = "al Sig. "
                Else
                    Conduttore = Conduttore & "la Sig.ra " & par.IfNull(myReader1("cognome"), "") & " " & par.IfNull(myReader1("nome"), " ") & " nata a " & par.IfNull(myReader1("comune_nascita"), "") & " (" & par.IfNull(myReader1("sigla"), "") & ") il " & par.FormattaData(par.IfNull(myReader1("data_nascita"), "")) & " e residente in " & par.IfNull(myReader1("residenza"), "") & " c.f. " & par.IfNull(myReader1("cod_fiscale"), "") & ", "
                    Titolo = "alla Sig./ra "
                End If

                Locatari = Locatari & par.IfNull(myReader1("cognome"), "") & " " & par.IfNull(myReader1("nome"), " ") & ","
                i = i + 1
            Loop
            myReader1.Close()
            If Conduttore = "" Then
                Response.Write("<script>alert('ERRORE, i dati anagrafici del conduttori non sono completi!');</script>")
            End If

            If i > 1 Then
                Titolo = "ai sig./ri "
            End If
            Locatari = Titolo & Mid(Locatari, 1, Len(Locatari) - 1)

            Dim SUP_UTILE_NETTA As Double = 0
            Dim SUP_BALCONI As Double = 0
            Dim SUP_ESCLUSIVA As Double = 0
            Dim VAL_MILLESIMO As Double = 0
            Dim NUM_VANI As Double = 0
            Dim SUP_VERDE As Double = 0
            Dim STRINGA_SUP As String = ""


            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE WHERE COD_TIPOLOGIA='SUP_NETTA' AND ID_CONTRATTO=" & lIdContratto & " AND ID_UNITA=" & UnitaContratto
            myReader1 = par.cmd.ExecuteReader()
            Do While myReader1.Read
                SUP_UTILE_NETTA = SUP_UTILE_NETTA + CDbl(par.IfNull(myReader1("VALORE"), 0))
            Loop
            myReader1.Close()

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE WHERE (COD_TIPOLOGIA='SUSCO' OR COD_TIPOLOGIA='VESCL') AND ID_CONTRATTO=" & lIdContratto & " AND ID_UNITA=" & UnitaContratto
            myReader1 = par.cmd.ExecuteReader()
            Do While myReader1.Read
                SUP_ESCLUSIVA = SUP_ESCLUSIVA + CDbl(par.IfNull(myReader1("VALORE"), 0))
            Loop
            myReader1.Close()

            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE WHERE COD_TIPOLOGIA='BALCONI' AND ID_CONTRATTO=" & lIdContratto & " AND ID_UNITA=" & UnitaContratto
            myReader1 = par.cmd.ExecuteReader()
            Do While myReader1.Read
                SUP_BALCONI = SUP_BALCONI + CDbl(par.IfNull(myReader1("VALORE"), 0))
            Loop
            myReader1.Close()

            par.cmd.CommandText = "SELECT DIMENSIONI_UNITA_CONTRATTUALE.* FROM SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE,siscom_mi.unita_contrattuale WHERE DIMENSIONI_UNITA_CONTRATTUALE.COD_TIPOLOGIA='SUP_NETTA' AND UNITA_CONTRATTUALE.ID_CONTRATTO=" & lIdContratto & " AND UNITA_CONTRATTUALE.ID_UNITA_principale=" & UnitaContratto & " and DIMENSIONI_UNITA_CONTRATTUALE.id_contratto=UNITA_CONTRATTUALE.id_contratto and DIMENSIONI_UNITA_CONTRATTUALE.id_unita=UNITA_CONTRATTUALE.id_unita"
            myReader1 = par.cmd.ExecuteReader()
            Do While myReader1.Read
                SUP_BALCONI = SUP_BALCONI + CDbl(par.IfNull(myReader1("VALORE"), 0))
            Loop
            myReader1.Close()

            par.cmd.CommandText = "SELECT NUM_VANI FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & lIdContratto & " AND ID_UNITA=" & UnitaContratto
            myReader1 = par.cmd.ExecuteReader()
            Do While myReader1.Read
                NUM_VANI = NUM_VANI + CDbl(par.IfNull(myReader1("NUM_VANI"), 0))
            Loop
            myReader1.Close()

            par.cmd.CommandText = "SELECT DIMENSIONI_UNITA_CONTRATTUALE.* FROM SISCOM_MI.DIMENSIONI_UNITA_CONTRATTUALE,siscom_mi.unita_contrattuale WHERE DIMENSIONI_UNITA_CONTRATTUALE.COD_TIPOLOGIA='SUVEC' AND UNITA_CONTRATTUALE.ID_CONTRATTO=" & lIdContratto & " AND UNITA_CONTRATTUALE.ID_UNITA_principale=" & UnitaContratto & " and DIMENSIONI_UNITA_CONTRATTUALE.id_contratto=UNITA_CONTRATTUALE.id_contratto and DIMENSIONI_UNITA_CONTRATTUALE.id_unita=UNITA_CONTRATTUALE.id_unita"
            myReader1 = par.cmd.ExecuteReader()
            Do While myReader1.Read
                SUP_VERDE = SUP_VERDE + CDbl(par.IfNull(myReader1("VALORE"), 0))
            Loop
            myReader1.Close()

            If SUP_UTILE_NETTA > 0 Then
                STRINGA_SUP = SUP_UTILE_NETTA & " (Sup. Utile Netta), "
            End If

            If SUP_BALCONI > 0 Then
                STRINGA_SUP = STRINGA_SUP & "mq " & SUP_BALCONI & " (Balconi,Terrezze,Cantine e Simili), "
            End If

            If SUP_ESCLUSIVA > 0 Then
                STRINGA_SUP = STRINGA_SUP & " mq " & SUP_ESCLUSIVA & " (Sup.scoperta uso escl.), "
            End If

            If SUP_VERDE > 0 Then
                STRINGA_SUP = STRINGA_SUP & " mq " & SUP_VERDE & " (Sup.Condominiale a verde), "
            End If
            If NUM_VANI > 0 Then
                STRINGA_SUP = STRINGA_SUP & "num. vani conv. " & NUM_VANI & " "
            End If

            'sostituisco i segnaposto
            contenuto = Replace(contenuto, "$suputile$", STRINGA_SUP)
            contenuto = Replace(contenuto, "$scadenza$", CType(Generale1.FindControl("lblScadenza"), Label).Text)
            contenuto = Replace(contenuto, "$decorrenza$", CType(Generale1.FindControl("lblDecorrenza"), Label).Text)
            contenuto = Replace(contenuto, "$durata$", CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).Text)
            contenuto = Replace(contenuto, "$durataRinnovo$", CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).Text)
            contenuto = Replace(contenuto, "$giornidisdetta$", par.IfEmpty(CType(Tab_Contratto1.FindControl("txtEntroCuiDisdettare"), TextBox).Text, 0) * 30)

            contenuto = Replace(contenuto, "$canoneiniziale$", Format(CDbl(CType(Tab_Canone1.FindControl("txtCanoneIniziale"), TextBox).Text), "##,##0.00"))
            'contenuto = Replace(contenuto, "$anticipo$", Format(CDbl(CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text), "##,##0.00"))
            contenuto = Replace(contenuto, "$anticipo$", "0,00")


            contenuto = Replace(contenuto, "$classe$", sClasse)
            contenuto = Replace(contenuto, "$rendita$", sRendita)
            contenuto = Replace(contenuto, "$catcatastale$", sCatastale)
            contenuto = Replace(contenuto, "$subalterno$", sSub)
            contenuto = Replace(contenuto, "$foglio$", sFoglio)
            contenuto = Replace(contenuto, "$particella$", sParticella)


            contenuto = Replace(contenuto, "$interno$", sInterno)
            contenuto = Replace(contenuto, "$scala$", sSCALA)
            contenuto = Replace(contenuto, "$piano$", sPiano)
            contenuto = Replace(contenuto, "$indirizzoalloggio$", indirizzoalloggio)
            contenuto = Replace(contenuto, "$sedelocatore$", sedelocatore)
            contenuto = Replace(contenuto, "$direttore$", direttore)
            contenuto = Replace(contenuto, "$locatore$", locatore)
            contenuto = Replace(contenuto, "$cflocatore$", cflocatore)
            contenuto = Replace(contenuto, "$datadelibera$", DataDelibera)
            contenuto = Replace(contenuto, "$delibera$", Delibera)
            contenuto = Replace(contenuto, "$protocollo$", protocollo)
            contenuto = Replace(contenuto, "$DatiIntestatari$", Conduttore)
            contenuto = Replace(contenuto, "$Locatari$", Locatari)

            'scrivo il nuovo contratto compilato
            Dim sr As StreamWriter = New StreamWriter(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeContratti\") & NomeFile & ".htm", False, System.Text.Encoding.Default)
            sr.WriteLine(contenuto)
            sr.Close()

            par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                    & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                    & "'F03','')"
            par.cmd.ExecuteNonQuery()

            par.myTrans.Commit()
            par.myTrans = par.OracleConn.BeginTransaction()
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)


            Dim url As String = NomeFile
            Dim pdfConverter As PdfConverter = New PdfConverter
            ''pdfConverter.LicenseKey = "P38cBx6AWW7b9c81TjEGxnrazP+J7rOjs+9omJ3TUycauK+cL WdrITM5T59hdW5r"
            pdfConverter.PdfDocumentOptions.PdfPageSize = PdfPageSize.A4
            pdfConverter.PdfDocumentOptions.PdfCompressionLevel = PdfCompressionLevel.NoCompression
            pdfConverter.PdfDocumentOptions.ShowHeader = False
            pdfConverter.PdfDocumentOptions.ShowFooter = False
            pdfConverter.PdfDocumentOptions.LeftMargin = 70
            pdfConverter.PdfDocumentOptions.RightMargin = 70
            pdfConverter.PdfDocumentOptions.TopMargin = 21
            pdfConverter.PdfDocumentOptions.BottomMargin = 21
            pdfConverter.PdfDocumentOptions.GenerateSelectablePdf = True

            pdfConverter.PdfDocumentOptions.ShowHeader = False
            pdfConverter.PdfFooterOptions.FooterText = ("")
            pdfConverter.PdfFooterOptions.FooterTextColor = Color.Blue
            pdfConverter.PdfFooterOptions.DrawFooterLine = False
            pdfConverter.PdfFooterOptions.PageNumberText = ""
            pdfConverter.PdfFooterOptions.ShowPageNumber = False

            pdfConverter.SavePdfFromUrlToFile(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeContratti\") & NomeFile & ".htm", Server.MapPath("..\ALLEGATI\CONTRATTI\StampeContratti\") & NomeFile & ".pdf")
            Response.Write("<script>window.open('../ALLEGATI/CONTRATTI/StampeContratti/" & NomeFile & ".pdf" & "','Contratto','');</script>")

            System.IO.File.Delete(Server.MapPath("..\ALLEGATI\CONTRATTI\StampeContratti\") & NomeFile & ".htm")

        Catch ex As Exception
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")

        End Try
    End Function


    Private Function CalcolaProssimoPeriodo(ByVal Rate As Integer, ByVal DataDecorrenza As String, ByRef NumRata As Integer) As String
        If DataDecorrenza < Format(Now, "yyyyMMdd") Then
            DataDecorrenza = Format(Now, "yyyyMMdd")
        End If
        CalcolaProssimoPeriodo = ""
        Select Case Rate
            Case 12
                If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("1201") Then
                    'parte dal 01/01
                    CalcolaProssimoPeriodo = "0101"
                    NumRata = 1
                Else
                    If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("1101") Then
                        'parte dal 12/01
                        CalcolaProssimoPeriodo = "1201"
                        NumRata = 12
                    Else
                        If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("1001") Then
                            'parte dal 11/01
                            CalcolaProssimoPeriodo = "1101"
                            NumRata = 11
                        Else
                            If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0901") Then
                                'parte dal 10/01
                                CalcolaProssimoPeriodo = "1001"
                                NumRata = 10
                            Else
                                If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0801") Then
                                    'parte dal 09/01
                                    CalcolaProssimoPeriodo = "0901"
                                    NumRata = 9
                                Else
                                    If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0701") Then
                                        'parte dal 08/01
                                        CalcolaProssimoPeriodo = "0801"
                                        NumRata = 8
                                    Else
                                        If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0601") Then
                                            'parte dal 07/01
                                            CalcolaProssimoPeriodo = "0701"
                                            NumRata = 7
                                        Else
                                            If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0501") Then
                                                'parte dal 06/01
                                                CalcolaProssimoPeriodo = "0601"
                                                NumRata = 6
                                            Else
                                                If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0401") Then
                                                    'parte dal 05/01
                                                    CalcolaProssimoPeriodo = "0501"
                                                    NumRata = 5
                                                Else
                                                    If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0301") Then
                                                        'parte dal 04/01
                                                        CalcolaProssimoPeriodo = "0401"
                                                        NumRata = 4
                                                    Else
                                                        If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0201") Then
                                                            'parte dal 03/01
                                                            CalcolaProssimoPeriodo = "0301"
                                                            NumRata = 3
                                                        Else
                                                            If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0101") Then
                                                                'parte dal 02/01
                                                                CalcolaProssimoPeriodo = "0201"
                                                                NumRata = 2
                                                            Else
                                                                If CLng(Mid(DataDecorrenza, 5, 4)) = CLng("0101") Then
                                                                    'parte dal 01/01
                                                                    CalcolaProssimoPeriodo = "0101"
                                                                    NumRata = 1
                                                                End If
                                                            End If
                                                        End If
                                                    End If
                                                End If
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
            Case 6
                If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("1101") Then
                    'parte dal 01/01
                    CalcolaProssimoPeriodo = "0101"
                    NumRata = 1
                Else
                    If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0901") Then
                        'parte dal 11/01
                        CalcolaProssimoPeriodo = "1101"
                        NumRata = 6
                    Else
                        If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0701") Then
                            'parte dal 09/01
                            CalcolaProssimoPeriodo = "0901"
                            NumRata = 5
                        Else
                            If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0501") Then
                                'parte dal 07/01
                                CalcolaProssimoPeriodo = "0701"
                                NumRata = 4
                            Else
                                If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0301") Then
                                    'parte dal 05/01
                                    CalcolaProssimoPeriodo = "0501"
                                    NumRata = 3
                                Else
                                    If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0101") Then
                                        'parte dal 03/01
                                        CalcolaProssimoPeriodo = "0301"
                                        NumRata = 2
                                    Else
                                        If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0101") Then
                                            'parte dal 01/01
                                            CalcolaProssimoPeriodo = "0101"
                                            NumRata = 1
                                        End If
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If

            Case 4
                If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("1001") Then
                    'parte dal 01/01
                    CalcolaProssimoPeriodo = "0101"
                    NumRata = 1
                Else
                    If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0701") Then
                        'parte dal 10/01
                        CalcolaProssimoPeriodo = "1001"
                        NumRata = 4
                    Else
                        If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0401") Then
                            'parte dal 07/01
                            CalcolaProssimoPeriodo = "0701"
                            NumRata = 3
                        Else
                            If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0101") Then
                                'parte dal 04/01
                                CalcolaProssimoPeriodo = "0401"
                                NumRata = 2
                            Else
                                If CLng(Mid(DataDecorrenza, 5, 4)) = CLng("0101") Then
                                    'parte dal 01/01
                                    CalcolaProssimoPeriodo = "0101"
                                    NumRata = 1
                                End If
                            End If
                        End If
                    End If
                End If

            Case 3
                If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0901") Then
                    'parte dal 01/01
                    CalcolaProssimoPeriodo = "0101"
                    NumRata = 1
                Else
                    If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0501") Then
                        'parte dal 09/01
                        CalcolaProssimoPeriodo = "0901"
                        NumRata = 3
                    Else
                        If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0101") Then
                            'parte dal 03/01
                            CalcolaProssimoPeriodo = "0501"
                            NumRata = 2
                        Else
                            If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0101") Then
                                'parte dal 01/01
                                CalcolaProssimoPeriodo = "0101"
                                NumRata = 1
                            End If
                        End If
                    End If
                End If
            Case 2
                If CLng(Mid(DataDecorrenza, 5, 4)) > CLng("0701") Then
                    'parte dal 01/01
                    CalcolaProssimoPeriodo = "0101"
                    NumRata = 1
                Else
                    If CLng(Mid(DataDecorrenza, 5, 4)) = CLng("0101") Then
                        'parte dal 01/01
                        CalcolaProssimoPeriodo = "0101"
                        NumRata = 1
                    Else
                        'parte dal 07/01
                        CalcolaProssimoPeriodo = "0701"
                        NumRata = 2
                    End If
                End If
            Case 1
                CalcolaProssimoPeriodo = Format(CLng(Mid(DataDecorrenza, 5, 2)) + 1, "00")
                NumRata = 1
        End Select
    End Function


    Protected Sub imgChiudiContratto_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs) Handles imgChiudiContratto.Click
        Try
            Dim Risoluzione As Boolean = False
            Dim importoRisoluzione As Double = 0
            Dim IMPORTOINTERESSI As Double = 0
            Dim sAggiunta As String = ""
            Dim DataCalcolo As String = ""
            Dim DataInizio As String = ""

            Dim tasso As Double = 0
            Dim baseCalcolo As Double = 0

            Dim Giorni As Integer = 0
            Dim GiorniAnno As Integer = 0
            Dim dataPartenza As String = ""

            Dim Totale As Double = 0
            Dim TotalePeriodo As Double = 0
            Dim indice As Long = 0
            Dim DataFine As String = ""
            Dim num_bolletta As String = ""
            Dim importobolletta As Double = 0
            Dim I As Integer = 0

            Dim importodanni As Double = 0
            Dim importotrasporto As Double = 0

            Dim Interessi As New SortedDictionary(Of Integer, Double)

            Dim RIASSUNTO_BOLLETTA As String = ""
            Dim INDICEANAGRAFICA As Long = 0

            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans

            If TXTATTIVA.Value = "1" Then
                'If CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text <> "" Then

                'End If

                If txtModificato.Value <> "111" Then


                    If CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text <> "" Then

                        If par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text) > Format(Now, "yyyyMMdd") Then
                            Response.Write("<script>alert('La data di sloggio non deve essere successiva alla data odierna!');</script>")
                            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                            CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text = ""
                            par.myTrans.Commit()
                            par.myTrans = par.OracleConn.BeginTransaction()
                            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)
                            Exit Sub
                        End If



                        'If par.IfEmpty(par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDisdetta"), TextBox).Text), "0") < par.IfEmpty(par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Text), "0") Then
                        Risoluzione = True
                        par.cmd.CommandText = "select * from siscom_mi.parametri_bolletta where id=1"
                        Dim myReaderAa As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderAa.Read Then
                            importoRisoluzione = CDbl(par.PuntiInVirgole(myReaderAa("valore")))
                        End If
                        myReaderAa.Close()

                        If LBLVIRTUALE.Visible = False Then
                            par.cmd.CommandText = "select * from siscom_mi.unita_stato_manutentivo where id_unita=" & UnitaContratto
                            myReaderAa = par.cmd.ExecuteReader()
                            If myReaderAa.Read Then
                                If par.IfNull(myReaderAa("FL_AUTORIZZATI_IMP"), "0") = "0" Then
                                    Response.Write("<script>alert('Attenzione, non risulta autorizzato l\'ammontare dei danni nel modulo di verifica stato manutentivo! Operazione non effettuata!');</script>")
                                    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                                    CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text = ""
                                    par.myTrans.Commit()
                                    par.myTrans = par.OracleConn.BeginTransaction()
                                    HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)
                                    Exit Sub
                                Else
                                    importodanni = par.IfNull(myReaderAa("importo_danni"), 0)
                                    importotrasporto = par.IfNull(myReaderAa("importo_trasporto"), 0)
                                End If
                            End If
                            myReaderAa.Close()
                            par.cmd.CommandText = "select * from siscom_mi.sl_sloggio where ID_UNITA_IMMOBILIARE = " & UnitaContratto & " and id_contratto = " & lIdContratto & ""
                            myReaderAa = par.cmd.ExecuteReader()
                            If myReaderAa.Read Then
                                importodanni = importodanni + par.IfNull(myReaderAa("TOT_RAPPORTO_SLOGGIO"), 0)
                            End If
                            myReaderAa.Close()
                        End If



                        If TipoContratto = "7" Then
                            importoRisoluzione = 0
                        End If

                        par.cmd.CommandText = "select * from siscom_mi.tab_interessi_legaLI order by anno desc"
                        Interessi.Clear()
                        Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        Do While myReaderC.Read
                            Interessi.Add(myReaderC("anno"), myReaderC("tasso"))
                        Loop
                        myReaderC.Close()

                        DataCalcolo = par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text)

                        baseCalcolo = par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, 0)
                        If baseCalcolo > 0 And CType(Tab_Canone1.FindControl("checkInteressiCauzione"), CheckBox).Checked = True Then

                            par.cmd.CommandText = "select * from siscom_mi.adeguamento_interessi where id_contratto=" & lIdContratto & " order by id desc"
                            Dim myReaderZ As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            If myReaderZ.HasRows = False Then
                                DataInizio = par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text)
                            End If
                            If myReaderZ.Read Then
                                DataInizio = Format(DateAdd(DateInterval.Day, 1, CDate(par.FormattaData(myReaderZ("data")))), "yyyyMMdd")
                            End If
                            myReaderZ.Close()

                            If DataInizio < "20091001" Then
                                DataInizio = "20091001"
                            End If

                            Giorni = 0
                            GiorniAnno = 0
                            dataPartenza = DataInizio
                            Totale = 0
                            TotalePeriodo = 0

                            par.cmd.CommandText = "insert into siscom_mi.adeguamento_interessi (id,id_contratto,data,fl_applicato) values (siscom_mi.seq_adeguamento_interessi.nextval," & lIdContratto & ",'" & DataCalcolo & "',1)"
                            par.cmd.ExecuteNonQuery()
                            par.cmd.CommandText = "select siscom_mi.seq_adeguamento_interessi.currval from dual"
                            myReaderZ = par.cmd.ExecuteReader()
                            indice = 0
                            If myReaderZ.Read Then
                                indice = myReaderZ(0)
                            End If

                            For I = CInt(Mid(DataInizio, 1, 4)) To CInt(Mid(DataCalcolo, 1, 4))

                                If I = CInt(Mid(DataCalcolo, 1, 4)) Then
                                    DataFine = par.FormattaData(DataCalcolo)
                                Else
                                    DataFine = "31/12/" & I

                                End If

                                GiorniAnno = DateDiff(DateInterval.Day, CDate("01/01/" & I), CDate("31/12/" & I)) + 1

                                Giorni = DateDiff(DateInterval.Day, CDate(par.FormattaData(dataPartenza)), CDate(DataFine)) + 1

                                If I < 1990 Then
                                    tasso = 5
                                Else
                                    If Interessi.ContainsKey(I) = True Then
                                        tasso = Interessi(I)
                                    End If
                                End If

                                TotalePeriodo = Format((((baseCalcolo * tasso) / 100) / GiorniAnno) * Giorni, "0.00")
                                Totale = Totale + TotalePeriodo



                                par.cmd.CommandText = "insert into siscom_mi.adeguamento_interessi_voci (id_adeguamento,dal,al,giorni,tasso,importo) values (" & indice & ",'" & dataPartenza & "','" & Format(CDate(DataFine), "yyyyMMdd") & "'," & Giorni & "," & par.VirgoleInPunti(tasso) & "," & par.VirgoleInPunti(TotalePeriodo) & ")"
                                par.cmd.ExecuteNonQuery()

                                dataPartenza = I + 1 & "0101"

                            Next
                            par.cmd.CommandText = "update siscom_mi.adeguamento_interessi set importo=" & par.VirgoleInPunti(Format(Totale, "0.00")) & " where id=" & indice
                            par.cmd.ExecuteNonQuery()
                        End If



                        par.cmd.CommandText = "select sum(importo) as TotInteressi from siscom_mi.adeguamento_interessi where id_contratto=" & lIdContratto & " and fl_applicato=0 order by id desc"
                        Dim myReaderZ2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderZ2.Read Then
                            Totale = Totale + par.IfNull(myReaderZ2("TotInteressi"), 0)
                        End If
                        myReaderZ2.Close()
                        par.cmd.CommandText = "UPDATE siscom_mi.adeguamento_interessi SET FL_APPLICATO=1 where id_contratto=" & lIdContratto & " and fl_applicato=0"
                        par.cmd.ExecuteNonQuery()

                        Dim DataScadenza As String = DateAdd("d", 10, Now)
                        Dim TOTALE_BOLLETTA As Double = 0



                        par.cmd.CommandText = "select anagrafica.id as ida,anagrafica.cognome,anagrafica.nome,ANAGRAFICA.RAGIONE_SOCIALE,RAPPORTI_UTENZA.*,EDIFICI.ID_COMPLESSO,UNITA_CONTRATTUALE.ID_EDIFICIO FROM SISCOM_MI.UNITA_CONTRATTUALE,SISCOM_MI.EDIFICI,SISCOM_MI.RAPPORTI_UTENZA,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND SOGGETTI_CONTRATTUALI.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='INTE' AND UNITA_CONTRATTUALE.ID_UNITA_PRINCIPALE IS NULL AND RAPPORTI_UTENZA.ID=" & lIdContratto & " AND UNITA_CONTRATTUALE.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND EDIFICI.ID=UNITA_CONTRATTUALE.ID_EDIFICIO"
                        Dim myReaderS As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderS.Read Then


                            Dim PRESSO As String = UCase(Trim(par.IfNull(myReaderS("PRESSO_COR"), "")))
                            Dim Cognome As String = ""
                            Dim Nome As String = ""

                            If par.IfNull(myReaderS("ragione_sociale"), "") <> "" Then
                                Cognome = par.IfNull(myReaderS("ragione_sociale"), "")
                                Nome = ""
                            Else
                                Cognome = par.IfNull(myReaderS("cognome"), "")
                                Nome = par.IfNull(myReaderS("nome"), "")
                            End If

                            If UCase(Trim(Cognome & " " & Nome)) = PRESSO Then
                                PRESSO = ""
                            End If
                            INDICEANAGRAFICA = par.IfNull(myReaderS("IDA"), 0)

                            par.cmd.CommandText = "update siscom_mi.adeguamento_interessi set id_anagrafica=" & INDICEANAGRAFICA & " where id=" & indice
                            par.cmd.ExecuteNonQuery()

                            par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE " _
                                                            & "(ID, N_RATA, DATA_EMISSIONE, DATA_SCADENZA, DATA_I_SOLLECITO, " _
                                                            & "DATA_II_SOLLECITO, DATA_PAGAMENTO, NOTE, ID_CONTRATTO, ID_ESERCIZIO_F, " _
                                                            & "ID_UNITA, FL_ANNULLATA, PAGABILE_PRESSO, COD_AFFITTUARIO, INTESTATARIO, " _
                                                            & "INDIRIZZO, CAP_CITTA, PRESSO, RIFERIMENTO_DA, RIFERIMENTO_A, " _
                                                            & "FL_STAMPATO, ID_COMPLESSO, DATA_INS_PAGAMENTO, IMPORTO_PAGATO, NOTE_PAGAMENTO, " _
                                                            & "ANNO, OPERATORE_PAG, ID_EDIFICIO, DATA_ANNULLO_PAG, OPERATORE_ANNULLO_PAG,RIF_FILE,ID_TIPO) " _
                                                            & "Values " _
                                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE.NEXTVAL, 999, '" & Format(Now, "yyyyMMdd") _
                                                            & "', '" & Format(CDate(DataScadenza), "yyyyMMdd") & "', NULL,NULL,NULL,'BOLLETTA FINE CONTRATTO'," _
                                                            & "" & lIdContratto _
                                                            & " ," & par.RicavaEsercizioCorrente & ", " _
                                                            & UnitaContratto _
                                                            & ", '0', '', " & par.IfNull(myReaderS("IDA"), 0) _
                                                            & ", '" & par.PulisciStrSql(Trim(Cognome & " " & Nome)) & "', " _
                                                            & "'" & par.PulisciStrSql(par.IfNull(myReaderS("TIPO_COR"), "") & " " & par.IfNull(myReaderS("VIA_COR"), "") & ", " & par.PulisciStrSql(par.IfNull(myReaderS("CIVICO_COR"), ""))) _
                                                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderS("CAP_COR"), "") & " " & par.IfNull(myReaderS("LUOGO_COR"), "") & "(" & par.IfNull(myReaderS("SIGLA_COR"), "") & ")") _
                                                            & "', '" & par.PulisciStrSql(PRESSO) & "', '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text) _
                                                            & "', '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text) & "', " _
                                                            & "'0', " & myReaderS("ID_COMPLESSO") & ", '', NULL, '', " _
                                                            & Year(Now) & ", '', " & myReaderS("ID_EDIFICIO") & ", NULL, NULL,'FIN',3)"
                            par.cmd.ExecuteNonQuery()
                            par.cmd.CommandText = "select SISCOM_MI.SEQ_BOL_BOLLETTE.CURRVAL FROM DUAL"
                            Dim myReaderA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            If myReaderA.Read Then
                                Dim ID_BOLLETTA As Long = myReaderA(0)

                                If importoRisoluzione > 0 Then
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                        & ",35" _
                                                        & "," & par.VirgoleInPunti(importoRisoluzione) & ")"
                                    RIASSUNTO_BOLLETTA = "Risoluzione: " & par.VirgoleInPunti(importoRisoluzione) & " Euro;\n"
                                    par.cmd.ExecuteNonQuery()

                                    TOTALE_BOLLETTA = importoRisoluzione
                                End If

                                If importodanni > 0 Then
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                        & ",100" _
                                                        & "," & par.VirgoleInPunti(importodanni) & ")"
                                    RIASSUNTO_BOLLETTA = "Risoluzione: " & par.VirgoleInPunti(importodanni) & " Euro;\n"
                                    par.cmd.ExecuteNonQuery()

                                    TOTALE_BOLLETTA = TOTALE_BOLLETTA + importodanni
                                End If

                                If importotrasporto > 0 Then
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                        & ",101" _
                                                        & "," & par.VirgoleInPunti(importotrasporto) & ")"
                                    RIASSUNTO_BOLLETTA = "Risoluzione: " & par.VirgoleInPunti(importotrasporto) & " Euro;\n"
                                    par.cmd.ExecuteNonQuery()

                                    TOTALE_BOLLETTA = TOTALE_BOLLETTA + importotrasporto
                                End If


                                If Totale > 0 And CType(Tab_Canone1.FindControl("checkInteressiCauzione"), CheckBox).Checked = True Then
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,note) VALUES " _
                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                        & ",15" _
                                                        & "," & par.VirgoleInPunti(Format(Totale * -1, "0.00")) & ",'Dal " & par.FormattaData(DataInizio) & "')"
                                    par.cmd.ExecuteNonQuery()
                                    RIASSUNTO_BOLLETTA = RIASSUNTO_BOLLETTA & "Rimborso Interessi Annuo Cauzione: " & par.VirgoleInPunti(Format(Totale * -1, "0.00")) & " Euro;\n"
                                    TOTALE_BOLLETTA = TOTALE_BOLLETTA + (Totale * -1)


                                    'MAX 29/11/2018 SCRITTURA IN GESTIONALE
                                    Dim ID_BOLLETTA_GEST As Long = 0
                                    par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE_GEST (ID, ID_CONTRATTO, ID_ESERCIZIO_F, ID_UNITA, ID_ANAGRAFICA, RIFERIMENTO_DA, RIFERIMENTO_A, IMPORTO_TOTALE, DATA_EMISSIONE, DATA_PAGAMENTO, DATA_VALUTA, ID_TIPO, TIPO_APPLICAZIONE, DATA_APPLICAZIONE, ID_OPERATORE_APPLICAZIONE, NOTE, ID_EVENTO_PAGAMENTO,ID_ADEGUAMENTO,ID_BOLLETTA) " _
                                                        & " Values " _
                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_GEST.NEXTVAL, " & lIdContratto & ", " & par.RicavaEsercizioCorrente & ", " & UnitaContratto & "," _
                                                        & INDICEANAGRAFICA & ", '" & DataInizio & "', '" & Format(Now, "yyyyMMdd") _
                                                        & "', " & par.VirgoleInPunti(Format(Totale * -1, "0.00")) & ", '" & Format(Now, "yyyyMMdd") & "',NULL, NULL, 57, 'T', NULL, " _
                                                        & "'', '" & par.PulisciStrSql("REST. INTERESSI DEP.CAUZIONALE ") & "', NULL," & indice & "," & ID_BOLLETTA & ")"
                                    par.cmd.ExecuteNonQuery()
                                    par.cmd.CommandText = "select SISCOM_MI.SEQ_BOL_BOLLETTE_GEST.CURRVAL FROM DUAL"
                                    Dim myReaderX As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                    If myReaderX.Read Then
                                        ID_BOLLETTA_GEST = myReaderX(0)
                                        par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE_VOCI_GEST (ID, ID_BOLLETTA_GEST, ID_VOCE, IMPORTO, IMP_PAGATO, FL_ACCERTATO) Values  (SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI_GEST.NEXTVAL, " & ID_BOLLETTA_GEST & ",15, " & par.VirgoleInPunti(Format(Totale * -1, "0.00")) & ",  NULL, NULL)"
                                        par.cmd.ExecuteNonQuery()
                                        par.cmd.CommandText = "INSERT INTO OPERAZIONI_PART_GEST (DATA_ORA,ID_CONTRATTO,OPERAZIONE,NOTE,ID_BOLLETTA,ID_BOLLETTA_GEST) VALUES ('" & Format(Now, "yyyyMMddHHmmss") & "'," & lIdContratto & ",'RIMBORSO INTERESSI DEPOSITO CAUZIONALE','CREATA IN P.GEST. BOLLETTA NUM." & par.PulisciStrSql(ID_BOLLETTA_GEST) & " PER FINE CONTRATTO',NULL," & ID_BOLLETTA_GEST & ")"
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                    myReaderX.Close()

                                End If

                                '13/03/2015
                                'If baseCalcolo > 0 Then
                                '    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                '                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                '                        & ",50" _
                                '                        & "," & par.VirgoleInPunti(Format(baseCalcolo * -1, "0.00")) & ")"
                                '    par.cmd.ExecuteNonQuery()
                                '    RIASSUNTO_BOLLETTA = RIASSUNTO_BOLLETTA & "Rimborso Deposito Cauzionale: " & par.VirgoleInPunti(Format(baseCalcolo * -1, "0.00")) & " Euro;\n"
                                '    TOTALE_BOLLETTA = TOTALE_BOLLETTA + (baseCalcolo * -1)

                                'End If

                                Dim Giorni1 As Integer = 0
                                Dim Giorni2 As Integer = 0
                                Dim SPESEmav As Double = 0
                                Dim BOLLO As Double = 0
                                Dim APPLICABOLLO As Double = 0

                                Dim PARTENZA As String = ""
                                Dim FINE As String = ""


                                par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=26"
                                myReaderA = par.cmd.ExecuteReader()
                                If myReaderA.Read Then
                                    SPESEmav = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                                End If
                                myReaderA.Close()

                                par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=0"
                                myReaderA = par.cmd.ExecuteReader()
                                If myReaderA.Read Then
                                    BOLLO = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                                End If
                                myReaderA.Close()

                                par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=25"
                                myReaderA = par.cmd.ExecuteReader()
                                If myReaderA.Read Then
                                    APPLICABOLLO = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                                End If
                                myReaderA.Close()

                                Dim SPESEPOSTALI As Double = 0
                                Dim SPESEPOSTALI_CAPOLUOGHI As Double = 0
                                Dim SPESEPOSTALI_ALTRI As Double = 0
                                Dim SPESEPOSTALI_DA_APPLICARE As Double = 0

                                par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=17"
                                myReaderA = par.cmd.ExecuteReader()
                                If myReaderA.Read Then
                                    SPESEPOSTALI = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                                End If
                                myReaderA.Close()

                                par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=29"
                                myReaderA = par.cmd.ExecuteReader()
                                If myReaderA.Read Then
                                    SPESEPOSTALI_CAPOLUOGHI = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                                End If
                                myReaderA.Close()

                                par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=30"
                                myReaderA = par.cmd.ExecuteReader()
                                If myReaderA.Read Then
                                    SPESEPOSTALI_ALTRI = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                                End If
                                myReaderA.Close()

                                If UCase(CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text) = "MILANO" Then
                                    SPESEPOSTALI_DA_APPLICARE = SPESEPOSTALI
                                Else
                                    If InStr(Capoluoghi, UCase(CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text)) > 0 Then
                                        SPESEPOSTALI_DA_APPLICARE = SPESEPOSTALI_CAPOLUOGHI
                                    Else
                                        SPESEPOSTALI_DA_APPLICARE = SPESEPOSTALI_ALTRI
                                    End If
                                End If


                                'MAX 08/11/2018 Visto che su alcuni contratti vengono stornate numerose bollette ordinarie e poi riemesse 
                                'ma di tipo MANUALE viene cambiata la query in modo da prendere tutte le bollette valide, non stornate e non di storno
                                'par.cmd.CommandText = "select * FROM SISCOM_MI.BOL_BOLLETTE WHERE ID_BOLLETTA_STORNO IS NULL AND FL_ANNULLATA='0' AND N_RATA<>99 AND N_RATA<>999 AND N_RATA<>99999 AND ID_CONTRATTO=" & lIdContratto & " ORDER BY ID DESC"
                                par.cmd.CommandText = "select max(riferimento_a) FROM SISCOM_MI.BOL_BOLLETTE WHERE ID_TIPO<>22 AND id_tipo=1 and ID_BOLLETTA_STORNO IS NULL AND FL_ANNULLATA='0' AND ID_CONTRATTO=" & lIdContratto & " "
                                myReaderA = par.cmd.ExecuteReader()
                                If myReaderA.Read Then
                                    PARTENZA = myReaderA(0)
                                End If
                                myReaderA.Close()
                                'par.cmd.CommandText = "select * FROM SISCOM_MI.BOL_BOLLETTE WHERE ID_BOLLETTA_STORNO IS NULL AND FL_ANNULLATA='0' AND N_RATA<>99 AND N_RATA<>999 AND N_RATA<>99999 AND ID_CONTRATTO=" & lIdContratto & " ORDER BY ID DESC"
                                'myReaderA = par.cmd.ExecuteReader()
                                'If myReaderA.Read Then
                                '    PARTENZA = myReaderA("RIFERIMENTO_A")
                                'End If
                                'myReaderA.Close()

                                FINE = par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text)

                                If PARTENZA <> "" And FINE <> "" Then
                                    Giorni1 = DateDiff("d", CDate(par.FormattaData(PARTENZA)), CDate(par.FormattaData(FINE)))


                                    If Giorni1 > 0 Then
                                        'calcolo l'importo dell'affitto in base al numero di rate annue

                                        Dim affitto As Double = 0

                                        If par.IfNull(myReaderS("imp_CANONE_INIZIALE"), 0) > 0 Then
                                            affitto = Format((par.IfNull(myReaderS("imp_CANONE_INIZIALE"), 1) / 365) * (Giorni1), "0.00")
                                            TOTALE_BOLLETTA = TOTALE_BOLLETTA + (par.IfNull(myReaderS("imp_CANONE_INIZIALE"), 1) / 365) * (Giorni1)

                                            If par.IfNull(myReaderS("PROVENIENZA_ASS"), "") <> "7" Then
                                                If FINE = par.IfNull(myReaderS("data_scadenza_rinnovo"), "") Then
                                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",36" _
                                                                        & "," & par.VirgoleInPunti(affitto) & ")"
                                                    par.cmd.ExecuteNonQuery()
                                                Else
                                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",1" _
                                                                        & "," & par.VirgoleInPunti(affitto) & ")"
                                                    par.cmd.ExecuteNonQuery()
                                                End If
                                            Else
                                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",560" _
                                                    & "," & par.VirgoleInPunti(affitto) & ")"
                                                par.cmd.ExecuteNonQuery()
                                            End If


                                        End If
                                    End If
                                End If

                                If Giorni1 > 0 Then
                                    Dim aggiornamento_istat As Double = 0
                                    Dim AltriAdeguamenti As Double = 0
                                    'calcolo eventuali aggiornamenti istat E altri adeguamenti

                                    'par.cmd.CommandText = "select SUM(IMPORTO_TR_AGG) FROM SISCOM_MI.ADEGUAMENTO_ISTAT WHERE ID_CONTRATTO=" & lIdContratto
                                    'myReaderA = par.cmd.ExecuteReader()
                                    'If myReaderA.Read Then
                                    '    aggiornamento_istat = par.IfNull(myReaderA(0), 0)
                                    'End If
                                    'myReaderA.Close()


                                    par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo=2 and ID_CONTRATTO=" & lIdContratto
                                    myReaderA = par.cmd.ExecuteReader()
                                    If myReaderA.Read Then
                                        aggiornamento_istat = par.IfNull(myReaderA(0), 0)
                                    End If
                                    myReaderA.Close()

                                    par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo<>2 and ID_CONTRATTO=" & lIdContratto
                                    myReaderA = par.cmd.ExecuteReader()
                                    If myReaderA.Read Then
                                        AltriAdeguamenti = par.IfNull(myReaderA(0), 0)
                                    End If
                                    myReaderA.Close()

                                    If aggiornamento_istat > 0 Then

                                        TOTALE_BOLLETTA = TOTALE_BOLLETTA + Format((aggiornamento_istat / 365) * Giorni1, "0.00")
                                        aggiornamento_istat = (aggiornamento_istat / 365) * Giorni1

                                        If FINE = par.IfNull(myReaderS("data_scadenza_rinnovo"), "") Or par.IfNull(myReaderS("PROVENIENZA_ASS"), "") = "7" Then
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",405" _
                                                                & "," & par.VirgoleInPunti(Format(aggiornamento_istat, "0.00")) & ")"
                                            par.cmd.ExecuteNonQuery()
                                        Else
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",404" _
                                                                & "," & par.VirgoleInPunti(Format(aggiornamento_istat, "0.00")) & ")"
                                            par.cmd.ExecuteNonQuery()
                                        End If
                                    End If

                                    If AltriAdeguamenti > 0 Then

                                        TOTALE_BOLLETTA = TOTALE_BOLLETTA + Format((AltriAdeguamenti / 365) * Giorni1, "0.00")
                                        AltriAdeguamenti = (AltriAdeguamenti / 365) * Giorni1


                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",652" _
                                                            & "," & par.VirgoleInPunti(Format(AltriAdeguamenti, "0.00")) & ")"
                                        par.cmd.ExecuteNonQuery()

                                    End If

                                    par.cmd.CommandText = "select bol_schema.*,t_voci_bolletta.descrizione from siscom_mi.bol_schema,siscom_mi.t_voci_bolletta where anno=" & Year(Now) & " and da_rata=1 And per_rate=12 AND t_voci_bolletta.id=bol_schema.id_voce and  bol_schema.id_contratto=" & lIdContratto
                                    myReaderA = par.cmd.ExecuteReader()
                                    Do While myReaderA.Read

                                        TOTALE_BOLLETTA = TOTALE_BOLLETTA + CDbl((myReaderA("importo") / 365) * Giorni1)

                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & "," & myReaderA("ID_VOCE") _
                                                            & "," & par.VirgoleInPunti(Format((myReaderA("importo") / 365) * Giorni1, "0.00")) & ")"
                                        par.cmd.ExecuteNonQuery()


                                    Loop
                                    myReaderA.Close()


                                    Dim TotMorosita As Double = 0
                                    Dim TotMorositaSB As Double = 0
                                    'par.cmd.CommandText = "SELECT BOL_BOLLETTE.ID,(NVL(IMPORTO_TOTALE,0)-NVL(QUOTA_SIND_B,0))-  NVL(IMPORTO_PAGATO,0)-NVL(QUOTA_SIND_PAGATA_B,0) FROM SISCOM_MI.BOL_BOLLETTE WHERE (BOL_BOLLETTE.FL_SOLLECITO=1 OR ID<0) AND BOL_BOLLETTE.data_scadenza<" & Format(Now, "yyyyMMdd") & " AND FL_ANNULLATA='0' AND ID_BOLLETTA_RIC IS NULL AND ID_RATEIZZAZIONE IS NULL AND (ID_TIPO=1 OR ID_TIPO=2 OR ID_TIPO=6 OR id_tipo=8) AND ID_CONTRATTO=" & lIdContratto

                                    'myReaderA = par.cmd.ExecuteReader()
                                    'Do While myReaderA.Read
                                    '    TotMorositaSB = 0
                                    '    TotMorositaSB = par.IfNull(myReaderA("IMPORTO_altri"), 0)
                                    '    If TotMorositaSB > 0 Then
                                    '        par.cmd.CommandText = "UPDATE SISCOM_MI.BOL_BOLLETTE SET fl_sollecito='1',ID_BOLLETTA_RIC=" & ID_BOLLETTA & " WHERE ID=" & myReaderA("ID")
                                    '        par.cmd.ExecuteNonQuery()
                                    '        TotMorosita = TotMorosita + TotMorositaSB
                                    '    End If
                                    'Loop
                                    'myReaderA.Close()

                                    If TotMorosita > 0 Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                       & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",151" _
                                                       & "," & par.VirgoleInPunti(Format(TotMorosita, "0.00")) & ")"
                                        par.cmd.ExecuteNonQuery()
                                        TOTALE_BOLLETTA = TOTALE_BOLLETTA + TotMorosita
                                    End If
                                End If

                                'max 14/12/2016
                                Dim IndiciGestionali As String = ""
                                par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=60"
                                myReaderA = par.cmd.ExecuteReader()
                                If myReaderA.HasRows = True Then
                                    If myReaderA.Read Then
                                        IndiciGestionali = myReaderA("VALORE")
                                    End If
                                End If
                                myReaderA.Close()
                                If IndiciGestionali <> "" Then
                                    '30/08/2018
                                    par.cmd.CommandText = "select sum(abs(importo)) as imp_interessi FROM SISCOM_MI.bol_bollette_gest,SISCOM_MI.bol_bollette_VOCI_gest WHERE bol_bollette_VOCI_gest.ID_BOLLETTA_GEST=BOL_BOLLETTE_GEST.ID AND TIPO_APPLICAZIONE='N' AND ID_TIPO IN (" & IndiciGestionali & ") AND ID_CONTRATTO=" & lIdContratto & " ORDER BY ID_TIPO ASC"
                                    Dim imp_interessi As Decimal = par.IfNull(par.cmd.ExecuteScalar, 0)

                                    If imp_interessi < TOTALE_BOLLETTA Then
                                    par.cmd.CommandText = "select bol_bollette_VOCI_gest.*,BOL_BOLLETTE_GEST.NOTE FROM SISCOM_MI.bol_bollette_gest,SISCOM_MI.bol_bollette_VOCI_gest WHERE bol_bollette_VOCI_gest.ID_BOLLETTA_GEST=BOL_BOLLETTE_GEST.ID AND TIPO_APPLICAZIONE='N' AND ID_TIPO IN (" & IndiciGestionali & ") AND ID_CONTRATTO=" & lIdContratto & " ORDER BY ID_TIPO ASC"
                                    myReaderA = par.cmd.ExecuteReader()
                                    Do While myReaderA.Read
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & "," & myReaderA("ID_VOCE") _
                                                            & "," & par.VirgoleInPunti(myReaderA("IMPORTO")) & ")"
                                        par.cmd.ExecuteNonQuery()

                                        par.cmd.CommandText = "UPDATE SISCOM_MI.BOL_BOLLETTE_GEST SET TIPO_APPLICAZIONE='T' WHERE ID=" & myReaderA("ID_BOLLETTA_GEST")
                                        par.cmd.ExecuteNonQuery()

                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO, ID_OPERATORE, DATA_ORA, COD_EVENTO, MOTIVAZIONE) VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ", '" & Format(Now, "yyyyMMddHHmmss") & "', 'F02', 'IMPORTO DI EURO " & myReaderA("IMPORTO") & " (" & par.PulisciStrSql(par.IfNull(myReaderA("NOTE"), "")) & ") INSERITE NELLA BOLLETTA DI FINE CONTRATTO')"
                                        par.cmd.ExecuteNonQuery()

                                        TOTALE_BOLLETTA = TOTALE_BOLLETTA + CDbl(myReaderA("IMPORTO"))
                                    Loop
                                    myReaderA.Close()
                                    End If

                                End If


                                '--------------

                                If SPESEmav > 0 And TOTALE_BOLLETTA > 0 Then
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",407" _
                                    & "," & par.VirgoleInPunti(Format(SPESEmav, "0.00")) & ")"
                                    par.cmd.ExecuteNonQuery()

                                    TOTALE_BOLLETTA = TOTALE_BOLLETTA + SPESEmav
                                End If

                                If TOTALE_BOLLETTA > 0 Then
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",403" _
                                                        & "," & par.VirgoleInPunti(Format(SPESEPOSTALI_DA_APPLICARE, "0.00")) & ")"
                                    par.cmd.ExecuteNonQuery()
                                    TOTALE_BOLLETTA = TOTALE_BOLLETTA + SPESEPOSTALI_DA_APPLICARE
                                End If

                                If TOTALE_BOLLETTA > APPLICABOLLO Then
                                    If BOLLO > 0 Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",95" _
                                                            & "," & par.VirgoleInPunti(Format(BOLLO, "0.00")) & ")"
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                End If




                                If TOTALE_BOLLETTA <= SPESEmav And TOTALE_BOLLETTA > 0 Then
                                    par.cmd.CommandText = "UPDATE SISCOM_MI.BOL_BOLLETTE SET FL_STAMPATO=0 WHERE ID=" & ID_BOLLETTA
                                    par.cmd.ExecuteNonQuery()
                                    par.cmd.CommandText = "DELETE FROM SISCOM_MI.BOL_BOLLETTE WHERE ID=" & ID_BOLLETTA
                                    par.cmd.ExecuteNonQuery()
                                    RIASSUNTO_BOLLETTA = ""
                                End If

                            End If

                        End If
                        myReaderS.Close()

                        'MAX 26/04/2016 SCRITTURA GEST. DEPOSITO CAUZIONALE
                        If par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, 0) > 0 Then
                            Dim ID_BOLLETTA_GEST As Long = 0
                            par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE_GEST (ID, ID_CONTRATTO, ID_ESERCIZIO_F, ID_UNITA, ID_ANAGRAFICA, RIFERIMENTO_DA, RIFERIMENTO_A, IMPORTO_TOTALE, DATA_EMISSIONE, DATA_PAGAMENTO, DATA_VALUTA, ID_TIPO, TIPO_APPLICAZIONE, DATA_APPLICAZIONE, ID_OPERATORE_APPLICAZIONE, NOTE, ID_EVENTO_PAGAMENTO) " _
                                                & " Values " _
                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_GEST.NEXTVAL, " & lIdContratto & ", " & par.RicavaEsercizioCorrente & ", " & UnitaContratto & "," _
                                                & INDICEANAGRAFICA & ", '" & DataInizio & "', '" & Format(Now, "yyyyMMdd") _
                                                & "', " & par.VirgoleInPunti(-1 * par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, 0)) & ", '" & Format(Now, "yyyyMMdd") & "',NULL, NULL, 55, 'N', NULL, " _
                                                & "'', '" & par.PulisciStrSql("RIMBORSO DEPOSITO CAUZIONALE") & "', NULL)"
                            par.cmd.ExecuteNonQuery()
                            par.cmd.CommandText = "select SISCOM_MI.SEQ_BOL_BOLLETTE_GEST.CURRVAL FROM DUAL"
                            Dim myReaderX As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            If myReaderX.Read Then
                                ID_BOLLETTA_GEST = myReaderX(0)
                                par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE_VOCI_GEST (ID, ID_BOLLETTA_GEST, ID_VOCE, IMPORTO, IMP_PAGATO, FL_ACCERTATO) Values  (SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI_GEST.NEXTVAL, " & ID_BOLLETTA_GEST & ",7, " & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, 0) * -1) & ",  NULL, NULL)"
                                par.cmd.ExecuteNonQuery()
                                par.cmd.CommandText = "INSERT INTO OPERAZIONI_PART_GEST (DATA_ORA,ID_CONTRATTO,OPERAZIONE,NOTE,ID_BOLLETTA,ID_BOLLETTA_GEST) VALUES ('" & Format(Now, "yyyyMMddHHmmss") & "'," & lIdContratto & ",'RIMBORSO DEPOSITO CAUZIONALE','CREATA IN P.GEST. BOLLETTA NUM." & par.PulisciStrSql(ID_BOLLETTA_GEST) & " PER RIMBORSO DEP. CAUZIONALE',NULL," & ID_BOLLETTA_GEST & ")"
                                par.cmd.ExecuteNonQuery()
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO, ID_OPERATORE, DATA_ORA, COD_EVENTO, MOTIVAZIONE) VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ", '" & Format(Now, "yyyyMMddHHmmss") & "', 'F02', 'CREATA IN P.GEST. BOLLETTA RIMBORSO DEPOSITO CAUZIONE NUM." & ID_BOLLETTA_GEST & "')"
                                par.cmd.ExecuteNonQuery()
                            End If
                            myReaderX.Close()
                        End If

                        CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items.Clear()
                        imgChiudiContratto.Visible = False

                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                            & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                            & "'F18','')"
                        par.cmd.ExecuteNonQuery()

                        'I = 0



                        'Dim importopagato As Double = 0
                        'par.cmd.CommandText = "select TIPO_BOLLETTE.ACRONIMO,bol_bollette.* from SISCOM_MI.TIPO_BOLLETTE,siscom_mi.bol_bollette where BOL_BOLLETTE.ID_TIPO=TIPO_BOLLETTE.ID (+) AND bol_bollette.id_unita=" & UnitaContratto & " and bol_bollette.id_contratto=" & lIdContratto & " order by bol_bollette.data_emissione desc,BOL_BOLLETTE.ANNO DESC,BOL_BOLLETTE.N_RATA DESC,bol_bollette.id desc"
                        'Dim myReader2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        'Do While myReader2.Read
                        '    Select Case par.IfNull(myReader2("n_rata"), "")
                        '        Case "99" 'bolletta manuale
                        '            num_bolletta = "MA"
                        '        Case "999" 'bolletta automatica
                        '            num_bolletta = "AU"
                        '        Case "99999" 'bolletta di conguaglio
                        '            num_bolletta = "CO"
                        '        Case Else
                        '            num_bolletta = Format(par.IfNull(myReader2("n_rata"), "??"), "00")
                        '    End Select


                        '    importobolletta = par.IfNull(myReader2("IMPORTO_TOTALE"), "0,00")
                        '    importopagato = par.IfNull(myReader2("IMPORTO_PAGATO"), "0,00")


                        '    Dim STATO As String = ""
                        '    If par.IfNull(myReader2("FL_ANNULLATA"), "0") <> "0" Then
                        '        STATO = "ANNUL."
                        '    Else
                        '        STATO = "VALIDA"
                        '    End If

                        '    If par.IfNull(myReader2("id_bolletta_ric"), "0") <> "0" Or par.IfNull(myReader2("ID_RATEIZZAZIONE"), "0") <> "0" Then
                        '        STATO = "RICLA."
                        '    End If

                        '    CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items.Add(New ListItem(par.MiaFormat(num_bolletta, 2) & " " & par.MiaFormat(STATO, 7) & " " & par.IfNull(myReader2("ACRONIMO"), "---") & "   " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("riferimento_da"), "")), 12) & "   " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("riferimento_a"), "")), 12) & " " & par.MiaFormat(Format(importobolletta, "##,##0.00"), 10) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_emissione"), "")), 12) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_scadenza"), "")), 12) & " " & par.MiaFormat(Format(importopagato, "##,##0.00"), 10) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_pagamento"), "")), 12) & " " & par.MiaFormat(par.IfNull(myReader2("note"), ""), 35) & " ", myReader2("ID")))

                        '    If I Mod 2 <> 0 Then
                        '        CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "#dcdada")
                        '    Else
                        '        CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "white")
                        '    End If

                        '    Select Case par.IfNull(myReader2("ID_TIPO"), "0")
                        '        Case "3"
                        '            CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "yellow")
                        '        Case "4"
                        '            CType(Tab_Bollette1.FindControl("lstBollette"), ListBox).Items(I).Attributes.CssStyle.Add("background-color", "yellow")
                        '    End Select

                        '    I = I + 1
                        'Loop
                        'myReader2.Close()


                        'CaricaBollette(lIdContratto)
                        CaricaTabBollette()
                        CaricaGestionale()

                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.UNITA_STATO_MANUTENTIVO WHERE ID_UNITA=" & UnitaContratto
                        Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReader.Read Then

                            par.cmd.CommandText = "Insert into siscom_mi.UNITA_STATO_MAN_S (id_unita,id_contratto,data_memo) values (" & UnitaContratto & "," & lIdContratto & ",'" & Format(Now, "yyyyMMdd") & "')"
                            par.cmd.ExecuteNonQuery()

                            par.cmd.CommandText = "update siscom_mi.UNITA_STATO_MAN_S set DATA_RIPRESA_STR='" & par.IfNull(myReader("DATA_RIPRESA_STR"), "") _
                            & "', DATA_CONSEGNA_STR='" & par.IfNull(myReader("DATA_CONSEGNA_STR"), "") _
                            & "',ID_STRUTTURA_COMP=" & par.IfNull(myReader("ID_STRUTTURA_COMP"), "NULL") _
                            & ",ST_DEP_CHIAVI=" & par.IfNull(myReader("ST_DEP_CHIAVI"), "NULL") _
                                                & ",DATA_S='" & par.IfNull(myReader("DATA_S"), "") & "'" _
                                                & ",RILEVAZIONE=" & par.IfNull(myReader("RILEVAZIONE"), 0) _
                                                & ",RIASSEGNABILE=" & par.IfNull(myReader("RIASSEGNABILE"), 0) _
                                                & ", P_BLINDATA=" & par.IfNull(myReader("P_BLINDATA"), 0) _
                                                & ",SOL_GP=" & par.IfNull(myReader("SOL_GP"), 0) _
                                                & ",SOL_GF=" & par.IfNull(myReader("SOL_GF"), 0) _
                                                & ",SOL_PB=" & par.IfNull(myReader("SOL_PB"), 0) _
                                                & ",SOL_LA=" & par.IfNull(myReader("SOL_LA"), 0) _
                                                & ",SOL_AL=" & par.IfNull(myReader("SOL_AL"), 0) _
                                                & ",HANDICAP=" & par.IfNull(myReader("HANDICAP"), 0) _
                                                & ",DATA_PRE_S='" & par.IfNull(myReader("DATA_PRE_S"), "") _
                                                & "',DATA_PRE_SLOGGIO='" & par.IfNull(myReader("DATA_PRE_SLOGGIO"), "") _
                                                & "', NOTE='" & par.PulisciStrSql(par.IfNull(myReader("NOTE"), "")) _
                                                & "',ALLARME=" & par.IfNull(myReader("ALLARME"), 0) _
                                                & ", MOTIVAZIONI='" & par.PulisciStrSql(par.IfNull(myReader("MOTIVAZIONI"), "")) _
                                                & "', ZONA='" & par.PulisciStrSql(par.IfNull(myReader("ZONA"), "")) _
                                                & "', NUM_LOCALI='" & par.PulisciStrSql(par.IfNull(myReader("NUM_LOCALI"), "")) _
                                                & "',NUM_SERVIZI='" & par.PulisciStrSql(par.IfNull(myReader("NUM_SERVIZI"), "")) _
                                                & "', TIPO_ALLOGGIO=" & par.IfNull(myReader("TIPO_ALLOGGIO"), "NULL") _
                                                & ", DATA_CONSEGNA_CHIAVI='" & par.PulisciStrSql(par.IfNull(myReader("DATA_CONSEGNA_CHIAVI"), "")) _
                                                & "', CONSEGNATE_A='" & par.PulisciStrSql(par.IfNull(myReader("CONSEGNATE_A"), "")) _
                                                & "', DATA_RIPRESA_CHIAVI='" & par.PulisciStrSql(par.IfNull(myReader("DATA_RIPRESA_CHIAVI"), "")) _
                                                & "',ID_QUARTIERE=" & par.IfNull(myReader("ID_QUARTIERE"), 0) _
                                                & ", DATA_RILEVAZIONE='" & par.PulisciStrSql(par.IfNull(myReader("DATA_RILEVAZIONE"), "")) _
                                                & "', NOTEGRTP='" & par.PulisciStrSql(par.IfNull(myReader("NOTEGRTP"), "")) _
                                                & "', SOL_PB1=" & par.IfNull(myReader("SOL_PB1"), 0) _
                                                & ", SOL_PB2=" & par.IfNull(myReader("SOL_PB2"), 0) _
                                                & ", SOL_PB3=" & par.IfNull(myReader("SOL_PB3"), 0) _
                                                & ", SOL_LA1=" & par.IfNull(myReader("SOL_LA1"), 0) _
                                                & ", TIPO_RIASSEGNABILE=" & par.IfNull(myReader("TIPO_RIASSEGNABILE"), 0) _
                                                & ", FINE_LAVORI='" & par.IfNull(myReader("FINE_LAVORI"), 0) _
                                                & "', DATA_Q='" & par.IfNull(myReader("DATA_Q"), 0) _
                                                & "',IMPORTO_DANNI=" & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO_DANNI"), 0)) _
                                                & ", IMPORTO_TRASPORTO=" & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO_DANNI"), 0)) _
                                                & ", NOTE_DANNI='" & par.PulisciStrSql(par.IfNull(myReader("NOTE_DANNI"), "")) _
                                                & "', FL_AUTORIZZATI_IMP='" & par.IfNull(myReader("FL_AUTORIZZATI_IMP"), 0) _
                                                & "', REC_GRTP=" & par.IfNull(myReader("REC_GRTP"), 0) _
                                                & " WHERE ID_UNITA=" & UnitaContratto & " AND ID_CONTRATTO=" _
                                                & lIdContratto & " AND DATA_MEMO='" & Format(Now, "yyyyMMdd") & "'"





                            par.cmd.ExecuteNonQuery()
                        End If
                        myReader.Close()



                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.UNITA_STATO_MANUTENTIVO_INT WHERE ID_UNITA=" & UnitaContratto
                        myReader = par.cmd.ExecuteReader()
                        Do While myReader.Read
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.UNITA_STATO_MAN_INT_S (ID_UNITA,ID_INTERVENTO,DATA_MEMO) VALUES (" & UnitaContratto & "," & myReader("ID_INTERVENTO") & ",'" & Format(Now, "yyyyMMdd") & "')"
                            par.cmd.ExecuteNonQuery()
                        Loop
                        myReader.Close()

                        'par.cmd.CommandText = "delete from siscom_mi.unita_STATO_MANUTENTIVO where id_unita=" & UnitaContratto
                        'par.cmd.ExecuteNonQuery()


                        'INSERIMENTO AVVISO PER CONDOMINI
                        par.cmd.CommandText = "SELECT cond_edifici.* FROM SISCOM_MI.COND_EDIFICI,SISCOM_MI.EDIFICI,SISCOM_MI.UNITA_IMMOBILIARI WHERE UNITA_IMMOBILIARI.ID=" & UnitaContratto & " AND EDIFICI.ID=UNITA_IMMOBILIARI.ID_EDIFICIO AND COND_EDIFICI.ID_EDIFICIO=EDIFICI.ID"
                        myReader = par.cmd.ExecuteReader
                        Do While myReader.Read
                            'par.cmd.CommandText = "INSERT INTO SISCOM_MI.COND_AVVISI (ID_UI,EVENTO,DATA,VISTO,ID_CONDOMINIO) VALUES (" & UnitaContratto & ",'CHIUSURA RAPPORTO','" & Format(Now, "yyyyMMdd") & "',0," & myReader("ID_CONDOMINIO") & ")"
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.COND_AVVISI (ID_TIPO,ID_UI,DATA,VISTO,ID_CONDOMINIO,ID_CONTRATTO) VALUES (1," & UnitaContratto & ",'" & Format(Now, "yyyyMMdd") & "',0," & myReader("ID_CONDOMINIO") & "," & lIdContratto & ")"
                            par.cmd.ExecuteNonQuery()
                        Loop
                        myReader.Close()


                        txtModificato.Value = "0"
                        Tab_Contratto1.DisabilitaTutto()

                        If RIASSUNTO_BOLLETTA <> "" Then
                            If par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, 0) > 0 Then
                                Response.Write("<script>alert('Operazione Effettuata! La bolletta di fine rapporto è stata regolarmente creata.\nVerificare che le date di emissione e scadenza siano corrette.\nIn partita gestionale è stata creata la bolletta di restituzione deposito cauzionale');</script>")
                            Else
                                Response.Write("<script>alert('Operazione Effettuata! La bolletta di fine rapporto è stata regolarmente creata.\nVerificare che le date di emissione e scadenza siano corrette.');</script>")
                            End If
                        Else
                            Response.Write("<script>alert('Operazione Effettuata!');</script>")
                        End If

                        par.myTrans.Commit()
                        par.myTrans = par.OracleConn.BeginTransaction()
                        HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)
                    Else
                        Response.Write("<script>alert('Il contratto si può considerare chiuso solo se è presente una data di sloggio!');</script>")
                    End If



                    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"

                End If
            Else
                txtModificato.Value = "1"
                CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            End If

            Generale1.Provenienza = TipoContratto
            Generale1.IndiceDichiarazione = lIdDichiarazione
            Generale1.IndiceDomanda = lIdDomandaERP
            Generale1.IndiceAnagrafe = lIdAU



        Catch ex As Exception
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Sub

    Public Property Capoluoghi() As String
        Get
            If Not (ViewState("par_Capoluoghi") Is Nothing) Then
                Return CStr(ViewState("par_Capoluoghi"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_Capoluoghi") = value
        End Set

    End Property

    Private Function CaricaCapoluoghi()
        Capoluoghi = "AGRIGENTO (SICILIA) " _
        & "ALESSANDRIA(PIEMONTE) " _
        & "ANCONA(MARCHE) " _
& "AOSTA (VALLE D'AOSTA) " _
        & "AREZZO(TOSCANA) " _
        & "ASCOLI PICENO(MARCHE)) " _
        & "ASTI(PIEMONTE) " _
        & "AVELLINO(CAMPANIA) " _
        & "BARI(PUGLIA)  " _
        & "TRANI() " _
        & "ANDRIA() " _
        & "BARLETTA() " _
        & "BELLUNO(VENETO) " _
        & "BENEVENTO(CAMPANIA) " _
        & "BERGAMO(LOMBARDIA) " _
        & "BIELLA(PIEMONTE) " _
        & "BOLOGNA(EMILIA - ROMAGNA) " _
& "BOLZANO (TRENTINO-ALTO ADIGE) " _
        & "BRESCIA(LOMBARDIA) " _
        & "BRINDISI(PUGLIA) " _
        & "CAGLIARI(SARDEGNA) " _
        & "CALTANISSETTA(SICILIA) " _
        & "CAMPOBASSO(MOLISE) " _
        & "CARBONIA-IGLESIAS(SARDEGNA)) " _
        & "CASERTA(CAMPANIA) " _
        & "CATANIA(SICILIA) " _
        & "CATANZARO(CALABRIA) " _
        & "CHIETI(ABRUZZO) " _
        & "COMO(LOMBARDIA) " _
        & "COSENZA(CALABRIA) " _
        & "CREMONA(LOMBARDIA) " _
        & "CROTONE(CALABRIA) " _
        & "CUNEO(PIEMONTE) " _
        & "ENNA(SICILIA) " _
        & "FERMO(MARCHE) " _
        & "FERRARA(EMILIA - ROMAGNA) " _
        & "FIRENZE(TOSCANA) " _
        & "FOGGIA(PUGLIA) " _
        & "FORLÌ-CESENA(EMILIA - ROMAGNA) " _
        & "FROSINONE(LAZIO) " _
        & "GENOVA(LIGURIA) " _
& "GORIZIA (FRIULI-VENEZIA GIULIA) " _
        & "GROSSETO(TOSCANA) " _
        & "IMPERIA(LIGURIA) " _
        & "ISERNIA(MOLISE) " _
        & "LA SPEZIA(LIGURIA)) " _
        & "L'AQUILA (ABRUZZO) " _
        & "LATINA(LAZIO) " _
        & "LECCE(PUGLIA) " _
        & "LECCO(LOMBARDIA) " _
        & "LIVORNO(TOSCANA) " _
        & "LODI(LOMBARDIA) " _
        & "LUCCA(TOSCANA) " _
        & "MACERATA(MARCHE) " _
        & "MANTOVA(LOMBARDIA) " _
        & "MASSA-CARRARA(TOSCANA)) " _
        & "MATERA(BASILICATA) " _
        & "MESSINA(SICILIA) " _
        & " " _
        & "MODENA(EMILIA - ROMAGNA) " _
        & "MONZA() " _
        & "NAPOLI(CAMPANIA) " _
        & "NOVARA(PIEMONTE) " _
        & "NUORO(SARDEGNA) " _
        & "OLBIA(-TEMPIO(SARDEGNA)) " _
        & "ORISTANO(SARDEGNA) " _
        & "PADOVA(VENETO)" _
        & "PALERMO(SICILIA) " _
        & "PARMA(EMILIA - ROMAGNA) " _
        & "PAVIA(LOMBARDIA) " _
        & "PERUGIA(UMBRIA) " _
& "PESARO E URBINO (MARCHE) " _
   & "PESCARA(ABRUZZO) " _
      & "  PIACENZA(EMILIA - ROMAGNA) " _
        & "PISA(TOSCANA) " _
        & "PISTOIA(TOSCANA) " _
& "PORDENONE (FRIULI-VENEZIA GIULIA) " _
        & "POTENZA(BASILICATA) " _
        & "PRATO(TOSCANA) " _
        & "RAGUSA(SICILIA) " _
        & "RAVENNA(EMILIA - ROMAGNA) " _
        & "REGGIO CALABRIA(CALABRIA)) " _
        & "REGGIO EMILIA(EMILIA - ROMAGNA)) " _
        & "RIETI(LAZIO)  " _
        & "RIMINI(EMILIA - ROMAGNA) " _
        & "ROMA(LAZIO) " _
        & "ROVIGO(VENETO) " _
        & "SALERNO(CAMPANIA) " _
        & "MEDIO CAMPIDANO(SARDEGNA))  " _
        & "SASSARI(SARDEGNA)  " _
        & "SAVONA(LIGURIA) " _
        & "SIENA(TOSCANA) " _
        & "SIRACUSA(SICILIA) " _
        & "SONDRIO(LOMBARDIA) " _
        & "TARANTO(PUGLIA) " _
        & "TERAMO(ABRUZZO) " _
        & "TERNI(UMBRIA) " _
        & "TORINO(PIEMONTE) " _
        & "OGLIASTRA(SARDEGNA) " _
        & "TRAPANI(SICILIA) " _
& "TRENTO (TRENTINO-ALTO ADIGE) " _
        & "TREVISO(VENETO) " _
& "TRIESTE (FRIULI-VENEZIA GIULIA) " _
& "UDINE (FRIULI-VENEZIA GIULIA) " _
   & "     OSSOLA() " _
      & "  VARESE(LOMBARDIA) " _
        & "CUSIO() " _
        & "VENEZIA(VENETO) " _
        & "VERBANIA() " _
        & "VERBANO() " _
        & "VERCELLI(PIEMONTE) " _
        & "VERONA(VENETO) " _
        & "VIBO VALENTIA(CALABRIA)) " _
        & "VICENZA(VENETO) " _
        & "VITERBO(LAZIO)"
    End Function





    Private Function CaricaDati()

        Dim FREQ_VAR_ISTAT As String = ""
        Dim PERC_ISTAT As Double = 0
        Dim StatoRapporto As String = "LEGIT" 'legittimo o illegittimo

        Try


            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans

            CaricaCompContratto(lIdContratto)
            'CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Clear()
            'CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Clear()

            'Dim INTESTAT As String = ""

            ''CARICO INTESTATARI
            'par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.data_inizio,SOGGETTI_CONTRATTUALI.data_fine,TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",ANAGRAFICA.* FROM SISCOM_MI.TIPOLOGIA_PARENTELA,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE TIPOLOGIA_PARENTELA.COD=SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_PARENTELA AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND  COD_TIPOLOGIA_OCCUPANTE='INTE' AND ID_CONTRATTO=" & lIdContratto
            'Dim myReader2 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            'Do While myReader2.Read
            '    If par.IfNull(myReader2("RAGIONE_SOCIALE"), "") <> "" Then
            '        CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("RAGIONE_SOCIALE"), ""), 37) & " " & par.MiaFormat(par.IfNull(myReader2("PARTITA_IVA"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
            '        INTESTAT = par.IfNull(myReader2("RAGIONE_SOCIALE"), "")
            '    Else
            '        CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReader2("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReader2("COD_FISCALE"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
            '        INTESTAT = par.IfNull(myReader2("COGNOME"), "") & " " & par.IfNull(myReader2("NOME"), "")
            '    End If

            'Loop
            'myReader2.Close()
            'CType(Tab_Comunicazioni1.FindControl("txtPresso"), TextBox).Text = INTESTAT

            ''CARICO COINTESTATARI
            'par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.data_inizio,SOGGETTI_CONTRATTUALI.data_fine,TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",ANAGRAFICA.* FROM SISCOM_MI.TIPOLOGIA_PARENTELA,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE TIPOLOGIA_PARENTELA.COD=SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_PARENTELA AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND  COD_TIPOLOGIA_OCCUPANTE='COINT' AND ID_CONTRATTO=" & lIdContratto
            'myReader2 = par.cmd.ExecuteReader()
            'Do While myReader2.Read
            '    If par.IfNull(myReader2("RAGIONE_SOCIALE"), "") <> "" Then
            '        CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("RAGIONE_SOCIALE"), ""), 37) & " " & par.MiaFormat(par.IfNull(myReader2("PARTITA_IVA"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
            '    Else
            '        CType(Tab_Conduttore1.FindControl("lstIntestatari"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReader2("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReader2("COD_FISCALE"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
            '    End If
            'Loop
            'myReader2.Close()





            ''CARICAMENTO OCCUPANTI
            'par.cmd.CommandText = "SELECT SOGGETTI_CONTRATTUALI.data_inizio,SOGGETTI_CONTRATTUALI.data_fine,TIPOLOGIA_PARENTELA.DESCRIZIONE AS ""PARENTE"",ANAGRAFICA.* FROM SISCOM_MI.TIPOLOGIA_PARENTELA,SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE TIPOLOGIA_PARENTELA.COD=SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_PARENTELA AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND  COD_TIPOLOGIA_OCCUPANTE<>'INTE' AND COD_TIPOLOGIA_OCCUPANTE<>'COINT' AND ID_CONTRATTO=" & lIdContratto & " order by anagrafica.cognome asc,anagrafica.nome asc,SOGGETTI_CONTRATTUALI.data_inizio"
            'myReader2 = par.cmd.ExecuteReader()
            'Do While myReader2.Read
            '    If par.IfNull(myReader2("RAGIONE_SOCIALE"), "") <> "" Then
            '        CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("RAGIONE_SOCIALE"), ""), 37) & " " & par.MiaFormat(par.IfNull(myReader2("PARTITA_IVA"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
            '    Else
            '        CType(Tab_Conduttore1.FindControl("lstComponenti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("COGNOME"), ""), 20) & " " & par.MiaFormat(par.IfNull(myReader2("NOME"), ""), 16) & " " & par.MiaFormat(par.IfNull(myReader2("COD_FISCALE"), ""), 16) & " " & par.MiaFormat(UCase(par.IfNull(myReader2("PARENTE"), "")), 20) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio"), "")), 10) & " " & par.FormattaData(par.IfNull(myReader2("data_fine"), "")), myReader2("ID")))
            '    End If

            'Loop
            'myReader2.Close()

            ''CARICAMENTO OSPITI
            'CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Clear()

            'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.OSPITI WHERE ID_CONTRATTO=" & lIdContratto & " ORDER BY DATA_AGG DESC"
            'myReader2 = par.cmd.ExecuteReader()
            'Do While myReader2.Read
            '    CType(Tab_Conduttore1.FindControl("lstOspiti"), ListBox).Items.Add(New ListItem(par.MiaFormat(par.IfNull(myReader2("nominativo"), ""), 30) & " " & par.MiaFormat(par.IfNull(myReader2("cod_fiscale"), ""), 16) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_inizio_ospite"), "")), 15) & " " & par.MiaFormat(par.FormattaData(par.IfNull(myReader2("data_fine_ospite"), "")), 15), myReader2("ID")))
            'Loop
            'myReader2.Close()



            'RICARICO IL CONDUTTORE NEL TAB GENERALE PERCHè POTREBBE ESSERE CAMBIATO
            Dim Conduttore As String = ""
            Dim Conduttore1 As String = ""

            par.cmd.CommandText = "SELECT anagrafica.id,CASE WHEN anagrafica.ragione_sociale is not null THEN ragione_sociale  ELSE RTRIM(LTRIM(COGNOME ||' ' ||NOME)) END AS ""INTESTATARIO"" FROM SISCOM_MI.ANAGRAFICA,SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE SOGGETTI_CONTRATTUALI.ID_CONTRATTO=" & lIdContratto & " AND (SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='INTE' OR SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='COINT') AND ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA ORDER BY SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE DESC"
            Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            Do While myReader1.Read
                Conduttore = Conduttore & par.IfNull(myReader1("INTESTATARIO"), "") & ", "
                'Conduttore1 = Conduttore1 & "<a href='#' onclick=" & Chr(34) & "window.open('anagrafica/Inserimento.aspx?DAC=1&ID=" & par.IfNull(myReader1("id"), "-1") & "','Anagrafe','height=500,top=0,left=0,width=500,scroll=no,status=no');" & Chr(34) & ">" & par.IfNull(myReader1("INTESTATARIO"), "") & "</a>, "
                Conduttore1 = Conduttore1 & "<a href='#' onclick=" & Chr(34) & "document.getElementById('Generale1_hAnagrafica').value='" & par.IfNull(myReader1("id"), "-1") & "';myOpacity10.toggle();" & Chr(34) & ">" & par.IfNull(myReader1("INTESTATARIO"), "") & "</a>, "

                txtCodAffittuario.Value = par.IfNull(myReader1("id"), "-1")
            Loop
            myReader1.Close()

            If Len(Conduttore) > 40 Then
                CType(Generale1.FindControl("lblConduttore"), Label).Font.Size = 8
            End If
            CType(Generale1.FindControl("lblConduttore"), Label).Text = Conduttore1
            txtconduttore.Value = Replace(Conduttore, "<br />", ", ")

            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"



        Catch EX1 As Oracle.DataAccess.Client.OracleException
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & EX1.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        Catch ex As Exception
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")

        End Try
    End Function

    Protected Sub btnCambioIntBox_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs) Handles btnCambioIntBox.Click
        Try
            If FaiCambioBox.Value = "1" Then
                par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
                par.SettaCommand(par)
                par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)
                '‘par.cmd.Transaction = par.myTrans

                CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text = RinnovoDataChiusura.Value
                CambioBox.Value = "0"
                ChiudiPerRinnovo(CFRinnovoBoxUSD.Value)
                imgSalva_Click(sender, e)
                Response.Write("<script>popupWindow = window.open('Contratto.aspx?ID=" & lNuovoIdRapporto & "&COD=" & sNuovoCodiceRapporto & "', '" & sNuovoCodiceRapporto & "', 'height=780,width=1160');</script>")
                imgEsci_Click(sender, e)
            End If
        Catch ex As Exception

        End Try
    End Sub

    Protected Sub btnRinnovoUSD_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs) Handles btnRinnovoUSD.Click
        Try
            If FaiRinnovoUSD.Value = "1" Then
                CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text = RinnovoDataChiusura.Value
                RinnovoUSD.Value = "0"
                ChiudiPerRinnovo("-1")
                imgSalva_Click(sender, e)
                Response.Write("<script>popupWindow = window.open('Contratto.aspx?ID=" & lNuovoIdRapporto & "&COD=" & sNuovoCodiceRapporto & "', '" & sNuovoCodiceRapporto & "', 'height=700,width=1160');</script>")
                imgEsci_Click(sender, e)
            End If
        Catch ex As Exception

        End Try
    End Sub

    Private Function ChiudiPerRinnovo(ByVal CodFis As String)
        Try

            Dim DESTINAZIONE As String = ""

            Dim Risoluzione As Boolean = False
            Dim importoRisoluzione As Double = 0
            Dim IMPORTOINTERESSI As Double = 0
            Dim sAggiunta As String = ""
            Dim DataCalcolo As String = ""
            Dim DataInizio As String = ""

            Dim tasso As Double = 0
            Dim baseCalcolo As Double = 0

            Dim Giorni As Integer = 0
            Dim GiorniAnno As Integer = 0
            Dim dataPartenza As String = ""

            Dim Totale As Double = 0
            Dim TotalePeriodo As Double = 0
            Dim indice As Long = 0
            Dim DataFine As String = ""
            Dim num_bolletta As String = ""
            Dim importobolletta As Double = 0
            Dim I As Integer = 0

            Dim importodanni As Double = 0
            Dim importotrasporto As Double = 0

            Dim Interessi As New SortedDictionary(Of Integer, Double)

            Dim RIASSUNTO_BOLLETTA As String = ""

            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)
            '‘par.cmd.Transaction = par.myTrans




            If CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text <> "" Then


                Risoluzione = True
                par.cmd.CommandText = "select * from siscom_mi.parametri_bolletta where id=1"
                Dim myReaderAa As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderAa.Read Then
                    importoRisoluzione = CDbl(par.PuntiInVirgole(myReaderAa("valore")))
                End If
                myReaderAa.Close()
                importodanni = 0
                importotrasporto = 0

                If CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text = CType(Tab_Contratto1.FindControl("txtDataSecScadenza"), TextBox).Text Or CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text = CType(Tab_Contratto1.FindControl("txtDataScadenza"), TextBox).Text Then
                    importoRisoluzione = 0
                End If

                par.cmd.CommandText = "select * from siscom_mi.tab_interessi_legaLI order by anno desc"
                Interessi.Clear()
                Dim myReaderC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                Do While myReaderC.Read
                    Interessi.Add(myReaderC("anno"), myReaderC("tasso"))
                Loop
                myReaderC.Close()

                DataCalcolo = par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text)
                baseCalcolo = par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, 0)
                If baseCalcolo > 0 And CType(Tab_Canone1.FindControl("checkInteressiCauzione"), CheckBox).Checked = True Then

                    par.cmd.CommandText = "select * from siscom_mi.adeguamento_interessi where id_contratto=" & lIdContratto & " order by id desc"
                    Dim myReaderZ As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderZ.HasRows = False Then
                        DataInizio = par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text)
                    End If
                    If myReaderZ.Read Then
                        DataInizio = Format(DateAdd(DateInterval.Day, 1, CDate(par.FormattaData(myReaderZ("data")))), "yyyyMMdd")
                    End If
                    myReaderZ.Close()

                    Giorni = 0
                    GiorniAnno = 0
                    dataPartenza = DataInizio
                    Totale = 0
                    TotalePeriodo = 0

                    par.cmd.CommandText = "insert into siscom_mi.adeguamento_interessi (id,id_contratto,data,fl_applicato) values (siscom_mi.seq_adeguamento_interessi.nextval," & lIdContratto & ",'" & DataCalcolo & "',1)"
                    par.cmd.ExecuteNonQuery()
                    par.cmd.CommandText = "select siscom_mi.seq_adeguamento_interessi.currval from dual"
                    myReaderZ = par.cmd.ExecuteReader()
                    indice = 0
                    If myReaderZ.Read Then
                        indice = myReaderZ(0)
                    End If

                    For I = CInt(Mid(DataInizio, 1, 4)) To CInt(Mid(DataCalcolo, 1, 4))

                        If I = CInt(Mid(DataCalcolo, 1, 4)) Then
                            DataFine = par.FormattaData(DataCalcolo)
                        Else
                            DataFine = "31/12/" & I

                        End If

                        GiorniAnno = DateDiff(DateInterval.Day, CDate("01/01/" & I), CDate("31/12/" & I)) + 1

                        Giorni = DateDiff(DateInterval.Day, CDate(par.FormattaData(dataPartenza)), CDate(DataFine)) + 1

                        If I < 1990 Then
                            tasso = 5
                        Else
                            If Interessi.ContainsKey(I) = True Then
                                tasso = Interessi(I)
                            End If
                        End If

                        TotalePeriodo = Format((((baseCalcolo * tasso) / 100) / GiorniAnno) * Giorni, "0.00")
                        Totale = Totale + TotalePeriodo
                        par.cmd.CommandText = "insert into siscom_mi.adeguamento_interessi_voci (id_adeguamento,dal,al,giorni,tasso,importo) values (" & indice & ",'" & dataPartenza & "','" & Format(CDate(DataFine), "yyyyMMdd") & "'," & Giorni & "," & par.VirgoleInPunti(tasso) & "," & par.VirgoleInPunti(TotalePeriodo) & ")"
                        par.cmd.ExecuteNonQuery()
                        dataPartenza = I + 1 & "0101"
                    Next
                    par.cmd.CommandText = "update siscom_mi.adeguamento_interessi set importo=" & par.VirgoleInPunti(Format(Totale, "0.00")) & " where id=" & indice
                    par.cmd.ExecuteNonQuery()
                End If


                If CodFis <> "-1" Then
                    If IDRinnovoBoxUSD.Value <> "&nbsp;" Then
                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & IDRinnovoBoxUSD.Value
                        Dim myReaderS1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderS1.Read = True Then
                            par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET TIPO_COR='" & par.PulisciStrSql(par.IfNull(myReaderS1("TIPO_COR"), "VIA")) _
                                                & "',LUOGO_COR='" & par.PulisciStrSql(par.IfNull(myReaderS1("LUOGO_COR"), "")) _
                                                & "',VIA_COR='" & par.PulisciStrSql(par.IfNull(myReaderS1("VIA_COR"), "")) _
                                                & "',CIVICO_COR='" & par.PulisciStrSql(par.IfNull(myReaderS1("CIVICO_COR"), "")) _
                                                & "',SIGLA_COR='" & par.PulisciStrSql(par.IfNull(myReaderS1("SIGLA_COR"), "")) _
                                                & "',CAP_COR='" & par.PulisciStrSql(par.IfNull(myReaderS1("CAP_COR"), "")) _
                                                & "',PRESSO_COR='" & par.PulisciStrSql(par.IfNull(myReaderS1("PRESSO_COR"), "")) _
                                                & "',SCALA_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtScalaCor"), TextBox).Text) _
                                                & "',PIANO_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtPianoCor"), TextBox).Text) _
                                                & "',INTERNO_COR='" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtInternoCor"), TextBox).Text) & "'" _
                                                & " WHERE ID=" & lIdContratto
                            par.cmd.ExecuteNonQuery()
                        End If
                        myReaderS1.Close()
                    End If
                End If


                Dim DataScadenza As String = DateAdd("d", 10, Now)
                Dim TOTALE_BOLLETTA As Double = 0

                par.cmd.CommandText = "select RAPPORTI_UTENZA.*,EDIFICI.ID_COMPLESSO,UNITA_CONTRATTUALE.ID_EDIFICIO FROM SISCOM_MI.UNITA_CONTRATTUALE,SISCOM_MI.EDIFICI,SISCOM_MI.RAPPORTI_UTENZA WHERE UNITA_CONTRATTUALE.ID_UNITA_PRINCIPALE IS NULL AND RAPPORTI_UTENZA.ID=" & lIdContratto & " AND UNITA_CONTRATTUALE.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND EDIFICI.ID=UNITA_CONTRATTUALE.ID_EDIFICIO"
                Dim myReaderS As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderS.Read Then


                    'DESTINAZIONE = par.IfNull(myReaderS("TIPO_COR"), "")


                    par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE " _
                                                    & "(ID, N_RATA, DATA_EMISSIONE, DATA_SCADENZA, DATA_I_SOLLECITO, " _
                                                    & "DATA_II_SOLLECITO, DATA_PAGAMENTO, NOTE, ID_CONTRATTO, ID_ESERCIZIO_F, " _
                                                    & "ID_UNITA, FL_ANNULLATA, PAGABILE_PRESSO, COD_AFFITTUARIO, INTESTATARIO, " _
                                                    & "INDIRIZZO, CAP_CITTA, PRESSO, RIFERIMENTO_DA, RIFERIMENTO_A, " _
                                                    & "FL_STAMPATO, ID_COMPLESSO, DATA_INS_PAGAMENTO, IMPORTO_PAGATO, NOTE_PAGAMENTO, " _
                                                    & "ANNO, OPERATORE_PAG, ID_EDIFICIO, DATA_ANNULLO_PAG, OPERATORE_ANNULLO_PAG,RIF_FILE,ID_TIPO) " _
                                                    & "Values " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE.NEXTVAL, 999, '" & Format(Now, "yyyyMMdd") _
                                                    & "', '" & Format(CDate(DataScadenza), "yyyyMMdd") & "', NULL,NULL,NULL,'FINE CONTRATTO'," _
                                                    & "" & lIdContratto _
                                                    & " ," & par.RicavaEsercizioCorrente & ", " _
                                                    & UnitaContratto _
                                                    & ", '0', '', " & CType(Me.Page.FindControl("txtCodAffittuario"), HiddenField).Value _
                                                    & ", '" & par.PulisciStrSql(par.IfNull(myReaderS("PRESSO_COR"), "")) & "', " _
                                                    & "'" & par.PulisciStrSql(par.IfNull(myReaderS("TIPO_COR"), "") & " " & par.IfNull(myReaderS("VIA_COR"), "") & ", " & par.PulisciStrSql(par.IfNull(myReaderS("CIVICO_COR"), ""))) _
                                                    & "', '" & par.PulisciStrSql(par.IfNull(myReaderS("CAP_COR"), "") & " " & par.IfNull(myReaderS("LUOGO_COR"), "") & "(" & par.IfNull(myReaderS("SIGLA_COR"), "") & ")") _
                                                    & "', '', '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text) _
                                                    & "', '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text) & "', " _
                                                    & "'0', " & myReaderS("ID_COMPLESSO") & ", '', NULL, '', " _
                                                    & Year(Now) & ", '', " & myReaderS("ID_EDIFICIO") & ", NULL, NULL,'FIN',3)"

                    par.cmd.ExecuteNonQuery()
                    par.cmd.CommandText = "select SISCOM_MI.SEQ_BOL_BOLLETTE.CURRVAL FROM DUAL"
                    Dim myReaderA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderA.Read Then
                        Dim ID_BOLLETTA As Long = myReaderA(0)


                        If importoRisoluzione > 0 Then
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                & ",35" _
                                                & "," & par.VirgoleInPunti(importoRisoluzione) & ")"
                            RIASSUNTO_BOLLETTA = "Risoluzione: " & par.VirgoleInPunti(importoRisoluzione) & " Euro;\n"
                            par.cmd.ExecuteNonQuery()

                            TOTALE_BOLLETTA = importoRisoluzione
                        End If

                        If importodanni > 0 Then
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                & ",100" _
                                                & "," & par.VirgoleInPunti(importodanni) & ")"
                            RIASSUNTO_BOLLETTA = "Risoluzione: " & par.VirgoleInPunti(importodanni) & " Euro;\n"
                            par.cmd.ExecuteNonQuery()

                            TOTALE_BOLLETTA = TOTALE_BOLLETTA + importodanni
                        End If

                        If importotrasporto > 0 Then
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                & ",101" _
                                                & "," & par.VirgoleInPunti(importotrasporto) & ")"
                            RIASSUNTO_BOLLETTA = "Risoluzione: " & par.VirgoleInPunti(importotrasporto) & " Euro;\n"
                            par.cmd.ExecuteNonQuery()

                            TOTALE_BOLLETTA = TOTALE_BOLLETTA + importotrasporto
                        End If


                        If Totale > 0 And CType(Tab_Canone1.FindControl("checkInteressiCauzione"), CheckBox).Checked = True Then
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                & ",15" _
                                                & "," & par.VirgoleInPunti(Format(Totale * -1, "0.00")) & ")"
                            par.cmd.ExecuteNonQuery()
                            RIASSUNTO_BOLLETTA = RIASSUNTO_BOLLETTA & "Rimborso Interessi Annuo Cauzione: " & par.VirgoleInPunti(Format(Totale * -1, "0.00")) & " Euro;\n"
                            TOTALE_BOLLETTA = TOTALE_BOLLETTA + (Totale * -1)

                        End If

                        'If baseCalcolo > 0 Then
                        '    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                        '                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                        '                        & ",50" _
                        '                        & "," & par.VirgoleInPunti(Format(baseCalcolo * -1, "0.00")) & ")"
                        '    par.cmd.ExecuteNonQuery()
                        '    RIASSUNTO_BOLLETTA = RIASSUNTO_BOLLETTA & "Rimborso Deposito Cauzionale: " & par.VirgoleInPunti(Format(baseCalcolo * -1, "0.00")) & " Euro;\n"
                        '    TOTALE_BOLLETTA = TOTALE_BOLLETTA + (baseCalcolo * -1)

                        'End If

                        Dim Giorni1 As Integer = 0
                        Dim Giorni2 As Integer = 0
                        Dim SPESEmav As Double = 0
                        Dim BOLLO As Double = 0
                        Dim APPLICABOLLO As Double = 0

                        Dim PARTENZA As String = ""
                        Dim FINE As String = ""


                        par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=26"
                        myReaderA = par.cmd.ExecuteReader()
                        If myReaderA.Read Then
                            SPESEmav = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                        End If
                        myReaderA.Close()

                        par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=0"
                        myReaderA = par.cmd.ExecuteReader()
                        If myReaderA.Read Then
                            BOLLO = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                        End If
                        myReaderA.Close()

                        par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=25"
                        myReaderA = par.cmd.ExecuteReader()
                        If myReaderA.Read Then
                            APPLICABOLLO = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                        End If
                        myReaderA.Close()

                        Dim SPESEPOSTALI As Double = 0
                        Dim SPESEPOSTALI_CAPOLUOGHI As Double = 0
                        Dim SPESEPOSTALI_ALTRI As Double = 0
                        Dim SPESEPOSTALI_DA_APPLICARE As Double = 0

                        par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=17"
                        myReaderA = par.cmd.ExecuteReader()
                        If myReaderA.Read Then
                            SPESEPOSTALI = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                        End If
                        myReaderA.Close()

                        par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=29"
                        myReaderA = par.cmd.ExecuteReader()
                        If myReaderA.Read Then
                            SPESEPOSTALI_CAPOLUOGHI = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                        End If
                        myReaderA.Close()

                        par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=30"
                        myReaderA = par.cmd.ExecuteReader()
                        If myReaderA.Read Then
                            SPESEPOSTALI_ALTRI = CDbl(par.PuntiInVirgole(myReaderA("VALORE")))
                        End If
                        myReaderA.Close()

                        If UCase(CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text) = "MILANO" Then
                            SPESEPOSTALI_DA_APPLICARE = SPESEPOSTALI
                        Else
                            If InStr(Capoluoghi, UCase(CType(Tab_Comunicazioni1.FindControl("txtLuogoCor"), TextBox).Text)) > 0 Then
                                SPESEPOSTALI_DA_APPLICARE = SPESEPOSTALI_CAPOLUOGHI
                            Else
                                SPESEPOSTALI_DA_APPLICARE = SPESEPOSTALI_ALTRI
                            End If
                        End If


                        par.cmd.CommandText = "select * FROM SISCOM_MI.BOL_BOLLETTE WHERE FL_ANNULLATA='0' AND N_RATA<>99 AND N_RATA<>999 AND N_RATA<>99999 AND ID_CONTRATTO=" & lIdContratto & " ORDER BY ID DESC"
                        myReaderA = par.cmd.ExecuteReader()
                        If myReaderA.Read Then
                            PARTENZA = myReaderA("RIFERIMENTO_A")
                        End If
                        myReaderA.Close()

                        FINE = par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text)

                        If PARTENZA <> "" And FINE <> "" Then
                            Giorni1 = DateDiff("d", CDate(par.FormattaData(PARTENZA)), CDate(par.FormattaData(FINE)))


                            If Giorni1 > 0 Then
                                'calcolo l'importo dell'affitto in base al numero di rate annue

                                Dim affitto As Double = 0

                                If par.IfNull(myReaderS("imp_CANONE_INIZIALE"), 0) > 0 Then
                                    affitto = Format((par.IfNull(myReaderS("imp_CANONE_INIZIALE"), 1) / 365) * (Giorni1), "0.00")
                                    TOTALE_BOLLETTA = TOTALE_BOLLETTA + (par.IfNull(myReaderS("imp_CANONE_INIZIALE"), 1) / 365) * (Giorni1)

                                    If par.IfNull(myReaderS("PROVENIENZA_ASS"), "") <> "7" Then
                                        If FINE = par.IfNull(myReaderS("data_scadenza_rinnovo"), "") Then
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",36" _
                                                                & "," & par.VirgoleInPunti(affitto) & ")"
                                            par.cmd.ExecuteNonQuery()
                                        Else
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",1" _
                                                                & "," & par.VirgoleInPunti(affitto) & ")"
                                            par.cmd.ExecuteNonQuery()
                                        End If
                                    Else
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",560" _
                                            & "," & par.VirgoleInPunti(affitto) & ")"
                                        par.cmd.ExecuteNonQuery()
                                    End If


                                End If
                            End If
                        End If

                        If Giorni1 > 0 Then
                            Dim aggiornamento_istat As Double = 0
                            Dim AltriAdeguamenti As Double = 0

                            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo=2 and ID_CONTRATTO=" & lIdContratto
                            myReaderA = par.cmd.ExecuteReader()
                            If myReaderA.Read Then
                                aggiornamento_istat = par.IfNull(myReaderA(0), 0)
                            End If
                            myReaderA.Close()

                            par.cmd.CommandText = "SELECT SUM(IMPORTO) FROM SISCOM_MI.RAPPORTI_UTENZA_AD_CANONE WHERE id_motivo<>2 and ID_CONTRATTO=" & lIdContratto
                            myReaderA = par.cmd.ExecuteReader()
                            If myReaderA.Read Then
                                AltriAdeguamenti = par.IfNull(myReaderA(0), 0)
                            End If
                            myReaderA.Close()

                            If aggiornamento_istat > 0 Then

                                TOTALE_BOLLETTA = TOTALE_BOLLETTA + Format((aggiornamento_istat / 365) * Giorni1, "0.00")
                                aggiornamento_istat = (aggiornamento_istat / 365) * Giorni1

                                If FINE = par.IfNull(myReaderS("data_scadenza_rinnovo"), "") Or par.IfNull(myReaderS("PROVENIENZA_ASS"), "") = "7" Then
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",405" _
                                                        & "," & par.VirgoleInPunti(Format(aggiornamento_istat, "0.00")) & ")"
                                    par.cmd.ExecuteNonQuery()
                                Else
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",404" _
                                                        & "," & par.VirgoleInPunti(Format(aggiornamento_istat, "0.00")) & ")"
                                    par.cmd.ExecuteNonQuery()
                                End If
                            End If

                            If AltriAdeguamenti > 0 Then

                                TOTALE_BOLLETTA = TOTALE_BOLLETTA + Format((AltriAdeguamenti / 365) * Giorni1, "0.00")
                                AltriAdeguamenti = (AltriAdeguamenti / 365) * Giorni1


                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",652" _
                                                    & "," & par.VirgoleInPunti(Format(AltriAdeguamenti, "0.00")) & ")"
                                par.cmd.ExecuteNonQuery()

                            End If

                            par.cmd.CommandText = "select bol_schema.*,t_voci_bolletta.descrizione from siscom_mi.bol_schema,siscom_mi.t_voci_bolletta where anno=" & Year(Now) & " and da_rata=1 And per_rate=12 AND t_voci_bolletta.id=bol_schema.id_voce and  bol_schema.id_contratto=" & lIdContratto
                            myReaderA = par.cmd.ExecuteReader()
                            Do While myReaderA.Read

                                TOTALE_BOLLETTA = TOTALE_BOLLETTA + CDbl((myReaderA("importo") / 365) * Giorni1)

                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & "," & myReaderA("ID_VOCE") _
                                                    & "," & par.VirgoleInPunti(Format((myReaderA("importo") / 365) * Giorni1, "0.00")) & ")"
                                par.cmd.ExecuteNonQuery()


                            Loop
                            myReaderA.Close()
                        End If

                        If SPESEmav > 0 Then
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",407" _
                            & "," & par.VirgoleInPunti(Format(SPESEmav, "0.00")) & ")"
                            par.cmd.ExecuteNonQuery()

                            TOTALE_BOLLETTA = TOTALE_BOLLETTA + SPESEmav
                        End If


                        Dim TotMorosita As Double = 0
                        Dim TotMorositaSB As Double = 0
                        'par.cmd.CommandText = "select BOL_BOLLETTE.id,(SELECT NVL(SUM(BOL_BOLLETTE_VOCI.importo),0)-NVL(SUM(BOL_BOLLETTE_VOCI.imp_pagato),0) FROM siscom_mi.BOL_BOLLETTE_VOCI,siscom_mi.T_VOCI_BOLLETTA WHERE T_VOCI_BOLLETTA.competenza=3 AND T_VOCI_BOLLETTA.ID=BOL_BOLLETTE_VOCI.id_voce AND BOL_BOLLETTE_VOCI.id_bolletta=BOL_BOLLETTE.ID) AS importo_sindacati,(SELECT NVL(SUM(BOL_BOLLETTE_VOCI.importo),0)-NVL(SUM(BOL_BOLLETTE_VOCI.imp_pagato),0) FROM siscom_mi.BOL_BOLLETTE_VOCI,siscom_mi.T_VOCI_BOLLETTA WHERE T_VOCI_BOLLETTA.competenza<>3 AND T_VOCI_BOLLETTA.ID=BOL_BOLLETTE_VOCI.id_voce AND BOL_BOLLETTE_VOCI.id_bolletta=BOL_BOLLETTE.ID) AS importo_altri FROM SISCOM_MI.BOL_BOLLETTE WHERE bol_bollette.data_scadenza<" & Format(Now, "yyyyMMdd") & " and FL_ANNULLATA='0' AND ID_BOLLETTA_RIC IS NULL AND (ID_TIPO=1 OR ID_TIPO=2 OR ID_TIPO=6 or id_tipo=8) AND importo_totale<>nvl(importo_pagato,0) and ID_CONTRATTO=" & lIdContratto
                        'myReaderA = par.cmd.ExecuteReader()
                        'Do While myReaderA.Read
                        '    TotMorositaSB = 0
                        '    TotMorositaSB = par.IfNull(myReaderA("IMPORTO_altri"), 0)
                        '    If TotMorositaSB > 0 Then
                        '        par.cmd.CommandText = "UPDATE SISCOM_MI.BOL_BOLLETTE SET fl_sollecito='1',ID_BOLLETTA_RIC=" & ID_BOLLETTA & " WHERE ID=" & myReaderA("ID")
                        '        par.cmd.ExecuteNonQuery()
                        '        TotMorosita = TotMorosita + TotMorositaSB
                        '    End If
                        'Loop
                        'myReaderA.Close()

                        If TotMorosita > 0 Then
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                           & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",151" _
                                           & "," & par.VirgoleInPunti(Format(TotMorosita, "0.00")) & ")"
                            par.cmd.ExecuteNonQuery()
                            TOTALE_BOLLETTA = TOTALE_BOLLETTA + TotMorosita
                        End If


                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",403" _
                                            & "," & par.VirgoleInPunti(Format(SPESEPOSTALI_DA_APPLICARE, "0.00")) & ")"
                        par.cmd.ExecuteNonQuery()
                        TOTALE_BOLLETTA = TOTALE_BOLLETTA + SPESEPOSTALI_DA_APPLICARE

                        'max 14/12/2016
                        Dim IndiciGestionali As String = ""
                        par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=60"
                        myReaderA = par.cmd.ExecuteReader()
                        If myReaderA.HasRows = True Then
                            If myReaderA.Read Then
                                IndiciGestionali = myReaderA("VALORE")
                            End If
                        End If
                        myReaderA.Close()
                        If IndiciGestionali <> "" Then
                            par.cmd.CommandText = "select bol_bollette_VOCI_gest.*,BOL_BOLLETTE_GEST.NOTE FROM SISCOM_MI.bol_bollette_gest,SISCOM_MI.bol_bollette_VOCI_gest WHERE bol_bollette_VOCI_gest.ID_BOLLETTA_GEST=BOL_BOLLETTE_GEST.ID AND TIPO_APPLICAZIONE='N' AND ID_TIPO IN (" & IndiciGestionali & ") AND ID_CONTRATTO=" & lIdContratto & " ORDER BY ID_TIPO ASC"
                            myReaderA = par.cmd.ExecuteReader()
                            Do While myReaderA.Read
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & "," & myReaderA("ID_VOCE") _
                                                    & "," & par.VirgoleInPunti(myReaderA("IMPORTO")) & ")"
                                par.cmd.ExecuteNonQuery()

                                par.cmd.CommandText = "UPDATE SISCOM_MI.BOL_BOLLETTE_GEST SET TIPO_APPLICAZIONE='T' WHERE ID=" & myReaderA("ID_BOLLETTA_GEST")
                                par.cmd.ExecuteNonQuery()

                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO, ID_OPERATORE, DATA_ORA, COD_EVENTO, MOTIVAZIONE) VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ", '" & Format(Now, "yyyyMMddHHmmss") & "', 'F02', 'IMPORTO DI EURO " & myReaderA("IMPORTO") & " (" & par.PulisciStrSql(par.IfNull(myReaderA("NOTE"), "")) & ") INSERITE NELLA BOLLETTA DI FINE CONTRATTO')"
                                par.cmd.ExecuteNonQuery()

                                TOTALE_BOLLETTA = TOTALE_BOLLETTA + CDbl(myReaderA("IMPORTO"))
                            Loop
                            myReaderA.Close()

                        End If


                        '--------------

                        If TOTALE_BOLLETTA > APPLICABOLLO Then
                            If BOLLO > 0 Then
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",95" _
                                                    & "," & par.VirgoleInPunti(Format(BOLLO, "0.00")) & ")"
                                par.cmd.ExecuteNonQuery()
                            End If
                        End If

                        If TOTALE_BOLLETTA <= SPESEmav And TOTALE_BOLLETTA > 0 Then
                            par.cmd.CommandText = "UPDATE SISCOM_MI.BOL_BOLLETTE SET FL_STAMPATO=0 WHERE ID=" & ID_BOLLETTA
                            par.cmd.ExecuteNonQuery()
                            par.cmd.CommandText = "DELETE FROM SISCOM_MI.BOL_BOLLETTE WHERE ID=" & ID_BOLLETTA
                            par.cmd.ExecuteNonQuery()
                            RIASSUNTO_BOLLETTA = ""
                        End If

                    End If

                    'MAX 26/04/2016 SCRITTURA GEST. DEPOSITO CAUZIONALE
                    If par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, 0) > 0 Then
                        Dim ID_BOLLETTA_GEST As Long = 0
                        par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE_GEST (ID, ID_CONTRATTO, ID_ESERCIZIO_F, ID_UNITA, ID_ANAGRAFICA, RIFERIMENTO_DA, RIFERIMENTO_A, IMPORTO_TOTALE, DATA_EMISSIONE, DATA_PAGAMENTO, DATA_VALUTA, ID_TIPO, TIPO_APPLICAZIONE, DATA_APPLICAZIONE, ID_OPERATORE_APPLICAZIONE, NOTE, ID_EVENTO_PAGAMENTO) " _
                                            & " Values " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_GEST.NEXTVAL, " & lIdContratto & ", " & par.RicavaEsercizioCorrente & ", " & UnitaContratto & "," _
                                            & CType(Me.Page.FindControl("txtCodAffittuario"), HiddenField).Value & ", '" & DataInizio & "', '" & Format(Now, "yyyyMMdd") _
                                            & "', " & par.VirgoleInPunti(-1 * par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, 0)) & ", '" & Format(Now, "yyyyMMdd") & "',NULL, NULL, 55, 'N', NULL, " _
                                            & "'', '" & par.PulisciStrSql("RIMBORSO DEPOSITO CAUZIONALE") & "', NULL)"
                        par.cmd.ExecuteNonQuery()
                        par.cmd.CommandText = "select SISCOM_MI.SEQ_BOL_BOLLETTE_GEST.CURRVAL FROM DUAL"
                        Dim myReaderX1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderX1.Read Then
                            ID_BOLLETTA_GEST = myReaderX1(0)
                            par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE_VOCI_GEST (ID, ID_BOLLETTA_GEST, ID_VOCE, IMPORTO, IMP_PAGATO, FL_ACCERTATO) Values  (SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI_GEST.NEXTVAL, " & ID_BOLLETTA_GEST & ",7, " & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, 0) * -1) & ",  NULL, NULL)"
                            par.cmd.ExecuteNonQuery()
                            par.cmd.CommandText = "INSERT INTO OPERAZIONI_PART_GEST (DATA_ORA,ID_CONTRATTO,OPERAZIONE,NOTE,ID_BOLLETTA,ID_BOLLETTA_GEST) VALUES ('" & Format(Now, "yyyyMMddHHmmss") & "'," & lIdContratto & ",'RIMBORSO DEPOSITO CAUZIONALE','CREATA IN P.GEST. BOLLETTA NUM." & par.PulisciStrSql(ID_BOLLETTA_GEST) & " PER RIMBORSO DEP. CAUZIONALE',NULL," & ID_BOLLETTA_GEST & ")"
                            par.cmd.ExecuteNonQuery()
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO, ID_OPERATORE, DATA_ORA, COD_EVENTO, MOTIVAZIONE) VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ", '" & Format(Now, "yyyyMMddHHmmss") & "', 'F02', 'CREATA IN P.GEST. BOLLETTA RIMBORSO DEPOSITO CAUZIONE NUM." & ID_BOLLETTA_GEST & "')"
                            par.cmd.ExecuteNonQuery()
                        End If
                        myReaderX1.Close()
                    End If


                End If
                myReaderS.Close()

                


                imgChiudiContratto.Visible = False

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                    & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                    & "'F18','')"
                par.cmd.ExecuteNonQuery()

                Dim cOD_eVENTO As String = ""

                If CodFis = "-1" Then
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                        & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                        & "'F102','')"
                    cOD_eVENTO = "F102"
                Else
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                        & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                        & "'F103','')"
                    cOD_eVENTO = "F103"
                End If
                par.cmd.ExecuteNonQuery()




                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.UNITA_STATO_MANUTENTIVO WHERE ID_UNITA=" & UnitaContratto
                Dim myReader As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader.Read Then

                    par.cmd.CommandText = "Insert into siscom_mi.UNITA_STATO_MAN_S (id_unita,id_contratto,data_memo) values (" & UnitaContratto & "," & lIdContratto & ",'" & Format(Now, "yyyyMMdd") & "')"
                    par.cmd.ExecuteNonQuery()

                    par.cmd.CommandText = "update siscom_mi.UNITA_STATO_MAN_S set DATA_RIPRESA_STR='" & par.IfNull(myReader("DATA_RIPRESA_STR"), "") _
                    & "', DATA_CONSEGNA_STR='" & par.IfNull(myReader("DATA_CONSEGNA_STR"), "") _
                    & "',ID_STRUTTURA_COMP=" & par.IfNull(myReader("ID_STRUTTURA_COMP"), "NULL") _
                    & ",ST_DEP_CHIAVI=" & par.IfNull(myReader("ST_DEP_CHIAVI"), "NULL") _
                                        & ",DATA_S='" & par.IfNull(myReader("DATA_S"), "") & "'" _
                                        & ",RILEVAZIONE=" & par.IfNull(myReader("RILEVAZIONE"), 0) _
                                        & ",RIASSEGNABILE=" & par.IfNull(myReader("RIASSEGNABILE"), 0) _
                                        & ", P_BLINDATA=" & par.IfNull(myReader("P_BLINDATA"), 0) _
                                        & ",SOL_GP=" & par.IfNull(myReader("SOL_GP"), 0) _
                                        & ",SOL_GF=" & par.IfNull(myReader("SOL_GF"), 0) _
                                        & ",SOL_PB=" & par.IfNull(myReader("SOL_PB"), 0) _
                                        & ",SOL_LA=" & par.IfNull(myReader("SOL_LA"), 0) _
                                        & ",SOL_AL=" & par.IfNull(myReader("SOL_AL"), 0) _
                                        & ",HANDICAP=" & par.IfNull(myReader("HANDICAP"), 0) _
                                        & ",DATA_PRE_S='" & par.IfNull(myReader("DATA_PRE_S"), "") _
                                        & "',DATA_PRE_SLOGGIO='" & par.IfNull(myReader("DATA_PRE_SLOGGIO"), "") _
                                        & "', NOTE='" & par.PulisciStrSql(par.IfNull(myReader("NOTE"), "")) _
                                        & "',ALLARME=" & par.IfNull(myReader("ALLARME"), 0) _
                                        & ", MOTIVAZIONI='" & par.PulisciStrSql(par.IfNull(myReader("MOTIVAZIONI"), "")) _
                                        & "', ZONA='" & par.PulisciStrSql(par.IfNull(myReader("ZONA"), "")) _
                                        & "', NUM_LOCALI='" & par.PulisciStrSql(par.IfNull(myReader("NUM_LOCALI"), "")) _
                                        & "',NUM_SERVIZI='" & par.PulisciStrSql(par.IfNull(myReader("NUM_SERVIZI"), "")) _
                                        & "', TIPO_ALLOGGIO=" & par.IfNull(myReader("TIPO_ALLOGGIO"), "NULL") _
                                        & ", DATA_CONSEGNA_CHIAVI='" & par.PulisciStrSql(par.IfNull(myReader("DATA_CONSEGNA_CHIAVI"), "")) _
                                        & "', CONSEGNATE_A='" & par.PulisciStrSql(par.IfNull(myReader("CONSEGNATE_A"), "")) _
                                        & "', DATA_RIPRESA_CHIAVI='" & par.PulisciStrSql(par.IfNull(myReader("DATA_RIPRESA_CHIAVI"), "")) _
                                        & "',ID_QUARTIERE=" & par.IfNull(myReader("ID_QUARTIERE"), 0) _
                                        & ", DATA_RILEVAZIONE='" & par.PulisciStrSql(par.IfNull(myReader("DATA_RILEVAZIONE"), "")) _
                                        & "', NOTEGRTP='" & par.PulisciStrSql(par.IfNull(myReader("NOTEGRTP"), "")) _
                                        & "', SOL_PB1=" & par.IfNull(myReader("SOL_PB1"), 0) _
                                        & ", SOL_PB2=" & par.IfNull(myReader("SOL_PB2"), 0) _
                                        & ", SOL_PB3=" & par.IfNull(myReader("SOL_PB3"), 0) _
                                        & ", SOL_LA1=" & par.IfNull(myReader("SOL_LA1"), 0) _
                                        & ", TIPO_RIASSEGNABILE=" & par.IfNull(myReader("TIPO_RIASSEGNABILE"), 0) _
                                        & ", FINE_LAVORI='" & par.IfNull(myReader("FINE_LAVORI"), 0) _
                                        & "', DATA_Q='" & par.IfNull(myReader("DATA_Q"), 0) _
                                        & "',IMPORTO_DANNI=" & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO_DANNI"), 0)) _
                                        & ", IMPORTO_TRASPORTO=" & par.VirgoleInPunti(par.IfNull(myReader("IMPORTO_DANNI"), 0)) _
                                        & ", NOTE_DANNI='" & par.PulisciStrSql(par.IfNull(myReader("NOTE_DANNI"), "")) _
                                        & "', FL_AUTORIZZATI_IMP='" & par.IfNull(myReader("FL_AUTORIZZATI_IMP"), 0) _
                                        & "', REC_GRTP=" & par.IfNull(myReader("REC_GRTP"), 0) _
                                        & " WHERE ID_UNITA=" & UnitaContratto & " AND ID_CONTRATTO=" _
                                        & lIdContratto & " AND DATA_MEMO='" & Format(Now, "yyyyMMdd") & "'"





                    par.cmd.ExecuteNonQuery()
                End If
                myReader.Close()

                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.UNITA_STATO_MANUTENTIVO_INT WHERE ID_UNITA=" & UnitaContratto
                myReader = par.cmd.ExecuteReader()
                Do While myReader.Read
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.UNITA_STATO_MAN_INT_S (ID_UNITA,ID_INTERVENTO,DATA_MEMO) VALUES (" & UnitaContratto & "," & myReader("ID_INTERVENTO") & ",'" & Format(Now, "yyyyMMdd") & "')"
                    par.cmd.ExecuteNonQuery()
                Loop
                myReader.Close()

                par.cmd.CommandText = "update siscom_mi.intestatari_rapporto set data_fine='" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataRiconsegna"), TextBox).Text) & "' where id_contratto=" & lIdContratto
                par.cmd.ExecuteNonQuery()


                Dim progressivo As Integer
                par.cmd.CommandText = "select MAX(TO_NUMBER(TRANSLATE(SUBSTR(cod_contratto,18,2),'A','0'))) from SISCOM_MI.rapporti_utenza where id=" & lIdContratto
                Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader1.Read Then
                    progressivo = par.IfNull(myReader1(0), 0) + 1
                Else
                    progressivo = 1
                End If
                myReader1.Close()
                Dim NuovoCodiceContratto As String = Mid(CodContratto1, 1, 17) & Format((progressivo), "00")

                Dim nome As String = ""
                Dim Cognome As String = ""
                Dim CF As String = ""

                If CodFis = "-1" Then
                    par.cmd.CommandText = "select anagrafica.* from siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='INTE' AND soggetti_contrattuali.id_CONTRATTO=" & lIdContratto
                Else
                    par.cmd.CommandText = "select anagrafica.* from siscom_mi.anagrafica,siscom_mi.soggetti_contrattuali where ANAGRAFICA.ID=SOGGETTI_CONTRATTUALI.ID_ANAGRAFICA AND SOGGETTI_CONTRATTUALI.COD_TIPOLOGIA_OCCUPANTE='INTE' AND anagrafica.cod_fiscale='" & UCase(par.PulisciStrSql(CodFis)) & "'"
                End If


                Dim myReaderX As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()

                If myReaderX.Read = True Then
                    If par.IfNull(myReaderX("ragione_sociale"), "") = "" Then
                        Cognome = par.IfNull(myReaderX("cognome"), "")
                        nome = par.IfNull(myReaderX("nome"), "")
                    Else
                        Cognome = par.IfNull(myReaderX("ragione_sociale"), "")
                        nome = ""
                    End If
                    If par.IfNull(myReaderX("partita_iva"), "") = "" Then
                        CF = par.IfNull(myReaderX("cod_fiscale"), "")
                    Else
                        CF = par.IfNull(myReaderX("partita_iva"), "")
                    End If



                    par.cmd.CommandText = "Insert into siscom_mi.UNITA_ASSEGNATE (ID_DOMANDA, ID_UNITA, DATA_ASSEGNAZIONE, " _
                                        & "GENERATO_CONTRATTO, ID_DICHIARAZIONE, COGNOME_RS, NOME, CF_PIVA, PROVENIENZA, N_OFFERTA,CANONE,ID_ANAGRAFICA,PROVVEDIMENTO,DATA_PROVVEDIMENTO) " _
                                        & " Values " _
                                        & "(-1, " & UnitaContratto & ", '" & par.AggiustaData(RinnovoDataPG.Value) & "', 1, -1, " _
                                        & "'" & par.PulisciStrSql(Cognome) & "', '" & par.PulisciStrSql(nome) _
                                        & "', '" & par.PulisciStrSql(CF) & "', 'U', 0," & par.VirgoleInPunti(RinnovoCanone.Value) & "," & par.IfNull(myReaderX("id"), "0") & ",'" & par.PulisciStrSql(RinnovoNumeroPG.Value) & "','" & par.AggiustaData(RinnovoDataPG.Value) & "')"
                    par.cmd.ExecuteNonQuery()
                End If
                myReaderX.Close()


                'INSERISCO IL CONTRATTO
                Dim CAUZIONE As Double = 0
                CAUZIONE = Format(Format((RinnovoCanone.Value / 12), "0.00") * 3, "0.00")
                Dim prossima_b As String = ""

                par.cmd.CommandText = "SELECT RAPPORTI_UTENZA.*,RAPPORTI_UTENZA_PROSSIMA_BOL.PROSSIMA_BOLLETTA FROM SISCOM_MI.RAPPORTI_UTENZA_PROSSIMA_BOL,SISCOM_MI.RAPPORTI_UTENZA WHERE RAPPORTI_UTENZA_PROSSIMA_BOL.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND RAPPORTI_UTENZA.ID=" & lIdContratto
                myReaderX = par.cmd.ExecuteReader()
                If myReaderX.Read = True Then
                    par.cmd.CommandText = "Insert into SISCOM_MI.RAPPORTI_UTENZA    (ID, COD_CONTRATTO_GIMI, COD_CONTRATTO, COD_TIPOLOGIA_RAPP_CONTR, COD_TIPOLOGIA_CONTR_LOC," _
                                        & "DURATA_ANNI, DURATA_MESI, DURATA_GIORNI, DATA_DECORRENZA, DATA_SCADENZA,     DATA_DISDETTA_LOCATARIO, NUM_REGISTRAZIONE, SERIE_REGISTRAZIONE, " _
                                        & "IMP_CANONE_INIZIALE, IMP_DEPOSITO_CAUZ,     COD_FASCIA_REDDITO, MESSA_IN_MORA, PRATICA_AL_LEGALE, ISCRIZIONE_RUOLO, RATEIZZAZIONI_IN_CORSO,     " _
                                        & "DECADENZA, SFRATTO, NOTE, DATA_REG, COD_UFFICIO_REG,     DATA_STIPULA, DATA_CONSEGNA, DATA_SCADENZA_RINNOVO, DURATA_RINNOVO, MESI_DISDETTA,     " _
                                        & "DATA_RICONSEGNA, DELIBERA, DATA_DELIBERA, NRO_RATE, FREQ_VAR_ISTAT,     VERSAMENTO_TR, PER_BANDO, TIPO_COR, LUOGO_COR, VIA_COR,     " _
                                        & "NOTE_COR, CIVICO_COR, SIGLA_COR, CAP_COR, PRESSO_COR,     BOZZA, INTERESSI_CAUZIONE, NRO_REPERTORIO, DATA_REPERTORIO, NRO_ASSEGNAZIONE_PG,     " _
                                        & "DATA_ASSEGNAZIONE_PG, INIZIO_PERIODO, LIBRETTO_DEPOSITO, ID_DEST_RATE, INVIO_BOLLETTA,     FL_CONGUAGLIO, PERC_RINNOVO_CONTRATTO, PERC_ISTAT, " _
                                        & "IMP_CANONE_ATTUALE, PROVENIENZA_ASS,     INTERESSI_RIT_PAG, IMPORTO_ANTICIPO, ID_DOMANDA, ID_AU, ID_ISEE,     ID_COMMISSARIATO, REG_TELEMATICA, " _
                                        & "DEST_USO, DESCR_DEST_USO, DATA_INVIO_RIC_DISDETTA,MOTIVO_REC_FORZOSO, FL_STAMPATO, BOLLO, N_OFFERTA, DATA_NOTIFICA_DISDETTA,     " _
                                        & "MITTENTE_DISDETTA, DATA_CONVALIDA_SFRATTO, DATA_ESECUZIONE_SFRATTO, DATA_RINVIO_SFRATTO, DATA_CONFERMA_FP,SCALA_COR,PIANO_COR,INTERNO_COR) " _
                                        & "Values   (SISCOM_MI.SEQ_RAPPORTI_UTENZA.NEXTVAL, '', '" & NuovoCodiceContratto & "', '" _
                                        & par.IfNull(myReaderX("COD_TIPOLOGIA_RAPP_CONTR"), "") & "', '" & par.IfNull(myReaderX("COD_TIPOLOGIA_CONTR_LOC"), "") _
                                        & "', " & par.IfNull(myReaderX("DURATA_ANNI"), "0") & ", " & par.IfNull(myReaderX("DURATA_MESI"), "0") _
                                        & ", NULL, '', '',  '' , NULL, NULL, " & par.VirgoleInPunti(RinnovoCanone.Value) & ", " & par.VirgoleInPunti(CAUZIONE) & " ,  NULL, NULL, NULL, NULL, NULL,  NULL, NULL, NULL, NULL, '" _
                                        & "TNP" & "',  '', '', '', " & par.IfNull(myReaderX("DURATA_RINNOVO"), "NULL") _
                                        & ", " & par.IfNull(myReaderX("MESI_DISDETTA"), "6") & ",     NULL, '" & par.PulisciStrSql(RinnovoNumeroPG.Value) _
                                        & "', '" & par.AggiustaData(RinnovoDataPG.Value) & "', 12, '" & par.IfNull(myReaderX("FREQ_VAR_ISTAT"), "0") _
                                        & "' ,'" & par.IfNull(myReaderX("VERSAMENTO_TR"), "NULL") & "', NULL, '" & par.PulisciStrSql(par.IfNull(myReaderX("TIPO_COR"), "VIA")) _
                                        & "', '" & par.PulisciStrSql(par.IfNull(myReaderX("LUOGO_COR"), "")) & "', '" _
                                        & par.PulisciStrSql(par.IfNull(myReaderX("VIA_COR"), "")) _
                                        & "', NULL, '" & par.PulisciStrSql(par.IfNull(myReaderX("CIVICO_COR"), "")) & "', '" _
                                        & par.PulisciStrSql(par.IfNull(myReaderX("SIGLA_COR"), "")) & "', '" _
                                        & par.PulisciStrSql(par.IfNull(myReaderX("CAP_COR"), "")) & "', '" _
                                        & par.PulisciStrSql(par.IfNull(myReaderX("PRESSO_COR"), "")) & "',     1, NULL, NULL, NULL, NULL,     NULL, '" _
                                        & par.IfNull(myReaderX("PROSSIMA_BOLLETTA"), "") & "', '" & par.IfNull(myReaderX("LIBRETTO_DEPOSITO"), "") _
                                        & "', " & par.IfNull(myReaderX("ID_DEST_RATE"), "1") & ", " & par.IfNull(myReaderX("INVIO_BOLLETTA"), "1") _
                                        & ",'" & par.IfNull(myReaderX("FL_CONGUAGLIO"), "1") & "', " & par.IfNull(myReaderX("PERC_RINNOVO_CONTRATTO"), "0") _
                                        & ", " & par.IfNull(myReaderX("PERC_ISTAT"), "0") & ", " & par.VirgoleInPunti(RinnovoCanone.Value) _
                                        & ", " & par.IfNull(myReaderX("PROVENIENZA_ASS"), "0") & " ,     '0', 0, " & par.IfNull(myReaderX("ID_DOMANDA"), "NULL") _
                                        & ", " & par.IfNull(myReaderX("ID_AU"), "NULL") & ", " & par.IfNull(myReaderX("ID_ISEE"), "NULL") _
                                        & "," & par.IfNull(myReaderX("ID_COMMISSARIATO"), "1") & ", NULL, '" & par.IfNull(myReaderX("DEST_USO"), "N") _
                                        & "', '" & par.PulisciStrSql(par.IfNull(myReaderX("DESCR_DEST_USO"), "0")) _
                                        & "', NULL, 4, 0, NULL, NULL, NULL,     -1, NULL, NULL, NULL, NULL" _
                                        & ",'" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtScalaCor"), TextBox).Text) _
                                        & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtPianoCor"), TextBox).Text) _
                                        & "','" & par.PulisciStrSql(CType(Tab_Comunicazioni1.FindControl("txtInternoCor"), TextBox).Text) & "'" _
                                        & ")"
                    par.cmd.ExecuteNonQuery()

                    prossima_b = par.IfNull(myReaderX("PROSSIMA_BOLLETTA"), "")

                End If
                myReaderX.Close()

                Dim indice_anagrafica As String = "0"
                Dim INDICE_CONTRATTO As Long = 0

                par.cmd.CommandText = "select siscom_mi.seq_RAPPORTI_UTENZA.currval from dual"
                myReaderX = par.cmd.ExecuteReader()
                If myReaderX.Read Then
                    INDICE_CONTRATTO = myReaderX(0)
                End If
                myReaderX.Close()

                par.cmd.CommandText = "INSERT INTO siscom_mi.RAPPORTI_UTENZA_PROSSIMA_BOL (PROSSIMA_BOLLETTA,ID_CONTRATTO) VALUES ('" & prossima_b & "'," & INDICE_CONTRATTO & ")"
                par.cmd.ExecuteNonQuery()

                If CodFis <> "-1" Then
                    If IDRinnovoBoxUSD.Value <> "&nbsp;" Then
                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & IDRinnovoBoxUSD.Value
                        myReaderX = par.cmd.ExecuteReader()
                        If myReaderX.Read = True Then
                            par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET TIPO_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("TIPO_COR"), "VIA")) _
                                                & "',LUOGO_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("LUOGO_COR"), "")) _
                                                & "',VIA_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("VIA_COR"), "")) _
                                                & "',CIVICO_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("CIVICO_COR"), "")) _
                                                & "',SIGLA_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("SIGLA_COR"), "")) _
                                                & "',CAP_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("CAP_COR"), "")) _
                                                & "',PRESSO_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("PRESSO_COR"), "")) _
                                                & "',SCALA_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("SCALA_COR"), "")) _
                                                & "',PIANO_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("PIANO_COR"), "")) _
                                                & "',INTERNO_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("INTERNO_COR"), "")) & "'" _
                                                & " WHERE ID=" & INDICE_CONTRATTO
                            par.cmd.ExecuteNonQuery()
                        End If
                        myReaderX.Close()
                    Else
                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RAPPORTI_UTENZA WHERE ID=" & lIdContratto
                        myReaderX = par.cmd.ExecuteReader()
                        If myReaderX.Read = True Then
                            par.cmd.CommandText = "UPDATE SISCOM_MI.RAPPORTI_UTENZA SET TIPO_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("TIPO_COR"), "VIA")) _
                                                & "',LUOGO_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("LUOGO_COR"), "")) _
                                                & "',VIA_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("VIA_COR"), "")) _
                                                & "',CIVICO_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("CIVICO_COR"), "")) _
                                                & "',SIGLA_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("SIGLA_COR"), "")) _
                                                & "',CAP_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("CAP_COR"), "")) _
                                                & "',PRESSO_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("PRESSO_COR"), "")) _
                                                & "',SCALA_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("SCALA_COR"), "")) _
                                                & "',PIANO_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("PIANO_COR"), "")) _
                                                & "',INTERNO_COR='" & par.PulisciStrSql(par.IfNull(myReaderX("INTERNO_COR"), "")) & "'" _
                                                & " WHERE ID=" & INDICE_CONTRATTO
                            par.cmd.ExecuteNonQuery()
                        End If
                        myReaderX.Close()
                    End If
                End If

                If CodFis = "-1" Then
                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE ID_CONTRATTO=" & lIdContratto
                    myReaderX = par.cmd.ExecuteReader()
                    Do While myReaderX.Read
                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                                            & par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                                            & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                        par.cmd.ExecuteNonQuery()

                        If par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") = "INTE" Then
                            indice_anagrafica = par.IfNull(myReaderX("ID_ANAGRAFICA"), "0")
                        End If
                    Loop
                    myReaderX.Close()
                Else
                    If IDRinnovoBoxUSD.Value <> "&nbsp;" Then
                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.SOGGETTI_CONTRATTUALI WHERE COD_TIPOLOGIA_OCCUPANTE='INTE' AND ID_CONTRATTO=" & IDRinnovoBoxUSD.Value
                        myReaderX = par.cmd.ExecuteReader()
                        Do While myReaderX.Read
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                                                & par.IfNull(myReaderX("ID_ANAGRAFICA"), "0") & "," & INDICE_CONTRATTO & ",'" & par.IfNull(myReaderX("COD_TIPOLOGIA_PARENTELA"), "1") _
                                                & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") & "','" & par.IfNull(myReaderX("COD_TIPOLOGIA_TITOLO"), "") & "')"
                            par.cmd.ExecuteNonQuery()

                            If par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") = "INTE" Then
                                indice_anagrafica = par.IfNull(myReaderX("ID_ANAGRAFICA"), "0")
                            End If
                        Loop
                        myReaderX.Close()
                    Else
                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.ANAGRAFICA WHERE COD_FISCALE='" & CodFis & "'"
                        myReaderX = par.cmd.ExecuteReader()
                        If myReaderX.Read Then
                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.SOGGETTI_CONTRATTUALI (ID_ANAGRAFICA,ID_CONTRATTO,COD_TIPOLOGIA_PARENTELA,COD_TIPOLOGIA_OCCUPANTE,COD_TIPOLOGIA_TITOLO) VALUES (" _
                                                & par.IfNull(myReaderX("ID"), "0") & "," & INDICE_CONTRATTO & ",'NA','INTE','LEGIT')"
                            par.cmd.ExecuteNonQuery()

                            'If par.IfNull(myReaderX("COD_TIPOLOGIA_OCCUPANTE"), "") = "INTE" Then
                            indice_anagrafica = par.IfNull(myReaderX("ID"), "0")
                            'End If
                        End If
                        myReaderX.Close()
                    End If



                End If


                par.cmd.CommandText = "SELECT * FROM SISCOM_MI.UNITA_CONTRATTUALE WHERE ID_CONTRATTO=" & lIdContratto
                myReaderX = par.cmd.ExecuteReader()
                Do While myReaderX.Read
                    par.cmd.CommandText = "Insert into SISCOM_MI.UNITA_CONTRATTUALE (ID_CONTRATTO, ID_UNITA, COD_UNITA_IMMOBILIARE, TIPOLOGIA, ID_EDIFICIO, SCALA, COD_TIPO_LIVELLO_PIANO, " _
                                     & "INTERNO, ID_UNITA_PRINCIPALE, SEZIONE, FOGLIO, NUMERO, SUB, COD_TIPOLOGIA_CATASTO, RENDITA, COD_CATEGORIA_CATASTALE, COD_CLASSE_CATASTALE," _
                                     & "COD_QUALITA_CATASTALE, SUPERFICIE_MQ, CUBATURA, NUM_VANI, SUPERFICIE_CATASTALE, RENDITA_STORICA, IMMOBILE_STORICO, REDDITO_DOMINICALE, VALORE_IMPONIBILE, " _
                                     & "REDDITO_AGRARIO, VALORE_BILANCIO, DATA_ACQUISIZIONE, DATA_FINE_VALIDITA, DITTA, NUM_PARTITA, ESENTE_ICI, PERC_POSSESSO, INAGIBILE, MICROZONA_CENSUARIA, " _
                                     & "ZONA_CENSUARIA, COD_STATO_CATASTALE, INDIRIZZO, CIVICO, CAP, LOCALITA, COD_COMUNE, SUP_CONVENZIONALE, VAL_LOCATIVO_UNITA) Values (" _
                                     & INDICE_CONTRATTO & "," & par.IfNull(myReaderX("id_unita"), "") & ", '" & par.IfNull(myReaderX("cod_unita_immobiliare"), "") _
                                     & "', '" & par.IfNull(myReaderX("tipologia"), "") & "', " & par.IfNull(myReaderX("id_edificio"), "") _
                                     & ", '" & par.IfNull(myReaderX("scala"), "null") & "', '" & par.IfNull(myReaderX("cod_tipo_livello_piano"), "") _
                                     & "', '" & par.IfNull(myReaderX("interno"), "") & "', " & par.IfNull(myReaderX("id_unita_principale"), "null") _
                                     & ", '" & par.IfNull(myReaderX("sezione"), "") & "','" & par.IfNull(myReaderX("foglio"), "") & "','" & par.IfNull(myReaderX("numero"), "") _
                                     & "', '" & par.IfNull(myReaderX("sub"), "") & "', '" & par.IfNull(myReaderX("COD_TIPOLOGIA_catasto"), "") & "', " & par.VirgoleInPunti(par.IfNull(myReaderX("rendita"), "null")) _
                                     & " ,'" & par.IfNull(myReaderX("cod_categoria_catastale"), "") & "', '" & par.IfNull(myReaderX("cod_classe_catastale"), "") _
                                     & "', " & par.VirgoleInPunti(par.IfNull(myReaderX("superficie_mq"), "null")) & ", " & par.VirgoleInPunti(par.IfNull(myReaderX("cubatura"), "null")) & ", " _
                                     & par.VirgoleInPunti(par.IfNull(myReaderX("num_vani"), "null")) & ", " & par.VirgoleInPunti(par.IfNull(myReaderX("superficie_catastale"), "null")) _
                                     & ", " & par.VirgoleInPunti(par.IfNull(myReaderX("rendita_storica"), "null")) & ", " & par.VirgoleInPunti(par.IfNull(myReaderX("immobile_storico"), "null")) _
                                     & ", " & par.VirgoleInPunti(par.IfNull(myReaderX("reddito_dominicale"), "null")) & ", " & par.VirgoleInPunti(par.IfNull(myReaderX("valore_imponibile"), "null")) _
                                     & ",  " & par.VirgoleInPunti(par.IfNull(myReaderX("reddito_agrario"), "null")) & ", " & par.VirgoleInPunti(par.IfNull(myReaderX("valore_bilancio"), "null")) _
                                     & ",null, '" & par.IfNull(myReaderX("data_acquisizione"), "") & "', '" & par.IfNull(myReaderX("data_fine_validita"), "null") _
                                     & "', '" & par.IfNull(myReaderX("ditta"), "") & "', '" & par.IfNull(myReaderX("num_partita"), "") & "', NULL, NULL, NULL, NULL,  NULL, NULL, '" _
                                     & par.PulisciStrSql(par.IfNull(myReaderX("indirizzo"), "")) & "', '" & par.IfNull(myReaderX("civico"), "") _
                                     & "', '" & par.IfNull(myReaderX("cap"), "") & "', NULL, '" & par.IfNull(myReaderX("cod_comune"), "") & "', NULL, NULL)"
                    par.cmd.ExecuteNonQuery()
                Loop
                myReaderX.Close()

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.INTESTATARI_RAPPORTO (ID_CONTRATTO,ID_ANAGRAFICA,DATA_INIZIO,DATA_FINE) VALUES (" & INDICE_CONTRATTO & "," & indice_anagrafica & ",'" & par.AggiustaData(RinnovoDataPG.Value) & "','29991231')"
                par.cmd.ExecuteNonQuery()

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                & "VALUES (" & INDICE_CONTRATTO & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                & "'F01','')"
                par.cmd.ExecuteNonQuery()


                par.cmd.CommandText = "INSERT INTO SISCOM_MI.RAPPORTI_UTENZA_CH_RINNOVI (ID_CONTRATTO_OR,ID_CONTRATTO_NU,COD_EVENTO,DATA_OPERAZIONE) VALUES (" & lIdContratto & "," & INDICE_CONTRATTO & ",'" & cOD_eVENTO & "','" & Format(Now, "yyyyMMdd") & "')"
                par.cmd.ExecuteNonQuery()


                txtModificato.Value = "0"
                Tab_Contratto1.DisabilitaTutto()

                Response.Write("<script>alert('Operazione Effettuata! La bolletta di fine rapporto è stata regolarmente creata.\nOra sarai reindirizzato sul nuovo rapporto (" & NuovoCodiceContratto & ") !');</script>")
                sNuovoCodiceRapporto = NuovoCodiceContratto
                lNuovoIdRapporto = INDICE_CONTRATTO

                'Generale1.Provenienza = TipoContratto
                'Generale1.IndiceDichiarazione = lIdDichiarazione
                'Generale1.IndiceDomanda = lIdDomandaERP
                'Generale1.IndiceAnagrafe = lIdAU




            End If

        Catch ex As Exception
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Function

    Public Property sNuovoCodiceRapporto() As String
        Get
            If Not (ViewState("par_sNuovoCodiceRapporto") Is Nothing) Then
                Return CStr(ViewState("par_sNuovoCodiceRapporto"))
            Else
                Return ""
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_sNuovoCodiceRapporto") = value
        End Set

    End Property

    Public Property lNuovoIdRapporto() As Long
        Get
            If Not (ViewState("par_lNuovoIdRapporto") Is Nothing) Then
                Return CLng(ViewState("par_lNuovoIdRapporto"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_lNuovoIdRapporto") = value
        End Set

    End Property

    Private Sub CanoniAttivazAbus(ByVal dataProssimoPeriodo As String, ByRef equoAnnuo As Decimal, ByRef canone2 As Decimal, ByRef descrizione As String, ByRef descrizioneEqc As String, ByRef descrizioneC2 As String)

        Dim giorniEquoCan As Integer = 0
        Dim giorniCanone2 As Integer = 0
        Dim giorni As Integer = 0

        Select Case Mid(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 4, 2)
            Case "01", "03", "05", "07", "08", "10", "12"
                giorni = DateDiff("d", CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, "31" & Mid(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 3, 8))
            Case "02"
                giorni = DateDiff("d", CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, "28" & Mid(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 3, 8)) + 3
            Case Else
                giorni = DateDiff("d", CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, "30" & Mid(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 3, 8)) + 1
        End Select

        If CDate(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) < CDate("30/11/2007") Then
            'equo
            giorniEquoCan = giorni + 30 * DateDiff("m", DateAdd(DateInterval.Month, 1, CDate(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text)), "28/11/2007")
            equoAnnuo = par.CalcolaEQCAbusivi(UnitaContratto, Right(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 4))
            equoAnnuo = (equoAnnuo * 120) / 100
            equoAnnuo = Format((equoAnnuo / 360) * giorniEquoCan, "0.00")
            descrizioneEqc = "dal " & CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text & " al 28/11/2007"

            giorniCanone2 = 30 * DateDiff("m", DateAdd(DateInterval.Month, 1, CDate("28/11/2007")), "31/12/2008")
            par.CalcolaCanoneAbusivi(UnitaContratto, canone2, 1)
            canone2 = Format((canone2 / 360) * giorniCanone2, "0.00")
            descrizioneC2 = "dal 28/11/2007 al 31/12/2008"
        End If

        If CDate(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) > CDate("30/11/2007") And CDate(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) < CDate("31/12/2008") Then
            giorniCanone2 = giorni + 30 * DateDiff("m", DateAdd(DateInterval.Month, 1, CDate(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text)), "31/12/2008")

            par.CalcolaCanoneAbusivi(UnitaContratto, canone2, 1)
            canone2 = Format((canone2 / 360) * giorniCanone2, "0.00")
            descrizioneC2 = "dal " & CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text & " al 31/12/2008"
        End If

        If descrizioneEqc <> "" Or descrizioneC2 <> "" Then
            descrizione = "dal 01/01/2009 al " & Format(DateAdd(DateInterval.Day, -1, CDate(par.FormattaData(dataProssimoPeriodo))), "dd/MM/yyyy")
        Else
            descrizione = "dal " & CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text & " al " & Format(DateAdd(DateInterval.Day, -1, CDate(par.FormattaData(dataProssimoPeriodo))), "dd/MM/yyyy")
        End If

    End Sub

    Protected Sub controllaContrColl()

        Try
            If par.OracleConn.State = Data.ConnectionState.Closed Then
                par.OracleConn.Open()
                par.SettaCommand(par)
            End If

            Dim ContrTemp As String = ""
            Dim DOMANDACONTR As Integer = 0

            par.cmd.CommandText = "SELECT rapporti_utenza.id_domanda_abus, rapporti_utenza.cod_contratto from siscom_mi.rapporti_utenza where ID=" & lIdContratto
            Dim myReader1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReader1.Read Then
                If par.IfNull(myReader1("id_domanda_abus"), -1) <> -1 Then
                    CType(Generale1.FindControl("ContrColl"), Object).style.add("display", "block")
                End If

                If par.IfNull(myReader1("cod_contratto"), "") <> "" Then
                    ContrTemp = par.IfNull(myReader1("cod_contratto"), "")
                End If

            End If
            myReader1.Close()

            par.cmd.CommandText = "select domande_bando_vsa.cod_contratto_bozza from domande_bando_vsa, siscom_mi.rapporti_utenza where rapporti_utenza.cod_contratto=domande_bando_vsa.COD_CONTRATTO_BOZZA and domande_bando_vsa.fl_autorizzazione='1' AND COD_CONTRATTO_BOZZA IN (SELECT COD_CONTRATTO_BOZZA FROM DOMANDE_BANDO_VSA WHERE CONTRATTO_NUM = '" & ContrTemp & "')"
            myReader1 = par.cmd.ExecuteReader()
            If myReader1.Read Then
                If par.IfNull(myReader1("cod_contratto_bozza"), "") <> "" Then
                    CType(Generale1.FindControl("ContrColl"), Object).style.add("display", "block")
                End If
            End If
            myReader1.Close()

            par.cmd.Dispose()
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()

        Catch ex As Exception
            par.OracleConn.Close()
            Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try

    End Sub

    Protected Sub btnAttivazione1_Click(sender As Object, e As System.Web.UI.ImageClickEventArgs) Handles btnAttivazione1.Click
        Try
            Dim bollo As Double = 0
            Dim bolloBolletta As Double = 0
            Dim ApplicabolloBolletta As Double = 0
            Dim impCauzione As Decimal = 0
            Dim DESCRIZIONE As String = ""
            Dim DESCRIZIONE1 As String = ""
            Dim PARAMETRO_IMPORT_BOLLETTA As Integer = 0

            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)


            Dim PeriodoGiusto As Integer = 0

            If FL_NuovoContratto = "1" Then
                TXTATTIVA.Value = "0"
                CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                Session.Item("LAVORAZIONE") = "0"
                Response.Write("<script>alert('Salvare i dati prima di attivare il contratto!');</script>")
                Exit Sub
            End If

            If txtModificato.Value = "1" Then
                TXTATTIVA.Value = "0"
                CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                Session.Item("LAVORAZIONE") = "0"
                Response.Write("<script>alert('Salvare i dati prima di procedere!');</script>")
                Exit Sub
            End If

            If TXTATTIVA.Value = "1" Then
                Dim buono As Boolean = True
                par.cmd.CommandText = "select siscom_mi.getstatocontratto(UNITA_CONTRATTUALE.id_contratto) as ""STATO"",rapporti_utenza.data_riconsegna  from siscom_mi.rapporti_utenza,SISCOM_MI.unita_contrattuale where rapporti_utenza.id=unita_contrattuale.id_contratto and id_contratto<>" & lIdContratto & " and id_unita=" & UnitaContratto
                Dim myReaderW As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                Do While myReaderW.Read
                    If myReaderW("STATO") <> "CHIUSO" Then
                        buono = False
                        Exit Do
                    End If
                    If par.IfNull(myReaderW("data_riconsegna"), "29991231") > par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) Then
                        buono = False
                        Exit Do
                    End If
                Loop
                myReaderW.Close()
                If buono = False Then
                    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                    Response.Write("<script>alert('Attenzione...Il contratto non può essere attivato perchè l\'unità immobiliare è ancora occupata!');</script>")
                    TXTATTIVA.Value = "0"
                    Exit Sub
                End If

                par.cmd.CommandText = "select * from parameter where id = 117"
                myReaderW = par.cmd.ExecuteReader()
                If myReaderW.Read Then
                    PARAMETRO_IMPORT_BOLLETTA = par.IfNull(myReaderW("VALORE"), 0)
                End If
                myReaderW.Close()

                par.cmd.CommandText = "select * from SISCOM_MI.unita_stato_manutentivo where id_unita=" & UnitaContratto
                myReaderW = par.cmd.ExecuteReader()
                If myReaderW.Read Then
                    If par.IfNull(myReaderW("riassegnabile"), "0") = "0" Or par.IfNull(myReaderW("tipo_riassegnabile"), "2") = "2" Or par.IfNull(myReaderW("tipo_riassegnabile"), "2") = "0" Then
                        Response.Write("<script>alert('Attenzione...non è possibile emettere i MAV di attivazione perchè l\'unità è INAGIBILE o NON RIASSEGNABILE o CI SONO LAVORI IN CORSO, secondo quanto descritto nell\'ultima verifica dello stato manutentivo!');</script>")
                        TXTATTIVA.Value = "0"
                        CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                        myReaderW.Close()
                        Exit Sub
                    End If
                End If
                myReaderW.Close()


                Dim TipoVer As String = CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).SelectedItem.Value

                If CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text = "67,00" Then
                    If par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDurataRinnovo"), TextBox).Text, "1") <> "1" Then
                        If par.SoluzioneUnica(CDbl(par.PuntiInVirgole(CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Text)), CType(Tab_Contratto1.FindControl("txtDurata"), TextBox).Text, par.IfEmpty(CType(Tab_Registrazione1.FindControl("lblRegTot"), Label).Text, 2)) <= 67 Then
                            CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).SelectedIndex = -1
                            CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Items.FindByValue("U").Selected = True
                            CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Enabled = False
                            TipoVer = "U"

                        Else
                            'CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Items.FindByValue("A").Selected = True
                        End If
                    End If
                Else
                    ' CType(Tab_Registrazione1.FindControl("cmbModVersamento"), DropDownList).Items.FindByValue("A").Selected = True
                End If


                'verifico se il bollettino n.1 è stato emesso
                par.cmd.CommandText = "select * from siscom_mi.eventi_Contratti where cod_evento='F15' AND id_contratto=" & lIdContratto
                Dim myReaderQ0 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderQ0.HasRows = True Then
                    Response.Write("<script>alert('Attenzione...bollettini di attivazione già emessi!');</script>")
                    TXTATTIVA.Value = "0"
                    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                    myReaderW.Close()
                    Exit Sub
                End If
                myReaderQ0.Close()


                par.cmd.CommandText = "select * from SISCOM_MI.BOL_BOLLETTE where NOTE IN ('ATTIVAZIONE CONTRATTO BOLLETTINO N.1-VARIE','ATTIVAZIONE CONTRATTO BOLLETTINO N.1-DEP.CAUZIONALE') AND  ID_BOLLETTA_STORNO IS NULL AND ID_TIPO IN (10,9) AND ID_contratto=" & lIdContratto
                Dim myReaderQ As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderQ.HasRows = True Then
                    TXTATTIVA.Value = "0"
                    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                    Session.Item("LAVORAZIONE") = "0"
                    myReaderQ.Close()
                    Response.Write("<script>alert('Attenzione, Il/I Bollettino/i N. 1 già emesso/i. Stornare prima di creare il/i nuovo/i bollettino/i N. 1!');</script>")
                    Exit Sub
                Else
                    myReaderQ.Close()
                End If

                Dim SPESE_ISTRUTTORIA As Double = 0
                Select Case TipoContratto
                    Case "1", "2", "10"
                        par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=22"
                    Case "5", "6", "7"
                        par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=23"
                    Case "3"
                        par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=24"
                End Select

                Dim myReaderJ As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    SPESE_ISTRUTTORIA = (CDbl(par.PuntiInVirgole(par.IfNull(myReaderJ("VALORE"), 0))) * CDbl(par.PuntiInVirgole(CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Text))) / 100
                End If
                myReaderJ.Close()

                Dim SPESEmav As Double = 0

                par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=26"
                myReaderJ = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    SPESEmav = CDbl(par.PuntiInVirgole(myReaderJ("VALORE")))
                End If
                myReaderJ.Close()

                par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=25"
                myReaderJ = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    ApplicabolloBolletta = CDbl(par.PuntiInVirgole(myReaderJ("VALORE")))
                End If
                myReaderJ.Close()

                par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=0"
                myReaderJ = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    bolloBolletta = CDbl(par.PuntiInVirgole(myReaderJ("VALORE")))
                End If
                myReaderJ.Close()


                Dim iGiorniScad As Double = 10

                par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=7"
                myReaderJ = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    iGiorniScad = CDbl(par.PuntiInVirgole(myReaderJ("VALORE")))
                End If
                myReaderJ.Close()

                Dim DataScadenza As String = DateAdd("d", iGiorniScad, Now)

                'VERIFICO SE L'INQUILINO RISULTAVA ASSEGNATARIO DI UN ALTRO ALLOGGIO
                Dim idRUCambioUI As Long = 0

                par.cmd.CommandText = "select * from siscom_mi.RU_CAMBIO_UI where id_anagrafica =" & txtCodAffittuario.Value
                Dim myReaderI As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderI.Read Then
                    idRUCambioUI = par.IfNull(myReaderI("ID"), "")
                End If
                myReaderI.Close()

                '31-03-2015 Recupero importo cauzione vecchio contratto
                par.cmd.CommandText = "SELECT * FROM siscom_mi.GESTIONE_CAMBIO_TIPO_CONTR WHERE ID_CONTRATTO_NUOVO=" & lIdContratto & ""
                Dim myReaderUA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderUA.Read Then
                    impCauzione = CDbl(par.PuntiInVirgole(par.IfNull(myReaderUA("IMPORTO_CAUZIONE"), 0)))
                End If
                myReaderUA.Close()
                '31-03-2015 Fine

                par.cmd.CommandText = "select RAPPORTI_UTENZA.*,EDIFICI.ID_COMPLESSO,UNITA_CONTRATTUALE.ID_EDIFICIO FROM SISCOM_MI.UNITA_CONTRATTUALE,SISCOM_MI.EDIFICI,SISCOM_MI.RAPPORTI_UTENZA WHERE UNITA_CONTRATTUALE.ID_UNITA_PRINCIPALE IS NULL AND RAPPORTI_UTENZA.ID=" & lIdContratto & " AND UNITA_CONTRATTUALE.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND EDIFICI.ID=UNITA_CONTRATTUALE.ID_EDIFICIO"
                Dim myReaderS As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderS.Read Then

                    If SPESE_ISTRUTTORIA > 0 Or par.VirgoleInPunti(CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text) > 0 Or bollo > 0 Or par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text, 0)) > 0 Then
                        par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE " _
                                                    & "(ID, N_RATA, DATA_EMISSIONE, DATA_SCADENZA, DATA_I_SOLLECITO, " _
                                                    & "DATA_II_SOLLECITO, DATA_PAGAMENTO, NOTE, ID_CONTRATTO, ID_ESERCIZIO_F, " _
                                                    & "ID_UNITA, FL_ANNULLATA, PAGABILE_PRESSO, COD_AFFITTUARIO, INTESTATARIO, " _
                                                    & "INDIRIZZO, CAP_CITTA, PRESSO, RIFERIMENTO_DA, RIFERIMENTO_A, " _
                                                    & "FL_STAMPATO, ID_COMPLESSO, DATA_INS_PAGAMENTO, IMPORTO_PAGATO, NOTE_PAGAMENTO, " _
                                                    & "ANNO, OPERATORE_PAG, ID_EDIFICIO, DATA_ANNULLO_PAG, OPERATORE_ANNULLO_PAG,RIF_FILE,ID_TIPO) " _
                                                    & "Values " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE.NEXTVAL, 999, '" & Format(Now, "yyyyMMdd") _
                                                    & "', '" & Format(CDate(DataScadenza), "yyyyMMdd") & "', NULL,NULL,NULL,'ATTIVAZIONE CONTRATTO BOLLETTINO N.1-VARIE'," _
                                                    & "" & lIdContratto _
                                                    & " ," & par.RicavaEsercizioCorrente & ", " _
                                                    & UnitaContratto _
                                                    & ", '0', '', " & CType(Me.Page.FindControl("txtCodAffittuario"), HiddenField).Value _
                                                    & ", '" & par.PulisciStrSql(par.IfNull(myReaderS("PRESSO_COR"), "")) & "', " _
                                                    & "'" & par.PulisciStrSql(par.IfNull(myReaderS("TIPO_COR"), "") & " " & par.IfNull(myReaderS("VIA_COR"), "") & ", " & par.PulisciStrSql(par.IfNull(myReaderS("CIVICO_COR"), ""))) _
                                                    & "', '" & par.PulisciStrSql(par.IfNull(myReaderS("CAP_COR"), "") & " " & par.IfNull(myReaderS("LUOGO_COR"), "") & "(" & par.IfNull(myReaderS("SIGLA_COR"), "") & ")") _
                                                    & "', '', '" & par.AggiustaData(par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, Format(Now, "dd/MM/yyyy"))) _
                                                    & "', '" & par.AggiustaData(par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, Format(Now, "dd/MM/yyyy"))) & "', " _
                                                    & "'1', " & myReaderS("ID_COMPLESSO") & ", '', NULL, '', " _
                                                    & Year(Now) & ", '', " & myReaderS("ID_EDIFICIO") & ", NULL, NULL,'MOD',10)"
                        par.cmd.ExecuteNonQuery()
                        par.cmd.CommandText = "select SISCOM_MI.SEQ_BOL_BOLLETTE.CURRVAL FROM DUAL"
                        Dim myReaderx As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderx.Read Then
                            Dim ID_BOLLETTA As Long = myReaderx(0)
                            Dim TOT1 As Double = 0

                            '@@@@@@@@@@@@@@@@@@@@@@@ GLI IMPORTI LEGATI ALLA PRIMA REGISTRAZIONE NON DEVONO ESSERE PIU' ADDEBITATI IN QUESTA FASE MA SOLO DOPO IL CARICAMENTO DELLA RICEVUTA
                            'If idRUCambioUI <> 0 Then
                            '    If PARAMETRO_IMPORT_BOLLETTA = 0 Then
                            '        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                            '            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",93" _
                            '            & "," & par.VirgoleInPunti(CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text) & ")"
                            '        par.cmd.ExecuteNonQuery()
                            '        If idRUCambioUI <> 0 Then
                            '            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 93 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                            '            Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            '            If myReaderCR.Read Then
                            '                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                            '                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",93" _
                            '                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO ATTIVAZ.CONTRATTO')"
                            '                par.cmd.ExecuteNonQuery()
                            '                par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                            '                par.cmd.ExecuteNonQuery()
                            '            End If
                            '            myReaderCR.Close()
                            '        End If
                            '    Else
                            '        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 93 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                            '        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            '        If myReaderCR.Read Then
                            '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,IMP_PAGATO,NOTE) VALUES " _
                            '                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",93" _
                            '                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & ",'ATTIVAZ.CONTRATTO PRECEDENTE')"
                            '            par.cmd.ExecuteNonQuery()
                            '            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                            '            par.cmd.ExecuteNonQuery()
                            '        Else
                            '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                            '                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",93" _
                            '                    & "," & par.VirgoleInPunti(CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        End If
                            '        myReaderCR.Close()
                            '    End If
                            'Else
                            '    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                            '                                  & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",93" _
                            '                                  & "," & par.VirgoleInPunti(CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text) & ")"
                            '    par.cmd.ExecuteNonQuery()
                            'End If

                            'TOT1 = TOT1 + par.PuntiInVirgole(CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text)
                            '*********************** FINE (spostamento UI) SCRIVO VOCE 93 DI CREDITO/DEBITO ******************




                            '*********************** (spostamento UI) SCRIVO VOCE 8 DI CREDITO/DEBITO ******************
                            'If idRUCambioUI <> 0 Then
                            '    If PARAMETRO_IMPORT_BOLLETTA = 0 Then
                            '        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                            '            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '            & "," & par.VirgoleInPunti(bollo) & ")"
                            '        par.cmd.ExecuteNonQuery()
                            '        If idRUCambioUI <> 0 Then
                            '            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 8 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                            '            Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            '            If myReaderCR.Read Then
                            '                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                            '                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO ATTIVAZ.CONTRATTO')"
                            '                par.cmd.ExecuteNonQuery()
                            '                par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                            '                par.cmd.ExecuteNonQuery()
                            '            End If
                            '            myReaderCR.Close()
                            '        End If
                            '    Else
                            '        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 8 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                            '        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            '        If myReaderCR.Read Then
                            '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,IMP_PAGATO,NOTE) VALUES " _
                            '                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & ",'ATTIVAZ.CONTRATTO PRECEDENTE')"
                            '            par.cmd.ExecuteNonQuery()
                            '            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                            '            par.cmd.ExecuteNonQuery()
                            '        Else
                            '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                            '                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '                    & "," & par.VirgoleInPunti(bollo) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        End If
                            '        myReaderCR.Close()
                            '    End If
                            'Else
                            '    If bollo > 0 Then
                            '        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                            '                                      & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '                                      & "," & par.VirgoleInPunti(bollo) & ")"
                            '        par.cmd.ExecuteNonQuery()
                            '    End If
                            'End If
                            'TOT1 = TOT1 + bollo
                            '@@@@@@@@@@@@@@@@@@@@@@@ FINE GLI IMPORTI LEGATI ALLA PRIMA REGISTRAZIONE NON DEVONO ESSERE PIU' ADDEBITATI IN QUESTA FASE MA SOLO DOPO IL CARICAMENTO DELLA RICEVUTA


                            If par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text, 0) > 0 Then
                                '*********************** (spostamento UI) SCRIVO VOCE 401 DI CREDITO/DEBITO ******************
                                If idRUCambioUI <> 0 Then
                                    If PARAMETRO_IMPORT_BOLLETTA = 0 Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",401" _
                                            & "," & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text, 0)) & ")"
                                        par.cmd.ExecuteNonQuery()
                                        If idRUCambioUI <> 0 Then
                                            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 401 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                                            Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                            If myReaderCR.Read Then
                                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",401" _
                                                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO ATTIVAZ.CONTRATTO')"
                                                par.cmd.ExecuteNonQuery()
                                                par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                                par.cmd.ExecuteNonQuery()
                                            End If
                                            myReaderCR.Close()
                                        End If
                                    Else
                                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 401 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                                        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                        If myReaderCR.Read Then
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,IMP_PAGATO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",401" _
                                                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & ",'ATTIVAZ.CONTRATTO PRECEDENTE')"
                                            par.cmd.ExecuteNonQuery()
                                            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                            par.cmd.ExecuteNonQuery()
                                        Else
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",401" _
                                                    & "," & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text, 0)) & ")"
                                            par.cmd.ExecuteNonQuery()
                                        End If
                                        myReaderCR.Close()
                                    End If
                                Else
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                                  & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",401" _
                                                                  & "," & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text, 0)) & ")"
                                    par.cmd.ExecuteNonQuery()
                                End If
                                '*********************** FINE (spostamento UI) SCRIVO VOCE 401 DI CREDITO/DEBITO ******************

                                TOT1 = TOT1 + par.PuntiInVirgole(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text, 0))
                            End If

                            If SPESE_ISTRUTTORIA > 0 Then
                                '*********************** (spostamento UI) SCRIVO VOCE 406 DI CREDITO/DEBITO ******************
                                If idRUCambioUI <> 0 Then
                                    If PARAMETRO_IMPORT_BOLLETTA = 0 Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",406" _
                                            & "," & par.VirgoleInPunti(Format(SPESE_ISTRUTTORIA, "0.00")) & ")"
                                        par.cmd.ExecuteNonQuery()
                                        If idRUCambioUI <> 0 Then
                                            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 406 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                                            Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                            If myReaderCR.Read Then
                                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",406" _
                                                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO ATTIVAZ.CONTRATTO')"
                                                par.cmd.ExecuteNonQuery()
                                                par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                                par.cmd.ExecuteNonQuery()
                                            End If
                                            myReaderCR.Close()
                                        End If
                                    Else
                                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 406 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                                        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                        If myReaderCR.Read Then
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,IMP_PAGATO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",406" _
                                                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & ",'ATTIVAZ.CONTRATTO PRECEDENTE')"
                                            par.cmd.ExecuteNonQuery()
                                            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                            par.cmd.ExecuteNonQuery()
                                        Else
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",406" _
                                                    & "," & par.VirgoleInPunti(Format(SPESE_ISTRUTTORIA, "0.00")) & ")"
                                            par.cmd.ExecuteNonQuery()
                                        End If
                                        myReaderCR.Close()
                                    End If
                                Else
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                                  & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",406" _
                                                                  & "," & par.VirgoleInPunti(Format(SPESE_ISTRUTTORIA, "0.00")) & ")"
                                    par.cmd.ExecuteNonQuery()
                                End If
                                '*********************** FINE (spostamento UI) SCRIVO VOCE 406 DI CREDITO/DEBITO ******************

                                TOT1 = TOT1 + par.PuntiInVirgole(Format(SPESE_ISTRUTTORIA, "0.00"))
                            End If

                            If SPESEmav > 0 And TOT1 > 0 Then
                                '*********************** (spostamento UI) SCRIVO VOCE 407 DI CREDITO/DEBITO ******************
                                If idRUCambioUI <> 0 Then
                                    If PARAMETRO_IMPORT_BOLLETTA = 0 Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",407" _
                                            & "," & par.VirgoleInPunti(Format(SPESEmav, "0.00")) & ")"
                                        par.cmd.ExecuteNonQuery()
                                        If idRUCambioUI <> 0 Then
                                            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 407 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                                            Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                            If myReaderCR.Read Then
                                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",407" _
                                                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO ATTIVAZ.CONTRATTO')"
                                                par.cmd.ExecuteNonQuery()
                                                par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                                par.cmd.ExecuteNonQuery()
                                            End If
                                            myReaderCR.Close()
                                        End If
                                    Else
                                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 407 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                                        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                        If myReaderCR.Read Then
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,IMP_PAGATO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",407" _
                                                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & ",'ATTIVAZ.CONTRATTO PRECEDENTE')"
                                            par.cmd.ExecuteNonQuery()
                                            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                            par.cmd.ExecuteNonQuery()
                                        Else
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",407" _
                                                    & "," & par.VirgoleInPunti(Format(SPESEmav, "0.00")) & ")"
                                            par.cmd.ExecuteNonQuery()
                                        End If
                                        myReaderCR.Close()
                                    End If
                                Else
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                                  & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",407" _
                                                                  & "," & par.VirgoleInPunti(Format(SPESEmav, "0.00")) & ")"
                                    par.cmd.ExecuteNonQuery()
                                End If
                                '*********************** FINE (spostamento UI) SCRIVO VOCE 407 DI CREDITO/DEBITO ******************

                                TOT1 = TOT1 + SPESEmav
                            End If

                            If TOT1 > ApplicabolloBolletta Then
                                '*********************** (spostamento UI) SCRIVO VOCE 95 DI CREDITO/DEBITO ******************
                                If idRUCambioUI <> 0 Then
                                    If PARAMETRO_IMPORT_BOLLETTA = 0 Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",95" _
                                            & "," & par.VirgoleInPunti(Format(bolloBolletta, "0.00")) & ")"
                                        par.cmd.ExecuteNonQuery()
                                        If idRUCambioUI <> 0 Then
                                            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 95 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                                            Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                            If myReaderCR.Read Then
                                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",95" _
                                                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO ATTIVAZ.CONTRATTO')"
                                                par.cmd.ExecuteNonQuery()
                                                par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                                par.cmd.ExecuteNonQuery()
                                            End If
                                            myReaderCR.Close()
                                        End If
                                    Else
                                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 95 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                                        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                        If myReaderCR.Read Then
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,IMP_PAGATO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",95" _
                                                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & ",'ATTIVAZ.CONTRATTO PRECEDENTE')"
                                            par.cmd.ExecuteNonQuery()
                                            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                            par.cmd.ExecuteNonQuery()
                                        Else
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",95" _
                                                    & "," & par.VirgoleInPunti(Format(bolloBolletta, "0.00")) & ")"
                                            par.cmd.ExecuteNonQuery()
                                        End If
                                        myReaderCR.Close()
                                    End If
                                Else
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                                  & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",95" _
                                                                  & "," & par.VirgoleInPunti(Format(bolloBolletta, "0.00")) & ")"
                                    par.cmd.ExecuteNonQuery()
                                End If
                                '*********************** FINE (spostamento UI) SCRIVO VOCE 406 DI CREDITO/DEBITO ******************

                                TOT1 = TOT1 + par.PuntiInVirgole(Format(bolloBolletta, "0.00"))
                            End If



                            If TOT1 <= 0 Then
                                par.cmd.CommandText = "UPDATE SISCOM_MI.BOL_BOLLETTE SET FL_STAMPATO=0 WHERE ID=" & ID_BOLLETTA
                                par.cmd.ExecuteNonQuery()
                                par.cmd.CommandText = "DELETE FROM SISCOM_MI.BOL_BOLLETTE WHERE ID=" & ID_BOLLETTA
                                par.cmd.ExecuteNonQuery()
                            End If


                        End If
                        myReaderx.Close()
                    End If


                    If par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, 0) > 0 Then
                        par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE " _
                                            & "(ID, N_RATA, DATA_EMISSIONE, DATA_SCADENZA, DATA_I_SOLLECITO, " _
                                            & "DATA_II_SOLLECITO, DATA_PAGAMENTO, NOTE, ID_CONTRATTO, ID_ESERCIZIO_F, " _
                                            & "ID_UNITA, FL_ANNULLATA, PAGABILE_PRESSO, COD_AFFITTUARIO, INTESTATARIO, " _
                                            & "INDIRIZZO, CAP_CITTA, PRESSO, RIFERIMENTO_DA, RIFERIMENTO_A, " _
                                            & "FL_STAMPATO, ID_COMPLESSO, DATA_INS_PAGAMENTO, IMPORTO_PAGATO, NOTE_PAGAMENTO, " _
                                            & "ANNO, OPERATORE_PAG, ID_EDIFICIO, DATA_ANNULLO_PAG, OPERATORE_ANNULLO_PAG,RIF_FILE,ID_TIPO) " _
                                            & "Values " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE.NEXTVAL, 999, '" & Format(Now, "yyyyMMdd") _
                                            & "', '" & Format(CDate(DataScadenza), "yyyyMMdd") & "', NULL,NULL,NULL,'ATTIVAZIONE CONTRATTO BOLLETTINO N.1-DEP.CAUZIONALE'," _
                                            & "" & lIdContratto _
                                            & " ," & par.RicavaEsercizioCorrente & ", " _
                                            & UnitaContratto _
                                            & ", '0', '', " & CType(Me.Page.FindControl("txtCodAffittuario"), HiddenField).Value _
                                            & ", '" & par.PulisciStrSql(par.IfNull(myReaderS("PRESSO_COR"), "")) & "', " _
                                            & "'" & par.PulisciStrSql(par.IfNull(myReaderS("TIPO_COR"), "") & " " & par.IfNull(myReaderS("VIA_COR"), "") & ", " & par.PulisciStrSql(par.IfNull(myReaderS("CIVICO_COR"), ""))) _
                                            & "', '" & par.PulisciStrSql(par.IfNull(myReaderS("CAP_COR"), "") & " " & par.IfNull(myReaderS("LUOGO_COR"), "") & "(" & par.IfNull(myReaderS("SIGLA_COR"), "") & ")") _
                                            & "', '', '" & par.AggiustaData(par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, Format(Now, "dd/MM/yyyy"))) _
                                            & "', '" & par.AggiustaData(par.IfEmpty(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, Format(Now, "dd/MM/yyyy"))) & "', " _
                                            & "'1', " & myReaderS("ID_COMPLESSO") & ", '', NULL, '', " _
                                            & Year(Now) & ", '', " & myReaderS("ID_EDIFICIO") & ", NULL, NULL,'MAV',9)"
                        par.cmd.ExecuteNonQuery()
                        par.cmd.CommandText = "select SISCOM_MI.SEQ_BOL_BOLLETTE.CURRVAL FROM DUAL"
                        Dim myReaderX As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderX.Read Then
                            Dim ID_BOLLETTA As Long = myReaderX(0)

                            '*********************** (spostamento UI) SCRIVO VOCE 7 DI CREDITO/DEBITO ******************
                            If idRUCambioUI <> 0 Then
                                If PARAMETRO_IMPORT_BOLLETTA = 0 Then
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",7" _
                                        & "," & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, "NULL")) & ")"
                                    par.cmd.ExecuteNonQuery()
                                    If idRUCambioUI <> 0 Then
                                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 7 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=9"
                                        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                        If myReaderCR.Read Then
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",7" _
                                                & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO DEPOSITO CAUZ.')"
                                            par.cmd.ExecuteNonQuery()
                                            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                            par.cmd.ExecuteNonQuery()
                                        End If
                                        myReaderCR.Close()
                                    End If
                                Else
                                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 7 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=9"
                                    Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                    If myReaderCR.Read Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,IMP_PAGATO,NOTE) VALUES " _
                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",7" _
                                                & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & ",'DEPOSITO CAUZ. PRECEDENTE')"
                                        par.cmd.ExecuteNonQuery()
                                        par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                        par.cmd.ExecuteNonQuery()
                                    Else
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",7" _
                                                & "," & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, "NULL")) & ")"
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                    myReaderCR.Close()
                                End If
                            Else
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                              & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",7" _
                                                              & "," & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, "NULL")) & ")"
                                par.cmd.ExecuteNonQuery()
                            End If
                            If impCauzione <> 0 Then
                                par.cmd.CommandText = "INSERT INTO siscom_mi.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                       & "(siscom_mi.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",7" _
                                                       & "," & par.VirgoleInPunti(impCauzione * -1) & ")"
                                par.cmd.ExecuteNonQuery()
                            End If

                            'scrivo dentro storico dep. cauzionale
                            If par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, "0")) > 0 Then
                                par.cmd.CommandText = "select SISCOM_MI.SEQ_STORICO_DEP_CAUZIONALE.NEXTVAL from dual"
                                Dim myReaderDPC As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                If myReaderDPC.Read Then
                                    par.cmd.CommandText = "insert into siscom_mi.storico_dep_cauzionale " _
                                                        & "(ID, id_contratto, id_anagrafica, Data, importo, ID_BOLLETTA, note, data_costituzione, fl_originale, data_restituzione, importo_restituzione,RESTITUIBILE) " _
                                                        & "values " _
                                                       & "(" & myReaderDPC(0) & ", " & lIdContratto & ", " & CType(Me.Page.FindControl("txtCodAffittuario"), HiddenField).Value & ", '" & Format(Now, "yyyyMMdd") & "', " & par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, 0)) & ", " & ID_BOLLETTA & ", '','',1,null, null,1)"
                                    par.cmd.ExecuteNonQuery()

                                    par.cmd.CommandText = "insert into siscom_mi.rapporti_utenza_dep_prov " _
                                                        & "(id_contratto, id_storico_dep, libro, bolla, provenienza) " _
                                                        & " values " _
                                                        & "(" & lIdContratto & ", " & myReaderDPC(0) & ", null, null, 1)"
                                    par.cmd.ExecuteNonQuery()
                                End If
                                myReaderDPC.Close()

                            End If


                            '*********************** FINE (spostamento UI) SCRIVO VOCE 7 DI CREDITO/DEBITO ******************

                            If SPESEmav > 0 Then
                                '*********************** (spostamento UI) SCRIVO VOCE 407 DI CREDITO/DEBITO ******************

                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                              & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",407" _
                                                              & "," & par.VirgoleInPunti(Format(SPESEmav, "0.00")) & ")"
                                par.cmd.ExecuteNonQuery()

                            End If


                            If par.VirgoleInPunti(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, "0")) + impCauzione + SPESEmav > ApplicabolloBolletta Then

                                '*********************** (spostamento UI) SCRIVO VOCE 96 DI CREDITO/DEBITO ******************
                                If idRUCambioUI <> 0 Then
                                    If PARAMETRO_IMPORT_BOLLETTA = 0 Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",96" _
                                            & "," & par.VirgoleInPunti(Format(bolloBolletta, "0.00")) & ")"
                                        par.cmd.ExecuteNonQuery()
                                        If idRUCambioUI <> 0 Then
                                            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 96 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=9"
                                            Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                            If myReaderCR.Read Then
                                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",96" _
                                                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO DEPOSITO CAUZ.')"
                                                par.cmd.ExecuteNonQuery()
                                                par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                                par.cmd.ExecuteNonQuery()
                                            End If
                                            myReaderCR.Close()
                                        End If
                                    Else
                                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 96 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=9"
                                        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                        If myReaderCR.Read Then
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,IMP_PAGATO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",96" _
                                                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & ",'DEPOSITO CAUZ. PRECEDENTE')"
                                            par.cmd.ExecuteNonQuery()
                                            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                            par.cmd.ExecuteNonQuery()
                                        Else
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",96" _
                                                    & "," & par.VirgoleInPunti(Format(bolloBolletta, "0.00")) & ")"
                                            par.cmd.ExecuteNonQuery()
                                        End If
                                        myReaderCR.Close()
                                    End If
                                Else
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                                  & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",96" _
                                                                  & "," & par.VirgoleInPunti(Format(bolloBolletta, "0.00")) & ")"
                                    par.cmd.ExecuteNonQuery()
                                End If
                                '*********************** FINE (spostamento UI) SCRIVO VOCE 96 DI CREDITO/DEBITO ******************
                            End If

                            If par.PuntiInVirgole(par.IfEmpty(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text, "NULL")) <= 0 And impCauzione <> 0 Then
                                par.cmd.CommandText = "UPDATE SISCOM_MI.BOL_BOLLETTE SET FL_STAMPATO=0 WHERE ID=" & ID_BOLLETTA
                                par.cmd.ExecuteNonQuery()
                                par.cmd.CommandText = "DELETE FROM SISCOM_MI.BOL_BOLLETTE WHERE ID=" & ID_BOLLETTA
                                par.cmd.ExecuteNonQuery()
                            End If

                        End If
                        myReaderX.Close()
                    End If
                End If
                myReaderS.Close()
                CaricaTabBollette()
                CaricaGestionale()

                Generale1.IndiceDichiarazione = "-1"
                Generale1.IndiceDomanda = "-1"
                Generale1.IndiceAnagrafe = "-1"

                Dim psr As String = ""

                par.cmd.CommandText = "update siscom_mi.rapporti_utenza set versamento_tr='" & TipoVer & "' where id=" & lIdContratto
                par.cmd.ExecuteNonQuery()


                'RAPPORTI_UTENZA_PROSSIMA_BOL

                par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                                    & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                                    & "'F104','')"
                par.cmd.ExecuteNonQuery()
                ''max 08/04/2015 gest.rest dep.cauz
                'par.cmd.CommandText = "INSERT INTO SISCOM_MI.RAPPORTI_UTENZA_DEP_PROV (ID_CONTRATTO,ID_STORICO_DEP,LIBRO,BOLLA,PROVENIENZA) VALUES (" & lIdContratto & ",NULL,NULL,NULL,1)"
                'par.cmd.ExecuteNonQuery()
                ''--------fine


                'INSERISCO L'ID DEL NUOVO CONTRATTO NEL CASO DI SPOSTAMENTO
                If idRUCambioUI <> 0 Then
                    par.cmd.CommandText = "UPDATE siscom_mi.RU_CAMBIO_UI set ID_CONTRATTO_NEW=" & lIdContratto & " WHERE ID=" & idRUCambioUI
                    par.cmd.ExecuteNonQuery()
                End If
                par.myTrans.Commit()
                par.myTrans = par.OracleConn.BeginTransaction()
                HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)

                txtModificato.Value = "0"
                Response.Write("<script>alert('Bollettino/i N.1 creato regolarmente.');</script>")

                CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            End If
            TXTATTIVA.Value = "0"
            VisualizzaPreventivo()
        Catch ex As Exception
            TXTATTIVA.Value = "0"
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Sub

    Protected Sub btnAttivazione2_Click(sender As Object, e As System.Web.UI.ImageClickEventArgs) Handles btnAttivazione2.Click
        Try
            Dim bollo As Double = 0
            Dim bolloBolletta As Double = 0
            Dim ApplicabolloBolletta As Double = 0

            Dim DESCRIZIONE As String = ""
            Dim DESCRIZIONE1 As String = ""
            Dim PARAMETRO_IMPORT_BOLLETTA As Integer = 0
            Dim sMessaggioFinale As String = "Operazione effettuata. Il bollettino/i N.2 emesso/i regolarmente!"
            Dim BOLLETTINO1 As Boolean = False
            Dim BOLLETTINO2 As Boolean = False


            Dim TOT2 As Double = 0

            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            par.SettaCommand(par)
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)


            Dim PeriodoGiusto As Integer = 0

            If FL_NuovoContratto = "1" Then
                TXTATTIVA.Value = "0"
                CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                Session.Item("LAVORAZIONE") = "0"
                Response.Write("<script>alert('Salvare i dati prima di attivare il contratto!');</script>")
                Exit Sub
            End If

            If txtModificato.Value = "1" Then
                TXTATTIVA.Value = "0"
                CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                Session.Item("LAVORAZIONE") = "0"
                Response.Write("<script>alert('Salvare i dati prima di procedere!');</script>")
                Exit Sub
            End If

            If TXTATTIVA.Value = "1" Then
                Dim buono As Boolean = True
                par.cmd.CommandText = "select siscom_mi.getstatocontratto(UNITA_CONTRATTUALE.id_contratto) as ""STATO"",rapporti_utenza.data_riconsegna  from siscom_mi.rapporti_utenza,SISCOM_MI.unita_contrattuale where rapporti_utenza.id=unita_contrattuale.id_contratto and id_contratto<>" & lIdContratto & " and id_unita=" & UnitaContratto
                Dim myReaderW As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                Do While myReaderW.Read
                    If myReaderW("STATO") <> "CHIUSO" Then
                        buono = False
                        Exit Do
                    End If
                    If par.IfNull(myReaderW("data_riconsegna"), "29991231") > par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) Then
                        buono = False
                        Exit Do
                    End If
                Loop
                myReaderW.Close()
                If buono = False Then
                    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                    Response.Write("<script>alert('Attenzione...Il contratto non può essere attivato perchè l\'unità immobiliare è ancora occupata!');</script>")
                    TXTATTIVA.Value = "0"
                    Exit Sub
                End If

                If CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text = "" Then
                    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                    Response.Write("<script>alert('Attenzione...Inserire la data di decorrenza canone prima di procedere!');</script>")
                    TXTATTIVA.Value = "0"
                    Exit Sub
                End If

                par.cmd.CommandText = "select * from parameter where id = 117"
                myReaderW = par.cmd.ExecuteReader()
                If myReaderW.Read Then
                    PARAMETRO_IMPORT_BOLLETTA = par.IfNull(myReaderW("VALORE"), 0)
                End If
                myReaderW.Close()

                par.cmd.CommandText = "select * from SISCOM_MI.unita_stato_manutentivo where id_unita=" & UnitaContratto
                myReaderW = par.cmd.ExecuteReader()
                If myReaderW.Read Then
                    If par.IfNull(myReaderW("riassegnabile"), "0") = "0" Or par.IfNull(myReaderW("tipo_riassegnabile"), "2") = "2" Or par.IfNull(myReaderW("tipo_riassegnabile"), "2") = "0" Then
                        Response.Write("<script>alert('Attenzione...non è possibile emettere i MAV di attivazione perchè l\'unità è INAGIBILE o NON RIASSEGNABILE o CI SONO LAVORI IN CORSO, secondo quanto descritto nell\'ultima verifica dello stato manutentivo!');</script>")
                        TXTATTIVA.Value = "0"
                        CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                        myReaderW.Close()
                        Exit Sub

                    End If
                End If
                myReaderW.Close()

                par.cmd.CommandText = "select * from siscom_mi.eventi_Contratti where cod_evento='F15' AND id_contratto=" & lIdContratto
                Dim myReaderQ0 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderQ0.HasRows = True Then
                    Response.Write("<script>alert('Attenzione...bollettini di attivazione già emessi!');</script>")
                    TXTATTIVA.Value = "0"
                    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                    myReaderW.Close()
                    Exit Sub
                End If
                myReaderQ0.Close()

                If TipoContratto <> "7" Then
                    'verifico se il bollettino n.1 è stato emesso
                    par.cmd.CommandText = "select * from SISCOM_MI.BOL_BOLLETTE where NOTE IN ('ATTIVAZIONE CONTRATTO BOLLETTINO N.1-VARIE','ATTIVAZIONE CONTRATTO BOLLETTINO N.1-DEP.CAUZIONALE') AND  ID_BOLLETTA_STORNO IS NULL AND ID_TIPO IN (10,9) AND ID_contratto=" & lIdContratto
                    Dim myReaderQ3 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderQ3.HasRows = False Then
                        TXTATTIVA.Value = "0"
                        CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                        Session.Item("LAVORAZIONE") = "0"
                        myReaderQ3.Close()
                        Response.Write("<script>alert('Attenzione, Bollettino N. 1 NON EMESSO. Emettere il bollettino N. 1 prima del 2!');</script>")
                        Exit Sub
                    Else
                        myReaderQ3.Close()
                    End If
                End If

                'verifico se il bollettino n.2 è stato emesso
                par.cmd.CommandText = "select * from SISCOM_MI.BOL_BOLLETTE where note in ('ATTIVAZIONE CONTRATTO BOLLETTINO N.2-AFF. E SPESE','ATTIVAZIONE CONTRATTO BOLLETTINO N.2-BOLLO') and ID_BOLLETTA_STORNO IS NULL AND ID_TIPO IN (1,10) AND ID_contratto=" & lIdContratto
                myReaderW = par.cmd.ExecuteReader()
                If myReaderW.HasRows = True Then
                    TXTATTIVA.Value = "0"
                    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                    Session.Item("LAVORAZIONE") = "0"
                    myReaderW.Close()
                    Response.Write("<script>alert('Attenzione, Il Bollettino N. 2 è stato già creato. Stornare prima di creare il nuovo bollettino N. 2!');</script>")
                    Exit Sub
                Else
                    myReaderW.Close()
                    'par.cmd.CommandText = "select * from SISCOM_MI.EVENTI_CONTRATTI where COD_EVENTO='F60' AND ID_contratto=" & lIdContratto
                    'myReaderQ = par.cmd.ExecuteReader()
                    'If myReaderQ.HasRows = True Then
                    '    TXTATTIVA.Value = "0"
                    '    CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                    '    Session.Item("LAVORAZIONE") = "0"
                    '    myReaderQ.Close()
                    '    Response.Write("<script>alert('Attenzione, Il Bollettino N. 2 è stato già creato. Stornare prima di creare il nuovo bollettino N. 2!');</script>")
                    '    Exit Sub
                    'Else
                    '    myReaderQ.Close()
                    'End If
                End If


                par.cmd.CommandText = "select FL_STAMPATO,BOLLO from SISCOM_MI.RAPPORTI_UTENZA where id=" & lIdContratto
                myReaderW = par.cmd.ExecuteReader()
                If myReaderW.Read Then
                    If par.IfNull(myReaderW("FL_STAMPATO"), "0") = "0" And TipoContratto <> "7" Then
                        Response.Write("<script>alert('Attenzione...Il Bollettino N.2 non può essere emesso perchè il contratto non è stato stampato!');</script>")
                        TXTATTIVA.Value = "0"
                        CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
                        myReaderW.Close()
                        Exit Sub
                    Else
                        bollo = CDbl(par.PuntiInVirgole(par.IfNull(myReaderW("BOLLO"), 0)))
                        If CType(Tab_Contratto1.FindControl("ChBolloEsente"), CheckBox).Checked = True Then
                            bollo = 0
                        End If
                    End If
                End If
                myReaderW.Close()


                Dim dataProssimoPeriodo As String = ""
                Dim numerorata As Integer = par.ProssimaRata(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedValue, par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text), dataProssimoPeriodo)

                par.cmd.CommandText = "select * from siscom_mi.PARAMETRI_BOLLETTA WHERE id=5"
                Dim myReaderW1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderW1.Read = True Then
                    Select Case Format(Mid(par.IfNull(myReaderW1("VALORE"), "0"), 5, 2), "00")
                        Case "01", "03", "05", "07", "08", "10", "12"
                            numerorata = par.ProssimaRata(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedValue, par.IfNull(myReaderW1("VALORE"), "0000") & "31", dataProssimoPeriodo)
                        Case "02"
                            numerorata = par.ProssimaRata(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedValue, par.IfNull(myReaderW1("VALORE"), "0000") & "28", dataProssimoPeriodo)
                        Case Else
                            numerorata = par.ProssimaRata(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedValue, par.IfNull(myReaderW1("VALORE"), "0000") & "30", dataProssimoPeriodo)
                    End Select
                End If
                myReaderW1.Close()


                Dim SPESEmav As Double = 0

                par.cmd.CommandText = "select VALORE FROM SISCOM_MI.PARAMETRI_BOLLETTA WHERE ID=26"
                Dim myReaderJ As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    SPESEmav = CDbl(par.PuntiInVirgole(myReaderJ("VALORE")))
                End If
                myReaderJ.Close()

                par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=25"
                myReaderJ = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    ApplicabolloBolletta = CDbl(par.PuntiInVirgole(myReaderJ("VALORE")))
                End If
                myReaderJ.Close()

                par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=0"
                myReaderJ = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    bolloBolletta = CDbl(par.PuntiInVirgole(myReaderJ("VALORE")))
                End If
                myReaderJ.Close()

                Dim iGiorniScad As Double = 10

                par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=7"
                myReaderJ = par.cmd.ExecuteReader()
                If myReaderJ.Read Then
                    iGiorniScad = CDbl(par.PuntiInVirgole(myReaderJ("VALORE")))
                End If
                myReaderJ.Close()

                Dim DataScadenza As String = DateAdd("d", iGiorniScad, Now)

                Dim giorni As Integer = 0

                Select Case Mid(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 4, 2)
                    Case "01", "03", "05", "07", "08", "10", "12"
                        giorni = DateDiff("d", CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, "31" & Mid(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 3, 8)) + 1
                        If giorni = 31 Then giorni = 30
                    Case "02"
                        giorni = DateDiff("d", CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, "28" & Mid(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 3, 8)) + 1
                        If giorni = 28 Then giorni = 30
                    Case Else
                        giorni = DateDiff("d", CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, "30" & Mid(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 3, 8)) + 1
                End Select

                giorni = giorni + 30 * DateDiff("m", DateAdd(DateInterval.Month, 1, CDate(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text)), par.FormattaData(dataProssimoPeriodo))
                Dim ImportoResiduo As Double = Format((par.IfEmpty(CType(Tab_Canone1.FindControl("txtCANONECORRENTE"), TextBox).Text, 0) / 12) * (giorni / 30), "0.00")
                DESCRIZIONE = "dal " & CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text & " al " & Format(DateAdd(DateInterval.Day, -1, CDate(par.FormattaData(dataProssimoPeriodo))), "dd/MM/yyyy")

                ' 25/10/2013 CALCOLO CANONE PER TUTTO IL PERIODO TEMPORALE
                Dim equoAnnuo As Decimal = 0
                Dim canone2 As Decimal = 0
                Dim descrizioneEqc As String = ""
                Dim descrizioneC2 As String = ""
                If TipoContratto = "7" Then
                    CanoniAttivazAbus(dataProssimoPeriodo, equoAnnuo, canone2, DESCRIZIONE, descrizioneEqc, descrizioneC2)
                End If
                ' 25/10/2013 fine CALCOLO CANONE PER TUTTO IL PERIODO TEMPORALE

                Dim PERIODOALAFFITTOSPESE As String = ""
                Dim ImportoResiduo_2 As Double = 0

                If ImportoResiduo < 0 Then
                    ImportoResiduo_2 = ImportoResiduo * -1
                    ImportoResiduo = 0
                End If


                Dim dataProssimoPeriodo1 As String = ""
                Dim ImportoResiduo1 As Double = 0

                Select Case Mid(dataProssimoPeriodo, 5, 2)
                    Case "02", "04", "06", "08", "10", "12"
                        numerorata = par.ProssimaRata(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedValue, par.AggiustaData(DateAdd(DateInterval.Day, 1, CDate(par.FormattaData(dataProssimoPeriodo)))), dataProssimoPeriodo1)
                        ImportoResiduo1 = Format((par.IfEmpty(CType(Tab_Canone1.FindControl("txtCANONECORRENTE"), TextBox).Text, 0) / 12) - ImportoResiduo_2, "0.00")
                        DESCRIZIONE1 = MESE(Mid(dataProssimoPeriodo, 5, 2)) & " " & Mid(dataProssimoPeriodo, 1, 4)
                        giorni = giorni + 30
                    Case Else

                End Select


                'VERIFICO SE L'INQUILINO RISULTAVA ASSEGNATARIO DI UN ALTRO ALLOGGIO
                Dim idRUCambioUI As Long = 0

                par.cmd.CommandText = "select * from siscom_mi.RU_CAMBIO_UI where id_anagrafica =" & txtCodAffittuario.Value
                Dim myReaderI As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderI.Read Then
                    idRUCambioUI = par.IfNull(myReaderI("ID"), "")
                End If
                myReaderI.Close()

                Select Case Mid(dataProssimoPeriodo, 5, 2)
                    Case "01", "03", "05", "07", "08", "10", "12"
                        PERIODOALAFFITTOSPESE = "31/" & Mid(dataProssimoPeriodo, 5, 2) & "/" & Mid(dataProssimoPeriodo, 1, 4)
                    Case "02"
                        PERIODOALAFFITTOSPESE = "28/" & Mid(dataProssimoPeriodo, 5, 2) & "/" & Mid(dataProssimoPeriodo, 1, 4)
                    Case Else
                        PERIODOALAFFITTOSPESE = "30/" & Mid(dataProssimoPeriodo, 5, 2) & "/" & Mid(dataProssimoPeriodo, 1, 4)
                End Select

                par.cmd.CommandText = "select RAPPORTI_UTENZA.*,EDIFICI.ID_COMPLESSO,UNITA_CONTRATTUALE.ID_EDIFICIO FROM SISCOM_MI.UNITA_CONTRATTUALE,SISCOM_MI.EDIFICI,SISCOM_MI.RAPPORTI_UTENZA WHERE UNITA_CONTRATTUALE.ID_UNITA_PRINCIPALE IS NULL AND RAPPORTI_UTENZA.ID=" & lIdContratto & " AND UNITA_CONTRATTUALE.ID_CONTRATTO=RAPPORTI_UTENZA.ID AND EDIFICI.ID=UNITA_CONTRATTUALE.ID_EDIFICIO"
                Dim myReaderS As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderS.Read Then

                    Dim IMP300 As Double = 0
                    Dim IMP301 As Double = 0
                    Dim IMP302 As Double = 0
                    Dim IMP303 As Double = 0
                    Dim IMPaltraVoce As Double = 0
                    Dim idAltraVoce As Integer = 0

                    par.cmd.CommandText = "select IMPORTO,IMPORTO_SINGOLA_RATA FROM SISCOM_MI.BOL_SCHEMA WHERE ID_VOCE=300 AND ID_CONTRATTO=" & lIdContratto
                    Dim myReaderA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderA.Read Then
                        'If ImportoResiduo1 > 0 Then
                        '    IMP300 = par.IfNull(myReaderA("IMPORTO_SINGOLA_RATA"), 0)
                        'End If
                        If giorni > 0 Then
                            IMP300 = IMP300 + ((par.IfNull(myReaderA("IMPORTO_SINGOLA_RATA"), 0) / 1) * (giorni / 30))
                        End If
                    End If
                    myReaderA.Close()

                    par.cmd.CommandText = "select IMPORTO,IMPORTO_SINGOLA_RATA FROM SISCOM_MI.BOL_SCHEMA WHERE ID_VOCE=301 AND ID_CONTRATTO=" & lIdContratto
                    myReaderA = par.cmd.ExecuteReader()
                    If myReaderA.Read Then
                        'If ImportoResiduo1 > 0 Then
                        '    IMP301 = par.IfNull(myReaderA("IMPORTO_SINGOLA_RATA"), 0)
                        'End If
                        If giorni > 0 Then
                            IMP301 = IMP301 + ((par.IfNull(myReaderA("IMPORTO_SINGOLA_RATA"), 0) / 1) * (giorni / 30))
                        End If
                    End If
                    myReaderA.Close()

                    par.cmd.CommandText = "select IMPORTO,IMPORTO_SINGOLA_RATA FROM SISCOM_MI.BOL_SCHEMA WHERE ID_VOCE=302 AND ID_CONTRATTO=" & lIdContratto
                    myReaderA = par.cmd.ExecuteReader()
                    If myReaderA.Read Then
                        'If ImportoResiduo1 > 0 Then
                        '    IMP302 = par.IfNull(myReaderA("IMPORTO_SINGOLA_RATA"), 0)
                        'End If
                        If giorni > 0 Then
                            IMP302 = IMP302 + ((par.IfNull(myReaderA("IMPORTO_SINGOLA_RATA"), 0) / 1) * (giorni / 30))
                        End If
                    End If
                    myReaderA.Close()

                    par.cmd.CommandText = "select IMPORTO,IMPORTO_SINGOLA_RATA FROM SISCOM_MI.BOL_SCHEMA WHERE ID_VOCE=303 AND ID_CONTRATTO=" & lIdContratto
                    myReaderA = par.cmd.ExecuteReader()
                    If myReaderA.Read Then
                        'If ImportoResiduo1 > 0 Then
                        '    IMP303 = par.IfNull(myReaderA("IMPORTO_SINGOLA_RATA"), 0)
                        'End If
                        If giorni > 0 Then
                            IMP303 = IMP303 + ((par.IfNull(myReaderA("IMPORTO_SINGOLA_RATA"), 0) / 1) * (giorni / 30))
                        End If
                    End If
                    myReaderA.Close()

                    par.cmd.CommandText = "select IMPORTO,IMPORTO_SINGOLA_RATA,ID_VOCE FROM SISCOM_MI.BOL_SCHEMA WHERE ID_VOCE not in (300,301,302,303) AND DA_RATA=1 AND PER_RATE=12 AND ID_CONTRATTO=" & lIdContratto
                    myReaderA = par.cmd.ExecuteReader()
                    If myReaderA.Read Then
                        idAltraVoce = par.IfNull(myReaderA("ID_VOCE"), 0)
                        If giorni > 0 Then
                            IMPaltraVoce = IMPaltraVoce + ((par.IfNull(myReaderA("IMPORTO_SINGOLA_RATA"), 0) / 1) * (giorni / 30))
                        End If
                    End If
                    myReaderA.Close()

                    If ImportoResiduo > 0 Or ImportoResiduo1 > 0 Or IMP300 > 0 Or IMP301 > 0 Or IMP302 > 0 Or IMP303 > 0 Or IMPaltraVoce <> 0 Then
                        par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE " _
                                & "(ID, N_RATA, DATA_EMISSIONE, DATA_SCADENZA, DATA_I_SOLLECITO, " _
                                & "DATA_II_SOLLECITO, DATA_PAGAMENTO, NOTE, ID_CONTRATTO, ID_ESERCIZIO_F, " _
                                & "ID_UNITA, FL_ANNULLATA, PAGABILE_PRESSO, COD_AFFITTUARIO, INTESTATARIO, " _
                                & "INDIRIZZO, CAP_CITTA, PRESSO, RIFERIMENTO_DA, RIFERIMENTO_A, " _
                                & "FL_STAMPATO, ID_COMPLESSO, DATA_INS_PAGAMENTO, IMPORTO_PAGATO, NOTE_PAGAMENTO, " _
                                & "ANNO, OPERATORE_PAG, ID_EDIFICIO, DATA_ANNULLO_PAG, OPERATORE_ANNULLO_PAG,RIF_FILE,ID_TIPO) " _
                                & "Values " _
                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE.NEXTVAL, 999, '" & Format(Now, "yyyyMMdd") _
                                & "', '" & Format(CDate(DataScadenza), "yyyyMMdd") & "', NULL,NULL,NULL,'ATTIVAZIONE CONTRATTO BOLLETTINO N.2-AFF. E SPESE'," _
                                & "" & lIdContratto _
                                & " ," & par.RicavaEsercizioCorrente & ", " _
                                & UnitaContratto _
                                & ", '0', '', " & CType(Me.Page.FindControl("txtCodAffittuario"), HiddenField).Value _
                                & ", '" & par.PulisciStrSql(par.IfNull(myReaderS("PRESSO_COR"), "")) & "', " _
                                & "'" & par.PulisciStrSql(par.IfNull(myReaderS("TIPO_COR"), "") & " " & par.IfNull(myReaderS("VIA_COR"), "") & ", " & par.PulisciStrSql(par.IfNull(myReaderS("CIVICO_COR"), ""))) _
                                & "', '" & par.PulisciStrSql(par.IfNull(myReaderS("CAP_COR"), "") & " " & par.IfNull(myReaderS("LUOGO_COR"), "") & "(" & par.IfNull(myReaderS("SIGLA_COR"), "") & ")") _
                                & "', '', '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) _
                                & "', '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) & "', " _
                                & "'1', " & myReaderS("ID_COMPLESSO") & ", '', NULL, '', " _
                                & Year(Now) & ", '', " & myReaderS("ID_EDIFICIO") & ", NULL, NULL,'MOD',1)"
                        par.cmd.ExecuteNonQuery()
                        par.cmd.CommandText = "select SISCOM_MI.SEQ_BOL_BOLLETTE.CURRVAL FROM DUAL"
                        myReaderA = par.cmd.ExecuteReader()
                        If myReaderA.Read Then
                            Dim ID_BOLLETTA As Long = myReaderA(0)


                            If ImportoResiduo > 0 Then
                                If TipoContratto <> "7" Then
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,note) VALUES " _
                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                        & ",118" _
                                                        & "," & par.VirgoleInPunti(ImportoResiduo) & ",'" & par.PulisciStrSql(DESCRIZIONE) & "')"
                                    par.cmd.ExecuteNonQuery()

                                    '*********************** (spostamento UI) SCRIVO VOCE 118 DI CREDITO/DEBITO ******************
                                    If idRUCambioUI <> 0 Then
                                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 118 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=1"
                                        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                        If myReaderCR.Read Then
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",118" _
                                                & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO AFF.SPESE')"
                                            par.cmd.ExecuteNonQuery()
                                            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                            par.cmd.ExecuteNonQuery()
                                        End If
                                        myReaderCR.Close()
                                    End If
                                    '*********************** FINE (spostamento UI) SCRIVO VOCE 118 DI CREDITO/DEBITO ******************

                                Else
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                    & ",716" _
                                                    & "," & par.VirgoleInPunti(ImportoResiduo - equoAnnuo - canone2) & ",'" & par.PulisciStrSql(DESCRIZIONE) & "')"
                                    par.cmd.ExecuteNonQuery()

                                    If equoAnnuo > 0 Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                        & ",714" _
                                                        & "," & par.VirgoleInPunti(equoAnnuo) & ",'" & par.PulisciStrSql(descrizioneEqc) & "')"
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                    If canone2 > 0 Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                        & ",715" _
                                                        & "," & par.VirgoleInPunti(canone2) & ",'" & par.PulisciStrSql(descrizioneC2) & "')"
                                        par.cmd.ExecuteNonQuery()
                                    End If

                                    '*********************** (spostamento UI) SCRIVO VOCE 37 DI CREDITO/DEBITO ******************
                                    If idRUCambioUI <> 0 Then
                                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 716 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=1"
                                        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                        If myReaderCR.Read Then
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",716" _
                                                & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO AFF.SPESE')"
                                            par.cmd.ExecuteNonQuery()
                                            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                            par.cmd.ExecuteNonQuery()
                                        End If
                                        myReaderCR.Close()
                                    End If
                                    '*********************** FINE (spostamento UI) SCRIVO VOCE 37 DI CREDITO/DEBITO ******************

                                End If

                                TOT2 = TOT2 + ImportoResiduo
                            End If

                            'If idRUCambioUI <> 0 Then
                            '    If PARAMETRO_IMPORT_BOLLETTA = 0 Then
                            '        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                            '            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '            & "," & par.VirgoleInPunti(bollo) & ")"
                            '        par.cmd.ExecuteNonQuery()
                            '        If idRUCambioUI <> 0 Then
                            '            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 8 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                            '            Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            '            If myReaderCR.Read Then
                            '                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                            '                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO ATTIVAZ.CONTRATTO')"
                            '                par.cmd.ExecuteNonQuery()
                            '                par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                            '                par.cmd.ExecuteNonQuery()
                            '            End If
                            '            myReaderCR.Close()
                            '        End If
                            '    Else
                            '        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 8 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                            '        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            '        If myReaderCR.Read Then
                            '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,IMP_PAGATO,NOTE) VALUES " _
                            '                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & ",'ATTIVAZ.CONTRATTO PRECEDENTE')"
                            '            par.cmd.ExecuteNonQuery()
                            '            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                            '            par.cmd.ExecuteNonQuery()
                            '        Else
                            '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                            '                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '                    & "," & par.VirgoleInPunti(bollo) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        End If
                            '        myReaderCR.Close()
                            '    End If
                            'Else
                            '    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                            '                                  & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '                                  & "," & par.VirgoleInPunti(bollo) & ")"
                            '    par.cmd.ExecuteNonQuery()
                            'End If
                            ''*********************** FINE (spostamento UI) SCRIVO VOCE 8 DI CREDITO/DEBITO ******************



                            'TOT2 = TOT2 + bollo

                            If ImportoResiduo1 > 0 Then
                                If TipoContratto <> "7" Then
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                        & ",1" _
                                                        & "," & par.VirgoleInPunti(ImportoResiduo1) & ",'" & par.PulisciStrSql(DESCRIZIONE1) & "')"
                                    par.cmd.ExecuteNonQuery()

                                    '*********************** (spostamento UI) SCRIVO VOCE 1 DI CREDITO/DEBITO ******************
                                    If idRUCambioUI <> 0 Then
                                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 1 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=1"
                                        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                        If myReaderCR.Read Then
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",1" _
                                                & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO AFF.SPESE')"
                                            par.cmd.ExecuteNonQuery()
                                            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                            par.cmd.ExecuteNonQuery()
                                        End If
                                        myReaderCR.Close()
                                    End If
                                    '*********************** FINE (spostamento UI) SCRIVO VOCE 1 DI CREDITO/DEBITO ******************

                                Else
                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                        & ",716" _
                                                        & "," & par.VirgoleInPunti(ImportoResiduo1) & ",'" & par.PulisciStrSql(DESCRIZIONE1) & "')"
                                    par.cmd.ExecuteNonQuery()

                                    '*********************** (spostamento UI) SCRIVO VOCE 560 DI CREDITO/DEBITO ******************
                                    If idRUCambioUI <> 0 Then
                                        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 716 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=1"
                                        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                        If myReaderCR.Read Then
                                            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",716" _
                                                & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO AFF.SPESE')"
                                            par.cmd.ExecuteNonQuery()
                                            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                            par.cmd.ExecuteNonQuery()
                                        End If
                                        myReaderCR.Close()
                                    End If
                                    '*********************** FINE (spostamento UI) SCRIVO VOCE 560 DI CREDITO/DEBITO ******************

                                End If


                                TOT2 = TOT2 + ImportoResiduo1
                            End If


                            If IMP300 > 0 Then
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                    & ",300" _
                                                    & "," & par.VirgoleInPunti(Format(IMP300, "0.00")) & ",'')"
                                par.cmd.ExecuteNonQuery()

                                '*********************** (spostamento UI) SCRIVO VOCE 300 DI CREDITO/DEBITO ******************
                                If idRUCambioUI <> 0 Then
                                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 300 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=1"
                                    Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                    If myReaderCR.Read Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",300" _
                                            & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO AFF.SPESE')"
                                        par.cmd.ExecuteNonQuery()
                                        par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                    myReaderCR.Close()
                                End If
                                '*********************** FINE (spostamento UI) SCRIVO VOCE 300 DI CREDITO/DEBITO ******************

                                TOT2 = TOT2 + IMP300
                            End If

                            If IMP301 > 0 Then
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                    & ",301" _
                                                    & "," & par.VirgoleInPunti(Format(IMP301, "0.00")) & ",'')"
                                par.cmd.ExecuteNonQuery()

                                '*********************** (spostamento UI) SCRIVO VOCE 301 DI CREDITO/DEBITO ******************
                                If idRUCambioUI <> 0 Then
                                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 301 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=1"
                                    Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                    If myReaderCR.Read Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",301" _
                                            & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO AFF.SPESE')"
                                        par.cmd.ExecuteNonQuery()
                                        par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                    myReaderCR.Close()
                                End If
                                '*********************** FINE (spostamento UI) SCRIVO VOCE 301 DI CREDITO/DEBITO ******************

                                TOT2 = TOT2 + IMP301
                            End If

                            If IMP302 > 0 Then
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                    & ",302" _
                                                    & "," & par.VirgoleInPunti(Format(IMP302, "0.00")) & ",'')"
                                par.cmd.ExecuteNonQuery()

                                '*********************** (spostamento UI) SCRIVO VOCE 302 DI CREDITO/DEBITO ******************
                                If idRUCambioUI <> 0 Then
                                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 302 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=1"
                                    Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                    If myReaderCR.Read Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",302" _
                                            & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO AFF.SPESE')"
                                        par.cmd.ExecuteNonQuery()
                                        par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                    myReaderCR.Close()
                                End If
                                '*********************** FINE (spostamento UI) SCRIVO VOCE 302 DI CREDITO/DEBITO ******************

                                TOT2 = TOT2 + IMP302
                            End If

                            If IMP303 > 0 Then
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                    & ",303" _
                                                    & "," & par.VirgoleInPunti(Format(IMP303, "0.00")) & ",'')"
                                par.cmd.ExecuteNonQuery()

                                '*********************** (spostamento UI) SCRIVO VOCE 303 DI CREDITO/DEBITO ******************
                                If idRUCambioUI <> 0 Then
                                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 303 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=1"
                                    Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                    If myReaderCR.Read Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",303" _
                                            & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO AFF.SPESE')"
                                        par.cmd.ExecuteNonQuery()
                                        par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                    myReaderCR.Close()
                                End If
                                '*********************** FINE (spostamento UI) SCRIVO VOCE 303 DI CREDITO/DEBITO ******************


                                TOT2 = TOT2 + IMP303
                            End If

                            par.cmd.CommandText = "select IMPORTO,IMPORTO_SINGOLA_RATA,ID_VOCE FROM SISCOM_MI.BOL_SCHEMA WHERE ID_VOCE not in (300,301,302,303) AND DA_RATA=1 AND PER_RATE=12 AND ID_CONTRATTO=" & lIdContratto
                            myReaderA = par.cmd.ExecuteReader()
                            Do While myReaderA.Read
                                If giorni > 0 Then
                                    IMPaltraVoce = ((par.IfNull(myReaderA("IMPORTO_SINGOLA_RATA"), 0) / 1) * (giorni / 30))

                                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                    & "," & par.IfNull(myReaderA("ID_VOCE"), 0) & "" _
                                                    & "," & par.VirgoleInPunti(Format(IMPaltraVoce, "0.00")) & ",'')"
                                    par.cmd.ExecuteNonQuery()
                                    TOT2 = TOT2 + IMPaltraVoce
                                End If
                            Loop
                            myReaderA.Close()
                            'idAltraVoce = par.IfNull(myReaderA("ID_VOCE"), 0)
                            



                            'If IMPaltraVoce <> 0 Then
                            '    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                            '                        & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                            '                        & "," & idAltraVoce & "" _
                            '                        & "," & par.VirgoleInPunti(Format(IMPaltraVoce, "0.00")) & ",'')"
                            '    par.cmd.ExecuteNonQuery()

                            '    '*********************** (spostamento UI) SCRIVO VOCE 303 DI CREDITO/DEBITO ******************
                            '    If idRUCambioUI <> 0 Then
                            '        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = " & idAltraVoce & " AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=1"
                            '        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            '        If myReaderCR.Read Then
                            '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                            '                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & "," & idAltraVoce & "" _
                            '                & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'')"
                            '            par.cmd.ExecuteNonQuery()
                            '            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                            '            par.cmd.ExecuteNonQuery()
                            '        End If
                            '        myReaderCR.Close()
                            '    End If
                            '    '*********************** FINE (spostamento UI) SCRIVO VOCE 303 DI CREDITO/DEBITO ******************

                            '    TOT2 = TOT2 + IMPaltraVoce
                            'End If

                            If SPESEmav > 0 And TOT2 > 0 Then
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",407" _
                                & "," & par.VirgoleInPunti(Format(SPESEmav, "0.00")) & ")"
                                par.cmd.ExecuteNonQuery()

                                '*********************** (spostamento UI) SCRIVO VOCE 407 DI CREDITO/DEBITO ******************
                                If idRUCambioUI <> 0 Then
                                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 407 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=1"
                                    Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                    If myReaderCR.Read Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",407" _
                                            & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO AFF.SPESE')"
                                        par.cmd.ExecuteNonQuery()
                                        par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                    myReaderCR.Close()
                                End If
                                '*********************** FINE (spostamento UI) SCRIVO VOCE 407 DI CREDITO/DEBITO ******************

                                TOT2 = TOT2 + SPESEmav
                            End If

                            If TOT2 > ApplicabolloBolletta Then
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                    & ",95" _
                                                    & "," & par.VirgoleInPunti(Format(bolloBolletta, "0.00")) & ")"
                                par.cmd.ExecuteNonQuery()

                                '*********************** (spostamento UI) SCRIVO VOCE 95 DI CREDITO/DEBITO ******************
                                If idRUCambioUI <> 0 Then
                                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 95 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=1"
                                    Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                    If myReaderCR.Read Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",95" _
                                            & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO AFF.SPESE')"
                                        par.cmd.ExecuteNonQuery()
                                        par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                    myReaderCR.Close()
                                End If
                                '*********************** FINE (spostamento UI) SCRIVO VOCE 95 DI CREDITO/DEBITO ******************


                                TOT2 = TOT2 + bolloBolletta
                            End If


                            If TOT2 <= 0 Then
                                par.cmd.CommandText = "UPDATE SISCOM_MI.BOL_BOLLETTE SET FL_STAMPATO=0 WHERE ID=" & ID_BOLLETTA
                                par.cmd.ExecuteNonQuery()
                                par.cmd.CommandText = "DELETE FROM SISCOM_MI.BOL_BOLLETTE WHERE ID=" & ID_BOLLETTA
                                par.cmd.ExecuteNonQuery()
                                BOLLETTINO1 = False
                            Else
                                BOLLETTINO1 = True
                            End If
                        End If
                        myReaderA.Close()
                    End If

                    Dim TOT2BOLLETTA As Double = 0

                    'secondo bollettino bollo
                    If bollo > 0 Then
                        par.cmd.CommandText = "Insert into SISCOM_MI.BOL_BOLLETTE " _
                                & "(ID, N_RATA, DATA_EMISSIONE, DATA_SCADENZA, DATA_I_SOLLECITO, " _
                                & "DATA_II_SOLLECITO, DATA_PAGAMENTO, NOTE, ID_CONTRATTO, ID_ESERCIZIO_F, " _
                                & "ID_UNITA, FL_ANNULLATA, PAGABILE_PRESSO, COD_AFFITTUARIO, INTESTATARIO, " _
                                & "INDIRIZZO, CAP_CITTA, PRESSO, RIFERIMENTO_DA, RIFERIMENTO_A, " _
                                & "FL_STAMPATO, ID_COMPLESSO, DATA_INS_PAGAMENTO, IMPORTO_PAGATO, NOTE_PAGAMENTO, " _
                                & "ANNO, OPERATORE_PAG, ID_EDIFICIO, DATA_ANNULLO_PAG, OPERATORE_ANNULLO_PAG,RIF_FILE,ID_TIPO) " _
                                & "Values " _
                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE.NEXTVAL, 999, '" & Format(Now, "yyyyMMdd") _
                                & "', '" & Format(CDate(DataScadenza), "yyyyMMdd") & "', NULL,NULL,NULL,'ATTIVAZIONE CONTRATTO BOLLETTINO N.2-BOLLO'," _
                                & "" & lIdContratto _
                                & " ," & par.RicavaEsercizioCorrente & ", " _
                                & UnitaContratto _
                                & ", '0', '', " & CType(Me.Page.FindControl("txtCodAffittuario"), HiddenField).Value _
                                & ", '" & par.PulisciStrSql(par.IfNull(myReaderS("PRESSO_COR"), "")) & "', " _
                                & "'" & par.PulisciStrSql(par.IfNull(myReaderS("TIPO_COR"), "") & " " & par.IfNull(myReaderS("VIA_COR"), "") & ", " & par.PulisciStrSql(par.IfNull(myReaderS("CIVICO_COR"), ""))) _
                                & "', '" & par.PulisciStrSql(par.IfNull(myReaderS("CAP_COR"), "") & " " & par.IfNull(myReaderS("LUOGO_COR"), "") & "(" & par.IfNull(myReaderS("SIGLA_COR"), "") & ")") _
                                & "', '', '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) _
                                & "', '" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) & "', " _
                                & "'1', " & myReaderS("ID_COMPLESSO") & ", '', NULL, '', " _
                                & Year(Now) & ", '', " & myReaderS("ID_EDIFICIO") & ", NULL, NULL,'MOD',10)"
                        par.cmd.ExecuteNonQuery()
                        par.cmd.CommandText = "select SISCOM_MI.SEQ_BOL_BOLLETTE.CURRVAL FROM DUAL"
                        myReaderA = par.cmd.ExecuteReader()
                        If myReaderA.Read Then
                            Dim ID_BOLLETTA As Long = myReaderA(0)




                            'If idRUCambioUI <> 0 Then
                            '    If PARAMETRO_IMPORT_BOLLETTA = 0 Then
                            '        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                            '            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '            & "," & par.VirgoleInPunti(bollo) & ")"
                            '        par.cmd.ExecuteNonQuery()
                            '        If idRUCambioUI <> 0 Then
                            '            par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 8 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                            '            Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            '            If myReaderCR.Read Then
                            '                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                            '                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO ATTIVAZ.CONTRATTO')"
                            '                par.cmd.ExecuteNonQuery()
                            '                par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                            '                par.cmd.ExecuteNonQuery()
                            '            End If
                            '            myReaderCR.Close()
                            '        End If
                            '    Else
                            '        par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 8 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=10"
                            '        Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                            '        If myReaderCR.Read Then
                            '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,IMP_PAGATO,NOTE) VALUES " _
                            '                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '                    & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0) * (-1)) & ",'ATTIVAZ.CONTRATTO PRECEDENTE')"
                            '            par.cmd.ExecuteNonQuery()
                            '            par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                            '            par.cmd.ExecuteNonQuery()
                            '        Else
                            '            par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                            '                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '                    & "," & par.VirgoleInPunti(bollo) & ")"
                            '            par.cmd.ExecuteNonQuery()
                            '        End If
                            '        myReaderCR.Close()
                            '    End If
                            'Else
                            '    par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                            '                                  & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",8" _
                            '                                  & "," & par.VirgoleInPunti(bollo) & ")"
                            '    par.cmd.ExecuteNonQuery()
                            'End If
                            ''*********************** FINE (spostamento UI) SCRIVO VOCE 8 DI CREDITO/DEBITO ******************



                            'TOT2BOLLETTA = TOT2BOLLETTA + bollo

                            If SPESEmav > 0 And TOT2BOLLETTA > 0 Then
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",407" _
                                & "," & par.VirgoleInPunti(Format(SPESEmav, "0.00")) & ")"
                                par.cmd.ExecuteNonQuery()

                                '*********************** (spostamento UI) SCRIVO VOCE 407 DI CREDITO/DEBITO ******************
                                If idRUCambioUI <> 0 Then
                                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 407 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=1"
                                    Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                    If myReaderCR.Read Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",407" _
                                            & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO AFF.SPESE')"
                                        par.cmd.ExecuteNonQuery()
                                        par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                    myReaderCR.Close()
                                End If
                                '*********************** FINE (spostamento UI) SCRIVO VOCE 407 DI CREDITO/DEBITO ******************

                                TOT2BOLLETTA = TOT2BOLLETTA + SPESEmav
                            End If

                            If TOT2BOLLETTA > ApplicabolloBolletta Then
                                par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO) VALUES " _
                                                    & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA _
                                                    & ",95" _
                                                    & "," & par.VirgoleInPunti(Format(bolloBolletta, "0.00")) & ")"
                                par.cmd.ExecuteNonQuery()

                                '*********************** (spostamento UI) SCRIVO VOCE 95 DI CREDITO/DEBITO ******************
                                If idRUCambioUI <> 0 Then
                                    par.cmd.CommandText = "SELECT * FROM SISCOM_MI.RU_CAMBIO_UI_CREDITI WHERE ID_VOCE = 95 AND ID_RU_CAMBIO_UI =" & idRUCambioUI & " AND ID_TIPO_BOLL=1"
                                    Dim myReaderCR As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                                    If myReaderCR.Read Then
                                        par.cmd.CommandText = "INSERT INTO SISCOM_MI.BOL_BOLLETTE_VOCI (ID,ID_BOLLETTA,ID_VOCE,IMPORTO,NOTE) VALUES " _
                                            & "(SISCOM_MI.SEQ_BOL_BOLLETTE_VOCI.NEXTVAL," & ID_BOLLETTA & ",95" _
                                            & "," & par.VirgoleInPunti(par.IfEmpty(myReaderCR("IMPORTO"), 0)) & ",'CREDITO/DEBITO AFF.SPESE')"
                                        par.cmd.ExecuteNonQuery()
                                        par.cmd.CommandText = "UPDATE SISCOM_MI.RU_CAMBIO_UI_CREDITI SET FL_RIASSEGNATO=1 WHERE ID=" & myReaderCR("ID")
                                        par.cmd.ExecuteNonQuery()
                                    End If
                                    myReaderCR.Close()
                                End If
                                '*********************** FINE (spostamento UI) SCRIVO VOCE 95 DI CREDITO/DEBITO ******************


                                TOT2BOLLETTA = TOT2BOLLETTA + bolloBolletta
                            End If


                            If TOT2BOLLETTA <= 0 Then
                                par.cmd.CommandText = "UPDATE SISCOM_MI.BOL_BOLLETTE SET FL_STAMPATO=0 WHERE ID=" & ID_BOLLETTA
                                par.cmd.ExecuteNonQuery()
                                par.cmd.CommandText = "DELETE FROM SISCOM_MI.BOL_BOLLETTE WHERE ID=" & ID_BOLLETTA
                                par.cmd.ExecuteNonQuery()
                                BOLLETTINO2 = False
                            Else
                                BOLLETTINO2 = True
                            End If
                        End If
                        myReaderA.Close()
                    End If




                End If
                myReaderS.Close()

                CaricaTabBollette()
                CaricaGestionale()

                Generale1.IndiceDichiarazione = "-1"
                Generale1.IndiceDomanda = "-1"
                Generale1.IndiceAnagrafe = "-1"

                Dim psr As String = ""

                If ImportoResiduo1 <> 0 Then
                    par.cmd.CommandText = "update siscom_mi.rapporti_utenza set INIZIO_PERIODO='" & Mid(dataProssimoPeriodo1, 1, 6) & "' where id=" & lIdContratto
                    par.cmd.ExecuteNonQuery()
                    CType(Tab_SchemaBollette1.FindControl("lblProssimaEmissione"), Label).Text = "Prossima Emissione: " & Mid(dataProssimoPeriodo1, 1, 4) & "/" & MESE(Mid(dataProssimoPeriodo1, 5, 2))
                    psr = Mid(dataProssimoPeriodo1, 1, 6)
                Else
                    par.cmd.CommandText = "update siscom_mi.rapporti_utenza set INIZIO_PERIODO='" & Mid(dataProssimoPeriodo, 1, 6) & "' where id=" & lIdContratto
                    par.cmd.ExecuteNonQuery()
                    CType(Tab_SchemaBollette1.FindControl("lblProssimaEmissione"), Label).Text = "Prossima Emissione: " & Mid(dataProssimoPeriodo, 1, 4) & "/" & MESE(Mid(dataProssimoPeriodo, 5, 2))
                    psr = Mid(dataProssimoPeriodo, 1, 6)
                End If


                par.cmd.CommandText = "select * from SISCOM_MI.RAPPORTI_UTENZA_PROSSIMA_BOL where ID_contratto=" & lIdContratto
                Dim myReader3 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReader3.HasRows = False Then
                    par.cmd.CommandText = "INSERT INTO siscom_mi.RAPPORTI_UTENZA_PROSSIMA_BOL (PROSSIMA_BOLLETTA,ID_CONTRATTO) VALUES ('" & psr & "'," & lIdContratto & ")"
                    par.cmd.ExecuteNonQuery()
                Else
                    par.cmd.CommandText = "update siscom_mi.RAPPORTI_UTENZA_PROSSIMA_BOL set PROSSIMA_BOLLETTA='" & psr & "' where id_CONTRATTO=" & lIdContratto
                    par.cmd.ExecuteNonQuery()
                End If
                myReader3.Close()

                If BOLLETTINO1 = True And BOLLETTINO2 = True Then
                    sMessaggioFinale = "Operazione effettuata! Sono stati emessi 2 bollettini."
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                                      & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                                      & "'F60','Emesso bollettino di att. affitto, spese e bolelttino bollo.')"
                    par.cmd.ExecuteNonQuery()
                End If

                If BOLLETTINO1 = True And BOLLETTINO2 = False Then
                    sMessaggioFinale = "Operazione effettuata! Emesso bollettino di attivazione affitto e spese"
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                                      & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                                      & "'F60','Emesso bollettino di att. affitto, spese.')"
                    par.cmd.ExecuteNonQuery()
                End If

                If BOLLETTINO1 = False And BOLLETTINO2 = True Then
                    sMessaggioFinale = "Operazione effettuata! Emesso bollettino di attivazione bollo"
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                                      & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                                      & "'F60','Emesso bollettino di attivazione bollo')"
                    par.cmd.ExecuteNonQuery()
                End If

                If BOLLETTINO1 = False And BOLLETTINO2 = False Then
                    sMessaggioFinale = "Operazione effettuata. Il bollettino N.2 non è stato creato per importo uguale a 0!"
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                                      & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                                      & "'F60','Il bollettino N.2 non è stato emesso per importo uguale a 0!')"
                    par.cmd.ExecuteNonQuery()
                End If

                'If TOT2 > 0 Then


                'Else
                '    par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                '                      & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                '                      & "'F60','Bollettino non emesso per importo uguale a 0')"
                '    par.cmd.ExecuteNonQuery()
                '    sMessaggioFinale = "Operazione effettuata. Il bollettino N.2 non è stato creato per importo uguale a 0!"
                'End If

                par.cmd.CommandText = "select * from SISCOM_MI.INTESTATARI_RAPPORTO where ID_contratto=" & lIdContratto & " and ID_ANAGRAFICA=" & CType(Me.Page.FindControl("txtCodAffittuario"), HiddenField).Value
                Dim myReaderQ As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                If myReaderQ.HasRows = False Then
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.INTESTATARI_RAPPORTO (ID_CONTRATTO,ID_ANAGRAFICA,DATA_INIZIO,DATA_FINE) " _
                   & "VALUES (" & lIdContratto & "," & CType(Me.Page.FindControl("txtCodAffittuario"), HiddenField).Value & ",'" & par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text) & "'," _
                   & "'29991231')"
                    par.cmd.ExecuteNonQuery()
                End If
                myReaderQ.Close()

                'INSERISCO L'ID DEL NUOVO CONTRATTO NEL CASO DI SPOSTAMENTO
                If idRUCambioUI <> 0 Then
                    par.cmd.CommandText = "UPDATE siscom_mi.RU_CAMBIO_UI set ID_CONTRATTO_NEW=" & lIdContratto & " WHERE ID=" & idRUCambioUI
                    par.cmd.ExecuteNonQuery()
                End If
                par.myTrans.Commit()
                'par.myTrans.Rollback()
                par.myTrans = par.OracleConn.BeginTransaction()
                HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)

                txtModificato.Value = "0"
                ImgBolAttivazione.Visible = False
                Response.Write("<script>alert('" & sMessaggioFinale & "');</script>")

                CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            End If
            TXTATTIVA.Value = "0"
            VisualizzaPreventivo()

        Catch ex As Exception
            TXTATTIVA.Value = "0"
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Sub

    Private Sub VisualizzaPreventivo()

        Dim TestoBollettino1 As String = ""
        Dim TotPreventivoBollettino1 As Double = 0

        Dim TestoBollettino2 As String = ""
        Dim TotPreventivoBollettino2 As Double = 0
        Dim Buono As Boolean = True
        Dim impCauzione As Decimal = 0
        Dim SPESE_ISTRUTTORIA As Double = 0
        Dim TotPreventivo As Double = 0
        Dim SPESE_BOLLO As Double = 0
        Dim StringaTabella As String = ""

        CType(Tab_Bollette1.FindControl("lblPreventivo"), Label).Text = ""
        CType(Tab_Bollette1.FindControl("lblPreventivo2"), Label).Text = ""

        '31-03-2015 Recupero importo cauzione vecchio contratto
        par.cmd.CommandText = "SELECT * FROM siscom_mi.GESTIONE_CAMBIO_TIPO_CONTR WHERE ID_CONTRATTO_NUOVO=" & lIdContratto & ""
        Dim myReaderUA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
        If myReaderUA.Read Then
            impCauzione = CDbl(par.PuntiInVirgole(par.IfNull(myReaderUA("IMPORTO_CAUZIONE"), 0)))
        End If
        myReaderUA.Close()
        '31-03-2015 Fine
        Dim myReaderQ As Oracle.DataAccess.Client.OracleDataReader

        If CType(Generale1.FindControl("lblStato"), Label).Text = "BOZZA" Then
            par.cmd.CommandText = "select * from siscom_mi.eventi_Contratti where cod_evento='F15' AND id_contratto=" & lIdContratto
            Dim myReaderQ0 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
            If myReaderQ0.HasRows = False Then



                par.cmd.CommandText = "select * from SISCOM_MI.BOL_BOLLETTE where NOTE IN ('ATTIVAZIONE CONTRATTO BOLLETTINO N.1-VARIE','ATTIVAZIONE CONTRATTO BOLLETTINO N.1-DEP.CAUZIONALE') AND  ID_BOLLETTA_STORNO IS NULL AND ID_TIPO IN (10,9) AND ID_contratto=" & lIdContratto
                myReaderQ = par.cmd.ExecuteReader()
                If myReaderQ.HasRows = False Then

                    'INIZIO BOLLETTINO N.1


                    Select Case TipoContratto
                        Case "1", "2", "10", "12"
                            par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=22"
                        Case "5", "6", "7"
                            par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=23"
                        Case "3"
                            par.cmd.CommandText = "select valore from siscom_MI.parametri_BOLLETTA where ID=24"
                    End Select

                    Dim myReaderJJ As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    If myReaderJJ.Read Then
                        SPESE_ISTRUTTORIA = (CDbl(par.PuntiInVirgole(par.IfNull(myReaderJJ("VALORE"), 0))) * CDbl(par.PuntiInVirgole(CType(Tab_Canone1.FindControl("txtCanoneCorrente"), TextBox).Text))) / 100
                    End If
                    myReaderJJ.Close()
                    TotPreventivo = TotPreventivo + SPESE_ISTRUTTORIA
                    If SPESE_ISTRUTTORIA > 0 Then
                        StringaTabella = "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">SPESE ISTRUTTORIA</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESE_ISTRUTTORIA, "0.00") & "</td></tr>"
                    End If
                    'If CDbl(par.VirgoleInPunti(CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text)) > 0 Then
                    '    TotPreventivo = TotPreventivo + CDbl(par.PuntiInVirgole(CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text))
                    '    StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">REGISTRAZIONE CONTRATTO</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & CType(Tab_Registrazione1.FindControl("lblRegCond"), Label).Text & "</td></tr>"
                    'End If
                    If CDbl(par.VirgoleInPunti(CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text)) > 0 Then
                        TotPreventivo = TotPreventivo + CDbl(par.PuntiInVirgole(CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text))
                        StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">ANTICIPO</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & CType(Tab_Canone1.FindControl("txtImportoAnticipo"), TextBox).Text & "</td></tr>"
                    End If
                    If CDbl(par.VirgoleInPunti(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text)) > 0 And impCauzione <> -1 Then
                        TotPreventivo = TotPreventivo + CDbl(par.PuntiInVirgole(CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text))
                        StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">CAUZIONE</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & CType(Tab_Canone1.FindControl("txtImportoCauzione"), TextBox).Text & "</td></tr>"
                    End If

                    '31-03-2015 aggiungo nuova riga per la restituzione cauzione nel preventivo
                    If impCauzione > 0 Then
                        StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">RESTITUZIONE CAUZIONE A SEGUITO CAMBIO TIPOLOGIA CONTRATTUALE</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format((impCauzione * -1), "0.00") & "</td></tr>"
                        TotPreventivo = TotPreventivo + (impCauzione * -1)
                    End If
                    '31-03-2015 FINE aggiungo nuova riga per la restituzione cauzione nel preventivo


                    StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">Totale</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(TotPreventivo, "0.00") & "</td></tr>"
                    CType(Tab_Bollette1.FindControl("lblPreventivo"), Label).Text = "<table><tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">IMPORTO PRESUNTO BOLLETTINO DI ATTIVAZIONE N.1</td><td></td></tr>" & StringaTabella & "</table>"




                Else
                    CType(Tab_Bollette1.FindControl("lblPreventivo"), Label).Text = ""
                End If
                myReaderQ.Close()
            Else
                CType(Tab_Bollette1.FindControl("lblPreventivo"), Label).Text = ""
            End If
            myReaderQ0.Close()


            StringaTabella = ""
            TotPreventivo = 0

            'INIZIO BOLLETTINO N.2
            par.cmd.CommandText = "select * from siscom_mi.eventi_Contratti where cod_evento='F15' AND id_contratto=" & lIdContratto
            myReaderQ0 = par.cmd.ExecuteReader()
            If myReaderQ0.HasRows = False Then


                par.cmd.CommandText = "select * from SISCOM_MI.BOL_BOLLETTE where NOTE IN ('ATTIVAZIONE CONTRATTO BOLLETTINO N.2-AFF. E SPESE','ATTIVAZIONE CONTRATTO BOLLETTINO N.2-BOLLO') AND  ID_BOLLETTA_STORNO IS NULL AND ID_TIPO IN (1,10) AND ID_contratto=" & lIdContratto
                myReaderQ = par.cmd.ExecuteReader()
                If myReaderQ.HasRows = False Then

                    'par.cmd.CommandText = "select bollo from siscom_mi.rapporti_utenza where id=" & lIdContratto
                    'Dim myReaderJJ As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    'If myReaderJJ.Read Then
                    '    SPESE_BOLLO = CDbl(par.PuntiInVirgole(par.IfNull(myReaderJJ("BOLLO"), 0)))
                    'End If
                    'myReaderJJ.Close()
                    'If SPESE_BOLLO = 0 Then


                    '    Dim importoBolloParam As String = ""
                    '    Dim Pagine As Integer = 1
                    '    par.cmd.CommandText = "select valore from SISCOM_MI.PARAMETRI_BOLLETTA where ID = 18"
                    '    Dim myReaderZ1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                    '    If myReaderZ1.Read Then
                    '        importoBolloParam = par.IfNull(myReaderZ1("VALORE"), "0")
                    '    End If
                    '    myReaderZ1.Close()

                    '    Dim NumCopie As Integer = 1
                    '    par.cmd.CommandText = "select valore from SISCOM_MI.PARAMETRI_BOLLETTA where ID = 45"
                    '    myReaderZ1 = par.cmd.ExecuteReader()
                    '    If myReaderZ1.Read Then
                    '        NumCopie = par.IfNull(myReaderZ1("VALORE"), "0")
                    '    End If
                    '    myReaderZ1.Close()

                    '    Select Case TipoContratto
                    '        Case "1", "2", "8", "10", "12", "6"
                    '            Pagine = 5
                    '            SPESE_BOLLO = Ceiling((CDec(Pagine) / 4)) * CDec(par.PuntiInVirgole(importoBolloParam)) * NumCopie
                    '            StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">BOLLO SU CONTRATTO (STIMATO)</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESE_BOLLO, "0.00") & "</td></tr>"
                    '        Case "3"
                    '            Pagine = 6
                    '            SPESE_BOLLO = Ceiling((CDec(Pagine) / 4)) * CDec(par.PuntiInVirgole(importoBolloParam)) * NumCopie
                    '            If CType(Tab_Contratto1.FindControl("cmbDestUso"), DropDownList).SelectedItem.Value = "B" Then
                    '                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">BOLLO SU CONTRATTO (STIMATO)</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESE_BOLLO, "0.00") & "</td></tr>"
                    '            Else
                    '                StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">BOLLO SU CONTRATTO (STIMATO)</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESE_BOLLO, "0.00") & "</td></tr>"
                    '            End If
                    '        Case "5"
                    '            Pagine = 6
                    '            SPESE_BOLLO = Ceiling((CDec(Pagine) / 4)) * CDec(par.PuntiInVirgole(importoBolloParam)) * NumCopie
                    '            StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">BOLLO SU CONTRATTO (STIMATO)</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESE_BOLLO, "0.00") & "</td></tr>"

                    '        Case "7"
                    '            SPESE_BOLLO = 0
                    '    End Select
                    '    TotPreventivo = TotPreventivo + SPESE_BOLLO
                    'Else
                    '    StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">BOLLO SU CONTRATTO</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(SPESE_BOLLO, "0.00") & "</td></tr>"
                    '    TotPreventivo = TotPreventivo + SPESE_BOLLO
                    'End If



                    If CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text <> "" And CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text <> "" And CType(Tab_Canone1.FindControl("txtCANONECORRENTE"), TextBox).Text <> "" Then

                        Dim dataProssimoPeriodo As String = ""

                        Dim numerorata As Integer = par.ProssimaRata(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedValue, par.AggiustaData(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text), dataProssimoPeriodo)
                        par.cmd.CommandText = "select * from siscom_mi.PARAMETRI_BOLLETTA WHERE id=5"
                        Dim myReaderW1 As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderW1.Read = True Then
                            Select Case Format(Mid(par.IfNull(myReaderW1("VALORE"), 0), 5, 2), "00")
                                Case "01", "03", "05", "07", "08", "10", "12"
                                    numerorata = par.ProssimaRata(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedValue, par.IfNull(myReaderW1("VALORE"), "0000") & "31", dataProssimoPeriodo)
                                Case "02"
                                    numerorata = par.ProssimaRata(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedValue, par.IfNull(myReaderW1("VALORE"), "0000") & "28", dataProssimoPeriodo)
                                Case Else
                                    numerorata = par.ProssimaRata(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedValue, par.IfNull(myReaderW1("VALORE"), "0000") & "30", dataProssimoPeriodo)
                            End Select
                        End If
                        myReaderW1.Close()

                        Dim giorni As Integer = 0

                        Select Case Mid(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 4, 2)
                            Case "01", "03", "05", "07", "08", "10", "12"
                                giorni = DateDiff("d", CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, "31" & Mid(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 3, 8)) + 1
                                If giorni = 31 Then giorni = 30
                            Case "02"
                                giorni = DateDiff("d", CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, "28" & Mid(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 3, 8)) + 1
                                If giorni = 28 Then giorni = 30
                            Case Else
                                giorni = DateDiff("d", CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, "30" & Mid(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text, 3, 8)) + 1
                        End Select
                        giorni = giorni + 30 * DateDiff("m", DateAdd(DateInterval.Month, 1, CDate(CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text)), par.FormattaData(dataProssimoPeriodo))
                        Dim ImportoResiduo As Double = Format((par.IfEmpty(CType(Tab_Canone1.FindControl("txtCANONECORRENTE"), TextBox).Text, 0) / 12) * (giorni / 30), "0.00")
                        If ImportoResiduo < 0 Then ImportoResiduo = 0
                        If ImportoResiduo > 0 Then
                            TotPreventivo = TotPreventivo + ImportoResiduo
                            Dim sDESCRIZIONE = "dal " & CType(Tab_Contratto1.FindControl("txtDataDecorrenza"), TextBox).Text & " al " & Format(DateAdd(DateInterval.Day, -1, CDate(par.FormattaData(dataProssimoPeriodo))), "dd/MM/yyyy")
                            StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">CANONE " & sDESCRIZIONE & "</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(ImportoResiduo, "0.00") & "</td></tr>"
                        End If
                        Dim dataProssimoPeriodo1 As String = ""
                        Dim ImportoResiduo1 As Double = 0
                        Dim ImportoResiduo_2 As Double = 0

                        If ImportoResiduo < 0 Then
                            ImportoResiduo_2 = ImportoResiduo * -1
                            ImportoResiduo = 0
                        End If

                        Select Case Mid(dataProssimoPeriodo, 5, 2)
                            Case "02", "04", "06", "08", "10", "12"
                                numerorata = par.ProssimaRata(CType(Tab_Canone1.FindControl("cmbFreqCanone"), DropDownList).SelectedValue, par.AggiustaData(DateAdd(DateInterval.Day, 1, CDate(par.FormattaData(dataProssimoPeriodo)))), dataProssimoPeriodo1)
                                ImportoResiduo1 = Format((par.IfEmpty(CType(Tab_Canone1.FindControl("txtCANONECORRENTE"), TextBox).Text, 0) / 12) - ImportoResiduo_2, "0.00")
                                giorni = (giorni + 30) / 30
                            Case Else

                        End Select
                        If ImportoResiduo1 < 0 Then ImportoResiduo1 = 0
                        If ImportoResiduo1 > 0 Then
                            TotPreventivo = TotPreventivo + ImportoResiduo1
                            StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">CANONE " & Mid(dataProssimoPeriodo, 5, 2) & "/" & Mid(dataProssimoPeriodo, 1, 4) & "</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(ImportoResiduo1, "0.00") & "</td></tr>"
                        End If

                        Dim IMP300 As Double = 0
                        Dim IMP301 As Double = 0
                        Dim IMP302 As Double = 0
                        Dim IMP303 As Double = 0
                        par.cmd.CommandText = "select IMPORTO,IMPORTO_SINGOLA_RATA FROM SISCOM_MI.BOL_SCHEMA WHERE ANNO=" & Year(Now) & " AND ID_VOCE=300 AND ID_CONTRATTO=" & lIdContratto
                        Dim myReaderA As Oracle.DataAccess.Client.OracleDataReader = par.cmd.ExecuteReader()
                        If myReaderA.Read Then
                            If giorni > 0 Then
                                IMP300 = ((par.IfNull(myReaderA("IMPORTO_SINGOLA_RATA"), 0) / 1) * giorni)
                            End If
                        End If
                        myReaderA.Close()
                        par.cmd.CommandText = "select IMPORTO,IMPORTO_SINGOLA_RATA FROM SISCOM_MI.BOL_SCHEMA WHERE  ANNO=" & Year(Now) & " AND  ID_VOCE=301 AND ID_CONTRATTO=" & lIdContratto
                        myReaderA = par.cmd.ExecuteReader()
                        If myReaderA.Read Then
                            If giorni > 0 Then
                                IMP301 = ((par.IfNull(myReaderA("IMPORTO_SINGOLA_RATA"), 0) / 1) * giorni)
                            End If
                        End If
                        myReaderA.Close()
                        par.cmd.CommandText = "select IMPORTO,IMPORTO_SINGOLA_RATA FROM SISCOM_MI.BOL_SCHEMA WHERE  ANNO=" & Year(Now) & " AND  ID_VOCE=302 AND ID_CONTRATTO=" & lIdContratto
                        myReaderA = par.cmd.ExecuteReader()
                        If myReaderA.Read Then
                            If giorni > 0 Then
                                IMP302 = ((par.IfNull(myReaderA("IMPORTO_SINGOLA_RATA"), 0) / 1) * giorni)
                            End If
                        End If
                        myReaderA.Close()
                        par.cmd.CommandText = "select IMPORTO,IMPORTO_SINGOLA_RATA FROM SISCOM_MI.BOL_SCHEMA WHERE  ANNO=" & Year(Now) & " AND ID_VOCE=303 AND ID_CONTRATTO=" & lIdContratto
                        myReaderA = par.cmd.ExecuteReader()
                        If myReaderA.Read Then
                            If giorni > 0 Then
                                IMP303 = ((par.IfNull(myReaderA("IMPORTO_SINGOLA_RATA"), 0) / 1) * giorni)
                            End If
                        End If
                        myReaderA.Close()

                        If IMP300 > 0 Or IMP301 > 0 Or IMP302 > 0 Or IMP303 > 0 Then
                            TotPreventivo = TotPreventivo + IMP300 + IMP301 + IMP302 + IMP303
                            'StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">SPESE dal " & par.FormattaData(DataPartenza) & " al " & par.FormattaData(CDate(par.FormattaData(dataProssimoPeriodo)).AddDays(-1)) & "</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(IMP300 + IMP301 + IMP302 + IMP303, "0.00") & "</td></tr>"
                            StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold" & Chr(34) & ">SPESE (STIMATO)</td><td style=" & Chr(34) & "font-family: Arial; font-size: 8px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(IMP300 + IMP301 + IMP302 + IMP303, "0.00") & "</td></tr>"
                        End If
                    End If
                    StringaTabella = StringaTabella & "<tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">Totale</td><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold;text-align: right" & Chr(34) & ">" & Format(TotPreventivo, "0.00") & "</td></tr>"
                    CType(Tab_Bollette1.FindControl("lblPreventivo2"), Label).Text = "<table><tr><td style=" & Chr(34) & "font-family: Arial; font-size: 10px; font-weight: bold" & Chr(34) & ">IMPORTO PRESUNTO BOLLETTINO DI ATTIVAZIONE N.2</td><td></td></tr>" & StringaTabella & "</table>"

                Else
                    CType(Tab_Bollette1.FindControl("lblPreventivo2"), Label).Text = ""
                End If
                myReaderQ.Close()
            Else
                CType(Tab_Bollette1.FindControl("lblPreventivo2"), Label).Text = ""
            End If
            myReaderQ0.Close()
        Else
            CType(Tab_Bollette1.FindControl("lblPreventivo"), Label).Text = ""
            CType(Tab_Bollette1.FindControl("lblPreventivo2"), Label).Text = ""
        End If
    End Sub

    Public Property SaldoContratto() As Double
        Get
            If Not (ViewState("par_SaldoContratto") Is Nothing) Then
                Return CDbl(ViewState("par_SaldoContratto"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Double)
            ViewState("par_SaldoContratto") = value
        End Set

    End Property

    Private Sub RiempiCampiOA()
        Try
            'par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Oracle.DataAccess.Client.OracleConnection)
            'par.SettaCommand(par)
            'par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Oracle.DataAccess.Client.OracleTransaction)
            par.caricaComboTelerik("SELECT ID, DESCRIZIONE FROM SISCOM_MI.TAB_TIPO_OCCU_ABUSIVA ORDER BY ID ASC", CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoOccupazione"), Telerik.Web.UI.RadComboBox), "ID", "DESCRIZIONE", True)
            par.caricaComboTelerik("SELECT ID, DESCRIZIONE FROM SISCOM_MI.TAB_TIPO_ATTO_LEGITTIMANTE ORDER BY ID ASC", CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoAttoLegittimante"), Telerik.Web.UI.RadComboBox), "ID", "DESCRIZIONE", True)
            par.caricaComboTelerik("SELECT ID, DESCRIZIONE FROM SISCOM_MI.TAB_DEBITO_OA ORDER BY ID ASC", CType(Tab_OccupazioneAbusiva.FindControl("cmbPresenzaDebito"), Telerik.Web.UI.RadComboBox), "ID", "DESCRIZIONE", True)
            par.caricaComboTelerik("SELECT ID, DESCRIZIONE FROM SISCOM_MI.TAB_TIPO_DEBITO_OA ORDER BY ID ASC", CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoDebito"), Telerik.Web.UI.RadComboBox), "ID", "DESCRIZIONE", False)
            par.caricaComboTelerik("SELECT ID, DESCRIZIONE FROM SISCOM_MI.TAB_ESTINZIONE_DEBITO_OA ORDER BY ID ASC", CType(Tab_OccupazioneAbusiva.FindControl("cmbEstinzioneDebito"), Telerik.Web.UI.RadComboBox), "ID", "DESCRIZIONE", True)
        Catch ex As Exception
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Sub

    Private Sub SalvaOccupanteAbusivo()
        Try
            'GESTIONE OCCUPANTI ABUSIVI
            par.cmd.CommandText = "SELECT COUNT(ID) FROM SISCOM_MI.RU_OCCUPANTI_ABUSIVI WHERE ID_CONTRATTO = " & lIdContratto
            Dim numOccupantiAbusivi As Integer = par.IfNull(par.cmd.ExecuteScalar, 0)
            Dim codEvento As String = ""
            Dim motivazione As String = ""
            If numOccupantiAbusivi = 0 Then
                par.cmd.CommandText = "INSERT INTO SISCOM_MI.RU_OCCUPANTI_ABUSIVI (" _
                                    & " ID, ID_CONTRATTO, ID_TIPO_OCCU_ABUSIVA, " _
                                    & " ATTO_RILEVAZIONE, DATA_ATTO_RILEVAZIONE, ID_TIPO_ATTO_LEGITTIMANTE, " _
                                    & " ATTO_LEGITTIMANTE, DATA_ATTO_LEGIT, ATTO_RILASCIO, " _
                                    & " PROT_ATTO_RILASCIO, DATA_ATTO_RILASCIO, ID_DEBITO_OA, " _
                                    & " ID_ESTINZIONE_DEBITO_OA, DATA_ESTINZIONE_DEBITO, " _
                                    & " PROV_CESSAZIONE, PROT_PROV_CESSAZIONE, DATA_PROV_CESSAZIONE, TIPO_ATTO_RILEVAZIONE) " _
                                    & " VALUES ( " _
                                    & " SISCOM_MI.SEQ_RU_OCCUPANTI_ABUSIVI.NEXTVAL /* ID */, " _
                                    & lIdContratto & "  /* ID_CONTRATTO */, " _
                                    & par.RitornaNullSeMenoUno(CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoOccupazione"), Telerik.Web.UI.RadComboBox).SelectedValue) & "  /* ID_TIPO_OCCU_ABUSIVA */, " _
                                    & par.insDbValue(CType(Tab_OccupazioneAbusiva.FindControl("txtIdentificativoAtto"), Telerik.Web.UI.RadTextBox).Text, True) & "  /* ATTO_RILEVAZIONE */, " _
                                    & par.insDbValue(par.IfNull(CType(Tab_OccupazioneAbusiva.FindControl("txtDataAttoRilevazione"), Telerik.Web.UI.RadDatePicker).SelectedDate, ""), True, True) & "  /* DATA_ATTO_RILEVAZIONE */, " _
                                    & par.RitornaNullSeMenoUno(CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoAttoLegittimante"), Telerik.Web.UI.RadComboBox).SelectedValue) & "  /* ID_TIPO_ATTO_LEGITTIMANTE */, " _
                                    & par.insDbValue(CType(Tab_OccupazioneAbusiva.FindControl("txtIdentificativoAttoLegittimante"), Telerik.Web.UI.RadTextBox).Text, True) & "  /* ATTO_LEGITTIMANTE */, " _
                                    & par.insDbValue(par.IfNull(CType(Tab_OccupazioneAbusiva.FindControl("txtDataAttoLegittimante"), Telerik.Web.UI.RadDatePicker).SelectedDate, ""), True, True) & "  /* DATA_ATTO_LEGIT */, " _
                                    & par.insDbValue(CType(Tab_OccupazioneAbusiva.FindControl("txtIdentificativoAttoRilascio"), Telerik.Web.UI.RadTextBox).Text, True) & "  /* ATTO_RILASCIO */, " _
                                    & par.insDbValue(CType(Tab_OccupazioneAbusiva.FindControl("txtProtocolloAttoRilascio"), Telerik.Web.UI.RadTextBox).Text, True) & "  /* PROT_ATTO_RILASCIO */, " _
                                    & par.insDbValue(par.IfNull(CType(Tab_OccupazioneAbusiva.FindControl("txtDataAttoRilascio"), Telerik.Web.UI.RadDatePicker).SelectedDate, ""), True, True) & "  /* DATA_ATTO_RILASCIO */, " _
                                    & par.RitornaNullSeMenoUno(CType(Tab_OccupazioneAbusiva.FindControl("cmbPresenzaDebito"), Telerik.Web.UI.RadComboBox).SelectedValue) & "  /* ID_DEBITO_OA */, " _
                                    & par.RitornaNullSeMenoUno(CType(Tab_OccupazioneAbusiva.FindControl("cmbEstinzioneDebito"), Telerik.Web.UI.RadComboBox).SelectedValue) & "  /* ID_ESTINZIONE_DEBITO_OA */, " _
                                    & par.insDbValue(par.IfNull(CType(Tab_OccupazioneAbusiva.FindControl("txtDataEstinzioneDebito"), Telerik.Web.UI.RadDatePicker).SelectedDate, ""), True, True) & "  /* DATA_ESTINZIONE_DEBITO */, " _
                                    & par.insDbValue(CType(Tab_OccupazioneAbusiva.FindControl("txtIdentificativoProvvedimentoCessazione"), Telerik.Web.UI.RadTextBox).Text, True) & "  /* PROV_CESSAZIONE */, " _
                                    & par.insDbValue(CType(Tab_OccupazioneAbusiva.FindControl("txtProtocolloProvvedimentoCessazione"), Telerik.Web.UI.RadTextBox).Text, True) & "  /* PROT_PROV_CESSAZIONE */, " _
                                    & par.insDbValue(par.IfNull(CType(Tab_OccupazioneAbusiva.FindControl("txtDataProvvedimentoCessazione"), Telerik.Web.UI.RadDatePicker).SelectedDate, ""), True, True) & "  /* DATA_PROV_CESSAZIONE */," _
                                    & par.insDbValue(CType(Tab_OccupazioneAbusiva.FindControl("txtTipologiaAttoRilevazione"), Telerik.Web.UI.RadTextBox).Text, True) & "/*TIPO_ATTO_RILEVAZIONE*/)"
                par.cmd.ExecuteNonQuery()
                codEvento = "F322"
                motivazione = "INSERIMENTO OCCUPAZIONE ABUSIVA"
            Else
                par.cmd.CommandText = "UPDATE SISCOM_MI.RU_OCCUPANTI_ABUSIVI " _
                                        & " SET " _
                                        & " ID_TIPO_OCCU_ABUSIVA      = " & par.RitornaNullSeMenoUno(CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoOccupazione"), Telerik.Web.UI.RadComboBox).SelectedValue) & ", " _
                                        & " ATTO_RILEVAZIONE          = " & par.insDbValue(CType(Tab_OccupazioneAbusiva.FindControl("txtIdentificativoAtto"), Telerik.Web.UI.RadTextBox).Text, True) & ", " _
                                        & " DATA_ATTO_RILEVAZIONE     = " & par.insDbValue(par.IfNull(CType(Tab_OccupazioneAbusiva.FindControl("txtDataAttoRilevazione"), Telerik.Web.UI.RadDatePicker).SelectedDate, ""), True, True) & ", " _
                                        & " ID_TIPO_ATTO_LEGITTIMANTE = " & par.RitornaNullSeMenoUno(CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoAttoLegittimante"), Telerik.Web.UI.RadComboBox).SelectedValue) & ", " _
                                        & " ATTO_LEGITTIMANTE         = " & par.insDbValue(CType(Tab_OccupazioneAbusiva.FindControl("txtIdentificativoAttoLegittimante"), Telerik.Web.UI.RadTextBox).Text, True) & ", " _
                                        & " DATA_ATTO_LEGIT           = " & par.insDbValue(par.IfNull(CType(Tab_OccupazioneAbusiva.FindControl("txtDataAttoLegittimante"), Telerik.Web.UI.RadDatePicker).SelectedDate, ""), True, True) & ", " _
                                        & " ATTO_RILASCIO             = " & par.insDbValue(CType(Tab_OccupazioneAbusiva.FindControl("txtIdentificativoAttoRilascio"), Telerik.Web.UI.RadTextBox).Text, True) & ", " _
                                        & " PROT_ATTO_RILASCIO        = " & par.insDbValue(CType(Tab_OccupazioneAbusiva.FindControl("txtProtocolloAttoRilascio"), Telerik.Web.UI.RadTextBox).Text, True) & ", " _
                                        & " DATA_ATTO_RILASCIO        = " & par.insDbValue(par.IfNull(CType(Tab_OccupazioneAbusiva.FindControl("txtDataAttoRilascio"), Telerik.Web.UI.RadDatePicker).SelectedDate, ""), True, True) & ", " _
                                        & " ID_DEBITO_OA              = " & par.RitornaNullSeMenoUno(CType(Tab_OccupazioneAbusiva.FindControl("cmbPresenzaDebito"), Telerik.Web.UI.RadComboBox).SelectedValue) & ", " _
                                        & " ID_ESTINZIONE_DEBITO_OA   = " & par.RitornaNullSeMenoUno(CType(Tab_OccupazioneAbusiva.FindControl("cmbEstinzioneDebito"), Telerik.Web.UI.RadComboBox).SelectedValue) & ", " _
                                        & " DATA_ESTINZIONE_DEBITO    = " & par.insDbValue(par.IfNull(CType(Tab_OccupazioneAbusiva.FindControl("txtDataEstinzioneDebito"), Telerik.Web.UI.RadDatePicker).SelectedDate, ""), True, True) & ", " _
                                        & " PROV_CESSAZIONE           = " & par.insDbValue(CType(Tab_OccupazioneAbusiva.FindControl("txtIdentificativoProvvedimentoCessazione"), Telerik.Web.UI.RadTextBox).Text, True) & ", " _
                                        & " PROT_PROV_CESSAZIONE      = " & par.insDbValue(CType(Tab_OccupazioneAbusiva.FindControl("txtProtocolloProvvedimentoCessazione"), Telerik.Web.UI.RadTextBox).Text, True) & ", " _
                                        & " DATA_PROV_CESSAZIONE      = " & par.insDbValue(par.IfNull(CType(Tab_OccupazioneAbusiva.FindControl("txtDataProvvedimentoCessazione"), Telerik.Web.UI.RadDatePicker).SelectedDate, ""), True, True) & ", " _
                                        & " TIPO_ATTO_RILEVAZIONE     = " & par.insDbValue(CType(Tab_OccupazioneAbusiva.FindControl("txtTipologiaAttoRilevazione"), Telerik.Web.UI.RadTextBox).Text, True) _
                                        & " WHERE  ID_CONTRATTO       = " & lIdContratto
                par.cmd.ExecuteNonQuery()
                codEvento = "F323"
                motivazione = "MODIFICA OCCUPAZIONE ABUSIVA"
            End If
            'Gestione combobox con valori multipli TIPO_DEBITO
            par.cmd.CommandText = "DELETE FROM SISCOM_MI.RU_OCCU_ABUSIVI_TIPO_DEBITO WHERE ID_CONTRATTO = " & lIdContratto
            par.cmd.ExecuteNonQuery()
            For Each item As Telerik.Web.UI.RadComboBoxItem In CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoDebito"), Telerik.Web.UI.RadComboBox).Items
                If item.Checked = True Then
                    par.cmd.CommandText = "INSERT INTO SISCOM_MI.RU_OCCU_ABUSIVI_TIPO_DEBITO (" _
                                & " ID_CONTRATTO, ID_TIPO_DEBITO) " _
                                & " VALUES ( " _
                                & lIdContratto & "  /* ID_CONTRATTO */, " _
                                & item.Value & "  /* ID_TIPO_DEBITO */ )"
                    par.cmd.ExecuteNonQuery()
                End If
            Next
            par.cmd.CommandText = "INSERT INTO SISCOM_MI.EVENTI_CONTRATTI (ID_CONTRATTO,ID_OPERATORE,DATA_ORA,COD_EVENTO,MOTIVAZIONE) " _
                                    & "VALUES (" & lIdContratto & "," & Session.Item("ID_OPERATORE") & ",'" & Format(Now, "yyyyMMddHHmmss") & "'," _
                                    & par.insDbValue(codEvento, True) & "," & par.insDbValue(motivazione, True) & ")"
            par.cmd.ExecuteNonQuery()
        Catch ex As Exception
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Sub

    Private Function ControlloOAObb() As Boolean
        ControlloOAObb = True
        Try
            If Not IsNumeric(CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoOccupazione"), Telerik.Web.UI.RadComboBox).SelectedValue) _
                OrElse CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoOccupazione"), Telerik.Web.UI.RadComboBox).SelectedValue = "-1" Then
                ControlloOAObb = False
                Exit Function
            End If
            If String.IsNullOrEmpty(CType(Tab_OccupazioneAbusiva.FindControl("txtIdentificativoAtto"), Telerik.Web.UI.RadTextBox).Text) Then
                ControlloOAObb = False
                Exit Function
            End If
            If String.IsNullOrEmpty(CType(Tab_OccupazioneAbusiva.FindControl("txtTipologiaAttoRilevazione"), Telerik.Web.UI.RadTextBox).Text) Then
                ControlloOAObb = False
                Exit Function
            End If
            If Not IsDate(CType(Tab_OccupazioneAbusiva.FindControl("txtDataAttoRilevazione"), Telerik.Web.UI.RadDatePicker).SelectedDate) Then
                ControlloOAObb = False
                Exit Function
            End If
            'If Not IsNumeric(CType(Tab_OccupazioneAbusiva.FindControl("cmbPresenzaDebito"), Telerik.Web.UI.RadComboBox).SelectedValue) _
            '    OrElse CType(Tab_OccupazioneAbusiva.FindControl("cmbPresenzaDebito"), Telerik.Web.UI.RadComboBox).SelectedValue = "-1" Then
            '    ControlloOAObb = False
            '    Exit Function
            'Else
            '    If CType(Tab_OccupazioneAbusiva.FindControl("cmbPresenzaDebito"), Telerik.Web.UI.RadComboBox).SelectedValue = "1" Then
            '        If CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoDebito"), Telerik.Web.UI.RadComboBox).CheckedItems.Count = 0 Then
            '            ControlloOAObb = False
            '            Exit Function
            '        End If
            '        If Not IsNumeric(CType(Tab_OccupazioneAbusiva.FindControl("cmbEstinzioneDebito"), Telerik.Web.UI.RadComboBox).SelectedValue) _
            '            OrElse CType(Tab_OccupazioneAbusiva.FindControl("cmbEstinzioneDebito"), Telerik.Web.UI.RadComboBox).SelectedValue = "-1" Then
            '            ControlloOAObb = False
            '            Exit Function
            '        Else
            '            If CType(Tab_OccupazioneAbusiva.FindControl("cmbEstinzioneDebito"), Telerik.Web.UI.RadComboBox).SelectedValue = "1" Then
            '                If Not IsDate(CType(Tab_OccupazioneAbusiva.FindControl("txtDataEstinzioneDebito"), Telerik.Web.UI.RadDatePicker).SelectedDate) Then
            '                    ControlloOAObb = False
            '                    Exit Function
            '                End If
            '            End If
            '        End If
            '    End If
            'End If
                        If CType(Tab_OccupazioneAbusiva.FindControl("cmbEstinzioneDebito"), Telerik.Web.UI.RadComboBox).SelectedValue = "1" Then
                            If Not IsDate(CType(Tab_OccupazioneAbusiva.FindControl("txtDataEstinzioneDebito"), Telerik.Web.UI.RadDatePicker).SelectedDate) Then
                                ControlloOAObb = False
                                Exit Function
                End If
            End If
        Catch ex As Exception
            CType(Me.Page.FindControl("USCITA"), HiddenField).Value = "0"
            Session.Item("LAVORAZIONE") = "0"
            par.myTrans.Rollback()
            par.OracleConn.Close()
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Function

    Private Sub CaricaTabOA()
        Dim ConnAperta As Boolean = False

        Try
            If par.OracleConn.State = Data.ConnectionState.Closed Then
                ConnAperta = True
                par.OracleConn.Open()
                par.SettaCommand(par)
            End If
            par.cmd.CommandText = "SELECT  " _
                                & "ID_TIPO_OCCU_ABUSIVA, " _
                                & "ATTO_RILEVAZIONE, TO_DATE(DATA_ATTO_RILEVAZIONE,'YYYYMMDD') AS DATA_ATTO_RILEVAZIONE, ID_TIPO_ATTO_LEGITTIMANTE, " _
                                & "ATTO_LEGITTIMANTE, TO_DATE(DATA_ATTO_LEGIT,'YYYYMMDD') AS DATA_ATTO_LEGIT, ATTO_RILASCIO, " _
                                & "PROT_ATTO_RILASCIO, TO_DATE(DATA_ATTO_RILASCIO,'YYYYMMDD') AS DATA_ATTO_RILASCIO, ID_DEBITO_OA, " _
                                & "ID_ESTINZIONE_DEBITO_OA, TO_DATE(DATA_ESTINZIONE_DEBITO,'YYYYMMDD') AS DATA_ESTINZIONE_DEBITO, " _
                                & "PROV_CESSAZIONE, PROT_PROV_CESSAZIONE, TO_DATE(DATA_PROV_CESSAZIONE,'YYYYMMDD') AS DATA_PROV_CESSAZIONE, TIPO_ATTO_RILEVAZIONE " _
                                & "FROM SISCOM_MI.RU_OCCUPANTI_ABUSIVI WHERE ID_CONTRATTO = " & lIdContratto
            Dim dtOccupantiAbusivi As Data.DataTable = par.getDataTableGrid(par.cmd.CommandText)
            If dtOccupantiAbusivi.Rows.Count > 0 Then
                CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoOccupazione"), Telerik.Web.UI.RadComboBox).SelectedValue = par.IfNull(dtOccupantiAbusivi.Rows(0).Item("ID_TIPO_OCCU_ABUSIVA"), "-1")
                CType(Tab_OccupazioneAbusiva.FindControl("txtIdentificativoAtto"), Telerik.Web.UI.RadTextBox).Text = par.IfNull(dtOccupantiAbusivi.Rows(0).Item("ATTO_RILEVAZIONE"), "")
                CType(Tab_OccupazioneAbusiva.FindControl("txtTipologiaAttoRilevazione"), Telerik.Web.UI.RadTextBox).Text = par.IfNull(dtOccupantiAbusivi.Rows(0).Item("TIPO_ATTO_RILEVAZIONE"), "")

                If IsDate(dtOccupantiAbusivi.Rows(0).Item("DATA_ATTO_RILEVAZIONE")) Then
                    CType(Tab_OccupazioneAbusiva.FindControl("txtDataAttoRilevazione"), Telerik.Web.UI.RadDatePicker).SelectedDate = dtOccupantiAbusivi.Rows(0).Item("DATA_ATTO_RILEVAZIONE")
                End If
                CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoAttoLegittimante"), Telerik.Web.UI.RadComboBox).SelectedValue = par.IfNull(dtOccupantiAbusivi.Rows(0).Item("ID_TIPO_ATTO_LEGITTIMANTE"), "-1")
                CType(Tab_OccupazioneAbusiva.FindControl("txtIdentificativoAttoLegittimante"), Telerik.Web.UI.RadTextBox).Text = par.IfNull(dtOccupantiAbusivi.Rows(0).Item("ATTO_LEGITTIMANTE"), "")
                If IsDate(dtOccupantiAbusivi.Rows(0).Item("DATA_ATTO_LEGIT")) Then
                    CType(Tab_OccupazioneAbusiva.FindControl("txtDataAttoLegittimante"), Telerik.Web.UI.RadDatePicker).SelectedDate = dtOccupantiAbusivi.Rows(0).Item("DATA_ATTO_LEGIT")
                End If
                CType(Tab_OccupazioneAbusiva.FindControl("txtIdentificativoAttoRilascio"), Telerik.Web.UI.RadTextBox).Text = par.IfNull(dtOccupantiAbusivi.Rows(0).Item("ATTO_RILASCIO"), "")
                CType(Tab_OccupazioneAbusiva.FindControl("txtProtocolloAttoRilascio"), Telerik.Web.UI.RadTextBox).Text = par.IfNull(dtOccupantiAbusivi.Rows(0).Item("PROT_ATTO_RILASCIO"), "")
                If IsDate(dtOccupantiAbusivi.Rows(0).Item("DATA_ATTO_RILASCIO")) Then
                    CType(Tab_OccupazioneAbusiva.FindControl("txtDataAttoRilascio"), Telerik.Web.UI.RadDatePicker).SelectedDate = dtOccupantiAbusivi.Rows(0).Item("DATA_ATTO_RILASCIO")
                End If
                CType(Tab_OccupazioneAbusiva.FindControl("cmbPresenzaDebito"), Telerik.Web.UI.RadComboBox).SelectedValue = par.IfNull(dtOccupantiAbusivi.Rows(0).Item("ID_DEBITO_OA"), "-1")
                VerificaPresenzaDebito()

                'Caricamento combo multiselezione CMBTIPODEBITO
                par.cmd.CommandText = "SELECT ID_TIPO_DEBITO " _
                                    & "FROM SISCOM_MI.RU_OCCU_ABUSIVI_TIPO_DEBITO " _
                                    & "WHERE ID_CONTRATTO = " & lIdContratto
                Dim dtTipoDebito As Data.DataTable = par.getDataTableGrid(par.cmd.CommandText)
                If dtTipoDebito.Rows.Count > 0 Then
                    For Each riga As Data.DataRow In dtTipoDebito.Rows
                        For Each item As Telerik.Web.UI.RadComboBoxItem In CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoDebito"), Telerik.Web.UI.RadComboBox).Items
                            If item.Value = par.IfNull(riga.Item("ID_TIPO_DEBITO"), "-1") Then
                                item.Checked = True
                            End If
                        Next
                    Next
                End If
                CType(Tab_OccupazioneAbusiva.FindControl("cmbEstinzioneDebito"), Telerik.Web.UI.RadComboBox).SelectedValue = par.IfNull(dtOccupantiAbusivi.Rows(0).Item("ID_ESTINZIONE_DEBITO_OA"), "-1")
                VerificaEstinzioneDebito()
                If IsDate(dtOccupantiAbusivi.Rows(0).Item("DATA_ESTINZIONE_DEBITO")) Then
                    CType(Tab_OccupazioneAbusiva.FindControl("txtDataEstinzioneDebito"), Telerik.Web.UI.RadDatePicker).SelectedDate = dtOccupantiAbusivi.Rows(0).Item("DATA_ESTINZIONE_DEBITO")
                End If
                CType(Tab_OccupazioneAbusiva.FindControl("txtIdentificativoProvvedimentoCessazione"), Telerik.Web.UI.RadTextBox).Text = par.IfNull(dtOccupantiAbusivi.Rows(0).Item("PROV_CESSAZIONE"), "")
                CType(Tab_OccupazioneAbusiva.FindControl("txtProtocolloProvvedimentoCessazione"), Telerik.Web.UI.RadTextBox).Text = par.IfNull(dtOccupantiAbusivi.Rows(0).Item("PROT_PROV_CESSAZIONE"), "")
                If IsDate(dtOccupantiAbusivi.Rows(0).Item("DATA_PROV_CESSAZIONE")) Then
                    CType(Tab_OccupazioneAbusiva.FindControl("txtDataProvvedimentoCessazione"), Telerik.Web.UI.RadDatePicker).SelectedDate = dtOccupantiAbusivi.Rows(0).Item("DATA_PROV_CESSAZIONE")
                End If
                CType(Tab_OccupazioneAbusiva.FindControl("txtTipologiaAttoRilevazione"), Telerik.Web.UI.RadTextBox).Text = par.IfNull(dtOccupantiAbusivi.Rows(0).Item("TIPO_ATTO_RILEVAZIONE"), "")
            End If
            If ConnAperta = True Then
                par.OracleConn.Close()
                Oracle.DataAccess.Client.OracleConnection.ClearAllPools()
            End If
        Catch ex As Exception
            If Not IsNothing(par.myTrans) Then
                par.myTrans.Rollback()
            End If
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " (funzione CaricaTabOA) - " & ex.Message)
            Response.Redirect("../Errore.aspx", False)
        End Try
    End Sub

    Public Sub VerificaEstinzioneDebito()
        If CType(Tab_OccupazioneAbusiva.FindControl("cmbEstinzioneDebito"), Telerik.Web.UI.RadComboBox).SelectedValue = "1" Then
            CType(Tab_OccupazioneAbusiva.FindControl("lblDataEstinzioneDebito"), Label).Visible = True
            CType(Tab_OccupazioneAbusiva.FindControl("txtDataEstinzioneDebito"), Telerik.Web.UI.RadDatePicker).Visible = True
        Else
            CType(Tab_OccupazioneAbusiva.FindControl("lblDataEstinzioneDebito"), Label).Visible = False
            CType(Tab_OccupazioneAbusiva.FindControl("txtDataEstinzioneDebito"), Telerik.Web.UI.RadDatePicker).Visible = False
        End If
    End Sub


    Public Sub VerificaPresenzaDebito()
        If CType(Tab_OccupazioneAbusiva.FindControl("cmbPresenzaDebito"), Telerik.Web.UI.RadComboBox).SelectedValue = "1" Then
            CType(Tab_OccupazioneAbusiva.FindControl("lblTipoDebito"), Label).Visible = True
            CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoDebito"), Telerik.Web.UI.RadComboBox).Visible = True
            CType(Tab_OccupazioneAbusiva.FindControl("lblEstinzioneDebito"), Label).Visible = True
            CType(Tab_OccupazioneAbusiva.FindControl("cmbEstinzioneDebito"), Telerik.Web.UI.RadComboBox).Visible = True
        Else
            CType(Tab_OccupazioneAbusiva.FindControl("lblTipoDebito"), Label).Visible = False
            CType(Tab_OccupazioneAbusiva.FindControl("cmbTipoDebito"), Telerik.Web.UI.RadComboBox).Visible = False
            CType(Tab_OccupazioneAbusiva.FindControl("lblEstinzioneDebito"), Label).Visible = False
            CType(Tab_OccupazioneAbusiva.FindControl("cmbEstinzioneDebito"), Telerik.Web.UI.RadComboBox).Visible = False
        End If
    End Sub

End Class
