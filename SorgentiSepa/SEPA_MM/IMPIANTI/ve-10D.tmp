Imports System.Collections

Partial Class IMPIANTI_Imp_Riscaldamento
    Inherits System.Web.UI.Page
    Dim par As New CM.Global
    Public Tabber1 As String = ""
    Public Tabber2 As String = ""
    Public Tabber3 As String = ""
    Public Tabber4 As String = ""

    Public Visibile As String = ""

    Dim lstEdifici As System.Collections.Generic.List(Of CM.Edifici)

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load

        If Session.Item("OPERATORE") = "" Then
            Response.Write("<script>top.location.href=""../Portale.aspx""</script>")
            Exit Sub
        End If

        Response.Expires = 0

        lstEdifici = CType(HttpContext.Current.Session.Item("LSTEDIFICI"), System.Collections.Generic.List(Of CM.Edifici))


        If Not IsPostBack Then

            vIdImpianto = 0
            vIdImpianto = Session.Item("ID")

            lstEdifici.Clear()


            ' CONNESSIONE DB
            lIdConnessione = Format(Now, "yyyyMMddhhmmss")

            'CType(TabDettagli1.FindControl("txtConnessione"), TextBox).Text = CStr(lIdConnessione)
            Me.txtConnessione.Text = CStr(lIdConnessione)
            Me.txtIdImpianto.Text = "-1"

            If par.OracleConn.State = Data.ConnectionState.Open Then
                Response.Write("IMPOSSIBILE VISUALIZZARE")
                Exit Sub
            Else
                par.OracleConn.Open()
                par.cmd = par.OracleConn.CreateCommand()
                HttpContext.Current.Session.Add("CONNESSIONE" & lIdConnessione, par.OracleConn)
            End If

            SettaggioCampi()
            AbilitazioneOggetti(True)

            If vIdImpianto <> 0 Then
                'Visibile = "style=" & Chr(34) & "visibility:Visible" & Chr(34)

                VisualizzaDati()
                txtindietro.Text = 0
                Tabber1 = "tabbertabdefault"
            Else
                '*** DEVO DISABILITARE IL TAB COMPONENTI
                'NuovoImpianto()
                Me.txtIdImpianto.Text = -1


                'Visibile = "style=" & Chr(34) & "visibility:hidden" & Chr(34)

                Tabber1 = "tabbertabdefault"
                txtindietro.Text = 1
                'Me.LblRiepilogo.Visible = False
            End If

            '*** FORM PRINCIPALE
            cmbComplesso.Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';document.getElementById('USCITA').value='1';")
            DrLEdificio.Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            cmbTipoUso.Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")

            txtDenominazione.Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            txtDitta.Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")

            txtAnnoRealizzazione.Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            txtAnnoRealizzazione.Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")


            '*** FORM GENERALE
            CType(TabGenerale.FindControl("txtDittaGestione"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(TabGenerale.FindControl("txtNumTelefonico"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")

            CType(TabGenerale.FindControl("txtDataAccensione"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(TabGenerale.FindControl("txtDataAccensione"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")
            CType(TabGenerale.FindControl("txtDataRiposo"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(TabGenerale.FindControl("txtDataRiposo"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            CType(TabGenerale.FindControl("txtOreEsercizio"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")

            CType(TabGenerale.FindControl("cmbCombustibile"), DropDownList).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            CType(TabGenerale.FindControl("cmbCombustibile"), DropDownList).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';document.getElementById('USCITA').value='1';")

            CType(TabGenerale.FindControl("cmbTipoSerbatoio"), DropDownList).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            CType(TabGenerale.FindControl("txtCapacita"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(TabGenerale.FindControl("txtPotenza"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(TabGenerale.FindControl("txtConsumo"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(TabGenerale.FindControl("txtNote"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")

            CType(TabGenerale.FindControl("CheckBoxEdifici"), CheckBoxList).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';document.getElementById('USCITA').value='1';")
            'CType(TabGenerale.FindControl("RBList_Tipologia"), RadioButtonList).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")


            '*** TAB VERTIFICAZIONI
            CType(Tab_Termico_Certificazioni.FindControl("cmbTrattamentoAcqua"), DropDownList).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            'CType(TabGenerale.FindControl("cmbDenuncia"), DropDownList).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Termico_Certificazioni.FindControl("cmbLibretto"), DropDownList).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Termico_Certificazioni.FindControl("cmbContEnergia"), DropDownList).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Termico_Certificazioni.FindControl("cmbConformita"), DropDownList).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Termico_Certificazioni.FindControl("cmbDecreto"), DropDownList).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Termico_Certificazioni.FindControl("cmbLicenzaUTF"), DropDownList).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            'CType(TabGenerale.FindControl("cmbExUNI"), DropDownList).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Termico_Certificazioni.FindControl("cmbISPESL"), DropDownList).Attributes.Add("onclick", "javascript:document.getElementById('txtModificato').value='1';")

            CType(Tab_Termico_Certificazioni.FindControl("txtDataISPESL"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Termico_Certificazioni.FindControl("txtDataISPESL"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

            CType(Tab_Termico_Certificazioni.FindControl("txtDataCT"), TextBox).Attributes.Add("onchange", "javascript:document.getElementById('txtModificato').value='1';")
            CType(Tab_Termico_Certificazioni.FindControl("txtDataCT"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")


            '*** TAB RENDIMENTO
            CType(Tab_Termico_Rendimento.FindControl("txtData"), TextBox).Attributes.Add("onkeypress", "javascript:CompletaData(event,this);")

        End If


        CType(TabGenerale.FindControl("cmbTipoSerbatoio"), DropDownList).Enabled = True
        CType(TabGenerale.FindControl("lblSerbatoio"), Label).Enabled = True

        CType(TabGenerale.FindControl("txtCapacita"), TextBox).Enabled = True
        CType(TabGenerale.FindControl("lblCapacita"), Label).Enabled = True


        If CType(TabGenerale.FindControl("cmbCombustibile"), DropDownList).Text = "1" Then 'METANO
            CType(TabGenerale.FindControl("cmbTipoSerbatoio"), DropDownList).Text = ""
            CType(TabGenerale.FindControl("cmbTipoSerbatoio"), DropDownList).Enabled = False
            CType(TabGenerale.FindControl("lblSerbatoio"), Label).Enabled = False

            CType(TabGenerale.FindControl("txtCapacita"), TextBox).Text = ""
            CType(TabGenerale.FindControl("txtCapacita"), TextBox).Enabled = False
            CType(TabGenerale.FindControl("lblCapacita"), Label).Enabled = False
        End If

        If CType(TabGenerale.FindControl("cmbCombustibile"), DropDownList).Text = "3" Then  'GASOLIO
            CType(Tab_Termico_Certificazioni.FindControl("cmbDecreto"), DropDownList).Enabled = True
            CType(Tab_Termico_Certificazioni.FindControl("lblDecreto"), Label).Enabled = True
        Else
            CType(Tab_Termico_Certificazioni.FindControl("cmbDecreto"), DropDownList).Text = ""
            CType(Tab_Termico_Certificazioni.FindControl("cmbDecreto"), DropDownList).Enabled = False
            CType(Tab_Termico_Certificazioni.FindControl("lblDecreto"), Label).Enabled = False
        End If


        'txtindietro.Text = txtindietro.Text - 1

        ' ''TxtDataInizio.Attributes.Add("onblur", "javascript:return mask(this.value,this,'2,5','/');")
        ' ''txtDataOrdine.Attributes.Add("onblur", "javascript:return mask(this.value,this,'2,5','/');")
        ' ''txtDatFine.Attributes.Add("onblur", "javascript:return mask(this.value,this,'2,5','/');")

        ' ''TxtDataInizio.Attributes.Add("onfocus", "javascript:selectText(this);")
        ' ''txtDataOrdine.Attributes.Add("onfocus", "javascript:selectText(this);")
        ' ''txtDatFine.Attributes.Add("onfocus", "javascript:selectText(this);")
        'txtindietro.Text = txtindietro.Text - 1



    End Sub

    Protected Sub Page_LoadComplete(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.LoadComplete
        Tabber1 = ""
        Tabber2 = ""
        Tabber3 = ""
        Tabber4 = ""

        Select Case txttab.Text
            Case "1"
                Tabber1 = "tabbertabdefault"
            Case "2"
                Tabber2 = "tabbertabdefault"
            Case "3"
                Tabber3 = "tabbertabdefault"
            Case "4"
                Tabber4 = "tabbertabdefault"
        End Select

    End Sub

    Private Sub SettaggioCampi()

        '' CONNESSIONE DB
        'par.OracleConn = CType(HttpContext.Current.Session.Item("CONNESSIONE" & lIdConnessione), Data.OracleClient.OracleConnection)
        'par.cmd = par.OracleConn.CreateCommand()


        'CARICO COMBO COMPLESSI
        Dim gest As Integer
        gest = 0

        Try

            'par.OracleConn.Open()
            'par.cmd = par.OracleConn.CreateCommand()

            'If par.OracleConn.State = Data.ConnectionState.Closed Then
            '    If par.OracleConn.State = Data.ConnectionState.Closed Then
            '        par.OracleConn.Open()
            '        par.cmd = par.OracleConn.CreateCommand()
            '        'HttpContext.Current.Session.Add("CONNESSIONE" & lIdConnessione, par.OracleConn)
            '    End If

            If gest > 0 Then
                par.cmd.CommandText = "select distinct ID,DENOMINAZIONE from SISCOM_MI.COMPLESSI_IMMOBILIARI where substr(ID,1,1)= " & gest & "order by DENOMINAZIONE asc"
            Else
                par.cmd.CommandText = "select distinct ID,DENOMINAZIONE from SISCOM_MI.COMPLESSI_IMMOBILIARI order by DENOMINAZIONE asc"
            End If

            Dim myReader1 As Data.OracleClient.OracleDataReader = par.cmd.ExecuteReader()
            cmbComplesso.Items.Add(New ListItem(" ", -1))
            While myReader1.Read
                cmbComplesso.Items.Add(New ListItem(par.IfNull(myReader1("DENOMINAZIONE"), " "), par.IfNull(myReader1("ID"), -1)))
            End While
            myReader1.Close()
            cmbComplesso.SelectedValue = "-1"


            ''Me.cmbConformita.Items.Add(" ")
            ''Me.cmbConformita.Items.Add("SI")
            ''Me.cmbConformita.Items.Add("NO")


            ''ChBoxListEdifici.Items.Add(New ListItem("pippo", 0))
            ''ChBoxListEdifici.Items.Add(New ListItem("pluto", 0))

            'par.cmd.CommandText = "select * from SISCOM_MI.T_STATI_EFFICIENZA order by ID"
            'myReader1 = par.cmd.ExecuteReader
            'cmbStatoEfficienza.Items.Add(New ListItem(" ", -1))

            'While myReader1.Read
            '    cmbStatoEfficienza.Items.Add(New ListItem(par.IfNull(myReader1("DESCRIZIONE"), " "), par.IfNull(myReader1("ID"), -1)))
            'End While
            'cmbStatoEfficienza.Text = "-1"
            'myReader1.Close()

            '*** TIPOLOGIA_USO_TERMICI
            par.cmd.CommandText = "select * from SISCOM_MI.TIPOLOGIA_USO_TERMICI order by ID"
            myReader1 = par.cmd.ExecuteReader
            'cmbTipoUso.Items.Add(New ListItem(" ", -1))

            While myReader1.Read
                cmbTipoUso.Items.Add(New ListItem(par.IfNull(myReader1("DESCRIZIONE"), " "), par.IfNull(myReader1("ID"), -1)))
            End While
            cmbTipoUso.Text = cmbTipoUso.Items(0).Text
            myReader1.Close()
            '*********************+++


            'par.cmd.CommandText = "select ID,DESCRIZIONE from SISCOM_MI.TIPO_TERMICI_COMP order by DESCRIZIONE asc"
            'myReader1 = par.cmd.ExecuteReader

            'CType(TabDettagli1.FindControl("cmbTabTipoComp"), DropDownList).Items.Add(New ListItem(" ", -1))
            'While myReader1.Read
            '    CType(TabDettagli1.FindControl("cmbTabTipoComp"), DropDownList).Items.Add(New ListItem(par.IfNull(myReader1("DESCRIZIONE"), " "), par.IfNull(myReader1("ID"), -1)))
            'End While
            'myReader1.Close()
            'CType(TabDettagli1.FindControl("cmbTabTipoComp"), DropDownList).SelectedValue = "-1"


            'par.cmd.CommandText = "select * from SISCOM_MI.T_STATI_EFFICIENZA order by ID"
            'myReader1 = par.cmd.ExecuteReader
            'CType(TabDettagli1.FindControl("cmbTabStatoEfficienza"), DropDownList).Items.Add(New ListItem(" ", -1))

            'While myReader1.Read
            '    CType(TabDettagli1.FindControl("cmbTabStatoEfficienza"), DropDownList).Items.Add(New ListItem(par.IfNull(myReader1("DESCRIZIONE"), " "), par.IfNull(myReader1("ID"), -1)))
            'End While
            'CType(TabDettagli1.FindControl("cmbTabStatoEfficienza"), DropDownList).Text = "-1"
            'myReader1.Close()

            '***  TIPOLOGIA_COMBUSTIBILI (Tab Generale)
            par.cmd.CommandText = "select * from SISCOM_MI.TIPOLOGIA_COMBUSTIBILI order by ID"
            myReader1 = par.cmd.ExecuteReader
            CType(TabGenerale.FindControl("cmbCombustibile"), DropDownList).Items.Add(New ListItem(" ", -1))

            While myReader1.Read
                CType(TabGenerale.FindControl("cmbCombustibile"), DropDownList).Items.Add(New ListItem(par.IfNull(myReader1("DESCRIZIONE"), " "), par.IfNull(myReader1("ID"), -1)))
            End While
            CType(TabGenerale.FindControl("cmbCombustibile"), DropDownList).Text = "-1"
            myReader1.Close()

            'par.OracleConn.Close()


        Catch ex As Exception
            par.OracleConn.Close()

            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")

        End Try
        'CaricaInterventi()
        CaricaEdifici()



    End Sub

    Private Sub CaricaEdifici()
        Dim gest As Integer = 0

        Try
            'If par.OracleConn.State = Data.ConnectionState.Closed Then
            'par.OracleConn.Open()
            'par.cmd = par.OracleConn.CreateCommand()
            'HttpContext.Current.Session.Add("CONNESSIONE" & lIdConnessione, par.OracleConn)
            'End If

            Me.DrLEdificio.Items.Clear()

            DrLEdificio.Items.Add(New ListItem(" ", -1))


            If gest <> 0 Then
                par.cmd.CommandText = "select distinct ID,(DENOMINAZIONE||' - -Cod.'||COD_EDIFICIO) as DENOMINAZIONE from SISCOM_MI.EDIFICI where substr(ID,1,1)= " & gest & " order by DENOMINAZIONE asc"
            Else
                par.cmd.CommandText = "select distinct ID,(DENOMINAZIONE||' - -Cod.'||COD_EDIFICIO) as DENOMINAZIONE from SISCOM_MI.EDIFICI order by DENOMINAZIONE asc"

            End If
            Dim myReader1 As Data.OracleClient.OracleDataReader = par.cmd.ExecuteReader()
            While myReader1.Read
                DrLEdificio.Items.Add(New ListItem(par.IfNull(myReader1("DENOMINAZIONE"), " "), par.IfNull(myReader1("ID"), -1)))
            End While


            DrLEdificio.SelectedValue = "-1"

            myReader1.Close()
            'par.OracleConn.Close()

        Catch ex As Exception
            par.OracleConn.Close()

            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try

    End Sub

    Protected Sub cmbComplesso_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbComplesso.SelectedIndexChanged

        CType(Me.Page.FindControl("USCITA"), TextBox).Text = "0"

        If Me.cmbComplesso.SelectedValue <> "-1" Then

            FiltraEdifici()
        Else
            Me.DrLEdificio.Items.Clear()
            DrLEdificio.Items.Add(New ListItem(" ", -1))
        End If


        ' ''If Me.cmbComplesso.SelectedValue <> "-1" And TipoImmobile = "UNI_IMMOB" Then
        ' ''    FiltraEdifici()
        ' ''    Me.cmbUnitaImmob.Items.Add(New ListItem(" SELEZIONARE UN EDIFICIO ", -1))
        ' ''    FiltraUnitaComuni()
        ' ''ElseIf Me.cmbComplesso.SelectedValue <> "-1" And TipoImmobile = "UNI_COM" Then
        ' ''    FiltraEdifici()
        ' ''    FiltraUnitaComuni()
        ' ''ElseIf Me.cmbComplesso.SelectedValue <> "-1" And TipoImmobile = "EDIF" Then
        ' ''    FiltraEdifici()
        ' ''Else

        ' ''    Me.cmbUnitaComune.Items.Clear()
        ' ''    CaricaEdifici()
        ' ''End If

    End Sub

    Protected Sub cmbComplesso_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbComplesso.TextChanged
        CType(Me.Page.FindControl("USCITA"), TextBox).Text = "0"
    End Sub

    Private Sub FiltraEdifici()
        Dim StringaSql As String
        Dim StringaSql2 As String
        Dim dlist As CheckBoxList
        Dim ds As New Data.DataSet()
        'Dim da As Data.OracleClient.OracleDataAdapter
        Dim FlagConnessione As Boolean

        Try

            FlagConnessione = False
            If Me.cmbComplesso.SelectedValue <> "-1" Then

                If par.OracleConn.State = Data.ConnectionState.Closed Then
                    par.OracleConn.Open()
                    par.cmd = par.OracleConn.CreateCommand()

                    FlagConnessione = True
                End If
                'par.OracleConn = CType(HttpContext.Current.Session.Item("CONNESSIONE" & lIdConnessione), Data.OracleClient.OracleConnection)
                'par.cmd = par.OracleConn.CreateCommand()


                'HttpContext.Current.Session.Add("CONNESSIONE" & lIdConnessione, par.OracleConn)
                'End If


                Dim gest As Integer = 0
                Me.DrLEdificio.Items.Clear()
                lstEdifici.Clear()

                DrLEdificio.Items.Add(New ListItem(" ", -1))


                '                select distinct ID,(DENOMINAZIONE||' - -Cod.'||COD_EDIFICIO) as DENOMINAZIONE, 
                '(select count(*) from SISCOM_MI.UNITA_IMMOBILIARI where ID_EDIFICIO=EDIFICI.ID      and COD_TIPOLOGIA='AL'),
                '(SELECT SUM (( 
                '		select sum(VALORE) from SISCOM_MI.DIMENSIONI where ID_UNITA_IMMOBILIARE=SISCOM_MI.UNITA_IMMOBILIARI.ID and COD_TIPOLOGIA='SUP_NETTA'))
                '  		from SISCOM_MI.UNITA_IMMOBILIARI where ID_EDIFICIO=EDIFICI.ID      and COD_TIPOLOGIA='AL')
                'from SISCOM_MI.EDIFICI 
                'where ID_COMPLESSO = 300000004 order by DENOMINAZIONE asc


                par.cmd.CommandText = "select distinct ID,(DENOMINAZIONE||' - -Cod.'||COD_EDIFICIO) as DENOMINAZIONE," _
                                & " (select count(*) from SISCOM_MI.UNITA_IMMOBILIARI where ID_EDIFICIO=EDIFICI.ID and COD_TIPOLOGIA='AL')," _
                                & " (SELECT SUM (( " _
                                & " select sum(VALORE) from SISCOM_MI.DIMENSIONI where ID_UNITA_IMMOBILIARE=SISCOM_MI.UNITA_IMMOBILIARI.ID and COD_TIPOLOGIA='SUP_NETTA')) " _
                                & " from SISCOM_MI.UNITA_IMMOBILIARI where ID_EDIFICIO=EDIFICI.ID and COD_TIPOLOGIA='AL') " _
                                & " from SISCOM_MI.EDIFICI " _
                                & " where ID_COMPLESSO = 300000004 order by DENOMINAZIONE asc "





                If gest <> 0 Then

                    par.cmd.CommandText = "select distinct ID,(DENOMINAZIONE||' - -Cod.'||COD_EDIFICIO) as DENOMINAZIONE," _
                                                    & " (select count(*) from SISCOM_MI.UNITA_IMMOBILIARI where ID_EDIFICIO=EDIFICI.ID and COD_TIPOLOGIA='AL')," _
                                                    & " (SELECT SUM (( " _
                                                    & " select sum(VALORE) from SISCOM_MI.DIMENSIONI where ID_UNITA_IMMOBILIARE=SISCOM_MI.UNITA_IMMOBILIARI.ID and COD_TIPOLOGIA='SUP_NETTA')) " _
                                                    & " from SISCOM_MI.UNITA_IMMOBILIARI where ID_EDIFICIO=EDIFICI.ID and COD_TIPOLOGIA='AL') " _
                                                    & " from SISCOM_MI.EDIFICI " _
                                                    & " where substr(ID,1,1)= " & gest & " order by DENOMINAZIONE asc"

                    'par.cmd.CommandText = "select distinct ID,(DENOMINAZIONE||' - -Cod.'||COD_EDIFICIO) as DENOMINAZIONE from SISCOM_MI.EDIFICI where substr(ID,1,1)= " & gest & " order by DENOMINAZIONE asc"
                Else
                    par.cmd.CommandText = "select distinct ID,(DENOMINAZIONE||' - -Cod.'||COD_EDIFICIO) as DENOMINAZIONE," _
                                                    & " (select count(*) from SISCOM_MI.UNITA_IMMOBILIARI where ID_EDIFICIO=EDIFICI.ID and COD_TIPOLOGIA='AL')," _
                                                    & " (SELECT SUM (( " _
                                                    & " select sum(VALORE) from SISCOM_MI.DIMENSIONI where ID_UNITA_IMMOBILIARE=SISCOM_MI.UNITA_IMMOBILIARI.ID and COD_TIPOLOGIA='SUP_NETTA')) " _
                                                    & " from SISCOM_MI.UNITA_IMMOBILIARI where ID_EDIFICIO=EDIFICI.ID and COD_TIPOLOGIA='AL') " _
                                                    & " from SISCOM_MI.EDIFICI " _
                                                    & " where ID_COMPLESSO = " & Me.cmbComplesso.SelectedValue.ToString & " order by DENOMINAZIONE asc"

                    'par.cmd.CommandText = "select distinct ID,(DENOMINAZIONE||' - -Cod.'||COD_EDIFICIO) as DENOMINAZIONE from SISCOM_MI.EDIFICI where ID_COMPLESSO = " & Me.cmbComplesso.SelectedValue.ToString & " order by DENOMINAZIONE asc"
                End If
                StringaSql = par.cmd.CommandText

                Dim myReader1 As Data.OracleClient.OracleDataReader = par.cmd.ExecuteReader()

                While myReader1.Read
                    DrLEdificio.Items.Add(New ListItem(par.IfNull(myReader1("DENOMINAZIONE"), " "), par.IfNull(myReader1("ID"), -1)))

                    ''StringaSql2 = "select count(*), SUM((select sum(VALORE) " _
                    '                    & " from SISCOM_MI.DIMENSIONI where ID_UNITA_IMMOBILIARE=SISCOM_MI.UNITA_IMMOBILIARI.ID and COD_TIPOLOGIA='SUP_NETTA')) " _
                    '           & " from SISCOM_MI.UNITA_IMMOBILIARI where ID_EDIFICIO=" & par.IfNull(myReader1("ID"), -1) _
                    '           & "      and COD_TIPOLOGIA='AL'"

                    'par.cmd.CommandText = StringaSql2
                    'Dim myReader2 As Data.OracleClient.OracleDataReader = par.cmd.ExecuteReader()
                    'If myReader2.Read Then
                    Dim gen As CM.Edifici
                    gen = New CM.Edifici(par.IfNull(myReader1("ID"), -1), par.IfNull(myReader1("DENOMINAZIONE"), " "), par.IfNull(myReader1(2), 0), par.IfNull(myReader1(3), 0))

                    lstEdifici.Add(gen)
                    gen = Nothing
                    'End If
                    'myReader2.Close()


                End While
                myReader1.Close()


                dlist = CType(TabGenerale.FindControl("CheckBoxEdifici"), CheckBoxList)
                'da = New Data.OracleClient.OracleDataAdapter(StringaSql, par.OracleConn)
                'da.Fill(ds)

                'dlist.Items.Clear()
                dlist.DataSource = lstEdifici

                dlist.DataTextField = "descrizione"
                dlist.DataValueField = "ID"
                dlist.DataBind()

                'da.Dispose()
                ' da = Nothing




                'dlist = CType(TabGenerale.FindControl("CheckBoxEdifici"), CheckBoxList)
                'da = New Data.OracleClient.OracleDataAdapter(StringaSql, par.OracleConn)
                'da.Fill(ds)

                'dlist.Items.Clear()
                'dlist.DataSource = ds
                'dlist.DataTextField = "DENOMINAZIONE"
                'dlist.DataValueField = "ID"
                'dlist.DataBind()

                'da.Dispose()
                'da = Nothing



                '************



                '************+


                If FlagConnessione = True Then
                    par.OracleConn.Close()
                End If
            End If

        Catch ex As Exception
            par.OracleConn.Close()

            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")

        End Try

    End Sub


    Private Sub NuovoImpianto()

        Try
            par.OracleConn = CType(HttpContext.Current.Session.Item("CONNESSIONE" & lIdConnessione), Data.OracleClient.OracleConnection)
            par.cmd = par.OracleConn.CreateCommand()


            '*** INSERT e Ricavo ID IMPIANTO
            par.cmd.CommandText = " select SISCOM_MI.SEQ_IMPIANTI.NEXTVAL FROM dual "
            Dim myReader1 As Data.OracleClient.OracleDataReader = par.cmd.ExecuteReader()
            If myReader1.Read Then
                vIdImpianto = myReader1(0)
            End If
            myReader1.Close()

            Me.txtIdImpianto.Text = vIdImpianto

            'par.cmd.CommandText = "insert into SISCOM_MI.IMPIANTI (ID,COD_TIPOLOGIA) values (" & vIdImpianto & ",'TE')"


            'par.cmd.CommandText = "insert into SISCOM_MI.IMPIANTI (ID, ID_COMPLESSO, ID_EDIFICIO,COD_TIPOLOGIA,DESCRIZIONE,ANNO_COSTRUZIONE,DITTA_COSTRUTTRICE,ANNOTAZIONI) " _
            '                    & "values (" & vIdImpianto & "," & Me.cmbComplesso.SelectedValue.ToString & "," & RitornaNullSeMenoUno(Me.DrLEdificio.SelectedValue.ToString) & ",'TE','" _
            '                        & par.PulisciStrSql(Me.txtDenominazione.Text) & "','" & par.AggiustaData(txtAnnoRealizzazione.Text) & "','" _
            '                        & par.PulisciStrSql(txtDitta.Text) & "','" _
            '                        & par.PulisciStrSql(CType(TabGenerale.FindControl("txtNote"), TextBox).Text) & "')"


            'par.cmd.ExecuteNonQuery()




            'par.cmd.CommandText = "insert into SISCOM_MI.IMPIANTI (ID,COD_TIPOLOGIA) values (SISCOM_MI.SEQ_IMPIANTI.NEXTVAL,'TE')"
            'par.cmd.ExecuteNonQuery()

            'par.cmd.CommandText = " select SISCOM_MI.SEQ_IMPIANTI.NEXTVAL FROM dual "
            'Dim myReader1 As Data.OracleClient.OracleDataReader = par.cmd.ExecuteReader()
            'If myReader1.Read Then
            '    vIdImpianto = myReader1(0)
            'End If
            'myReader1.Close()

            '*** APERTURA TRANSAZIONE
            par.myTrans = par.OracleConn.BeginTransaction(System.Data.IsolationLevel.Unspecified)
            par.cmd.Transaction = par.myTrans
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)

            Session.Add("LAVORAZIONE", "1")

        Catch ex As Exception
            par.myTrans.Rollback()
            par.OracleConn = CType(HttpContext.Current.Session.Item(lIdConnessione), Data.OracleClient.OracleConnection)
            par.OracleConn.Close()
            HttpContext.Current.Session.Remove(lIdConnessione)
            Data.OracleClient.OracleConnection.ClearAllPools()
            Page.Dispose()

            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try

    End Sub

    Private Sub VisualizzaDati()
        Dim scriptblock As String
        'Dim StringaSql As String
        Dim myReader1 As Data.OracleClient.OracleDataReader
        Dim myReader2 As Data.OracleClient.OracleDataReader

        'Dim dlist As CheckBoxList
        Dim ds As New Data.DataSet()
        'Dim da As Data.OracleClient.OracleDataAdapter
        Dim i, j As Integer
        Dim SommaMQ As Double
        Dim SommaUI As Integer

        'Apro la CONNESSIONE con il DB



        Try

            par.OracleConn = CType(HttpContext.Current.Session.Item("CONNESSIONE" & lIdConnessione), Data.OracleClient.OracleConnection)
            par.cmd = par.OracleConn.CreateCommand()

            If vIdImpianto <> 0 Then
                ' LEGGO IMP_TERMICI


                par.cmd.CommandText = "select * from SISCOM_MI.IMPIANTI where SISCOM_MI.IMPIANTI.ID = " & vIdImpianto & " FOR UPDATE NOWAIT"
                myReader1 = par.cmd.ExecuteReader()

                If myReader1.Read Then

                    '*** FORM PRINCIPALE
                    Me.txtIdImpianto.Text = par.IfNull(myReader1("ID"), "-1")

                    Me.cmbComplesso.SelectedValue = par.IfNull(myReader1("ID_COMPLESSO"), "-1")
                    FiltraEdifici()

                    Me.DrLEdificio.SelectedValue = par.IfNull(myReader1("ID_EDIFICIO"), "-1")

                    Me.txtDenominazione.Text = par.IfNull(myReader1("DESCRIZIONE"), "")
                    Me.txtCodImpianto.Text = par.IfNull(myReader1("COD_IMPIANTO"), "")

                    Me.txtDitta.Text = par.IfNull(myReader1("DITTA_COSTRUTTRICE"), "")
                    Me.txtAnnoRealizzazione.Text = par.FormattaData(par.IfNull(myReader1("ANNO_COSTRUZIONE"), ""))


                    par.cmd.CommandText = "select * from SISCOM_MI.I_TERMICI where SISCOM_MI.I_TERMICI.ID = " & vIdImpianto '& " FOR UPDATE NOWAIT"
                    myReader2 = par.cmd.ExecuteReader()

                    If myReader2.Read Then

                        '*** FORM PRINCIPALE
                        Me.cmbTipoUso.SelectedValue = par.IfNull(myReader2("ID_TIPOLOGIA_USO"), "")

                        '*** TAB GENERALE
                        CType(TabGenerale.FindControl("txtDittaGestione"), TextBox).Text = par.IfNull(myReader2("DITTA_GESTIONE"), "")
                        CType(TabGenerale.FindControl("txtNumTelefonico"), TextBox).Text = par.IfNull(myReader2("TELEFONO_DITTA"), "")
                        CType(TabGenerale.FindControl("txtDataAccensione"), TextBox).Text = par.FormattaData(par.IfNull(myReader2("DATA_PRIMA_ACCENSIONE"), ""))
                        CType(TabGenerale.FindControl("txtDataRiposo"), TextBox).Text = par.FormattaData(par.IfNull(myReader2("DATA_MESSA_RIPOSO"), ""))
                        CType(TabGenerale.FindControl("txtOreEsercizio"), TextBox).Text = par.IfNull(myReader2("NUM_ORE_ESERCIZIO"), "")

                        'CType(TabGenerale.FindControl("RBList_Tipologia"), RadioButtonList).SelectedValue = par.IfNull(myReader2("COD_TIPOLOGIA"), "")
                        CType(TabGenerale.FindControl("cmbCombustibile"), DropDownList).SelectedValue = par.IfNull(myReader2("ID_COMBUSTIBILE"), -1)
                        CType(TabGenerale.FindControl("cmbTipoSerbatoio"), DropDownList).SelectedValue = par.IfNull(myReader2("SERBATOIO"), "")

                        CType(TabGenerale.FindControl("txtCapacita"), TextBox).Text = par.IfNull(myReader2("CAPACITA"), "")
                        CType(TabGenerale.FindControl("txtPotenza"), TextBox).Text = par.IfNull(myReader2("POTENZA"), "")
                        CType(TabGenerale.FindControl("txtConsumo"), TextBox).Text = par.IfNull(myReader2("CONSUMO_MEDIO"), "")

                        CType(TabGenerale.FindControl("txtNote"), TextBox).Text = par.IfNull(myReader1("ANNOTAZIONI"), "")


                        '*** TAB CERTIFICAZIONI
                        CType(Tab_Termico_Certificazioni.FindControl("cmbLibretto"), DropDownList).Items.FindByValue(par.IfNull(myReader2("LIBRETTO"), "")).Selected = True
                        'CType(TabGenerale.FindControl("cmbExUNI"), DropDownList).Items.FindByValue(par.IfNull(myReader2("CERT_EX_UNI_8364"), "")).Selected = True
                        CType(Tab_Termico_Certificazioni.FindControl("cmbConformita"), DropDownList).Items.FindByValue(par.IfNull(myReader2("DICH_CONF_LG_46_90"), "")).Selected = True
                        CType(Tab_Termico_Certificazioni.FindControl("cmbDecreto"), DropDownList).Items.FindByValue(par.IfNull(myReader2("DECR_PREFETTIZIO_SERBATOI"), "")).Selected = True
                        CType(Tab_Termico_Certificazioni.FindControl("cmbLicenzaUTF"), DropDownList).Items.FindByValue(par.IfNull(myReader2("LICENZA_UTF"), "")).Selected = True
                        CType(Tab_Termico_Certificazioni.FindControl("cmbISPESL"), DropDownList).Items.FindByValue(par.IfNull(myReader2("PRATICA_ISPESL"), "")).Selected = True
                        CType(Tab_Termico_Certificazioni.FindControl("cmbTrattamentoAcqua"), DropDownList).Items.FindByValue(par.IfNull(myReader2("TRATTAMENTO_ACQUA"), "")).Selected = True
                        CType(Tab_Termico_Certificazioni.FindControl("cmbContEnergia"), DropDownList).Items.FindByValue(par.IfNull(myReader2("CONT_ENERGIA"), "")).Selected = True
                        'CType(TabGenerale.FindControl("cmbDenuncia"), DropDownList).Items.FindByValue(par.IfNull(myReader2("DENUNCIA_IMPIANTO"), "")).Selected = True
                        CType(Tab_Termico_Certificazioni.FindControl("txtDataISPESL"), TextBox).Text = par.FormattaData(par.IfNull(myReader2("DATA_PRATICA_ISPESL"), ""))
                        CType(Tab_Termico_Certificazioni.FindControl("txtDataCT"), TextBox).Text = par.FormattaData(par.IfNull(myReader2("DATA_DISMISSIONE_CT"), ""))



                    End If
                    myReader2.Close()

                    'Me.cmbStatoEfficienza.SelectedValue = par.IfNull(myReader1("COD_STATO_CONSERVAZIONE"), "-1")

                    'CType(TabGenerale.FindControl("cmbConformita"), DropDownList).SelectedIndex = -1

                    'CType(TabGenerale.FindControl("cmbOmologazione"), DropDownList).SelectedIndex = -1
                    'CType(TabGenerale.FindControl("cmbOmologazione"), DropDownList).Items.FindByValue(par.IfNull(myReader1("OMOLOGAZIONI"), "")).Selected = True



                    'Select Case par.IfNull(myReader1("CERTIFICATI_CONFORMITA"), "")
                    '    Case "S"
                    '        CType(TabGenerale.FindControl("cmbConformita"), DropDownList).Items.FindByValue(par.IfNull(myReader1("CERTIFICATI_CONFORMITA"), "")).Selected = True
                    '    Case "N"
                    '        CType(TabGenerale.FindControl("cmbConformita"), DropDownList).Items.FindByValue("N").Selected = True
                    '    Case Else
                    '        CType(TabGenerale.FindControl("cmbConformita"), DropDownList).Items.FindByValue("").Selected = True
                    'End Select

                    'CType(TabGenerale.FindControl("cmbTabRagg"), DropDownList).SelectedIndex = -1
                    'CType(TabGenerale.FindControl("cmbTabRagg"), DropDownList).Items.FindByValue(par.IfNull(myReader1("CERTIFICAZIONE"), "")).Selected = True




                    '                    Response.Write("<script>window.open('ListaUtenze.aspx?ID=" & vIdComplesso & ",&Pas=COMP','UTENZA', 'resizable=no, width=630, height=280');</script>")

                    'StringaSql = "select SISCOM_MI.IMP_TERMICI_COMP.ID,SISCOM_MI.TIPO_TERMICI_COMP.DESCRIZIONE AS ""TIPO_COMPONENTE""," _
                    '            & "SISCOM_MI.IMP_TERMICI_COMP.DENOMINAZIONE,SISCOM_MI.IMP_TERMICI_COMP.DESCRIZIONE," _
                    '               & "SISCOM_MI.T_STATI_EFFICIENZA.DESCRIZIONE AS ""STATO_EFFICIENZA""" _
                    '      & " from SISCOM_MI.IMP_TERMICI_COMP, SISCOM_MI.TIPO_TERMICI_COMP, SISCOM_MI.T_STATI_EFFICIENZA " _
                    '      & " where SISCOM_MI.IMP_TERMICI_COMP.ID_IMPIANTO = " & vIdImpianto & " and " _
                    '      & "       SISCOM_MI.TIPO_TERMICI_COMP.ID=SISCOM_MI.IMP_TERMICI_COMP.ID_TIPO  and " _
                    '      & "       SISCOM_MI.T_STATI_EFFICIENZA.ID = SISCOM_MI.IMP_TERMICI_COMP.ID_STATO_EFFICIENZA" _
                    '      & " order by SISCOM_MI.IMP_TERMICI_COMP.ID_TIPO,SISCOM_MI.IMP_TERMICI_COMP.DENOMINAZIONE "

                    ''Passo il risultato della select alla DropDownList impostando Indice e Testo associato
                    'Dim da As New Data.OracleClient.OracleDataAdapter(StringaSql, par.OracleConn)

                    'Dim ds As New Data.DataSet()
                    'da.Fill((ds), "IMP_TERMICI_COMP")

                    'CType(TabDettagli1.FindControl("DataGrid1"), DataGrid).DataSource = ds
                    'CType(TabDettagli1.FindControl("DataGrid1"), DataGrid).DataBind()

                    '***************

                    'StringaSql = "select SISCOM_MI.IMP_TERMICI_COMP.ID,SISCOM_MI.TIPO_TERMICI_COMP.DESCRIZIONE AS ""TIPO_COMPONENTE""," _
                    '            & "SISCOM_MI.IMP_TERMICI_COMP.DENOMINAZIONE,SISCOM_MI.IMP_TERMICI_COMP.DESCRIZIONE," _
                    '               & "SISCOM_MI.T_STATI_EFFICIENZA.DESCRIZIONE AS ""STATO_EFFICIENZA""" _
                    '      & " from SISCOM_MI.IMP_TERMICI_COMP, SISCOM_MI.TIPO_TERMICI_COMP, SISCOM_MI.T_STATI_EFFICIENZA " _
                    '      & " where SISCOM_MI.IMP_TERMICI_COMP.ID_IMPIANTO = " & vIdImpianto & " and " _
                    '      & "       SISCOM_MI.TIPO_TERMICI_COMP.ID=SISCOM_MI.IMP_TERMICI_COMP.ID_TIPO  and " _
                    '      & "       SISCOM_MI.T_STATI_EFFICIENZA.ID = SISCOM_MI.IMP_TERMICI_COMP.ID_STATO_EFFICIENZA" _
                    '      & " order by SISCOM_MI.IMP_TERMICI_COMP.ID_TIPO,SISCOM_MI.IMP_TERMICI_COMP.DENOMINAZIONE "

                    'StringaSql = "select SISCOM_MI.BRUCIATORI.ID,SISCOM_MI.BRUCIATORI.MODELLO," _
                    '                    & "SISCOM_MI.BRUCIATORI.MATRICOLA,SISCOM_MI.BRUCIATORI.NOTE," _
                    '                    & "SISCOM_MI.BRUCIATORI.ANNO_COSTRUZIONE,SISCOM_MI.BRUCIATORI.CAMPO_FUNZIONAMENTO" _
                    '          & " from SISCOM_MI.BRUCIATORI " _
                    '          & " where SISCOM_MI.IMP_TERMICI_COMP.ID_IMPIANTO = " & vIdImpianto _
                    '          & " order by SISCOM_MI.BRUCIATORI.MODELLO "


                    'dlist = CType(TabGenerale.FindControl("CheckBoxEdifici"), CheckBoxList) 'CheckOperatori

                    'da = New Data.OracleClient.OracleDataAdapter(StringaSql, par.OracleConn)


                    'da.Fill(ds)

                    'dlist.Items.Clear()
                    'dlist.DataSource = ds
                    'dlist.DataTextField = "DESCRIZIONE"
                    'dlist.DataValueField = "ID"
                    'dlist.DataBind()

                    'da.Dispose()
                    'da = Nothing

                    'CType(TabGenerale.FindControl("CheckBoxEdifici"), CheckBoxList).Items.Add(New CheckBoxList()

                    '*** TAB GENERALE (EDIFICI)
                    Dim lstEdifici As System.Collections.Generic.List(Of CM.Edifici)
                    lstEdifici = CType(HttpContext.Current.Session.Item("LSTEDIFICI"), System.Collections.Generic.List(Of CM.Edifici))

                    SommaMQ = 0
                    SommaUI = 0

                    par.cmd.CommandText = "select SISCOM_MI.IMPIANTI_EDIFICI.ID_EDIFICIO from SISCOM_MI.IMPIANTI_EDIFICI where  SISCOM_MI.IMPIANTI_EDIFICI.ID_IMPIANTO = " & vIdImpianto

                    myReader2 = par.cmd.ExecuteReader()

                    '                    Dim myReader2 As Data.OracleClient.OracleDataReader = par.cmd.ExecuteReader()
                    While myReader2.Read
                        For i = 0 To CType(TabGenerale.FindControl("CheckBoxEdifici"), CheckBoxList).Items.Count - 1
                            If CType(TabGenerale.FindControl("CheckBoxEdifici"), CheckBoxList).Items(i).Value = par.IfNull(myReader2("ID_EDIFICIO"), "-1") Then
                                CType(TabGenerale.FindControl("CheckBoxEdifici"), CheckBoxList).Items(i).Selected = True

                                '************+
                                For j = 0 To lstEdifici.Count - 1

                                    If lstEdifici(j).ID = par.IfNull(myReader2("ID_EDIFICIO"), "-1") Then
                                        SommaMQ = SommaMQ + lstEdifici(j).DIMENSIONE
                                        SommaUI = SommaUI + lstEdifici(j).TOT_UNITA
                                    End If

                                Next j
                                '********************************
                            End If
                        Next
                    End While
                    myReader2.Close()


                    '**IDINTERVENTO = par.IfNull(myReader1("ID_TIPO_INTERVENTO"), "-1")
                End If


                ' ''par.cmd.CommandText = "SELECT INDIRIZZI.DESCRIZIONE AS INDIRIZZO, INDIRIZZI.CIVICO, INDIRIZZI.CAP, INDIRIZZI.LOCALITA FROM SISCOM_MI.COMPLESSI_IMMOBILIARI, SISCOM_MI.INDIRIZZI WHERE COMPLESSI_IMMOBILIARI.ID = " & Me.cmbComplesso.SelectedValue.ToString & " AND COMPLESSI_IMMOBILIARI.ID_INDIRIZZO_RIFERIMENTO = INDIRIZZI.ID"
                ' ''myReader1 = par.cmd.ExecuteReader()
                ' ''If myReader1.Read Then
                ' ''    Me.LblRiepilogo.Text = "COMPLESSO IMMOBILIARE SITO IN " & par.IfNull(myReader1("INDIRIZZO"), " - - ") & ", CIVICO " & par.IfNull(myReader1("CIVICO"), " - - ") & ", LOCALITA " & par.IfNull(myReader1("LOCALITA"), " - - ") & ", CAP " & par.IfNull(myReader1("CAP"), " - - ")
                ' ''End If


                myReader1.Close()


                CType(TabGenerale.FindControl("txtTotUI"), TextBox).Text = SommaUI
                CType(TabGenerale.FindControl("txtTotMq"), TextBox).Text = SommaMQ



                par.myTrans = par.OracleConn.BeginTransaction(System.Data.IsolationLevel.Unspecified)
                par.cmd.Transaction = par.myTrans
                HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)

                'par.OracleConn.Close()

                Session.Add("LAVORAZIONE", "1")

                ' ''    Filtrainterventi()
                ' ''    Me.cmbTipoIntervento.SelectedValue = IDINTERVENTO
                ' ''    Me.cmbUnitaImmob.Enabled = False
                ' ''    Me.cmbComplesso.Enabled = False
                ' ''    Me.DrLEdificio.Enabled = False
                ' ''    Me.cmbUnitaComune.Enabled = False
                ' ''    Me.LBLINSCOMP.Enabled = False
                ' ''    Me.LBLINSEDIFICIO.Enabled = False
                ' ''    Me.LblDenominazione.Enabled = False
                ' ''    Me.LBLINSUNIIMMOB.Enabled = False

            End If

        Catch EX1 As Data.OracleClient.OracleException
            If EX1.Code = 54 Then
                par.OracleConn.Close()
                scriptblock = "<script language='javascript' type='text/javascript'>" _
                & "alert('Impianto aperto da un altro utente. Non è possibile effettuare modifiche!');" _
                & "</script>"
                If (Not Page.ClientScript.IsClientScriptBlockRegistered("clientScript4")) Then
                    Page.ClientScript.RegisterClientScriptBlock(Me.GetType(), "clientScript4", scriptblock)
                End If
            Else
                'par.myTrans.Rollback()
                par.OracleConn.Close()

                Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & EX1.Message)
                Response.Write("<script>top.location.href='../Errore.aspx';</script>")
            End If

        Catch ex As Exception
            par.OracleConn.Close()
            Session.Item("LAVORAZIONE") = "0"

            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Sub


    Protected Sub btnSalva_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs) Handles btnSalva.Click

        If ControlloCampi() = False Then
            Exit Sub
        End If

        If vIdImpianto = 0 Then
            Me.Salva()
        Else
            Me.Update()
        End If

    End Sub

    Public Function ControlloCampi() As Boolean

        ControlloCampi = True

        If Me.cmbComplesso.SelectedValue = -1 Then
            Response.Write("<script>alert('Selezionare un Complesso Immobiliare!');</script>")
            ControlloCampi = False
            Exit Function
        End If

        If par.IfEmpty(Me.txtDenominazione.Text, "Null") = "Null" Then
            Response.Write("<script>alert('Inserire la Denominazione Impianto!');</script>")
            ControlloCampi = False
            txtDenominazione.Focus()
            Exit Function
        End If

        If par.IfEmpty(Me.cmbTipoUso.Text, "Null") = "Null" Then
            Response.Write("<script>alert('Selezionare la tipologia d\'uso dell\'impianto!');</script>")
            ControlloCampi = False
            Exit Function
        End If

        If Me.txtAnnoRealizzazione.Text = "dd/mm/YYYY" Then
            Me.txtAnnoRealizzazione.Text = ""

        End If

        If CType(Tab_Termico_Certificazioni.FindControl("txtDataISPESL"), TextBox).Text = "dd/mm/YYYY" Then
            CType(Tab_Termico_Certificazioni.FindControl("txtDataISPESL"), TextBox).Text = ""
        End If

    End Function

    Private Sub Salva()

        Try

            ' RIPRENDO LA CONNESSIONE
            par.OracleConn = CType(HttpContext.Current.Session.Item("CONNESSIONE" & lIdConnessione), Data.OracleClient.OracleConnection)
            par.cmd = par.OracleConn.CreateCommand()

            'RIPRENDO LA TRANSAZIONE
            'par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Data.OracleClient.OracleTransaction)
            'par.cmd.Transaction = par.myTrans

            par.myTrans = par.OracleConn.BeginTransaction(System.Data.IsolationLevel.Unspecified)
            par.cmd.Transaction = par.myTrans
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)


            ' '' Ricavo vIdImpianto
            par.cmd.CommandText = " select SISCOM_MI.SEQ_IMPIANTI.NEXTVAL FROM dual "
            Dim myReader1 As Data.OracleClient.OracleDataReader = par.cmd.ExecuteReader()
            If myReader1.Read Then
                vIdImpianto = myReader1(0)
            End If

            myReader1.Close()
            par.cmd.CommandText = ""

            Me.txtIdImpianto.Text = vIdImpianto


            ', TIPOLOGIA_USO, COD_STATO_CONSERVAZIONE, " _"
            '& ",,COMBUSTIBILE,SERBATOIO,CAPACITA,CERTIFICATI_CONFORMITA,CERTIFICAZIONE,OMOLOGAZIONI,COLLAUDO) " _

            '***par.PulisciStrSql(Me.cmbTipoUso.Text) *** & Me.cmbStatoEfficienza.SelectedValue.ToString
            '&  & ",'" & par.PulisciStrSql(CType(TabGenerale.FindControl("txtCombustibile"), TextBox).Text) & "','" _
            '& par.PulisciStrSql(CType(TabGenerale.FindControl("cmbTipoSerbatoio"), DropDownList).SelectedItem.Text) & "'," & par.VirgoleInPunti(par.IfEmpty(CType(TabGenerale.FindControl("txtCapacita"), TextBox).Text, "Null")) & "," _
            '& par.VirgoleInPunti(par.IfEmpty(CType(TabGenerale.FindControl("txtNumRadianti"), TextBox).Text, "Null")) & ",'" & CType(TabGenerale.FindControl("cmbConformita"), DropDownList).SelectedValue.ToString & "','" & CType(TabGenerale.FindControl("cmbTabRagg"), DropDownList).SelectedValue.ToString & "','" _
            '& CType(TabGenerale.FindControl("cmbOmologazione"), DropDownList).SelectedValue.ToString & "'," & par.AggiustaData(CType(TabGenerale.FindControl("txtDataUTOV"), TextBox).Text) & "," _

            par.cmd.Parameters.Clear()

            'par.cmd.CommandText = "insert into SISCOM_MI.IMPIANTI (ID, ID_COMPLESSO, ID_EDIFICIO,COD_TIPOLOGIA,DESCRIZIONE,ANNO_COSTRUZIONE,DITTA_COSTRUTTRICE,ANNOTAZIONI) " _
            '                    & "values (" & vIdImpianto & "," & Me.cmbComplesso.SelectedValue.ToString & "," & RitornaNullSeMenoUno(Me.DrLEdificio.SelectedValue.ToString) & ",'TE','" _
            '                        & par.PulisciStrSql(Me.txtDenominazione.Text) & "','" & par.AggiustaData(txtAnnoRealizzazione.Text) & "','" _
            '                        & par.PulisciStrSql(txtDitta.Text) & "','" _
            '                        & par.PulisciStrSql(CType(TabGenerale.FindControl("txtNote"), TextBox).Text) & "')"


            par.cmd.CommandText = "insert into SISCOM_MI.IMPIANTI (ID, ID_COMPLESSO, ID_EDIFICIO,COD_TIPOLOGIA,DESCRIZIONE,ANNO_COSTRUZIONE,DITTA_COSTRUTTRICE,ANNOTAZIONI) " _
                                & "values (:id,:id_complesso,:id_edificio,:cod_tipologia,:descrizione,:anno,:ditta,:annotazioni)"

            par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("id", vIdImpianto))
            par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("id_complesso", Convert.ToInt32(Me.cmbComplesso.SelectedValue)))
            par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("id_edificio", RitornaNullSeIntegerMenoUno(Convert.ToInt32(Me.DrLEdificio.SelectedValue))))
            par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("cod_tipologia", "TE"))
            par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("descrizione", Strings.Left(Me.txtDenominazione.Text, 500)))
            par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("anno", par.AggiustaData(txtAnnoRealizzazione.Text)))
            par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("ditta", Strings.Left(txtDitta.Text, 100)))
            par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("annotazioni", Strings.Left(CType(TabGenerale.FindControl("txtNote"), TextBox).Text, 4000)))


            par.cmd.ExecuteNonQuery()
            par.cmd.Parameters.Clear()


            '' COMMIT
            'par.myTrans.Commit()
            'par.myTrans = par.OracleConn.BeginTransaction(System.Data.IsolationLevel.Unspecified)
            'HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)

            'COD_TIPOLOGIA = CType(TabGenerale.FindControl("RBList_Tipologia"), RadioButtonList).SelectedValue.ToString
            par.cmd.CommandText = "insert into SISCOM_MI.I_TERMICI (ID,ID_TIPOLOGIA_USO, ID_COMBUSTIBILE,SERBATOIO,CAPACITA," _
                                                                & "POTENZA,CONSUMO_MEDIO,LIBRETTO,DICH_CONF_LG_46_90,DECR_PREFETTIZIO_SERBATOI," _
                                                                & "LICENZA_UTF,PRATICA_ISPESL,TRATTAMENTO_ACQUA,CONT_ENERGIA,DATA_PRATICA_ISPESL," _
                                                                & "DATA_MESSA_RIPOSO,DITTA_GESTIONE,NUM_ORE_ESERCIZIO,DATA_PRIMA_ACCENSIONE,TELEFONO_DITTA,DATA_DISMISSIONE_CT) " _
                                 & "values (" & vIdImpianto & "," _
                                 & RitornaNullSeMenoUno(Me.cmbTipoUso.SelectedValue.ToString) & "," & RitornaNullSeMenoUno((CType(TabGenerale.FindControl("cmbCombustibile"), DropDownList).SelectedValue.ToString)) & ",'" _
                                 & par.PulisciStrSql(CType(TabGenerale.FindControl("cmbTipoSerbatoio"), DropDownList).SelectedItem.Text) & "'," _
                                 & par.VirgoleInPunti(par.IfEmpty(CType(TabGenerale.FindControl("txtCapacita"), TextBox).Text, "Null")) & "," _
                                 & par.VirgoleInPunti(par.IfEmpty(CType(TabGenerale.FindControl("txtPotenza"), TextBox).Text, "Null")) & "," _
                                 & par.VirgoleInPunti(par.IfEmpty(CType(TabGenerale.FindControl("txtConsumo"), TextBox).Text, "Null")) & ",'" _
                                 & CType(Tab_Termico_Certificazioni.FindControl("cmbLibretto"), DropDownList).SelectedValue.ToString & "','" _
                                 & CType(Tab_Termico_Certificazioni.FindControl("cmbConformita"), DropDownList).SelectedValue.ToString & "','" _
                                 & CType(Tab_Termico_Certificazioni.FindControl("cmbDecreto"), DropDownList).SelectedValue.ToString & "','" _
                                 & CType(Tab_Termico_Certificazioni.FindControl("cmbLicenzaUTF"), DropDownList).SelectedValue.ToString & "','" _
                                 & CType(Tab_Termico_Certificazioni.FindControl("cmbISPESL"), DropDownList).SelectedValue.ToString & "','" _
                                 & CType(Tab_Termico_Certificazioni.FindControl("cmbTrattamentoAcqua"), DropDownList).SelectedValue.ToString & "','" _
                                 & CType(Tab_Termico_Certificazioni.FindControl("cmbContEnergia"), DropDownList).SelectedValue.ToString & "','" _
                                 & par.AggiustaData(CType(Tab_Termico_Certificazioni.FindControl("txtDataISPESL"), TextBox).Text) & "','" _
                                 & par.AggiustaData(CType(TabGenerale.FindControl("txtDataRiposo"), TextBox).Text) & "','" _
                                 & par.PulisciStrSql(CType(TabGenerale.FindControl("txtDittaGestione"), TextBox).Text) & "'," _
                                 & par.IfEmpty(CType(TabGenerale.FindControl("txtOreEsercizio"), TextBox).Text, "Null") & ",'" _
                                 & par.AggiustaData(CType(TabGenerale.FindControl("txtDataAccensione"), TextBox).Text) & "','" _
                                 & par.PulisciStrSql(CType(TabGenerale.FindControl("txtNumTelefonico"), TextBox).Text) & "','" _
                                 & par.AggiustaData(CType(Tab_Termico_Certificazioni.FindControl("txtDataCT"), TextBox).Text) & "')"

            'DENUNCIA_IMPIANTO CType(TabGenerale.FindControl("cmbDenuncia"), DropDownList).SelectedValue.ToString
            'CERT_EX_UNI_8364  CType(TabGenerale.FindControl("cmbExUNI"), DropDownList).SelectedValue.ToString & "','" 


            par.cmd.ExecuteNonQuery()

            AggiornaImpiantiEdifici()


            '*** INSERIMENTO GENERATORI
            Dim lstGeneratori As System.Collections.Generic.List(Of CM.Generatori)

            lstGeneratori = CType(HttpContext.Current.Session.Item("LSTGENERATORI"), System.Collections.Generic.List(Of CM.Generatori))

            For Each gen As CM.Generatori In lstGeneratori

                par.cmd.CommandText = "insert into SISCOM_MI.GENERATORI_TERMICI (ID, ID_IMPIANTO,MODELLO,MATRICOLA,ANNO_COSTRUZIONE,POTENZA,NOTE,FLUIDO_TERMOVETTORE,MARC_EFF_ENERGETICA) " _
                                    & "values (SISCOM_MI.SEQ_GENERATORI_TERMICI.NEXTVAL," & vIdImpianto & ",'" & par.PulisciStrSql(gen.MODELLO) & "',' " _
                                        & par.PulisciStrSql(gen.MATRICOLA) & "','" & gen.ANNO_COSTRUZIONE & "'," _
                                        & par.VirgoleInPunti(par.IfEmpty(gen.POTENZA, "Null")) & ",'" & Strings.Left(par.PulisciStrSql(gen.NOTE), 300) & "','" _
                                        & par.PulisciStrSql(gen.FLUIDO_TERMOVETTORE) & "','" & gen.MARC_EFF_ENERGETICA & "')"

                par.cmd.ExecuteNonQuery()
                par.cmd.CommandText = ""
            Next
            '********************************


            '*** INSERIMENTO BRUCIATORI
            Dim lstBruciatori As System.Collections.Generic.List(Of CM.Bruciatori)

            lstBruciatori = CType(HttpContext.Current.Session.Item("LSTBRUCIATORI"), System.Collections.Generic.List(Of CM.Bruciatori))

            For Each gen As CM.Bruciatori In lstBruciatori

                par.cmd.CommandText = "insert into SISCOM_MI.BRUCIATORI (ID, ID_IMPIANTO,MODELLO,MATRICOLA,ANNO_COSTRUZIONE,CAMPO_FUNZIONAMENTO,NOTE) " _
                                    & "values (SISCOM_MI.SEQ_BRUCIATORI.NEXTVAL," & vIdImpianto & ",'" & par.PulisciStrSql(gen.MODELLO) & "',' " _
                                        & par.PulisciStrSql(gen.MATRICOLA) & "','" & gen.ANNO_COSTRUZIONE & "'," _
                                        & par.VirgoleInPunti(par.IfEmpty(gen.CAMPO_FUNZIONAMENTO, "Null")) & ",'" & Strings.Left(par.PulisciStrSql(gen.NOTE), 300) & "')"

                par.cmd.ExecuteNonQuery()
                par.cmd.CommandText = ""
            Next
            '********************************


            '*** INSERIMENTO BRUCIATORI
            Dim lstPompe As System.Collections.Generic.List(Of CM.Pompe)

            lstPompe = CType(HttpContext.Current.Session.Item("LSTPOMPE"), System.Collections.Generic.List(Of CM.Pompe))

            For Each gen As CM.Pompe In lstPompe

                par.cmd.CommandText = "insert into SISCOM_MI.POMPE_CIRCOLAZIONE_TERMICI (ID, ID_IMPIANTO,MODELLO,MATRICOLA,ANNO_COSTRUZIONE,POTENZA,NOTE) " _
                                    & "values (SISCOM_MI.SEQ_POMPE_CIRCOLAZIONE_TERMICI.NEXTVAL," & vIdImpianto & ",'" & par.PulisciStrSql(gen.MODELLO) & "',' " _
                                        & par.PulisciStrSql(gen.MATRICOLA) & "','" & gen.ANNO_COSTRUZIONE & "'," _
                                        & par.VirgoleInPunti(par.IfEmpty(gen.POTENZA, "Null")) & ",'" & Strings.Left(par.PulisciStrSql(gen.NOTE), 300) & "')"

                par.cmd.ExecuteNonQuery()
                par.cmd.CommandText = ""
            Next
            '********************************

            '*** INSERIMENTO CONTROLLO DEL RENDIMENTO DU COMBUSTIONE
            Dim lstControlloRendimento As System.Collections.Generic.List(Of CM.ControlloRendimento)

            lstControlloRendimento = CType(HttpContext.Current.Session.Item("LSTCONTROLLORENDIMENTO"), System.Collections.Generic.List(Of CM.ControlloRendimento))

            For Each gen As CM.ControlloRendimento In lstControlloRendimento
                par.cmd.Parameters.Clear()

                'par.cmd.CommandText = " select SISCOM_MI.SEQ_RENDIMENTO_I_TERMICI.NEXTVAL FROM dual "
                'Dim myReaderRend As Data.OracleClient.OracleDataReader = par.cmd.ExecuteReader()
                'If myReaderRend.Read Then
                '    vIdREND = myReaderRend(0)
                'End If
                'myReaderRend.Close()


                par.cmd.CommandText = "insert into SISCOM_MI.RENDIMENTO_I_TERMICI (ID,ID_IMPIANTO,TEMP_FUMI,TEMP_AMB,O2,CO2," _
                                                                    & "BACHARACH,CO,RENDIMENTO,TIRAGGIO,DATA_ESAME,ESECUTORE) " _
                                & " values (SISCOM_MI.SEQ_RENDIMENTO_I_TERMICI.NEXTVAL,:id_impianto,:tempi_fumi,:tempi_amb,:o2,:co2,:bacharach,:co," _
                                         & ":rendimento,:tiraggio,:data_esame,:esecutore)"

                'par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("id", vIdREND)) ' "SISCOM_MI.SEQ_RENDIMENTO_I_TERMICI.NEXTVAL"))
                par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("id_impianto", vIdImpianto))
                par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("tempi_fumi", strToNumber(gen.TEMP_FUMI)))
                par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("tempi_amb", strToNumber(gen.TEMP_AMB)))
                par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("o2", strToNumber(gen.O2)))
                par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("co2", strToNumber(gen.CO2)))
                par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("bacharach", strToNumber(gen.BACHARACH)))
                par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("co", strToNumber(gen.CO)))
                par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("rendimento", strToNumber(gen.RENDIMENTO)))
                par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("tiraggio", strToNumber(gen.TIRAGGIO)))
                par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("data_esame", par.AggiustaData(gen.DATA_ESAME)))
                par.cmd.Parameters.Add(New System.Data.OracleClient.OracleParameter("esecutore", Strings.Left(gen.ESECUTORE, 100)))



                par.cmd.ExecuteNonQuery()
                par.cmd.CommandText = ""
                par.cmd.Parameters.Clear()
            Next
            '**********************




            ' COMMIT
            par.myTrans.Commit()


            '*** AGGIORNO il COD. IMPIANTO
            par.cmd.CommandText = "select COD_IMPIANTO from SISCOM_MI.IMPIANTI where SISCOM_MI.IMPIANTI.ID = " & vIdImpianto
            Dim myReader2 As Data.OracleClient.OracleDataReader = par.cmd.ExecuteReader()
            If myReader2.Read Then
                Me.txtCodImpianto.Text = myReader2(0)
            End If

            myReader2.Close()
            par.cmd.CommandText = ""


            '**** AGGIORNO I COMPONENTI

            'Passo il risultato della select alla DropDownList impostando Indice e Testo associato

            '*** BRUCIATORI
            par.cmd.CommandText = "select SISCOM_MI.BRUCIATORI.ID,SISCOM_MI.BRUCIATORI.MODELLO," _
                        & "SISCOM_MI.BRUCIATORI.MATRICOLA,SISCOM_MI.BRUCIATORI.NOTE," _
                           & "SISCOM_MI.BRUCIATORI.ANNO_COSTRUZIONE,SISCOM_MI.BRUCIATORI.CAMPO_FUNZIONAMENTO" _
                  & " from SISCOM_MI.BRUCIATORI " _
                  & " where SISCOM_MI.BRUCIATORI.ID_IMPIANTO = " & vIdImpianto _
                  & " order by SISCOM_MI.BRUCIATORI.MODELLO "

            Dim da1 As New Data.OracleClient.OracleDataAdapter(par.cmd)
            Dim ds1 As New Data.DataSet()

            da1.Fill(ds1, "BRUCIATORI")

            CType(TabDettagli1.FindControl("DataGrid1"), DataGrid).DataSource = ds1
            CType(TabDettagli1.FindControl("DataGrid1"), DataGrid).DataBind()
            ds1.Dispose()


            '*** GENERATORI
            par.cmd.CommandText = "select SISCOM_MI.GENERATORI_TERMICI.ID,SISCOM_MI.GENERATORI_TERMICI.MODELLO," _
                        & "SISCOM_MI.GENERATORI_TERMICI.MATRICOLA,SISCOM_MI.GENERATORI_TERMICI.NOTE," _
                           & "SISCOM_MI.GENERATORI_TERMICI.ANNO_COSTRUZIONE,SISCOM_MI.GENERATORI_TERMICI.POTENZA,SISCOM_MI.GENERATORI_TERMICI.MARC_EFF_ENERGETICA,SISCOM_MI.GENERATORI_TERMICI.FLUIDO_TERMOVETTORE " _
                  & " from SISCOM_MI.GENERATORI_TERMICI " _
                  & " where SISCOM_MI.GENERATORI_TERMICI.ID_IMPIANTO = " & vIdImpianto _
                  & " order by SISCOM_MI.GENERATORI_TERMICI.MODELLO "

            Dim da2 As New Data.OracleClient.OracleDataAdapter(par.cmd)
            Dim ds2 As New Data.DataSet()

            da2.Fill(ds2, "GENERATORI_TERMICI")

            CType(TabDettagli1.FindControl("DataGrid2"), DataGrid).DataSource = ds2
            CType(TabDettagli1.FindControl("DataGrid2"), DataGrid).DataBind()
            ds2.Dispose()


            '*** POMPE
            par.cmd.CommandText = "select SISCOM_MI.POMPE_CIRCOLAZIONE_TERMICI.ID,SISCOM_MI.POMPE_CIRCOLAZIONE_TERMICI.MODELLO," _
                        & "SISCOM_MI.POMPE_CIRCOLAZIONE_TERMICI.MATRICOLA,SISCOM_MI.POMPE_CIRCOLAZIONE_TERMICI.NOTE," _
                           & "SISCOM_MI.POMPE_CIRCOLAZIONE_TERMICI.ANNO_COSTRUZIONE,SISCOM_MI.POMPE_CIRCOLAZIONE_TERMICI.POTENZA " _
                  & " from SISCOM_MI.POMPE_CIRCOLAZIONE_TERMICI " _
                  & " where SISCOM_MI.POMPE_CIRCOLAZIONE_TERMICI.ID_IMPIANTO = " & vIdImpianto _
                  & " order by SISCOM_MI.POMPE_CIRCOLAZIONE_TERMICI.MODELLO "

            Dim da3 As New Data.OracleClient.OracleDataAdapter(par.cmd)
            Dim ds3 As New Data.DataSet()

            da3.Fill(ds3, "POMPE_CIRCOLAZIONE_TERMICI")

            CType(TabDettagli1.FindControl("DataGrid3"), DataGrid).DataSource = ds3
            CType(TabDettagli1.FindControl("DataGrid3"), DataGrid).DataBind()
            ds3.Dispose()
            '*******************************



            '*** CONTROLLO DEL RENDIMENTO DU COMBUSTIONE
            par.cmd.CommandText = "select SISCOM_MI.RENDIMENTO_I_TERMICI.ID,SISCOM_MI.RENDIMENTO_I_TERMICI.DATA_ESAME," _
                        & "SISCOM_MI.RENDIMENTO_I_TERMICI.ESECUTORE,SISCOM_MI.RENDIMENTO_I_TERMICI.TEMP_FUMI," _
                           & "SISCOM_MI.RENDIMENTO_I_TERMICI.TEMP_AMB,SISCOM_MI.RENDIMENTO_I_TERMICI.O2," _
                           & "SISCOM_MI.RENDIMENTO_I_TERMICI.CO2,SISCOM_MI.RENDIMENTO_I_TERMICI.BACHARACH," _
                           & "SISCOM_MI.RENDIMENTO_I_TERMICI.CO,SISCOM_MI.RENDIMENTO_I_TERMICI.RENDIMENTO," _
                           & "SISCOM_MI.RENDIMENTO_I_TERMICI.TIRAGGIO " _
                  & " from SISCOM_MI.RENDIMENTO_I_TERMICI " _
                  & " where SISCOM_MI.RENDIMENTO_I_TERMICI.ID_IMPIANTO = " & vIdImpianto _
                  & " order by SISCOM_MI.RENDIMENTO_I_TERMICI.DATA_ESAME "

            Dim da4 As New Data.OracleClient.OracleDataAdapter(par.cmd)
            Dim ds4 As New Data.DataSet()

            da4.Fill(ds4, "RENDIMENTO_I_TERMICI")

            CType(Tab_Termico_Rendimento.FindControl("DataGrid1"), DataGrid).DataSource = ds4
            CType(Tab_Termico_Rendimento.FindControl("DataGrid1"), DataGrid).DataBind()
            ds4.Dispose()
            '*******************************


            par.myTrans = par.OracleConn.BeginTransaction(System.Data.IsolationLevel.Unspecified)
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)

            Response.Write("<SCRIPT>alert('Operazione completata correttamente!');</SCRIPT>")
            'VisualizzaDati()

            CType(Me.Page.FindControl("USCITA"), TextBox).Text = "0"
            txtModificato.Text = "0"


            ' ''    Me.LBLINSCOMP.Enabled = False
            ' ''    Me.LBLINSEDIFICIO.Enabled = False
            ' ''    Me.LblDenominazione.Enabled = False
            ' ''    Me.LBLINSUNIIMMOB.Enabled = False
            ' ''    Me.cmbComplesso.Enabled = False
            ' ''    Me.DrLEdificio.Enabled = False
            ' ''    Me.cmbUnitaImmob.Enabled = False
            ' ''    Me.cmbUnitaComune.Enabled = False
            ' ''Else
            ' ''    Response.Write("<SCRIPT>alert('Il campo COSTO deve essere avvalorato!');</SCRIPT>")

            ' ''End If


        Catch ex As Exception
            par.myTrans.Rollback()
            par.OracleConn.Close()

            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")

        End Try
    End Sub

    Private Sub Update()

        Try

            ' RIPRENDO LA CONNESSIONE
            par.OracleConn = CType(HttpContext.Current.Session.Item("CONNESSIONE" & lIdConnessione), Data.OracleClient.OracleConnection)
            par.cmd = par.OracleConn.CreateCommand()

            'RIPRENDO LA TRANSAZIONE
            par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Data.OracleClient.OracleTransaction)
            par.cmd.Transaction = par.myTrans

            '& " COMBUSTIBILE='" & par.PulisciStrSql(CType(TabGenerale.FindControl("txtCombustibile"), TextBox).Text) & "'," _
            '& " SERBATOIO='" & par.PulisciStrSql(CType(TabGenerale.FindControl("cmbTipoSerbatoio"), DropDownList).SelectedItem.Text) & "',CAPACITA=" & par.VirgoleInPunti(par.IfEmpty(CType(TabGenerale.FindControl("txtCapacita"), TextBox).Text, "Null")) & "," _
            '& " RADIANTI=" & par.VirgoleInPunti(par.IfEmpty(CType(TabGenerale.FindControl("txtNumRadianti"), TextBox).Text, "Null")) & "," _
            '& " CERTIFICATI_CONFORMITA='" & CType(TabGenerale.FindControl("cmbConformita"), DropDownList).SelectedValue.ToString & "',CERTIFICAZIONE='" & CType(TabGenerale.FindControl("cmbTabRagg"), DropDownList).SelectedValue.ToString & "', " _
            '& " OMOLOGAZIONI='" & CType(TabGenerale.FindControl("cmbOmologazione"), DropDownList).SelectedValue.ToString & "',COLLAUDO='" & par.AggiustaData(CType(TabGenerale.FindControl("txtDataUTOV"), TextBox).Text) & "'," _


            par.cmd.CommandText = "update SISCOM_MI.IMPIANTI  set " _
                                         & " ID_COMPLESSO = " & Me.cmbComplesso.SelectedValue.ToString & ", ID_EDIFICIO=" & RitornaNullSeMenoUno(Me.DrLEdificio.SelectedValue.ToString) & "," _
                                         & " DESCRIZIONE='" & par.PulisciStrSql(Me.txtDenominazione.Text) & "'," _
                                         & " COD_TIPOLOGIA='TE'," _
                                         & " DITTA_COSTRUTTRICE='" & par.PulisciStrSql(Me.txtDitta.Text) & "'," _
                                         & " ANNO_COSTRUZIONE='" & par.AggiustaData(Me.txtAnnoRealizzazione.Text) & "'," _
                                         & " ANNOTAZIONI='" & par.PulisciStrSql(CType(TabGenerale.FindControl("txtNote"), TextBox).Text) & "'" _
                                         & " where ID = " & vIdImpianto

            par.cmd.ExecuteNonQuery()

            ' " COD_TIPOLOGIA='" & CType(TabGenerale.FindControl("RBList_Tipologia"), RadioButtonList).SelectedValue.ToString & "'," _

            par.cmd.CommandText = "update SISCOM_MI.I_TERMICI  set " _
                                         & " ID_TIPOLOGIA_USO = " & RitornaNullSeMenoUno(Me.cmbTipoUso.SelectedValue.ToString) & ", ID_COMBUSTIBILE=" & RitornaNullSeMenoUno((CType(TabGenerale.FindControl("cmbCombustibile"), DropDownList).SelectedValue.ToString)) & "," _
                                         & " SERBATOIO='" & par.PulisciStrSql(CType(TabGenerale.FindControl("cmbTipoSerbatoio"), DropDownList).SelectedItem.Text) & "'," _
                                         & " CAPACITA=" & par.VirgoleInPunti(par.IfEmpty(CType(TabGenerale.FindControl("txtCapacita"), TextBox).Text, "Null")) & "," _
                                         & " POTENZA=" & par.VirgoleInPunti(par.IfEmpty(CType(TabGenerale.FindControl("txtPotenza"), TextBox).Text, "Null")) & "," _
                                         & " CONSUMO_MEDIO=" & par.VirgoleInPunti(par.IfEmpty(CType(TabGenerale.FindControl("txtConsumo"), TextBox).Text, "Null")) & "," _
                                         & " LIBRETTO='" & CType(Tab_Termico_Certificazioni.FindControl("cmbLibretto"), DropDownList).SelectedValue.ToString & "'," _
                                         & " DICH_CONF_LG_46_90='" & CType(Tab_Termico_Certificazioni.FindControl("cmbConformita"), DropDownList).SelectedValue.ToString & "'," _
                                         & " DECR_PREFETTIZIO_SERBATOI='" & CType(Tab_Termico_Certificazioni.FindControl("cmbDecreto"), DropDownList).SelectedValue.ToString & "'," _
                                         & " LICENZA_UTF='" & CType(Tab_Termico_Certificazioni.FindControl("cmbLicenzaUTF"), DropDownList).SelectedValue.ToString & "'," _
                                         & " PRATICA_ISPESL='" & CType(Tab_Termico_Certificazioni.FindControl("cmbISPESL"), DropDownList).SelectedValue.ToString & "'," _
                                         & " TRATTAMENTO_ACQUA='" & CType(Tab_Termico_Certificazioni.FindControl("cmbTrattamentoAcqua"), DropDownList).SelectedValue.ToString & "'," _
                                         & " CONT_ENERGIA='" & CType(Tab_Termico_Certificazioni.FindControl("cmbContEnergia"), DropDownList).SelectedValue.ToString & "'," _
                                         & " DATA_PRATICA_ISPESL='" & par.AggiustaData(CType(Tab_Termico_Certificazioni.FindControl("txtDataISPESL"), TextBox).Text) & "'," _
                                         & " DATA_MESSA_RIPOSO='" & par.AggiustaData(CType(TabGenerale.FindControl("txtDataRiposo"), TextBox).Text) & "'," _
                                         & " DITTA_GESTIONE='" & par.PulisciStrSql(CType(TabGenerale.FindControl("txtDittaGestione"), TextBox).Text) & "'," _
                                         & " NUM_ORE_ESERCIZIO=" & par.IfEmpty(CType(TabGenerale.FindControl("txtOreEsercizio"), TextBox).Text, "Null") & "," _
                                         & " DATA_PRIMA_ACCENSIONE='" & par.AggiustaData(CType(TabGenerale.FindControl("txtDataAccensione"), TextBox).Text) & "'," _
                                         & " TELEFONO_DITTA='" & par.PulisciStrSql(CType(TabGenerale.FindControl("txtNumTelefonico"), TextBox).Text) & "'," _
                                         & " DATA_DISMISSIONE_CT='" & par.AggiustaData(CType(Tab_Termico_Certificazioni.FindControl("txtDataCT"), TextBox).Text) & "' " _
                                         & " where ID = " & vIdImpianto

            '& " DENUNCIA_IMPIANTO='" & CType(TabGenerale.FindControl("cmbDenuncia"), DropDownList).SelectedValue.ToString & "'" 
            '& " CERT_EX_UNI_8364='" & CType(TabGenerale.FindControl("cmbExUNI"), DropDownList).SelectedValue.ToString & "'," 


            par.cmd.ExecuteNonQuery()

            AggiornaImpiantiEdifici()

            par.myTrans.Commit() '

            '*** AGGIORNO il COD. IMPIANTO
            par.cmd.CommandText = "select COD_IMPIANTO from SISCOM_MI.IMPIANTI where SISCOM_MI.IMPIANTI.ID = " & vIdImpianto
            Dim myReader2 As Data.OracleClient.OracleDataReader = par.cmd.ExecuteReader()
            If myReader2.Read Then
                Me.txtCodImpianto.Text = myReader2(0)
            End If

            myReader2.Close()
            par.cmd.CommandText = ""


            par.myTrans = par.OracleConn.BeginTransaction(System.Data.IsolationLevel.Unspecified)
            HttpContext.Current.Session.Add("TRANSAZIONE" & lIdConnessione, par.myTrans)

            Response.Write("<SCRIPT>alert('Operazione completata correttamente!');</SCRIPT>")
            CType(Me.Page.FindControl("USCITA"), TextBox).Text = "0"
            txtModificato.Text = "0"


        Catch ex As Exception
            par.myTrans.Rollback()
            par.OracleConn.Close()

            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")

        End Try

    End Sub


    Protected Sub imgUscita_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs) Handles imgUscita.Click
        If txtModificato.Text <> "111" Then
            Session.Add("LAVORAZIONE", "0")


            par.OracleConn = CType(HttpContext.Current.Session.Item("CONNESSIONE" & lIdConnessione), Data.OracleClient.OracleConnection)
            par.OracleConn.Close()

            'par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Data.OracleClient.OracleTransaction)
            'par.cmd.Transaction = par.myTrans
            'par.myTrans.Rollback()

            Session.Item("LAVORAZIONE") = "0"

            HttpContext.Current.Session.Remove("CONNESSIONE" & lIdConnessione)
            HttpContext.Current.Session.Remove("TRANSAZIONE" & lIdConnessione)

            'HttpContext.Current.Session.Remove("LSTGENERATORI")
            'HttpContext.Current.Session.Remove("LSTBRUCIATORI")


            Data.OracleClient.OracleConnection.ClearAllPools()
            Page.Dispose()

            Response.Write("<script>document.location.href=""pagina_home.aspx""</script>")
        Else
            txtModificato.Text = "1"
            CType(Me.Page.FindControl("USCITA"), TextBox).Text = "0"
        End If

    End Sub

    Protected Sub btnINDIETRO_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs) Handles btnINDIETRO.Click
        If txtModificato.Text <> "111" Then
            Session.Add("LAVORAZIONE", "0")

            par.OracleConn = CType(HttpContext.Current.Session.Item("CONNESSIONE" & lIdConnessione), Data.OracleClient.OracleConnection)
            par.OracleConn.Close()

            'par.myTrans = CType(HttpContext.Current.Session.Item("TRANSAZIONE" & lIdConnessione), Data.OracleClient.OracleTransaction)
            'par.cmd.Transaction = par.myTrans
            'par.myTrans.Rollback()

            
            HttpContext.Current.Session.Remove("CONNESSIONE" & lIdConnessione)
            HttpContext.Current.Session.Remove("TRANSAZIONE" & lIdConnessione)

            'HttpContext.Current.Session.Remove("LSTGENERATORI")
            'HttpContext.Current.Session.Remove("LSTBRUCIATORI")


            Data.OracleClient.OracleConnection.ClearAllPools()
            Page.Dispose()


            If txtindietro.Text = 1 Then
                Response.Write("<script>document.location.href=""pagina_home.aspx""</script>")
            Else
                Response.Write("<script>document.location.href=""RisultatiImpianti.aspx""</script>")
                'Response.Write("<script>history.go(" & txtindietro.Text & ");</script>")
            End If

        Else
            txtModificato.Text = "1"
            CType(Me.Page.FindControl("USCITA"), TextBox).Text = "0"
        End If

    End Sub


    Public Property lIdConnessione() As String
        Get
            If Not (ViewState("par_lIdConnessione") Is Nothing) Then
                Return CStr(ViewState("par_lIdConnessione"))
            Else
                Return "0"
            End If
        End Get

        Set(ByVal value As String)
            ViewState("par_lIdConnessione") = value
        End Set

    End Property

    Private Property vIdImpianto() As Long
        Get
            If Not (ViewState("par_idImpianto") Is Nothing) Then
                Return CLng(ViewState("par_idImpianto"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As Long)
            ViewState("par_idImpianto") = value
        End Set

    End Property



    Private Sub CaricaInterventi()
        ''If par.OracleConn.State = Data.ConnectionState.Open Then
        ''    Response.Write("IMPOSSIBILE VISUALIZZARE")
        ''    Exit Sub
        ''Else
        ''    par.OracleConn.Open()
        ''    par.cmd = par.OracleConn.CreateCommand()
        ''    'HttpContext.Current.Session.Add("CONNESSIONE", par.OracleConn)
        ''End If
        'Try
        '    'Me.cmbTipoUso.Items.Clear()
        '    'par.cmd.CommandText = "SELECT * FROM SISCOM_MI.TIPOLOGIA_INTERVENTI_MANU"
        '    'Dim myReader1 As Data.OracleClient.OracleDataReader = par.cmd.ExecuteReader()
        '    'myReader1 = par.cmd.ExecuteReader
        '    'cmbTipoUso.Items.Add(New ListItem(" ", -1))
        '    'While myReader1.Read
        '    '    cmbTipoUso.Items.Add(New ListItem(par.IfNull(myReader1("descrizione"), " "), par.IfNull(myReader1("ID"), -1)))
        '    'End While
        '    'cmbTipoUso.Text = "-1"
        '    'myReader1.Close()
        '    'par.OracleConn.Close()
        'Catch ex As Exception
        '    ' par.OracleConn.Close()

        'End Try
    End Sub
    Private Sub Filtrainterventi()
        ''If par.OracleConn.State = Data.ConnectionState.Open Then
        ''    Response.Write("IMPOSSIBILE VISUALIZZARE")
        ''    Exit Sub
        ''Else
        ''    par.OracleConn.Open()
        ''    par.cmd = par.OracleConn.CreateCommand()
        ''    'HttpContext.Current.Session.Add("CONNESSIONE", par.OracleConn)
        ''End If



        'Try
        '    par.OracleConn = CType(HttpContext.Current.Session.Item("CONNESSIONE" & lIdConnessione), Data.OracleClient.OracleConnection)
        '    par.cmd = par.OracleConn.CreateCommand()


        '    ' ''Me.cmbTipoIntervento.Items.Clear()
        '    ' ''par.cmd.CommandText = "SELECT * FROM SISCOM_MI.TIPOLOGIA_INTERVENTI_MANU where ID_TIPO_SERVIZIO = " & Me.cmbTipoServizio.SelectedValue.ToString
        '    ' ''Dim myReader1 As Data.OracleClient.OracleDataReader = par.cmd.ExecuteReader()
        '    ' ''myReader1 = par.cmd.ExecuteReader
        '    ' ''cmbTipoIntervento.Items.Add(New ListItem(" ", -1))
        '    ' ''While myReader1.Read
        '    ' ''    cmbTipoIntervento.Items.Add(New ListItem(par.IfNull(myReader1("descrizione"), " "), par.IfNull(myReader1("ID"), -1)))
        '    ' ''End While
        '    ' ''cmbTipoIntervento.Text = "-1"
        '    ' ''myReader1.Close()
        '    ' ''par.OracleConn.Close()
        'Catch ex As Exception
        '    par.OracleConn.Close()

        '    Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
        '    Response.Write("<script>top.location.href='../Errore.aspx';</script>")

        'End Try
    End Sub

    Private Property TipoImmobile() As String
        Get
            If Not (ViewState("pa_tipoimmob") Is Nothing) Then
                Return CStr(ViewState("pa_tipoimmob"))
            Else
                Return 0
            End If
        End Get

        Set(ByVal value As String)
            ViewState("pa_tipoimmob") = value
        End Set

    End Property

    

    Private Sub AbilitazioneOggetti(ByVal ValorePass As Boolean)
        Try

            cmbComplesso.Enabled = ValorePass
            DrLEdificio.Enabled = ValorePass

            txtDenominazione.ReadOnly = Not (ValorePass)
            txtCodImpianto.ReadOnly = True

            cmbTipoUso.Enabled = ValorePass

        Catch ex As Exception

        End Try

    End Sub

    Private Sub AggiornaImpiantiEdifici()
        Dim i As Integer

        Try

        Catch ex As Exception
        End Try

        par.cmd.CommandText = "delete from SISCOM_MI.IMPIANTI_EDIFICI where ID_IMPIANTO = " & vIdImpianto
        par.cmd.ExecuteNonQuery()
        par.cmd.CommandText = ""

        For i = 0 To CType(TabGenerale.FindControl("CheckBoxEdifici"), CheckBoxList).Items.Count - 1
            If CType(TabGenerale.FindControl("CheckBoxEdifici"), CheckBoxList).Items(i).Selected = True Then
                par.cmd.CommandText = "insert into SISCOM_MI.IMPIANTI_EDIFICI (ID_IMPIANTO,ID_EDIFICIO) values " _
                           & "(" & vIdImpianto & "," & CType(TabGenerale.FindControl("CheckBoxEdifici"), CheckBoxList).Items(i).Value & ")"

                par.cmd.ExecuteNonQuery()
                par.cmd.CommandText = ""
            End If
        Next

    End Sub

    Private Function RitornaNumDaSiNo(ByVal valoredapassare As String) As String
        Try
            Dim a As String
            If valoredapassare = "SI" Then
                a = 1
            ElseIf valoredapassare = "NO" Then
                a = 0
            Else
                a = "Null"
            End If

            Return a
        Catch ex As Exception
        End Try
    End Function

    Private Function RitornaNullSeMenoUno(ByVal valorepass As String) As String
        Try
            Dim a As String
            If valorepass = "-1" Then
                a = "Null"
            ElseIf valorepass <> "-1" Then
                a = "'" & valorepass & "'"
            End If
            Return a
        Catch ex As Exception

        End Try

    End Function


    Private Function RitornaNullSeIntegerMenoUno(ByVal valorepass As Integer) As Object
        Dim a As Object = DBNull.Value
        Try

            If valorepass <> -1 Then
                a = valorepass
            End If

        Catch ex As Exception

        End Try

        Return a
    End Function

    Public Function strToNumber(ByVal s0 As String) As Object
        Dim s As String = s0.Replace(".", ",")

        Dim d As Double

        If Double.TryParse(s, d) = True Then
            Return d
        Else
            Return DBNull.Value
        End If
    End Function

    Protected Sub imgStampa_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs) Handles imgStampa.Click
        Dim scriptblock As String

        Try
            imgStampa.Attributes.Add("OnClick", "javascript:window.open('Report/ReportTermicoCentralizzato.aspx?ID_IMPIANTO=" & vIdImpianto & "','Report');")

            scriptblock = "<script language='javascript' type='text/javascript'>" _
            & "window.open('Report/ReportTermicoCentralizzato.aspx?ID_IMPIANTO=" & vIdImpianto & "','Report');" _
            & "</script>"
            If (Not Page.ClientScript.IsClientScriptBlockRegistered("clientScript55")) Then
                Page.ClientScript.RegisterClientScriptBlock(Me.GetType(), "clientScript55", scriptblock)
            End If

        Catch ex As Exception
            Session.Add("ERRORE", "Provenienza:" & Page.Title & " - " & ex.Message)
            Response.Write("<script>top.location.href='../Errore.aspx';</script>")
        End Try
    End Sub
End Class
